@inject IConfiguration Configuration
@{
    ViewData["Title"] = "ChangePassword";
    Layout = null;
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Change Password</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="~/assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="~/assets/css/icons.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            background: #f7f8fa;
        }

        .card {
            max-width: 600px;
            margin: 60px auto;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        .card-header {
            background-color: #f9f9f9;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            border-radius: 8px 8px 0 0;
        }

        .card-header h5 {
            margin: 0;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 16px;
            color: #555;
        }

        .btn-blue {
            background-color: #006eff;
            color: white;
            border: none;
        }

        .btn-blue:hover {
            background-color: #0051d9;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 25px;
        }

        .form-control {
            padding-right: 35px;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><span>🔐</span> Change Password</h5>
        </div>

        <div class="card-body">
            <form>
                <div class="form-group mb-3">
                    <label>Current Password <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="currentpassid" />
                    <span class="toggle-password" data-target="#currentpassid">👁️</span>
                </div>

                <div class="form-group mb-3">
                    <label>New Password <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="newpassid" />
                    <span class="toggle-password" data-target="#newpassid">👁️</span>
                </div>

                <div class="form-group mb-3">
                    <label>Confirm Password <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="confirmpassid" />
                    <span class="toggle-password" data-target="#confirmpassid">👁️</span>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-blue" id="btnChangePassword">🔒 Change Password</button>
                    <button type="button" class="btn btn-danger" id="btnCancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        var EmployeeId = localStorage.getItem('EmployeeId');

        $(document).ready(function () {
            // Toggle password visibility
            $('.toggle-password').on('click', function () {
                var input = $($(this).data('target'));
                input.attr('type', input.attr('type') === 'password' ? 'text' : 'password');
            });

            $('#btnCancel').click(function () {
                window.location.href = '@UIBaseUrl/AuthManage/Login';
            });

            $('#btnChangePassword').click(function () {
                changePassword();
            });
        });

        function changePassword() {
            var currentPassword = $('#currentpassid').val().trim();
            var newPassword = $('#newpassid').val().trim();
            var confirmPassword = $('#confirmpassid').val().trim();

            if (!currentPassword || !newPassword || !confirmPassword) {
                Swal.fire("Validation Error", "All fields are required.", "warning");
                return;
            }

            if (newPassword !== confirmPassword) {
                Swal.fire("Validation Error", "New and Confirm Password must match.", "warning");
                return;
            }

            // if (newPassword.length < 8 || !/[!#$%^&*(),.?":{}|<>]/g.test(newPassword)) {
            //     Swal.fire("Validation Error", "New password must be at least 8 characters and include a special character.", "warning");
            //     return;
            // }

            var payload = {
                EMPID: EmployeeId,
                CurrentPassword: currentPassword,
                NewPassword: newPassword
            };

            $.ajax({
                url: '@baseUrl/PasswordHistoryAPI/CreatePasswordHistory',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (response) {
                    if (response.isSuccess) {
                        Swal.fire({
                            title: "Success",
                            text: "Password changed successfully. Go to login?",
                            icon: "success",
                            showCancelButton: true,
                            confirmButtonText: "Yes",
                            cancelButtonText: "No"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '@UIBaseUrl/AuthManage/Login';
                            }
                        });

                        $('#currentpassid, #newpassid, #confirmpassid').val('');
                    } else {
                        Swal.fire("Error", response.responseMessage, "error");
                    }
                },
                error: function () {
                    Swal.fire("Error", "Something went wrong while calling the API.", "error");
                }
            });
        }
    </script>
</body>
</html>

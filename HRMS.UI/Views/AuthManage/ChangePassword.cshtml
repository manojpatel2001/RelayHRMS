@inject IConfiguration Configuration
@{
    ViewData["Title"] = "ChangePassword";
    Layout = null;
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Change Password</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--favicon-->
    <link rel="icon" href="~/assets/images/relayfevicon.jpeg" type="image/png" />
    <!--plugins-->
    <link rel="stylesheet" href="~/assets/plugins/notifications/css/lobibox.min.css" />
    <link href="~/assets/plugins/simplebar/css/simplebar.css" rel="stylesheet" />
    <link href="~/assets/plugins/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet" />
    <link href="~/assets/plugins/metismenu/css/metisMenu.min.css" rel="stylesheet" />
    <!-- Bootstrap CSS -->
    <link href="~/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="~/assets/css/bootstrap-extended.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="~/assets/css/app.css" rel="stylesheet">
    <link href="~/assets/css/icons.css" rel="stylesheet">
    <!-- Theme Style CSS -->
    <link rel="stylesheet" href="~/assets/css/dark-theme.css" />
    <link rel="stylesheet" href="~/assets/css/semi-dark.css" />
    <link rel="stylesheet" href="~/assets/css/header-colors.css" />
    <style>
        .required-star {
            color: red;
            margin-left: 2px;
        }

        .text-danger {
            font-size: 13px;
        }
    </style>

</head>
<body class="bg-login">
    <div class="wrapper">
        <div class="section-authentication-signin d-flex align-items-center justify-content-center my-5 my-lg-0">
            <div class="container-fluid">
                <div class="row row-cols-1 row-cols-lg-2 row-cols-xl-3">
                    <div class="col mx-auto">
                        <div class="mb-4 text-center">
                            <img src="~/assets/images/relaylogo.jpeg" width="220" alt="Logo" />
                        </div>
                       

                        <!-- Change Password Form Card -->
                        <div class="card">
                            <div class="card-body">
                                <div class="border p-4 rounded">
                                    <div class="form-body">
                                        <h5 class="text-center mb-4">🔐 Change Password</h5>

                                        <!-- Current Password -->
                                        <div class="col-12 mb-3">
                                            <label class="form-label">Current Password <span class="required-star">*</span></label>
                                            <div class="input-group" id="show_hide_current">
                                                <input type="password" class="form-control" id="currentpassid" placeholder="Enter current password" />
                                                <a href="javascript:;" class="input-group-text bg-transparent"><i class='bx bx-hide'></i></a>
                                            </div>
                                            <span id="spnCurrent" class="text-danger d-none">Please enter current password</span>
                                        </div>

                                        <!-- New Password -->
                                        <div class="col-12 mb-3">
                                            <label class="form-label">New Password <span class="required-star">*</span></label>
                                            <div class="input-group" id="show_hide_new">
                                                <input type="password" class="form-control" id="newpassid" placeholder="Enter new password" />
                                                <a href="javascript:;" class="input-group-text bg-transparent"><i class='bx bx-hide'></i></a>
                                            </div>
                                            <span id="spnNew" class="text-danger d-none">Please enter new password</span>
                                            <span id="spnPattern" class="text-danger d-none">Password must be at least 8 characters, include uppercase, lowercase, number and special character</span>
                                        </div>

                                        <!-- Confirm Password -->
                                        <div class="col-12 mb-3">
                                            <label class="form-label">Confirm Password <span class="required-star">*</span></label>
                                            <div class="input-group" id="show_hide_confirm">
                                                <input type="password" class="form-control" id="confirmpassid" placeholder="Confirm new password" />
                                                <a href="javascript:;" class="input-group-text bg-transparent"><i class='bx bx-hide'></i></a>
                                            </div>
                                            <span id="spnConfirm" class="text-danger d-none">Please confirm password</span>
                                            <span id="spnMatch" class="text-danger d-none">Passwords do not match</span>
                                        </div>

                                        <!-- Submit -->
                                        <div class="col-12 mt-4">
                                            <div class="d-grid gap-2">
                                                <button id="btnChangePassword" type="button" class="btn btn-primary d-flex align-items-center justify-content-center gap-2" style="background-color:#2395c6; color:white;">
                                                    <div id="divLoader" style="display: none;">
                                                        <span class="spinner-border spinner-border-sm text-light" role="status" aria-hidden="true"></span>
                                                    </div>
                                                    <span><i class="bx bxs-lock-alt"></i> Change Password</span>
                                                </button>
                                                <button type="button" class="btn btn-danger" id="btnCancel">Cancel</button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- END CARD -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="~/assets/js/bootstrap.bundle.min.js"></script>
    <!--plugins-->
    <script src="~/assets/js/jquery.min.js"></script>
    <script src="~/assets/plugins/simplebar/js/simplebar.min.js"></script>
    <script src="~/assets/plugins/metismenu/js/metisMenu.min.js"></script>
    <script src="~/assets/plugins/perfect-scrollbar/js/perfect-scrollbar.js"></script>
    <script src="~/assets/plugins/notifications/js/lobibox.min.js"></script>
    <script src="~/assets/plugins/notifications/js/notifications.min.js"></script>
    <script src="~/assets/plugins/notifications/js/notification-custom-script.js"></script>
    <!-- JS Dependencies -->
    <script>
        const RoleSlug=localStorage.getItem('RoleSlug');
        const previousUrl = localStorage.getItem("PreviousPageUrl");

        function validatePasswordPattern(password) {
            const pattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;
            return pattern.test(password);
        }

        function hideAllSpans() {
            $("#spnCurrent, #spnNew, #spnConfirm, #spnMatch, #spnPattern").addClass("d-none");
        }

        $(document).ready(function () {
            // Show/hide passwords
            ['#show_hide_current', '#show_hide_new', '#show_hide_confirm'].forEach(function (id) {
                $(`${id} a`).on('click', function (e) {
                    e.preventDefault();
                    const input = $(`${id} input`);
                    const icon = $(`${id} i`);
                    if (input.attr('type') === 'text') {
                        input.attr('type', 'password');
                        icon.addClass("bx-hide").removeClass("bx-show");
                    } else {
                        input.attr('type', 'text');
                        icon.removeClass("bx-hide").addClass("bx-show");
                    }
                });
            });

            $('#btnCancel').click(function () {
                if(RoleSlug.toLocaleLowerCase()=="admin" )
                {
                    window.location.href = previousUrl|| '@UIBaseUrl/Home/index';
                }
                else if(RoleSlug.toLocaleLowerCase()=="ess" )
                {
                    window.location.href = previousUrl|| '@UIBaseUrl/EmployeePanel/Home/index';
                }
                else{
                   window.location.href = previousUrl||'@UIBaseUrl/AuthManage/Login';
                }
            });

            $('#btnChangePassword').click(function () {
                hideAllSpans();
                const empId = localStorage.getItem('EmployeeId');
                const currentPassword = $('#currentpassid').val().trim();
                const newPassword = $('#newpassid').val().trim();
                const confirmPassword = $('#confirmpassid').val().trim();

                let isValid = true;

                if (!currentPassword) {
                    $("#spnCurrent").removeClass("d-none");
                    isValid = false;
                }

                if (!newPassword) {
                    $("#spnNew").removeClass("d-none");
                    isValid = false;
                }

                if (!confirmPassword) {
                    $("#spnConfirm").removeClass("d-none");
                    isValid = false;
                }

                //  if (currentPassword && newPassword && currentPassword === newPassword) {
                //     $("#spnPattern").text("New password cannot be the same as current password").removeClass("d-none");
                //     isValid = false;
                // }
                if (newPassword && confirmPassword && newPassword !== confirmPassword) {
                    $("#spnMatch").removeClass("d-none");
                    isValid = false;
                }

                if (newPassword && !validatePasswordPattern(newPassword)) {
                    $("#spnPattern").removeClass("d-none");
                    isValid = false;
                }

                if (!isValid) return;

                $('#divLoader').show();
                $('#btnChangePassword').prop("disabled", true);

                const payload = {
                    EMPID: empId,
                    CurrentPassword: currentPassword,
                    NewPassword: newPassword
                };

                $.ajax({
                    url: '@baseUrl/PasswordHistoryAPI/CreatePasswordHistory',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (response) {
                        if (response.isSuccess) {
                            round_success_noti("Password changed successfully.");
                            setTimeout(() => {
                                window.location.href = '@UIBaseUrl/AuthManage/Login';
                            }, 2000);
                        } else {
                            round_error_noti(response.responseMessage);
                        }

                        $('#divLoader').hide();
                        $('#btnChangePassword').prop("disabled", false);
                    },
                    error: function () {
                        round_error_noti("Something went wrong.");
                        $('#divLoader').hide();
                        $('#btnChangePassword').prop("disabled", false);
                    }
                });
            });
        });
    </script>
</body>

</html>

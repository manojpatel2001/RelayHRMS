@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Exit Application Approval";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrls = Configuration["BaseUrlSettings:baseUrl"];
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrls);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}

<title>Exit Approval Panel</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #ffffff;
    }

    .form-section {
        padding: 15px;
        border: 1px solid #ccc;
    }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        border: none;
        padding: 4px 12px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 4px;
        transition: none;
        box-shadow: none;
    }

        .btn-custom:hover,
        .btn-custom:focus,
        .btn-custom:active {
            background-color: #3e4b6d;
            color: white;
            outline: none;
            box-shadow: none;
        }

    .search-panel-wrapper {
        max-width: 100%;
        margin: auto;
    }

    .search-panel-container {
        background-color: #3e4b6d;
        padding: 6px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }

    .btn-add {
        background-color: orange;
        color: white;
        font-size: 14px;
        padding: 6px 15px;
        border: none;
        border-radius: 4px;
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .form-control-sm, .form-select-sm {
        height: calc(1.5em + .5rem + 2px);
        font-size: 0.875rem;
        padding: .25rem .5rem;
    }

    /* Grid width fixes */
    .container {
        max-width: 100% !important;
        width: 100% !important;
        padding-left: 15px;
        padding-right: 15px;
    }

    .grid-container {
        width: 100% !important;
        overflow-x: auto;
        margin: 0;
        padding: 0;
    }

    #exitGrid {
        width: 100% !important;
        min-width: 100% !important;
    }

        #exitGrid .dx-datagrid {
            width: 100% !important;
        }

        #exitGrid .dx-datagrid-content {
            width: 100% !important;
        }

        #exitGrid .dx-datagrid-table {
            width: 100% !important;
            table-layout: auto !important;
        }

    .form-section {
        width: 100%;
        max-width: 100%;
        padding: 15px;
        border: 1px solid #ccc;
        margin: 0;
    }

    .search-panel-wrapper {
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 0;
    }

    .custom-action-buttons {
        width: 100%;
        margin-bottom: 10px;
    }

    /* NOC Form Modal Styles */
    .noc-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        overflow: auto;
    }

    .noc-modal-content {
        background-color: #fefefe;
        margin: 2% auto;
        padding: 0;
        border: 1px solid #888;
        width: 90%;
        max-width: 900px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .noc-modal-header {
        padding: 15px 20px;
        background-color: #3e4b6d;
        color: white;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .noc-modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

    .noc-close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        line-height: 1;
    }

        .noc-close:hover,
        .noc-close:focus {
            color: #ddd;
        }

    .noc-modal-body {
        padding: 20px;
        max-height: 70vh;
        overflow-y: auto;
    }

    .noc-form-container {
        border: 2px solid #333;
        padding: 20px;
        background-color: white;
    }

    .noc-form-header {
        display: flex;
        border: 1px solid #000;
        margin-bottom: 10px;
    }

    .noc-logo-section {
        border-right: 1px solid #000;
        padding: 10px;
        width: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .noc-title-section {
        flex: 1;
        padding: 10px;
        text-align: center;
        border-right: 1px solid #000;
    }

        .noc-title-section h2 {
            margin: 0;
            font-size: 16px;
            font-weight: bold;
        }
        
    .noc-doc-info {
        padding: 10px;
        width: 120px;
        font-size: 11px;
    }

    .noc-approval-section {
        display: flex;
        border: 1px solid #000;
        margin-bottom: 10px;
    }

        .noc-approval-section > div {
            padding: 8px;
            border-right: 1px solid #000;
            font-size: 12px;
        }

            .noc-approval-section > div:last-child {
                border-right: none;
            }

    .noc-info-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
        font-size: 12px;
    }

        .noc-info-table td {
            border: 1px solid #000;
            padding: 8px;
        }

            .noc-info-table td:first-child {
                font-weight: bold;
                width: 40%;
            }

    .noc-items-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
        font-size: 11px;
    }

        .noc-items-table th,
        .noc-items-table td {
            border: 1px solid #000;
            padding: 6px;
            text-align: left;
        }

        .noc-items-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }

    .noc-signature-section {
        margin-top: 15px;
    }

    .noc-signature-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
        margin-bottom: 10px;
    }

        .noc-signature-table th,
        .noc-signature-table td {
            border: 1px solid #000;
            padding: 8px;
        }

        .noc-signature-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }

    .noc-note {
        font-size: 11px;
        margin-top: 10px;
        padding: 10px;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
    }

        .noc-note strong {
            display: block;
            margin-bottom: 5px;
        }

    .noc-declaration {
        font-size: 11px;
        margin-top: 10px;
        padding: 10px;
        border: 1px solid #000;
    }

        .noc-declaration strong {
            display: block;
            margin-bottom: 5px;
            text-decoration: underline;
        }

    .noc-modal-footer {
        padding: 15px 20px;
        background-color: #f5f5f5;
        border-top: 1px solid #ddd;
        text-align: right;
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
    }

    .btn-download-noc {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 8px 20px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
    }

        .btn-download-noc:hover {
            background-color: #218838;
        }

    .btn-download-pdf {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 8px 20px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
    }

        .btn-download-pdf:hover {
            background-color: #c82333;
        }

    .checkmark {
        color: green;
        font-weight: bold;
        font-size: 16px;
    }

    .crossmark {
        color: red;
        font-weight: bold;
        font-size: 16px;
    }
</style>

<!-- Search Panel Header -->
<div class="search-panel-wrapper">
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Search panel</div>
        </div>
    </div>
</div>

<!-- Form Starts -->
<div class="form-section">
    <!-- Row 1: Search By & Search For -->
    <div class="row justify-content-center mb-3">
        <div class="col-md-5 d-flex align-items-center">
            <label for="searchby" class="form-label mb-0 me-2" style="width: 120px;">Search By<span class="text-danger">*</span>:</label>
            <select class="form-select form-select-sm" id="searchby" style="width: 180px;">
                <option value="1">Emp Name</option>
                <option value="2">Emp Code</option>
                <option value="3">Reason</option>
            </select>
        </div>
        <div class="col-md-5 d-flex align-items-center">
            <label for="searchfor" class="form-label mb-0 me-2" style="width: 120px;">Search for<span class="text-danger">*</span>:</label>
            <input type="text" class="form-control form-control-sm" id="searchfor" style="width: 180px;" />
        </div>
    </div>

    <!-- Row 2: Radio Buttons + Buttons -->
    <div class="row justify-content-center align-items-center mb-3">
        <div class="col-md-10">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <!-- Radio Buttons -->
                <div class="d-flex align-items-center flex-wrap">
                    <div class="form-check me-4">
                        <input class="form-check-input" type="radio" name="type" id="r2">
                        <label class="form-check-label" for="r2">Pending</label>
                    </div>
                    <div class="form-check me-4">
                        <input class="form-check-input" type="radio" name="type" id="r3">
                        <label class="form-check-label" for="r3">Approved</label>
                    </div>
                    <div class="form-check me-4">
                        <input class="form-check-input" type="radio" name="type" id="r4">
                        <label class="form-check-label" for="r4">Rejected</label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex align-items-center mt-2 mt-md-0">
                    <button class="btn btn-custom me-2" id="btnGo">Go</button>
                    <button class="btn btn-custom me-2" id="btnClear">Clear</button>
                    <button onclick="goBack()" class="btn btn-custom">Back</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- EXIT APPLICATION Heading -->
<div class="search-panel-wrapper mt-2">
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">EXIT APPLICATION</div>
        </div>
    </div>
</div>

<!-- Action Buttons + Grid Container -->
<div class="container mt-3">
    <!-- Action Buttons Row -->
    <div id="actionButtons" class="custom-action-buttons text-end mb-2" style="display: none;">
        <button id="btnApprove" class="btn btn-custom">Approve</button>
        <button id="btnReject" class="btn btn-custom">Reject</button>
    </div>

    <!--Loader-->
    <div id="grid-loader"
         class="grid-loader justify-content-center align-items-center flex-column"
         style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(3px); z-index: 9999;">
        <img src="@baseDomainUrl/loders/loder.png"
             class="grid-logo-spinner"
             style="width: 40px; height: 40px; animation: spin 1s linear infinite;" />
        <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>
    </div>

    <!-- Grid Container with proper width -->
    <div class="grid-container">
        <div id="exitGrid"></div>
    </div>
</div>

<!-- NOC Form Modal -->
<div id="nocModal" class="noc-modal">
    <div class="noc-modal-content">
        <div class="noc-modal-header">
            <h3>NOC Form Preview - F & F Settlement Form</h3>
            <button class="noc-close" onclick="closeNOCModal()">&times;</button>
        </div>
        <div class="noc-modal-body" id="nocModalBody">
            <!-- NOC Form content will be dynamically inserted here -->
        </div>
        <div class="noc-modal-footer">
            <button class="btn btn-custom" onclick="closeNOCModal()">Close</button>
            <button class="btn btn-download-pdf" onclick="downloadNOCForm('pdf')">
                <i class="fas fa-download me-2"></i>Download PDF
            </button>
        </div>
    </div>
</div>

<script>
    const EmployeeId = localStorage.getItem('EmployeeId');
    let currentExitApplicationID = null;
    let currentNOCData = null;

    // Safe grid disposal function
    function safeDisposeGrid() {
        try {
            var gridInstance = $("#exitGrid").data("dxDataGrid");
            if (gridInstance) {
                gridInstance.dispose();
            }
        } catch (e) {
            // Grid doesn't exist, continue
        }
        $("#exitGrid").empty();
    }

    $(document).ready(function () {
        $('#r2').prop('checked', true); // Default to Pending
        $('#btnGo').click(); // Trigger initial load

        $("#btnApprove").click(function () {
            updateExitStatus("Approved");
        });

        $("#btnReject").click(function () {
            updateExitStatus("Rejected");
        });
    });

    let selectedKeys = [];

    // Get selected status from radio buttons
    function getStatus() {
        if ($('#r2').is(':checked')) return 'Pending';
        if ($('#r3').is(':checked')) return 'Approved';
        if ($('#r4').is(':checked')) return 'Rejected';
        return null;
    }

    // Map dropdown value to parameter
    function getSearchByText(value) {
        switch (value) {
            case '1': return 'EmpName';
            case '2': return 'EmpCode';
            case '3': return 'Reason';
            default: return null;
        }
    }

    function goBack() {
        window.location.href = '@UIBaseUrl/EmployeePanel/Home/index';
    }

    async function showLoder() {
        $('#grid-loader').addClass('d-flex').show();
    }

    async function hideLoder() {
        $('#grid-loader').removeClass('d-flex').hide();
    }

    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    function loadGrid(data) {
        // Dispose existing grid first to prevent conflicts
        console.log('data' ,data);
        try {
            const gridInstance = $("#exitGrid").dxDataGrid("instance");
            if (gridInstance) {
                gridInstance.dispose();
            }
        } catch (e) {
            // Grid doesn't exist yet, that's okay
        }

        // Clear the container
        $("#exitGrid").empty();

        // Check if data is empty - hide everything if no data
        if (!data || data.length === 0) {
            $("#actionButtons").hide();
            $(".search-panel-wrapper").last().hide(); // Hide "EXIT APPLICATION" heading
            return;
        }

        // Show heading if data exists
        $(".search-panel-wrapper").last().show();

        $("#exitGrid").dxDataGrid({
            dataSource: data,
            keyExpr: "exitApplicationID",
            showBorders: true,
            width: "100%",
            height: 400,
            columnAutoWidth: true,
            wordWrapEnabled: false,
            paging: {
                enabled: false
            },
            scrolling: {
                mode: "standard",
                useNative: true,
                showScrollbar: "always"
            },
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "always"
            },
            filterRow: { visible: false },
            searchPanel: { visible: false },
            onSelectionChanged: function (e) {
                selectedKeys = e.selectedRowKeys;
            },
            columns: [
                { dataField: "employeeCode", caption: "Emp Code", width: 100 },
                { dataField: "employeeid", visible: false },
                { dataField: "fullName", caption: "Employee Name", width: 200 },
                {
                    dataField: "resignationDate",
                    caption: "Resignation Date",
                    dataType: "date",
                    format: "dd/MM/yyyy",
                    width: 130
                },
                {
                    dataField: "reasonForResignation",
                    caption: "Reason",
                    dataType: "string",
                    width: 200
                },
                {
                    dataField: "lastWorkingDate",
                    caption: "Last Working Date",
                    dataType: "date",
                    format: "dd/MM/yyyy",
                    width: 140
                },
                {
                    caption: "Status",
                    width: 100,
                    alignment: "center",
                    allowFiltering: false,
                    allowSorting: false,
                    cellTemplate: function(container, options) {
                        const row = options.data;
                        let statusText = "";

                        if (row.isApproved === true) {
                            statusText = "Approved";
                        } else if (row.isRejected === true) {
                            statusText = "Rejected";
                        } else if (row.isPending === true) {
                            statusText = "Pending";
                        }

                        $("<div>").text(statusText).appendTo(container);
                    }
                },
                {
                    dataField: "approvedByReportingPerson",
                    caption: "Approved By Reporting Person",
                    width: 150,
                    calculateCellValue: function(rowData) {
                        return rowData.approvedByReportingPerson ? rowData.approvedByReportingPerson : "-";
                    }
                },
                {
                    dataField: "updatedDate",
                    caption: "Approved Date",
                    dataType: "date",
                    format: "dd/MM/yyyy",
                    width: 130,
                    calculateCellValue: function(rowData) {
                        if (!rowData.updatedDate) return "-";
                        const date = new Date(rowData.updatedDate);
                        const day = String(date.getDate()).padStart(2, '0');
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const year = date.getFullYear();
                        return `${day}/${month}/${year}`;
                    }
                },
                {
                    caption: "Preview",
                    width: 80,
                    alignment: "center",
                    allowFiltering: false,
                    allowSorting: false,
                    cellTemplate: function(container, options) {
                        const row = options.data;

                        // Only show Preview button if NOC form is filled
                        if (row.isNOCFormFilled === true) {
                            const previewIcon = $("<i>")
                                .addClass("fas fa-eye")
                                .css("cursor", "pointer")
                                .css("color", "#3e4b6d")
                                .css("font-size", "18px")
                                .attr("title", "Preview NOC Form")
                                .on("click", function() {
                                    previewNOCForm(row.employeeId);
                                });

                            container.append(previewIcon);
                        } else {
                            $("<span>").text("-").appendTo(container);
                        }
                    }
                },
                {
                    caption: "Export",
                    width: 80,
                    alignment: "center",
                    allowFiltering: false,
                    allowSorting: false,
                    cellTemplate: function(container, options) {
                        const row = options.data;

                        // Only show Export button if NOC form is filled
                        if (row.isNOCFormFilled === true) {
                            const downloadIcon = $("<i>")
                                .addClass("fas fa-download")
                                .css("cursor", "pointer")
                                .css("color", "#3e4b6d")
                                .css("font-size", "18px")
                                .attr("title", "Download NOC PDF")
                                .on("click", function() {
                                    downloadNOCFormDirect(row.employeeId, 'pdf');
                                });

                            container.append(downloadIcon);
                        } else {
                            $("<span>").text("-").appendTo(container);
                        }
                    }
                }
            ]
        });

        $("#actionButtons").show();
    }

    // Function to preview NOC Form
    function previewNOCForm(employeeId) {
        currentExitApplicationID = employeeId;
        showLoder();

        $.ajax({
            url: "@baseUrls/NOCAPI/GetNOCByGetEmployeeExitDetails",
            type: 'GET',
            data: { EmployeeId: employeeId },
            success: function (res) {
                hideLoder();
                if (res.isSuccess && res.data) {
                    // Check if data is array or single object
                    const nocData = Array.isArray(res.data) ? res.data[0] : res.data;

                    if (!nocData) {
                        round_error_noti('No NOC form data found');
                        return;
                    }

                    currentNOCData = nocData;
                    displayNOCForm(nocData);
                    $("#nocModal").show();
                } else {
                    round_error_noti(res.responseMessage || 'Failed to load NOC form data');
                }
            },
            error: function (xhr, status, error) {
                hideLoder();
                console.error('Error loading NOC form:', error);
                round_error_noti('Error loading NOC form: ' + error);
            }
        });
    }

    // Function to display NOC Form in modal
    function displayNOCForm(data) {
        // Company logo path
        const logoUrl = '/assets/images/relaylogo.jpeg';

        const nocItems = data.nocItems || [];

        let itemsHtml = '';
        nocItems.forEach(function(item) {
            const yesCheck = item.isHandedOver ? '✓' : '';
            const noCheck = !item.isHandedOver ? '✓' : '';
            const handoverTo = item.handoverTo && item.handoverTo !== 'NULL' ? item.handoverTo : '-';
            const remarks = item.remarks && item.remarks !== 'NULL' ? item.remarks : '-';

            itemsHtml += `
                <tr>
                    <td>${item.itemName}</td>
                    <td style="text-align: center;">${yesCheck ? '<span class="checkmark">✓</span>' : ''}</td>
                    <td style="text-align: center;">${noCheck ? '<span class="crossmark">✗</span>' : ''}</td>
                    <td>${handoverTo}</td>
                    <td>${remarks}</td>
                </tr>
            `;
        });

        const nocFormHtml = `
            <div class="noc-form-container">
                <!-- Header -->
                <div class="noc-form-header">
                    <div class="noc-logo-section">
                        <img src="${logoUrl}" alt="Company Logo" style="max-width: 130px; max-height: 60px; object-fit: contain;" onerror="this.style.display='none'; this.parentElement.innerHTML='<strong>RELAY EXPRESS</strong>';" />
                    </div>
                    <div class="noc-title-section">
                        <h2>Title- No Dues Claim/F & F Settlement Form</h2>
                    </div>
                    <div class="noc-doc-info">
                        <strong>Document No-8</strong><br>
                        <strong>Issue No: 1</strong><br>
                        <strong>Page:1 of 1</strong><br>
                        <strong>w.e.f :01.06.2017</strong>
                    </div>
                </div>

                <!-- Approval Section -->
                <div class="noc-approval-section">
                    <div style="width: 33.33%;"><strong>Prepared By:</strong> HRD</div>
                    <div style="width: 33.33%;"><strong>Approved By:</strong> Management</div>
                    <div style="width: 33.33%;"><strong>Issued By:</strong> MR</div>
                </div>

                <!-- Employee Information -->
                <table class="noc-info-table">
                    <tr>
                        <td>Employee Name</td>
                        <td>${data.employeeName || '-'}</td>
                        <td><strong>Employee Code</strong></td>
                        <td>${data.employeeCode || '-'}</td>
                    </tr>
                    <tr>
                        <td>Designation</td>
                        <td>${data.designation || '-'}</td>
                        <td><strong>Branch</strong></td>
                        <td>${data.branch || '-'}</td>
                    </tr>
                    <tr>
                        <td>Department</td>
                        <td>${data.department || '-'}</td>
                        <td><strong>Date of Joining</strong></td>
                        <td>${formatDate(data.dateOfJoining)}</td>
                    </tr>
                    <tr>
                        <td>Resignation Date (Mandatory)</td>
                        <td>${formatDate(data.resignationDate)}</td>
                        <td><strong>Date of Leaving</strong></td>
                        <td>${formatDate(data.lastWorkingDate)}</td>
                    </tr>
                    <tr>
                        <td>Notice Period as per Policy</td>
                        <td>${data.noticePeriodDays || '0'} days</td>
                        <td><strong>Short Fall Days</strong></td>
                        <td>${data.shortFallDays || '0'} days</td>
                    </tr>
                    <tr>
                        <td>Reason of Leaving</td>
                        <td colspan="3">${data.reasonForResignation || '-'}</td>
                    </tr>
                    <tr>
                        <td></td>
                        <td colspan="3"><strong>Notice Period actual served: ${data.noticePeriodDays || '0'} days</strong></td>
                    </tr>
                </table>

                <!-- Items Handover Table -->
                <table class="noc-items-table">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Dept. / Section</th>
                            <th style="width: 10%;">Yes</th>
                            <th style="width: 10%;">No</th>
                            <th style="width: 25%;">Handover to</th>
                            <th style="width: 25%;">Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>

                <!-- Signature Section -->
                <div class="noc-signature-section">
                    <table class="noc-signature-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Approved By (Dept. Mgr.)</th>
                                <th>Charge to be given to</th>
                                <th>Received By (HRD)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="height: 50px;"><strong>Signature</strong></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Note -->
                <div class="noc-note">
                    <strong>Note:</strong> - Settlement will have to be made to the employee only after obtaining this form duly approved by all
                    concerned and Full & final settlement will be done after 45 days from the last working day and if, employee will not
                    serve notice as per the HQO then HRD will adjust notice period amount against F & F settlement amount.
                </div>

                <!-- Employee's Declaration -->
                <div class="noc-declaration">
                    <strong>Employee's Self Declaration on his Personal Liabilities / A Guarantor:</strong>
                    <p>For any kind of loan (Home Loan/Personal Loan/ Vehicle Loan etc.) taken by me from third party, in that case Relay
                    Express Pvt Ltd. will nowhere liable for its repayment. I will solely and exclusively liable to repay my loan or any kind
                    financial liability to the lender. Even if I have availed any kind of loan /financial facility by making Relay Express as a
                    guarantor and not repaid that liability. I shall be exclusively responsible for that loan repayment, Relay Express will nowhere liable for its repayment.</p>
                    <div style="margin-top: 50px; text-align: right;">
                        <strong>Employee's Signature</strong>
                    </div>
                </div>
            </div>
        `;

        $('#nocModalBody').html(nocFormHtml);
    }

    // Function to close NOC modal
    function closeNOCModal() {
        $("#nocModal").hide();
        currentExitApplicationID = null;
        currentNOCData = null;
    }

    // Function to download NOC Form
    function downloadNOCForm(format) {
        if (!currentExitApplicationID || !currentNOCData) {
            round_error_noti('No NOC form data available');
            return;
        }
        downloadNOCFormDirect(currentExitApplicationID, format);
    }

    // ============ FIXED PDF GENERATION FUNCTION WITH LOGO AND SINGLE PAGE ============
    function downloadNOCFormDirect(employeeId, format) {
        showLoder();

        $.ajax({
            url: "@baseUrls/NOCAPI/GetNOCByGetEmployeeExitDetails",
            type: 'GET',
            data: { EmployeeId: employeeId },
            success: function (res) {
                hideLoder();
                if (res.isSuccess && res.data) {
                    const nocData = Array.isArray(res.data) ? res.data[0] : res.data;

                    if (!nocData) {
                        round_error_noti('No NOC form data found');
                        return;
                    }

                    generateNOCPDF(nocData);
                } else {
                    round_error_noti(res.responseMessage || 'Failed to load NOC form data');
                }
            },
            error: function (xhr, status, error) {
                hideLoder();
                console.error('Error loading NOC form:', error);
                round_error_noti('Error loading NOC form: ' + error);
            }
        });
    }

    // Function to generate PDF from NOC data - OPTIMIZED FOR SINGLE PAGE WITH LOGO
    function generateNOCPDF(data) {
        showLoder();

        // Company logo path
        const logoUrl = '/assets/images/relaylogo.jpeg';

        // Create temporary container with reduced size to fit on one page
        const tempContainer = $('<div>').css({
            'position': 'absolute',
            'left': '-9999px',
            'width': '750px',
            'background': 'white',
            'padding': '10px'
        }).appendTo('body');

        const nocItems = data.nocItems || [];
        let itemsHtml = '';

        nocItems.forEach(function(item) {
            const yesCheck = item.isHandedOver ? '✓' : '';
            const noCheck = !item.isHandedOver ? '✓' : '';
            const handoverTo = item.handoverTo && item.handoverTo !== 'NULL' ? item.handoverTo : '-';
            const remarks = item.remarks && item.remarks !== 'NULL' ? item.remarks : '-';

            itemsHtml += `
                <tr>
                    <td style="border: 1px solid #000; padding: 3px; font-size: 9px;">${item.itemName}</td>
                    <td style="border: 1px solid #000; padding: 3px; text-align: center; font-size: 9px;">${yesCheck ? '<span style="color: green;">✓</span>' : ''}</td>
                    <td style="border: 1px solid #000; padding: 3px; text-align: center; font-size: 9px;">${noCheck ? '<span style="color: red;">✗</span>' : ''}</td>
                    <td style="border: 1px solid #000; padding: 3px; font-size: 9px;">${handoverTo}</td>
                    <td style="border: 1px solid #000; padding: 3px; font-size: 9px;">${remarks}</td>
                </tr>
            `;
        });

        const nocFormHtml = `
            <div style="border: 2px solid #333; padding: 10px; background-color: white; font-family: Arial, sans-serif;">
                <!-- Header -->
                <div style="display: flex; border: 1px solid #000; margin-bottom: 6px;">
                    <div style="border-right: 1px solid #000; padding: 6px; width: 120px; display: flex; align-items: center; justify-content: center;">
                        <img src="${logoUrl}" alt="Company Logo" style="max-width: 100px; max-height: 45px; object-fit: contain;" onerror="this.style.display='none'; this.parentElement.innerHTML='<strong>RELAY EXPRESS</strong>';" />
                    </div>
                    <div style="flex: 1; padding: 6px; text-align: center; border-right: 1px solid #000;">
                        <h2 style="margin: 0; font-size: 13px; font-weight: bold;">Title- No Dues Claim/F & F Settlement Form</h2>
                    </div>
                    <div style="padding: 6px; width: 100px; font-size: 8px;">
                        <strong>Document No-8</strong><br>
                        <strong>Issue No: 1</strong><br>
                        <strong>Page:1 of 1</strong><br>
                        <strong>w.e.f :01.06.2017</strong>
                    </div>
                </div>

                <!-- Approval Section -->
                <div style="display: flex; border: 1px solid #000; margin-bottom: 5px;">
                    <div style="padding: 4px; border-right: 1px solid #000; font-size: 9px; width: 33.33%;"><strong>Prepared By:</strong> HRD</div>
                    <div style="padding: 4px; border-right: 1px solid #000; font-size: 9px; width: 33.33%;"><strong>Approved By:</strong> Management</div>
                    <div style="padding: 4px; font-size: 9px; width: 33.33%;"><strong>Issued By:</strong> MR</div>
                </div>

                <!-- Employee Information Table -->
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 5px; font-size: 9px;">
                    <tr>
                        <td style="border: 1px solid #000; padding: 4px; font-weight: bold; width: 25%;">Employee Name</td>
                        <td style="border: 1px solid #000; padding: 4px; width: 25%;">${data.employeeName || '-'}</td>
                        <td style="border: 1px solid #000; padding: 4px; font-weight: bold; width: 25%;">Employee Code</td>
                        <td style="border: 1px solid #000; padding: 4px; width: 25%;">${data.employeeCode || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 4px; font-weight: bold;">Designation</td>
                        <td style="border: 1px solid #000; padding: 4px;">${data.designation || '-'}</td>
                        <td style="border: 1px solid #000; padding: 4px; font-weight: bold;">Branch</td>
                        <td style="border: 1px solid #000; padding: 4px;">${data.branch || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 4px; font-weight: bold;">Department</td>
                        <td style="border: 1px solid #000; padding: 4px;">${data.department || '-'}</td>
                        <td style="border: 1px solid #000; padding: 4px; font-weight: bold;">Date of Joining</td>
                        <td style="border: 1px solid #000; padding: 4px;">${formatDate(data.dateOfJoining)}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 4px; font-weight: bold;">Resignation Date</td>
                        <td style="border: 1px solid #000; padding: 4px;">${formatDate(data.resignationDate)}</td>
                        <td style="border: 1px solid #000; padding: 4px; font-weight: bold;">Date of Leaving</td>
                        <td style="border: 1px solid #000; padding: 4px;">${formatDate(data.lastWorkingDate)}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 4px; font-weight: bold;">Notice Period</td>
                        <td style="border: 1px solid #000; padding: 4px;">${data.noticePeriodDays || '0'} days</td>
                        <td style="border: 1px solid #000; padding: 4px; font-weight: bold;">Short Fall Days</td>
                        <td style="border: 1px solid #000; padding: 4px;">${data.shortFallDays || '0'} days</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 4px; font-weight: bold;">Reason of Leaving</td>
                        <td colspan="3" style="border: 1px solid #000; padding: 4px;">${data.reasonForResignation || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 4px;"></td>
                        <td colspan="3" style="border: 1px solid #000; padding: 4px;"><strong>Notice Period actual served: ${data.noticePeriodDays || '0'} days</strong></td>
                    </tr>
                </table>

                <!-- Items Handover Table -->
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 5px; font-size: 9px;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #000; padding: 3px; background-color: #f0f0f0; font-weight: bold; text-align: center; width: 30%;">Dept. / Section</th>
                            <th style="border: 1px solid #000; padding: 3px; background-color: #f0f0f0; font-weight: bold; text-align: center; width: 10%;">Yes</th>
                            <th style="border: 1px solid #000; padding: 3px; background-color: #f0f0f0; font-weight: bold; text-align: center; width: 10%;">No</th>
                            <th style="border: 1px solid #000; padding: 3px; background-color: #f0f0f0; font-weight: bold; text-align: center; width: 25%;">Handover to</th>
                            <th style="border: 1px solid #000; padding: 3px; background-color: #f0f0f0; font-weight: bold; text-align: center; width: 25%;">Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>

                <!-- Signature Section -->
                <table style="width: 100%; border-collapse: collapse; font-size: 9px; margin-bottom: 5px;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; font-weight: bold; text-align: center;">Employee</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; font-weight: bold; text-align: center;">Approved By (Dept. Mgr.)</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; font-weight: bold; text-align: center;">Charge to be given to</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; font-weight: bold; text-align: center;">Received By (HRD)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px; height: 35px;"><strong>Signature</strong></td>
                            <td style="border: 1px solid #000; padding: 4px;"></td>
                            <td style="border: 1px solid #000; padding: 4px;"></td>
                            <td style="border: 1px solid #000; padding: 4px;"></td>
                        </tr>
                    </tbody>
                </table>

                <!-- Note -->
                <div style="font-size: 8px; margin-top: 5px; padding: 5px; background-color: #f9f9f9; border: 1px solid #ddd;">
                    <strong>Note:</strong> Settlement will have to be made to the employee only after obtaining this form duly approved by all concerned and Full & final settlement will be done after 45 days from the last working day and if, employee will not serve notice as per the HQO then HRD will adjust notice period amount against F & F settlement amount.
                </div>

                <!-- Employee's Declaration -->
                <div style="font-size: 8px; margin-top: 5px; padding: 5px; border: 1px solid #000;">
                    <strong style="text-decoration: underline;">Employee's Self Declaration on his Personal Liabilities / A Guarantor:</strong>
                    <p style="margin: 3px 0;">For any kind of loan (Home Loan/Personal Loan/ Vehicle Loan etc.) taken by me from third party, in that case Relay Express Pvt Ltd. will nowhere liable for its repayment. I will solely and exclusively liable to repay my loan or any kind financial liability to the lender. Even if I have availed any kind of loan /financial facility by making Relay Express as a guarantor and not repaid that liability. I shall be exclusively responsible for that loan repayment, Relay Express will nowhere liable for its repayment.</p>
                    <div style="margin-top: 30px; text-align: right;">
                        <strong>Employee's Signature</strong>
                    </div>
                </div>
            </div>
        `;

        tempContainer.html(nocFormHtml);

        // Generate PDF using html2canvas and jsPDF
        html2canvas(tempContainer[0], {
            scale: 2.5,
            useCORS: true,
            logging: false,
            allowTaint: true
        }).then(function(canvas) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            // Check if content fits on one page
            if (imgHeight <= pageHeight) {
                // Content fits on one page
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            } else {
                // Content is too tall, scale it down to fit on one page
                const scaledHeight = pageHeight - 10; // Leave small margin
                const scaledWidth = (canvas.width * scaledHeight) / canvas.height;
                const xOffset = (imgWidth - scaledWidth) / 2; // Center horizontally

                pdf.addImage(imgData, 'PNG', xOffset, 5, scaledWidth, scaledHeight);
            }

            // Download the PDF
            const fileName = `NOC_Form_${data.employeeCode || 'Employee'}_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(fileName);

            // Clean up
            tempContainer.remove();
            hideLoder();

            round_success_noti('NOC PDF downloaded successfully');
        }).catch(function(error) {
            console.error('Error generating PDF:', error);
            tempContainer.remove();
            hideLoder();
            round_error_noti('Error generating PDF: ' + error.message);
        });
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('nocModal');
        if (event.target === modal) {
            closeNOCModal();
        }
    }

    $('#btnGo').on('click', function () {
        let model = {
            EmployeeId: EmployeeId,
            Status: getStatus(),
            SearchBy: getSearchByText($('#searchby').val()),
            SearchValue: $('#searchfor').val()
        };

        $.ajax({
            url: "@baseUrls/ExitApplicationAPI/GetExitClearanceApproval",
            type: 'POST',
            data: JSON.stringify(model),
            contentType: 'application/json',
            beforeSend: function(xhr) {
                console.log('Request starting...');
            },
            success: function (res) {
                console.log('Response received:', res);

                if (res.isSuccess) {
                    if (res.data && res.data.length > 0) {
                        loadGrid(res.data);
                    } else {
                        $("#actionButtons").hide();
                        $(".search-panel-wrapper").last().hide();
                        safeDisposeGrid();
                        round_error_noti('No Data Found');
                    }
                } else {
                    $("#actionButtons").hide();
                    $(".search-panel-wrapper").last().hide();
                    safeDisposeGrid();
                    round_error_noti(res.responseMessage || 'No Data');
                }
            },
            error: function (xhr, status, error) {
                console.error('AJAX Error:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                $("#actionButtons").hide();
                $(".search-panel-wrapper").last().hide();
                safeDisposeGrid();
                round_error_noti('Error loading data: ' + error);
            }
        });
    });

    $("#btnClear").click(function () {
        $('#searchby').val("1");
        $('#searchfor').val('');
        $("input[name='type']").prop('checked', false);
        $('#r2').prop('checked', true);

        safeDisposeGrid();
        $("#actionButtons").hide();
        $(".search-panel-wrapper").last().hide();
    });

         function updateExitStatus(status) {
        debugger;
        var grid = $("#exitGrid").dxDataGrid("instance");
        var selectedRows = grid.getSelectedRowsData();

        if (selectedRows.length === 0) {
            round_error_noti("Please select at least one record.");
            return;
        }

 

        var rowsToUpdate = selectedRows.map(function(row) {
            return {
                ExitApplicationID: row.exitApplicationID,
                IsApproved: (status === "Approved"),  // Send true/false
                IsRejected: (status === "Rejected"),
                UpdatedBy: EmployeeId,
                EmployeeId: row.employeeId,
            };
        });

        showLoder();

        // Create array of promises for each update request
        var updatePromises = rowsToUpdate.map(function(row) {
            return $.ajax({
                url: "@baseUrls/ExitApplicationAPI/UpdateExitApprovalBYHR",
                type: "PUT",
                data: JSON.stringify([row]),
                contentType: "application/json"
            });
        });

        // Wait for all requests to complete
        Promise.all(updatePromises)
            .then(function(responses) {
                hideLoder();

                // Check if all updates were successful
                var allSuccess = responses.every(function(response) {
                    return response.isSuccess;
                });

                if (allSuccess) {
                    round_success_noti("Status updated successfully.");
                    $('#btnGo').click();
                } else {
                    // Find failed responses
                    var failedResponses = responses.filter(function(response) {
                        return !response.isSuccess;
                    });

                    if (failedResponses.length > 0) {
                        round_error_noti(failedResponses[0].responseMessage || "Some updates failed.");
                    } else {
                        round_error_noti("Update failed.");
                    }
                }
            })
            .catch(function(error) {
                hideLoder();
                console.error("Error details:", error);
                round_error_noti("Something went wrong during update.");
            });
    }


    // Handle window resize
    $(window).on('resize', function() {
        var gridInstance = $("#exitGrid").data("dxDataGrid");
        if (gridInstance) {
            setTimeout(function() {
                gridInstance.updateDimensions();
            }, 100);
        }
    });
</script>

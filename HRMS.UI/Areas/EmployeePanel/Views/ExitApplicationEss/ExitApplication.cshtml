@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Exit Application";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    string UIBaseUrlLayout = Configuration["UIBaseUrlSettings:baseUrl"];
    var uriAPI = new Uri(baseUrl);
    string baseAPIDomainUrl = $"{uriAPI.Scheme}://{uriAPI.Host}:{uriAPI.Port}";
}
<title>Exit Application Form</title>
<!-- jQuery + Bootstrap + SweetAlert -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
    }

    .form-section {
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
    }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        font-weight: 600;
        padding: 4px 12px;
        border: none;
        border-radius: 4px;
        transition: background-color 0.3s ease;
    }

        .btn-custom:hover {
            background-color: #2c3a57;
        }

        .btn-custom:active,
        .btn-custom:focus {
            background-color: #3e4b6d !important;
            box-shadow: none !important;
            outline: none !important;
        }

    .search-panel-container {
        background-color: #3e4b6d;
        padding: 6px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }

        .form-label.required::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

    .form-control-sm, .form-select-sm {
        height: calc(1.5em + .5rem + 2px);
        font-size: 0.875rem;
        padding: .25rem .5rem;
    }

    .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    .is-invalid {
        border-color: #dc3545 !important;
    }

    .info-box {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 10px;
        border-radius: 4px;
        font-size: 12px;
        color: #856404;
        margin-top: 10px;
    }

    .terms-container {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 4px;
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 10px;
    }

        .terms-container h6 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #3e4b6d;
        }

        .terms-container p {
            font-size: 12px;
            line-height: 1.6;
            margin-bottom: 8px;
        }

    .agreement-checkbox {
        margin-top: 10px;
    }

    .file-upload-wrapper {
        position: relative;
    }

    .file-name-display {
        display: inline-block;
        margin-left: 10px;
        font-size: 12px;
        color: #3e4b6d;
    }

    .remove-file {
        cursor: pointer;
        color: #dc3545;
        margin-left: 5px;
        font-weight: bold;
    }

    .calculated-field {
        background-color: #f8f9fa;
        cursor: not-allowed;
    }

    .btn-custom:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        pointer-events: none;
    }
</style>
<div class="container-fluid">
    <div class="search-panel-wrapper">
        <div class="search-panel-container">
            <div class="search-panel-row">
                <div class="search-heading">Exit Application</div>
                <div class="col-auto">
                    <a href="@Url.Action("ExitApplicationReport", "ExitApplicationEss", new { area = "EmployeePanel" })" class="btn btn-primary btn-sm">Back</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-7">
            <div class="form-section">
                <!-- Row 1 -->
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label required">Application Date:</label>
                        <input type="date" class="form-control form-control-sm" id="applicationDate" readonly>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Employee:</label>
                        <input type="text" class="form-control form-control-sm" id="employeeName" readonly>
                    </div>
                </div>

                <!-- Row 2 -->
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Reporting Manager:</label>
                        <input type="text" class="form-control form-control-sm" id="reportingManager" readonly>
                        <input type="hidden" id="reportingManagerId" />
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label required">Date of Resignation/Intimation:</label>
                        <input type="date" class="form-control form-control-sm" id="resignationDate">
                        <span class="error-message" id="resignationDateError">Please select resignation date</span>
                    </div>
                </div>

                <!-- Row 3 -->
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Notice Period (Days):</label>
                        <input type="number" class="form-control form-control-sm calculated-field" id="noticePeriod" readonly>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label required">Last Working Date/Left Date:</label>
                        <input type="date" class="form-control form-control-sm" id="lastWorkingDate">
                        <span class="error-message" id="lastWorkingDateError">Please select last working date</span>
                    </div>
                </div>

                <!-- Row 4 -->
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Short Fall Days:</label>
                        <input type="number" class="form-control form-control-sm calculated-field" id="shortFallDays" readonly>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label required">Reason for Resignation:</label>
                        <select class="form-select form-select-sm" id="resignationReason">
                            <option value="">-- Select Reason --</option>
                            <option value="Better Opportunity">Better Opportunity</option>
                            <option value="Personal Reasons">Personal Reasons</option>
                            <option value="Health Issues">Health Issues</option>
                            <option value="Higher Studies">Higher Studies</option>
                            <option value="Relocation">Relocation</option>
                            <option value="Career Change">Career Change</option>
                            <option value="Other">Other</option>
                        </select>
                        <span class="error-message" id="reasonError">Please select reason for resignation</span>
                    </div>
                </div>

                <!-- Row 5 -->
                <div class="row">
                    <div class="col-md-12 mb-2">
                        <label class="form-label">Comments:</label>
                        <textarea class="form-control form-control-sm" id="comments" rows="3" placeholder="Additional comments..."></textarea>
                    </div>
                </div>

                <!-- Row 6 - File Upload -->
                <div class="row">
                    <div class="col-md-12 mb-2">
                        <label class="form-label">Attach Documents:</label>
                        <div class="file-upload-wrapper">
                            <input type="file" class="form-control form-control-sm" id="attachDocument" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            <span class="file-name-display" id="fileNameDisplay"></span>
                        </div>
                        <small class="text-muted">Supported formats: PDF, DOC, DOCX, JPG, PNG (Max 5MB)</small>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="d-flex justify-content-end flex-wrap gap-2 mt-3">
                    <button type="button" class="btn btn-custom" id="submitBtn">Submit</button>
                    <button type="button" class="btn btn-custom" id="submittingBtn" style="display:none;" disabled>
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        Submitting...
                    </button>
                    <button type="button" class="btn btn-custom" id="clearBtn">Clear</button>
                </div>
            </div>
        </div>

        <!-- Right Side - Terms and Conditions -->
        <div class="col-md-5">
            <div class="form-section">
                <div class="card-header">
                    <h6 class="mb-0 form-label">Terms And Conditions</h6>
                </div>
                <div class="info-box">
                    <strong>Note:</strong> Check the agreement to save the application
                </div>
                <div class="terms-container">
                    <h6>Exit Application Terms</h6>
                    <p>Employees should compulsory serve notice period, in case employee fails to serve the notice period will not be issued the Relieving Letter and Full n Final Settlement shall be processed after recovering Pay equivalent to Notice Pay. In case employee is in possession of any assets or product or process related material, the same needed to be handed over to immediate HOD before Last working date.</p>
                </div>
                <div class="agreement-checkbox">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="agreementCheckbox">
                        <label class="form-check-label" for="agreementCheckbox">
                            <strong>I Accept The Agreement</strong>
                        </label>
                    </div>
                    <span class="error-message" id="agreementError">Please accept the terms and conditions</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const Empid = parseInt(localStorage.getItem("EmployeeId"));
    const EmployeeName = localStorage.getItem("EmployeeName");
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany || '{}');
    const Compid = parseInt(companyDetails.CompanyId);
    const today = new Date();
    const NOTICE_PERIOD_DAYS = 30; // Fixed notice period

    function showBtnLoader() {
        $('#submitBtn').prop('disabled', true);
        $('#submitBtn').html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Submitting...');
    }

    function hideBtnLoader() {
        $('#submitBtn').prop('disabled', false);
        $('#submitBtn').html('Submit');
    }

    $(document).ready(function () {
        // Initialize form
        const formattedDate = today.toISOString().split('T')[0];
        $('#applicationDate').val(formattedDate);
        $('#employeeName').val(EmployeeName);

        // Notice period by default 30
        $('#noticePeriod').val(NOTICE_PERIOD_DAYS);

        // Debug localStorage values
        console.log('Employee ID:', Empid);
        console.log('Employee Name:', EmployeeName);

        loadReportingManager();

        // Event handlers
        $('#resignationDate').on('change', calculateNoticePeriod);
        $('#lastWorkingDate').on('change', calculateNoticePeriod);

        $('#attachDocument').on('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire('Error', 'File size should not exceed 5MB', 'error');
                    $(this).val('');
                    $('#fileNameDisplay').text('');
                    return;
                }
                $('#fileNameDisplay').html(`${file.name} <span class="remove-file" onclick="removeFile()">✕</span>`);
            }
        });

        $('#submitBtn').on('click', handleSubmit);
        $('#clearBtn').on('click', clearForm);
    });

    function removeFile() {
        $('#attachDocument').val('');
        $('#fileNameDisplay').text('');
    }

    function loadReportingManager() {

        const apiUrl = `@baseUrl/LeaveApplication/GetReportingperson?Empid=${Empid}`;
        if (!Empid || isNaN(Empid)) {
            console.error('Invalid Employee ID');
            return;
        }

        $.ajax({
            url: apiUrl,
            method: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            success: function (response) {

                if (response.isSuccess && response.data) {
                    $('#reportingManager').val(response.data.fullName);
                    $('#reportingManagerId').val(response.data.id);

                } else {

                    $('#reportingManager').val('Not Assigned');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading reporting manager:');
                console.error('Status:', status);
                console.error('Error:', error);
                console.error('Response:', xhr.responseText);
                $('#reportingManager').val('Error loading manager');
            }
        });
    }


    function calculateNoticePeriod() {
        const resignationDate = $('#resignationDate').val();
        const lastWorkingDate = $('#lastWorkingDate').val();

        // Notice period is always 30 days
        $('#noticePeriod').val(NOTICE_PERIOD_DAYS);

        // Clear previous LWD errors
        $('#lastWorkingDate').removeClass('is-invalid');
        $('#lastWorkingDateError').hide();

        // Agar dono dates available hain tabhi calculate karo
        if (resignationDate && lastWorkingDate) {
            const resDate = new Date(resignationDate + 'T00:00:00');
            const lwDate = new Date(lastWorkingDate + 'T00:00:00');

            // --- Validation: LWD resignation date se pehle nahi ho sakta ---
            if (lwDate < resDate) {
                $('#lastWorkingDate').addClass('is-invalid');
                $('#lastWorkingDateError').text('Last working date cannot be before resignation date').show();
                $('#shortFallDays').val('');
                return;
            }

            // Notice End Date = Resignation Date + 30 days
            const noticeEndDate = new Date(resDate);
            noticeEndDate.setDate(noticeEndDate.getDate() + NOTICE_PERIOD_DAYS);

            // Short Fall = agar employee ne notice period poora nahi serve kiya
            if (lwDate < noticeEndDate) {
                const diffTime = noticeEndDate.getTime() - lwDate.getTime();
                const shortFall = Math.round(diffTime / (1000 * 60 * 60 * 24));
                $('#shortFallDays').val(shortFall);
            } else {
                // Full notice period serve kiya — no shortfall
                $('#shortFallDays').val(0);
            }

        } else {
            // Dono dates nahi hain toh shortfall blank
            $('#shortFallDays').val('');
        }
    }

    function validateForm() {
        let isValid = true;
        $('.error-message').hide();
        $('.form-control, .form-select').removeClass('is-invalid');

        const resignationDate = $('#resignationDate').val();
        const lastWorkingDate = $('#lastWorkingDate').val();
        const reason = $('#resignationReason').val();
        const agreementAccepted = $('#agreementCheckbox').is(':checked');

        if (!resignationDate) {
            $('#resignationDate').addClass('is-invalid');
            $('#resignationDateError').show();
            isValid = false;
        }

        if (!lastWorkingDate) {
            $('#lastWorkingDate').addClass('is-invalid');
            $('#lastWorkingDateError').text('Please select last working date').show();
            isValid = false;
        } else if (resignationDate) {
            // Re-run date validation on submit
            const resDate = new Date(resignationDate + 'T00:00:00');
            const lwDate = new Date(lastWorkingDate + 'T00:00:00');
            if (lwDate < resDate) {
                $('#lastWorkingDate').addClass('is-invalid');
                $('#lastWorkingDateError').text('Last working date cannot be before resignation date').show();
                isValid = false;
            }
        }

        if (!reason) {
            $('#resignationReason').addClass('is-invalid');
            $('#reasonError').show();
            isValid = false;
        }

        if (!agreementAccepted) {
            $('#agreementCheckbox').addClass('is-invalid');
            $('#agreementError').show();
            isValid = false;
        }

        return isValid;
    }


    async function handleSubmit() {
        if (!validateForm()) {
            Swal.fire({
                title: 'Validation Error',
                text: 'Please fill all required fields',
                icon: 'warning'
            });
            return;
        }

        showBtnLoader();

        try {
            const fileInput = document.getElementById('attachDocument');
            let documentData = "";
            let documentName = "";

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                documentName = file.name;
                documentData = await fileToBase64(file);
            }

            const payload = {
                ResignationDate: $('#resignationDate').val(),
                EmployeeId: Empid,
                NoticePeriodDays: parseInt($('#noticePeriod').val()) || 0,
                LastWorkingDate: $('#lastWorkingDate').val(),
                ShortFallDays: parseInt($('#shortFallDays').val()) || 0,
                ReasonForResignation: $('#resignationReason').val(),
                Comments: $('#comments').val() || '',
                DocumentName: documentName,
                DocumentData: documentData,
                IsAgreementAccepted: $('#agreementCheckbox').is(':checked'),
                IsPending: true,
                IsApproved: false,
                IsRejected: false,
                CreatedBy: Empid
            };

            $.ajax({
                url: `@baseUrl/ExitApplicationAPI/CreateExitAppication`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (response) {
                    hideBtnLoader();
                    console.log('Submit response:', response);

                    if (response.isSuccess) {
                        Swal.fire({
                            title: 'Success',
                            text: 'Exit application submitted successfully',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            clearForm();
                            // Optionally redirect to list page
                            // window.location.href = '@Url.Action("ExitApplicationList", "Exit", new { area = "EmployeePanel" })';
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: response.responseMessage || 'Failed to submit application',
                            icon: 'error'
                        });
                    }
                },
                error: function (xhr, status, error) {
                    hideBtnLoader();
                    console.error('Submit error:', xhr, status, error);
                    console.error('Response Text:', xhr.responseText);

                    let errorMessage = 'An error occurred while submitting the application';

                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        errorMessage = errorResponse.responseMessage || errorMessage;
                    } catch (e) {
                        // If response is not JSON, use default message
                    }

                    Swal.fire({
                        title: 'Error',
                        text: errorMessage,
                        icon: 'error'
                    });
                }
            });

        } catch (error) {
            hideBtnLoader();
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'An error occurred while processing the file',
                icon: 'error'
            });
        }
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                const base64String = reader.result.split(',')[1];
                resolve(base64String);
            };
            reader.onerror = error => reject(error);
        });
    }

    function clearForm() {
        $('#resignationDate').val('');
        $('#lastWorkingDate').val('');
        $('#noticePeriod').val(NOTICE_PERIOD_DAYS); // Clear pe wapas 30 set hoga
        $('#shortFallDays').val('');
        $('#resignationReason').val('');
        $('#comments').val('');
        $('#attachDocument').val('');
        $('#fileNameDisplay').text('');
        $('#agreementCheckbox').prop('checked', false);

        $('.form-control, .form-select').removeClass('is-invalid');
        $('.error-message').hide();

        const formattedDate = today.toISOString().split('T')[0];
        $('#applicationDate').val(formattedDate);
    }
</script>

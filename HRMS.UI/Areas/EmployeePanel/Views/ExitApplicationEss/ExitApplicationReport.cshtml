@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Exit Application";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrls = Configuration["BaseUrlSettings:baseUrl"];
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrls);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}

<title>Exit Application</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #ffffff;
    }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        border: none;
        padding: 4px 12px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 4px;
        transition: none;
        box-shadow: none;
    }

        .btn-custom:hover,
        .btn-custom:focus,
        .btn-custom:active {
            background-color: #3e4b6d;
            color: white;
            outline: none;
            box-shadow: none;
        }

    .btn-add {
        background-color: #28a745;
        color: white;
        font-size: 14px;
        padding: 6px 15px;
        border: none;
        border-radius: 4px;
    }

        .btn-add:hover {
            background-color: #218838;
        }

    .btn-fill-form {
        background-color: #007bff;
        color: white;
        font-size: 12px;
        padding: 4px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

        .btn-fill-form:hover {
            background-color: #0056b3;
        }

    .search-panel-wrapper {
        max-width: 100%;
        margin: auto;
    }

    .search-panel-container {
        background-color: #3e4b6d;
        padding: 6px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }

    .container {
        max-width: 100% !important;
        width: 100% !important;
        padding-left: 15px;
        padding-right: 15px;
    }

    .grid-container {
        width: 100% !important;
        overflow-x: auto;
        margin: 0;
        padding: 0;
    }

    #exitApplicationGrid {
        width: 100% !important;
        min-width: 100% !important;
    }

        #exitApplicationGrid .dx-datagrid {
            width: 100% !important;
        }

        #exitApplicationGrid .dx-datagrid-content {
            width: 100% !important;
        }

        #exitApplicationGrid .dx-datagrid-table {
            width: 100% !important;
            table-layout: auto !important;
        }

    .custom-action-buttons {
        width: 100%;
        margin-bottom: 10px;
    }

    .note-section {
        margin-top: 15px;
        font-size: 13px;
        color: #333;
    }

        .note-section p {
            margin: 5px 0;
        }

    /* NOC Modal Styles */
    .noc-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }

    .noc-modal-content {
        background-color: #fefefe;
        margin: 2% auto;
        padding: 0;
        border: 1px solid #888;
        width: 90%;
        max-width: 900px;
        border-radius: 8px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .noc-modal-header {
        background-color: #3e4b6d;
        color: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .noc-modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

    .noc-close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 20px;
    }

        .noc-close:hover {
            color: #ddd;
        }

    .noc-modal-body {
        padding: 20px;
    }

    .noc-form-section {
        margin-bottom: 25px;
    }

        .noc-form-section h4 {
            background-color: #f0f0f0;
            padding: 10px;
            margin: 0 0 15px 0;
            border-left: 4px solid #3e4b6d;
            font-size: 15px;
        }

    .noc-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

        .noc-table th,
        .noc-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }

        .noc-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .noc-table input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .noc-table input[type="text"] {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

    .noc-modal-footer {
        padding: 15px 20px;
        background-color: #f8f9fa;
        border-top: 1px solid #ddd;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .btn-save-noc {
        background-color: #28a745;
        color: white;
        padding: 8px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

        .btn-save-noc:hover {
            background-color: #218838;
        }

    .btn-cancel-noc {
        background-color: #6c757d;
        color: white;
        padding: 8px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

        .btn-cancel-noc:hover {
            background-color: #5a6268;
        }

    .noc-note {
        margin-top: 20px;
        padding: 15px;
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        font-size: 12px;
    }

        .noc-note p {
            margin: 5px 0;
        }

    .btn-update-form {
        background-color: #ffc107;
        color: #000;
        font-size: 12px;
        padding: 4px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
    }

        .btn-update-form:hover {
            background-color: #e0a800;
        }
</style>

<div class="search-panel-wrapper">
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">EXIT APPLICATION</div>
        </div>
    </div>
</div>

<div class="container mt-3">
    <div id="actionButtons" class="custom-action-buttons text-end mb-2">
        <button id="btnAdd" class="btn btn-add" style="display: none;">Add</button>
        <button id="btnDelete" class="btn btn-custom" style="display: none;">Delete</button>
    </div>

    <div id="grid-loader"
         class="grid-loader justify-content-center align-items-center flex-column"
         style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(3px); z-index: 9999;">
        <img src="@baseDomainUrl/loders/loder.png"
             class="grid-logo-spinner"
             style="width: 40px; height: 40px; animation: spin 1s linear infinite;" />
        <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>
    </div>

    <div class="grid-container">
        <div id="exitApplicationGrid"></div>
        <div id="noRecordMessage" style="display: none; text-align: center; padding: 40px; font-size: 14px; color: #666;">
            No Records found.
        </div>
    </div>

    <div class="note-section">
        <p><strong>Note:</strong></p>
        <p><span style="color: red; font-weight: bold;">Reject *</span> indicate that exit application rejected by manager without interview process.</p>
        <p><span style="color: red; font-weight: bold;">Reject</span> indicate that exit application rejected by manager with interview process.</p>
    </div>
</div>

<!-- NOC Form Modal -->
<div id="nocModal" class="noc-modal">
    <div class="noc-modal-content">
        <div class="noc-modal-header">
            <h3>No Dues Claim / F & F Settlement Form</h3>
            <span class="noc-close">&times;</span>
        </div>
        <div class="noc-modal-body">
            <form id="nocForm">
                <input type="hidden" id="currentExitAppId" />

                <div class="noc-form-section">
                    <h4>Department / Section Handover</h4>
                    <table class="noc-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Item</th>
                                <th style="width: 10%; text-align: center;">Yes</th>
                                <th style="width: 10%; text-align: center;">No</th>
                                <th style="width: 20%;">Handover to</th>
                                <th style="width: 20%;">Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr data-item="softCopies">
                                <td>To handover files handled by him/her (Soft Copies) (list required)</td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-yes-checkbox" data-item="softCopies" /></td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-no-checkbox" data-item="softCopies" /></td>
                                <td><input type="text" class="handover-to" /></td>
                                <td><input type="text" class="remarks" /></td>
                            </tr>
                            <tr data-item="hardCopies">
                                <td>Hard copies (list required)</td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-yes-checkbox" data-item="hardCopies" /></td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-no-checkbox" data-item="hardCopies" /></td>
                                <td><input type="text" class="handover-to" /></td>
                                <td><input type="text" class="remarks" /></td>
                            </tr>
                            <tr data-item="laptop">
                                <td>Laptop</td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-yes-checkbox" data-item="laptop" /></td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-no-checkbox" data-item="laptop" /></td>
                                <td><input type="text" class="handover-to" /></td>
                                <td><input type="text" class="remarks" /></td>
                            </tr>
                            <tr data-item="idCard">
                                <td>ID Card</td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-yes-checkbox" data-item="idCard" /></td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-no-checkbox" data-item="idCard" /></td>
                                <td><input type="text" class="handover-to" /></td>
                                <td><input type="text" class="remarks" /></td>
                            </tr>
                            <tr data-item="keys">
                                <td>Keys for drawers, Cabinets, etc.</td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-yes-checkbox" data-item="keys" /></td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-no-checkbox" data-item="keys" /></td>
                                <td><input type="text" class="handover-to" /></td>
                                <td><input type="text" class="remarks" /></td>
                            </tr>
                            <tr data-item="vehicle">
                                <td>Company Vehicle with Vehicle No.</td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-yes-checkbox" data-item="vehicle" /></td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-no-checkbox" data-item="vehicle" /></td>
                                <td><input type="text" class="handover-to" /></td>
                                <td><input type="text" class="remarks" /></td>
                            </tr>
                            <tr data-item="advance">
                                <td>Advance/Loan, If any</td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-yes-checkbox" data-item="advance" /></td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-no-checkbox" data-item="advance" /></td>
                                <td><input type="text" class="handover-to" /></td>
                                <td><input type="text" class="remarks" /></td>
                            </tr>
                            <tr data-item="accommodation">
                                <td>Accommodation</td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-yes-checkbox" data-item="accommodation" /></td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-no-checkbox" data-item="accommodation" /></td>
                                <td><input type="text" class="handover-to" /></td>
                                <td><input type="text" class="remarks" /></td>
                            </tr>
                            <tr data-item="mobilePhone">
                                <td>Mobile Phone / Sim Card</td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-yes-checkbox" data-item="mobilePhone" /></td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-no-checkbox" data-item="mobilePhone" /></td>
                                <td><input type="text" class="handover-to" /></td>
                                <td><input type="text" class="remarks" /></td>
                            </tr>
                            <tr data-item="mobileSetNo">
                                <td>Mobile Set No. / Sim No.</td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-yes-checkbox" data-item="mobileSetNo" /></td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-no-checkbox" data-item="mobileSetNo" /></td>
                                <td><input type="text" class="handover-to" /></td>
                                <td><input type="text" class="remarks" /></td>
                            </tr>
                            <tr data-item="otherBelongings">
                                <td>Other Belongings, If any</td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-yes-checkbox" data-item="otherBelongings" /></td>
                                <td style="text-align: center;"><input type="checkbox" class="noc-no-checkbox" data-item="otherBelongings" /></td>
                                <td><input type="text" class="handover-to" /></td>
                                <td><input type="text" class="remarks" /></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="noc-note">
                    <p><strong>Note:</strong></p>
                    <p>Settlement will have to be made to the employee only after obtaining this form duly approved by all concerned and Full & final settlement will be done after 45 days from the last working day and if, employee will not serve notice period then amount against F & F settlement amount.</p>
                    <p><strong>Employee's Self Declaration on his Personal Liabilities / as a Guarantor:</strong></p>
                    <p>For any kind of loan (Home Loan/Personal Loan/ Vehicle Loan etc.) is taken by me from third party, in that case Relay Express will not be held responsible and shall not be held exclusively liable to repay my loan or any kind of personal liabilities. Also, if I have taken guarantee of any person's loan repayment, then I will be solely & exclusively responsible for that loan repayment. Relay Express will nowhere liable for that repayment.</p>
                </div>
            </form>
        </div>
        <div class="noc-modal-footer">
            <button type="button" class="btn-cancel-noc">Cancel</button>
            <button type="button" class="btn-save-noc">Save</button>
        </div>
    </div>
</div>

<script>
    const EmployeeId = localStorage.getItem('EmployeeId');

    function safeDisposeGrid() {
        try {
            var gridInstance = $("#exitApplicationGrid").data("dxDataGrid");
            if (gridInstance) {
                gridInstance.dispose();
            }
        } catch (e) {
        }
        $("#exitApplicationGrid").empty();
    }

    $(document).ready(function () {
        loadExitApplicationData();

        $("#btnAdd").click(function () {
            window.location.href = '@UIBaseUrl/EmployeePanel/ExitApplicationEss/ExitApplication';
        });

        $("#btnDelete").click(function () {
            var grid = $("#exitApplicationGrid").dxDataGrid("instance");
            var selectedRows = grid.getSelectedRowsData();

            if (selectedRows.length === 0) {
                round_error_noti("Please select at least one record.");
                return;
            }

            const approvedRecords = selectedRows.filter(row => row.status === 'Approved');
            if (approvedRecords.length > 0) {
                Swal.fire({
                    title: "Not Allowed",
                    text: "Approved records cannot be deleted.",
                    icon: "error"
                });
                return;
            }

            showLoder();

            const selectedIds = selectedRows.map(row => row.exitApplicationID);

            const deletePayload = {
                Id: selectedIds,
                DeletedBy: EmployeeId
            };

            $.ajax({
                url: "@baseUrls/ExitApplicationAPI/Delete",
                type: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify(deletePayload),
                success: function (res) {
                    hideLoder();
                    if (res.isSuccess) {
                        round_success_noti(res.responseMessage || "Deleted successfully.");
                        loadExitApplicationData();
                    } else {
                        round_error_noti(res.responseMessage || "Deletion failed.");
                    }
                },
                error: function () {
                    hideLoder();
                    round_error_noti("Something went wrong during deletion.");
                }
            });
        });

        // NOC Modal handlers
        $(".noc-close, .btn-cancel-noc").click(function () {
            $("#nocModal").hide();
        });

        // Close modal on outside click
        $(window).click(function (event) {
            if (event.target.id === 'nocModal') {
                $("#nocModal").hide();
            }
        });

        // Checkbox exclusive selection (Yes/No cannot both be checked)
        $(".noc-yes-checkbox").change(function () {
            if ($(this).is(':checked')) {
                $(`.noc-no-checkbox[data-item="${$(this).data('item')}"]`).prop('checked', false);
            }
        });

        $(".noc-no-checkbox").change(function () {
            if ($(this).is(':checked')) {
                $(`.noc-yes-checkbox[data-item="${$(this).data('item')}"]`).prop('checked', false);
            }
        });

        // Save NOC Form
        $(".btn-save-noc").click(function () {
            saveNOCForm();
        });
    });

    async function showLoder() {
        $('#grid-loader').addClass('d-flex').show();
    }

    async function hideLoder() {
        $('#grid-loader').removeClass('d-flex').hide();
    }

    function loadExitApplicationData() {
        showLoder();

        $.ajax({
            url: "@baseUrls/ExitApplicationAPI/GetExitApplicationById",
            type: 'GET',
            data: { EmployeeId: EmployeeId },
            success: function (res) {
                hideLoder();
                if (res.isSuccess && res.data) {
                    let gridData = Array.isArray(res.data) ? res.data : [res.data];
                    $("#btnAdd").hide();
                    $("#btnDelete").show();
                    loadGrid(gridData);
                } else {
                    $("#btnAdd").show();
                    $("#btnDelete").hide();
                    safeDisposeGrid();
                }
            },
            error: function (xhr, status, error) {
                hideLoder();
                console.error('AJAX Error:', error);
                $("#btnAdd").show();
                $("#btnDelete").hide();
                safeDisposeGrid();
            }
        });
    }

    function loadGrid(data) {
        console.log('Grid Data:', data);
        safeDisposeGrid();
        $("#noRecordMessage").hide();

        $("#exitApplicationGrid").dxDataGrid({
            dataSource: data,
            keyExpr: "exitApplicationID",
            showBorders: true,
            width: "100%",
            height: "auto",
            columnAutoWidth: true,
            wordWrapEnabled: false,
            paging: {
                enabled: false
            },
            scrolling: {
                mode: "standard",
                useNative: true,
                showScrollbar: "always"
            },
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "always"
            },
            filterRow: { visible: false },
            searchPanel: { visible: false },
            columns: [
                { dataField: "employeeCode", caption: "Code", width: 100 },
                { dataField: "fullName", caption: "Employee", width: 250 },
                { dataField: "resignationDate", caption: "Resignation Date", dataType: "date", format: "dd/MM/yyyy", width: 150 },
                { dataField: "lastWorkingDate", caption: "Last Working Date", dataType: "date", format: "dd/MM/yyyy", width: 150 },
                {
                    caption: "Status",
                    width: 150,
                    alignment: "center",
                    cellTemplate: function (container, options) {
                        const row = options.data;
                        let statusText = "";
                        if (row.isApproved === true) statusText = "Approved";
                        else if (row.isRejected === true) statusText = "Rejected";
                        else if (row.isPending === true) statusText = "Pending";
                        $("<span>").text(statusText).appendTo(container);
                    }
                },
                {
                    caption: "NOC Status",
                    width: 120,
                    alignment: "center",
                    cellTemplate: function (container, options) {
                        const row = options.data;
                        const isFormFilled = row.isNOCFormFilled === true || row.IsNOCFormFilled === true;

                        if (isFormFilled) {
                            $("<span>").text("✅ Filled").css("color", "green").appendTo(container);
                        } else {
                            $("<span>").text("⏳ Pending").css("color", "orange").appendTo(container);
                        }
                    }
                },
                {
                    caption: "Fill NOC Form",
                    width: 150,
                    alignment: "center",
                    cellTemplate: function (container, options) {
                        const row = options.data;

                        console.log("Button rendering - IsNOCFormFilled:", row.isNOCFormFilled);

                        if (row.isApproved === true) {
                            const isFormFilled = row.isNOCFormFilled === true || row.IsNOCFormFilled === true;

                            const buttonText = isFormFilled ? "Update NOC Form" : "Fill NOC Form";
                            const buttonClass = isFormFilled ? "btn-update-form" : "btn-fill-form";

                            const fillFormBtn = $("<button>")
                                .addClass(buttonClass)
                                .text(buttonText)
                                .click(function (e) {
                                    e.preventDefault();
                                    openNOCModal(row);
                                });
                            fillFormBtn.appendTo(container);
                        } else {
                            $("<span>").text("-").appendTo(container);
                        }
                    }
                }
            ]
        });
    }

    function openNOCModal(rowData) {
        // Reset form first
        $("#nocForm")[0].reset();
        $("#currentExitAppId").val(rowData.exitApplicationID);
        $(".noc-yes-checkbox, .noc-no-checkbox").prop('checked', false);
        $(".noc-table input[type='text']").val('');

        // Clear any existing NOSID data attributes
        $(".noc-table tbody tr[data-item]").removeAttr('data-nosid');

        // ⭐ Change button text based on form filled status
        const isFormFilled = rowData.isNOCFormFilled === true || rowData.IsNOCFormFilled === true;
        $(".btn-save-noc").text(isFormFilled ? "Update" : "Save");

        // Check if NOC form is already filled
        if (isFormFilled) {
            loadExistingNOCData(rowData.exitApplicationID);
        }

        $("#nocModal").show();
    }

    function loadExistingNOCData(exitAppId) {
        showLoder();

        $.ajax({
            url: "@baseUrls/NOCAPI/GetNOCByExitApplicationId?exitApplicationId=" + exitAppId,
            type: 'GET',
            success: function (response) {
                hideLoder();

                if (response.isSuccess && response.data && response.data.length > 0) {
                    console.log("📥 Loaded NOC Data:", response.data);

                    // Populate the form with existing data
                    response.data.forEach(function(item) {
                        $(".noc-table tbody tr[data-item]").each(function() {
                            const row = $(this);
                            const rowItemName = row.find('td:first').text().trim();

                            if (rowItemName === item.itemName) {
                                // Store NOSID in the row for update
                                row.attr('data-nosid', item.nosid);

                                // Set checkboxes
                                if (item.isHandedOver) {
                                    row.find('.noc-yes-checkbox').prop('checked', true);
                                    row.find('.noc-no-checkbox').prop('checked', false);
                                } else {
                                    row.find('.noc-yes-checkbox').prop('checked', false);
                                    row.find('.noc-no-checkbox').prop('checked', true);
                                }

                                // Set text fields
                                row.find('.handover-to').val(item.handoverTo || '');
                                row.find('.remarks').val(item.remarks || '');
                            }
                        });
                    });

                    console.log("✅ NOC Data loaded successfully in form");
                }
            },
            error: function (xhr, status, error) {
                hideLoder();
                console.error("❌ Error loading NOC data:", error);
                round_error_noti("Failed to load existing NOC data.");
            }
        });
    }

    function saveNOCForm() {
        const exitAppId = $("#currentExitAppId").val();

        if (!exitAppId) {
            round_error_noti("Exit Application ID is missing.");
            return;
        }

        // Collect all items from the table
        const nocItems = [];
        $(".noc-table tbody tr[data-item]").each(function () {
            const row = $(this);
            const itemName = row.find('td:first').text().trim();
            const yesChecked = row.find('.noc-yes-checkbox').is(':checked');
            const noChecked = row.find('.noc-no-checkbox').is(':checked');
            const handoverTo = row.find('.handover-to').val() || null;
            const remarks = row.find('.remarks').val() || null;
            const nosid = row.attr('data-nosid') ? parseInt(row.attr('data-nosid')) : 0;

            // Only add items that have at least one checkbox checked
            if (yesChecked || noChecked) {
                nocItems.push({
                    NOSID: nosid,
                    ExitApplicationID: parseInt(exitAppId),
                    ItemName: itemName,
                    IsHandedOver: yesChecked,
                    HandoverTo: handoverTo,
                    Remarks: remarks,
                    DocumentProof: null,
                    CreatedBy: parseInt(EmployeeId)
                });
            }
        });

        if (nocItems.length === 0) {
            round_error_noti("Please select at least one item.");
            return;
        }

        console.log("📤 Sending NOC Items:", nocItems);
        showLoder();

        let successCount = 0;
        let errorCount = 0;
        const totalItems = nocItems.length;

        // Process each item
        nocItems.forEach((item, index) => {
            const apiUrl = item.NOSID > 0
                ? "@baseUrls/NOCAPI/UpdateNOC"
                : "@baseUrls/NOCAPI/CreateNOC";

            const actionText = item.NOSID > 0 ? "Updating" : "Creating";

            console.log(`📝 ${actionText} Item ${index + 1}/${totalItems}:`, item.ItemName, `(NOSID: ${item.NOSID})`);

            $.ajax({
                url: apiUrl,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(item),
                success: function (response) {
                    console.log(`✅ Item ${index + 1}/${totalItems}:`, item.ItemName, response);
                    successCount++;

                    if (successCount + errorCount === totalItems) {
                        handleSaveComplete(successCount, errorCount, exitAppId);
                    }
                },
                error: function (xhr, status, error) {
                    console.error(`❌ Item ${index + 1}/${totalItems}:`, item.ItemName, {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        response: xhr.responseText,
                        error: error
                    });

                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        console.error("Server Error Details:", errorResponse);
                    } catch (e) {
                        console.error("Raw Error Response:", xhr.responseText);
                    }

                    errorCount++;

                    if (successCount + errorCount === totalItems) {
                        handleSaveComplete(successCount, errorCount, exitAppId);
                    }
                }
            });
        });
    }

    // ⭐ This function was missing!
    function handleSaveComplete(successCount, errorCount, exitAppId) {
        hideLoder();

        if (successCount > 0 && errorCount === 0) {
            // All items saved/updated successfully, now update the flag
            updateNOCFormFlag(exitAppId);
        } else if (successCount > 0 && errorCount > 0) {
            round_error_noti(`Saved/Updated: ${successCount}, Failed: ${errorCount}. Check console for details.`);
        } else {
            round_error_noti("Failed to save/update NOC items. Please check console for details.");
        }
    }

    function updateNOCFormFlag(exitAppId) {
        showLoder();

        $.ajax({
            url: "@baseUrls/ExitApplicationAPI/UpdateNOCFormFlag?exitApplicationId=" + exitAppId,
            type: 'PUT',
            contentType: 'application/json',
            success: function (response) {
                hideLoder();
                if (response.isSuccess) {
                    round_success_noti("NOC Form saved/updated successfully!");
                    $("#nocModal").hide();

                    // Reload grid to get fresh data
                    setTimeout(function() {
                        loadExitApplicationData();
                    }, 500);
                } else {
                    round_error_noti(response.responseMessage || "Failed to update NOC form flag.");
                }
            },
            error: function (xhr, status, error) {
                hideLoder();
                console.error("❌ Error updating NOC form flag:", error);
                round_error_noti("Failed to update NOC form flag.");
            }
        });
    }

    // Handle window resize
    $(window).on('resize', function () {
        var gridInstance = $("#exitApplicationGrid").data("dxDataGrid");
        if (gridInstance) {
            setTimeout(function () {
                gridInstance.updateDimensions();
            }, 100);
        }
    });
</script>
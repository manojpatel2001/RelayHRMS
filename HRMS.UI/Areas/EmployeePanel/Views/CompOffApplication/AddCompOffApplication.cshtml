@{
    ViewData["Title"] = "Employee Panel";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrl = ViewBag.BaseUrl;
    string apiBase = ViewBag.BaseUrlAPI;
}

<link href="~/commoncss.css" rel="stylesheet" />

<!-- SweetAlert2 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    .fixed-label {
        min-width: 130px;
        white-space: nowrap;
        margin-bottom: 0;
        text-align: right;
    }

    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .error-msg {
        font-size: 13px;
    }
</style>

<div class="card">
    <div class="card-header bg-transparent ml-0 py-0">
        <div class="row">
            <div class="col-6">
                <h4 class="pt-2 mb-0">Comp Off Application</h4>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header bg-transparent py-2">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="mb-0">Add Comp-Off Application</h6>
                    </div>
                    <div class="col-auto">
                        <a href='@Url.Action("Index", "CompOffApplication", new { area = "EmployeePanel" })' class="btn btn-primary btn-sm">Back</a>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <div class="form-container">
                    <form id="compoffForm">
                        <!-- Application Date -->
                       @*  <div class="row mb-3">
                            <label for="applicationDate" class="col-sm-4 col-form-label fixed-label">
                                Application Date<span class="text-danger">*</span>:
                            </label>
                            <div class="col-sm-4">
                                <input type="date" class="form-control form-control-sm" id="applicationDate">
                                <span class="text-danger error-msg" id="applicationDate-error" style="display:none">Application date is required</span>
                            </div>
                        </div> *@

                        <!-- Employee -->
                        <div class="row mb-3">
                            <label for="employeeid" class="col-sm-4 col-form-label fixed-label">
                                Employee<span class="text-danger">*</span>:
                            </label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control form-control-sm" id="employeeid" readonly>
                            </div>
                        </div>

                        <!-- Reporting Manager -->
                        <div class="row mb-3">
                            <label for="repoid" class="col-sm-4 col-form-label fixed-label">
                                Reporting Manager<span class="text-danger">*</span>:
                            </label>
                            <div class="col-sm-4">
                                <select class="form-control form-control-sm" id="repoid">
                                    <option value="0">Select</option>
                                </select>
                                <span class="text-danger error-msg" id="repoid-error" style="display:none">Please select a reporting manager</span>
                            </div>
                        </div>

                        <!-- Date of Extra Work -->
                        <div class="row mb-3">
                            <label for="extraworkdateid" class="col-sm-4 col-form-label fixed-label">
                                Date of Extra Work<span class="text-danger">*</span>:
                            </label>
                            <div class="col-sm-4">
                                <input type="date" class="form-control form-control-sm" id="extraworkdateid">
                                <span class="text-danger error-msg" id="extraworkdateid-error" style="display:none">Date of extra work is required</span>
                            </div>
                        </div>

                        <!-- Extra Worked Hours -->
                        <div class="row mb-3">
                            <label for="extraworkhrid" class="col-sm-4 col-form-label fixed-label">
                                Extra Worked Hours<span class="text-danger">*</span>:
                            </label>
                            <div class="col-sm-4">
                                <input type="time" class="form-control form-control-sm" id="extraworkhrid">
                                <span class="text-danger error-msg" id="extraworkhrid-error" style="display:none">Worked hours are required</span>
                            </div>
                        </div>

                        <!-- Reason -->
                        <div class="row mb-3">
                            <label for="reasonid" class="col-sm-4 col-form-label fixed-label">
                                Reason for Extra Work<span class="text-danger">*</span>:
                            </label>
                            <div class="col-sm-4">
                                <textarea class="form-control form-control-sm" id="reasonid" rows="3"></textarea>
                                <span class="text-danger error-msg" id="reasonid-error" style="display:none">Please provide a reason</span>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="row mb-3">
                            <div class="col-sm-4"></div>
                            <div class="col-sm-4">
                                <button type="submit" id="submitid" class="btn btn-primary btn-sm me-2">Submit</button>
                                <button type="reset" id="resetid" class="btn btn-secondary btn-sm">Clear</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const apiBase = '@apiBase';
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany);
    const Compid = parseInt(companyDetails.CompanyId);
    const Empid = parseInt(localStorage.getItem("EmployeeId"));
    const EmployeeName = localStorage.getItem("EmployeeName");

    $(document).ready(function () {
        $('#employeeid').val(EmployeeName);
        //$('#applicationDate').val(new Date().toISOString().split('T')[0]);
        loadreportingperson();

        // Validation & Submit
        $('#compoffForm').on('submit', function (e) {
            e.preventDefault();
            let isValid = true;
            $('.error-msg').hide();

            // if (!$('#applicationDate').val()) {
            //     $('#applicationDate-error').show(); isValid = false;
            // }
            if ($('#repoid').val() == "0") {
                $('#repoid-error').show(); isValid = false;
            }
            if (!$('#extraworkdateid').val()) {
                $('#extraworkdateid-error').show(); isValid = false;
            }
            if (!$('#extraworkhrid').val()) {
                $('#extraworkhrid-error').show(); isValid = false;
            }
            if (!$('#reasonid').val()) {
                $('#reasonid-error').show(); isValid = false;
            }

            if (!isValid) {
                $('html, body').animate({
                    scrollTop: $(".error-msg:visible:first").offset().top - 100
                }, 500);
                return;
            }

            const payload = {
                CreatedBy: Empid.toString(),
                Emp_Id: Empid,
                Cmp_Id: Compid,
                Extra_Work_Day: $('#extraworkdateid').val(),
                Extra_Work_Hours: $('#extraworkhrid').val(),
                Rep_Person_Id: $('#repoid').val(),
                ComoffReason: $('#reasonid').val(),
                //ApplicationDate: $('#applicationDate').val()
            };

            $.ajax({
                url: apiBase + '/CompOffAPI/CompOffDetailsApplication',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (res) {
                    Swal.fire({
                        icon: 'success',
                        title: res.responseMessage || '✅ Application submitted successfully.',
                        confirmButtonText: 'OK',
                        timer: 2000
                    });
                    $('#compoffForm')[0].reset();
                    $('#employeeid').val(EmployeeName);
                    //$('#applicationDate').val(new Date().toISOString().split('T')[0]);
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: '❌ Error submitting application.',
                        confirmButtonText: 'OK'
                    });
                }
            });
        });

        // Auto-hide errors on input
        $('#compoffForm input, #compoffForm textarea, #compoffForm select').on('input change', function () {
            $(this).siblings('.error-msg').hide();
        });
    });

    function loadreportingperson() {
        $.ajax({
            url: `${apiBase}/CompOffAPI/ReportingPersonEmpVise?Compid=${Compid}&Empid=${Empid}`,
            method: 'POST',
            success: function (res) {
                if (res.isSuccess && res.data && res.data.length > 0) {
                    var dropdown = $('#repoid');
                    dropdown.empty().append('<option value="0">Select</option>');
                    $.each(res.data, function (index, item) {
                        dropdown.append('<option value="' + item.reportingPersonId + '">' + item.reportingPersonName + '</option>');
                    });
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: res.responseMessage || '⚠ Unable to load reporting manager.',
                        confirmButtonText: 'OK'
                    });
                }
            },
            error: function (xhr) {
                Swal.fire({
                    icon: 'error',
                    title: '❌ Server error: ' + xhr.responseText,
                    confirmButtonText: 'OK'
                });
            }
        });
    }
</script>

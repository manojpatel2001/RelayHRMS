@{
    ViewData["Title"] = "Employee Panel";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrl = ViewBag.BaseUrl;
    string apiBase = ViewBag.BaseUrlAPI;
}

<!-- Dependencies -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f9f9f9;
    }

    /* Top header panels */
    .search-panel-container {
        background-color: #3e4b6d;
        padding: 8px 20px;
        border-radius: 6px;
        margin-bottom: 15px;
        width: 100%;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }

    /* Center wrapper for form */
    .center-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: calc(100vh - 120px);
        padding: 30px 15px;
    }

    /* Form design */
    .form-section {
        background-color: #fff;
        padding: 25px 30px;
        border: 1px solid #ccc;
        border-radius: 8px;
        width: 100%;
        max-width: 750px;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
    }

    .form-control-sm, .form-select-sm {
        font-size: 0.875rem;
        padding: .25rem .5rem;
        height: calc(1.5em + .5rem + 2px);
    }

    .error-msg {
        font-size: 12px;
        color: red;
        display: none;
    }
</style>

<!-- Full-width Top Header Section -->
<div class="top-header">
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Search Panel</div>
            <div class="col-auto">
                <a href='@Url.Action("Index", "CompOffApplication", new { area = "EmployeePanel" })' class="btn btn-primary btn-sm">Back</a>
            </div>
        </div>
    </div>

    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Comp-Off Application</div>
        </div>
    </div>
</div>

<!-- Centered Form Section -->
<div class="center-wrapper">
    <form id="compoffForm" class="form-section">
        <div class="row mb-3">
            <label for="employeeid" class="col-sm-4 col-form-label form-label">Employee<span class="text-danger">*</span>:</label>
            <div class="col-sm-8">
                <input type="text" class="form-control form-control-sm" id="employeeid" readonly>
            </div>
        </div>


        <div class="row mb-3">
            <label for="repoid" class="col-sm-4 col-form-label form-label">Reporting Person:</label>
            <div class="col-sm-8">
                <input type="text" class="form-control form-control-sm" id="repoid" readonly>
                <input type="hidden" id="reportingManagerId" />
            </div>
        </div>
       


        <div class="row mb-3">
            <label for="extraworkdateid" class="col-sm-4 col-form-label form-label">Date of Extra Work<span class="text-danger">*</span>:</label>
            <div class="col-sm-8">
                <input type="date" class="form-control form-control-sm" id="extraworkdateid">
                <span class="error-msg" id="extraworkdateid-error">Date of extra work is required</span>
            </div>
        </div>

        <div class="row mb-3">
            <label for="extraworkhrid" class="col-sm-4 col-form-label form-label">Extra Worked Hours<span class="text-danger">*</span>:</label>
            <div class="col-sm-8">
                <input type="time" class="form-control form-control-sm" id="extraworkhrid">
                <span class="error-msg" id="extraworkhrid-error">Worked hours are required</span>
            </div>
        </div>

        <div class="row mb-3">
            <label for="reasonid" class="col-sm-4 col-form-label form-label">Reason for Extra Work<span class="text-danger">*</span>:</label>
            <div class="col-sm-8">
                <textarea class="form-control form-control-sm" id="reasonid" rows="3"></textarea>
                <span class="error-msg" id="reasonid-error">Please provide a reason</span>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12 d-flex justify-content-end">
                <button type="submit" id="submitid" class="search-panel-container  search-heading btn-sm me-2">Submit</button>
                <button type="reset" id="resetid" class="search-panel-container  search-heading btn-sm">Clear</button>
            </div>
        </div>
    </form>
</div>

<!-- JavaScript Logic -->
<script>
    const apiBase = '@apiBase';
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany);
    const Compid = parseInt(companyDetails.CompanyId);
    const Empid = parseInt(localStorage.getItem("EmployeeId"));
    const EmployeeName = localStorage.getItem("EmployeeName");

    $(document).ready(function () {
        $('#employeeid').val(EmployeeName);
        loadReportingPerson();

        $('#compoffForm').on('submit', function (e) {
            e.preventDefault();
            let isValid = true;
            $('.error-msg').hide();

            if ($('#repoid').val() == "0") {
                $('#repoid-error').show(); isValid = false;
            }
            if (!$('#extraworkdateid').val()) {
                $('#extraworkdateid-error').show(); isValid = false;
            }
            if (!$('#extraworkhrid').val()) {
                $('#extraworkhrid-error').show(); isValid = false;
            }
            if (!$('#reasonid').val()) {
                $('#reasonid-error').show(); isValid = false;
            }

            if (!isValid) {
                $('html, body').animate({
                    scrollTop: $(".error-msg:visible:first").offset().top - 100
                }, 500);
                return;
            }

            const payload = {
                CreatedBy: Empid.toString(),
                Emp_Id: Empid,
                Cmp_Id: Compid,
                Extra_Work_Day: $('#extraworkdateid').val(),
                Extra_Work_Hours: $('#extraworkhrid').val(),
                Rep_Person_Id: parseInt($('#reportingManagerId').val()),
                ComoffReason: $('#reasonid').val()
            };

            $.ajax({
                url: apiBase + '/CompOffAPI/CompOffDetailsApplication',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (res) {
                    Swal.fire({
                        icon: 'success',
                        title: res.responseMessage || '✅ Application submitted successfully.',
                        confirmButtonText: 'OK',
                        timer: 2000
                    });
                    $('#compoffForm')[0].reset();
                    $('#employeeid').val(EmployeeName);
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: '❌ Error submitting application.',
                        confirmButtonText: 'OK'
                    });
                }
            });
        });

        $('#compoffForm input, #compoffForm textarea, #compoffForm select').on('input change', function () {
            $(this).siblings('.error-msg').hide();
        });
    });

    function loadReportingPerson() {
        debugger;
        $.ajax({
            url: `${apiBase}/LeaveApplication/GetReportingperson?Empid=${Empid}`,
            method: 'POST',
            dataType: 'json',
            success: function (response) {
                if (response.isSuccess && response.data) {
                    $('#repoid').val(response.data.fullName);
                    $('#reportingManagerId').val(response.data.id);
                }
            }
        });
    }
</script>

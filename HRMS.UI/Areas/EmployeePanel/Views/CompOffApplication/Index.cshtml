@{
    ViewData["Title"] = "Employee Panel";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrl = ViewBag.BaseUrl;
    string apiBase = ViewBag.BaseUrlAPI;
}
<link href="~/commoncss.css" rel="stylesheet" />
<title>Search Panel</title>

<!-- jQuery + Bootstrap + SweetAlert -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
    }

    .form-section {
        padding: 15px;
        border: 1px solid #ccc;
    }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        font-weight: 600;
        padding: 4px 12px;
        border: none;
        border-radius: 4px;
    }

        .btn-custom:hover {
            background-color: #2c3a57;
        }

    .search-panel-container {
        background-color: #3e4b6d;
        padding: 6px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .form-control-sm, .form-select-sm {
        height: calc(1.5em + .5rem + 2px);
        font-size: 0.875rem;
        padding: .25rem .5rem;
    }

    .text-center-cell {
        text-align: center !important;
    }

        .text-center-cell > div {
            text-align: center !important;
        }
</style>

<!-- Search Panel Header -->
<div class="search-panel-wrapper">
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Search Panel</div>
            <div class="col-auto">
                <a href="@Url.Action("AddCompOffApplication", "CompOffApplication", new { area = "EmployeePanel" })" class="btn btn-primary">Add</a>
            </div>
        </div>
    </div>
</div>

<!-- Filter Controls -->
<div class="form-section">
    <div class="row justify-content-center mb-3">
        <div class="col-md-4 d-flex align-items-center">
            <label for="searchtypeid" class="form-label mb-0 me-2">Search Type:</label>
            <select class="form-control form-control-sm" id="searchtypeid" disabled>
                <option value="Extra_Work_Day" selected>Extra Work Date</option>
            </select>
        </div>

        <div class="col-md-4 d-flex align-items-center">
            <div class="col-md-6 d-flex align-items-center">
                <label for="searchforid" class="form-label mb-0 me-2">Search For:</label>
                <input type="date" class="form-control form-control-sm" id="searchforid" />
            </div>
        </div>
    </div>

    <div class="row justify-content-center mb-3">
        <div class="col d-flex align-items-center justify-content-center flex-wrap gap-3">
            <button type="button" class="search-panel-container  search-heading btn-sm" id="gobutoonid">GO</button>
            <button type="button" class="search-panel-container  search-heading btn-sm" id="clearbuttonid">Clear</button>
        </div>
    </div>

    <!-- Sub Heading -->
    <div class="search-panel-wrapper">
        <div class="search-panel-container">
            <div class="search-panel-row">
                <div class="search-heading">Comp-Off Application</div>
            </div>
        </div>
    </div>
</div>

<!-- Grid Section -->
<div class="form-section">
    <div class="container mt-3">
        <div class="d-flex justify-content-end mb-2" id="actionButtons" style="display: none;">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="leaveStatus" id="pendingleaveid" value="Pending" checked>
                <label class="form-check-label" for="pendingleaveid">Pending</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="leaveStatus" id="Approveid" value="Approved">
                <label class="form-check-label" for="Approveid">Approved/Rejected</label>
            </div>
        </div>

        <div id="attendanceGrid">Loading...</div>
        <div id="recordSummary" class="text-center mt-2 text-muted"></div>
    </div>
</div>

<!-- Scripts -->
<script>
    const apiBase = '@apiBase';
    const Empid = parseInt(localStorage.getItem("EmployeeId"));
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany || '{}');
    const Compid = parseInt(companyDetails.CompanyId);

    $(document).ready(function () {
        loadAllApplications("", "Pending");

        $('#gobutoonid').on('click', function () {
            const selectedStatus = $('input[name="leaveStatus"]:checked').val();
            const selectedDate = $('#searchforid').val();
            loadAllApplications(selectedDate, selectedStatus);
        });

        $('#clearbuttonid').on('click', function () {
            $('#searchtypeid').val(),
            $('#searchforid').val("");
            $('input[name="leaveStatus"]').prop('checked', false);
            $('#pendingleaveid').prop('checked', true);
            loadAllApplications("", "Pending");
        });

        $('input[name="leaveStatus"]').on('change', function () {
            const selectedStatus = $(this).val();
            const selectedDate = $('#searchforid').val();
            loadAllApplications(selectedDate, selectedStatus);
        });
    });

    function loadAllApplications(date, status) {
        const payload = {
            SearchType: $('#searchtypeid').val(),
            SearchFor: date || "",
            Status: status,
            CompId: Compid,
            Emplooyeid: Empid
        };
        console.log("payload",payload);

        $.ajax({
            url: apiBase + '/CompOffAPI/GetCompOffApplications',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (data) {
                if (data.isSuccess && data.data && data.data.length > 0) {
                    renderTable(data.data);
                    $('#recordSummary').text(`${data.data.length} records found.`);
                } else {
                    $('#attendanceGrid').html('<div class="text-center text-muted">No records found.</div>');
                    $('#recordSummary').text('');
                }
            },
            error: function (xhr) {
                Swal.fire("❌ Server error", xhr.responseText, "error");
            }
        });
    }

    function renderTable(data) {
        $("#attendanceGrid").dxDataGrid({
            dataSource: data,
            keyExpr: "comp_Off_Detailsid",
            showBorders: true,
            columnAutoWidth: true,
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "always"
            },
            onSelectionChanged: function (e) {
                selectedKeys = e.selectedRowKeys;
                $("#actionButtons").toggle(selectedKeys.length > 0);
            },
            columns: [
                { dataField: "comp_Off_Detailsid", caption: "ComoffApplicationId", width: 80, cssClass: "text-center-cell" },
                { dataField: "emp_Code", caption: "Employee Code", cssClass: "text-center-cell" },
                { dataField: "fullName", caption: "Employee Name", cssClass: "text-center-cell" },
                { dataField: "branchName", caption: "Branch name", cssClass: "text-center-cell" },
                { dataField: "extra_Work_Day", caption: "Extra Work Day", dataType: "date", format: "dd/MM/yyyy", cssClass: "text-center-cell" },
                { dataField: "extra_Work_Hours", caption: "Extra Hour", dataType: "number", format: { type: "fixedPoint", precision: 2 }, cssClass: "text-center-cell" },
                { dataField: "comoffReason", caption: "Reason", cssClass: "text-center-cell" },
                { dataField: "application_Status", caption: "Application Status", cssClass: "text-center-cell" }
            ]
        });
    }
</script>

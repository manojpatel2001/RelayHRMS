@{
    ViewData["Title"] = "Employee Panel";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrl = ViewBag.BaseUrl;
    string apiBase = ViewBag.BaseUrlAPI;
}

<title>Search Panel</title>
<!-- jQuery + Bootstrap + SweetAlert -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>


<style>
    .fixed-label {
        min-width: 160px;
        white-space: nowrap;
        margin-bottom: 0;
        margin-right: 10px;
        text-align: right;
    }

    body {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
    }

    .form-section {
        padding: 15px;
        border: 1px solid #ccc;
    }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        font-weight: 600;
        padding: 4px 12px;
        border: none;
        border-radius: 4px;
    }

        .btn-custom:hover {
            background-color: #2c3a57;
        }

    .search-panel-container {
        background-color: #3e4b6d;
        padding: 6px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .form-control-sm, .form-select-sm {
        height: calc(1.5em + .5rem + 2px);
        font-size: 0.875rem;
        padding: .25rem .5rem;
    }

    .text-center-cell {
        text-align: center !important;
    }

        /* Also center any inner content */
        .text-center-cell > div {
            text-align: center !important;
        }

    #branchid, #departmentid {
        width: 100%;
    }

    .small-dropdown {
        width: 180px !important;
    }

    .card {
        border-radius: 12px;
        transition: transform 0.2s ease-in-out;
    }

        .card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

</style>


<div class="search-panel-wrapper">
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Search Panel</div>
            
        </div>
    </div>
</div>

<div class="form-section">
    <div class="row justify-content-center mb-3">

        

        <div class="col-md-4 d-flex align-items-center">
            <label for="branchid" class="fixed-label">Branch:</label>
            <div id="branchid"></div>
        </div>
      
        <div class="col-md-4 d-flex align-items-center">
            <label for="departmentid" class="fixed-label">Department:</label>
            
            <div id="departmentid"></div>
        </div>


    </div>
    <div class="row justify-content-center mb-3">
        
        
        <div class="col-md-4 d-flex align-items-center">
            <label for="designationid" class="fixed-label">Designation:</label>

            <div id="designationid"></div>
        </div>



        <div class="col-md-4 d-flex align-items-center">
            <label for="empid" class="fixed-label">Emp Code/Name:</label>
            <input type="text" class="form-control form-control-sm" id="empid" placeholder="Employee Code or Name" />
        </div>
    </div>
    <div class="row justify-content-center mb-3">

        
        <div class="col-md-4 d-flex align-items-center">
            <label for="employeeid" class="fixed-label">Employee Status:</label>
            <select class="form-control form-control-sm" id="employeeid">
                <option value="0">All Employee</option>
                <option value="1">Active Employee</option>
                <option value="2">Left Employee</option>
            </select>
        </div>


        <div class="col-md-4 d-flex align-items-center justify-content-center flex-wrap gap-3">
            <button type="button" class="search-panel-container  search-heading btn-sm" id="gobutoonid">GO</button>
            <button type="button" class="search-panel-container  search-heading btn-sm" id="clearbuttonid">Clear</button>
        </div>
    </div>

   

    <!-- Sub Heading -->
    <div class="search-panel-wrapper">
        <div class="search-panel-container">
            <div class="search-panel-row">
                <div class="search-heading">Employee Directory</div>
            </div>
        </div>
    </div>
</div>



<div class="form-section">
    <div class="container mt-3">
        <!-- Container for cards -->
        <div id="employeeCardContainer" class="row"></div>

        <!-- Record summary -->
        <div id="recordSummary" class="text-center mt-2 text-muted"></div>
    </div>
</div>



<script>

      const apiBase = '@apiBase';
      const Empid = parseInt(localStorage.getItem("EmployeeId"));
    const EmployeeName = localStorage.getItem("EmployeeName");
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany || '{}');
    const Compid = parseInt(companyDetails.CompanyId);
    const Token=localStorage.getItem("authToken");

    $(document).ready(function(){
        

        loadbrach();
        loaddepartment();
        loaddesignation();

          $('#gobutoonid').on('click', function () {

             loademployeedirecotry();
         });

    });



        function loadbrach() {
        $.ajax({
            url: `${apiBase}/BranchAPI/GetAllBranchesListByCompanyId/${Compid}`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (response) {
                if (response?.data?.length > 0) {
                    $("#branchid").dxTagBox({
                        items: response.data,
                        displayExpr: "branchName",
                        valueExpr: "branchId",
                        placeholder: "--Select Branch--",
                        showSelectionControls: true,
                        searchEnabled: true,
                        showClearButton: true,
                        maxDisplayedTags: 3,
                        applyValueMode: "instantly",
                        multiline: false,
                        minSearchLength: 0,
                        width: "100%",
                        onOpened: function () {
                           $(".dx-overlay-content").css({
                                "max-width": "150px"
                               
                            });
                           },
                        onValueChanged: function (e) {
                            let selectedBranchIds = e.value.length > 0 ? e.value : [0];
                            // BindEmployeeDropdownByBranch(selectedBranchIds);
                        }
                        
                    });
                }
            }
        });
    }


        function loaddepartment() {
        $.ajax({
            url: `${apiBase}/DepartmentAPI/GetAllDepartmentByCompanyId/${Compid}`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (response) {
                if (response?.data?.length > 0) {
                    $("#departmentid").dxTagBox({
                        items: response.data,
                        displayExpr: "departmentName",
                        valueExpr: "departmentId",
                        placeholder: "--Select Department--",
                        showSelectionControls: true,
                        searchEnabled: true,
                        showClearButton: true,
                        maxDisplayedTags: 3,
                        applyValueMode: "instantly",
                        multiline: false,
                        minSearchLength: 0,
                        width: "100%",
                        onOpened: function () {
                            $(".dx-overlay-content").css("max-width", "150px" );
                        },
                        onValueChanged: function (e) {
                            let selecteddepids = e.value.length > 0 ? e.value : [0];
                            // BindEmployeeDropdownByBranch(selectedBranchIds);
                        }
                    });
                }
            }
        });
    }


   function loaddesignation() {
        $.ajax({
            url: `${apiBase}/DesignationAPI/GetAllDesignationByCompanyId/${Compid}`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (response) {
                if (response?.data?.length > 0) {
                    $("#designationid").dxTagBox({
                        items: response.data,
                        displayExpr: "designationName",
                        valueExpr: "designationId",
                        placeholder: "--Select Designation--",
                        showSelectionControls: true,
                        searchEnabled: true,
                        showClearButton: true,
                        maxDisplayedTags: 3,
                        applyValueMode: "instantly",
                        multiline: false,
                        minSearchLength: 0,
                        width: "100%",
                        onOpened: function () {
                            $(".dx-overlay-content").css("max-width", "150px" );
                        },
                        onValueChanged: function (e) {
                            let selecteddepids = e.value.length > 0 ? e.value : [0];
                            // BindEmployeeDropdownByBranch(selectedBranchIds);
                        }
                    });
                }
            }
        });
   }



        function loademployeedirecotry() {
           
         const status = $('#employeeid').val();
         let isenable = null, isdeleted = null;

         if (status === "1") {
             isenable = 1; isdeleted = 0;
         } else if (status === "2") {
             isenable = 0; isdeleted = 1;
         }

         const payload = {
                 BranchId: $('#branchid').dxTagBox("instance").option("value").join(','),     
             DepartmentId: $('#departmentid').dxTagBox("instance").option("value").join(','), 
             DesignationId: $('#designationid').dxTagBox("instance").option("value").join(','),
                    EmpCodeName: $('#empid').val(),
             isenable: isenable,
             isdeleted: isdeleted
         };
           console.log("payload",payload);

         $.ajax({
               url: `${apiBase}/EmployeeDirecotryAPI/GetEmployeeDirectory`,
             method: 'POST',
             contentType: 'application/json',
             data: JSON.stringify(payload),
             success: function (response) {
                 if (response.isSuccess && response.data.length > 0) {
                     renderCards(response.data);
                     $('#recordSummary').text(`${response.data.length} Records Found.`);
                 } else {
                     $('#employeeCardContainer').html('<div class="text-center text-muted">No records found.</div>');
                     $('#recordSummary').text('');
                 }
             },
             error: function (xhr) {
                 Swal.fire("❌ Server error", xhr.responseText, "error");
             }
         });
     }

        function renderCards(data) {
        let html = '';

        data.forEach(emp => {
            const imageUrl = emp.employeeProfileUrl || '/images/default-user.png';
            html += `
                <div class="col-md-3 mb-4">
                    <div class="card p-3 h-100 shadow-sm">
                        <div class="d-flex align-items-center mb-3">
                            <img src="${imageUrl}" alt="Profile" class="rounded-circle me-3" style="width: 60px; height: 60px; object-fit: cover; border: 2px solid #ccc;" />
                            <div>
                                <h6 class="mb-1">${emp.employeeCode}</h6>
                                <strong>${emp.fullName}</strong>
                            </div>
                        </div>
                        <div><strong>Gender:</strong> ${emp.gender || '-'}</div>
                        <div><strong>Branch:</strong> ${emp.branchName || '-'}</div>
                        <div><strong>Department:</strong> ${emp.departmentName || '-'}</div>
                        <div><strong>Designation:</strong> ${emp.designationName || '-'}</div>
                        <div><strong>DOJ:</strong> ${emp.dateOfJoining ? new Date(emp.dateOfJoining).toLocaleDateString() : '-'}</div>
                    </div>
                </div>
            `;
        });

        $('#employeeCardContainer').html(html);
    }

</script>
@{
    ViewData["Title"] = "Employee Panel";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrl = ViewBag.BaseUrl;
    string apiBase = ViewBag.BaseUrlAPI;
}

<!-- Dependencies -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f9f9f9;
    }

    /* Top header panels */
    .search-panel-container {
        background-color: #3e4b6d;
        padding: 8px 20px;
        border-radius: 6px;
        margin-bottom: 15px;
        width: 100%;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }

    /* Center wrapper for form */
    .center-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: calc(100vh - 120px);
        padding: 30px 15px;
    }

    /* Form design */
    .form-section {
        background-color: #fff;
        padding: 25px 30px;
        border: 1px solid #ccc;
        border-radius: 8px;
        width: 100%;
        max-width: 1200px;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
    }

    .form-control-sm, .form-select-sm {
        font-size: 0.875rem;
        padding: .25rem .5rem;
        height: calc(1.5em + .5rem + 2px);
    }

    .error-msg {
        font-size: 12px;
        color: red;
        display: none;
    }
</style>

<!-- Full-width Top Header Section -->
<div class="top-header">
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Add Loan Application</div>
        </div>
    </div>
</div>

<!-- Centered Form Section -->
<div class="center-wrapper">
    <form id="loanForm" class="form-section">
        <!-- Row 1: Date and Email ID -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="row">
                    <label for="dateid" class="col-sm-4 col-form-label form-label">Date<span class="text-danger">*</span>:</label>
                    <div class="col-sm-8">
                        <input type="date" class="form-control form-control-sm" id="dateid" readonly>
                        <span class="error-msg" id="dateid-error">Date is required</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <label for="emailid" class="col-sm-4 col-form-label form-label">Email ID:</label>
                    <div class="col-sm-8">
                        <input type="email" class="form-control form-control-sm" id="emailid" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Employee and Contact No -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="row">
                    <label for="employeeid" class="col-sm-4 col-form-label form-label">Employee<span class="text-danger">*</span>:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control form-control-sm" id="employeeid" readonly>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <label for="contactid" class="col-sm-4 col-form-label form-label">Contact No:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control form-control-sm" id="contactid" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Loan Name and Loan Max Limit -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="row">
                    <label for="loannameid" class="col-sm-4 col-form-label form-label">Loan Name<span class="text-danger">*</span>:</label>
                    <div class="col-sm-8">
                        <select class="form-select form-select-sm" id="loannameid">
                            <option value="">--Select Loan--</option>
                        </select>
                        <span class="error-msg" id="loannameid-error">Please select a loan</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <label for="loanmaxlimitid" class="col-sm-4 col-form-label form-label">Loan Max Limit:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control form-control-sm" id="loanmaxlimitid" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 4: Loan Require Date and Amount -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="row">
                    <label for="loanrequiredateid" class="col-sm-4 col-form-label form-label">Loan Require Date<span class="text-danger">*</span>:</label>
                    <div class="col-sm-8">
                        <input type="date" class="form-control form-control-sm" id="loanrequiredateid">
                        <span class="error-msg" id="loanrequiredateid-error">Loan require date is required</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <label for="amountid" class="col-sm-4 col-form-label form-label">Amount<span class="text-danger">*</span>:</label>
                    <div class="col-sm-8">
                        <input type="number" class="form-control form-control-sm" id="amountid" step="0.01">
                        <span class="error-msg" id="amountid-error">Amount is required</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 5: Interest Type and Interest (%) (Yearly) -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="row">
                    <label for="interesttypeid" class="col-sm-4 col-form-label form-label">Interest Type:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control form-control-sm" id="interesttypeid" readonly>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <label for="interestid" class="col-sm-4 col-form-label form-label">Interest (%)(Yearly):</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control form-control-sm" id="interestid" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 6: Installment and Installment Amount -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="row">
                    <label for="installmentid" class="col-sm-4 col-form-label form-label">Installment<span class="text-danger">*</span>:</label>
                    <div class="col-sm-8">
                        <input type="number" class="form-control form-control-sm" id="installmentid">
                        <span class="error-msg" id="installmentid-error">Installment is required</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <label for="installmentamountid" class="col-sm-4 col-form-label form-label">Installment Amount<span class="text-danger">*</span>:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control form-control-sm" id="installmentamountid" readonly>
                        <span class="error-msg" id="installmentamountid-error">Installment amount is required</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 7: Installment Start Date and Remark -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="row">
                    <label for="installmentstartdateid" class="col-sm-4 col-form-label form-label">Installment Start Date<span class="text-danger">*</span>:</label>
                    <div class="col-sm-8">
                        <input type="date" class="form-control form-control-sm" id="installmentstartdateid">
                        <span class="error-msg" id="installmentstartdateid-error">Installment start date is required</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <label for="remarkid" class="col-sm-4 col-form-label form-label">Remark:</label>
                    <div class="col-sm-8">
                        <textarea class="form-control form-control-sm" id="remarkid" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit, Clear and Back Buttons -->
        <div class="row mb-3">
            <div class="col-12 d-flex justify-content-end gap-2">
                <button type="submit" id="submitid" class="search-panel-container search-heading btn-sm">Submit</button>
                <button type="reset" id="resetid" class="search-panel-container search-heading btn-sm">Clear</button>
                <a href='@Url.Action("Index", "LoanApplication", new { area = "EmployeePanel" })' class="search-panel-container search-heading btn-sm text-decoration-none">Back</a>
            </div>
        </div>
    </form>
</div>

<!-- JavaScript Logic -->
<script>
    const apiBase = '@apiBase';
    const baseUrl = '@baseUrl';
    const Token = localStorage.getItem('token');
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany);
    const Compid = parseInt(companyDetails.CompanyId);
    const Empid = parseInt(localStorage.getItem("EmployeeId"));
    const EmployeeName = localStorage.getItem("EmployeeName");
    const EmployeeEmail = localStorage.getItem("EmployeeEmail");
    const EmployeeContact = localStorage.getItem("EmployeeContact");
    let loanMasterData = [];

    $(document).ready(function () {
        // Initialize form fields
        const today = new Date().toISOString().split('T')[0];
        $('#dateid').val(today);
        $('#employeeid').val(EmployeeName);
        $('#emailid').val(EmployeeEmail);
        $('#contactid').val(EmployeeContact);

        // Load loan types
        BindLoanMasterDropdown();

        // Handle loan selection change
        $('#loannameid').on('change', function() {
            const selectedLoanId = parseInt($(this).val());
            if (selectedLoanId) {
                const selectedLoan = loanMasterData.find(loan => loan.loanid === selectedLoanId);
                if (selectedLoan) {
                    $('#loanmaxlimitid').val(selectedLoan.maxLimit || '');
                    $('#interesttypeid').val(selectedLoan.interestType || '');
                    $('#interestid').val(selectedLoan.interestRate || '');
                    calculateInstallmentAmount();
                }
            } else {
                $('#loanmaxlimitid').val('');
                $('#interesttypeid').val('');
                $('#interestid').val('');
                $('#installmentamountid').val('');
            }
        });

        // Calculate installment amount when amount or installment changes
        $('#amountid, #installmentid').on('input', function() {
            calculateInstallmentAmount();
        });

        // Handle form submission
        $('#loanForm').on('submit', function (e) {
            e.preventDefault();

            // Validate form fields
            let isValid = true;
            $('.error-msg').hide();

            if (!$('#loannameid').val()) {
                $('#loannameid-error').show();
                isValid = false;
            }
            if (!$('#loanrequiredateid').val()) {
                $('#loanrequiredateid-error').show();
                isValid = false;
            }
            if (!$('#amountid').val()) {
                $('#amountid-error').show();
                isValid = false;
            }
            if (!$('#installmentid').val()) {
                $('#installmentid-error').show();
                isValid = false;
            }
            if (!$('#installmentstartdateid').val()) {
                $('#installmentstartdateid-error').show();
                isValid = false;
            }

            // If validation fails, scroll to the first error and return
            if (!isValid) {
                $('html, body').animate({
                    scrollTop: $(".error-msg:visible:first").offset().top - 100
                }, 500);
                return;
            }


            const payload = {
                ApplicationDate: $('#dateid').val(),
                EmployeeId: Empid,
                ContactNo: $('#contactid').val(),
                EmailId: $('#emailid').val(),
                LoanId: parseInt($('#loannameid').val()),
                LoanRequireDate: $('#loanrequiredateid').val(),
                LoanMaxLimit: parseFloat($('#loanmaxlimitid').val()) || 0,
                LoanAmount: parseFloat($('#amountid').val()),
                InterestType: $('#interesttypeid').val(),
                InterestPercentage: parseFloat($('#interestid').val()) || 0,
                NoOfInstallment: parseInt($('#installmentid').val()),
                InstallmentAmount: parseFloat($('#installmentamountid').val()),
                InstallmentStartDate: $('#installmentstartdateid').val(),
                Remark: $('#remarkid').val() || '',
                IsEnabled: true,
                IsDeleted: false,
                CreatedBy: Empid
            };

 
            $.ajax({
                url: apiBase + '/LoanApplicationAPI/CreateLoanApplication',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (res) {
                    if (res.isSuccess === true) {
                        Swal.fire({
                            icon: 'success',
                            title: res.responseMessage || '✅ Loan application submitted successfully.',
                            confirmButtonText: 'OK',
                            timer: 2000
                        });
                        $('#loanForm')[0].reset();
                        $('#dateid').val(today);
                        $('#employeeid').val(EmployeeName);
                        $('#emailid').val(EmployeeEmail);
                        $('#contactid').val(EmployeeContact);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: res.responseMessage || '❌ Application failed. Please try again.',
                            confirmButtonText: 'OK'
                        });
                    }
                },
                error: function (xhr, status, error) {
                    let errorMessage = '❌ Error submitting application.';
                    if (xhr.responseJSON && xhr.responseJSON.responseMessage) {
                        errorMessage = xhr.responseJSON.responseMessage;
                    } else if (error) {
                        errorMessage = error;
                    }
                    Swal.fire({
                        icon: 'error',
                        title: errorMessage,
                        confirmButtonText: 'OK'
                    });
                }
            });
        });

        // Clear error messages when the user types
        $('#loanForm input, #loanForm textarea, #loanForm select').on('input change', function () {
            $(this).siblings('.error-msg').hide();
        });
    });

    $('#resetid').on('click', function (e) {
        e.preventDefault();
        $('#loanForm')[0].reset();
        const today = new Date().toISOString().split('T')[0];
        $('#dateid').val(today);
        $('#employeeid').val(EmployeeName);
        $('#emailid').val(EmployeeEmail);
        $('#contactid').val(EmployeeContact);
    });

    function loadLoanTypes() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: apiBase + '/LoanApplicationAPI/GetLoanNamesForDropdown',
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (data) {
                    console.log('Loan API Response:', data);
                    if (data.isSuccess) {
                        loanMasterData = (data.data || []).map(loan => ({
                            loanid: loan.loanid || loan.Loanid || loan.LoanId,
                            loanName: loan.loanName || loan.LoanName,
                            maxLimit: loan.maxLimit || loan.MaxLimit || 0,
                            interestType: loan.interestType || loan.InterestType || '',
                            interestRate: loan.interestRate || loan.InterestRate || 0
                        }));
                        console.log('Loaded loan master data:', loanMasterData);

                        // Populate dropdown
                        const $select = $('#loannameid');
                        $select.empty().append('<option value="">--Select Loan--</option>');

                        loanMasterData.forEach(function(loan) {
                            $select.append(
                                $('<option></option>')
                                    .val(loan.loanid)
                                    .text(loan.loanName)
                            );
                        });

                        resolve(loanMasterData);
                    } else {
                        reject('Failed to fetch loans');
                    }
                },
                error: function (error) {
                    console.error('Error loading loans:', error);
                    reject(error);
                }
            });
        });
    }

    async function BindLoanMasterDropdown() {
        try {
            await loadLoanTypes();
        } catch (error) {
            console.error('Error binding loan dropdown:', error);
            Swal.fire({
                icon: 'error',
                title: 'Failed to load loan types',
                confirmButtonText: 'OK'
            });
        }
    }

    function calculateInstallmentAmount() {
        const amount = parseFloat($('#amountid').val()) || 0;
        const installments = parseInt($('#installmentid').val()) || 0;
        const interest = parseFloat($('#interestid').val()) || 0;

        if (amount > 0 && installments > 0) {
            // Simple calculation: (Amount + Interest Amount) / Installments
            const totalInterest = (amount * interest) / 100;
            const totalAmount = amount + totalInterest;
            const installmentAmount = totalAmount / installments;
            $('#installmentamountid').val(installmentAmount.toFixed(2));
        } else {
            $('#installmentamountid').val('');
        }
    }
</script>
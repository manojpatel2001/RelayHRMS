@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Employee Loan Application";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseAPIDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}
<title>Loan Search Panel</title>
<!-- jQuery + Bootstrap + SweetAlert -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
    }

    .form-section {
        padding: 15px;
        border: 1px solid #ccc;
    }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        font-weight: 600;
        padding: 4px 12px;
        border: none;
        border-radius: 4px;
    }

        .btn-custom:hover {
            background-color: #2c3a57;
        }

    .search-panel-container {
        background-color: #3e4b6d;
        padding: 6px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .form-control-sm, .form-select-sm {
        height: calc(1.5em + .5rem + 2px);
        font-size: 0.875rem;
        padding: .25rem .5rem;
    }

    .text-center-cell {
        text-align: center !important;
    }

        .text-center-cell > div {
            text-align: center !important;
        }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        border: none;
        padding: 4px 12px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 4px;
        transition: none;
        box-shadow: none;
    }

        .btn-custom:hover,
        .btn-custom:focus,
        .btn-custom:active {
            background-color: #3e4b6d;
            color: white;
            outline: none;
            box-shadow: none;
        }

    #loanGrid {
        width: 100% !important;
        max-width: 100%;
    }

    .form-section {
        padding: 15px;
        border: 1px solid #ccc;
        overflow-x: hidden;
    }

    .container {
        max-width: 100% !important;
        padding: 0 15px;
    }

    .dx-datagrid {
        width: 100% !important;
    }

    /* Loading spinner */
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3e4b6d;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
    }

    @@keyframes spin {
        0%

    {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }

    }
</style>

<div class="search-panel-wrapper">
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Loan Status Search Panel</div>
            <div class="ms-auto">
                <a href="@Url.Action("EmpLoanApplication", "SalaryDetail", new { area = "EmployeePanel" })" class="btn btn-primary btn-sm">Add</a>
            </div>
        </div>
    </div>
</div>

<div class="form-section">
    <div class="row justify-content-center mb-3">
        <div class="col-md-4 d-flex align-items-center">
            <label for="Loantypeid" class="form-label mb-0 me-2" style="width: 120px;">Loan Type:</label>
            <select class="form-control form-control-sm" id="Loantypeid">
                <option value="0">-- Select --</option>
            </select>
        </div>
        <div class="col-md-4 d-flex align-items-center">
            <label for="input1" class="form-label mb-0 me-2" style="width: 120px;">Search For:</label>
            <input type="text" class="form-control form-control-sm" id="input1" placeholder="Search Employee Code or Name">
        </div>
    </div>

    <div class="row justify-content-center mb-3">
        <div class="col d-flex align-items-center justify-content-center flex-wrap gap-3">
            <button type="button" class="search-panel-container search-heading btn-sm" id="gobutoonid">GO</button>
            <button type="button" class="search-panel-container search-heading btn-sm" id="clearbuttonid">Clear</button>
        </div>
    </div>

    <div class="search-panel-wrapper">
        <div class="search-panel-container">
            <div class="search-panel-row">
                <div class="search-heading">Loan Application</div>
            </div>
        </div>
    </div>
</div>

<div class="form-section">
    <div class="container mt-3">
        <div class="d-flex justify-content-end mb-2 align-items-center gap-3" id="actionButtons" style="display: none;">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="loanStatus" id="pendingloanid" value="Pending" checked>
                <label class="form-check-label" for="pendingloanid">Pending</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="loanStatus" id="Approveid" value="ApprovedRejected">
                <label class="form-check-label" for="Approveid">Approved/Rejected</label>
            </div>
            <button id="btnDelete" class="btn btn-custom">Delete</button>
        </div>
        <div id="loanGrid">Loading...</div>
        <div id="recordSummary" class="text-center mt-2 text-muted"></div>
    </div>
</div>

<script>
    const Empid = parseInt(localStorage.getItem("EmployeeId"));
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany || '{}');
    const Compid = parseInt(companyDetails.CompanyId);
    let selectedKeys = [];
    var baseUrl = '@baseUrl';

    // Debug: Check if values are loaded correctly
    console.log("Initialized - Empid:", Empid, "Compid:", Compid, "baseUrl:", baseUrl);

    $(document).ready(function () {
        loadLoanTypeOptions();
        fetchLoanData();

        $('#gobutoonid').on('click', function () {
            if (!$(this).prop('disabled')) {
                console.log("GO button clicked");
                fetchLoanData();
            }
        });

        $('#pendingloanid').on('click', function () {
            fetchLoanData();
        });

        $('#Approveid').on('click', function () {
            fetchLoanData();
        });

        $('input[name="loanStatus"]').on('change', function () {
            fetchLoanData();
        });

        $('#Loantypeid').change(function () {
            // No auto-fill needed, SearchFor is independent
        });

        $('#clearbuttonid').on('click', function () {
            $('#Loantypeid').val('0');
            $('#input1').val('');
            $('#pendingloanid').prop('checked', true);
            selectedKeys = [];
            $('#actionButtons').hide();
            fetchLoanData();
        });
    });

    function loadLoanTypeOptions() {
        $.ajax({
            url: baseUrl + '/LoanApplicationAPI/GetLoanNamesForDropdown',
            type: "GET",
            headers: {
                'Content-Type': 'application/json'
            },
            success: function (res) {
                const dropdown = $('#Loantypeid');
                dropdown.empty().append(`<option value="0">-- Select --</option>`);

                if (res.isSuccess && res.data && res.data.length > 0) {
                    $.each(res.data, function (i, item) {
                        const loanTypeId = item.loantypeid || item.loanTypeId || item.LoanTypeId || item.loanid || item.Loanid || item.LoanId;
                        const loanName = item.loanName || item.LoanName;
                        dropdown.append(`<option value="${loanTypeId}">${loanName}</option>`);
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error("Error loading loan types:", xhr, status, error);
                Swal.fire({
                    title: "Error",
                    text: "Failed to load loan types. Please refresh the page.",
                    icon: "error"
                });
            }
        });
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
    }

    $('#btnDelete').on('click', function () {
        var grid = $("#loanGrid").dxDataGrid("instance");
        var selectedRows = grid.getSelectedRowsData();

        if (selectedRows.length === 0) {
            Swal.fire("Warning", "Please select at least one record to delete.", "warning");
            return;
        }

        const nonPendingRecords = selectedRows.filter(row => row.loanStatus !== "Pending");

        if (nonPendingRecords.length > 0) {
            Swal.fire({
                title: "Cannot Delete",
                text: "Only pending loan applications can be deleted. Please remove approved/rejected records from selection.",
                icon: "error"
            });
            return;
        }

        const selectedIds = selectedRows.map(row => row.loanApplicationId);
        const deletePayload = {
            Id: selectedIds,
            DeletedBy: Empid.toString()
        };

        $.ajax({
            url: baseUrl + "/LoanApplicationAPI/Delete",
            type: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify(deletePayload),
            success: function (res) {
                if (res.isSuccess) {
                    Swal.fire({
                        title: "Success",
                        text: res.responseMessage || "Records deleted successfully.",
                        icon: "success",
                        timer: 2000
                    }).then(() => {
                        grid.clearSelection();
                        selectedKeys = [];
                        fetchLoanData();
                    });
                } else {
                    Swal.fire("Error", res.responseMessage || "Deletion failed.", "error");
                }
            },
            error: function (xhr) {
                console.error("Delete error:", xhr);
                Swal.fire("Error", "Something went wrong during deletion.", "error");
            }
        });
    });

    function fetchLoanData() {
        console.log("fetchLoanData called");

        // Show loading indicator
        $('#loanGrid').html('<div class="text-center p-3"><div class="spinner"></div>Loading data...</div>');
        $('#recordSummary').text('');
        $('#actionButtons').hide();

        const searchFor = $('#input1').val().trim();
        const selectedLoanType = $('#Loantypeid option:selected').text();
        const loanTypeValue = $('#Loantypeid').val();
        const selectedStatus = $('input[name="loanStatus"]:checked').val();

        let loanType = null;
        if (loanTypeValue && loanTypeValue !== "0") {
            loanType = selectedLoanType;
        }

        let status = null;
        if (selectedStatus === "Pending") {
            status = "isPending";
        } else if (selectedStatus === "ApprovedRejected") {
            status = "isApprovedReject";
        }

        let filter = {
            LoanType: loanType,
            Status: status,
            SearchFor: searchFor || null,
            Emplooyeid: Empid,
            CompId: Compid
        };

        console.log("Sending filter:", filter);
        console.log("API URL:", baseUrl + '/LoanApplicationAPI/GetLoanApprovalEss');

        $.ajax({
            url: baseUrl + '/LoanApplicationAPI/GetLoanApprovalEss',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(filter),
            beforeSend: function() {
                // Disable GO button during request
                $('#gobutoonid').prop('disabled', true).html('<div class="spinner" style="width: 15px; height: 15px; border-width: 2px; margin-right: 5px;"></div>Loading...');
            },
            success: function (response) {
                console.log("API Response:", response);

                if (response.isSuccess && response.data && response.data.length > 0) {
                    let filteredData = response.data;

                    if (selectedStatus === "Pending") {
                        filteredData = response.data.filter(item =>
                            item.loanStatus === "Pending" || item.isPending === true
                        );
                    } else if (selectedStatus === "ApprovedRejected") {
                        filteredData = response.data.filter(item =>
                            item.loanStatus === "Approved" ||
                            item.loanStatus === "Rejected" ||
                            item.isApproved === true ||
                            item.isRejected === true
                        );
                    }

                    console.log("Filtered data count:", filteredData.length);

                    if (filteredData.length > 0) {
                        if ($("#loanGrid").data("dxDataGrid")) {
                            $("#loanGrid").dxDataGrid("dispose");
                            $("#loanGrid").empty();
                        }

                        renderTable(filteredData);
                        $('#actionButtons').show();
                        $('#recordSummary').text(`Total Records: ${filteredData.length}`);
                    } else {
                        if ($("#loanGrid").data("dxDataGrid")) {
                            $("#loanGrid").dxDataGrid("dispose");
                        }

                        $('#loanGrid').html('<div class="text-center text-muted p-3">No records found for selected status.</div>');
                        $('#recordSummary').text('');
                        $('#actionButtons').hide();
                    }
                } else {
                    console.log("No data or unsuccessful response");

                    if ($("#loanGrid").data("dxDataGrid")) {
                        $("#loanGrid").dxDataGrid("dispose");
                    }

                    $('#loanGrid').html('<div class="text-center text-muted p-3">No records found.</div>');
                    $('#recordSummary').text('');
                    $('#actionButtons').hide();
                }
            },
            error: function (xhr, status, error) {
                console.error("AJAX Error:", {
                    xhr: xhr,
                    status: status,
                    error: error,
                    responseText: xhr.responseText
                });

                $('#loanGrid').html('<div class="text-center text-danger p-3">Error loading data. Please try again.</div>');

                Swal.fire({
                    title: "❌ Server Error",
                    text: xhr.responseText || "Something went wrong while fetching data",
                    icon: "error"
                });
            },
            complete: function() {
                // Re-enable GO button
                $('#gobutoonid').prop('disabled', false).text('GO');
                console.log("AJAX request completed");
            }
        });
    }

    function renderTable(data) {
        console.log("Rendering table with data:", data);

        $("#loanGrid").dxDataGrid({
            dataSource: data,
            keyExpr: "loanApplicationId",
            showBorders: true,
            columnAutoWidth: false,
            wordWrapEnabled: true,
            showColumnLines: true,
            showRowLines: true,
            rowAlternationEnabled: true,
            hoverStateEnabled: true,
            width: '100%',
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "always"
            },
            paging: {
                enabled: true,
                pageSize: 10
            },
            pager: {
                visible: true,
                showPageSizeSelector: true,
                allowedPageSizes: [10, 20, 50],
                showInfo: true
            },
            scrolling: {
                mode: "standard",
                useNative: false,
                showScrollbar: "onHover",
                columnRenderingMode: "standard"
            },
            onSelectionChanged: function (e) {
                selectedKeys = e.selectedRowKeys;
                console.log("Selected keys:", selectedKeys);
            },
            columns: [
                {
                    dataField: "loanApplicationId",
                    caption: "Application Id",
                    width: 100,
                    alignment: "center",
                    visible: false
                },
                {
                    dataField: "employeeName",
                    caption: "Employee Name",
                    alignment: "left",
                    width: 180
                },
                {
                    dataField: "loanTypeName",
                    caption: "Loan Type",
                    alignment: "left",
                    width: 150
                },
                {
                    dataField: "loanAmount",
                    caption: "Loan Amount",
                    alignment: "right",
                    dataType: "number",
                    format: { type: "fixedPoint", precision: 2 },
                    width: 130
                },
                {
                    dataField: "installmentAmount",
                    caption: "Installment Amount",
                    alignment: "right",
                    dataType: "number",
                    format: { type: "fixedPoint", precision: 2 },
                    width: 160
                },
                {
                    dataField: "numberOfInstallments",
                    caption: "Installments",
                    alignment: "center",
                    width: 120
                },
                {
                    dataField: "applicationDate",
                    caption: "Application Date",
                    dataType: "date",
                    format: "dd/MM/yyyy",
                    alignment: "center",
                    width: 150
                },
                {
                    dataField: "loanRequireDate",
                    caption: "Loan Require Date",
                    dataType: "date",
                    format: "dd/MM/yyyy",
                    alignment: "center",
                    width: 150
                },
                {
                    dataField: "reason",
                    caption: "Reason",
                    alignment: "left",
                    width: 200
                },
                {
                    dataField: "loanStatus",
                    caption: "Status",
                    alignment: "center",
                    width: 120
                },
                {
                    dataField: "UpdatedBy",
                    caption: "Approved By",
                    width: 150,
                    alignment: "center",
                    calculateCellValue: function (rowData) {
                        return rowData.approvedBy || "-";
                    }
                },
                {
                    dataField: "UpdatedDate",
                    caption: "Approved Date",
                    width: 150,
                    alignment: "center",
                    calculateCellValue: function (rowData) {
                        if (!rowData.approvedDate) return "-";
                        const date = new Date(rowData.approvedDate);
                        const day = String(date.getDate()).padStart(2, '0');
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const year = date.getFullYear();
                        return `${day}/${month}/${year}`;
                    }
                }
            ]
        });

        console.log("Table rendered successfully");
    }
</script>
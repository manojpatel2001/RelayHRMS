@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Loan Management";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    string UIBaseUrlLayout = Configuration["UIBaseUrlSettings:baseUrl"];
    var uriAPI = new Uri(baseUrl);
    string baseAPIDomainUrl = $"{uriAPI.Scheme}://{uriAPI.Host}:{uriAPI.Port}";
}

<div class="no-print-content">
    <div class="card">
        <div class="card-header bg-transparent ml-0 py-0">
            <div class="row">
                <div class="col-6">
                    <h6 class="p-2 mb-0">
                        Manage Loan Applications
                    </h6>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-12">
                    <div class="grid-wrapper" style="position: relative;">
                        <div id="grid-loader" class="grid-loader justify-content-center align-items-center flex-column"
                             style="display: none; position: absolute; inset: 0; background: rgba(255,255,255,0.6); z-index: 10;">
                            <img src="@baseAPIDomainUrl/loders/loder.png" class="grid-logo-spinner" style="width: 30px; height: 30px; animation: spin 1s linear infinite;" />
                            <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>
                        </div>
                        <div class="rowCount" id="rowCount2"></div>
                        <div id="GridContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    const EmployeeId = localStorage.getItem("EmployeeId");
    var Token = localStorage.getItem("authToken");
    var gridInstance;

    $(() => {
        PendingLoanApplicationsDataTable();
    });

    function PendingLoanApplicationsDataTable() {
        try {
            $('#grid-loader').addClass('d-flex').show();

            const approverEmployeeId = EmployeeId;
            const status = "Pending";
            const approvalMasterId = 4;

            $.ajax({
                type: "POST",
                url: '@baseUrl/ProbationPerformanceAPI/GetPendingApprovalRequestsWithHistory1',
                headers: {
                    'Authorization': 'Bearer ' + Token,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    approverEmployeeId: approverEmployeeId,
                    status: status,
                    ApprovalMasterId: approvalMasterId
                }),
                success: function (data) {
                    console.log("Pending loan applications:", data);

                    gridInstance = $("#GridContainer").dxDataGrid({
                        dataSource: data.data || [],
                        columns: [
                            {
                                dataField: "requesterName",
                                caption: "Applicant",
                                minWidth: 250
                            },
                            {
                                dataField: "loanName",
                                caption: "Loan Type",
                                minWidth: 150
                            },
                            {
                                dataField: "loanAmount",
                                caption: "Amount",
                                dataType: "number",
                                format: "currency",
                                minWidth: 120
                            },
                            {
                                dataField: "currentLevelStatus",
                                caption: "Status",
                                minWidth: 120
                            },
                            {
                                dataField: "currentLevelNo",
                                caption: "Level",
                                width: 80
                            },
                            {
                                dataField: "loanApplicationID",
                                caption: "loanApplicationID",
								visible: false
                            },
                            {
                                dataField: "assignedOn",
                                caption: "Assigned On",
                                dataType: "date",
                                format: "dd-MM-yyyy HH:mm",
                                minWidth: 160
                            },
                            {
                                dataField: "escalationDueOn",
                                caption: "Due On",
                                dataType: "date",
                                format: "dd-MM-yyyy HH:mm",
                                minWidth: 160
                            },
                            {
                                dataField: '',
                                caption: 'Action',
                                alignment: 'center',
                                dataType: 'string',
                                type: 'buttons',
                                width: '200px',
                                cellTemplate: function (container, options) {
                                    var actionContainer = $('<div/>').addClass('d-flex gap-2 justify-content-center').appendTo(container);

                                    // Approve Button
                                    $('<button/>')
                                        .addClass('btn btn-success btn-sm')
                                        .html('<i class="bi bi-check-circle"></i> Approve')
                                        .on('click', function () {
                                            updateLoanApplication(options.data, 'Approved');
                                        })
                                        .appendTo(actionContainer);

                                    // Reject Button
                                    $('<button/>')
                                        .addClass('btn btn-danger btn-sm')
                                        .html('<i class="bi bi-x-circle"></i> Reject')
                                        .on('click', function () {
                                            updateLoanApplication(options.data, 'Rejected');
                                        })
                                        .appendTo(actionContainer);
                                }
                            }
                        ],
                        masterDetail: {
                            enabled: true,
                            template: function(container, options) {
                                const data = options.data;
                                const loadingIndicator = $("<div>")
                                    .addClass("dx-loadindicator")
                                    .text("Loading...")
                                    .appendTo(container);

                                const tabPanel = $("<div>").addClass("master-detail-tabs").appendTo(container);
                                const tabContent = $("<div>").addClass("tab-content").appendTo(tabPanel);

                                // Approval History Tab
                                const historyTab = $("<div>").addClass("tab-pane fade show active").attr("id", "history").appendTo(tabContent);

                                if (data.previousApprovalLevelsJson) {
                                    try {
                                        const historyData = JSON.parse(data.previousApprovalLevelsJson);

                                        $("<h6>Approval History</h6>").appendTo(historyTab);

                                        const historyGrid = $("<div>").dxDataGrid({
                                            dataSource: historyData,
                                            columns: [
                                                { dataField: "HistoryLevelNo", caption: "Level", alignment: 'left', Width: 80 },
                                                { dataField: "HistoryStatus", caption: "Status", alignment: 'left', minWidth: 120 },
                                                { dataField: "HistoryApproverName", caption: "Approver", alignment: 'left', minWidth: 300 },
                                                {
                                                    dataField: "HistoryAssignedOn",
                                                    caption: "Assigned On",
                                                    dataType: "date",
                                                    format: "dd-MM-yyyy HH:mm",
                                                    alignment: 'left',
                                                    minWidth: 180
                                                },
                                                {
                                                    dataField: "HistoryEscalationDueOn",
                                                    caption: "Due On",
                                                    dataType: "date",
                                                    format: "dd-MM-yyyy HH:mm",
                                                    alignment: 'left',
                                                    minWidth: 180
                                                }
                                            ],
                                            showBorders: true,
                                            paging: { enabled: false },
                                            scrolling: { mode: "standard" }
                                        }).appendTo(historyTab);
                                    } catch (e) {
                                        $("<p>Error loading approval history</p>").appendTo(historyTab);
                                        console.error("Error parsing history JSON:", e);
                                    }
                                } else {
                                    $("<p>No approval history available</p>").appendTo(historyTab);
                                }

                                // Loan Details Tab
                                const loanTab = $("<div>").addClass("tab-pane fade").attr("id", "loan").appendTo(tabContent);

                                $("<h6>Loan Application Details</h6>").appendTo(loanTab);

                                const detailsTable = $("<table>").addClass("table table-bordered").appendTo(loanTab);
                                const tbody = $("<tbody>").appendTo(detailsTable);

                                $("<tr>")
                                    .append($("<th>").text("Applicant Name"))
                                    .append($("<td>").text(data.applicantName || "N/A"))
                                    .appendTo(tbody);

                                $("<tr>")
                                    .append($("<th>").text("Loan Type"))
                                    .append($("<td>").text(data.loanType || "N/A"))
                                    .appendTo(tbody);

                                $("<tr>")
                                    .append($("<th>").text("Loan Amount"))
                                    .append($("<td>").text(data.loanAmount ? '₹' + data.loanAmount.toLocaleString() : "N/A"))
                                    .appendTo(tbody);

                                $("<tr>")
                                    .append($("<th>").text("Application Date"))
                                    .append($("<td>").text(data.applicationDate ?
                                        new Date(data.applicationDate).toLocaleDateString('en-GB') : "N/A"))
                                    .appendTo(tbody);

                                $("<tr>")
                                    .append($("<th>").text("Tenure (Months)"))
                                    .append($("<td>").text(data.tenureMonths || "N/A"))
                                    .appendTo(tbody);

                                $("<tr>")
                                    .append($("<th>").text("Purpose"))
                                    .append($("<td>").text(data.purpose || "N/A"))
                                    .appendTo(tbody);

                                $("<tr>")
                                    .append($("<th>").text("Branch"))
                                    .append($("<td>").text(data.branchName || "N/A"))
                                    .appendTo(tbody);

                                loadingIndicator.remove();
                            }
                        },
                        export: {
                            enabled: false
                        },
                        columnsAutoWidth: true,
                        wordWrapEnabled: true,
                        rowAlternationEnabled: true,
                        showBorders: true,
                        grouping: { autoExpandAll: false },
                        paging: { pageSize: 10 },
                        pager: {
                            showPageSizeSelector: true,
                            allowedPageSizes: [10, 25, 50, 100],
                            showInfo: true
                        },
                        headerFilter: { visible: false },
                        filterRow: { visible: false },
                        allowColumnResizing: true,
                        allowColumnReordering: true,
                        columnFixing: { enabled: false },
                        searchPanel: {
                            visible: true,
                            width: 240,
                            placeholder: "Search..."
                        },
                        scrolling: {
                            mode: "standard",
                            useNative: false,
                            scrollByContent: true,
                            scrollByThumb: true,
                        },
                        onContentReady: function(e) {
                            $("#rowCount2").html("Total Records: " + e.component.totalCount());
                        }
                    }).dxDataGrid('instance');

                    $('#grid-loader').removeClass('d-flex').hide();
                },
                error: function (xhr, status, error) {
                    $('#grid-loader').removeClass('d-flex').hide();
                    console.error("Error loading loan applications:", error);
                    alert("Error loading loan applications. Please try again.");
                }
            });
        } catch (e) {
            console.error("Error in PendingLoanApplicationsDataTable:", e);
            $('#grid-loader').removeClass('d-flex').hide();
        }
    }

    function updateLoanApplication(data, action) {
        // Confirm action
        const confirmMessage = action === 'Approved'
            ? 'Are you sure you want to approve this loan application?'
            : 'Are you sure you want to reject this loan application?';

        if (!confirm(confirmMessage)) {
            return;
        }

        // Show loader
        $('#grid-loader').addClass('d-flex').show();

        // Prepare update data
        const updateData = {
            LoanApplicationId: data.loanApplicationID,
            ApprovalRequestLevelId: data.currentApprovalRequestLevelId,
            ApprovalRequestId: data.approvalRequestId,
            ApproverEmployeeId: EmployeeId,
            Status: action,
            LevelNo: data.currentLevelNo,
            UpdatedBy:EmployeeId
        };

        $.ajax({
            type: "POST",
            url: '@baseUrl/LoanApplicationAPI/LoanApproval',
            headers: {
                'Authorization': 'Bearer ' + Token,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(updateData),
            success: function (response) {
                $('#grid-loader').removeClass('d-flex').hide();

                if (response.success) {
                    alert(`Loan application ${action.toLowerCase()} successfully!`);
                    // Refresh the grid
                    PendingLoanApplicationsDataTable();
                } else {
                    alert('Error: ' + (response.message || 'Failed to update loan application'));
                }
            },
            error: function (xhr, status, error) {
                $('#grid-loader').removeClass('d-flex').hide();
                console.error("Error updating loan application:", error);
                alert("Error updating loan application. Please try again.");
            }
        });
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
    }
</script>

<style>
    @@keyframes spin {
        0%

    {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }

    }

    .gap-2 {
        gap: 0.5rem;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
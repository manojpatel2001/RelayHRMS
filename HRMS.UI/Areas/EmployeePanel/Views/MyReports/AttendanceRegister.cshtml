@{
    ViewData["Title"] = "Attendance Register";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string apiBase = ViewBag.BaseUrlAPI;
}
<link href="~/commoncss.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .fixed-label {
        min-width: 100px;
        white-space: nowrap;
        margin-bottom: 0;
        text-align: right;
    }
</style>

<div class="card">
    <div class="card-header bg-transparent py-2 text-center">
        <h6 class="mb-0">ATTENDANCE REGISTER</h6>
    </div>

    <div class="card-body">
        <form>
            <div class="col-md-8 mx-auto">
                <!-- Month / Year / Branch -->
                <div class="row mb-2">
                    <div class="col-md-4 d-flex align-items-center">
                        <label for="month" class="fixed-label">Month<span class="text-danger">*</span>:</label>
                        <select class="form-select form-select-sm" id="month">
                            <option value="">--Select--</option>
                            @for (int i = 1; i <= 12; i++)
                            {
                                <option value="@i">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(i)</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-4 d-flex align-items-center">
                        <label for="year" class="fixed-label">Year<span class="text-danger">*</span>:</label>
                        <input type="number" class="form-control form-control-sm" id="year" min="2000" max="2100" value="@DateTime.Now.Year" />
                    </div>

                    <div class="col-md-4 d-flex align-items-center">
                        <label for="branchid" class="fixed-label">Branch:</label>
                        <select class="form-select form-select-sm" id="branchid">
                            <option value="0">-- Select --</option>
                        </select>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="row justify-content-center mt-3">
                    <div class="col-md-6 d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-primary btn-sm" id="btnView">View</button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="window.location.href='@Url.Action("Index", "MyReports")'">Back</button>
                    </div>
                </div>
            </div>
        </form>

        <!-- Data Grid Container -->
        <div id="attendanceTableContainer" class="table-responsive mt-4"></div>
    </div>
</div>

<script>
    const apiBase = '@apiBase';

         const Empid = parseInt(localStorage.getItem("EmployeeId"));


    $(document).ready(function () {
        GetBranch();

        $('#btnView').on('click', function () {
            debugger;
            const month = $('#month').val();
            const year = $('#year').val();
            const branchId = $('#branchid').val();

            if (!month || !year) {
                Swal.fire('Required', 'Please select month and year.', 'warning');
                return;
            }

            const startDate = `${year}-${month.padStart(2, '0')}-01`;
            const lastDay = new Date(year, month, 0).getDate();
            const endDate = `${year}-${month.padStart(2, '0')}-${lastDay}`;

            const request = {
                startDate: startDate,
                endDate: endDate,
                userId: Empid,
                branchId: branchId == "0" ? null : parseInt(branchId)
            };

            console.log(request,"request");

            $.ajax({
                url: apiBase + '/EmployeeReportAPI/Attendencereport', 
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(request),
                success: function (res) {
                    console.log(res,"res");
                    if (res && res.length > 0) {
                        renderAttendanceTable(res);
                    } else {
                        $('#attendanceTableContainer').html('<p class="text-danger">No attendance records found for selected filters.</p>');
                    }
                },
                error: function () {
                    Swal.fire('Error', 'Something went wrong while fetching data.', 'error');
                }
            });
        });
    });

    function GetBranch() {
        $.ajax({
            url: apiBase + '/BranchAPI/GetAllBranch',
            type: 'GET',
            contentType: 'application/json',
            success: function (data) {
                if (data.isSuccess && data.data) {
                    const $branchDropdown = $('#branchid');
                    $branchDropdown.empty().append('<option value="0">-- Select --</option>');
                    data.data.forEach(branch => {
                        $branchDropdown.append(
                            `<option value="${branch.branchId}">${branch.branchName}</option>`
                        );
                    });
                }
            },
            error: function () {
                console.error("Error fetching branches.");
            }
        });
    }

    function renderAttendanceTable(data) {
        let columns = Object.keys(data[0].days); // dynamic D01, D02...
        let html = `<table class="table table-bordered table-striped table-sm">
            <thead class="table-light">
                <tr>
                    <th>Branch</th>
                    <th>Emp Code</th>
                    <th>Employee</th>`;

        columns.forEach(col => {
            html += `<th>${col}</th>`;
        });

        html += `<th>Total P</th><th>Total A</th><th>Total W</th><th>Total HF</th></tr></thead><tbody>`;

        data.forEach(emp => {
            html += `<tr>
                <td>${emp.branchName ?? ''}</td>
                <td>${emp.employeeCode ?? ''}</td>
                <td>${emp.fullName ?? ''}</td>`;
            columns.forEach(day => {
                html += `<td>${emp.days[day] ?? ''}</td>`;
            });
            html += `<td>${emp.total_P ?? 0}</td>
                     <td>${emp.total_A ?? 0}</td>
                     <td>${emp.total_W ?? 0}</td>
                     <td>${emp.total_HF ?? 0}</td>
            </tr>`;
        });

        html += `</tbody></table>`;
        $('#attendanceTableContainer').html(html);
    }
</script>

@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Attendance Register";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string apiBase = ViewBag.BaseUrlAPI;
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];
}

<!-- CSS -->
<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>


<style>
    .fixed-label {
        min-width: 100px;
        white-space: nowrap;
        margin-bottom: 0;
        text-align: right;
    }

    #attendanceModalBody table th,
    #attendanceModalBody table td {
        font-weight: normal;
        font-size: 13px;
    }

    #attendanceModalBody table thead th {
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f8f9fa !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .custom-modal-width {
        max-width: 98% !important;
    }

    .attendance-table-container {
        max-height: 60vh;
        overflow: auto;
        position: relative;
    }

        /* Ensure sticky header works properly */
        .attendance-table-container table {
            position: relative;
        }

        /* Fix for scrollbar appearing under header */
        .attendance-table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .attendance-table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .attendance-table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

            .attendance-table-container::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
</style>

<!-- Modal -->
<div class="modal fade" id="attendanceModal" tabindex="-1" aria-labelledby="attendanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl custom-modal-width">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Attendance Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="attendanceModalBody">
                <!-- Report info and export button will be injected here -->
            </div>
        </div>
    </div>
</div>

<!-- Main Card -->
<div class="card">
    <div class="card-header bg-transparent py-2 text-center">
        <h6 class="mb-0">ATTENDANCE REGISTER</h6>
    </div>

    <div class="card-body">
        <form>
            <div class="col-md-8 mx-auto">
                <div class="row mb-2">
                    <div class="col-md-4 d-flex align-items-center">
                        <label for="month" class="fixed-label">Month<span class="text-danger">*</span>:</label>
                        <select class="form-select form-select-sm" id="month">
                            <option value="">--Select--</option>
                            @for (int i = 1; i <= 12; i++)
                            {
                                <option value="@i">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(i)</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-center">
                        <label for="year" class="fixed-label">Year<span class="text-danger">*</span>:</label>
                        <input type="number" class="form-control form-control-sm" id="year" min="2000" max="2100" value="@DateTime.Now.Year" />
                    </div>
                    @*       <div class="col-md-4 d-flex align-items-center">
                        <label for="branchid" class="fixed-label">Branch:</label>
                        <select class="form-select form-select-sm" id="branchid">
                            <option value="0">-- Select --</option>
                        </select>
                    </div> *@
                </div>



                <div class="row justify-content-center mt-3">
                    <div class="col-md-6 d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-primary btn-sm" id="btnView">View</button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="window.location.href='@Url.Action("index", "Home")'">Back</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>


<div id="grid-loader"
     class="grid-loader justify-content-center align-items-center flex-column"
     style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(3px); z-index: 9999;">
    <img src="@baseDomainUrl/loders/loder.png"
         class="grid-logo-spinner"
         style="width: 40px; height: 40px; animation: spin 1s linear infinite;" />
    <div class="grid-loading-text text-dark " style="font-size: 16px;">Loading...</div>
</div>


<script>
    const apiBase = '@apiBase';
    const Role = localStorage.getItem("RoleSlug");
    const savedCompany = localStorage.getItem('selectedCompany');
    var companyDetails = JSON.parse(savedCompany);
    const CompanyId=companyDetails.CompanyId;
    const Compname = companyDetails.CompanyName;
    const Token=localStorage.getItem("authToken");
        const EmployeeId = localStorage.getItem('EmployeeId');
    $(document).ready(function () {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth() + 1; // 1-12
        const currentYear = currentDate.getFullYear();

        $('#month').val(currentMonth);
        $('#year').val(currentYear);

        GetBranch();
        loadEmployeeGridAsync();
    });


    function loadEmployeeGridAsync() {
        const selectedMonth = $('#month').val();
        const selectedYear = $('#year').val();

        return new Promise((resolve, reject) => {
            $.ajax({
                type: "GET",
                url: apiBase + '/EmployeeDashBoardAPI/GetEmployeesforAttendanceRegister',
                data: {
                    Compid: CompanyId,
                    EmployeeId: EmployeeId,
                    Month: selectedMonth,
                    Year: selectedYear
                },
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (response) {
                    // Extract employee IDs from response
                    if (response && response.data && response.data.length > 0) {
                        const ids = response.data.map(employee => employee.id);
                        resolve(ids); // Return the IDs
                    } else {
                        console.log('No employees found in response');
                        resolve([]); // Return empty array if no data
                    }
                },
                error: function (xhr) {
                    console.error("Async AJAX Error:", xhr);
                    reject(xhr); // Reject promise on error
                }
            });
        });
    }

    $('#btnView').on('click', async function () {
        var selectedYear = $('#year').val();
        var selectedMonth = $('#month').val();
        const month = parseInt(selectedMonth);
        const year = parseInt(selectedYear);

        if (!month || !year) {
            Swal.fire('Required', 'Please select month and year.', 'warning');
            return;
        }

        const paddedMonth = String(month).padStart(2, '0');
        const startDate = `${year}-${paddedMonth}-01`;
        const lastDay = new Date(year, month, 0).getDate();
        const endDate = `${year}-${paddedMonth}-${lastDay}`;

        try {
            // Get fresh employee IDs
            const freshEmployeeIds = await loadEmployeeGridAsync();

            let EmployeeIds = [];
            if (freshEmployeeIds.length > 0) {
                EmployeeIds = freshEmployeeIds;
            } else {
                const Empid = parseInt(localStorage.getItem("EmployeeId"));
                EmployeeIds = Empid ? [Empid] : [];
            }

          

            const request = {
                startDate: startDate,
                endDate: endDate,
                EmployeeIds: EmployeeIds
            };
            showLoder();
            $.ajax({
                url: apiBase + '/EmployeeReportAPI/Attendencereport',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(request),
                success: function (res) {
                    hideLoder();
                    if (!res || !res.data || res.data.length === 0) {
                        $('#attendanceModalBody').html('<p class="text-danger">No attendance records found.</p>');
                        const modal = new bootstrap.Modal(document.getElementById('attendanceModal'));
                        modal.show();
                        return;
                    }
                    renderAttendanceTable(res.data, startDate, endDate);
                },
                error: function () {
                    hideLoder();
                    Swal.fire('Error', 'Something went wrong while fetching data.', 'error');
                }
            });

        } catch (error) {
            hideLoder();
            console.error('Error loading employee IDs:', error);
            Swal.fire('Error', 'Failed to load employee data.', 'error');
        }
    });



         async function showLoder() {
              $('#grid-loader').addClass('d-flex').show();
          }

          async function hideLoder() {
              $('#grid-loader').removeClass('d-flex').hide();
          }

     function GetBranch(){

       $.ajax({
            url: apiBase+'/BranchAPI/GetAllBranchesListByCompanyId/'+CompanyId,
            method: 'GET',
                headers: {
                        'Authorization': 'Bearer ' + Token
                    },
            success: function(data) {
                if(data.isSuccess){
                    var dropdown = $('#branchid');
                    dropdown.empty();
                    dropdown.append('<option disabled selected value="">Select</option>');
                    $.each(data.data, function(index, company) {
                        dropdown.append($('<option>', {
                            value: company.branchId,
                            text: company.branchName
                        }));
                    });


                }
            },
            error: function(error) {
                console.error('Error fetching branch data:', error);
            }
        });

    }
    function renderAttendanceTable(data, startDate, endDate) {
        debugger;
        // First row contains day names - extract it separately
        const dayRow = data[0];
        const dayKeys = Object.keys(dayRow.days).sort((a, b) => parseInt(a) - parseInt(b));

        const formatDate = (dateStr) => {
            const [yyyy, mm, dd] = dateStr.split("-");
            return `${dd}-${mm}-${yyyy}`;
        };
        const today = formatDate(new Date().toISOString().split('T')[0]);

        // Get selected branch names for report header
        const branchTagBox = $("#branchDropdown").dxTagBox("instance");
        const selectedBranchIds = branchTagBox ? branchTagBox.option("value") : [];
        const allBranches = branchTagBox ? branchTagBox.option("items") : [];
        const selectedBranchNames = allBranches
            .filter(branch => selectedBranchIds.includes(branch.branchId))
            .map(branch => branch.branchName)
            .join(', ');

        let header = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div id="reportInfo">
                    <strong>Company:</strong> ${Compname} &nbsp;&nbsp;
                    <strong>From:</strong> ${formatDate(startDate)} &nbsp;&nbsp;
                    <strong>To:</strong> ${formatDate(endDate)} &nbsp;&nbsp;
                    <strong>Print Date:</strong> ${today}
                </div>
                <button class="btn btn-success btn-sm" id="btnExportExcel">Export to Excel</button>
            </div>`;

        let html = `<div class="attendance-table-container">
            <table class="table table-bordered table-sm align-middle">
                <thead class="table-light text-center">
                    <tr>
                        <th class="text-nowrap">Branch</th>
                        <th class="text-nowrap">Emp Code</th>
                        <th class="text-nowrap" style="min-width: 180px;">Employee</th>`;

        // Build day headers with day names
        dayKeys.forEach(day => {
            const dayLabel = `${day} (${dayRow.days[day]})`;
            html += `<th class="text-center" style="min-width: 45px;">${dayLabel}</th>`;
        });

        html += `
            <th class="text-nowrap">Total P</th>
            <th class="text-nowrap">Total A</th>
            <th class="text-nowrap">Total W</th>
            <th class="text-nowrap">Total L</th>
            <th class="text-nowrap">Total H</th>
            <th class="text-nowrap">Total HF Leave</th>
            <th class="text-nowrap">Total CO</th>
            <th class="text-nowrap">Total LWP</th>
            <th class="text-nowrap">Total Payable Days</th>
            <th class="text-nowrap">Total Unpaid Days</th>
            <th class="text-nowrap">Total Month Days</th>
        </tr>
        </thead>
        <tbody>`;

        // Skip first row (index 0) as it contains only day names, start from index 1
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            html += `<tr>
                <td>${row.branchName ?? ''}</td>
                <td>${row.employeeCode ?? ''}</td>
                <td>${row.fullName ?? ''}</td>`;

            // Day-wise attendance columns - mark 'A' as red
            dayKeys.forEach(day => {
                const value = row.days?.[day] ?? '';
                const trimmedValue = value.toString().trim().toUpperCase();
                const redClass = trimmedValue === 'A' ? 'text-danger fw-bold' : '';
                html += `<td class="text-center ${redClass}">${value}</td>`;
            });

            // Totals - Match exact order with headers
            html += `
                <td class="text-center">${row.totalP ?? 0}</td>
                <td class="text-center text-danger fw-bold">${row.totalA ?? 0}</td>
                <td class="text-center">${row.totalW ?? 0}</td>
                <td class="text-center">${row.totalL ?? 0}</td>
                <td class="text-center">${row.totalH ?? 0}</td>
                <td class="text-center">${row.totalHFLeave ?? 0}</td>
                <td class="text-center">${row.totalCO ?? 0}</td>
                <td class="text-center">${row.totalLWP ?? 0}</td>
                <td class="text-center">${row.totalPayableDays ?? 0}</td>
                <td class="text-center">${row.totalUnpaidDays ?? 0}</td>
                <td class="text-center">${row.totalMonthDays ?? 0}</td>
            </tr>`;
        }

        html += `</tbody></table></div>`;

        // Add Legend/Reference Table in 3 Columns
        const legend = `
            <div class="mt-4">
                <h6 class="fw-bold mb-3">Attendance Code Reference:</h6>
                <div class="row">
                    <!-- Column 1 -->
                    <div class="col-md-4">
                        <table class="table table-bordered table-sm">
                            <tbody style="font-size: 12px;">
                                <tr><td class="fw-bold" style="width: 60px;">P</td><td>Present</td></tr>
                                <tr><td class="fw-bold">HF</td><td>Half Day Present</td></tr>
                                <tr><td class="fw-bold text-danger">A</td><td>Absent</td></tr>
                                <tr><td class="fw-bold">LWP</td><td>Leave Without Pay</td></tr>
                                <tr><td class="fw-bold">W</td><td>Week Off</td></tr>
                                <tr><td class="fw-bold">H</td><td>Holiday</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Column 2 -->
                    <div class="col-md-4">
                        <table class="table table-bordered table-sm">
                            <tbody style="font-size: 12px;">
                                <tr><td class="fw-bold" style="width: 60px;">PL</td><td>Full Day PL Leave</td></tr>
                                <tr><td class="fw-bold">CO</td><td>Comp Off Leave</td></tr>
                                <tr><td class="fw-bold">P*</td><td>Present + PL (Half Day)</td></tr>
                                <tr><td class="fw-bold">P^</td><td>Present + HD (Half Day)</td></tr>
                                <tr><td class="fw-bold">HPL</td><td>Absent + PL (Half Day)</td></tr>
                                <tr><td class="fw-bold">HDL</td><td>Absent + HD (Half Day)</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Column 3 -->
                    <div class="col-md-4">
                        <table class="table table-bordered table-sm">
                            <tbody style="font-size: 12px;">
                                <tr><td class="fw-bold" style="width: 60px;">COP</td><td>HF + Comp Off (Half Day)</td></tr>
                                <tr><td class="fw-bold">HCO</td><td>Absent + Comp Off (Half Day)</td></tr>
                                <tr><td class="fw-bold">CO*</td><td>PL + Comp Off (Half Day)</td></tr>
                                <tr><td class="fw-bold">CO^</td><td>HD + Comp Off (Half Day)</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;

        $('#attendanceModalBody').html(header + html + legend);
        const modal = new bootstrap.Modal(document.getElementById('attendanceModal'));
        modal.show();
    }



     $(document).on('click', '#btnExportExcel', function () {
        const table = document.querySelector("#attendanceModalBody table");
        if (!table) {
            Swal.fire('Error', 'No table found to export.', 'error');
            return;
        }

        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet("Attendance");

        // Create table header row with styling
        const headerRow = [];
        table.querySelectorAll("thead tr th").forEach(th => {
            headerRow.push(th.innerText.trim());
        });
        worksheet.addRow(headerRow);

        // Apply style to header
        worksheet.getRow(1).eachCell(cell => {
            cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF343A40' } // Bootstrap dark
            };
            cell.alignment = { vertical: 'middle', horizontal: 'center' };
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });

        // Add table rows
        table.querySelectorAll("tbody tr").forEach(tr => {
            const row = [];
            tr.querySelectorAll("td").forEach(td => {
                row.push(td.innerText.trim());
            });
            worksheet.addRow(row);
        });

        // Apply border to all data cells
        worksheet.eachRow((row, rowNumber) => {
            row.eachCell(cell => {
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
            });
        });

        // Auto width for columns
        worksheet.columns.forEach(column => {
            let maxLength = 10;
            column.eachCell({ includeEmpty: true }, cell => {
                const length = cell.value ? cell.value.toString().length : 10;
                if (length > maxLength) {
                    maxLength = length;
                }
            });
            column.width = maxLength + 2;
        });

        // Save file
        workbook.xlsx.writeBuffer().then(buffer => {
            const now = new Date();
            const fileName = `Attendance_Report_${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}.xlsx`;
            const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            saveAs(blob, fileName);
        });
    });

     function clearForm() {
        const currentDate = new Date();
        $('#month').val(currentDate.getMonth() + 1);
        $('#year').val(currentDate.getFullYear());
    }
    // Add these event handlers for modal close
    $(document).on('click', '#attendanceModal .btn-close', function () {
        clearForm();
    });

    $('#attendanceModal').on('hidden.bs.modal', function () {
        clearForm();
    });

</script>
@{
    ViewData["Title"] = "Employee Panel";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string apiBase = ViewBag.BaseUrlAPI;
}

<!-- ✅ CSS -->
<link href="~/commoncss.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

<style>
    .fixed-label {
        min-width: 220px;
        white-space: nowrap;
        margin-bottom: 0;
        text-align: right;
        padding-right: 25px;
    }
</style>

<div class="card">
    <div class="card-header bg-transparent ml-0 py-0">
        <div class="row">
            <div class="col-6">
                <h4 class="pt-2 mb-0">Leave Approval</h4>
            </div>
        </div>

        <!-- 🔍 Search Panel -->
        <div class="card mt-2">
            <div class="card-header bg-transparent">
                <h6 class="mb-0">Search Panel</h6>
            </div>
            <div class="card-body">
                <form>
                    <div class="row justify-content-center">
                        <div class="col-md-10">
                            <div class="row mb-3">
                                <div class="col-md-6 d-flex align-items-center">
                                    <label for="Leavetypeid" class="fixed-label">Search By:</label>
                                    <select class="form-control form-control-sm" id="Leavetypeid">
                                        <option value="0">-- Select --</option>
                                        <option value="1">Employee Name</option>
                                        <option value="2">Employee Code</option>
                                        <option value="3">Leave Name</option>
                                    </select>
                                </div>
                                <div class="col-md-6 d-flex align-items-center">
                                    <label for="input1" class="fixed-label">Search For:</label>
                                    <input type="text" class="form-control form-control-sm" id="input1" placeholder="Enter value (optional)">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col d-flex justify-content-center gap-3">
                                    <button type="button" class="btn btn-primary btn-sm" id="gobutoonid">Go</button>
                                    <button type="button" class="btn btn-secondary btn-sm" id="clearbuttonid">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- 📊 Table -->
                <div class="table-responsive px-3 pb-3">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Leave Application ID</th>
                                <th>Leave Type</th>
                                <th>Employee Name</th>
                                <th>Employee Code</th>
                                <th>From Date</th>
                                <th>To Date</th>
                                <th>No. of Days</th>
                                <th>Reason</th>
                                <th>Application Type</th>
                                <th>Reporting Person</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody">
                            <tr><td colspan="8">No records found.</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="col d-flex justify-content-center gap-3">
                    <button type="button" class="btn btn-primary btn-sm" id="Approveid" value="Approve">Approve</button>
                    <button type="button" class="btn btn-primary btn-sm" id="rejectedid" value="Rejected">Rejected</button>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- ✅ Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const apiBase = '@apiBase';
    const Empid = parseInt(localStorage.getItem("EmployeeId"));

    $(document).ready(function () {
        loadLeaveApplications(); // On page load

        $('#Approveid, #rejectedid').click(function () {
        const status = $(this).val(); // 'Approve' or 'Rejected'
        updateLeaveStatus(status);
       });
    });

    $('#gobutoonid').click(function () {
        loadLeaveApplications();
    });

    $('#clearbuttonid').click(function () {
        $('#Leavetypeid').val('0');
        $('#input1').val('');
        loadLeaveApplications();
    });

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
    }

    function loadLeaveApplications() {
        const searchTypeValue = $('#Leavetypeid').val();
        const searchFor = $('#input1').val().trim();
        let searchTypeText = '';

        if (searchTypeValue == '1') searchTypeText = 'Employee Name';
        else if (searchTypeValue == '2') searchTypeText = 'Employee Code';
        else if (searchTypeValue == '3') searchTypeText = 'Leave Name';

        const payload = {
            SearchType: searchTypeText,
            SearchFor: searchFor,
            Emplooyeid: Empid
        };

        const $tbody = $('#resultBody');
        $tbody.empty(); // Clear previous rows

        $.ajax({
            url: apiBase + '/LeaveApplication/GetLeaveApplicationsforApprove',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (data) {
                if (data.isSuccess && data.data && data.data.length > 0) {
                    data.data.forEach((item) => {
                        const row = `
                            <tr>
                              <td><input type="checkbox" class="row-checkbox" value="${item.leaveApplicationId}" /></td>
                                <td>${item.leaveApplicationId}</td>
                                <td>${item.leaveTypeName}</td>
                                <td>${item.employeeName}</td>
                                <td>${item.employeeCode}</td>
                                <td>${formatDate(item.fromDate)}</td>
                                <td>${formatDate(item.todate)}</td>
                                <td>${item.no_Of_Date}</td>
                                <td>${item.reason}</td>
                                <td>${item.applicationType}</td>
                                <td>${item.reportingPersonName}</td>
                                <td>${item.leaveStatus}</td>
                            </tr>`;
                        $tbody.append(row);
                    });
                } else {
                    $tbody.append('<tr><td colspan="11" class="text-center text-muted">No records found.</td></tr>');
                }
            },
            error: function () {
                $tbody.html(`
                    <tr>
                        <td colspan="11" class="text-danger text-center">Error fetching data.</td>
                    </tr>
                `);
            }
        });
    }


     function updateLeaveStatus(status) {
        const selectedIds = [];
        $('.row-checkbox:checked').each(function () {
            selectedIds.push(parseInt($(this).val()));
        });

        if (selectedIds.length === 0) {
            Swal.fire('Warning', 'Please select at least one application.', 'warning');
            return;
        }

        const payload = {
            Ids: selectedIds,
            Status: status
        };

        $.ajax({
            url: apiBase + '/LeaveApplication/LeaveapplicationApproveorReject',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (res) {
                if (res.isSuccess) {
                    Swal.fire('Success', res.message, 'success');
                    loadLeaveApplications(); // Reload
                } else {
                    Swal.fire('Error', res.message || 'Something went wrong.', 'error');
                }
            },
            error: function () {
                Swal.fire('Error', 'Failed to update status.', 'error');
            }
        });
    }

</script>

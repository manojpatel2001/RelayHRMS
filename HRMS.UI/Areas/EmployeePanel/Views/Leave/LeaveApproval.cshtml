@{
    ViewData["Title"] = "Employee Panel";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string apiBase = ViewBag.BaseUrlAPI;
}

<title>Search Panel</title>

<!-- jQuery + Bootstrap + SweetAlert -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
    }

    .form-section {
        padding: 15px;
        border: 1px solid #ccc;
    }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        font-weight: 600;
        padding: 4px 12px;
        border: none;
        border-radius: 4px;
    }

        .btn-custom:hover {
            background-color: #2c3a57;
        }

    .search-panel-container {
        background-color: #3e4b6d;
        padding: 6px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .form-control-sm, .form-select-sm {
        height: calc(1.5em + .5rem + 2px);
        font-size: 0.875rem;
        padding: .25rem .5rem;
    }

    .text-center-cell {
        text-align: center !important;
    }

        /* Also center any inner content */
        .text-center-cell > div {
            text-align: center !important;
        }
</style>

<div class="search-panel-wrapper">
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Search Panel</div>
        </div>
    </div>
</div>

<div class="form-section">
    <div class="row justify-content-center mb-3">
        <div class="col-md-4 d-flex align-items-center">
            <label for="Leavetypeid" class="form-label me-2">Search By:</label>
            <select class="form-control form-control-sm" id="Leavetypeid">
                <option value="0">-- Select --</option>
                <option value="1">Employee Code</option>
                <option value="2">Employee Name</option>
                <option value="3">Leave Name</option>
            </select>
        </div>
        <div class="col-md-4 d-flex align-items-center">
            <label for="input1" class="form-label me-2">Search For:</label>
            <input type="text" class="form-control form-control-sm" id="input1" disabled />
        </div>
    </div>

    <div class="row justify-content-center mb-3">
        <div class="col-md-4 d-flex align-items-center gap-2">
            <button type="button" class="search-panel-container  search-heading btn-sm form-label me-2" id="goButtonId">GO</button>
            <button type="button" class="search-panel-container  search-heading btn-sm form-label me-2" id="clearButtonId">Clear</button>
        </div>
    </div>

    <div class="search-panel-wrapper">
        <div class="search-panel-container">
            <div class="search-panel-row">
                <div class="search-heading">Leave Approval</div>
            </div>
        </div>
    </div>

    <div class="container mt-3">
        <div class="d-flex justify-content-end mb-2 gap-2" id="actionButtons" style="display: none;">
         
                
                    <button type="button" id="Approveid" class="search-panel-container  search-heading btn-sm form-label me-2" value="Approved">
                        <i class="fas fa-sign-in-alt me-2"></i>Approved
                    </button>
                    <button type="button" class="btn-punching search-panel-container  search-heading btn-sm form-label me-2" disabled id="btnAproving" style="display:none;">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        Approving...
                    </button>
                <button type="button" id="rejectedid" class="search-panel-container  search-heading btn-sm form-label me-2" value="Rejected">
                  <i class="fas fa-sign-in-alt me-2"></i>Rejected
                </button>
                <button type="button" class="btn-punching search-panel-container  search-heading btn-sm form-label me-2" disabled id="btnRejecting" style="display:none;">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Rejecting...
                </button>
@*             <button type="button" class="search-panel-container  search-heading btn-sm form-label me-2" id="Approveid" value="Approved">Approved</button>
           <button type="button" class="search-panel-container  search-heading btn-sm form-label me-2" id="rejectedid" value="Rejected">Rejected</button> *@ 
        </div>

        <div id="attendanceGrid">Loading...</div>
        <div id="recordSummary" class="text-center mt-2 text-muted"></div>
    </div>
</div>

<script>
    const apiBase = '@apiBase';
    const Empid = parseInt(localStorage.getItem("EmployeeId"));
    var token=localStorage.getItem("authToken");
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany || '{}');
    const Compid = parseInt(companyDetails.CompanyId);
    let selectedKeys = [];
    let gridInstance; // Store grid instance

    $(document).ready(function () {
        loadLeaveApplications(); // On page load

        $('#Approveid, #rejectedid').click(function () {
            const status = $(this).val(); // 'Approve' or 'Rejected'
            updateLeaveStatus(status);
        });

        $('#goButtonId').click(function () {
            loadLeaveApplications();
        });

        $('#clearButtonId').click(function () {
            $('#Leavetypeid').val('0');
            $('#input1').val('');
            $('#input1').prop('disabled', true);
            loadLeaveApplications();
        });

        $('#Leavetypeid').change(function () {
            const val = $(this).val();
            $('#input1').prop('disabled', val === '0');
        });
    });

    function loadLeaveApplications() {
        if ($("#attendanceGrid").data("dxDataGrid")) {
            $("#attendanceGrid").dxDataGrid("dispose");
            $("#attendanceGrid").empty();
        }

        const searchTypeValue = $('#Leavetypeid').val();
        const searchFor = $('#input1').val().trim();
        let searchTypeText = '';

        if (searchTypeValue == '1') searchTypeText = 'Employee Code';
        else if (searchTypeValue == '2') searchTypeText = 'Employee Name';
        else if (searchTypeValue == '3') searchTypeText = 'Leave Name';

        const payload = {
            SearchType: searchTypeText,
            SearchFor: searchFor,
            Emplooyeid: Empid,
            CompId: Compid
        };

        $.ajax({
            url: apiBase + '/LeaveApplication/GetLeaveApplicationsforApprove',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (data) {
                if (data.isSuccess && data.data && data.data.length > 0) {
                    renderTable(data.data);
                    $('#actionButtons').hide();
                } else {
                    $('#attendanceGrid').html('<div class="text-center text-muted">No records found.</div>');
                    $('#recordSummary').text('');
                    $('#actionButtons').hide();
                }
            },
            error: function () {
                $('#attendanceGrid').html('<div class="text-center text-danger">Error fetching data.</div>');
                $('#recordSummary').text('');
                $('#actionButtons').hide();
            }
        });
    }

    function renderTable(data) {
        gridInstance = $("#attendanceGrid").dxDataGrid({
            dataSource: data,
            keyExpr: "leaveApplicationid",
            showBorders: true,
            columnAutoWidth: false,
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "always"
            },
            onSelectionChanged: function (e) {
                selectedKeys = e.selectedRowKeys;
                $("#actionButtons").toggle(selectedKeys.length > 0);
            },
            columns: [
                { dataField: "leaveApplicationid", caption: "ApplicationId", width: 80 ,visible:false},
                { dataField: "leaveTypeName", caption: "Leave Type", cssClass: "text-center-cell" },
                { dataField: "employeeName", caption: "Employee Name", cssClass: "text-center-cell" },
                { dataField: "employeeCode", caption: "Employee Code", cssClass: "text-center-cell" },
                { dataField: "fromDate", caption: "From Date", dataType: "date", format: "dd/MM/yyyy", cssClass: "text-center-cell" },
                { dataField: "todate", caption: "To Date", dataType: "date", format: "dd/MM/yyyy", cssClass: "text-center-cell" },
                { dataField: "no_Of_Date", caption: "Days", cssClass: "text-center-cell" },
                { dataField: "reason", caption: "Reason", cssClass: "text-center-cell" },
                { dataField: "applicationType", caption: "Application Type", cssClass: "text-center-cell" },
                { dataField: "reportingPersonName", caption: "Reporting Person", cssClass: "text-center-cell" },
                { dataField: "leaveStatus", caption: "Leave Status", cssClass: "text-center-cell" }
            ]
        }).dxDataGrid("instance");
    }

    function getSelectedRowData() {
        if (!gridInstance || !selectedKeys || selectedKeys.length === 0) {
            return [];
        }

        // Get selected row data using the grid instance
        const selectedRowsData = [];
        selectedKeys.forEach(key => {
            const rowData = gridInstance.getDataSource().items().find(item =>
                item.leaveApplicationId === key
            );
            if (rowData) {
                selectedRowsData.push(rowData);
            }
        });

        return selectedRowsData;
    }

    function checkSalaryProcessed(fromDate) {
        return new Promise((resolve, reject) => {
            const leaveDate = new Date(fromDate);
            const month = leaveDate.getMonth() + 1;
            const year = leaveDate.getFullYear();
            const empCode = "";
            const branch = "";

            const requestData = {
                Month: parseInt(month),
                Year: parseInt(year),
                EmployeeCodes: empCode || "",
                BranchId: branch === "" ? 0 : parseInt(branch)
            };

            $.ajax({
                url: `${apiBase}/MonthlySalaryDetailsAPI/GetAll`,
                type: "POST",
                data: JSON.stringify(requestData),
                contentType: "application/json",
                success: function (response) {
                    resolve({
                        isProcessed: response.isSuccess && response.data && response.data.length > 0,
                        month: month,
                        year: year
                    });
                },
                error: function (xhr, status, error) {
                    console.log("Error Status: ", status);
                    console.log("Error Message: ", error);
                    console.log("Response Text: ", xhr.responseText);
                    reject(error);
                }
            });
        });
    }

    function updateLeaveStatus(status) {
        if (!selectedKeys || selectedKeys.length === 0) {
            Swal.fire('Warning', 'Please select at least one application.', 'warning');
            return;
        }

        // Get selected rows data
        const selectedRowsData = getSelectedRowData();

        if (!selectedRowsData || selectedRowsData.length === 0) {
            Swal.fire('Error', 'Unable to retrieve selected row data.', 'error');
            return;
        }

        // Get the first selected row's details
        const firstSelectedRow = selectedRowsData[0];
        const fromDate = firstSelectedRow.fromDate;

        if (status === "Approved") {
            checkSalaryProcessed(fromDate).then(result => {
                if (result.isProcessed) {
                    Swal.fire('Warning', 'Leave applications not allowed for periods where the previous month’s salary has already been processed. Please contact HR for assistance if needed.', 'warning');
                    return;
                } else {
                    proceedWithStatusUpdate(status);
                }
            }).catch(error => {
                console.error("Error checking salary processed status: ", error);
                Swal.fire('Error', 'Failed to check salary status.', 'error');
            });
        } else {
            proceedWithStatusUpdate(status);
        }
    }

    function proceedWithStatusUpdate(status) {
        if (status === "Approved") {
            $('#Approveid').hide();
            $('#btnAproving').show();
        } else {
            $('#rejectedid').hide();
            $('#btnRejecting').show();
        }

        const payload = {
            Ids: selectedKeys,
            Status: status,
            EmployeeId: Empid
        };

        $.ajax({
            url: apiBase + '/LeaveApplication/LeaveapplicationApproveorReject',
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'Authorization': 'Bearer ' + token,
            },
            data: JSON.stringify(payload),
            success: function (res) {
                if (res.isSuccess) {
                    Swal.fire('Success', res.message, 'success');
                    loadLeaveApplications();
                } else {
                    Swal.fire('Error', res.message || 'Something went wrong.', 'error');
                }
                resetButtons(status);
            },
            error: function () {
                resetButtons(status);
                Swal.fire('Error', 'Failed to update status.', 'error');
            }
        });
    }

    function resetButtons(status) {
        if (status === "Approved") {
            $('#Approveid').show();
            $('#btnAproving').hide();
        } else {
            $('#rejectedid').show();
            $('#btnRejecting').hide();
        }
    }
</script>

@{
    ViewData["Title"] = "Employee Panel";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrl = ViewBag.BaseUrl;
    string apiBase = ViewBag.BaseUrlAPI;
}

<div class="card">
    <div class="card-header bg-transparent ml-0 py-0">
        <div class="row">
            <div class="col-6">
                <h4 class="pt-2 mb-0">Leave</h4>
            </div>
        </div>

        <div class="card mt-2">
            <div class="card-header bg-transparent">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="mb-0">Leave Application</h6>
                    </div>
                    <div class="col-auto">
                        <a href='@Url.Action("LeaveApplication", "Leave", new { area = "EmployeePanel" })' class="btn btn-primary">Back</a>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <div class="row">
                    <!-- Form -->
                    <div class="col-md-6">
                        <form id="leaveForm">
                            <div class="mb-3 row">
                                <label class="col-sm-5 col-form-label">Application Date:</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control" id="applicationDate" readonly>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label class="col-sm-5 col-form-label">Employee:</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control" id="employedid" readonly>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label class="col-sm-5 col-form-label">Reporting Person:</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control" id="repoid" readonly>
                                    <input type="hidden" id="reportingManagerId" />
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label class="col-sm-5 col-form-label">Leave:</label>
                                <div class="col-sm-7">
                                    <select class="form-control" id="Leavetypeid">
                                        <option value="0">-- Select Leave Type --</option>
                                        <option value="1">Casual Leave</option>
                                        <option value="2">Comp-Off Leave</option>
                                        <option value="3">LWP</option>
                                        <option value="4">Privileging Leave</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label class="col-sm-5 col-form-label">Application Type:</label>
                                <div class="col-sm-7">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="leaveStatus" id="regularid" value="Regular">
                                        <label class="form-check-label" for="regularid">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="leaveStatus" id="Previousmonthid" value="Previous">
                                        <label class="form-check-label" for="Previousmonthid">Previous Month</label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label class="col-sm-5 col-form-label">From Date:</label>
                                <div class="col-sm-7">
                                    <input type="date" class="form-control" id="formdateid">
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label class="col-sm-5 col-form-label">To Date:</label>
                                <div class="col-sm-7">
                                    <input type="date" class="form-control" id="todateid" readonly>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label class="col-sm-5 col-form-label">No. of Days:</label>
                                <div class="col-sm-7">
                                    <input type="number" class="form-control" id="nodaysid">
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label class="col-sm-5 col-form-label">Reason:</label>
                                <div class="col-sm-7">
                                    <textarea class="form-control" id="resonid" rows="3" placeholder="Enter reason here..."></textarea>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label class="col-sm-5 col-form-label">Responsible:</label>
                                <div class="col-sm-7">
                                    <select class="form-control" id="responsibleid">
                                        <option value="">-- Select Employee --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label class="col-sm-5 col-form-label">Cancel Weekoff:</label>
                                <div class="col-sm-7">
                                    <select class="form-control" id="weekid">
                                        <option value="">-- Select --</option>
                                        <option value="1">Yes</option>
                                        <option value="0">No</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-md-8 offset-md-4 d-flex justify-content-end">
                                    <button type="button" class="btn btn-primary me-2" id="submitid">Submit</button>
                                    <button type="button" class="btn btn-secondary" id="clearbuttonid">Clear</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Leave Balance -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><h6 class="mb-0">Leave Balance</h6></div>
                            <div class="card-body">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr><th>Leave Type</th><th>Balance</th></tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                                <p class="text-muted mt-3" style="font-size: 0.9rem;">
                                    <strong>Note:</strong> Weekoff/Holiday inclusion depends on policy & approval.
                                </p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const apiBase = '@apiBase';
    const Empid = parseInt(localStorage.getItem("EmployeeId"));
    const EmployeeName = localStorage.getItem("EmployeeName");
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany || '{}');
    const Compid = parseInt(companyDetails.CompanyId);

    $(document).ready(function () {
        const today = new Date().toISOString().split('T')[0];
        $('#applicationDate').val(today);
        $('#employedid').val(EmployeeName);

        loadReportingPerson();
        loadResponsibleDropdown();

        $('#formdateid').on('change', function () {
            $('#nodaysid').trigger('input');
        });

        $('#nodaysid').on('input', function () {
            const fromDateStr = $('#formdateid').val();
            const noOfDays = parseInt($(this).val(), 10);

            if (!fromDateStr || isNaN(noOfDays)) {
                $('#todateid').val('').prop('readonly', true);
                return;
            }

            const fromDate = new Date(fromDateStr);
            const toDate = new Date(fromDate);
            toDate.setDate(fromDate.getDate() + noOfDays - 1);

            const yyyy = toDate.getFullYear();
            const mm = String(toDate.getMonth() + 1).padStart(2, '0');
            const dd = String(toDate.getDate()).padStart(2, '0');

            $('#todateid').val(`${yyyy}-${mm}-${dd}`);
        });

        $('#submitid').on('click', function () {
            const leaveType = $('#Leavetypeid').val();
            const applicationType = $('input[name="leaveStatus"]:checked').val();

            if (leaveType === "0" || !applicationType || !$('#formdateid').val() || !$('#todateid').val() || !$('#nodaysid').val() || !$('#resonid').val()) {
                Swal.fire("All fields are required", "", "warning");
                return;
            }

            const payload = {
                EmplooyeId: Empid,
                ReportingManagerId: parseInt($('#reportingManagerId').val()),
                LeaveType: parseInt(leaveType),
                ApplicationType: applicationType,
                FromDate: $('#formdateid').val(),
                Todate: $('#todateid').val(),
                No_Of_Date: parseFloat($('#nodaysid').val()),
                Reason: $('#resonid').val(),
                Responsibleperson: parseInt($('#responsibleid').val()) || null,
                Cancel_Weekoff: $('#weekid').val() === "1",
                Send_Intimate: $('#weekid').val()
            };

            $.ajax({
                url: apiBase + '/LeaveApplication/AddLeaveapplication',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (response) {
                    if (response.isSuccess) {
                        Swal.fire("Success", response.responseMessage, "success");
                        $('#leaveForm')[0].reset();
                    } else {
                        Swal.fire("Error", response.responseMessage, "error");
                    }
                },
                error: function () {
                    Swal.fire("Error", "An error occurred while submitting", "error");
                }
            });
        });

        $('#clearbuttonid').on('click', function () {
            $('#leaveForm')[0].reset();
        });
    });

    function loadReportingPerson() {
        $.ajax({
            url: `${apiBase}/LeaveApplication/GetReportingperson?Empid=${Empid}`,
            method: 'POST',
            dataType: 'json',
            success: function (response) {
                if (response.isSuccess && response.data) {
                    $('#repoid').val(response.data.fullName);
                    $('#reportingManagerId').val(response.data.id);
                }
            }
        });
    }

    function loadResponsibleDropdown() {
        $.ajax({
            url: `${apiBase}/CompOffAPI/ReportingPersonEmpVise?Compid=${Compid}&Empid=${Empid}`,
            method: 'POST',
            success: function (res) {
                if (res.isSuccess && res.data?.length > 0) {
                    const dropdown = $('#responsibleid');
                    dropdown.empty().append('<option value="">-- Select Employee --</option>');
                    res.data.forEach(item => {
                        dropdown.append(`<option value="${item.reportingPersonId}">${item.reportingPersonName}</option>`);
                    });
                }
            },
            error: function () {
                Swal.fire("Error", "Could not load responsible list", "error");
            }
        });
    }
</script>

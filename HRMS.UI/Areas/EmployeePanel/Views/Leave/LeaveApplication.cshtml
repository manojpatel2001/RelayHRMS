@{
    ViewData["Title"] = "Employee Panel";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrl = ViewBag.BaseUrl;
    string apiBase = ViewBag.BaseUrlAPI;
}

<title>Search Panel</title>
<!-- jQuery + Bootstrap + SweetAlert -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
    }

    .form-section {
        padding: 15px;
        border: 1px solid #ccc;
    }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        font-weight: 600;
        padding: 4px 12px;
        border: none;
        border-radius: 4px;
    }

        .btn-custom:hover {
            background-color: #2c3a57;
        }

    .search-panel-container {
        background-color: #3e4b6d;
        padding: 6px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .form-control-sm, .form-select-sm {
        height: calc(1.5em + .5rem + 2px);
        font-size: 0.875rem;
        padding: .25rem .5rem;
    }

    .text-center-cell {
        text-align: center !important;
    }

        .text-center-cell > div {
            text-align: center !important;
        }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        border: none;
        padding: 4px 12px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 4px;
        transition: none;
        box-shadow: none;
    }

        .btn-custom:hover,
        .btn-custom:focus,
        .btn-custom:active {
            background-color: #3e4b6d;
            color: white;
            outline: none;
            box-shadow: none;
        }
</style>

<div class="search-panel-wrapper">
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Search Panel</div>
            <div class="ms-auto">
                <a href="@Url.Action("AddLeave", "Leave", new { area = "EmployeePanel" })" class="btn btn-primary btn-sm">Add</a>
            </div>
        </div>
    </div>
</div>


<div class="form-section">
    <div class="row justify-content-center mb-3">
        <div class="col-md-4 d-flex align-items-center">
            <label for="Leavetypeid" class="form-label mb-0 me-2" style="width: 120px;">Leave Type:</label>
            <select class="form-control form-control-sm" id="Leavetypeid">
                <option value="0">-- Select --</option>
            </select>
        </div>
        <div class="col-md-4 d-flex align-items-center">
            <label for="input1" class="form-label mb-0 me-2" style="width: 120px;">Search For:</label>
            <input type="text" class="form-control form-control-sm" id="input1" placeholder="Search Employee code or Name" disabled>
        </div>
    </div>

    <!-- Status & Buttons -->
    <div class="row justify-content-center mb-3">
        <div class="col d-flex align-items-center justify-content-center flex-wrap gap-3">

            <button type="button" class="search-panel-container  search-heading btn-sm" id="gobutoonid">GO</button>
            <button type="button" class="search-panel-container  search-heading btn-sm" id="clearbuttonid">Clear</button>
        </div>
    </div>

    <div class="search-panel-wrapper">
        <div class="search-panel-container">
            <div class="search-panel-row">
                <div class="search-heading">Leave Application</div>
            </div>
        </div>
    </div>
</div>

<div class="form-section">
    <div class="container mt-3">
        <div class="d-flex justify-content-end mb-2 align-items-center" id="actionButtons" style="display: none;">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="leaveStatus" id="pendingleaveid" value="Pending" checked>
                <label class="form-check-label" for="pendingleaveid">Pending</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="leaveStatus" id="Approveid" value="ApprovedRejected">
                <label class="form-check-label" for="Approveid">Approved/Rejected</label>
            </div>
            <button id="btnDelete" class="btn btn-custom">Delete</button>
        </div>
        <div id="attendanceGrid">Loading...</div>
        <div id="recordSummary" class="text-center mt-2 text-muted"></div>
    </div>
</div>

<!-- Script -->
<script>

    const apiBase = '@apiBase';
    const Empid = parseInt(localStorage.getItem("EmployeeId"));
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany || '{}');
    const Compid = parseInt(companyDetails.CompanyId);
    let selectedKeys = [];


    $(document).ready(function () {
         fetchLeaveData();
         loadSearchByOptions();

        // Trigger on GO button
        $('#gobutoonid').on('click', function () {
            fetchLeaveData();
        });

        $('#pendingleaveid').on('click', function () {
            fetchLeaveData();
        });

        $('#Approveid').on('click', function () {
            fetchLeaveData();
        });

        // Trigger on radio button change
        $('input[name="leaveStatus"]').on('change', function () {
            fetchLeaveData();
        });

         $('#Leavetypeid').change(function () {
            $('#input1').prop('disabled', $(this).val() === '0');
        });

        // Clear button
        $('#clearbuttonid').on('click', function () {
            $('#Leavetypeid').val('0');
            $('#input1').val('').prop('disabled', true);
            $('#pendingleaveid').prop('checked', true);
            selectedKeys = [];
            $('#deleteButton').prop('disabled', true);
            fetchLeaveData();
        });

        // Delete button click handler
        $('#deleteButton').on('click', function () {
            if (selectedKeys.length === 0) {
                Swal.fire("Warning", "Please select at least one record to delete", "warning");
                return;
            }

            Swal.fire({
                title: 'Are you sure?',
                text: `You are about to delete ${selectedKeys.length} record(s). This action cannot be undone!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteSelectedRecords();
                }
            });
        });

    function loadSearchByOptions() {
        $.ajax({
            url: apiBase + '/LeaveMasterAPI/LeaveType?Compid=' + Compid,
            type: "GET",
            success: function (res) {
                const dropdown = $('#Leavetypeid');
                dropdown.empty().append(`<option value="0">-- Select --</option>`);

                if (res.isSuccess && res.data) {
                    $.each(res.data, function (i, item) {
                        dropdown.append(`<option value="${item.leavtypeid}">${item.leaveName}</option>`);
                    });
                }
            },
            error: function () {
                console.error("Failed to load leave type options.");
            }
        });
    }


        function formatDate(dateString) {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
       }

        // Main AJAX function
        function fetchLeaveData() {
             if ($("#attendanceGrid").data("dxDataGrid")) {
            $("#attendanceGrid").dxDataGrid("dispose");
            $("#attendanceGrid").empty();
             }

          const searchFor = $('#input1').val().trim();
           const leaveTypeRaw = $('#Leavetypeid').val();
            let filter = {
                  LeaveType: leaveTypeRaw === "0" || !leaveTypeRaw ? 0 : parseInt(leaveTypeRaw),
                    Status: $('input[name="leaveStatus"]:checked').val() || null,
                    SearchFor: searchFor,
                    Emplooyeid:Empid,
                     CompId:Compid

            };

            $.ajax({
                url: apiBase + '/LeaveApplication/GetLeaveApplications',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(filter ),
                     success: function (data) {

                    if (data.isSuccess && data.data && data.data.length > 0) {
                        allData = data.data;
                        currentPage = 1;
                       renderTable(allData);

                    } else {
                        $('#attendanceGrid').html('<div class="text-center text-muted">No records found.</div>');
                        $('#recordSummary').text('');
                        $('#actionButtons').hide();
                        $('#deleteButton').prop('disabled', true);
                    }
                },

                error: function (xhr) {
                    console.error("AJAX error:", xhr);
                    Swal.fire("❌ Server Error", xhr.responseText || "Something went wrong", "error");
                }
            });
        }

    });



        $('#btnDelete').on('click', function () {
        var grid = $("#attendanceGrid").dxDataGrid("instance");
        var selectedRows = grid.getSelectedRowsData();

        if (selectedRows.length === 0) {
            Swal.fire("Warning", "Please select at least one record to delete.", "warning");
            return;
        }

        const nonPendingRecords = selectedRows.filter(row => {
            const status = row.leaveStatus;
            // Check if status exists and is NOT "Pending" (case-insensitive)
            return status && status.trim().toLowerCase() !== "pending";
        });

        if (nonPendingRecords.length > 0) {
            // Count approved and rejected separately
            const approvedCount = nonPendingRecords.filter(row =>
                row.leaveStatus.trim().toLowerCase() === "approved"
            ).length;

            const rejectedCount = nonPendingRecords.filter(row =>
                row.leaveStatus.trim().toLowerCase() === "rejected"
            ).length;

            let message = `Cannot delete records: `;
            let parts = [];

            if (approvedCount > 0) {
                parts.push(`${approvedCount} approved`);
            }
            if (rejectedCount > 0) {
                parts.push(`${rejectedCount} rejected`);
            }

            message += parts.join(' and ') + ". Only pending records can be deleted.";

            Swal.fire({
                title: "Cannot Delete",
                text: message,
                icon: "error",
                confirmButtonText: "OK"
            });
            return;
        }

        // ✅ Proceed with deletion (only pending records)
        const selectedIds = selectedRows.map(row => row.leaveApplicationId);
        const deletePayload = {
            Id: selectedIds,
            DeletedBy: Empid.toString()
        };

        Swal.fire({
            title: 'Are you sure?',
            text: `Delete ${selectedRows.length} pending record(s)?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: apiBase + "/LeaveApplication/Delete",
                    type: 'DELETE',
                    contentType: 'application/json',
                    data: JSON.stringify(deletePayload),
                    success: function (res) {
                        if (res.isSuccess) {
                            Swal.fire({
                                title: "Success",
                                text: res.responseMessage || "Records deleted successfully.",
                                icon: "success",
                                timer: 2000
                            }).then(() => {
                                grid.clearSelection();
                                selectedKeys = [];
                                $('#actionButtons').hide();
                                fetchLeaveData();
                            });
                        } else {
                            Swal.fire("Error", res.responseMessage || "Deletion failed.", "error");
                        }
                    },
                    error: function (xhr) {
                        Swal.fire("Error", "Something went wrong during deletion.", "error");
                        console.error("Delete error:", xhr);
                    }
                });
            }
        });
    });


        function renderTable(data) {

            $("#attendanceGrid").dxDataGrid({
                dataSource: data,
                keyExpr: "leaveApplicationId",
                showBorders: true,
                 columnAutoWidth: true,
                 height:400,
                selection: {
                    mode: "multiple",
                    showCheckBoxesMode: "always"
                },
                      paging: { enabled: false },
                                        scrolling: {
                                            mode: "standard",
                                            useNative: true,
                                            showScrollbar: "always"    },
                onSelectionChanged: function (e) {
                    selectedKeys = e.selectedRowKeys;
                    $("#actionButtons").show();
                    $("#deleteButton").prop('disabled', selectedKeys.length === 0);
                },
                columns: [
                    { dataField: "leaveApplicationId", caption: "ApplicationId", width: 80,cssClass: "text-center-cell" ,visible: false },
                    { dataField: "employeeName", caption: "Employee Name",cssClass: "text-center-cell" },
                    { dataField: "leaveTypeName", caption: "Leave Type",cssClass: "text-center-cell" },
                    { dataField: "reportingPersonName", caption: "Reporting Person",cssClass: "text-center-cell" },
                    { dataField: "fromDate", caption: "From Date", dataType: "date", format: "dd/MM/yyyy" ,cssClass: "text-center-cell"},
                    { dataField: "todate", caption: "To Date", dataType: "date", format: "dd/MM/yyyy" ,cssClass: "text-center-cell"},
                    { dataField: "no_Of_Date", caption: "Days",cssClass: "text-center-cell" },
                     { dataField: "reason", caption: "Reason",cssClass: "text-center-cell" },
                     { dataField: "applicationType", caption: "Application Type" ,cssClass: "text-center-cell",visible: false  },
                     { dataField: "leaveStatus", caption: "Leave Status" ,cssClass: "text-center-cell" },
                 {
                        dataField: "approvedBy",
                        caption: "Approved By",
                        width: 120,
                        calculateCellValue: function(rowData) {
                            return rowData.approvedBy ? rowData.approvedBy : "-";
                        }
                    },

               {
        dataField: "approvedDate",
        caption: "Approved Date",
        dataType: "date",
        format: "dd/MM/yyyy",
        width: "10%",
        minWidth: 100,
        calculateCellValue: function(rowData) {
            if (!rowData.approvedDate) return "-";

            const date = new Date(rowData.approvedDate);

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }
    }


                ]
            });
        }

</script>
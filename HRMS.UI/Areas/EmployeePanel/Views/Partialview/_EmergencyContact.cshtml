@inject IConfiguration Configuration
@{
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}

<style>
    .form-heading {
        background-color: #87CEEB;
        padding: 8px 15px;
        font-weight: bold;
        color: #000;
        border-radius: 4px 4px 0 0;
        margin-bottom: 10px;
    }

    .form-row {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 10px;
    }

    .form-group-custom,
    .d-flex.align-items-center {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
    }

    .form-control-sm, .form-select-sm {
        width: 230px;
    }

    .form-check-input {
        transform: scale(1.1);
        margin-right: 5px;
    }

    .form-check-label {
        margin-right: 15px;
    }

    .form-section {
        display: none;
        border: 1px solid #ccc;
        padding: 15px;
        background-color: #fff;
    }

    .section-title {
        font-weight: bold;
        margin: 10px 0;
    }

    .col-md-6 table {
        width: 100%;
        table-layout: fixed;
    }

    .col-md-6 th,
    .col-md-6 td {
        word-wrap: break-word;
    }
</style>

<!-- Emergency Contact(s)-->
<div id="form-section-area">
    <form id="emergencyContactForm">
        <div id="EmergencyContact-form" class="card p-3 form-section">
            <div class="form-heading">Emergency Contact(s)</div>
            <div class="form-row">

                <div class="form-group-custom">
                    <label class="form-label-fixed mb-0">Name  <span class="text-danger">*</span>:</label>
                    <input type="text" class="form-control form-control-sm" id="txtEmergencyName">
                    <span id="spnEmergencyName" style="color:red; display:none;">Please Enter Name</span>
                </div>

                <div class="form-group-custom">
                    <label class="form-label-fixed mb-0">Relationship <span class="text-danger">*</span>:</label>
                    <select class="form-select form-select-sm" id="ddlEmergencyRelationship">
                        <option value="">-- Select --</option>
                        <option value="1">Brother</option>
                        <option value="2">Father</option>
                        <option value="3">Daughter</option>
                        <option value="4">Father</option>
                        <option value="5">Mother</option>
                        <option value="6">Son</option>
                        <option value="7">Sister</option>
                        <option value="8">Spouse</option>
                    </select>
                    <span id="spnEmergencyRelationship" style="color:red; display:none;">Please Select Relationship</span>

                </div>
            </div>

            <div class="form-row">
                <div class="form-group-custom">
                    <label class="form-label-fixed mb-0">Mobile  <span class="text-danger">*</span>:</label>
                    <input type="text" class="form-control form-control-sm" id="txtEmergencyMobile">
                    <span id="spnEmergencyMobile" style="color:red; display:none;">Please Enter Mobile</span>

                </div>

                <div class="form-group-custom">
                    <label class="form-label-fixed mb-0">Home Phone :</label>
                    <input type="text" class="form-control form-control-sm" id="txtEmergencyHomePhone">
                    <span id="spnEmergencyHomePhone" style="color:red; display:none;">Please Enter Home Phone</span>

                </div>
            </div>
            <div class="form-row">
                <div class="form-group-custom">
                    <label class="form-label-fixed mb-0">Work Phone:</label>
                    <input type="text" class="form-control form-control-sm" id="txtEmergencyWorkPhone">
                    <span id="spnEmergencyWorkPhone" style="color:red; display:none;">Please Enter Work Phone</span>

                </div>
            </div>
            <div class="form-row d-flex justify-content-center mt-4">

                @* <button type="button" class="btn btn-primary me-3" id="btnSaveEmergencyContact">Submit</button>
            <button type="button" class="btn btn-primary">Delete</button> *@

                <button type="button" class="btn btn-primary " style="background-color:#394867 !important" id="btnSaveEmergencyContact">Save</button>
                <button type="button" class="btn  " style="background-color:#e2e2e2 !important" id="btnResetEmergencyContact" onclick="resetEmergencyContactForm()">Reset</button>

            </div>
        </div>


        <!-- Dependents -->
        @*  <div id="Dependents-form" class="form-section">
            <div class="row">
                <!-- Nominee Section -->
                <div class="col-md-6">
                    <div class="form-heading">Nominee</div>

                    <div class="form-row">
                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">Name <span class="text-danger">*</span> :</label>
                            <input type="text" class="form-control form-control-sm">
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">Relationship <span class="text-danger">*</span> :</label>
                            <select class="form-select form-select-sm">
                                <option>--Select--</option>
                                <option value="Brother">Brother</option>
                                <option value="Daughter">Daughter</option>
                                <option value="Father">Father</option>
                                <option value="Mother">Mother</option>
                                <option value="Son">Son</option>
                                <option value="Sister">Sister</option>
                                <option value="Spouse">Spouse</option>
                            </select>
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">Address :</label>
                            <input type="text" class="form-control form-control-sm">
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">DOB <span class="text-danger">*</span> :</label>
                            <input type="date" class="form-control form-control-sm">
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">Share <span class="text-danger">*</span> :</label>
                            <input type="number" class="form-control form-control-sm" value="0">
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">Nominee for :</label>
                            <select class="form-select form-select-sm">
                                <option>All</option>
                                <option>PF</option>
                                <option>Gratuity</option>
                                <option>ESIC</option>
                                <option>GPA</option>
                                <option>Super Annuation</option>
                            </select>
                        </div>


                        <div class="form-group-custom d-flex align-items-center">
                            <label class="form-label-fixed mb-0" for="chkDisability">Is Residing with him/her  :</label>
                            <div class="ms-3 d-flex align-items-center">
                                <input class="form-check-input" type="checkbox">
                            </div>
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">PAN Card :</label>
                            <input type="text" class="form-control form-control-sm">
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">Aadhar Card :</label>
                            <input type="text" class="form-control form-control-sm">
                        </div>
                    </div>

                    <button class="btn btn-primary btn-sm">Submit</button>
                    <button class="btn btn-danger btn-sm">Delete</button>
                </div>

                <!-- Vertical Line Separator -->
                <div class="col-md-1 d-flex justify-content-center">
                    <div style="border-left: 1px solid #ccc; height: 100%;"></div>
                </div>

                <!-- Family Details Section -->
                <div class="col-md-5">
                    <div class="form-heading">Family Details</div>

                    <div class="form-row">
                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">Name <span class="text-danger">*</span> :</label>
                            <input type="text" class="form-control form-control-sm">
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">Relationship <span class="text-danger">*</span> :</label>
                            <select class="form-select form-select-sm">
                                <option value="">-- Select --</option>
                                <option value="Brother">Brother</option>
                                <option value="Daughter">Daughter</option>
                                <option value="Father">Father</option>
                                <option value="Mother">Mother</option>
                                <option value="Son">Son</option>
                                <option value="Sister">Sister</option>
                                <option value="Spouse">Spouse</option>
                            </select>
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">Gender :</label>
                            <select class="form-select form-select-sm">
                                <option>Male</option>
                                <option>Female</option>
                                <option>Other</option>
                            </select>
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">DOB :</label>
                            <input type="date" class="form-control form-control-sm">
                        </div>

                        <!-- Stacked Checkboxes -->

                        <div class="form-group-custom d-flex align-items-center">
                            <label class="form-label-fixed mb-0" for="chkDisability">Is Residing with him/her :</label>
                            <div class="ms-3 d-flex align-items-center">
                                <input class="form-check-input" type="checkbox">
                            </div>
                        </div>

                        <div class="form-group-custom d-flex align-items-center">
                            <label class="form-label-fixed mb-0" for="chkDisability">Is Dependent on you?:</label>
                            <div class="ms-3 d-flex align-items-center">
                                <input class="form-check-input" type="checkbox">
                            </div>
                        </div>
                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">Photo upload :</label>
                            <input type="file" class="form-control form-control-sm">
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">PAN Card :</label>
                            <input type="text" class="form-control form-control-sm">
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-fixed mb-0">Aadhar Card :</label>
                            <input type="text" class="form-control form-control-sm">
                        </div>
                    </div>

                    <button class="btn btn-primary btn-sm">Submit</button>
                    <button class="btn btn-danger btn-sm">Delete</button>
                </div>
            </div>
        </div> *@
        <!--Immigration-->
        @*  <div id="Immigration-form" class="form-section">
        <div class="form-heading">Immigration</div>
        <div class="row">
            <!-- Left Side -->
            <div class="col-md-6">
                <div class="form-group-custom d-flex align-items-center mb-2">
                    <label class="form-label-fixed mb-0 me-2"> <input type="radio" name="type" checked> Passport </label>
                    <label class="form-label-fixed mb-0 ms-4"> <input type="radio" name="type"> Visa </label>
                </div>

                <div class="form-group-custom mb-2">
                    <label class="form-label-fixed mb-0">Passport No. <span class="text-danger">*</span> :</label>
                    <input type="text" class="form-control form-control-sm">
                </div>

                <div class="form-group-custom mb-2">
                    <label class="form-label-fixed mb-0">Issue Date <span class="text-danger">*</span> :</label>
                    <input type="date" class="form-control form-control-sm">
                </div>

                <div class="form-group-custom mb-2">
                    <label class="form-label-fixed mb-0">Renew Date :</label>
                    <input type="date" class="form-control form-control-sm">
                </div>

                <div class="form-group-custom mb-2">
                    <label class="form-label-fixed mb-0">Comments :</label>
                    <textarea class="form-control form-control-sm"></textarea>
                </div>
            </div>

            <!-- Right Side -->
            <div class="col-md-6">
                <div class="form-group-custom mb-2">
                    <label class="form-label-fixed mb-0">Citizenship :</label>
                    <select class="form-select form-select-sm">
                        <option>INDIA</option>
                        <option>USA</option>
                        <option>UK</option>
                    </select>
                </div>

                <div class="form-group-custom mb-2">
                    <label class="form-label-fixed mb-0">Date of Expiry <span class="text-danger">*</span> :</label>
                    <input type="date" class="form-control form-control-sm">
                </div>

                <div class="form-group-custom mb-2">
                    <label class="form-label-fixed mb-0">Status :</label>
                    <input type="text" class="form-control form-control-sm">
                </div>

                <div class="form-group-custom mb-2">
                    <label class="form-label-fixed mb-0">Attach Documents :</label>
                    <input type="file" class="form-control form-control-sm">
                </div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="mt-3 text-center">
            <button class="btn btn-primary btn-sm">Submit</button>
            <button class="btn btn-danger btn-sm">Delete</button>
        </div>
    </div> *@
    </form>
    <div class="row">
        <div class="col-md-12 mt-2">

            <div class="table-responsive table-responsive-fixed">
                <table class="table table-bordered" id="tableEmegency">
                    <thead class="thead-dark">
                        <tr>
                            <th style="width:18%">Name</th>
                            <th style="width:18%">Relation</th>
                            <th style="width:18%">Mobile No</th>
                            <th style="width:18%">Home Phone</th>
                            <th style="width:18%">Work Phone</th>

                            <th style="width:10%">Actions</th> <!-- Add action column -->
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            @* 	<div class="form-group" id="tagEmergencyGrid">
					<div class="rowCount" id="rowCountEmergency"></div>
					<div id="gridContainerEmegency">
						<div class="d-flex justify-content-center align-items-center" style="height: 10vh;">
							<div class="spinner-border text-primary" role="status">
								<span class="visually-hidden">Loading...</span>
							</div>
						</div>
					</div>

				</div>
				<div id="spnNoRecord" style="display:none;">No Record Found!</div>
 *@
        </div>
    </div>
</div>


<script>
    (function () {
        const currentEmployeeId = localStorage.getItem("EmployeeId");
        let emergencyContactId = 0;
        let emergencyDetails = [];

        // ✅ Save / Update Emergency Contact
        $("#btnSaveEmergencyContact").click(function () {
            $("#btnSaveEmergencyContact").prop("disabled", true);

            if (!validateEmergencyContactForm()) {
                $("#btnSaveEmergencyContact").prop("disabled", false);
                return;
            }

            const contact = {
                EmployeeId: currentEmployeeId,
                EmergencyContactId: emergencyContactId || 0,
                Name: $("#txtEmergencyName").val().trim(),
                RelationShipId: $("#ddlEmergencyRelationship").val(),   // 👈 direct dropdown value
                MobileNo: $("#txtEmergencyMobile").val().trim(),
                HomePhoneNo: $("#txtEmergencyHomePhone").val().trim() || null,
                WorkPhoneNo: $("#txtEmergencyWorkPhone").val().trim() || null,
                CreatedBy: emergencyContactId === 0 ? currentEmployeeId : null,
                UpdatedBy: emergencyContactId === 0 ? null : currentEmployeeId
            };

            const isNew = emergencyContactId === 0;
            const url = isNew
                ? "@baseUrl/EmergencyContactAPI/CreateEmergencyContact"
                : "@baseUrl/EmergencyContactAPI/UpdateEmergencyContact";

            const method = isNew ? "POST" : "PUT";

            $.ajax({
                url: url,
                type: method,
                contentType: "application/json",
                data: JSON.stringify(contact),
                success: function (response) {
                    if (response.isSuccess) {
                        round_success_noti(response.responseMessage);
                        loadEmergencyContactff();
                        resetEmergencyContactForm();
                    } else {
                        round_error_noti(response.responseMessage);
                    }
                    $("#btnSaveEmergencyContact").prop("disabled", false);
                },
                error: function (err) {
                    console.error("Save EmergencyContact Error:", err);
                    round_error_noti("Something went wrong while saving Emergency Contact!");
                    $("#btnSaveEmergencyContact").prop("disabled", false);
                }
            });
        });

        // ✅ Load grid
        async function loadEmergencyContactff() {
            try {
                const response = await fetch(`@baseUrl/EmergencyContactAPI/GetAllEmergencyContacts/${currentEmployeeId}`);
                const data = await response.json();
                const tableBody = $('#tableEmegency tbody');
                tableBody.empty();

                if (data.isSuccess && data.data?.length > 0) {
                    emergencyDetails = data.data;
                    data.data.forEach(row => {
                        tableBody.append(`
                            <tr>
                                <td>${row.name ?? ''}</td>
                                <td>${row.relationName ?? ''}</td>
                                <td>${row.mobileNo ?? ''}</td>
                                <td>${row.homePhoneNo ?? ''}</td>
                                <td>${row.workPhoneNo ?? ''}</td>
                                <td>
                                    <a href="#" onclick="editEmergencyContact(${row.emergencyContactId})">✏️</a>
                                    <a href="#" onclick="deleteEmergencyContact(${row.emergencyContactId})">🗑️</a>
                                </td>
                            </tr>
                        `);
                    });
                } else {
                    tableBody.append('<tr><td colspan="6" class="text-center">No data found.</td></tr>');
                }
            } catch (error) {
                console.error("Error loading emergency contacts:", error);
            }
        }

            function resetEmergencyContactForm() {
        emergencyContactId = 0;

        // Clear input fields
        $("#txtEmergencyName, #txtEmergencyMobile, #txtEmergencyHomePhone, #txtEmergencyWorkPhone").val("");
        $("#ddlEmergencyRelationship").val("");

        // Hide validation messages
        $("#spnEmergencyName, #spnEmergencyRelationship, #spnEmergencyMobile, #spnEmergencyHomePhone, #spnEmergencyWorkPhone").hide();

        // Reset button text
        $("#btnSaveEmergencyContact").text("Save").prop("disabled", false);
    }


        // ✅ Edit
        window.editEmergencyContact = function (id) {
            resetEmergencyContactForm();
            const rowData = emergencyDetails.find(x => x.emergencyContactId === id);
            if (!rowData) return;

            emergencyContactId = id;
            $("#txtEmergencyName").val(rowData.name);
            $("#ddlEmergencyRelationship").val(rowData.relationShipId); // 👈 direct ID bind
            $("#txtEmergencyMobile").val(rowData.mobileNo);
            $("#txtEmergencyHomePhone").val(rowData.homePhoneNo);
            $("#txtEmergencyWorkPhone").val(rowData.workPhoneNo);

            $("#btnSaveEmergencyContact").text("Update");
        }

        // ✅ Delete
        window.deleteEmergencyContact = function (id) {
            if (!confirm("Are you sure you want to delete?")) return;

            const deleteObj = { id: id, deletedBy: currentEmployeeId };

            $.ajax({
                url: "@baseUrl/EmergencyContactAPI/DeleteEmergencyContact",
                type: "DELETE",
                contentType: "application/json",
                data: JSON.stringify(deleteObj),
                success: function (response) {
                    if (response.isSuccess) {
                        round_success_noti(response.responseMessage);
                        loadEmergencyContactff();
                        resetEmergencyContactForm();
                    } else {
                        round_error_noti(response.responseMessage);
                    }
                },
                error: function (err) {
                    console.error("Error deleting emergency contact:", err);
                    round_error_noti("Something went wrong while deleting Emergency Contact!");
                }
            });
        }

        // ✅ Relationship dropdown load
        async function loadBindRelationShipOption() {
            try {
                const response = await fetch('@baseUrl/RelationShipAPI/GetAllRelationShips');
                const data = await response.json();

                const dropdown = $('#ddlEmergencyRelationship');
                dropdown.empty();

                if (data.isSuccess && data.data?.length > 0) {
                    dropdown.append(`<option value="" disabled selected>Select</option>`);
                    $.each(data.data, function (_, x) {
                        dropdown.append(`<option value="${x.relationShipId}">${x.relationName}</option>`);
                    });
                } else {
                    dropdown.append(`<option disabled>No relationships found</option>`);
                }
            } catch (error) {
                console.error('Error loading relationships:', error);
                $('#ddlEmergencyRelationship').empty().append(`<option disabled>Error loading data</option>`);
            }
        }

        // ✅ Validation
        function validateEmergencyContactForm() {
            let isValid = true;

            // Name
            if ($("#txtEmergencyName").val().trim() === "") {
                $("#spnEmergencyName").show();
                isValid = false;
            } else $("#spnEmergencyName").hide();

            // Relationship
            if (!$("#ddlEmergencyRelationship").val()) {
                $("#spnEmergencyRelationship").show();
                isValid = false;
            } else $("#spnEmergencyRelationship").hide();

            // Mobile
            let mobile = $("#txtEmergencyMobile").val().trim();
            if (mobile === "") {
                $("#spnEmergencyMobile").text("Please Enter Phone Number").show();
                isValid = false;
            } else if (mobile.length !== 10) {
                $("#spnEmergencyMobile").text("Number must be 10 digits").show();
                isValid = false;
            } else $("#spnEmergencyMobile").hide();

            // Home Phone
            let homePhone = $("#txtEmergencyHomePhone").val().trim();
            if (homePhone && homePhone.length !== 10) {
                $("#spnEmergencyHomePhone").text("Number must be 10 digits").show();
                isValid = false;
            } else $("#spnEmergencyHomePhone").hide();

            // Work Phone
            let workPhone = $("#txtEmergencyWorkPhone").val().trim();
            if (workPhone && workPhone.length !== 10) {
                $("#spnEmergencyWorkPhone").text("Number must be 10 digits").show();
                isValid = false;
            } else $("#spnEmergencyWorkPhone").hide();

            return isValid;
        }

        // ✅ On page load
        loadEmergencyContactff();
        loadBindRelationShipOption();
    })();
</script>



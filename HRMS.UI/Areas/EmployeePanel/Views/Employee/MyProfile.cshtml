@inject IConfiguration Configuration
@{
    ViewData["Title"] = "My Profile";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];
    var uriAPI = new Uri(baseUrl);
    string baseAPIDomainUrl = $"{uriAPI.Scheme}://{uriAPI.Host}:{uriAPI.Port}";

}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
@* <style>
    body {
        font-family: Arial, sans-serif;
    }

    .form-section {
        display: none;
    }

        .form-section:not(.d-none) {
            display: block;
        }


  /*   .form-label-fixed {
        width: 180px;
        text-align: right;
        margin-right: 10px;
        font-weight: normal;
        background-color: transparent;
        display: inline-block;
        white-space: nowrap;
    } */

    .center-heading {
        text-align: center;
    }

    .icon-container {
        display: flex;
        flex-wrap: wrap; /* allow wrapping */
        justify-content: flex-start;
        gap: 16px; /* increase spacing if needed */
        padding: 12px;
    }



    .icon-box {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        margin: 0 auto;
    }

    .icon-label {
        text-align: center;
        font-size: 11px;
        margin-top: 6px;
        width: 70px;
        word-break: break-word;
        line-height: 1.2;
        margin: 6px auto 0 auto;
    }

    .icon-item {
        text-align: center;
        width: 70px;
        cursor: pointer;
    }

    .orange {
        background-color: #f4511e;
    }

    .blue {
        background-color: #2196f3;
    }

    .red {
        background-color: #e53935;
    }

    .purple {
        background-color: #9c27b0;
    }

    .pink {
        background-color: #ec407a;
    }

    .dark {
        background-color: #424242;
    }

    .lime {
        background-color: #aed581;
        color: #000;
    }

    .yellow {
        background-color: #ffeb3b;
        color: #000;
    }

    .green {
        background-color: #4caf50;
    }

    .brown {
        background-color: #8d6e63;
    }

    .magenta {
        background-color: #d81b60;
    }

    .darkgreen {
        background-color: #2e7d32;
    }

    .form-heading {
        background-color: #87CEEB;
        padding: 8px 15px;
        font-weight: bold;
        color: #000;
        border-radius: 4px 4px 0 0;
        margin-bottom: 10px;
    }

    .form-row {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 10px;
    }

    .form-group-custom,
    .d-flex.align-items-center {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
    }

    .form-control-sm, .form-select-sm {
        width: 230px;
    }

    .form-check-input {
        transform: scale(1.1);
        margin-right: 5px;
    }

    .form-check-label {
        margin-right: 15px;
    }

    .form-section {
        display: none;
        border: 1px solid #ccc;
        padding: 15px;
        background-color: #fff;
    }

    .section-title {
        font-weight: bold;
        margin: 10px 0;
    }

    .col-md-6 table {
        width: 100%;
        table-layout: fixed;
    }

    .col-md-6 th,
    .col-md-6 td {
        word-wrap: break-word;
    }
</style> *@
<style>
       .card {
        margin: 20px;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .form-label-fixed {
        width: 150px;
    }
    .icon-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }

    .icon-box {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        margin: 0 auto;
    }

    .icon-label {
        text-align: center;
        font-size: 11px;
        margin-top: 6px;
        width: 80px;
        word-break: break-word;
        line-height: 1.2;
        margin: 6px auto 0 auto;
    }

    .icon-item {
        text-align: center;
        width: 70px;
        cursor: pointer;
    }

    .orange { background-color: #ffa500; }
    .blue { background-color: #007bff; }
    .red { background-color: #dc3545; }
    .purple { background-color: #6f42c1; }
    .pink { background-color: #e83e8c; }
    .dark { background-color: #343a40; }
    .lime { background-color: #28a745; }
    .yellow { background-color: #ffc107; }
    .green { background-color: #28a745; }
    .brown { background-color: #A52A2A; }
    .magenta { background-color: #FF00FF; }
    .darkgreen { background-color: #006400; }
    .icon-label {
        text-align: center;
        font-size: 12px;
    }
    
    h4.text-center {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    .inp-width{
        width:230px;
    }

    #profileImage {
       border:1px solid grey;
        object-fit: cover;
        cursor: pointer;
    }

    #cropModal .modal-dialog {
        max-width: 600px; /* Optional: limit modal width */
    }

    #cropModal .modal-body {
        max-height: 70vh;
        overflow: auto;
    }

    #cropImagePreview {
        max-width: 100%;
        max-height: 60vh;
        display: block;
        margin: 0 auto;
    }


</style>

<div class="card p-3">

    <h4 class="text-center">
        <span id="empCode"></span>
        <span>-</span>
        <span id="empName"></span>
    </h4>
    <!-- Employee Information Sections -->
    <div class="row px-5 py-2">
        <div class="col-md-4">
            <!-- Left Side -->
            <div class="row mb-2 g-3">
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Login ID:</label>
                    <input type="text" id="loginid" class="form-control form-control-sm inp-width" readonly>
                </div>
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Alpha Emp Code:</label>
                    <input type="text" id="Alpempcodeid" class="form-control form-control-sm inp-width" readonly >
                </div>
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Branch Name:</label>
                    <input type="text" id="branchid" class="form-control form-control-sm inp-width" readonly >
                </div>
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Grade:</label>
                    <input type="text" id="gradeid" class="form-control form-control-sm inp-width" readonly>
                </div>
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Date Of Join:</label>
                    <input type="datetime" id="dateofjoinid" class="form-control form-control-sm inp-width" readonly>
                </div>
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Shift Name:</label>
                    <input type="text" id="shiftnameid" class="form-control form-control-sm inp-width" readonly>
                </div>
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Category:</label>
                    <input type="text" id="category" class="form-control form-control-sm inp-width" readonly>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <!-- Right Side -->
            <div class="row mb-2 g-3">
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Designation:</label>
                    <input type="text" id="desgid" class="form-control form-control-sm inp-width" readonly>
                </div>
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Monthly CTC:</label>
                    <input type="text" id="monthCTCid" class="form-control form-control-sm inp-width" readonly>
                </div>
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Monthly Basic:</label>
                    <input type="text" id="monthlybasicid" class="form-control form-control-sm inp-width" readonly>
                </div>
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Monthly Gross:</label>
                    <input type="text" id="monthlyGrossid" class="form-control form-control-sm inp-width" readonly>
                </div>
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Department:</label>
                    <input type="text" id="depatid" class="form-control form-control-sm inp-width" readonly>
                </div>
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Employment Type:</label>
                    <input type="text" id="employmentType" class="form-control form-control-sm inp-width" readonly>
                </div>
                <div class="col-md-12 d-flex align-items-center">
                    <label class="form-label-fixed mb-0">Manager:</label>
                    <input type="text" id="manager" class="form-control form-control-sm inp-width" readonly>
                </div>
            </div>

        </div>

        
        <div class="col-md-4">

            <!-- PHOTO Upload -->
            <div class="mb-4 text-center">
                <label>Profile Picture</label><br>

                <img id="profileImage"
                     src="@baseAPIDomainUrl/uploads/defaultuserprofile/user-profile-png-image.png"
                     alt="Profile Image"
                     style="width: 200px; height: 150px; cursor: pointer;border:1px solid grey;" />

                <input type="file" id="profileInput" accept="image/jpeg" class="d-none" />

                @* <!-- Show filename BELOW image -->
                <div id="fileInfo" class="mt-2" style="display: none; margin-left:20px;">
                    <p>
                        <span id="fileNameText" class="text-success"></span>
                        <span id="deleteBtn">
                            <i class="fas fa-trash text-danger ms-2 cursor-pointer" aria-hidden="true"></i>
                        </span>
                    </p>
                </div> *@
            </div>

            @* <!-- SIGNATURE Upload -->
            <div class="mb-4 text-center">
                <label>Signature</label><br>

                <img id="empSignPreview"
                     src="@baseAPIDomainUrl/uploads/defaultuserprofile/default-signature.jpg"
                     style="width: 200px; height: 50px; cursor: pointer;"
                     class="img-thumbnail" />

                <input type="file" id="empSignatureInput" class="d-none" accept=".jpg,.jpeg" />
 *@
                @* <!-- Show signature filename BELOW image -->
                <div id="signFileInfo" class="mt-2" style="display: none;">
                    <p>
                        <span id="signFileNameText" class="text-success"></span>
                        <span id="deleteSignBtn">
                            <i class="fas fa-trash text-danger ms-2 cursor-pointer" aria-hidden="true"></i>
                        </span>
                    </p>
                </div> 
            </div>*@

            <!-- Upload button -->
            <div class="text-center mt-4">
                <div id="uploadBtnTag" class="mt-2" style="display: none;">
                    <button type="button" class="btn btn-primary" id="btnUpload" style="background-color:#2395c6; color:white;">
                        Upload
                    </button>
                </div>
            </div>

        </div>
      
            <div class="col-md-2">
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="pt" disabled>
                    <label class="form-check-label" for="pt">PT</label>
                </div>
            </div>

          

            <div class="col-md-2">
                <div class="form-check mt-4">
                    <input class="form-check-input" checked type="checkbox" id="isPFApplicable" disabled>
                    <label class="form-check-label" for="isPFApplicable">Is PF Applicable</label>
                </div>
            </div>

    </div>
    <hr />
    <!-- Personal Information-->

    <div class="icon-container mb-4">

        <!-- Personal Information -->
        <div class="icon-item" onclick="openForm('personal-form')">
            <div class="icon-box orange"><i class="fas fa-user"></i></div>
            <div class="icon-label">Personal Information</div>
        </div>

        <div class="icon-item" onclick="openForm('contact-form-section')">
            <div class="icon-box blue"><i class="fas fa-phone"></i></div>
            <div class="icon-label">Contact</div>
        </div>

        <div class="icon-item" onclick="openForm('emergency-form')">
            <div class="icon-box red"><i class="fas fa-phone"></i></div>
            <div class="icon-label">Emergency Contact(s)</div>
        </div>


   @*      <div class="icon-item" onclick="openForm('Dependents-form')">
            <div class="icon-box purple"><i class="fas fa-people-group"></i></div>
            <div class="icon-label">Dependents</div>
        </div>
 *@
      @*   <div class="icon-item" onclick="openForm('Immigration-form')">
            <div class="icon-box pink"><i class="fas fa-plane"></i></div>
            <div class="icon-label">Immigration</div>
        </div> *@

       @*  <div class="icon-item" onclick="openForm('Asset-License-form')">
            <div class="icon-box red"><i class="fas fa-house-user"></i></div>
            <div class="icon-label">Asset & License</div>
        </div> *@

        <div class="icon-item" onclick="openForm('reporting-contract-form')">
            <div class="icon-box dark"><i class="fas fa-file-contract"></i></div>
            <div class="icon-label">Reporting & Contract</div>


        </div>
      @*   <div class="icon-item" onclick="openForm('Experience-Language-form')">
            <div class="icon-box lime"><i class="fas fa-language"></i></div>
            <div class="icon-label">Experience & Language</div>
        </div>*@
       @*  <div class="icon-item" onclick="openForm('Qualification-form')">
            <div class="icon-box yellow"><i class="fas fa-award"></i></div>
            <div class="icon-label">Qualification</div>
        </div> *@
        <div class="icon-item" onclick="openForm('Skill-form')">
            <div class="icon-box green"><i class="fas fa-screwdriver-wrench"></i></div>
            <div class="icon-label">Skills</div>
        </div> 
        <div class="icon-item" onclick="openForm('Attachments-form')">
            <div class="icon-box brown"><i class="fas fa-paperclip"></i></div>
            <div class="icon-label">Attachments</div>
        </div>
        <div class="icon-item" onclick="openForm('allowance-form')">
            <div class="icon-box magenta"><i class="fas fa-money-bill-wave"></i></div>
            <div class="icon-label">Allowance</div>
        </div>
        <div class="icon-item" onclick="openForm('salary-form')">
            <div class="icon-box darkgreen"><i class="fas fa-rupee-sign"></i></div>
            <div class="icon-label">Salary</div>
        </div>

    </div>

    <!-- Containers -->
    <div id="partialViewContainer">
        <div id="personal-form" class="partial-section"></div>
        <div id="contact-form-section" class="partial-section d-none"></div>
        <div id="emergency-form" class="partial-section d-none"></div>
        <div id="Dependents-form" class="partial-section d-none"></div>
        <div id="Immigration-form" class="partial-section d-none"></div>
        <div id="Asset-License-form" class="partial-section d-none"></div>
        <div id="reporting-contract-form" class="partial-section d-none"></div>
        <div id="Experience-Language-form" class="partial-section d-none"></div>
        <div id="Qualification-form" class="partial-section d-none"></div>
        <div id="Skill-form" class="partial-section d-none"></div>
        <div id="Attachments-form" class="partial-section d-none"></div>
        <div id="allowance-form" class="partial-section d-none"></div>
        <div id="salary-form" class="partial-section d-none"></div>
    </div>



</div>

<!-- Modal HTML -->
<div class="modal" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropModalLabel">Crop Profile Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <img id="cropImagePreview" src="" alt="Image preview" class="img-fluid">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="cropConfirmBtn">Confirm Crop</button>
            </div>
        </div>
    </div>
</div>
<!-- CropperJS CSS & JS -->
<script src="~/assets/js/jquery.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


<script>

    const savedCompany = localStorage.getItem('selectedCompany');
    var companyDetails = JSON.parse(savedCompany);
    const companyId = companyDetails.CompanyId;
    const employeeId = localStorage.getItem('EmployeeId');
    const token = localStorage.getItem("authToken");

    $(document).ready(function () {
            loadEmployeeProfile();
        $('#btnShowMore').click(function () {
            var $moreDetailsForm = $('#more-details-form');
            var $btnSubmitPersonal = $('#submit-personal');
            var $btnSubmitMore = $('#submit-more');

            if ($moreDetailsForm.is(':visible')) {
                $moreDetailsForm.hide();
                $(this).text('Show');
                $btnSubmitPersonal.show();
            } else {
                $moreDetailsForm.show();
                $(this).text('Hide');
                $btnSubmitPersonal.hide();
            }
        });

    });


        function loadEmployeeProfile()
        {

           
            if (!companyId) {
                round_error_noti("Please select company");
                return;
            }
            if (!employeeId) {
                round_error_noti("Employee ID not found");
                return;
            }
            $.ajax({
                url: '@baseUrl/MyProfileAPI/GetMyProfileWithEmp',
                method: 'GET',
                data: { companyId: companyId, employeeId: employeeId },
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function (data) {
                    if (data.isSuccess) {
                        let emp = data.data[0];
                        $('#loginid').val(emp.loginAlias);
                        $('#Alpempcodeid').val(emp.employeeCode);
                        $('#branchid').val(emp.branchName);
                        $('#gradeid').val(emp.gradeName);
                        $('#dateofjoinid').val(formatToDDMMYYYY(emp.dateOfJoining));
                        $('#shiftnameid').val(emp.shiftName);
                        $('#desgid').val(emp.designationName);
                        $('#monthCTCid').val(emp.monthlyCTC);
                        $('#monthlybasicid').val(emp.monthlyBasic);
                        $('#monthlyGrossid').val(emp.monthlyGross);
                        $('#depatid').val(emp.departmentName);
                        $('#enrollnoid').val(emp.enrollNo);
                        $('#mailid').val(emp.email);
                        $('#employmentType').val(emp.employeeTypeName);
                        $('#category').val(emp.categoryName);
                        $('#manager').val(emp.reportingManagerName);
                        $('#pt').prop('checked', emp.pt || false);
                         $('#isPFApplicable').prop('checked', emp.isPFApplicable || false);

                          $('#empCode').text(emp.employeeCode);   // span ke liye
                          $('#empName').text(emp.fullName);       // span ke liye
                          // Profile and Signature Images
                        if (emp.employeeProfileUrl) {
                            $('#profileImage').attr('src', emp.employeeProfileUrl);
                            
                        } 
                       

                    } else {
                        round_error_noti(data.responseMessage);
                    }
                },
                error: function (err) {
                    console.error("Error fetching employee profile: ", err);
                }
            });
        } // end of function


     function formatToDDMMYYYY(dateInput) {
        const date = new Date(dateInput);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    $(document).ready(function () {
        openForm('personal-form');
    });


     function openForm(formId) {

        let viewName = '';
        switch (formId) {
            case 'personal-form': viewName = 'PersonalInfo'; break;
            case 'contact-form-section': viewName = 'Contact'; break;
             case 'emergency-form': viewName = 'EmergencyContact'; break; // 👈 FIXED
            case 'Dependents-form': viewName = 'Dependents'; break;
            case 'Immigration-form': viewName = 'Immigration'; break;
            case 'Asset-License-form': viewName = 'AssetAndLicense'; break;

             case 'reporting-contract-form': viewName = 'Reporting'; break;
                    case 'Experience-Language-form': viewName = 'Experience'; break;
            case 'Qualification-form': viewName = 'Qualification'; break;
            case 'Skill-form': viewName = 'Skills'; break;
            case 'Attachments-form': viewName = 'Attachments'; break;
            case 'allowance-form': viewName = 'Allowance'; break;
            case 'salary-form': viewName = 'Salary'; break;
            default:
                console.error("❌ No matching viewName found for", formId);
                return;
        }
        
          $.ajax({
            url: `/EmployeePanel/PartialView/${viewName}`,
            method: 'GET',
            success: function (data) {
               // sab sections ko hide karo
                $(".partial-section").addClass("d-none");
                // jis formId pe click hua usme HTML inject karo
                    $("#" + formId).find('script').remove(); // Remove old scripts
                    $("#" + formId).html(data).removeClass("d-none");

            },
            error: function (xhr) {
                console.error('AJAX failed:', xhr.status, xhr.statusText);
            }
        });
    }


</script>

<script>
        let cropper;
    let selectedFile;
    let profileFile = null;
    let currentCropTarget = 'profile'; // default target

    // Trigger file input
    $('#profileImage').click(() => {
        currentCropTarget = 'profile';
        $('#profileInput').click();
    });

    // File selected
    $('#profileInput').change(function () {
        const file = this.files[0];
        if (!file || !file.name.toLowerCase().endsWith(".jpg")) {
            alert("Only JPG files are allowed.");
            return;
        }

        selectedFile = file;
        const reader = new FileReader();
        reader.onload = function (e) {
            $('#cropImagePreview').attr('src', e.target.result);
            $('#cropImagePreview').on('load', function () {
                initCropper();
            });

            const modal = new bootstrap.Modal(document.getElementById('cropModal'));
            modal.show();
        };
        reader.readAsDataURL(file);
    });

    // Initialize Cropper
    function initCropper() {
        const image = document.getElementById('cropImagePreview');
        if (cropper) cropper.destroy();

        cropper = new Cropper(image, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1
        });
    }

    // Destroy cropper on modal close
    $('#cropModal').on('hidden.bs.modal', function () {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        
    });

    // Confirm Crop
    $('#cropConfirmBtn').click(function () {
        if (!cropper) {
            alert("Cropper not initialized.");
            return;
        }

        const canvas = cropper.getCroppedCanvas({ width: 150, height: 150 });

        canvas.toBlob(function (blob) {
            const croppedFile = new File([blob], selectedFile.name, {
                type: "image/jpeg",
                lastModified: Date.now()
            });

            const previewURL = URL.createObjectURL(croppedFile);
            $('#profileImage').attr('src', previewURL);
            profileFile = croppedFile;
            $("#uploadBtnTag").show();
            bootstrap.Modal.getInstance(document.getElementById('cropModal')).hide();
        }, "image/jpeg");
    });

    // Upload Cropped Image
    $("#btnUpload").click(() => {
        $("#btnUpload").prop("disabled", true);

        if (!profileFile) {
            round_error_noti("Please select and crop an image first!");
            $("#btnUpload").prop("disabled", false);
            return;
        }

        const profileFormdata = new FormData();
        profileFormdata.append("EmployeeId", employeeId); // Make sure employeeId is defined
        profileFormdata.append("EmployeeProfileFile", profileFile);

        $.ajax({
            url: '@baseUrl/ProfileManageAPI/UpdateProfilePic', // Replace with your actual endpoint
            type: 'POST',
            data: profileFormdata,
            processData: false,
            contentType: false,
            success: function (response) {
                if (response.isSuccess) {
                    const employee = response.data;
                    const imageUrl = employee.employeeProfileUrl ;
                    if(imageUrl){
                        $('#profileImage').attr('src', imageUrl);
                        $("#uploadBtnTag").hide();
                    
                       round_success_noti(response.responseMessage);
                      $('.profileImage').attr('src', imageUrl);
                    }
                } else {
                    round_error_noti(response.responseMessage);
                }
                $("#btnUpload").prop("disabled", false);
            },
            error: function (xhr, status, error) {
                $("#btnUpload").prop("disabled", false);
            }
        });
    });


</script>



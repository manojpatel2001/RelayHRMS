@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Employee Panel";
    Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];
}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<title>Salary Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8fafc;
        color: #334155;
        width: 100%;
        overflow-x: auto;
    }

    .container {
        width: 100%;
        max-width: none;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
    }

    /* Header */
    .header {
        background: white;
        border-bottom: 1px solid #e2e8f0;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        width: 100%;
    }

    .header-content {
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header h1 {
        color: #1e293b;
        font-size: 24px;
        font-weight: 600;
    }

    .breadcrumb {
        color: #64748b;
        font-size: 14px;
    }

    /* Dashboard Grid - Responsive */
    .dashboard-grid {
        display: grid;
        grid-template-columns: minmax(280px, 320px) 1fr minmax(250px, 280px);
        gap: 20px;
        margin-bottom: 20px;
        width: 100%;
    }

    /* Responsive grid using CSS Grid auto-fit */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
        width: 100%;
    }

    /* Force 3 columns on larger screens */
    .dashboard-grid-large {
        grid-template-columns: minmax(280px, 320px) 1fr minmax(250px, 280px);
    }

    /* Cards */
    .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
        width: 100%;
    }

    .card-header {
        padding: 20px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .card-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

    .card-content {
        padding: 20px;
    }

    /* Calculated Days */
    .days-legend {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        font-size: 12px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .legend-color {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .present-days-info {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
        font-weight: 600;
    }

    .present-indicator {
        width: 12px;
        height: 12px;
        background: #3b82f6;
        border-radius: 50%;
    }

    .days-bar {
        margin-bottom: 15px;
    }

    .days-bar-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 14px;
    }

    .bar-container {
        height: 24px;
        background: #f1f5f9;
        border-radius: 4px;
        display: flex;
        overflow: hidden;
        width: 100%;
    }

    .bar-segment {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
        color: white;
    }

    .bar-present {
        background: #3b82f6;
    }

    .bar-holiday {
        background: #10b981;
    }

    .bar-leave {
        background: #ef4444;
    }

    /* Chart */
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 10px;
        width: 100%;
    }

    .chart-legend {
        display: flex;
        gap: 20px;
        margin-top: 10px;
        font-size: 14px;
        flex-wrap: wrap;
    }

    /* Quick Access */
    .quick-access-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .quick-access-item {
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        text-align: left;
        width: 100%;
    }

        .quick-access-item:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

    /* Yearly Table */
    .yearly-card {
        grid-column: 1 / -1;
        width: 100%;
    }

    .year-selector {
        padding: 6px 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: white;
        font-size: 14px;
    }

    .salary-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        min-width: 800px;
    }

        .salary-table th,
        .salary-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            white-space: nowrap;
        }

        .salary-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .salary-table td {
            color: #6b7280;
        }

        .salary-table tr:hover {
            background: #f8fafc;
        }

    .net-amount-row {
        background: #eff6ff !important;
        font-weight: 600;
    }

        .net-amount-row td {
            color: #1e293b;
        }

    /* Loading */
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        width: 100%;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }



    .hidden {
        display: none;
    }

    .text-center {
        text-align: center;
    }

    .overflow-x-auto {
        overflow-x: auto;
        width: 100%;
    }

    /* Responsive utilities */
    .responsive-header {
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
    }

    .responsive-legends {
        justify-content: center;
        flex-wrap: wrap;
    }

    /* Compact table styles */
    .compact-table th,
    .compact-table td {
        padding: 8px;
        font-size: 12px;
    }
</style>

<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>Salary Dashboard</h1>
            <div class="breadcrumb">
                🏠 Home > Salary
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard" class="hidden">
        <!-- Main Grid -->
        <div class="dashboard-grid dashboard-grid-large" id="dashboardGrid">
            <!-- Calculated Days -->
            <div class="card">
                <div class="card-header">
                    <h2>Calculated Salary Days</h2>
                </div>
                <div class="card-content">
                    <div class="present-days-info">
                        <div class="present-indicator"></div>
                        <span>Present Days: <span id="currentPresentDays">23.5</span></span>
                    </div>

                    <div class="days-legend responsive-legends">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fbbf24;"></div>
                            <span>Holiday Days</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ef4444;"></div>
                            <span>Total Leave Days</span>
                        </div>
                    </div>

                    <div id="daysContainer">
                        <!-- Days bars will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Salary Chart -->
            <div class="card">
                <div class="card-header">
                    <h2>Salary Summary of Last 6 Months</h2>
                </div>
                <div class="card-content">
                    <div class="chart-legend responsive-legends">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <span>Net Salary</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>Gross Salary</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="salaryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Quick Access -->
            <div class="card">
                <div class="card-header">
                    <h2>Quick Access</h2>
                </div>
                <div class="card-content">
                    <div class="quick-access-list">
                        <button class="quick-access-item" onclick="handleQuickAccess('ctc')">CTC Letter (Annexure)</button>
                        <button class="quick-access-item" onclick="handleQuickAccess('form11')">FORM 11 (PF)</button>
                        <button class="quick-access-item" onclick="handleQuickAccess('form16')">Form-16(IT)</button>
                        <button class="quick-access-item" onclick="handleQuickAccess('tax-declaration')">Income Tax Declaration</button>
                        <button class="quick-access-item" onclick="handleQuickAccess('pf-statement')">PF Statement</button>
                        <button class="quick-access-item" onclick="handleQuickAccess('salary-slip')">Salary Slip</button>
                        <button class="quick-access-item" onclick="handleQuickAccess('tax-prep')">Tax Preparation</button>
                        <button class="quick-access-item" onclick="handleQuickAccess('yearly-salary')">Yearly Salary</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Yearly Salary Table -->
        <div class="card yearly-card">
            <div class="card-header">
                <h2>Yearly Salary</h2>
                <select id="yearSelector" class="year-selector" >
                    <!-- Years will be populated dynamically here -->
                </select>
            </div>
            <div class="card-content">
                <div id="gridContainer"></div>
            </div>
        </div>
    </div>
</div>

<script>

        const savedCompany = localStorage.getItem('selectedCompany');
    var companyDetails = savedCompany ? JSON.parse(savedCompany) : null;
    const Compid = companyDetails ? companyDetails.CompanyId : null;
    const EmployeeId = localStorage.getItem('EmployeeId');
    const Token = localStorage.getItem("authToken");
    // Global variables
    let salaryChart;
    let dashboardData = {};

    // Mock API data - Replace with your .NET API calls
    const mockApiData = {
        calculatedDays: [
            { month: 'Nov-2024', presentDays: 23.5, holidayDays: 4, leaveDays: 2.5 },
            { month: 'Dec-2024', presentDays: 24, holidayDays: 5, leaveDays: 2 },
            { month: 'Feb-2025', presentDays: 21, holidayDays: 4, leaveDays: 3 },
            { month: 'Apr-2025', presentDays: 26, holidayDays: 4, leaveDays: 0 },
            { month: 'May-2025', presentDays: 23.5, holidayDays: 4, leaveDays: 3.5 },
            { month: 'Jun-2025', presentDays: 23, holidayDays: 5, leaveDays: 2 }
        ],
        salaryChart: [
            { month: 'Nov-2024', netSalary: 75610, grossSalary: 76176 },
            { month: 'Dec-2024', netSalary: 60610, grossSalary: 76176 },
            { month: 'Feb-2025', netSalary: 75610, grossSalary: 76176 },
            { month: 'Apr-2025', netSalary: 60610, grossSalary: 76176 },
            { month: 'May-2025', netSalary: 87037, grossSalary: 87603 },
            { month: 'Jun-2025', netSalary: 52037, grossSalary: 87603 }
        ]
  
    };

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        setupResponsiveLayout();
        loadDashboardData(); 
        fetchYearlySalaryReport(EmployeeId);
        populateYearDropdown();



    });  


         $('#yearSelector').change(function() {
            const selectedYear = $(this).val();
            if (selectedYear) {
                fetchYearlySalaryReport(EmployeeId);
            }
        });

     function renderTable(data) {
        $("#gridContainer").dxDataGrid({
            dataSource: data,
            showBorders: true,
            columnAutoWidth: true,
            allowColumnReordering: true,
            allowColumnResizing: true,
            columnResizingMode: "widget",
            scrolling: {
                mode: "standard",
                useNative: true
            },
            columnFixing: {
                enabled: true
            },
            columns: [

                      {
                    dataField: "salaryHead",
                    caption: "Salary Head",
                    cssClass: "text-center-cell",
                    format: { type: "fixedPoint", precision: 2 },
                    cellTemplate: function(container, options) {
                        container.css("font-weight", "700");
                          container.css("background-color", "#f8f9fa");
                        container.text(options.value);
                    }
                },
                { dataField: "jan", caption: "Jan", cssClass: "text-center-cell", format: { type: "fixedPoint", precision: 2 } },
                { dataField: "feb", caption: "Feb", cssClass: "text-center-cell", format: { type: "fixedPoint", precision: 2 } },
                { dataField: "mar", caption: "Mar", cssClass: "text-center-cell", format: { type: "fixedPoint", precision: 2 } },
                { dataField: "apr", caption: "Apr", cssClass: "text-center-cell", format: { type: "fixedPoint", precision: 2 } },
                { dataField: "may", caption: "May", cssClass: "text-center-cell", format: { type: "fixedPoint", precision: 2 } },
                { dataField: "jun", caption: "Jun", cssClass: "text-center-cell", format: { type: "fixedPoint", precision: 2 } },
                { dataField: "jul", caption: "Jul", cssClass: "text-center-cell", format: { type: "fixedPoint", precision: 2 } },
                { dataField: "aug", caption: "Aug", cssClass: "text-center-cell", format: { type: "fixedPoint", precision: 2 } },
                { dataField: "sep", caption: "Sep", cssClass: "text-center-cell", format: { type: "fixedPoint", precision: 2 } },
                { dataField: "oct", caption: "Oct", cssClass: "text-center-cell", format: { type: "fixedPoint", precision: 2 } },
                { dataField: "nov", caption: "Nov", cssClass: "text-center-cell", format: { type: "fixedPoint", precision: 2 } },
                { dataField: "dec", caption: "Dec", cssClass: "text-center-cell", format: { type: "fixedPoint", precision: 2 } }
       
            ]
        });
    }


        function populateYearDropdown() {
          const startYear = 2024;
          const currentYear = new Date().getFullYear();
          const yearDropdown = $("#yearSelector");
          yearDropdown.empty();
          yearDropdown.append('<option value="">--Select--</option>');
          for (let year = currentYear; year >= startYear; year--) {
              yearDropdown.append(`<option value="${year}">${year}</option>`);
          }
      }


    function setupResponsiveLayout() {
        function checkScreenSize() {
            const dashboardGrid = document.getElementById('dashboardGrid');
            const headerContent = document.querySelector('.header-content');

            if (window.innerWidth <= 768) {
                // Mobile layout
                dashboardGrid.classList.remove('dashboard-grid-large');
                headerContent.classList.add('responsive-header');

                // Make table compact on mobile
                const table = document.querySelector('.salary-table');
                if (table) {
                    table.classList.add('compact-table');
                }

                // Adjust chart height
                const chartContainer = document.querySelector('.chart-container');
                if (chartContainer) {
                    chartContainer.style.height = '250px';
                }
            } else {
                // Desktop layout
                dashboardGrid.classList.add('dashboard-grid-large');
                headerContent.classList.remove('responsive-header');

                const table = document.querySelector('.salary-table');
                if (table) {
                    table.classList.remove('compact-table');
                }

                const chartContainer = document.querySelector('.chart-container');
                if (chartContainer) {
                    chartContainer.style.height = '300px';
                }
            }
        }

        // Check on load and resize
        checkScreenSize();
        window.addEventListener('resize', checkScreenSize);
    }

    // Load data function - Replace with your API call
    async function loadDashboardData() {
        try {
            // Show loading
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');

            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 1000));
   
            dashboardData = mockApiData;

            // Hide loading and show dashboard
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            // Render all components
            renderCalculatedDays();     
     

        } catch (error) {
            console.error('Error loading dashboard data:', error);
            alert('Error loading dashboard data. Please try again.');
        }
    }

    // Render calculated days bars
    function renderCalculatedDays() {
        const container = document.getElementById('daysContainer');
        const currentDays = dashboardData.calculatedDays[dashboardData.calculatedDays.length - 1];

        document.getElementById('currentPresentDays').textContent = currentDays.presentDays;

        container.innerHTML = dashboardData.calculatedDays.map(item => {
            const total = 30; // Assuming 30 days max
            const presentWidth = (item.presentDays / total) * 100;
            const holidayWidth = (item.holidayDays / total) * 100;
            const leaveWidth = (item.leaveDays / total) * 100;

            return `
                <div class="days-bar">
                    <div class="days-bar-header">
                        <span>${item.month}</span>
                        <span>${item.presentDays}</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-segment bar-present" style="width: ${presentWidth}%">
                            ${item.presentDays}
                        </div>
                        <div class="bar-segment bar-holiday" style="width: ${holidayWidth}%">
                            ${item.holidayDays}
                        </div>
                        <div class="bar-segment bar-leave" style="width: ${leaveWidth}%">
                            ${item.leaveDays > 0 ? item.leaveDays : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    


    // Handle quick access clicks
    function handleQuickAccess(type) {
        // Replace with your .NET controller action URLs
        const urls = {
            'ctc': '/Salary/CTCLetter',
            'form11': '/Salary/Form11',
            'form16': '/Salary/Form16',
            'tax-declaration': '/Salary/TaxDeclaration',
            'pf-statement': '/Salary/PFStatement',
            'salary-slip': '/Salary/SalarySlip',
            'tax-prep': '/Salary/TaxPreparation',
            'yearly-salary': '/Salary/YearlySalary'
        };

        if (urls[type]) {
            window.location.href = urls[type];
        }
    }

    // Example API integration functions for your .NET backend

    // Function to call your .NET API
    async function fetchSalaryData() {
        try {
            const response = await fetch('/api/Salary/GetDashboardData', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            return await response.json();
        } catch (error) {
            console.error('Error fetching salary data:', error);
            throw error;
        }
    }

    function fetchYearlySalaryReport(EmployeeId) {
        debugger;
          var selectedYear = document.getElementById('yearSelector').value || '2025';

        var isValid = true;
        // Validate the selected year
        if (selectedYear === "" || selectedYear === null) {
            $("#spnyear").show();
            isValid = false;
        } else {
            $("#spnyear").hide();
        }
        if (!isValid) {
            return;
        }

        $.ajax({
           url: '@(baseDomainUrl + "/api/MonthlySalaryDetailsAPI/GetYearlySalaryCard")',
            type: 'GET',
            data: {
                year: parseInt(selectedYear),
                EmployeeId: EmployeeId
            },
            contentType: 'application/json',
            success: function (res) {
                console.log("res", res);
                if (res.isSuccess) {            
                    renderTable(res.data);
                } else {
                    if (typeof round_error_noti === 'function') {
                        round_error_noti(res.responseMessage || 'No Data Found');
                    } else {
                        alert(res.responseMessage || 'No Data Found');
                    }
                    renderTable([]);
                }
            },
            error: function (xhr) {
                console.error("AJAX Error:", xhr);
                if (typeof round_error_noti === 'function') {
                    round_error_noti(xhr.responseJSON?.responseMessage || 'An error occurred. Please try again.');
                } else {
                    alert('An error occurred. Please try again.');
                }
                renderTable([]);
            }
        });
    }


 
</script>
@{
	ViewData["Title"] = "Employee Panel";
	Layout = "~/Areas/EmployeePanel/Views/Shared/_EmployeeLayout.cshtml";
	string baseUrl = ViewBag.BaseUrl;
	string apiBase = ViewBag.BaseUrlAPI; 
}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
	.notification-list-container ul {
		max-height: 180px;
		overflow-y: auto;
		padding-left: 20px;
		margin: 0;
		border: 1px solid #ddd;
	}

	/* Yellow border without shadow */
	.yellow-border {
		border: 2px solid #ffc107;
	}

	#aboutmeid {
		min-height: 400px;
	}

	#rightSideCard {
		min-height: 500px;
	}

	.search-heading {
		font-size: 15px;
		color: white;
		margin: 0;
	}

	body {
		font-family: Arial, sans-serif;
		background-color: #ffffff;
	}

	.form-section {
		padding: 15px;
		border: 1px solid #ccc;
	}

	.btn-custom {
		background-color: #3e4b6d;
		color: white;
		font-weight: 600;
		padding: 4px 12px;
		border: none;
		border-radius: 4px;
	}

		.btn-custom:hover {
			background-color: #2c3a57;
		}

	.search-panel-container {
		background-color: #3e4b6d;
		padding: 6px 15px;
		border-radius: 6px;
		margin-bottom: 15px;
	}

	.search-panel-row {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.search-heading {
		font-size: 15px;
		color: white;
		margin: 0;
	}

	.form-label {
		font-size: 13px;
		font-weight: 500;
		margin-bottom: 4px;
	}

	.form-control-sm, .form-select-sm {
		height: calc(1.5em + .5rem + 2px);
		font-size: 0.875rem;
		padding: .25rem .5rem;
	}

	.text-center-cell {
		text-align: center !important;
	}

		.text-center-cell > div {
			text-align: center !important;
		}


	.list-group-item {
		font-size: 14px;
		padding: 8px 12px;
		border: none;
		border-bottom: 1px solid #eee;
	}
</style>

<!-- Dashboard Heading -->
<div class="search-panel-wrapper">
	<div class="search-panel-container">
		<div class="search-panel-row">
			<div class="search-heading">Dashboard</div>

		</div>
	</div>
</div>
<!-- Profile, About Me, and Right Side Card Layout -->
<div class="row">
	<!-- Left Column (Profile + About Me) -->
	<div class="col-md-3">
		<!-- Profile Card -->
		<div id="profileid" class="card mb-3 radius-10 yellow-border">
			<div class="card-body text-center">
				<img id="profilePhoto" src="/images/default-avatar.png" class="rounded-circle mb-3" alt="Profile Photo" width="100" height="100" />
				<h5 id="profileName" class="text-dark mb-1"></h5>
				<p id="profileRole" class="text-muted mb-2"></p>

				<hr />
				<div class="mb-2">
					<strong class="text-dark">Last Login:</strong>
					<span id="lastLogin" class="text-muted float-end text-end"></span>
				</div>
				<hr />
				<div class="text-start">
					<div class="mb-2">
						<strong class="text-dark">Direct Team Members:</strong>
						<span id="directTeamCount" class="text-muted  float-end text-end"></span>
					</div>
					<div class="mb-2">
						<strong class="text-dark">In-Direct Team Members:</strong>
						<span id="indirectTeamCount" class="text-muted  float-end text-end"></span>
					</div>
					
				</div>

				
			</div>
		</div>

		<!-- About Me Card -->
		<div id="aboutmeid" class="card radius-10 yellow-border">
			<div class="card-body">
				<h5 class="text-dark mb-3 text-center">About Me</h5>
				<ul class="list-group list-group-flush small">
					<li class="list-group-item d-flex justify-content-between">
						<strong class="text-dark">Branch:</strong>
						<span id="branch"></span>
					</li>
					<li class="list-group-item d-flex justify-content-between">
						<strong class="text-dark">Designation:</strong>
						<span id="designation"></span>
					</li>
					<li class="list-group-item d-flex justify-content-between">
						<strong class="text-dark">Department:</strong>
						<span id="department"></span>
					</li>
					<li class="list-group-item d-flex justify-content-between">
						<strong class="text-dark">Joining Date:</strong>
						<span id="joiningDate"></span>
					</li>
					<li class="list-group-item d-flex justify-content-between">
						<strong class="text-dark">Address:</strong>
						<span id="address"></span>
					</li>
					<li class="list-group-item d-flex justify-content-between text-danger">
						<strong class="text-dark">Warning Card:</strong>
						<span id="warningCard"></span>
					</li>
				</ul>
			</div>
		</div>
	</div>

	<!-- Right Column (New Card beside the 2 stacked) -->
	<div class="col-md-9">
		<div id="rightSideCard" class="card radius-10 yellow-border">
			<div class="card-body">
				<!-- Heading and Buttons Row -->
				<div class="d-flex justify-content-between align-items-center mb-3">
					<h5 class="text-dark mb-0">My Team</h5>
					<div>
						<button class="search-panel-container  search-heading btn-sm" id="myInOutBtn">My In-Out</button>
						<button class="search-panel-container  search-heading btn-sm" id="myProfileBtn">My Profile</button>
						<button class="search-panel-container  search-heading btn-sm" id="empHistoryBtn">Employee History</button>
					</div>
				</div>

				<!-- Tabs -->
				<ul class="nav nav-tabs" id="attendanceTabs" role="tablist">
					<li class="nav-item">
						<a class="nav-link active" id="team-tab" data-toggle="tab" href="#teamid" role="tab">My Team Leave</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" id="direct-tab" data-toggle="tab" href="#directid" role="tab" value="direct">Direct Report</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" id="indirect-tab" data-toggle="tab" href="#indirectid" role="tab" value="indirect">Indirect Report</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" id="Member-tab" data-toggle="tab" href="#memberid" role="tab">My Members In-Out</a>
					</li>
				</ul>
				
			</div>
		</div>
	</div>

</div>
<script>
	const apiBase = '@apiBase';
	const Empid = parseInt(localStorage.getItem("EmployeeId"));
		const savedCompany = localStorage.getItem('selectedCompany');
	const companyDetails = JSON.parse(savedCompany || '{}');
	const Compid = parseInt(companyDetails.CompanyId);



	$(document).ready(function () {
		loadpersonaldata();
		loaddirectindirectdata();
	});

		function loadpersonaldata() {
		$.ajax({
			url: `${apiBase}/EmployeeMasterAPI/EmployeePersonalInformation?empid=${Empid}&Compid=${Compid}`,
			method: 'GET',
			contentType: 'application/json',
			success: function (data) {
				console.log("response", data);

				if (data.isSuccess && Array.isArray(data.data) && data.data.length > 0) {
					let emp = data.data[0]; // ✅ Access first object from array

					// Profile card data
					$('#profileName').text(emp.fullName || '-');
					$('#lastLogin').text(emp.lastLogin ? formatDateTime(emp.lastLogin) : '-');
						const profileUrl = emp.employeeProfileUrl?.trim();
	                $('#profilePhoto').attr('src', profileUrl ? profileUrl : 'default-avatar.png');

					// About Me card data
					$('#branch').text(emp.branchName || '-');
					$('#designation').text(emp.designationName || '-');
					$('#department').text(emp.departmentName || '-');
					$('#joiningDate').text(emp.joiningDate ? formatDate(emp.joiningDate) : '-');
					$('#address').text(emp.permanentAddress || 'N/A');
					$('#warningCard').text(emp.warningCard || '0');

					
				} else {
					console.warn("No employee data found.");
				}
			},
			error: function (xhr) {
				Swal.fire("❌ Server error", xhr.responseText, "error");
			}
		});
	}


		function formatDate(dateStr) {
		const date = new Date(dateStr);
		const day = String(date.getDate()).padStart(2, '0');        // 01 to 31
		const month = String(date.getMonth() + 1).padStart(2, '0'); // 01 to 12
		const year = date.getFullYear();                            // 2025

		return `${day}/${month}/${year}`; // DD/MM/YYYY
	}


		function formatDateTime(dateString) {
		const date = new Date(dateString);
		if (isNaN(date)) return '-';

		const day = String(date.getDate()).padStart(2, '0');
		const month = String(date.getMonth() + 1).padStart(2, '0'); // Months start from 0
		const year = date.getFullYear();

		const hours = String(date.getHours()).padStart(2, '0');
		const minutes = String(date.getMinutes()).padStart(2, '0');
		const seconds = String(date.getSeconds()).padStart(2, '0');

		return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
	}



		function loaddirectindirectdata() {
		$.ajax({
			url: `${apiBase}/EmployeeDashBoardAPI/GetCountDirectOrIndirectEmployees?empid=${Empid}&Compid=${Compid}`,
			method: 'GET',
			contentType: 'application/json',
			success: function (data) {
				console.log("response", data);

				if (data.isSuccess && Array.isArray(data.data) && data.data.length > 0) {
					let emp = data.data[0]; // ✅ Access first object from array
					console.log("emp",emp);
					
					$('#directTeamCount').text(emp.directMember || '0');
					$('#indirectTeamCount').text(emp.indirectMember || '0');
				} else {
					console.warn("No employee data found.");
				}
			},
			error: function (xhr) {
				Swal.fire("❌ Server error", xhr.responseText, "error");
			}
		});
	}



		function loaddirectindirectdata() {
		$.ajax({
			url: `${apiBase}/EmployeeDashBoardAPI/GetCountDirectOrIndirectEmployees?empid=${Empid}&Compid=${Compid}`,
			method: 'GET',
			contentType: 'application/json',
			success: function (data) {
				console.log("response", data);

				if (data.isSuccess && Array.isArray(data.data) && data.data.length > 0) {
					let emp = data.data[0]; // ✅ Access first object from array
					console.log("emp",emp);

					$('#directTeamCount').text(emp.directMember || '0');
					$('#indirectTeamCount').text(emp.indirectMember || '0');
				} else {
					console.warn("No employee data found.");
				}
			},
			error: function (xhr) {
				Swal.fire("❌ Server error", xhr.responseText, "error");
			}
		});
	}
		let fromDateStr = '';  // globally declared variable

	$('#direct-tab').on('click', function () {
		fromDateStr = 'direct';
		loaddirectindirectdetails(fromDateStr);
	});

	$('#indirect-tab').on('click', function () {
		fromDateStr = 'indirect';
		loaddirectindirectdetails(fromDateStr);
	});

			function loaddirectindirectdetails(type) {
		console.log("Loading:", type);

		$.ajax({
			url: `${apiBase}/EmployeeDashBoardAPI/GetDirectIndirectEmployee?EmployeeId=${Empid}&Compid=${Compid}&Action=${type}`,
			method: 'GET',
			contentType: 'application/json',
			success: function (data) {
				console.log(`Data for ${type}:`, data);

				let html = '';
				if (data && data.length > 0) {
					data.forEach(item => {
						html += `
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span class="text-muted">${item.EmployeeCode}</span>
								<span><strong>${item.FullName}</strong></span>
							</div>
						`;
					});
				} else {
					html = `<div class="list-group-item text-muted">No data available</div>`;
				}

				if (type === 'direct') {
					$('#directList').html(html);
				} else if (type === 'indirect') {
					$('#indirectlist').html(html);
				}
			},
			error: function (err) {
				console.error("Error fetching", type, err);
			}
		});
	}

</script>

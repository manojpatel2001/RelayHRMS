@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<div style="min-height: 600px;">
    <div class="container-fluid">
        <div class="row">
            <!-- Left Content -->
            <div class="col-lg-9">
                <div class="row">
                    <!-- Row 1 -->
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Application Status</div>
                            <div class="dashboard-body">
                                <a href="/EmployeePanel/Leave/AdminLeaveApproval" class="dashboard-link" id="leaveApplicationLink">
                                    Leave Application <span class="red-count" id="leaveCount">(0)</span>
                                </a>
                                <a href="#" class="dashboard-link">Leave Cancellation <span class="red-count" id="leaveCancellationCount">(0)</span></a>
                                <a href="/AdminPanel/DashboardReport/CompOffApprovalApplicationAdmin" class="dashboard-link" id="compApplicationLink">
                                    Comp Off Application <span class="red-count" id="compoffCount">(0)</span>
                                </a>
                                <a href="#" class="dashboard-link">Pre Comp Off Application <span class="red-count" id="preCompOffCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Loan Application <span class="red-count" id="loanCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Claim Application <span class="red-count" id="claimCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Attendance Regularization <span class="red-count" id="attendanceRegCount">(0)</span></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Quick Data</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Yearly Holiday</a>
                                <a href="#" class="dashboard-link">Company Consolidate Info</a>
                                <a href="#" class="dashboard-link">Active/InActive Users <span class="red-count" id="activeUsersCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Active/InActive Mobile Users <span class="red-count" id="mobileUsersCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Allowance/Reim Application <span class="red-count" id="allowanceCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Scheme Not Assigned</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Graphics Report</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Leave Reports</a>
                                <a href="#" class="dashboard-link">View Message</a>
                                <a href="#" class="dashboard-link">Yearly Salary</a>
                                <a href="#" class="dashboard-link">WhosOff</a>
                                <a href="#" class="dashboard-link">View Graphical Report</a>
                                <a href="#" class="dashboard-link">Continues Absent</a>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Other Details</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Insurance Reminder <span class="red-count" id="insuranceCount">(0)</span></a>
                                <a href="#" class="dashboard-link">IT Declaration History</a>
                                <a href="#" class="dashboard-link">Survey</a>
                                <a href="#" class="dashboard-link">Today's Attendance</a>
                                <a href="#" class="dashboard-link">Compoff Lapse Reminder</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Deputation/Contract</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Deputation Over <span class="red-count" id="deputationCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Contract Over <span class="red-count" id="contractCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Probation/Trainee Over <span class="red-count" id="probationCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Retirement Over <span class="red-count" id="retirementCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Document Expiry Reminder</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Leave Data</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Leave/OD Status</a>
                                <a href="#" class="dashboard-link">Leave Carry Forward</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grid Below All Cards -->
                <div class="dashboard-grid-container">
                    <div class="dashboard-header">Employees Detail</div>

                    <div class="grid-wrapper " style="position: relative; ">
                        <div id="grid-loader" class="grid-loader justify-content-center align-items-center flex-column "
                             style="display: none;  inset: 0; background: rgba(255,255,255,0.6); z-index: 10; ">
                            <img src="@baseDomainUrl/loders/loder.png" class="grid-logo-spinner" style="width: 30px;                                            height: 30px; animation: spin 1s linear infinite;" />
                            <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>

                        </div>
                        <div id="gridTag">
                            <div class="rowCount" id="rowCountEmployee"></div>
                            <div id="employeeGrid" class="p-2"></div>
                        </div>
                        <div id="noRecord" style="display:none;">
                            No Record Found!
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="col-lg-3 mt-2">
                <div class="panel-wrapper position-relative">
                    <div class="side-panel">
                        <!-- Tab Headers -->
                        <a href="#" class="tab-item active" data-tab="todaysAttendance">Today's Attendance</a>

                        <!-- Tab Content for Today's Attendance -->
                        <div id="todaysAttendanceContent" class="tab-content">
                            <div id="tab-loader" class="text-center" style="display: none;">
                                <img src="@baseDomainUrl/loders/loder.png" style="width: 20px; height: 20px; animation: spin 1s linear infinite;" />
                                <div>Loading...</div>
                            </div>
                            <div id="attendanceGrid" class="mt-2"></div>
                            <div id="attendancePopup"></div>
                        </div>

                        <a href="#" class="tab-item" data-tab="birthdayAnniversary">Birthday & Anniversary Reminder</a>

                        <!-- Tab Content for Birthday & Anniversary -->
                        <div id="birthdayAnniversaryContent" class="tab-content" style="display: none;">
                            <div class="tab-content-header">Birthday & Anniversary</div>
                            <div class="tab-placeholder">
                                <p>Birthday and Anniversary details will be displayed here</p>
                                <!-- Add your birthday/anniversary content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="addViewEvents">Add & View Events</a>

                        <!-- Tab Content for Add & View Events -->
                        <div id="addViewEventsContent" class="tab-content" style="display: none;">
                            <div class="tab-content-header">Events</div>
                            <div class="tab-placeholder">
                                <p>Events will be displayed here</p>
                                <!-- Add your events content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="messageBoard">Message Board</a>

                        <!-- Tab Content for Message Board -->
                        <div id="messageBoardContent" class="tab-content" style="display: none;">
                            <div class="tab-content-header">Message Board</div>
                            <div class="tab-placeholder">
                                <p>Messages will be displayed here</p>
                                <!-- Add your message board content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="newJoining">New Joining Details</a>

                        <!-- Tab Content for New Joining -->
                        <div id="newJoiningContent" class="tab-content" style="display: none;">
                            <div class="tab-content-header">New Joining Details</div>
                            <div class="tab-placeholder">
                                <p>New joining details will be displayed here</p>
                                <!-- Add your new joining content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="wallOfFame">Wall Of Fame</a>

                        <!-- Tab Content for Wall Of Fame -->
                        <div id="wallOfFameContent" class="tab-content" style="display: none;">
                            <div class="tab-content-header">Wall Of Fame</div>
                            <div class="tab-placeholder">
                                <p>Wall of Fame content will be displayed here</p>
                                <!-- Add your wall of fame content here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add CSS for tab functionality -->
<style>
    /* Replace your existing CSS with these updated styles */

    .side-panel {
        background: #d1d5db;
        border-radius: 8px;
        overflow: hidden;
    }

    .tab-item {
        display: block;
        padding: 8px 15px; /* Reduced from 12px to 8px - makes heading height smaller */
        color: white;
        text-decoration: none;
        border-bottom: 1px solid #ffffff;
        transition: all 0.3s ease;
        cursor: pointer;
        background-color: #2c3a57;
        font-size: 14px; /* Slightly smaller font size */
    }

        .tab-item:hover {
            background-color: #3d4b6a;
            color: white;
            text-decoration: none;
        }

        .tab-item.active {
            background-color: #9ca3af;
            color: #1f2937;
            font-weight: 500;
        }

    .tab-content {
        background: white;
        border: 1px solid #dee2e6;
        border-top: none;
        padding: 15px;
        margin-bottom: 0;
        display: none;
        min-height: 380px; /* Increased tab content height - was not set before */
        max-height: 420px; /* Set maximum height for better control */
        overflow-y: auto; /* Add scroll if content exceeds height */
    }

    .tab-content-header {
        font-weight: 600;
        color: #495057;
        padding-bottom: 8px;
        margin-bottom: 15px;
    }

    .tab-placeholder {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 20px;
    }

    .tab-content .dxDataGrid {
        font-size: 12px;
    }

        .tab-content .dxDataGrid .dx-datagrid-headers {
            font-size: 11px;
        }

    /* NEW: Hide the "Branch Name" header in Today's Attendance grid */
    #attendanceGrid .dx-datagrid-headers {
        display: none !important;
    }

    /* NEW: Add border to top of grid when header is hidden */
    #attendanceGrid .dx-datagrid-rowsview {
        border-top: 1px solid #ddd;
    }

    /* NEW: Increase grid height for more branches to show */
    #attendanceGrid {
        min-height: 380px !important;
        height: 400px !important; /* Set specific height for more data visibility */
    }

    .tab-content::-webkit-scrollbar {
        display: none;
    }

    #attendanceGrid::-webkit-scrollbar {
        display: none;
    }
</style>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const Token = localStorage.getItem("authToken");
    const userId = localStorage.getItem("EmployeeId");
    const companyDetails = JSON.parse(localStorage.getItem('selectedCompany'));
    const CompanyId = companyDetails.CompanyId;

    $(document).ready(function(){
        BranchData();
        LoadDashboardCounts();
        initializeTabs(); // Initialize tab functionality

        $('#leaveCount').text('(.)');
        $('#compoffCount').text('(.)');
    });

    function initializeTabs() {
        $('.tab-item').on('click', function(e) {
            e.preventDefault();

            const tabId = $(this).data('tab');
            const isCurrentlyActive = $(this).hasClass('active');

            // Remove active class from all tabs
            $('.tab-item').removeClass('active');

            // Hide all tab contents
            $('.tab-content').slideUp(300);

            // If the clicked tab wasn't active, make it active and show content
            if (!isCurrentlyActive) {
                $(this).addClass('active');
                $('#' + tabId + 'Content').slideDown(300);
                loadTabContent(tabId);
            }
        });
    }

    // Load content for specific tabs
    function loadTabContent(tabId) {
        switch(tabId) {
            case 'todaysAttendance':
                loadTodaysAttendanceData();
                break;
            case 'birthdayAnniversary':
                loadBirthdayAnniversaryData();
                break;
            case 'addViewEvents':
                loadEventsData();
                break;
            case 'messageBoard':
                loadMessageBoardData();
                break;
            case 'newJoining':
                loadNewJoiningData();
                break;
            case 'wallOfFame':
                loadWallOfFameData();
                break;
        }
    }

    // Load Today's Attendance Data
    function loadTodaysAttendanceData() {
        
        $('#tab-loader').show();

        $.ajax({
            type: "GET",
            url: '@baseDomainUrl/api/BranchAPI/GetAllBranchesListByCompanyId/' + CompanyId,
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (data) {
                $('#tab-loader').hide();

                if (data.isSuccess && data.data.length > 0) {
                                   $("#attendanceGrid").dxDataGrid({
                                dataSource: data.data,
                                columns: [
                                    {
                                        dataField: "branchName",
                                        cellTemplate: function(container, options) {
                                            $("<a>")
                                                .text(options.value)
                                                .css("cursor", "pointer")
                                                .on("click", function() {
                                                    showAttendancePopup(options.data.branchId, options.data.branchName);
                                                })
                                                .appendTo(container);
                                        }
                                    }
                                ],
                                showBorders: true,
                                columnAutoWidth: true,
                                height: 200,
                                scrolling: { mode: "virtual" },
                                filterRow: { visible: false },
                                headerFilter: { visible: false },
                                groupPanel: { visible: false },
                                paging: { enabled: false }
                            });


                } else {
                    $('#attendanceGrid').html('<div class="text-center p-3">No attendance data found</div>');
                }
            },
            error: function (xhr, status, error) {
                $('#tab-loader').hide();
                $('#attendanceGrid').html('<div class="text-center p-3 text-danger">Error loading attendance data</div>');
                console.error("AJAX Error: ", error);
            }
        });
    }

        async function fetchTodaysAttendance(BranchId, ShiftMasterId) {
        try {
            
            const response = await $.ajax({
                type: "GET",
                url: `@baseDomainUrl/api/EmpAttendanceAPI/GetTodaysAttendanceAdmin?BranchId=${BranchId}&ShiftMatserId=${ShiftMasterId}`,
                headers: {
                    'Authorization': 'Bearer ' + Token
                }
            });
            return response;
        } catch (error) {
            console.error("Error fetching attendance data:", error);
            return { isSuccess: false, ResponseMessage: "Error fetching data" };
        }
    }


       async function fetchShiftData() {
        try {
            const response = await $.ajax({
                type: "GET",
                url: `@baseDomainUrl/api/ShiftMasterAPI/GetAllShifts`, 
                headers: {
                    'Authorization': 'Bearer ' + Token
                }
            });
            return response;
        } catch (error) {
            console.error("Error fetching shift data:", error);
            return { isSuccess: false, data: [] };
        }
    }

async function showAttendancePopup(BranchId, BranchName) {
    const shiftsResponse = await fetchShiftData();
    const response = await fetchTodaysAttendance(BranchId, 0);
    if (response.isSuccess && response.data) {
        let currentData = response.data;

        const popup = $("#attendancePopup").dxPopup({
            title: "TODAY'S PRESENT/ABSENT LIST",
            width: 1000,
            height: 750,
            showTitle: true,
            contentTemplate: function(container) {
                // Create main container
                const mainContainer = $("<div>").css({
                    "padding": "15px",
                    "height": "100%",
                    "overflow": "hidden",
                    "background": "white"
                });

                // Filter section
                const filterContainer = $("<div>").css({
                    "padding": "10px 0",
                    "margin-bottom": "15px",
                    "display": "flex",
                    "align-items": "center",
                    "justify-content": "center",
                    "gap": "10px"
                });

                $("<label>").text("Shift Name :").css({
                    "font-weight": "bold",
                    "margin-right": "10px"
                }).appendTo(filterContainer);
                
                const shiftDropdown = $("<div>").attr("id", "shiftFilterDropdown").appendTo(filterContainer);
                const goButton = $("<div>").attr("id", "filterGoButton").appendTo(filterContainer);
                filterContainer.appendTo(mainContainer);

                // Grid container
                const gridContainer = $("<div>")
                    .attr("id", "attendanceDataGrid")
                    .css({
                        "margin": "0 auto 20px auto",
                        "max-width": "100%",
                        "height": "280px"
                    })
                    .appendTo(mainContainer);

                // Chart section
                const chartContainer = $("<div>").css({
                    "text-align": "center",
                    "margin": "20px auto 0 auto"
                });

                const chartTitle = $("<h4>").text("TODAY'S PRESENT/ABSENT LIST GRAPH").css({
                    "text-align": "center",
                    "margin-bottom": "15px",
                    "color": "#333",
                    "font-size": "16px",
                    "font-weight": "bold"
                }).appendTo(chartContainer);

                // Summary row
                const summaryContainer = $("<div>")
                    .attr("id", "attendanceSummary")
                    .css({
                        "display": "flex",
                        "justify-content": "center",
                        "gap": "20px",
                        "margin-bottom": "15px",
                        "font-weight": "bold",
                        "font-size": "14px"
                    })
                    .appendTo(chartContainer);

                // Legend
                const legendContainer = $("<div>").css({
                    "display": "flex",
                    "justify-content": "center",
                    "gap": "15px",
                    "margin-bottom": "15px",
                    "flex-wrap": "wrap"
                }).appendTo(chartContainer);

                // Chart
                const chartDiv = $("<div>")
                    .attr("id", "attendanceChart")
                    .css({
                        "height": "200px",
                        "width": "300px",
                        "margin": "0 auto"
                    })
                    .appendTo(chartContainer);

                chartContainer.appendTo(mainContainer);

                // Initialize dropdown
                    let shiftOptions = [{ shiftID: 0, shiftName: "--Select--" }];
                if (shiftsResponse.isSuccess && shiftsResponse.data) {
                    shiftOptions = shiftOptions.concat(shiftsResponse.data.map(shift => ({
                                     shiftID: shift.shiftID,
                            shiftName: shift.shiftName
                    })));
                }

                shiftDropdown.dxSelectBox({
                    dataSource: shiftOptions,
                    displayExpr: "shiftName",
                       valueExpr: "shiftID",
                        value: 0,
                    width: 200
                });

                goButton.dxButton({
                    text: "Go",
                    type: "default",
                    width: 60,
                    onClick: async function() {
                        const selectedShiftId = shiftDropdown.dxSelectBox("option", "value");
                        const newResponse = await fetchTodaysAttendance(BranchId, selectedShiftId);

                        if (newResponse.isSuccess && newResponse.data) {
                            currentData = newResponse.data;
                            updateGridAndChart(currentData);
                        } else {
                            alert("No data found for selected shift.");
                        }
                    }
                });

                // Grid and chart update function
                function updateGridAndChart(data) {
                    // Update grid
                    gridContainer.dxDataGrid({
                        dataSource: data,
                        columns: [
                            { dataField: "employeeCode", caption: "Emp Code", width: 120, alignment: "left" },
                            { dataField: "fullName", caption: "Emp Name", width: 250, alignment: "left" },
                            { dataField: "employeeTypeName", caption: "Emp Status", width: 150, alignment: "center" },
                            {
                                dataField: "attendanceStatus",
                                caption: "Status",
                                width: 100,
                                alignment: "center",
                                cellTemplate: function(container, options) {
                                    const status = options.value;
                                    let color, text;
                                    switch(status) {
                                        case "P": color = "blue"; text = "P"; break;
                                        case "A": color = "red"; text = "A"; break;
                                        case "L": color = "orange"; text = "L"; break;
                                        case "OD": color = "teal"; text = "OD"; break;
                                        case "H": color = "green"; text = "H"; break;
                                        case "W": color = "purple"; text = "W"; break;
                                        case "LWP": color = "orange"; text = "LWP"; break;
                                        default: color = "black"; text = status; break;
                                    }
                                    $("<div>")
                                        .text(text)
                                        .css({
                                            "color": color,
                                            "font-weight": "bold"
                                        })
                                        .appendTo(container);
                                }
                            }
                        ],
                        showBorders: true,
                        columnAutoWidth: false,
                        width: "100%",
                        height: 280,
                        scrolling: {
                            mode: "virtual"
                        },
                        paging: { enabled: false },
                        export: {
                            enabled: true,
                            formats: ['xlsx'],
                            fileName: `Attendance_${BranchName}_${new Date().toISOString().split('T')[0]}`
                        }
                    });

                    // Calculate summary data
                    const summary = calculateSummary(data);
                    
                    // Update summary
                    summaryContainer.empty();
                    $("<span>").text(`Present : ${summary.present}`).css("color", "#1f77b4").appendTo(summaryContainer);
                    $("<span>").text(`On Duty : ${summary.onDuty}`).css("color", "#2ca02c").appendTo(summaryContainer);
                    $("<span>").text(`Leave : ${summary.leave}`).css("color", "#ff7f0e").appendTo(summaryContainer);
                    $("<span>").text(`Week Off : ${summary.weekOff}`).css("color", "#9467bd").appendTo(summaryContainer);
                    $("<span>").text(`Absent : ${summary.absent}`).css("color", "#d62728").appendTo(summaryContainer);
                    $("<span>").text(`Total : ${data.length}`).css("color", "#333").appendTo(summaryContainer);

                    // Update legend
                    legendContainer.empty();
                    const legendItems = [
                        { text: "PRESENT", color: "#1f77b4" },
                        { text: "ABSENT", color: "#d62728" },
                        { text: "LEAVE", color: "#ff7f0e" },
                        { text: "OD", color: "#2ca02c" },
                        { text: "WO", color: "#9467bd" }
                    ];
                    
                    legendItems.forEach(item => {
                        const legendItem = $("<div>").css({
                            "display": "flex",
                            "align-items": "center",
                            "gap": "5px"
                        });
                        
                        $("<div>").css({
                            "width": "15px",
                            "height": "15px",
                            "background-color": item.color,
                            "display": "inline-block"
                        }).appendTo(legendItem);
                        
                        $("<span>").text(item.text).css({
                            "font-size": "12px",
                            "font-weight": "bold"
                        }).appendTo(legendItem);
                        
                        legendItem.appendTo(legendContainer);
                    });

                    // Update doughnut chart
                    const chartData = getChartDataForDoughnut(data);
                    chartDiv.dxPieChart({
                        dataSource: chartData,
                        series: [{
                            argumentField: "status",
                            valueField: "count",
                            colorField: "color"
                        }],
                        innerRadius: 0.6, // Makes it a doughnut chart
                        legend: { visible: false },
                        tooltip: {
                            enabled: true,
                            customizeTooltip: function(arg) {
                                return {
                                    text: `${arg.argumentText}: ${arg.valueText}`
                                };
                            }
                        }
                    });
                }

                // Calculate summary function
                function calculateSummary(data) {
                    const summary = {
                        present: 0,
                        absent: 0,
                        leave: 0,
                        onDuty: 0,
                        weekOff: 0,
                        holiday: 0,
                        lwp: 0
                    };

                    data.forEach(item => {
                        switch(item.attendanceStatus) {
                            case "P": summary.present++; break;
                            case "A": summary.absent++; break;
                            case "L": summary.leave++; break;
                            case "OD": summary.onDuty++; break;
                            case "W": summary.weekOff++; break;
                            case "H": summary.holiday++; break;
                            case "LWP": summary.lwp++; break;
                        }
                    });

                    return summary;
                }

                // Chart data for doughnut
                function getChartDataForDoughnut(data) {
                    const summary = calculateSummary(data);
                    const chartData = [];

                    if (summary.present > 0) {
                        chartData.push({ status: "Present", count: summary.present, color: "#1f77b4" });
                    }
                    if (summary.absent > 0) {
                        chartData.push({ status: "Absent", count: summary.absent, color: "#d62728" });
                    }
                    if (summary.leave > 0) {
                        chartData.push({ status: "Leave", count: summary.leave, color: "#ff7f0e" });
                    }
                    if (summary.onDuty > 0) {
                        chartData.push({ status: "On Duty", count: summary.onDuty, color: "#2ca02c" });
                    }
                    if (summary.weekOff > 0) {
                        chartData.push({ status: "Week Off", count: summary.weekOff, color: "#9467bd" });
                    }

                    return chartData;
                }

                updateGridAndChart(currentData);
                return mainContainer;
            },
            toolbarItems: [
                {
                    toolbar: "top",
                    location: "after",
                    widget: "dxButton",
                    options: {
                        text: "Print",
                        onClick: function() {
                            window.print();
                        }
                    }
                },
                {
                    toolbar: "top",
                    location: "after",
                    widget: "dxButton",
                    options: {
                        text: "Close",
                        type: "danger",
                        onClick: function() {
                            popup.hide();
                        }
                    }
                }
            ]
        }).dxPopup("instance");

        popup.show();
    } else {
        alert("No attendance data found for this branch.");
    }
}  
// Enhanced manual export function
    function exportToExcel(data, branchName) {
        try {
            // Create workbook and worksheet
            const workbook = XLSX.utils.book_new();

            // Prepare data for Excel
            const excelData = data.map(item => ({
                'Emp Code': item.employeeCode,
                'Emp Name': item.fullName,
                'Emp Status': item.employeeTypeName,
                'Status': getStatusText(item.attendanceStatus)
            }));

            // Create worksheet
            const worksheet = XLSX.utils.json_to_sheet(excelData);

            // Set column widths
            const columnWidths = [
                { wch: 15 }, // Emp Code
                { wch: 30 }, // Emp Name
                { wch: 15 }, // Emp Status
                { wch: 15 }  // Status
            ];
            worksheet['!cols'] = columnWidths;

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Attendance');

            // Generate filename with current date
            const currentDate = new Date().toISOString().split('T')[0];
            const filename = `Attendance_${branchName}_${currentDate}.xlsx`;

            // Save file
            XLSX.writeFile(workbook, filename);
        } catch (error) {
            console.error("Error exporting to Excel:", error);
            alert("Error exporting to Excel. Please try again.");
        }
    }

    // Helper function to get status text
    function getStatusText(status) {
        const statusMap = {
            'P': 'Present',
            'A': 'Absent',
            'L': 'Leave',
            'OD': 'On Duty',
            'W': 'Week Off',
            'H': 'Holiday',
            'LWP': 'LWP'
        };
        return statusMap[status] || status;
    }
    // Placeholder functions for other tabs
    function loadBirthdayAnniversaryData() {
        console.log('Loading Birthday & Anniversary data...');
    }

    function loadEventsData() {
        console.log('Loading Events data...');
    }

    function loadMessageBoardData() {
        console.log('Loading Message Board data...');
    }

    function loadNewJoiningData() {
        console.log('Loading New Joining data...');
    }

    function loadWallOfFameData() {
        console.log('Loading Wall of Fame data...');
    }

    // Function to load all dashboard counts
    function LoadDashboardCounts() {
        LoadLeaveApplicationCount();
        LoadAttendanceRegularizationCount();
        LoadCompApplicationCount();
        LoadMobileUsersCount();
    }

    function LoadLeaveApplicationCount() {
        const payload = {
            SearchType: '',
            SearchFor: '',
            BranchId: '0',
            CompId: CompanyId
        };

        $.ajax({
            url: '@baseDomainUrl/api/LeaveApplication/GetLeaveApplicationsforApproveAdmin',
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (data) {
                if (data.isSuccess && data.data) {
                    const count = data.data.length;
                    $('#leaveCount').text(`(${count})`);

                    if (count > 0) {
                        $('#leaveCount').removeClass('red-count').addClass('red-count');
                    } else {
                        $('#leaveCount').removeClass('red-count');
                    }
                }
            },
            error: function () {
                console.error("Error loading leave application count");
                $('#leaveCount').text('(0)');
            }
        });
    }

    function LoadCompApplicationCount() {
        const payload = {
            SearchType: null,
            SearchFor: null,
            CompId: CompanyId,
            BranchId: null,
            ApplicationStatus: 'Pending'
        };

        $.ajax({
            url: '@baseDomainUrl/api/CompOffAPI/GetCompOffDetailsReportForAdmin',
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (data) {
                if (data.isSuccess && data.data) {
                    const count = data.data.length;
                    $('#compoffCount').text(`(${count})`);

                    if (count > 0) {
                        $('#compoffCount').removeClass('red-count').addClass('red-count');
                    } else {
                        $('#compoffCount').removeClass('red-count');
                    }
                }
            },
            error: function () {
                console.error("Error loading comp off application count");
                $('#compoffCount').text('(0)');
            }
        });
    }

    function LoadAttendanceRegularizationCount() {
        $.ajax({
            url: '@baseDomainUrl/api/AttendanceRegularization/GetPendingCount/' + CompanyId,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (data) {
                if (data.isSuccess) {
                    const count = data.data || 0;
                    $('#attendanceRegCount').text(`(${count})`);

                    if (count > 0) {
                        $('#attendanceRegCount').addClass('red-count');
                    }
                }
            },
            error: function () {
                console.error("Error loading attendance regularization count");
                $('#attendanceRegCount').text('(0)');
            }
        });
    }

    function LoadActiveUsersCount() {
        $.ajax({
            url: '@baseDomainUrl/api/Users/GetActiveInactiveCount/' + CompanyId,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (data) {
                if (data.isSuccess) {
                    const inactiveCount = data.data.inactiveCount || 0;
                    $('#activeUsersCount').text(`(${inactiveCount})`);

                    if (inactiveCount > 0) {
                        $('#activeUsersCount').addClass('red-count');
                    }
                }
            },
            error: function () {
                console.error("Error loading active users count");
                $('#activeUsersCount').text('(0)');
            }
        });
    }

    function LoadMobileUsersCount() {
        $.ajax({
            url: '@baseDomainUrl/api/Users/GetMobileUsersCount/' + CompanyId,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (data) {
                if (data.isSuccess) {
                    const count = data.data || 0;
                    $('#mobileUsersCount').text(`(${count})`);

                    if (count > 0) {
                        $('#mobileUsersCount').addClass('red-count');
                    }
                }
            },
            error: function () {
                console.error("Error loading mobile users count");
                $('#mobileUsersCount').text('(0)');
            }
        });
    }

    // Auto-refresh counts every 5 minutes
    setInterval(function() {
        LoadDashboardCounts();
    }, 300000); // 5 minutes = 300,000 milliseconds

    function BranchData() {
        $('#grid-loader').addClass('d-flex').show();
        $.ajax({
            type: "GET",
            url: '@baseDomainUrl/api/BranchAPI/GetBranchWiseEmpCount/' + CompanyId,
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (data) {
                if (data.isSuccess && data.data.length > 0) {
                    $("#employeeGrid").dxDataGrid({
                        dataSource: data.data,
                        columns: [
                            { dataField: 'branchName', caption: 'Branch', alignment: 'center' },
                            { dataField: 'totalUsers', caption: 'Total', alignment: 'center' },
                            { dataField: 'joinLastMonth', caption: 'Join (Last Month)', alignment: 'center' },
                            { dataField: 'leftLastMonth', caption: 'Left (Last Month)', alignment: 'center' }
                        ],
                        showBorders: true,
                        columnAutoWidth: true,
                        height: 250,
                        scrolling: {
                            mode: "virtual",
                            useNative: false
                        },
                        filterRow: { visible: false, aplyFilter: "auto" },
                        headerFilter: { visible: false },
                        groupPanel: { visible: false },
                        summary: {
                            totalItems: [
                                { column: "branchName", summaryType: "count", displayFormat: "Total" },
                                { column: "totalUsers", summaryType: "sum" },
                                { column: "joinLastMonth", summaryType: "sum" },
                                { column: "leftLastMonth", summaryType: "sum" }
                            ]
                        },
                        onContentReady(e) {
                            $('#grid-loader').removeClass('d-flex').hide()
                            const totalRecords = e.component.option("dataSource").length;
                        }
                    });
                } else {
                    round_error_noti("No record found!");
                    $('#grid-loader').removeClass('d-flex').hide()
                }
            },
            error: function (xhr, status, error) {
                $('#grid-loader').removeClass('d-flex').hide()
                console.error("AJAX Error: ", error);
            }
        });
    }
</script>
@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}

<div style="min-height: 600px;">
    <div class="container-fluid">
        <div class="row">
            <!-- Left Content -->
            <div class="col-lg-9">
                <div class="row">
                    <!-- Row 1 -->
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Application Status</div>
                            <div class="dashboard-body">
                                <a href="/EmployeePanel/Leave/AdminLeaveApproval" class="dashboard-link" id="leaveApplicationLink">
                                    Leave Application <span class="red-count" id="leaveCount">(0)</span>
                                </a>
                                <a href="#" class="dashboard-link">Leave Cancellation <span class="red-count" id="leaveCancellationCount">(0)</span></a>
                                <a href="/AdminPanel/DashboardReport/CompOffApprovalApplicationAdmin" class="dashboard-link" id="compApplicationLink">
                                    Comp Off Application <span class="red-count" id="compoffCount">(0)</span>
                                </a>
                                <a href="#" class="dashboard-link">Pre Comp Off Application <span class="red-count" id="preCompOffCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Loan Application <span class="red-count" id="loanCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Claim Application <span class="red-count" id="claimCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Attendance Regularization <span class="red-count" id="attendanceRegCount">(0)</span></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Quick Data</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Yearly Holiday</a>
                                <a href="#" class="dashboard-link">Company Consolidate Info</a>
                                <a href="#" class="dashboard-link">Active/InActive Users <span class="red-count" id="activeUsersCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Active/InActive Mobile Users <span class="red-count" id="mobileUsersCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Allowance/Reim Application <span class="red-count" id="allowanceCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Scheme Not Assigned</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Graphics Report</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Leave Reports</a>
                                <a href="#" class="dashboard-link">View Message</a>
                                <a href="#" class="dashboard-link">Yearly Salary</a>
                                <a href="#" class="dashboard-link">WhosOff</a>
                                <a href="#" class="dashboard-link">View Graphical Report</a>
                                <a href="#" class="dashboard-link">Continues Absent</a>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Other Details</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Insurance Reminder <span class="red-count" id="insuranceCount">(0)</span></a>
                                <a href="#" class="dashboard-link">IT Declaration History</a>
                                <a href="#" class="dashboard-link">Survey</a>
                                <a href="#" class="dashboard-link">Today's Attendance</a>
                                <a href="#" class="dashboard-link">Compoff Lapse Reminder</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Deputation/Contract</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Deputation Over <span class="red-count" id="deputationCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Contract Over <span class="red-count" id="contractCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Probation/Trainee Over <span class="red-count" id="probationCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Retirement Over <span class="red-count" id="retirementCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Document Expiry Reminder</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Leave Data</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Leave/OD Status</a>
                                <a href="#" class="dashboard-link">Leave Carry Forward</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grid Below All Cards -->
                <div class="dashboard-grid-container">
                    <div class="dashboard-header">Employees Detail</div>

                    <div class="grid-wrapper " style="position: relative; ">
                        <div id="grid-loader" class="grid-loader justify-content-center align-items-center flex-column "
                             style="display: none;  inset: 0; background: rgba(255,255,255,0.6); z-index: 10; ">
                            <img src="@baseDomainUrl/loders/loder.png" class="grid-logo-spinner" style="width: 30px;                                            height: 30px; animation: spin 1s linear infinite;" />
                            <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>

                        </div>
                        <div id="gridTag">
                            <div class="rowCount" id="rowCountEmployee"></div>
                            <div id="employeeGrid" class="p-2"></div>
                        </div>
                        <div id="noRecord" style="display:none;">
                            No Record Found!
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="col-lg-3 mt-2">
                <div class="panel-wrapper position-relative">
                    <div class="side-panel">
                        <!-- Tab Headers -->
                        <a href="#" class="tab-item active" data-tab="todaysAttendance">Today's Attendance</a>

                        <!-- Tab Content for Today's Attendance -->
                        <div id="todaysAttendanceContent" class="tab-content" style="display: block;">
                            <div id="tab-loader" class="text-center" style="display: none;">
                                <img src="@baseDomainUrl/loders/loder.png" style="width: 20px; height: 20px; animation: spin 1s linear infinite;" />
                                <div>Loading...</div>
                            </div>
                            <div id="attendanceGrid" class="mt-2"></div>
                        </div>

                        <a href="#" class="tab-item" data-tab="birthdayAnniversary">Birthday & Anniversary Reminder</a>

                        <!-- Tab Content for Birthday & Anniversary -->
                        <div id="birthdayAnniversaryContent" class="tab-content" style="display: none;">
                            <div class="tab-content-header">Birthday & Anniversary</div>
                            <div class="tab-placeholder">
                                <p>Birthday and Anniversary details will be displayed here</p>
                                <!-- Add your birthday/anniversary content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="addViewEvents">Add & View Events</a>

                        <!-- Tab Content for Add & View Events -->
                        <div id="addViewEventsContent" class="tab-content" style="display: none;">
                            <div class="tab-content-header">Events</div>
                            <div class="tab-placeholder">
                                <p>Events will be displayed here</p>
                                <!-- Add your events content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="messageBoard">Message Board</a>

                        <!-- Tab Content for Message Board -->
                        <div id="messageBoardContent" class="tab-content" style="display: none;">
                            <div class="tab-content-header">Message Board</div>
                            <div class="tab-placeholder">
                                <p>Messages will be displayed here</p>
                                <!-- Add your message board content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="newJoining">New Joining Details</a>

                        <!-- Tab Content for New Joining -->
                        <div id="newJoiningContent" class="tab-content" style="display: none;">
                            <div class="tab-content-header">New Joining Details</div>
                            <div class="tab-placeholder">
                                <p>New joining details will be displayed here</p>
                                <!-- Add your new joining content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="wallOfFame">Wall Of Fame</a>

                        <!-- Tab Content for Wall Of Fame -->
                        <div id="wallOfFameContent" class="tab-content" style="display: none;">
                            <div class="tab-content-header">Wall Of Fame</div>
                            <div class="tab-placeholder">
                                <p>Wall of Fame content will be displayed here</p>
                                <!-- Add your wall of fame content here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add CSS for tab functionality -->
<style>
    .side-panel {
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
    }

    .tab-item {
        display: block;
        padding: 12px 15px;
        color: white;
        text-decoration: none;
        border-bottom: 1px solid #2c3a57;
        transition: all 0.3s ease;
        cursor: pointer;
        background-color: #2c3a57;
    }

        .tab-item:hover {
            background-color: #3d4b6a;
            color: white;
            text-decoration: none;
        }

        .tab-item.active {
            background-color: #9ca3af;
            color: #1f2937;
            font-weight: 500;
        }

    .tab-content {
        background: white;
        border: 1px solid #dee2e6;
        border-top: none;
        padding: 15px;
        margin-bottom: 0;
    }

    .tab-content-header {
        font-weight: 600;
        color: #495057;
        padding-bottom: 8px;
        margin-bottom: 15px;
    }

    .tab-placeholder {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 20px;
    }

    .tab-content .dxDataGrid {
        font-size: 12px;
    }

        .tab-content .dxDataGrid .dx-datagrid-headers {
            font-size: 11px;
        }
</style>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const Token = localStorage.getItem("authToken");
    const userId = localStorage.getItem("EmployeeId");
    const companyDetails = JSON.parse(localStorage.getItem('selectedCompany'));
    const CompanyId = companyDetails.CompanyId;

    $(document).ready(function(){
        BranchData();
        LoadDashboardCounts();
        initializeTabs(); // Initialize tab functionality

        $('#leaveCount').text('(.)');
        $('#compoffCount').text('(.)');
    });

    // Tab functionality
    function initializeTabs() {
        $('.tab-item').on('click', function(e) {
            e.preventDefault();

            const tabId = $(this).data('tab');

            // Remove active class from all tabs
            $('.tab-item').removeClass('active');

            // Hide all tab contents
            $('.tab-content').slideUp(300);

            // Add active class to clicked tab
            $(this).addClass('active');

            // Show corresponding content
            $('#' + tabId + 'Content').slideDown(300);

            // Load specific content based on tab
            loadTabContent(tabId);
        });
    }

    // Load content for specific tabs
    function loadTabContent(tabId) {
        switch(tabId) {
            case 'todaysAttendance':
                loadTodaysAttendanceData();
                break;
            case 'birthdayAnniversary':
                loadBirthdayAnniversaryData();
                break;
            case 'addViewEvents':
                loadEventsData();
                break;
            case 'messageBoard':
                loadMessageBoardData();
                break;
            case 'newJoining':
                loadNewJoiningData();
                break;
            case 'wallOfFame':
                loadWallOfFameData();
                break;
        }
    }

    // Load Today's Attendance Data
    function loadTodaysAttendanceData() {
        $('#tab-loader').show();

        $.ajax({
            type: "GET",
            url: '@baseDomainUrl/api/BranchAPI/GetAllBranchesListByCompanyId/' + CompanyId,
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (data) {
                $('#tab-loader').hide();

                if (data.isSuccess && data.data.length > 0) {
                    $("#attendanceGrid").dxDataGrid({
                        dataSource: data.data,
                        columns: [
                            { dataField: 'branchName' },                 
                        ],
                        showBorders: true,
                        columnAutoWidth: true,
                        height: 200,
                        scrolling: {
                            mode: "virtual",
                            useNative: false
                        },
                        filterRow: { visible: false },
                        headerFilter: { visible: false },
                        groupPanel: { visible: false },
                        paging: { enabled: false }
                    });
                } else {
                    $('#attendanceGrid').html('<div class="text-center p-3">No attendance data found</div>');
                }
            },
            error: function (xhr, status, error) {
                $('#tab-loader').hide();
                $('#attendanceGrid').html('<div class="text-center p-3 text-danger">Error loading attendance data</div>');
                console.error("AJAX Error: ", error);
            }
        });
    }

    // Placeholder functions for other tabs
    function loadBirthdayAnniversaryData() {
        console.log('Loading Birthday & Anniversary data...');
    }

    function loadEventsData() {
        console.log('Loading Events data...');
    }

    function loadMessageBoardData() {
        console.log('Loading Message Board data...');
    }

    function loadNewJoiningData() {
        console.log('Loading New Joining data...');
    }

    function loadWallOfFameData() {
        console.log('Loading Wall of Fame data...');
    }

    // Function to load all dashboard counts
    function LoadDashboardCounts() {
        LoadLeaveApplicationCount();
        LoadAttendanceRegularizationCount();
        LoadCompApplicationCount();
        LoadMobileUsersCount();
    }

    function LoadLeaveApplicationCount() {
        const payload = {
            SearchType: '',
            SearchFor: '',
            BranchId: '0',
            CompId: CompanyId
        };

        $.ajax({
            url: '@baseDomainUrl/api/LeaveApplication/GetLeaveApplicationsforApproveAdmin',
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (data) {
                if (data.isSuccess && data.data) {
                    const count = data.data.length;
                    $('#leaveCount').text(`(${count})`);

                    if (count > 0) {
                        $('#leaveCount').removeClass('red-count').addClass('red-count');
                    } else {
                        $('#leaveCount').removeClass('red-count');
                    }
                }
            },
            error: function () {
                console.error("Error loading leave application count");
                $('#leaveCount').text('(0)');
            }
        });
    }

    function LoadCompApplicationCount() {
        const payload = {
            SearchType: null,
            SearchFor: null,
            CompId: CompanyId,
            BranchId: null,
            ApplicationStatus: 'Pending'
        };

        $.ajax({
            url: '@baseDomainUrl/api/CompOffAPI/GetCompOffDetailsReportForAdmin',
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (data) {
                if (data.isSuccess && data.data) {
                    const count = data.data.length;
                    $('#compoffCount').text(`(${count})`);

                    if (count > 0) {
                        $('#compoffCount').removeClass('red-count').addClass('red-count');
                    } else {
                        $('#compoffCount').removeClass('red-count');
                    }
                }
            },
            error: function () {
                console.error("Error loading comp off application count");
                $('#compoffCount').text('(0)');
            }
        });
    }

    function LoadAttendanceRegularizationCount() {
        $.ajax({
            url: '@baseDomainUrl/api/AttendanceRegularization/GetPendingCount/' + CompanyId,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (data) {
                if (data.isSuccess) {
                    const count = data.data || 0;
                    $('#attendanceRegCount').text(`(${count})`);

                    if (count > 0) {
                        $('#attendanceRegCount').addClass('red-count');
                    }
                }
            },
            error: function () {
                console.error("Error loading attendance regularization count");
                $('#attendanceRegCount').text('(0)');
            }
        });
    }

    function LoadActiveUsersCount() {
        $.ajax({
            url: '@baseDomainUrl/api/Users/GetActiveInactiveCount/' + CompanyId,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (data) {
                if (data.isSuccess) {
                    const inactiveCount = data.data.inactiveCount || 0;
                    $('#activeUsersCount').text(`(${inactiveCount})`);

                    if (inactiveCount > 0) {
                        $('#activeUsersCount').addClass('red-count');
                    }
                }
            },
            error: function () {
                console.error("Error loading active users count");
                $('#activeUsersCount').text('(0)');
            }
        });
    }

    function LoadMobileUsersCount() {
        $.ajax({
            url: '@baseDomainUrl/api/Users/GetMobileUsersCount/' + CompanyId,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (data) {
                if (data.isSuccess) {
                    const count = data.data || 0;
                    $('#mobileUsersCount').text(`(${count})`);

                    if (count > 0) {
                        $('#mobileUsersCount').addClass('red-count');
                    }
                }
            },
            error: function () {
                console.error("Error loading mobile users count");
                $('#mobileUsersCount').text('(0)');
            }
        });
    }

    // Auto-refresh counts every 5 minutes
    setInterval(function() {
        LoadDashboardCounts();
    }, 300000); // 5 minutes = 300,000 milliseconds

    function BranchData() {
        $('#grid-loader').addClass('d-flex').show();
        $.ajax({
            type: "GET",
            url: '@baseDomainUrl/api/BranchAPI/GetBranchWiseEmpCount/' + CompanyId,
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (data) {
                if (data.isSuccess && data.data.length > 0) {
                    $("#employeeGrid").dxDataGrid({
                        dataSource: data.data,
                        columns: [
                            { dataField: 'branchName', caption: 'Branch', alignment: 'center' },
                            { dataField: 'totalUsers', caption: 'Total', alignment: 'center' },
                            { dataField: 'joinLastMonth', caption: 'Join (Last Month)', alignment: 'center' },
                            { dataField: 'leftLastMonth', caption: 'Left (Last Month)', alignment: 'center' }
                        ],
                        showBorders: true,
                        columnAutoWidth: true,
                        height: 250,
                        scrolling: {
                            mode: "virtual",
                            useNative: false
                        },
                        filterRow: { visible: false, aplyFilter: "auto" },
                        headerFilter: { visible: false },
                        groupPanel: { visible: false },
                        summary: {
                            totalItems: [
                                { column: "branchName", summaryType: "count", displayFormat: "Total" },
                                { column: "totalUsers", summaryType: "sum" },
                                { column: "joinLastMonth", summaryType: "sum" },
                                { column: "leftLastMonth", summaryType: "sum" }
                            ]
                        },
                        onContentReady(e) {
                            $('#grid-loader').removeClass('d-flex').hide()
                            const totalRecords = e.component.option("dataSource").length;
                        }
                    });
                } else {
                    round_error_noti("No record found!");
                    $('#grid-loader').removeClass('d-flex').hide()
                }
            },
            error: function (xhr, status, error) {
                $('#grid-loader').removeClass('d-flex').hide()
                console.error("AJAX Error: ", error);
            }
        });
    }
</script>
@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<div style="min-height: 600px;">
    <div class="container-fluid">
        <div class="row">
            <!-- Left Content -->
            <div class="col-lg-9">
                <div class="row">
                    <!-- Row 1 -->
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Application Status</div>
                            <div class="dashboard-body">
                                <a href="/EmployeePanel/Leave/AdminLeaveApproval" class="dashboard-link" id="leaveApplicationLink">
                                    Leave Application <span class="red-count" id="leaveCount">(0)</span>
                                </a>
                                <a href="#" class="dashboard-link">Leave Cancellation <span class="red-count" id="leaveCancellationCount">(0)</span></a>
                                <a href="/AdminPanel/DashboardReport/CompOffApprovalApplicationAdmin" class="dashboard-link" id="compApplicationLink">
                                    Comp Off Application <span class="red-count" id="compoffCount">(0)</span>
                                </a>
                                <a href="#" class="dashboard-link">Pre Comp Off Application <span class="red-count" id="preCompOffCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Loan Application <span class="red-count" id="loanCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Claim Application <span class="red-count" id="claimCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Attendance Regularization <span class="red-count" id="attendanceRegCount">(0)</span></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Quick Data</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Yearly Holiday</a>
                                <a href="#" class="dashboard-link">Company Consolidate Info</a>
                                <a href="#" class="dashboard-link">Active/InActive Users <span class="red-count" id="activeUsersCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Active/InActive Mobile Users <span class="red-count" id="mobileUsersCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Allowance/Reim Application <span class="red-count" id="allowanceCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Scheme Not Assigned</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Graphics Report</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Leave Reports</a>
                                <a href="#" class="dashboard-link">View Message</a>
                                <a href="#" class="dashboard-link">Yearly Salary</a>
                                <a href="#" class="dashboard-link">WhosOff</a>
                                <a href="#" class="dashboard-link">View Graphical Report</a>
                                <a href="#" class="dashboard-link">Continues Absent</a>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Other Details</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Insurance Reminder <span class="red-count" id="insuranceCount">(0)</span></a>
                                <a href="#" class="dashboard-link">IT Declaration History</a>
                                <a href="#" class="dashboard-link">Survey</a>
                                <a href="#" class="dashboard-link">Today's Attendance</a>
                                <a href="#" class="dashboard-link">Compoff Lapse Reminder</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Deputation/Contract</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Deputation Over <span class="red-count" id="deputationCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Contract Over <span class="red-count" id="contractCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Probation/Trainee Over <span class="red-count" id="probationCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Retirement Over <span class="red-count" id="retirementCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Document Expiry Reminder</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Leave Data</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link">Leave/OD Status</a>
                                <a href="#" class="dashboard-link">Leave Carry Forward</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grid Below All Cards -->
                <div class="dashboard-grid-container">
                    <div class="dashboard-header">Employees Detail</div>

                    <div class="grid-wrapper " style="position: relative; ">
                        <div id="grid-loader" class="grid-loader justify-content-center align-items-center flex-column "
                             style="display: none;  inset: 0; background: rgba(255,255,255,0.6); z-index: 10; ">
                            <img src="@baseDomainUrl/loders/loder.png" class="grid-logo-spinner" style="width: 30px;                                            height: 30px; animation: spin 1s linear infinite;" />
                            <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>

                        </div>
                        <div id="gridTag">
                            <div class="rowCount" id="rowCountEmployee"></div>
                            <div id="employeeGrid" class="p-2"></div>
                        </div>
                        <div id="noRecord" style="display:none;">
                            No Record Found!
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="col-lg-3">
                <div class="panel-wrapper position-relative">
                    <div class="side-panel">
                        <!-- Tab Headers -->
                        <a href="#" class="tab-item active" data-tab="todaysAttendance">Today's Attendance</a>

                        <!-- Tab Content for Today's Attendance -->
                        <div id="todaysAttendanceContent" class="tab-content">
                            <div id="tab-loader" class="text-center" style="display: none;">
                                <img src="@baseDomainUrl/loders/loder.png" style="width: 20px; height: 20px; animation: spin 1s linear infinite;" />
                                <div>Loading...</div>
                            </div>
                            <div id="attendanceGrid" class=""></div>
                            <div id="attendancePopup"></div>
                        </div>

                        <a href="#" class="tab-item" data-tab="birthdayAnniversary">Birthday & Anniversary Reminder</a>

                        <!-- Tab Content for Birthday & Anniversary -->
                        <div id="birthdayAnniversaryContent" class="tab-content" style="display: none; max-height: 415px; overflow-y: auto;">
                            <div class="tab-content-header">Birthday & Anniversary</div>
                            <div class="tab-placeholder">
                                <p>Birthday and Anniversary details will be displayed here</p>
                                <!-- Add your birthday/anniversary content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="addViewEvents">Add & View Events</a>

                        <!-- Tab Content for Add & View Events -->
                        <div id="addViewEventsContent" class="tab-content" style="display: none; min-height:415px;">
                            <div class="tab-content-header">Events</div>
                            <div class="tab-placeholder">
                                <p>Events will be displayed here</p>
                                <!-- Add your events content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="messageBoard">Message Board</a>

                        <!-- Tab Content for Message Board -->
                        <div id="messageBoardContent" class="tab-content" style="display: none; min-height:415px;">
                            <div class="tab-content-header">Message Board</div>
                            <div class="tab-placeholder">
                                <p>Messages will be displayed here</p>
                                <!-- Add your message board content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="newJoining">New Joining Details</a>

                        <!-- Tab Content for New Joining -->
                        <div id="newJoiningContent" class="tab-content" style="display: none; min-height:415px;">
                            <div class="tab-content-header">New Joining Details</div>
                            <div class="tab-placeholder">
                                <p>New joining details will be displayed here</p>
                                <!-- Add your new joining content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="wallOfFame">Wall Of Fame</a>

                        <!-- Tab Content for Wall Of Fame -->
                        <div id="wallOfFameContent" class="tab-content" style="display: none; min-height:415px;">
                            <div class="tab-content-header">Wall Of Fame</div>
                            <div class="tab-placeholder">
                                <p>Wall of Fame content will be displayed here</p>
                                <!-- Add your wall of fame content here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add CSS for tab functionality -->
<style>
    /* Replace your existing CSS with these updated styles */

    .side-panel {
        background: #d1d5db;
        border-radius: 8px;
        overflow: hidden;
    }

    .tab-item {
        display: block;
        padding: 8px 15px; /* Reduced from 12px to 8px - makes heading height smaller */
        color: white;
        text-decoration: none;
        border-bottom: 1px solid #ffffff;
        transition: all 0.3s ease;
        cursor: pointer;
        background-color: #2c3a57;
        font-size: 14px; /* Slightly smaller font size */
    }

        .tab-item:hover {
            background-color: #3d4b6a;
            color: white;
            text-decoration: none;
        }

        .tab-item.active {
            background-color: #9ca3af;
            color: #1f2937;
            font-weight: 500;
        }

    .tab-content {
        background: white;
        border: 1px solid #dee2e6;
        border-top: none;
        padding: 8px;
        margin-bottom: 0;
        display: none;
        min-height: 380px; /* Increased tab content height - was not set before */
        max-height: 420px; /* Set maximum height for better control */
        overflow-y: auto; /* Add scroll if content exceeds height */
        overflow-y: hidden; /* Change from 'auto' to 'hidden' */
        overflow-x: hidden; /* Add this line */
    }

    .tab-content-header {
        font-weight: 600;
        color: #495057;
        padding-bottom: 8px;
        margin-bottom: 15px;
    }

    .tab-placeholder {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 20px;
    }

    .tab-content .dxDataGrid {
        font-size: 12px;
    }

        .tab-content .dxDataGrid .dx-datagrid-headers {
            font-size: 11px;
        }

    /* NEW: Hide the "Branch Name" header in Today's Attendance grid */
    #attendanceGrid .dx-datagrid-headers {
        display: none !important;
    }

    /* NEW: Add border to top of grid when header is hidden */
    #attendanceGrid .dx-datagrid-rowsview {
        border-top: 1px solid #ddd;
    }

    /* NEW: Increase grid height for more branches to show */
    #attendanceGrid {
        min-height: 380px !important;
        height: 400px !important; /* Set specific height for more data visibility */
    }

    .tab-content::-webkit-scrollbar {
        display: none;
    }

    #attendanceGrid::-webkit-scrollbar {
        display: none;
    }

    #profilePopup {
        position: fixed !important;
        pointer-events: none !important;
    }

    #birthdayAnniversaryContent {
        overflow-y: auto; /* Only this panel will scroll if needed */
        max-height: 420px;
    }

    .tab-content-header {
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
    }
</style>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
        const Token = localStorage.getItem("authToken");
        const userId = localStorage.getItem("EmployeeId");
        const companyDetails = JSON.parse(localStorage.getItem('selectedCompany'));
        const CompanyId = companyDetails.CompanyId;

        $(document).ready(function(){
            BranchData();
            LoadDashboardCounts();
            initializeTabs(); // Initialize tab functionality

            $('#leaveCount').text('(.)');
            $('#compoffCount').text('(.)');
        });

        function initializeTabs() {
            $('.tab-item').on('click', function(e) {
                e.preventDefault();

                const tabId = $(this).data('tab');
                const isCurrentlyActive = $(this).hasClass('active');

                // Remove active class from all tabs
                $('.tab-item').removeClass('active');

                // Hide all tab contents
                $('.tab-content').slideUp(300);

                // If the clicked tab wasn't active, make it active and show content
                if (!isCurrentlyActive) {
                    $(this).addClass('active');
                    $('#' + tabId + 'Content').slideDown(300);
                    loadTabContent(tabId);
                }
            });
        }

        // Load content for specific tabs
        function loadTabContent(tabId) {
            switch(tabId) {
                case 'todaysAttendance':
                    loadTodaysAttendanceData();
                    break;
                case 'birthdayAnniversary':
                    loadBirthdayAnniversaryData();
                    break;
                case 'addViewEvents':
                    loadEventsData();
                    break;
                case 'messageBoard':
                    loadMessageBoardData();
                    break;
                case 'newJoining':
                    loadNewJoiningData();
                    break;
                case 'wallOfFame':
                    loadWallOfFameData();
                    break;
            }
        }

            // Load Today's Attendance Data
        function loadTodaysAttendanceData() {
            $('#tab-loader').show();
            $.ajax({
                type: "GET",
                url: '@baseDomainUrl/api/BranchAPI/GetAllBranchesListByCompanyId/' + CompanyId,
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (data) {
                    $('#tab-loader').hide();
                    if (data.isSuccess && data.data.length > 0) {
                        $("#attendanceGrid").dxDataGrid({
                            dataSource: data.data,
                            columns: [
                                {
                                    dataField: "branchName",
                                    cellTemplate: function(container, options) {
                                        $("<a>")
                                            .text(options.value)
                                            .css("cursor", "pointer")
                                            .on("click", function() {
                                                showAttendancePopup(options.data.branchId, options.data.branchName);
                                            })
                                            .appendTo(container);
                                    }
                                }
                            ],
                            showBorders: true,
                            columnAutoWidth: true,
                            paging: {
                                 enabled: false
                                },
                                scrolling: {
                                    mode: "standard",
                                    useNative: true,
                                    showScrollbar: "always"
                                },
                        });
                    } else {
                        $('#attendanceGrid').html('<div class="text-center p-3">No attendance data found</div>');
                    }
                },
                error: function (xhr, status, error) {
                    $('#tab-loader').hide();
                    $('#attendanceGrid').html('<div class="text-center p-3 text-danger">Error loading attendance data</div>');
                    console.error("AJAX Error: ", error);
                }
            });
        }

            async function fetchTodaysAttendance(BranchId, ShiftMasterId) {
            try {

                const response = await $.ajax({
                    type: "GET",
                    url: `@baseDomainUrl/api/EmpAttendanceAPI/GetTodaysAttendanceAdmin?BranchId=${BranchId}&ShiftMatserId=${ShiftMasterId}`,
                    headers: {
                        'Authorization': 'Bearer ' + Token
                    }
                });
                return response;
            } catch (error) {
                console.error("Error fetching attendance data:", error);
                return { isSuccess: false, ResponseMessage: "Error fetching data" };
            }
        }


           async function fetchShiftData() {
            try {
                const response = await $.ajax({
                    type: "GET",
                    url: `@baseDomainUrl/api/ShiftMasterAPI/GetAllShifts`,
                    headers: {
                        'Authorization': 'Bearer ' + Token
                    }
                });
                return response;
            } catch (error) {
                console.error("Error fetching shift data:", error);
                return { isSuccess: false, data: [] };
            }
        }

        //Modal
        async function showAttendancePopup(BranchId, BranchName) {
            const shiftsResponse = await fetchShiftData();
            const response = await fetchTodaysAttendance(BranchId, 0);
            if (response.isSuccess && response.data) {
                let currentData = response.data;

                const popup = $("#attendancePopup").dxPopup({
                    title: "Today's Attendance Summary",
                    width: 900, // Reduced from 1000
                    height: 720, // Increased height to prevent chart cutoff
                    maxWidth: "95vw",
                    maxHeight: "90vh",
                    showTitle: true,
                    resizeEnabled: true,
                    contentTemplate: function(container) {
                        // Create main container with better spacing
                        const mainContainer = $("<div>").css({
                            "padding": "10px",
                            "height": "calc(100% - 20px)",
                            "background": "#fafafa",
                            "font-family": "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                        });

                        // Compact filter section
                        const filterContainer = $("<div>").css({
                            "padding": "8px 12px",
                            "margin-bottom": "10px",
                            "display": "flex",
                            "align-items": "center",
                            "justify-content": "flex-start",
                            "gap": "8px",
                            "background": "white",
                            "border-radius": "6px",
                            "box-shadow": "0 1px 3px rgba(0,0,0,0.1)"
                        });

                        $("<label>").text("Shift:").css({
                            "font-weight": "600",
                            "font-size": "13px",
                            "color": "#555",
                            "min-width": "40px"
                        }).appendTo(filterContainer);

                        const shiftDropdown = $("<div>").attr("id", "shiftFilterDropdown").appendTo(filterContainer);
                        const goButton = $("<div>").attr("id", "filterGoButton").appendTo(filterContainer);
                        filterContainer.appendTo(mainContainer);

                        // Summary cards section - more compact
                        const summaryContainer = $("<div>")
                            .attr("id", "attendanceSummary")
                            .css({
                                "display": "grid",
                                "grid-template-columns": "repeat(auto-fit, minmax(80px, 1fr))",
                                "gap": "8px",
                                "margin-bottom": "12px",
                                "font-size": "12px"
                            })
                            .appendTo(mainContainer);

                        // Compact grid container
                        const gridContainer = $("<div>")
                            .attr("id", "attendanceDataGrid")
                            .css({
                                "margin-bottom": "12px",
                                "height": "250px", // Reduced to make room for chart
                                "background": "white",
                                "border-radius": "6px",
                                "box-shadow": "0 1px 3px rgba(0,0,0,0.1)"
                            })
                            .appendTo(mainContainer);

                        // Chart section - side by side layout
                        const chartSection = $("<div>").css({
                            "display": "grid",
                            "grid-template-columns": "280px 1fr",
                            "gap": "12px",
                            "height": "220px",
                            "margin-top": "10px",
                            "margin-bottom": "10px"
                        });

                        // Legend container (left side)
                        const legendContainer = $("<div>").css({
                            "background": "white",
                            "border-radius": "6px",
                            "padding": "10px",
                            "box-shadow": "0 1px 3px rgba(0,0,0,0.1)",
                            "overflow": "hidden"
                        }).appendTo(chartSection);

                        const legendTitle = $("<h5>").text("Status Legend").css({
                            "margin": "0 0 8px 0",
                            "font-size": "14px",
                            "font-weight": "600",
                            "color": "#333"
                        }).appendTo(legendContainer);

                        const legendItems = $("<div>").attr("id", "legendItems").css({
                            "display": "grid",
                            "grid-template-columns": "1fr 1fr",
                            "gap": "8px",
                            "font-size": "12px"
                        }).appendTo(legendContainer);

                        // Chart container (right side)
                        const chartContainer = $("<div>").css({
                            "background": "white",
                            "border-radius": "6px",
                            "padding": "8px",
                            "display": "flex",
                            "flex-direction": "column",
                            "align-items": "center",
                            "justify-content": "center",
                            "box-shadow": "0 1px 3px rgba(0,0,0,0.1)",
                            "height": "100%"
                        }).appendTo(chartSection);

                        const chartTitle = $("<h5>").text("Distribution").css({
                            "margin": "0 0 8px 0",
                            "font-size": "14px",
                            "font-weight": "600",
                            "color": "#333"
                        }).appendTo(chartContainer);

                        const chartDiv = $("<div>")
                            .attr("id", "attendanceChart")
                            .css({
                                "height": "170px",
                                "width": "170px",
                                "margin": "0 auto",
                                "flex-shrink": "0"
                            })
                            .appendTo(chartContainer);

                        chartSection.appendTo(mainContainer);

                        // Initialize compact dropdown
                        let shiftOptions = [{ shiftID: 0, shiftName: "--All Shifts--" }];
                        if (shiftsResponse.isSuccess && shiftsResponse.data) {
                            shiftOptions = shiftOptions.concat(shiftsResponse.data.map(shift => ({
                                shiftID: shift.shiftID,
                                shiftName: shift.shiftName
                            })));
                        }

                        shiftDropdown.dxSelectBox({
                            dataSource: shiftOptions,
                            displayExpr: "shiftName",
                            valueExpr: "shiftID",
                            value: 0,
                            width: 160,
                            height: 32
                        });

                        goButton.dxButton({
                            text: "Apply",
                            type: "default",
                            width: 80,
                            height: 34,
                            onClick: async function() {
                                const selectedShiftId = shiftDropdown.dxSelectBox("option", "value");
                                const newResponse = await fetchTodaysAttendance(BranchId, selectedShiftId);

                                if (newResponse.isSuccess && newResponse.data) {
                                    currentData = newResponse.data;
                                    updateGridAndChart(currentData);
                                } else {
                                    DevExpress.ui.notify("No data found for selected shift.", "warning", 2000);
                                }
                            }
                        });

                        // Grid and chart update function
                        function updateGridAndChart(data) {
                            // Update compact grid
                            gridContainer.dxDataGrid({
                                dataSource: data,
                                columns: [
                                    {
                                        dataField: "employeeCode",
                                        caption: "Code",
                                        width: 100,
                                        alignment: "center"
                                    },
                                    {
                                        dataField: "fullName",
                                        caption: "Employee Name",
                                        minWidth: 200,
                                        alignment: "left"
                                    },
                                    {
                                        dataField: "employeeTypeName",
                                        caption: "Type",
                                        width: 100,
                                        alignment: "center"
                                    },
                                    {
                                        dataField: "attendanceStatus",
                                        caption: "Status",
                                        width: 100,
                                        alignment: "center",
                                        cellTemplate: function(container, options) {
                                            const status = options.value;
                                            let color, text, bgColor;
                                            switch(status) {
                                                case "P": color = "white"; bgColor = "#1f77b4"; text = "P"; break;
                                                case "A": color = "white"; bgColor = "#d62728"; text = "A"; break;
                                                case "L": color = "white"; bgColor = "#ff7f0e"; text = "L"; break;
                                                case "OD": color = "white"; bgColor = "#2ca02c"; text = "OD"; break;
                                                case "H": color = "white"; bgColor = "#17a2b8"; text = "H"; break;
                                                case "W": color = "white"; bgColor = "#9467bd"; text = "W"; break;
                                                case "LWP": color = "white"; bgColor = "#ff6b35"; text = "LWP"; break;
                                                default: color = "white"; bgColor = "#6c757d"; text = status; break;
                                            }
                                            $("<div>")
                                                .text(text)
                                                .css({
                                                    "color": color,
                                                    "background": bgColor,
                                                    "padding": "4px 8px",
                                                    "border-radius": "18px",
                                                    "font-weight": "600",
                                                    "font-size": "11px",
                                                    "display": "inline-block",
                                                    "min-width": "24px",
                                                    "text-align": "center",
                                                    "width": "28px",
                                                    "height": "28px",
                                                    "line-height": "20px"
                                                })
                                                .appendTo(container);
                                        }
                                    }
                                ],

                                    showBorders: true,
                                    columnAutoWidth: true,
                                    paging: {
                                        enabled: false
                                    },
                                    scrolling: {
                                        mode: "standard",
                                        useNative: true,
                                        showScrollbar: "always"
                                    },
                                    height:250,
                                paging: { enabled: false },
                                headerFilter: { visible: false },
                                export: {
                                    enabled: true,
                                    formats: ['xlsx'],
                                    fileName: `Attendance_${BranchName}_${new Date().toISOString().split('T')[0]}`
                                },
                                onToolbarPreparing: function(e) {
                                    e.toolbarOptions.items.unshift({
                                        location: "before",
                                        template: function() {
                                            return $("<div>").css({
                                                "font-weight": "600",
                                                "color": "#333",
                                                "font-size": "14px"
                                            }).text(`${BranchName} - Employee List`);
                                        }
                                    });
                                }
                            });

                            // Calculate summary data
                            const summary = calculateSummary(data);

                            // Update compact summary cards
                            summaryContainer.empty();
                            const summaryItems = [
                                { label: "Present", value: summary.present, color: "#1f77b4" },
                                { label: "Absent", value: summary.absent, color: "#d62728" },
                                { label: "Leave", value: summary.leave, color: "#ff7f0e" },
                                { label: "On Duty", value: summary.onDuty, color: "#2ca02c" },
                                { label: "Week Off", value: summary.weekOff, color: "#9467bd" },
                                { label: "Total", value: data.length, color: "#333" }
                            ];

                            summaryItems.forEach(item => {
                                const card = $("<div>").css({
                                    "background": "white",
                                    "border-radius": "6px",
                                    "padding": "8px",
                                    "text-align": "center",
                                    "box-shadow": "0 1px 3px rgba(0,0,0,0.1)",
                                    "border-left": `3px solid ${item.color}`
                                });

                                $("<div>").text(item.value).css({
                                    "font-size": "16px",
                                    "font-weight": "700",
                                    "color": item.color,
                                    "margin-bottom": "2px"
                                }).appendTo(card);

                                $("<div>").text(item.label).css({
                                    "font-size": "11px",
                                    "color": "#666",
                                    "font-weight": "500"
                                }).appendTo(card);

                                card.appendTo(summaryContainer);
                            });

                            // Update compact legend
                            legendItems.empty();
                            const legendData = [
                                { text: "PRESENT", color: "#1f77b4", short: "P" },
                                { text: "ABSENT", color: "#d62728", short: "A" },
                                { text: "LEAVE", color: "#ff7f0e", short: "L" },
                                { text: "ON DUTY", color: "#2ca02c", short: "OD" },
                                { text: "WEEK OFF", color: "#9467bd", short: "W" },
                                { text: "HOLIDAY", color: "#17a2b8", short: "H" }
                            ];

                            legendData.forEach(item => {
                                const legendItem = $("<div>").css({
                                    "display": "flex",
                                    "align-items": "center",
                                    "gap": "6px"
                                });

                                $("<div>").css({
                                    "width": "12px",
                                    "height": "12px",
                                    "background-color": item.color,
                                    "border-radius": "2px",
                                    "flex-shrink": "0"
                                }).appendTo(legendItem);

                                $("<span>").text(item.text).css({
                                    "font-size": "11px",
                                    "font-weight": "500",
                                    "color": "#555"
                                }).appendTo(legendItem);

                                legendItem.appendTo(legendItems);
                            });

                            // Update compact doughnut chart
                            const chartData = getChartDataForDoughnut(data);
                            chartDiv.dxPieChart({
                                dataSource: chartData,
                                series: [{
                                    argumentField: "status",
                                    valueField: "count",
                                    colorField: "color"
                                }],
                                innerRadius: 0.65,
                                legend: { visible: false },
                                tooltip: {
                                    enabled: true,
                                    customizeTooltip: function(arg) {
                                        return {
                                            text: `${arg.argumentText}: ${arg.valueText} (${Math.round(arg.percent)}%)`
                                        };
                                    }
                                },
                                size: {
                                    height: 170,
                                    width: 170
                                }
                            });
                        }

                        // Calculate summary function
                        function calculateSummary(data) {
                            const summary = {
                                present: 0,
                                absent: 0,
                                leave: 0,
                                onDuty: 0,
                                weekOff: 0,
                                holiday: 0,
                                lwp: 0
                            };

                            data.forEach(item => {
                                switch(item.attendanceStatus) {
                                    case "P": summary.present++; break;
                                    case "A": summary.absent++; break;
                                    case "L": summary.leave++; break;
                                    case "OD": summary.onDuty++; break;
                                    case "W": summary.weekOff++; break;
                                    case "H": summary.holiday++; break;
                                    case "LWP": summary.lwp++; break;
                                }
                            });

                            return summary;
                        }

                        // Chart data for doughnut
                        function getChartDataForDoughnut(data) {
                            const summary = calculateSummary(data);
                            const chartData = [];

                            if (summary.present > 0) {
                                chartData.push({ status: "Present", count: summary.present, color: "#1f77b4" });
                            }
                            if (summary.absent > 0) {
                                chartData.push({ status: "Absent", count: summary.absent, color: "#d62728" });
                            }
                            if (summary.leave > 0) {
                                chartData.push({ status: "Leave", count: summary.leave, color: "#ff7f0e" });
                            }
                            if (summary.onDuty > 0) {
                                chartData.push({ status: "On Duty", count: summary.onDuty, color: "#2ca02c" });
                            }
                            if (summary.weekOff > 0) {
                                chartData.push({ status: "Week Off", count: summary.weekOff, color: "#9467bd" });
                            }
                            if (summary.holiday > 0) {
                                chartData.push({ status: "Holiday", count: summary.holiday, color: "#17a2b8" });
                            }

                            return chartData;
                        }

                        updateGridAndChart(currentData);
                        return mainContainer;
                    }


                }).dxPopup("instance");

                popup.show();
            } else {
                DevExpress.ui.notify("No attendance data found for this branch.", "error", 3000);
            }
        }


    // Enhanced manual export function
        function exportToExcel(data, branchName) {
            try {
                // Create workbook and worksheet
                const workbook = XLSX.utils.book_new();

                // Prepare data for Excel
                const excelData = data.map(item => ({
                    'Emp Code': item.employeeCode,
                    'Emp Name': item.fullName,
                    'Emp Status': item.employeeTypeName,
                    'Status': getStatusText(item.attendanceStatus)
                }));

                // Create worksheet
                const worksheet = XLSX.utils.json_to_sheet(excelData);

                // Set column widths
                const columnWidths = [
                    { wch: 15 }, // Emp Code
                    { wch: 30 }, // Emp Name
                    { wch: 15 }, // Emp Status
                    { wch: 15 }  // Status
                ];
                worksheet['!cols'] = columnWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Attendance');

                // Generate filename with current date
                const currentDate = new Date().toISOString().split('T')[0];
                const filename = `Attendance_${branchName}_${currentDate}.xlsx`;

                // Save file
                XLSX.writeFile(workbook, filename);
            } catch (error) {
                console.error("Error exporting to Excel:", error);
                alert("Error exporting to Excel. Please try again.");
            }
        }

        // Helper function to get status text
        function getStatusText(status) {
            const statusMap = {
                'P': 'Present',
                'A': 'Absent',
                'L': 'Leave',
                'OD': 'On Duty',
                'W': 'Week Off',
                'H': 'Holiday',
                'LWP': 'LWP'
            };
            return statusMap[status] || status;
        }
        // Placeholder functions for other tabs
        function loadBirthdayAnniversaryData() {
            console.log('Loading Birthday & Anniversary data...');
        }

        function loadEventsData() {
            console.log('Loading Events data...');
        }

        function loadMessageBoardData() {
            console.log('Loading Message Board data...');
        }

        function loadNewJoiningData() {
            console.log('Loading New Joining data...');
        }

        function loadWallOfFameData() {
            console.log('Loading Wall of Fame data...');
        }

        // Function to load all dashboard counts
        function LoadDashboardCounts() {
            LoadLeaveApplicationCount();
            LoadCompApplicationCount();

        }

        function LoadLeaveApplicationCount() {
            const payload = {
                SearchType: '',
                SearchFor: '',
                BranchId: '0',
                CompId: CompanyId
            };

            $.ajax({
                url: '@baseDomainUrl/api/LeaveApplication/GetLeaveApplicationsforApproveAdmin',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (data) {
                    if (data.isSuccess && data.data) {
                        const count = data.data.length;
                        $('#leaveCount').text(`(${count})`);

                        if (count > 0) {
                            $('#leaveCount').removeClass('red-count').addClass('red-count');
                        } else {
                            $('#leaveCount').removeClass('red-count');
                        }
                    }
                },
                error: function () {
                    console.error("Error loading leave application count");
                    $('#leaveCount').text('(0)');
                }
            });
        }

        function LoadCompApplicationCount() {
            const payload = {
                SearchType: null,
                SearchFor: null,
                CompId: CompanyId,
                BranchId: null,
                ApplicationStatus: 'Pending'
            };

            $.ajax({
                url: '@baseDomainUrl/api/CompOffAPI/GetCompOffDetailsReportForAdmin',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (data) {
                    if (data.isSuccess && data.data) {
                        const count = data.data.length;
                        $('#compoffCount').text(`(${count})`);

                        if (count > 0) {
                            $('#compoffCount').removeClass('red-count').addClass('red-count');
                        } else {
                            $('#compoffCount').removeClass('red-count');
                        }
                    }
                },
                error: function () {
                    console.error("Error loading comp off application count");
                    $('#compoffCount').text('(0)');
                }
            });
        }


        // Auto-refresh counts every 5 minutes
        setInterval(function() {
            LoadDashboardCounts();
        }, 300000); // 5 minutes = 300,000 milliseconds




            function loadBirthdayAnniversaryData() {
            $('#birthdayAnniversaryContent').html(`
                <div id="birthday-loader" class="text-center" style="display: block;">
                    <img src="@baseDomainUrl/loders/loder.png" style="width: 20px; height: 20px; animation: spin 1s linear infinite;" />
                    <div>Loading...</div>
                </div>
                <div id="birthday-content" style="display: none;">
                    <!-- Today's Birthday Section -->
                    <div class="birthday-section">
                        <h6 style="color: #8B4513; font-weight: bold; margin-bottom: 8px; font-size: 12px;">TODAY'S BIRTHDAY</h6>
                        <div style="font-style: italic; color: #666; margin-bottom: 10px; font-size: 11px;">Relay Express Pvt Ltd ${getCurrentDate()}</div>
                        <div id="todayBirthdays"></div>
                    </div>

                    <!-- Today's Anniversary Section -->
                    <div class="anniversary-section" style="margin-top: 20px;">
                        <h6 style="color: #8B4513; font-weight: bold; margin-bottom: 8px; font-size: 12px;">TODAY'S MARRIAGE ANNIVERSARY</h6>
                        <div id="todayAnniversaries"></div>
                    </div>

                    <!-- Upcoming Birthday Section -->
                    <div class="upcoming-section" style="margin-top: 20px;">
                        <h6 style="color: #8B4513; font-weight: bold; margin-bottom: 8px; font-size: 12px;">UPCOMING BIRTHDAY</h6>
                        <div style="font-style: italic; color: #666; margin-bottom: 10px; font-size: 11px;">Relay Express Pvt Ltd</div>
                        <div id="upcomingBirthdays"></div>
                    </div>

                    <!-- Upcoming Anniversary Section -->
                    <div class="upcoming-anniversary-section" style="margin-top: 20px;">
                        <h6 style="color: #8B4513; font-weight: bold; margin-bottom: 8px; font-size: 12px;">UPCOMING MARRIAGE ANNIVERSARY</h6>
                        <div id="upcomingAnniversaries"></div>
                    </div>
                </div>
            `);

            // Load birthday data
            $.ajax({
                url: '@baseDomainUrl/api/EmployeeDashBoardAPI/GetTodayBirthdaysByCompany?Compid=' + CompanyId,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (response) {
                    if (response.isSuccess && response.data && response.data.length > 0) {
                                console.log('response' ,response);
                        displayBirthdayData(response.data);
                    } else {
                        $('#todayBirthdays').html('<div style="color: #999; font-style: italic; font-size: 11px;">No birthdays today</div>');
                        $('#upcomingBirthdays').html('<div style="color: #999; font-style: italic; font-size: 11px;">No upcoming birthdays</div>');
                    }
                    loadAnniversaryData();
                },
                error: function (xhr, status, error) {
                    console.error("Error loading birthday data:", error);
                    $('#todayBirthdays').html('<div style="color: #999; font-style: italic; font-size: 11px;">No birthdays today</div>');
                    $('#upcomingBirthdays').html('<div style="color: #999; font-style: italic; font-size: 11px;">No upcoming birthdays</div>');
                    loadAnniversaryData();
                }
            });
        }

        function loadAnniversaryData() {
            // Load anniversary data using the provided API
            $.ajax({
                url: '@baseDomainUrl/api/EmployeeDashBoardAPI/GetTodayWorkAnniversary?Compid=' + CompanyId,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (response) {
                    $('#birthday-loader').hide();
                    $('#birthday-content').show();

                    if (response.isSuccess && response.data && response.data.length > 0) {
                               console.log('response' ,response);
                        displayAnniversaryData(response.data);
                    } else {
                        $('#todayAnniversaries').html('<div style="color: #999; font-style: italic; font-size: 11px;">No anniversaries today</div>');
                        $('#upcomingAnniversaries').html('<div style="color: #999; font-style: italic; font-size: 11px;">No upcoming anniversaries</div>');
                    }
                },
                error: function (xhr, status, error) {
                    $('#birthday-loader').hide();
                    $('#birthday-content').show();
                    console.error("Error loading anniversary data:", error);
                    $('#todayAnniversaries').html('<div style="color: #999; font-style: italic; font-size: 11px;">No anniversaries today</div>');
                    $('#upcomingAnniversaries').html('<div style="color: #999; font-style: italic; font-size: 11px;">No upcoming anniversaries</div>');
                }
            });
        }

        function displayBirthdayData(data) {
            const today = new Date();
            const todayBirthdays = [];
            const upcomingBirthdays = [];

            data.forEach(person => {
                const birthDate = new Date(person.date);
                const birthMonth = birthDate.getMonth();
                const birthDay = birthDate.getDate();
                const todayMonth = today.getMonth();
                const todayDay = today.getDate();

                if (birthMonth === todayMonth && birthDay === todayDay) {
                    todayBirthdays.push(person);
                } else {
                    // Only show upcoming birthdays within next 30 days
                    const thisYear = today.getFullYear();
                    const nextBirthday = new Date(thisYear, birthMonth, birthDay);
                    if (nextBirthday < today) {
                        nextBirthday.setFullYear(thisYear + 1);
                    }
                    const daysDiff = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
                    if (daysDiff <= 30) {
                        person.daysDiff = daysDiff;
                        person.nextBirthdayDate = nextBirthday;
                        upcomingBirthdays.push(person);
                    }
                }
            });

            // Display today's birthdays
            displayTodaysBirthdays(todayBirthdays);

            // Display upcoming birthdays grouped by date
            displayUpcomingBirthdays(upcomingBirthdays);
        }

        function displayAnniversaryData(data) {
            const today = new Date();
            const todayAnniversaries = [];
            const upcomingAnniversaries = [];

            data.forEach(person => {
                const anniversaryDate = new Date(person.date);
                const anniversaryMonth = anniversaryDate.getMonth();
                const anniversaryDay = anniversaryDate.getDate();
                const todayMonth = today.getMonth();
                const todayDay = today.getDate();

                if (anniversaryMonth === todayMonth && anniversaryDay === todayDay) {
                    todayAnniversaries.push(person);
                } else {
                    // Only show upcoming anniversaries within next 30 days
                    const thisYear = today.getFullYear();
                    const nextAnniversary = new Date(thisYear, anniversaryMonth, anniversaryDay);
                    if (nextAnniversary < today) {
                        nextAnniversary.setFullYear(thisYear + 1);
                    }
                    const daysDiff = Math.ceil((nextAnniversary - today) / (1000 * 60 * 60 * 24));
                    if (daysDiff <= 30) {
                        person.daysDiff = daysDiff;
                        person.nextAnniversaryDate = nextAnniversary;
                        upcomingAnniversaries.push(person);
                    }
                }
            });

            // Display today's anniversaries
            displayTodaysAnniversaries(todayAnniversaries);

            // Display upcoming anniversaries grouped by date
            displayUpcomingAnniversaries(upcomingAnniversaries);
        }

        function displayTodaysBirthdays(todayBirthdays) {
            if (todayBirthdays.length > 0) {
                let todayHtml = '';
                todayBirthdays.forEach(person => {
                    todayHtml += createPersonCard(person, 'birthday', false);
                });
                $('#todayBirthdays').html(todayHtml);
            } else {
                $('#todayBirthdays').html('<div style="color: #999; font-style: italic; font-size: 11px;">No birthdays today</div>');
            }
        }

        function displayUpcomingBirthdays(upcomingBirthdays) {
            if (upcomingBirthdays.length > 0) {
                // Sort by date
                upcomingBirthdays.sort((a, b) => new Date(a.nextBirthdayDate) - new Date(b.nextBirthdayDate));

                // Group by date
                const groupedByDate = {};
                upcomingBirthdays.forEach(person => {
                    const dateKey = person.nextBirthdayDate.toDateString();
                    if (!groupedByDate[dateKey]) {
                        groupedByDate[dateKey] = [];
                    }
                    groupedByDate[dateKey].push(person);
                });

                let upcomingHtml = '';
                Object.keys(groupedByDate).forEach(dateKey => {
                    const persons = groupedByDate[dateKey];
                    const date = persons[0].nextBirthdayDate;
                    const dateStr = `Date : ${date.getDate()}-${getMonthName(date.getMonth()).toUpperCase()}`;

                    upcomingHtml += `<div style="font-weight: bold; margin: 12px 0 5px 0; font-size: 11px; color: #333;">${dateStr}</div>`;


                    persons.forEach(person => {
                     upcomingHtml += createPersonCard(person, 'birthday', false, person.employeeProfileUrl);
                    });
                });
                $('#upcomingBirthdays').html(upcomingHtml);
            } else {
                $('#upcomingBirthdays').html('<div style="color: #999; font-style: italic; font-size: 11px;">No upcoming birthdays</div>');
            }
        }

        function displayTodaysAnniversaries(todayAnniversaries) {
            if (todayAnniversaries.length > 0) {
                let todayHtml = '';
                todayAnniversaries.forEach(person => {
                    todayHtml += createPersonCard(person, 'anniversary', false);
                });
                $('#todayAnniversaries').html(todayHtml);
            } else {
                $('#todayAnniversaries').html('<div style="color: #999; font-style: italic; font-size: 11px;">No anniversaries today</div>');
            }
        }

        function displayUpcomingAnniversaries(upcomingAnniversaries) {
            if (upcomingAnniversaries.length > 0) {
                // Sort by date
                upcomingAnniversaries.sort((a, b) => new Date(a.nextAnniversaryDate) - new Date(b.nextAnniversaryDate));

                // Group by date
                const groupedByDate = {};
                upcomingAnniversaries.forEach(person => {
                    const dateKey = person.nextAnniversaryDate.toDateString();
                    if (!groupedByDate[dateKey]) {
                        groupedByDate[dateKey] = [];
                    }
                    groupedByDate[dateKey].push(person);
                });

                let upcomingHtml = '';
                Object.keys(groupedByDate).forEach(dateKey => {
                    const persons = groupedByDate[dateKey];
                    const date = persons[0].nextAnniversaryDate;
                    const dateStr = `Date : ${date.getDate()}-${getMonthName(date.getMonth()).toUpperCase()}`;

                    upcomingHtml += `<div style="font-weight: bold; margin: 12px 0 5px 0; font-size: 11px; color: #333;">${dateStr}</div>`;

                    persons.forEach(person => {
                         upcomingHtml += createPersonCard(person, 'birthday', false, person.employeeProfileUrl);
                    });
                });
                $('#upcomingAnniversaries').html(upcomingHtml);
            } else {
                $('#upcomingAnniversaries').html('<div style="color: #999; font-style: italic; font-size: 11px;">No upcoming anniversaries</div>');
            }
        }

         function createPersonCard(person, type, showAge) {
            const age = type === 'birthday' ? (person.ageInYears || calculateAge(person.date)) : calculateWorkYears(person.date);

            return `
                <div class="person-card"
                     style="display: flex; justify-content: space-between; align-items: center; margin: 6px 0; padding: 6px 8px; background: #f8f9fa; border-radius: 4px; position: relative; font-size: 11px;"
                     onmouseenter="showProfilePopup(event, '${person.id}', '${person.fullName}', '${person.designationName || ''}', '${person.departmentName || ''}', '${person.employeeProfileUrl || ''}')"
                     onmouseleave="hideProfilePopup()">
                    <div style="flex: 1;">
                        <div style="color: #333; font-weight: 500; font-size: 11px;">${person.fullName}</div>
                        <div style="color: #666; font-size: 10px;">${person.branchName}</div>
                    </div>
                </div>
            `;
        }



        function calculateWorkYears(joiningDate) {
            const joining = new Date(joiningDate);
            const today = new Date();
            let years = today.getFullYear() - joining.getFullYear();
            const monthDiff = today.getMonth() - joining.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < joining.getDate())) {
                years--;
            }

            return years;
        }

        function getCurrentDate() {
            const today = new Date();
            const day = today.getDate();
            const month = getMonthName(today.getMonth()).toUpperCase();
            return `${day}-${month}`;
        }

        function calculateAge(dateOfBirth) {
            const birth = new Date(dateOfBirth);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }

            return age;
        }

        function getMonthName(monthIndex) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return months[monthIndex];
        }

        // Profile popup functions remain the same
        let profilePopupTimeout;

        function showProfilePopup(event, employeeId, fullName, designation, department, profileImageUrl) {
            clearTimeout(profilePopupTimeout);
            let popup = document.getElementById('profilePopup');

            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'profilePopup';
                popup.style.cssText = `
                    position: fixed;
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    padding: 10px;
                    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
                    z-index: 1000;
                    display: none;
                    min-width: 180px;
                    font-size: 11px;
                    pointer-events: none;
                `;
                document.body.appendChild(popup);
            }

            // Use the profile image if available, otherwise use a default
            let imageSrc = profileImageUrl || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNjY2MiIHN0cm9rZS13aWR0aD0iMSI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiByeD0iMCIgZmlsbD0iI2QyZDFkMSIvPjxwYXRoIGQ9Ik0xMiAxMkw4IDZMMTIgMTBMMCAxMEwxMiAxMHpNMTIgMTZMOCAxMkwxMiAxNkwwIDE2TDEyIDE2eiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==';

            popup.innerHTML = `
                <div style="text-align: center;">
                    <img src="${imageSrc}"
                         style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 8px; object-fit: cover;"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNjY2MiIHN0cm9rZS13aWR0aD0iMSI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiByeD0iMCIgZmlsbD0iI2QyZDFkMSIvPjxwYXRoIGQ9Ik0xMiAxMkw4IDZMMTIgMTBMMCAxMEwxMiAxMHpNMTIgMTZMOCAxMkwxMiAxNkwwIDE2TDEyIDE2eiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg=='"
                         alt="Profile">
                    <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${fullName}</div>
                    <div style="color: #666; font-size: 10px; margin-bottom: 2px;"><strong>Designation:</strong> ${designation}</div>
                    <div style="color: #666; font-size: 10px;"><strong>Department:</strong> ${department}</div>
                    <div style="color: #666; font-size: 10px; margin-top: 4px;"><strong>ID:</strong> ${employeeId}</div>
                </div>
            `;

            // Position the popup near the cursor
            popup.style.left = `${event.clientX + 10}px`;
            popup.style.top = `${event.clientY + 10}px`;
            popup.style.display = 'block';
        }



        function hideProfilePopup() {
            profilePopupTimeout = setTimeout(() => {
                const popup = document.getElementById('profilePopup');
                if (popup) {
                    popup.style.display = 'none';
                }
            }, 200);
        }

        function createProfilePopup() {
            const popup = document.createElement('div');
            popup.id = 'profilePopup';
            popup.style.cssText = `
                position: absolute;
                background: white;
                border: 1px solid #ddd;
                border-radius: 6px;
                padding: 10px;
                box-shadow: 0 3px 8px rgba(0,0,0,0.15);
                z-index: 1000;
                display: none;
                min-width: 180px;
                max-width: 220px;
                font-size: 11px;
            `;
            document.body.appendChild(popup);
            return popup;
        }
        function BranchData() {
            $('#grid-loader').addClass('d-flex').show();
            $.ajax({
                type: "GET",
                url: '@baseDomainUrl/api/BranchAPI/GetBranchWiseEmpCount/' + CompanyId,
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (data) {
                    if (data.isSuccess && data.data.length > 0) {
                        $("#employeeGrid").dxDataGrid({
                            dataSource: data.data,
                            columns: [
                                { dataField: 'branchName', caption: 'Branch', alignment: 'center' },
                                { dataField: 'totalUsers', caption: 'Total', alignment: 'center' },
                                { dataField: 'joinLastMonth', caption: 'Join (Last Month)', alignment: 'center' },
                                { dataField: 'leftLastMonth', caption: 'Left (Last Month)', alignment: 'center' }
                            ],
                            height: 250,
                            showBorders: true,
                            columnAutoWidth: true,
                            paging: {
                                enabled: false
                            },
                            scrolling: {
                                mode: "standard",
                                useNative: true,
                                showScrollbar: "always"
                            },
                            filterRow: { visible: false, aplyFilter: "auto" },
                            headerFilter: { visible: false },
                            groupPanel: { visible: false },
                            summary: {
                                totalItems: [
                                    { column: "branchName", summaryType: "count", displayFormat: "Total" },
                                    { column: "totalUsers", summaryType: "sum" },
                                    { column: "joinLastMonth", summaryType: "sum" },
                                    { column: "leftLastMonth", summaryType: "sum" }
                                ]
                            },
                            onContentReady(e) {
                                $('#grid-loader').removeClass('d-flex').hide()
                                const totalRecords = e.component.option("dataSource").length;
                            }
                        });
                    } else {
                        round_error_noti("No record found!");
                        $('#grid-loader').removeClass('d-flex').hide()
                    }
                },
                error: function (xhr, status, error) {
                    $('#grid-loader').removeClass('d-flex').hide()
                    console.error("AJAX Error: ", error);
                }
            });
        }
</script>
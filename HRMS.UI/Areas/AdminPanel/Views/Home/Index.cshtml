@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}
<style>

    .page-content {
        padding-left: 0px;
        padding-right: 0px;
    }
    .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header {
        background: #5a6b7d;
        color: white;
        text-align: center;
        padding: 15px;
        font-size: 18px;
        font-weight: bold;
    }

    .add-view-events {
        background: #ff9933;
        color: white;
        text-align: center;
        padding: 12px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
    }

        .add-view-events:hover {
            background: #e6851f;
        }

    .calendar-header {
        background: #E0E5E5;
        color: #000000;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
    }

    .nav-btn {
        background: none;
        border: none;
        color: #000000;
        font-size: 18px;
        cursor: pointer;
        padding: 5px;
    }

        .nav-btn:hover {
            opacity: 0.7;
        }

    .month-year {
        font-size: 16px;
        font-weight: bold;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background: white;
    }

    .day-header {
        background: #5a6b7d;
        color: white;
        text-align: center;
        padding: 10px 5px;
        font-weight: bold;
        font-size: 12px;
    }

    .day-cell {
        border: 1px solid #ddd;
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        background: white;
    }

        .day-cell:hover {
            background: #f0f0f0;
        }

        .day-cell.today {
            background: #26a0da;
            color: white;
            font-weight: bold;
        }

        .day-cell.has-event {
            background: #fffbcc;
        }

            .day-cell.has-event::after {
                content: '•';
                color: #ff6600;
                position: absolute;
                bottom: 2px;
                right: 5px;
                font-size: 16px;
            }

    .events-section {
        background: #5a6b7d;
        color: white;
        text-align: center;
        padding: 12px;
        font-weight: bold;
    }

    .events-list {
        padding: 20px;
        min-height: 150px;
        max-height: 300px;
        background: #f9f9f9;
        overflow-y: auto;
        overflow-x: hidden;
    }

        /* Scrollbar styling for events list */
        .events-list::-webkit-scrollbar {
            width: 6px;
        }

        .events-list::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }

        .events-list::-webkit-scrollbar-thumb {
            background: #5a6b7d;
            border-radius: 10px;
        }

            .events-list::-webkit-scrollbar-thumb:hover {
                background: #4a5a6b;
            }

    .no-events {
        color: #666;
        font-style: italic;
    }

    .event-item {
        background: white;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 4px;
        border-left: 4px solid #ff9933;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .event-date {
        font-weight: bold;
        color: #333;
    }

    .event-name {
        margin: 5px 0;
        color: #555;
    }

    .event-type {
        font-size: 12px;
        color: #777;
        text-transform: uppercase;
    }

  /*   
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 8px;
        width: 400px;
        max-width: 90vw;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-header {
        background: #5a6b7d;
        color: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 16px;
        font-weight: bold;
    }

    .close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
    }

    .modal-body {
        padding: 15px;
    } */

    .form-group {
        margin-bottom: 10px;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }

    .required {
        color: red;
    }

    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-textarea {
        height: 60px;
        resize: vertical;
    }

    .radio-group {
        display: flex;
        gap: 15px;
        margin-top: 10px;
    }

    .radio-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
    }

    .btn-primary {
        background: #5a6b7d;
        color: white;
    }

        .btn-primary:hover {
            background: #4a5a6b;
        }

    .btn-secondary {
        background: #999;
        color: white;
    }

        .btn-secondary:hover {
            background: #777;
        }

    .posted-events {
        background: #5a6b7d;
        color: white;
        padding: 8px 15px;
        font-weight: bold;
        font-size: 14px;
    }

    .no-record {
        padding: 12px;
        color: #666;
        font-style: italic;
        font-size: 13px;
    }

    .small-swal {
        font-size: 14px !important;
    }

        .small-swal .swal2-title {
            font-size: 18px !important;
        }

        .small-swal .swal2-content {
            font-size: 13px !important;
        }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


<div style="min-height: 600px;">
    <div class="container-fluid">
        <div class="row">
            <!-- Left Content -->
            <div class="col-lg-9">
                <div class="row">
                    <!-- Row 1 -->
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Application Status</div>
                            <div class="dashboard-body">
                                <a href="/AdminPanel/Report/AttendanceRegularization" class="dashboard-link">Attendance Regularization <span class="red-count" id="attendanceRegCount">(0)</span></a>
                                <a href="/AdminPanel/DashboardReport/CompOffApprovalApplicationAdmin" class="dashboard-link" id="compApplicationLink">Comp Off Application <span class="red-count" id="compoffCount">(0)</span></a>
@*                                 <a href="#" class="dashboard-link">Claim Application <span class="red-count" id="claimCount">(0)</span></a> *@
                                <a href="/EmployeePanel/Leave/AdminLeaveApproval" class="dashboard-link" id="leaveApplicationLink">Leave Application <span class="red-count" id="leaveCount">(0)</span></a>
                                <a href="/AdminPanel/Report/LeavecancellationRequestRepotAdmin" class="dashboard-link">Leave Cancellation<span class="red-count" id="leavecancallationCount">(0)</span></a>
@*                                 <a href="#" class="dashboard-link">Loan Application <span class="red-count" id="loanCount">(0)</span></a> *@
                            </div>
                        </div> 
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Quick Data</div>
                            <div class="dashboard-body">
                                <a href="#" class="dashboard-link" onclick="openHolidayModal(); return false;">Yearly Holiday</a>
                                <a href="/AdminPanel/Report/ActiveInActiveUsers" class="dashboard-link">Active/InActive Users <span class="red-count" id="activeUsersCount">(0)</span></a>
                                <a href="/AdminPanel/Report/ActiveInActiveMobileUsers" class="dashboard-link">Active/InActive Mobile Users <span class="red-count" id="mobileUsersCount">(0)</span></a>

@*                                 <a href="#" class="dashboard-link">Allowance/Reim Application <span class="red-count" id="allowanceCount">(0)</span></a> *@
                  @*               <a href="#" class="dashboard-link">Company Consolidate Info</a> *@
                         
                                @* <a href="#" class="dashboard-link">Scheme Not Assigned</a> *@
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Graphics Report</div>
                            <div class="dashboard-body">

                            @*     <a href="#" class="dashboard-link" onclick="openContinuousAbsentModal(); return false;">Continues Absent</a> *@
                                <a href="#" class="dashboard-link" onclick="openLeaveReportModal(); return false;">Leave Reports</a>
                             @*    <a href="#" class="dashboard-link">View Message</a> *@
                                <a href="#" class="dashboard-link" onclick="openYearlySalaryModal(); return false;">Yearly Salary </a>
                            @*     <a href="#" class="dashboard-link">View Graphical Report</a> *@
                                <a href="/AdminPanel/Report/WhosOffReport" class="dashboard-link">WhosOff</a>
                            </div>
                        </div>
                    </div>
                    <!-- Row 2 -->
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Other Details</div>
                            <div class="dashboard-body">
                                <!-- Update this line in your "Other Details" section -->
                                <a href="#" class="dashboard-link" onclick="openCompoffLapseModal(); return false;">Compoff Lapse Reminder</a>
@*                                 <a href="#" class="dashboard-link">Insurance Reminder <span class="red-count" id="insuranceCount">(0)</span></a>
                                <a href="#" class="dashboard-link">IT Declaration History</a>
                                <a href="#" class="dashboard-link">Survey</a> *@
                                <a href="/AdminPanel/DashboardReport/TodaysAttendanceForAdmin" class="dashboard-link">Today's Attendance</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Deputation/Contract</div>
                            <div class="dashboard-body">
@*                                 <a href="#" class="dashboard-link">Contract Over <span class="red-count" id="contractCount">(0)</span></a>
                                <a href="#" class="dashboard-link">Deputation Over <span class="red-count" id="deputationCount">(0)</span></a> *@
                             @*    <a href="#" class="dashboard-link">Document Expiry Reminder</a> *@
                                <a href="/AdminPanel/Report/ProbationReport" class="dashboard-link">Probation/Trainee Over <span class="red-count" id="probationCount">(0)</span></a>
                   @*              <a href="#" class="dashboard-link">Retirement Over <span class="red-count" id="retirementCount">(0)</span></a> *@
                            </div>
                        </div>   
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="dashboard-header">Leave Data</div>
                            <div class="dashboard-body">
                                <a href="/AdminPanel/Report/LeaveODReport" class="dashboard-link">Leave/OD Status</a>
              @*                   <a href="#" class="dashboard-link">Leave Carry Forward</a> *@
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Grid Below All Cards -->
                <div class="dashboard-grid-container">
                    <div class="dashboard-header">Employees Detail</div>

                    <div class="grid-wrapper " style="position: relative; ">
                        <div id="grid-loader" class="grid-loader justify-content-center align-items-center flex-column "
                             style="display: none;  inset: 0; background: rgba(255,255,255,0.6); z-index: 10; ">
                            <img src="@baseDomainUrl/loders/loder.png" class="grid-logo-spinner" style="width: 30px;  height: 30px; animation: spin 1s linear infinite;" />
                            <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>

                        </div>
                        <div id="gridTag">
                            <div class="rowCount" id="
"></div>
                            <div id="employeeGrid" class="p-2"></div>
                        </div>
                        <div id="noRecord" style="display:none;">
                            No Record Found!
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="col-lg-3">
                <div class="panel-wrapper position-relative">
                    <div class="side-panel">
                        <!-- Tab Headers -->
                        <a href="#" class="tab-item " data-tab="todaysAttendance">Today's Attendance</a>

                        <!-- Tab Content for Today's Attendance -->
                        <div id="todaysAttendanceContent" class="tab-contents">
                            <div id="tab-loader" class="text-center" style="display: none;">
                                <img src="@baseDomainUrl/loders/loder.png" style="width: 20px; height: 20px; animation: spin 1s linear infinite;" />
                                <div>Loading...</div>
                            </div>
                            <div id="attendanceGrid" class=""></div>
                            <div id="attendancePopup"></div>
                        </div>

                        <a href="#" class="tab-item" data-tab="birthdayAnniversary">Birthday & Anniversary Reminder</a>

                        <!-- Tab Content for Birthday & Anniversary -->
                        <div id="birthdayAnniversaryContent" class="tab-contents" style="display: none; max-height: 415px; overflow-y: auto;">
                            <div class="tab-contents-header">Birthday & Anniversary</div>
                            <div class="tab-placeholder">
                                <p>Birthday and Anniversary details will be displayed here</p>
                                <!-- Add your birthday/anniversary content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="addViewEvents">Add & View Events</a>

                        <!-- Tab Content for Add & View Events -->
                        <div id="addViewEventsContent" class="tab-contents" style="display: none; min-height:415px;">

                            <div class="container p-0">

                                <div class="calendar-header">
                                    <button class="nav-btn" onclick="previousMonth()">❮</button>
                                    <div class="month-year" id="monthYear"></div>
                                    <button class="nav-btn" onclick="nextMonth()">❯</button>
                                </div>

                                <div class="calendar-grid" id="calendarGrid">
                                    <!-- Calendar will be generated here -->
                                </div>

                                <div class="events-section">Events</div>

                                <div class="events-list" id="eventsList" style="max-height: 300px; overflow-y: auto; overflow-x: hidden;">
                                    <div class="no-events">No Event Today</div>
                                    <div class="no-events">No Upcoming Event</div>
                                </div>
                            </div>

                        </div>

                        <a href="#" class="tab-item" data-tab="messageBoard">Message Board</a>

                        <!-- Tab Content for Message Board -->
                        <div id="messageBoardContent" class="tab-contents" style="display: none; min-height:415px;">
                            <div class="tab-contents-header">Message Board</div>
                            <div class="tab-placeholder">
                                <p>Messages will be displayed here</p>
                                <!-- Add your message board content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="newJoining">New Joining Details</a>

                        <!-- Tab Content for New Joining -->
                        <div id="newJoiningContent" class="tab-contents" style="display: none; min-height:415px;">
                            <div class="tab-contents-header">New Joining Details</div>
                            <div class="tab-placeholder">
                                <p>New joining details will be displayed here</p>
                                <!-- Add your new joining content here -->
                            </div>
                        </div>

                        <a href="#" class="tab-item" data-tab="wallOfFame">Wall Of Fame</a>

                        <!-- Tab Content for Wall Of Fame -->
                        <div id="wallOfFameContent" class="tab-contents" style="display: none; min-height:415px;">
                            <div class="tab-contents-header">Wall Of Fame</div>
                            <div class="tab-placeholder">
                                <p>Wall of Fame content will be displayed here</p>
                                <!-- Add your wall of fame content here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add CSS for tab functionality -->
<style>
    /* Replace your existing CSS with these updated styles */

    .side-panel {
        background: #d1d5db;
        border-radius: 8px;
        overflow: hidden;
    }

    .tab-item {
        display: block;
        padding: 8px 15px;
        color: white;
        text-decoration: none;
        border-bottom: 1px solid #ffffff;
        transition: all 0.3s ease;
        cursor: pointer;
        background-color: #2c3a57;
        font-size: 14px; 
    }

        .tab-item:hover {
            background-color: #3d4b6a;
            color: white;
            text-decoration: none;
        }

        .tab-item.active {
            background-color: #9ca3af;
            color: #1f2937;
            font-weight: 500;
        }

    .tab-contents {
        background: white;
        border: 1px solid #dee2e6;
        border-top: none;
        padding: 8px;
        margin-bottom: 0;
        display: none;
        min-height: 380px; 
        max-height: 420px; 
        overflow-y: auto; 
        overflow-y: hidden; 
        overflow-x: hidden; 
    }

    .tab-contents-header {
        font-weight: 600;
        color: #495057;
        padding-bottom: 8px;
        margin-bottom: 15px;
    }

    .tab-placeholder {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 20px;
    }

    .tab-contents .dxDataGrid {
        font-size: 12px;
    }

        .tab-contents .dxDataGrid .dx-datagrid-headers {
            font-size: 11px;
        }
 
    /* NEW: Hide the "Branch Name" header in Today's Attendance grid */
    #attendanceGrid .dx-datagrid-headers {
        display: none !important;
    }

    /* NEW: Add border to top of grid when header is hidden */
    #attendanceGrid .dx-datagrid-rowsview {
        border-top: 1px solid #ddd;
    }

    /* NEW: Increase grid height for more branches to show */
    #attendanceGrid {
        min-height: 380px !important;
        height: 400px !important; /* Set specific height for more data visibility */
    }

    .tab-contents::-webkit-scrollbar {
        display: none;
    }

    #attendanceGrid::-webkit-scrollbar {
        display: none;
    }

    #profilePopup {
        position: fixed !important;
        pointer-events: none !important;
    }

    #birthdayAnniversaryContent {
        overflow-y: auto; /* Only this panel will scroll if needed */
        max-height: 420px;
    }

    #newJoiningContent {
        overflow-y: auto !important; /* Enable scrolling for new joining tab */
        max-height: 420px; /* Same height as birthday tab */
        overflow-x: hidden; /* Hide horizontal scroll */
    }

    .tab-contents-header {
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
    }

    .dx-button.green-export-btn {
        background-color: #28a745 !important;
        border-color: #28a745 !important;
        color: white !important;
    }

        .dx-button.green-export-btn:hover {
            background-color: #218838 !important;
            border-color: #1e7e34 !important;
        }


    #employeeDetailsPopup .dx-datagrid {
        margin: 10px;
    }

    #grid-loader {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.2);
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    /* Salary Modal Table Scrollbar */
    #salaryTable::-webkit-scrollbar {
        width: 8px;
    }

    #salaryTable::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    #salaryTable::-webkit-scrollbar-thumb {
        background: #5a6b7d;
        border-radius: 4px;
    }

        #salaryTable::-webkit-scrollbar-thumb:hover {
            background: #4a5a6b;
        }
</style>

<!-- Scripts -->
<!-- Event Modal -->
<!-- Bootstrap Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Event Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <!-- Date Field -->
                <div class="mb-3">
                    <label for="eventDate" class="form-label">Date:</label>
                    <input type="text" class="form-control" id="eventDate" readonly>
                </div>

                <!-- Event Name Field -->
                <div class="mb-3">
                    <label for="eventName" class="form-label">Event Name<span class="text-danger">*</span>:</label>
                    <textarea class="form-control" id="eventName" rows="2" placeholder="Enter event name"></textarea>
                </div>

                <!-- Event Type Dropdown -->
                <div class="mb-3">
                    <label for="eventType" class="form-label">Event Type<span class="text-danger">*</span>:</label>
                    <select class="form-select" id="eventType">
                        <option value="" selected>-Select-</option>
                        <option value="birthday">Birthday</option>
                        <option value="anniversary">Anniversary</option>
                        <option value="meeting">Meeting</option>
                        <option value="appointment">Appointment</option>
                        <option value="reminder">Reminder</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Repeat Dropdown -->
                <div class="mb-3">
                    <label for="eventRepeat" class="form-label">Repeat<span class="text-danger">*</span>:</label>
                    <select class="form-select" id="eventRepeat">
                        <option value="no-repeat" selected>No Repeat</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>

                <!-- Visibility Radio Buttons -->
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="eventVisibility" id="myEvent" value="my-event" checked>
                        <label class="form-check-label" for="myEvent">My Event</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="eventVisibility" id="showAll" value="show-all">
                        <label class="form-check-label" for="showAll">Show All</label>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Clear</button>
                <button type="button" class="btn btn-primary" onclick="saveEvent()">Save</button>
            </div>

            <!-- Posted Events Section -->
            <div class="modal-body">
                <h6>Posted Events</h6>
                <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-danger btn-sm" onclick="deleteSelectedEvents()">Delete</button>
                </div>
                <div id="postedEventsGrid" style="height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px;"></div>
            </div>
        </div>
    </div>
</div>




<!-- Holiday Modal -->
<div class="modal" id="holidayModal">
    <div class="modal-content" style="width: 900px; max-width: 95vw; max-height: 90vh; overflow: hidden;">
        <div class="modal-header">
            <div class="modal-title">Holiday Details</div>
            <button class="close-btn" onclick="closeHolidayModal()">×</button>
        </div>
        <div class="modal-body" style="padding: 0; display: flex; flex-direction: column; height: calc(90vh - 60px);">
            <!-- Year Selector - Centered -->
            <div style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 15px; flex-shrink: 0;">
                <button onclick="previousYear()" style="background: #5a6b7d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 18px;">❮</button>
                <div id="selectedYear" style="font-size: 18px; font-weight: bold; min-width: 80px; text-align: center;">2025</div>
                <button onclick="nextYear()" style="background: #5a6b7d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 18px;">❯</button>
            </div>

            <!-- Holiday Grid - With Scrollbar -->
            <div id="holidayGridContainer" style="flex: 1; padding: 15px; overflow: hidden;">
                <div id="holidayGrid" style="height: 100%;"></div>
            </div>
        </div>
    </div>
</div>  


<!-- Yearly Salary Modal -->
<div class="modal" id="yearlySalaryModal">
    <div class="modal-content" style="width: 900px; max-width: 95vw; max-height: 85vh; overflow: hidden;">
        <div class="modal-header">
            <div class="modal-title">Yearly Salary Summary</div>
            <button class="close-btn" onclick="closeYearlySalaryModal()">×</button>
        </div>
        <div class="modal-body" style="padding: 15px; display: flex; flex-direction: column; height: calc(85vh - 60px);">
            <!-- Year Type Selector and Year Navigation -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
                <!-- Radio Buttons for Year Type -->
                <div style="display: flex; gap: 20px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="yearType" value="financial" checked onchange="onYearTypeChange()">
                        <span style="font-size: 14px; font-weight: 500;">Financial Year</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="yearType" value="calender" onchange="onYearTypeChange()">
                        <span style="font-size: 14px; font-weight: 500;">Calender Year</span>
                    </label>
                </div>

                <!-- Year Dropdown and Go Button -->
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="salaryYearDropdown" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; min-width: 140px;">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                    <button onclick="loadSalaryData()" style="background: #5a6b7d; color: white; border: none; padding: 6px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">Go</button>
                </div>
            </div>

            <!-- Chart and Table Container -->
            <div style="flex: 1; overflow: hidden; display: flex; gap: 15px; min-height: 0;">
                <!-- Chart Section (Left Side - 60%) -->
                <div style="flex: 0 0 60%; display: flex; flex-direction: column; min-height: 0;">
                    <div id="salaryChart" style="flex: 1; min-height: 0;"></div>
                </div>

                <!-- Table Section (Right Side - 40%) -->
                <div style="flex: 0 0 40%; display: flex; flex-direction: column; border-left: 1px solid #e0e0e0; padding-left: 15px; min-height: 0;">
                    <h5 style="margin: 0 0 10px 0; font-size: 15px; font-weight: 600; color: #333; text-align: center;">Month-wise Details</h5>
                    <div id="salaryTable" style="flex: 1; overflow-y: auto; overflow-x: hidden; border: 1px solid #ddd; border-radius: 4px; background: white;">
                        <!-- Table will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Leave Report Modal -->
<div class="modal" id="leaveReportModal">
    <div class="modal-content" style="width: 900px; max-width: 95vw; max-height: 85vh; overflow: hidden;">
        <div class="modal-header">
            <div class="modal-title">Leave Summary Report</div>
            <button class="close-btn" onclick="closeLeaveReportModal()">×</button>
        </div>
        <div class="modal-body" style="padding: 15px; display: flex; flex-direction: column; height: calc(85vh - 60px);">
            <!-- Chart and Table Container -->
            <div style="flex: 1; overflow: hidden; display: flex; gap: 15px; min-height: 0;">
                <!-- Chart Section (Left Side - 60%) -->
                <div style="flex: 0 0 60%; display: flex; flex-direction: column; min-height: 0;">
                    <div id="leaveChart" style="flex: 1; min-height: 0;"></div>
                </div>

                <!-- Table Section (Right Side - 40%) -->
                <div style="flex: 0 0 40%; display: flex; flex-direction: column; border-left: 1px solid #e0e0e0; padding-left: 15px; min-height: 0;">
                    <h5 style="margin: 0 0 10px 0; font-size: 15px; font-weight: 600; color: #333; text-align: center;">Leave Details</h5>
                    <div id="leaveTable" style="flex: 1; overflow-y: auto; overflow-x: hidden; border: 1px solid #ddd; border-radius: 4px; background: white;">
                        <!-- Table will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Compoff Lapse Reminder Modal -->
<div class="modal" id="compoffLapseModal">
    <div class="modal-content" style="width: 900px; max-width: 95vw; max-height: 90vh; overflow: hidden;">
        <div class="modal-header">
            <div class="modal-title">Employee Compoff Lapse Details</div>
            <button class="close-btn" onclick="closeCompoffLapseModal()">×</button>
        </div>
        <div class="modal-body" style="padding: 15px; display: flex; flex-direction: column; height: calc(90vh - 60px);">
            <!-- Filter Section -->
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #ddd;">
                <!-- For Date -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 600; font-size: 14px; color: #555; min-width: 70px;">For Date :</label>
                    <input type="date"
                           id="compoffLapseDate"
                           style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; min-width: 150px;">
                </div>

                <!-- Lapse Days -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 600; font-size: 14px; color: #555; min-width: 90px;">Lapse Days :</label>
                    <input type="number"
                           id="compoffLapseDays"
                           value="3"
                           min="1"
                           style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100px;">
                </div>

                <!-- Go Button -->
                <button onclick="loadCompoffLapseData()"
                        style="background: #5a6b7d; color: white; border: none; padding: 7px 30px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">
                    Go
                </button>
            </div>

            <!-- Grid Container -->
            <div id="compoffLapseGridContainer" style="flex: 1; overflow: hidden;">
                <div id="compoffLapseGrid" style="height: 100%;"></div>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="continuousAbsentModal">
    <div class="modal-content" style="width: 1000px; max-width: 95vw; max-height: 90vh; overflow: hidden;">
        <div class="modal-header">
            <div class="modal-title">Continuous Absent Report</div>
            <button class="close-btn" onclick="closeContinuousAbsentModal()">×</button>
        </div>
        <div class="modal-body" style="padding: 15px; display: flex; flex-direction: column; height: calc(90vh - 60px);">
            <!-- Filter Section -->
            <div style="display: flex; align-items: flex-end; gap: 15px; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #ddd; flex-wrap: wrap;">
                <!-- Month -->
                <div style="display: flex; flex-direction: column; gap: 5px; min-width: 150px;">
                    <label style="font-weight: 600; font-size: 13px; color: #555;">Month :</label>
                    <div id="continuousAbsentMonth"></div>
                </div>

                <!-- Year -->
                <div style="display: flex; flex-direction: column; gap: 5px; min-width: 120px;">
                    <label style="font-weight: 600; font-size: 13px; color: #555;">Year :</label>
                    <div id="continuousAbsentYear"></div>
                </div>

                <!-- Branch -->
                <div style="display: flex; flex-direction: column; gap: 5px; min-width: 200px;">
                    <label style="font-weight: 600; font-size: 13px; color: #555;">Branch :</label>
                    <div id="continuousAbsentBranch"></div>
                </div>

                <!-- Employee -->
                <div style="display: flex; flex-direction: column; gap: 5px; min-width: 250px;">
                    <label style="font-weight: 600; font-size: 13px; color: #555;">Employee :</label>
                    <div id="continuousAbsentEmployee"></div>
                </div>

                <!-- Go Button -->
                <button onclick="loadContinuousAbsentData()"
                        style="background: #5a6b7d; color: white; border: none; padding: 8px 30px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; height: 36px; align-self: flex-end;">
                    Go
                </button>
            </div>

            <!-- Grid Container -->
            <div id="continuousAbsentGridContainer" style="flex: 1; overflow: hidden;">
                <div id="continuousAbsentGrid" style="height: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
        const Token = localStorage.getItem("authToken");
        const userId = localStorage.getItem("EmployeeId");
        const companyDetails = JSON.parse(localStorage.getItem('selectedCompany'));
        const CompanyId = companyDetails.CompanyId;

     $(document).ready(function() {
        BranchData();
        LoadDashboardCounts();
        initializeTabs();
        LoadAttendanceRegularizationCount();
        LoadLeaveCancellationCount();
        LoadActivemobileuserCount();
        LoadActiveUserCount();
        // Open the Events tab by default
        $('.tab-item[data-tab="addViewEvents"]').addClass('active'); // Mark tab as active
        $('#addViewEventsContent').show(); // Show the content (no animation delay)
        loadEventsData(); // Load the data

        $('#leaveCount').text('(.)');
        $('#attendanceRegCount').text('(.)');
        $('#leavecancallationCount').text('(.)');
        $('#compoffCount').text('(.)');
        $('#mobileUsersCount').text('(.)');
        $('#activeUsersCount').text('(.)');
    });

    function initializeTabs() {
        $('.tab-item').on('click', function(e) {
            e.preventDefault();
            const tabId = $(this).data('tab');
            const isCurrentlyActive = $(this).hasClass('active');

            // Remove active class from all tabs
            $('.tab-item').removeClass('active');
            // Hide all tab contents
            $('.tab-contents').slideUp(300);

            if (!isCurrentlyActive) {
                $(this).addClass('active');
                $('#' + tabId + 'Content').slideDown(300);
                loadTabContent(tabId);
            }
        });
    }

    // Load content for specific tabs
    function loadTabContent(tabId) {
        switch(tabId) {
            case 'todaysAttendance':
                loadTodaysAttendanceData();
                break;
            case 'birthdayAnniversary':
                loadBirthdayAnniversaryData();
                break;
            case 'addViewEvents':
                loadEventsData();
                break;
            case 'messageBoard':
                loadMessageBoardData();
                break;
            case 'newJoining':
                loadNewJoiningData();
                break;
            case 'wallOfFame':
                loadWallOfFameData();
                break;
        }
    }

            // Load Today's Attendance Data
        function loadTodaysAttendanceData() {
            $('#tab-loader').show();
            $.ajax({
                type: "GET",
                url: '@baseDomainUrl/api/BranchAPI/GetAllBranchesListByCompanyId/' + CompanyId,
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (data) {
                    $('#tab-loader').hide();
                    if (data.isSuccess && data.data.length > 0) {
                        $("#attendanceGrid").dxDataGrid({
                            dataSource: data.data,
                            columns: [
                                    {
                                        dataField: "branchName",
                                        cellTemplate: function(container, options) {
                                            $("<a>")
                                                .text(options.value)
                                                .css({
                                                    "cursor": "pointer",
                                                    "color": "#0066cc"  ,
                                                     'text-decoration': 'underline'
                                                })
                                                .on("click", function() {
                                                    showAttendancePopup(options.data.branchId, options.data.branchName);
                                                })
                                                .appendTo(container);
                                        }
                                    }
                            ],
                            showBorders: true,
                            columnAutoWidth: true,
                            paging: {
                                 enabled: false
                                },
                                scrolling: {
                                    mode: "standard",
                                    useNative: true,
                                    showScrollbar: "always"
                                },
                        });
                    } else {
                        $('#attendanceGrid').html('<div class="text-center p-3">No attendance data found</div>');
                    }
                },
                error: function (xhr, status, error) {
                    $('#tab-loader').hide();
                    $('#attendanceGrid').html('<div class="text-center p-3 text-danger">Error loading attendance data</div>');
                    console.error("AJAX Error: ", error);
                }
            });
        }

            async function fetchTodaysAttendance(BranchId, ShiftMasterId,CompanyId) {
            try {

                const response = await $.ajax({
                    type: "GET",
                    url: `@baseDomainUrl/api/EmpAttendanceAPI/GetTodaysAttendanceAdmin?BranchId=${BranchId}&ShiftMatserId=${ShiftMasterId}&CompanyId=${CompanyId}`,
                    headers: {
                        'Authorization': 'Bearer ' + Token
                    }
                });
                return response;
            } catch (error) {
                console.error("Error fetching attendance data:", error);
                return { isSuccess: false, ResponseMessage: "Error fetching data" };
            }
        }


           async function fetchShiftData() {
            try {
                const response = await $.ajax({
                    type: "GET",
                    url: `@baseDomainUrl/api/ShiftMasterAPI/GetAllShifts`,
                    headers: {
                        'Authorization': 'Bearer ' + Token
                    }
                });
                return response;
            } catch (error) {
                console.error("Error fetching shift data:", error);
                return { isSuccess: false, data: [] };
            }
        }

        //Modal
         async function showAttendancePopup(BranchId, BranchName) {
        const shiftsResponse = await fetchShiftData();
        const response = await fetchTodaysAttendance(BranchId, 0, CompanyId);
        if (response.isSuccess && response.data) {
            let currentData = response.data;
            const popup = $("#attendancePopup").dxPopup({
                title: "Today's Attendance Summary",
                width: 900,
                height: 720,
                maxWidth: "95vw",
                maxHeight: "90vh",
                showTitle: true,
                resizeEnabled: true,
                contentTemplate: function(container) {
                    // Create main container with better spacing
                    const mainContainer = $("<div>").css({
                        "padding": "10px",
                        "height": "calc(100% - 20px)",
                        "background": "#fafafa",
                        "font-family": "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                    });

                    // Compact filter section
                    const filterContainer = $("<div>").css({
                        "padding": "8px 12px",
                        "margin-bottom": "10px",
                        "display": "flex",
                        "align-items": "center",
                        "justify-content": "flex-start",
                        "gap": "8px",
                        "background": "white",
                        "border-radius": "6px",
                        "box-shadow": "0 1px 3px rgba(0,0,0,0.1)"
                    });

                    $("<label>").text("Shift:").css({
                        "font-weight": "600",
                        "font-size": "13px",
                        "color": "#555",
                        "min-width": "40px"
                    }).appendTo(filterContainer);

                    const shiftDropdown = $("<div>").attr("id", "shiftFilterDropdown").appendTo(filterContainer);
                    const goButton = $("<div>").attr("id", "filterGoButton").appendTo(filterContainer);
                    filterContainer.appendTo(mainContainer);

                    // Summary cards section - more compact
                    const summaryContainer = $("<div>")
                        .attr("id", "attendanceSummary")
                        .css({
                            "display": "grid",
                            "grid-template-columns": "repeat(auto-fit, minmax(80px, 1fr))",
                            "gap": "8px",
                            "margin-bottom": "12px",
                            "font-size": "12px"
                        })
                        .appendTo(mainContainer);

                    // Compact grid container
                    const gridContainer = $("<div>")
                        .attr("id", "attendanceDataGrid")
                        .css({
                            "margin-bottom": "12px",
                            "height": "250px",
                            "background": "white",
                            "border-radius": "6px",
                            "box-shadow": "0 1px 3px rgba(0,0,0,0.1)"
                        })
                        .appendTo(mainContainer);

                    // Chart section - side by side layout
                    const chartSection = $("<div>").css({
                        "display": "grid",
                        "grid-template-columns": "280px 1fr",
                        "gap": "12px",
                        "height": "220px",
                        "margin-top": "10px",
                        "margin-bottom": "10px"
                    });

                    // Legend container (left side)
                    const legendContainer = $("<div>").css({
                        "background": "white",
                        "border-radius": "6px",
                        "padding": "10px",
                        "box-shadow": "0 1px 3px rgba(0,0,0,0.1)",
                        "overflow": "hidden"
                    }).appendTo(chartSection);

                    const legendTitle = $("<h5>").text("Status Legend").css({
                        "margin": "0 0 8px 0",
                        "font-size": "14px",
                        "font-weight": "600",
                        "color": "#333"
                    }).appendTo(legendContainer);

                    const legendItems = $("<div>").attr("id", "legendItems").css({
                        "display": "grid",
                        "grid-template-columns": "1fr 1fr",
                        "gap": "8px",
                        "font-size": "12px"
                    }).appendTo(legendContainer);

                    // Chart container (right side)
                    const chartContainer = $("<div>").css({
                        "background": "white",
                        "border-radius": "6px",
                        "padding": "8px",
                        "display": "flex",
                        "flex-direction": "column",
                        "align-items": "center",
                        "justify-content": "center",
                        "box-shadow": "0 1px 3px rgba(0,0,0,0.1)",
                        "height": "100%"
                    }).appendTo(chartSection);

                    const chartTitle = $("<h5>").text("Distribution").css({
                        "margin": "0 0 8px 0",
                        "font-size": "14px",
                        "font-weight": "600",
                        "color": "#333"
                    }).appendTo(chartContainer);

                    const chartDiv = $("<div>")
                        .attr("id", "attendanceChart")
                        .css({
                            "height": "170px",
                            "width": "170px",
                            "margin": "0 auto",
                            "flex-shrink": "0"
                        })
                        .appendTo(chartContainer);

                    chartSection.appendTo(mainContainer);

                    // Initialize compact dropdown
                    let shiftOptions = [{ shiftID: 0, shiftName: "--All Shifts--" }];
                    if (shiftsResponse.isSuccess && shiftsResponse.data) {
                        shiftOptions = shiftOptions.concat(shiftsResponse.data.map(shift => ({
                            shiftID: shift.shiftID,
                            shiftName: shift.shiftName
                        })));
                    }

                    shiftDropdown.dxSelectBox({
                        dataSource: shiftOptions,
                        displayExpr: "shiftName",
                        valueExpr: "shiftID",
                        value: 0,
                        width: 160,
                        height: 32
                    });

                    goButton.dxButton({
                        text: "Apply",
                        type: "default",
                        width: 80,
                        height: 34,
                        onClick: async function() {
                            const selectedShiftId = shiftDropdown.dxSelectBox("option", "value");
                            const newResponse = await fetchTodaysAttendance(BranchId, selectedShiftId, CompanyId);

                            if (newResponse.isSuccess && newResponse.data) {
                                currentData = newResponse.data;
                                updateGridAndChart(currentData);
                            } else {
                                DevExpress.ui.notify("No data found for selected shift.", "warning", 2000);
                            }
                        }
                    });

                    // Grid and chart update function
                    function updateGridAndChart(data) {
                        // Update compact grid
                        gridContainer.dxDataGrid({
                            dataSource: data,
                            columns: [
                                {
                                    dataField: "employeeCode",
                                    caption: "Code",
                                    width: 100,
                                    alignment: "center"
                                },
                                {
                                    dataField: "fullName",
                                    caption: "Employee Name",
                                    minWidth: 200,
                                    alignment: "left"
                                },
                                {
                                    dataField: "employeeTypeName",
                                    caption: "Type",
                                    width: 100,
                                    alignment: "center"
                                },
                                {
                                    dataField: "attendanceStatus",
                                    caption: "Status",
                                    width: 100,
                                    alignment: "center",
                                    cellTemplate: function(container, options) {
                                        const status = options.value;
                                        let color, text, bgColor;
                                        switch(status) {
                                            case "P": color = "white"; bgColor = "#1f77b4"; text = "P"; break;
                                            case "A": color = "white"; bgColor = "#d62728"; text = "A"; break;
                                            case "L": color = "white"; bgColor = "#ff7f0e"; text = "L"; break;
                                            case "HF": color = "white"; bgColor = "#2ca02c"; text = "HF"; break;
                                            case "H": color = "white"; bgColor = "#17a2b8"; text = "H"; break;
                                            case "W": color = "white"; bgColor = "#9467bd"; text = "W"; break;
                                            case "LWP": color = "white"; bgColor = "#ff6b35"; text = "LWP"; break;
                                            default: color = "white"; bgColor = "#6c757d"; text = status; break;
                                        }
                                        $("<div>")
                                            .text(text)
                                            .css({
                                                "color": color,
                                                "background": bgColor,
                                                "padding": "4px 8px",
                                                "border-radius": "18px",
                                                "font-weight": "600",
                                                "font-size": "11px",
                                                "display": "inline-block",
                                                "min-width": "24px",
                                                "text-align": "center",
                                                "width": "28px",
                                                "height": "28px",
                                                "line-height": "20px"
                                            })
                                            .appendTo(container);
                                    }
                                }
                            ],
                            showBorders: true,
                            columnAutoWidth: true,
                            paging: {
                                enabled: false
                            },
                            scrolling: {
                                mode: "standard",
                                useNative: true,
                                showScrollbar: "always"
                            },
                            height: 250,
                            headerFilter: { visible: false },
                            export: {
                                enabled: false  // Disable built-in export to avoid duplicate icons
                            },
                            onToolbarPreparing: function(e) {
                                // Add title to toolbar
                                e.toolbarOptions.items.unshift({
                                    location: "before",
                                    template: function() {
                                        return $("<div>").css({
                                            "font-weight": "600",
                                            "color": "#333",
                                            "font-size": "14px"
                                        }).text(`${BranchName} - Employee List`);
                                    }
                                });

                                // Add single custom Excel export button
                                e.toolbarOptions.items.push({
                                    location: "after",
                                    widget: "dxButton",
                                    options: {
                                        icon: "exportxlsx",
                                        text: "Export Excel",
                                        type: "normal",
                                        stylingMode: "text",
                                        elementAttr: {
                                            style: "color: #333; background: transparent;"
                                        },
                                        onClick: function() {
                                            exportToExcel(data, BranchName);
                                        }
                                    }
                                });
                            }
                        });

                        // Calculate summary data
                        const summary = calculateSummary(data);

                        // Update compact summary cards
                        summaryContainer.empty();
                        const summaryItems = [
                            { label: "Present", value: summary.present, color: "#1f77b4" },
                            { label: "Absent", value: summary.absent, color: "#d62728" },
                            { label: "Leave", value: summary.leave, color: "#ff7f0e" },
                            { label: "Half Day", value: summary.halfDay, color: "#2ca02c" },
                            { label: "Week Off", value: summary.weekOff, color: "#9467bd" },
                            { label: "Total", value: data.length, color: "#333" }
                        ];

                        summaryItems.forEach(item => {
                            const card = $("<div>").css({
                                "background": "white",
                                "border-radius": "6px",
                                "padding": "8px",
                                "text-align": "center",
                                "box-shadow": "0 1px 3px rgba(0,0,0,0.1)",
                                "border-left": `3px solid ${item.color}`
                            });

                            $("<div>").text(item.value).css({
                                "font-size": "16px",
                                "font-weight": "700",
                                "color": item.color,
                                "margin-bottom": "2px"
                            }).appendTo(card);

                            $("<div>").text(item.label).css({
                                "font-size": "11px",
                                "color": "#666",
                                "font-weight": "500"
                            }).appendTo(card);

                            card.appendTo(summaryContainer);
                        });

                        // Update compact legend
                        legendItems.empty();
                        const legendData = [
                            { text: "PRESENT", color: "#1f77b4", short: "P" },
                            { text: "ABSENT", color: "#d62728", short: "A" },
                            { text: "LEAVE", color: "#ff7f0e", short: "L" },
                            { text: "Half Day", color: "#2ca02c", short: "HF" },
                            { text: "WEEK OFF", color: "#9467bd", short: "W" },
                            { text: "HOLIDAY", color: "#17a2b8", short: "H" }
                        ];

                        legendData.forEach(item => {
                            const legendItem = $("<div>").css({
                                "display": "flex",
                                "align-items": "center",
                                "gap": "6px"
                            });

                            $("<div>").css({
                                "width": "12px",
                                "height": "12px",
                                "background-color": item.color,
                                "border-radius": "2px",
                                "flex-shrink": "0"
                            }).appendTo(legendItem);

                            $("<span>").text(item.text).css({
                                "font-size": "11px",
                                "font-weight": "500",
                                "color": "#555"
                            }).appendTo(legendItem);

                            legendItem.appendTo(legendItems);
                        });

                        // Update compact doughnut chart
                        const chartData = getChartDataForDoughnut(data);
                        chartDiv.dxPieChart({
                            dataSource: chartData,
                            series: [{
                                argumentField: "status",
                                valueField: "count",
                                colorField: "color"
                            }],
                            innerRadius: 0.65,
                            legend: { visible: false },
                            tooltip: {
                                enabled: true,
                                customizeTooltip: function(arg) {
                                    return {
                                        text: `${arg.argumentText}: ${arg.valueText} (${Math.round(arg.percent)}%)`
                                    };
                                }
                            },
                            size: {
                                height: 170,
                                width: 170
                            }
                        });
                    }

                    // Calculate summary function
                    function calculateSummary(data) {
                        const summary = {
                            present: 0,
                            absent: 0,
                            leave: 0,
                            halfDay: 0,
                            weekOff: 0,
                            holiday: 0,
                            lwp: 0
                        };

                        data.forEach(item => {
                            switch(item.attendanceStatus) {
                                case "P": summary.present++; break;
                                case "A": summary.absent++; break;
                                case "L": summary.leave++; break;
                                case "HF": summary.halfDay++; break;
                                case "W": summary.weekOff++; break;
                                case "H": summary.holiday++; break;
                                case "LWP": summary.lwp++; break;
                            }
                        });

                        return summary;
                    }

                    // Chart data for doughnut
                    function getChartDataForDoughnut(data) {
                        const summary = calculateSummary(data);
                        const chartData = [];

                        if (summary.present > 0) {
                            chartData.push({ status: "Present", count: summary.present, color: "#1f77b4" });
                        }
                        if (summary.absent > 0) {
                            chartData.push({ status: "Absent", count: summary.absent, color: "#d62728" });
                        }
                        if (summary.leave > 0) {
                            chartData.push({ status: "Leave", count: summary.leave, color: "#ff7f0e" });
                        }
                        if (summary.halfDay > 0) {
                            chartData.push({ status: "Half Day", count: summary.halfDay, color: "#2ca02c" });
                        }
                        if (summary.weekOff > 0) {
                            chartData.push({ status: "Week Off", count: summary.weekOff, color: "#9467bd" });
                        }
                        if (summary.holiday > 0) {
                            chartData.push({ status: "Holiday", count: summary.holiday, color: "#17a2b8" });
                        }

                        return chartData;
                    }

                    updateGridAndChart(currentData);
                    return mainContainer;
                }

            }).dxPopup("instance");

            popup.show();
        } else {
            DevExpress.ui.notify("No attendance data found for this branch.", "error", 3000);
        }
    }

    // Enhanced manual export function with better status text conversion
    function exportToExcel(data, branchName) {
        try {
            // Check if XLSX library is available
            if (typeof XLSX === 'undefined') {
                // Fallback: Use DevExpress built-in export
                const gridInstance = $("#attendanceDataGrid").dxDataGrid("instance");
                if (gridInstance) {
                    gridInstance.exportToExcel();
                } else {
                    DevExpress.ui.notify("Export functionality not available. Please try again.", "error", 3000);
                }
                return;
            }

            // Create workbook and worksheet
            const workbook = XLSX.utils.book_new();

            // Add summary data
            const currentDate = new Date().toLocaleDateString();
            const summary = calculateSummaryForExport(data);

            // Prepare header data
            const headerData = [
                [`${branchName} - Today's Attendance Report`],
                [`Date: ${currentDate}`],
                [`Total Employees: ${data.length}`],
                [''],
                ['Summary:'],
                [`Present: ${summary.present}`, `Absent: ${summary.absent}`, `Leave: ${summary.leave}`, `Half Day: ${summary.halfDay}`, `Week Off: ${summary.weekOff}`, `Holiday: ${summary.holiday}`],
                [''],
                ['Employee Details:']
            ];

            // Prepare employee data for Excel
            const excelData = data.map(item => ({
                'Employee Code': item.employeeCode || '',
                'Employee Name': item.fullName || '',
                'Employee Type': item.employeeTypeName || '',
                'Attendance Status': getStatusText(item.attendanceStatus),
                'Department': item.departmentName || '',
                'Designation': item.designationName || '',
                'Shift': item.shiftName || ''
            }));

            // Create worksheet with headers
            const worksheet = XLSX.utils.aoa_to_sheet(headerData);

            // Add employee data starting from row 9
            XLSX.utils.sheet_add_json(worksheet, excelData, {
                origin: 'A9',
                skipHeader: false
            });

            // Set column widths
            const columnWidths = [
                { wch: 15 }, // Employee Code
                { wch: 30 }, // Employee Name
                { wch: 15 }, // Employee Type
                { wch: 18 }, // Attendance Status
                { wch: 20 }, // Department
                { wch: 20 }, // Designation
                { wch: 15 }  // Shift
            ];
            worksheet['!cols'] = columnWidths;

            // Style the header cells (if styling is supported)
            const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
            for (let row = 0; row < 8; row++) {
                for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    if (worksheet[cellAddress]) {
                        worksheet[cellAddress].s = {
                            font: { bold: true, sz: 12 },
                            fill: { fgColor: { rgb: "E6E6E6" } }
                        };
                    }
                }
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Attendance Report');

            // Generate filename with current date and time
            const currentDateTime = new Date();
            const dateStr = currentDateTime.toISOString().split('T')[0];
            const timeStr = currentDateTime.toTimeString().split(' ')[0].replace(/:/g, '-');
            const filename = `Attendance_${branchName.replace(/[^a-zA-Z0-9]/g, '_')}_${dateStr}_${timeStr}.xlsx`;

            // Save file
            XLSX.writeFile(workbook, filename);

            // Show success message
            DevExpress.ui.notify("Excel file downloaded successfully!", "success", 3000);

        } catch (error) {
            console.error("Error exporting to Excel:", error);
            DevExpress.ui.notify("Error exporting to Excel. Please try again.", "error", 3000);

            // Fallback to DevExpress export if available
            try {
                const gridInstance = $("#attendanceDataGrid").dxDataGrid("instance");
                if (gridInstance) {
                    gridInstance.exportToExcel();
                }
            } catch (fallbackError) {
                console.error("Fallback export also failed:", fallbackError);
            }
        }
    }

    // Helper function to get readable status text
    function getStatusText(status) {
        const statusMap = {
            'P': 'Present',
            'A': 'Absent',
            'L': 'Leave',
            'HF': 'Half Day',
            'H': 'Holiday',
            'W': 'Week Off',
            'LWP': 'Leave Without Pay'
        };
        return statusMap[status] || status;
    }

    // Helper function to calculate summary for export
    function calculateSummaryForExport(data) {
        const summary = {
            present: 0,
            absent: 0,
            leave: 0,
            halfDay: 0,
            weekOff: 0,
            holiday: 0,
            lwp: 0
        };

        data.forEach(item => {
            switch(item.attendanceStatus) {
                case "P": summary.present++; break;
                case "A": summary.absent++; break;
                case "L": summary.leave++; break;
                case "HF": summary.halfDay++; break;
                case "W": summary.weekOff++; break;
                case "H": summary.holiday++; break;
                case "LWP": summary.lwp++; break;
            }
        });

        return summary;
    }
        // Placeholder functions for other tabs
        function loadBirthdayAnniversaryData() {
        }
    function loadEventsData() {
        loadUserEvents();
    }
        function loadMessageBoardData() {
        }

        function loadNewJoiningData() {
        }

        function loadWallOfFameData() {
        }

        // Function to load all dashboard counts
        function LoadDashboardCounts() {
            LoadLeaveApplicationCount();
            LoadCompApplicationCount();

        }

        function LoadLeaveApplicationCount() {
            const payload = {
                SearchType: '',
                SearchFor: '',
                BranchId: '0',
                CompId: CompanyId
            };

            $.ajax({
                url: '@baseDomainUrl/api/LeaveApplication/GetLeaveApplicationsforApproveAdmin',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (data) {
                    if (data.isSuccess && data.data) {
                        const count = data.data.length;
                        $('#leaveCount').text(`(${count})`);

                        if (count > 0) {
                            $('#leaveCount').removeClass('red-count').addClass('red-count');
                        } else {
                            $('#leaveCount').removeClass('red-count');
                        }
                    }
                },
                error: function () {
                    console.error("Error loading leave application count");
                    $('#leaveCount').text('(0)');
                }
            });
        }
    function LoadAttendanceRegularizationCount() {

    const payload = {
        SearchBy: null,
        SearchValue: null,
        FromDate: null,
        ToDate: null,
        Status: 'Pending',
       // CompanyId: CompanyId  
    };
        $.ajax({
            url: '@(baseDomainUrl + "/api/AttendanceRegularizationAPI/GetAttendanceRegularizationForAdmin")', // Use a dedicated count endpoint
            type: 'POST',
            data: JSON.stringify(payload),
            contentType: 'application/json',
            success: function (res) {
           
                if (res.isSuccess) {
                       const count = Array.isArray(res.data) ? res.data.length : 0;
                    
                    $('#attendanceRegCount').text(`(${count})`);  
                 
                    if (count > 0) {
                        $('#attendanceRegCount').addClass('red-count');
                    } else {
                        $('#attendanceRegCount').removeClass('red-count');
                    }
                } else {
                    $('#attendanceRegCount').text('(0)');
                    // round_error_noti(res.responseMessage || 'Failed to load count');
                }
            },
            error: function (xhr, status, error) {
                hideLoder();
                $('#attendanceRegCount').text('(0)');
                // round_error_noti('Error fetching count');
            }
        });
    }
    function LoadLeaveCancellationCount() {
    const payload = {
        SearchBy: null,
        SearchValue: null,
        FromDate: null,
        ToDate: null,
        LeaveStatus: 'Pending',
        CompanyId: CompanyId
    };
        $.ajax({
                 url: '@(baseDomainUrl + "/api/LeaveCancellationAPI/GetLeaveCancellationReportAdmin")',
                 type: 'POST',
            data: JSON.stringify(payload),
            contentType: 'application/json',
            success: function (res) {
           
                if (res.isSuccess) {
                       const count = Array.isArray(res.data) ? res.data.length : 0;
                    
                    $('#leavecancallationCount').text(`(${count})`);

                    if (count > 0) {
                        $('#leavecancallationCount').addClass('red-count');
                    } else {
                        $('#leavecancallationCount').removeClass('red-count');
                    }
                } else {
                    $('#leavecancallationCount').text('(0)');
                    // round_error_noti(res.responseMessage || 'Failed to load count');
                }
            },
            error: function (xhr, status, error) {
                hideLoder();
                $('#leavecancallationCount').text('(0)');
                // round_error_noti('Error fetching count');
            }
        });
    }

        function LoadActivemobileuserCount() {
      currentStatus = 'Active';
     $.ajax({
         type: "GET",
         url: '@(baseDomainUrl + "/api/ReportAPI/ActiveOrInactiveMobileUsers")',
         data: {
             Compid: CompanyId,
             Action: currentStatus
         },
         headers: {
             'Authorization': 'Bearer ' + Token
         },
         success: function (response) {

                if (response.isSuccess) {
                       const count = Array.isArray(response.data) ? response.data.length : 0;
                      
                    $('#mobileUsersCount').text(`(${count})`);

                    if (count > 0) {
                        $('#mobileUsersCount').addClass('red-count');
                    } else {
                        $('#mobileUsersCount').removeClass('red-count');
                    }
                } else {
                    $('#mobileUsersCount').text('(0)');
                    // round_error_noti(res.responseMessage || 'Failed to load count');
                }
            },
            error: function (xhr, status, error) {
                hideLoder();
                $('#mobileUsersCount').text('(0)');
                // round_error_noti('Error fetching count');
            }
        });
    }


        function LoadActiveUserCount() {
      currentStatus = 'Active';
     $.ajax({
         type: "GET",
         url: '@(baseDomainUrl + "/api/ReportAPI/ActiveOrInactive")',
         data: {
             Compid: CompanyId,
             Action: currentStatus
         },
         headers: {
             'Authorization': 'Bearer ' + Token
         },
         success: function (response) {

                if (response.isSuccess) {
                       const count = Array.isArray(response.data) ? response.data.length : 0;                  
                    $('#activeUsersCount').text(`(${count})`);

                    if (count > 0) {
                        $('#activeUsersCount').addClass('red-count');
                    } else {
                        $('#activeUsersCount').removeClass('red-count');
                    }
                } else {
                    $('#activeUsersCount').text('(0)');
                    // round_error_noti(res.responseMessage || 'Failed to load count');
                }
            },
            error: function (xhr, status, error) {
                hideLoder();
                $('#activeUsersCount').text('(0)');
                // round_error_noti('Error fetching count');
            }
        });
    }


        function LoadCompApplicationCount() {
            const payload = {
                SearchType: null,
                SearchFor: null,
                CompId: CompanyId,
                BranchId: null,
                ApplicationStatus: 'Pending'
            };

            $.ajax({
                url: '@baseDomainUrl/api/CompOffAPI/GetCompOffDetailsReportForAdmin',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (data) {
                    if (data.isSuccess && data.data) {
                        const count = data.data.length;
                        $('#compoffCount').text(`(${count})`);

                        if (count > 0) {
                            $('#compoffCount').removeClass('red-count').addClass('red-count');
                        } else {
                            $('#compoffCount').removeClass('red-count');
                        }
                    }
                },
                error: function () {
                    console.error("Error loading comp off application count");
                    $('#compoffCount').text('(0)');
                }
            });
        }


        // Auto-refresh counts every 5 minutes
        setInterval(function() {
            LoadDashboardCounts();
        }, 300000); // 5 minutes = 300,000 milliseconds




            function loadBirthdayAnniversaryData() {
            $('#birthdayAnniversaryContent').html(`
                <div id="birthday-loader" class="text-center" style="display: block;">
                    <img src="@baseDomainUrl/loders/loder.png" style="width: 20px; height: 20px; animation: spin 1s linear infinite;" />
                    <div>Loading...</div>
                </div>
                <div id="birthday-content" style="display: none;">
                    <!-- Today's Birthday Section -->
                    <div class="birthday-section">
                        <h6 style="color: #8B4513; font-weight: bold; margin-bottom: 8px; font-size: 12px;">TODAY'S BIRTHDAY</h6>
                        <div style="font-style: italic; color: #666; margin-bottom: 10px; font-size: 11px;">Relay Express Pvt Ltd ${getCurrentDate()}</div>
                        <div id="todayBirthdays"></div>
                    </div>

                    <!-- Today's Anniversary Section -->
                    <div class="anniversary-section" style="margin-top: 20px;">
                        <h6 style="color: #8B4513; font-weight: bold; margin-bottom: 8px; font-size: 12px;">TODAY'S MARRIAGE ANNIVERSARY</h6>
                        <div id="todayAnniversaries"></div>
                    </div>

                    <!-- Upcoming Birthday Section -->
                    <div class="upcoming-section" style="margin-top: 20px;">
                        <h6 style="color: #8B4513; font-weight: bold; margin-bottom: 8px; font-size: 12px;">UPCOMING BIRTHDAY</h6>
                        <div style="font-style: italic; color: #666; margin-bottom: 10px; font-size: 11px;">Relay Express Pvt Ltd</div>
                        <div id="upcomingBirthdays"></div>
                    </div>

                    <!-- Upcoming Anniversary Section -->
                    <div class="upcoming-anniversary-section" style="margin-top: 20px;">
                        <h6 style="color: #8B4513; font-weight: bold; margin-bottom: 8px; font-size: 12px;">UPCOMING MARRIAGE ANNIVERSARY</h6>
                        <div id="upcomingAnniversaries"></div>
                    </div>
                </div>
            `);

            // Load birthday data
            $.ajax({
                url: '@baseDomainUrl/api/EmployeeDashBoardAPI/GetTodayBirthdaysByCompany?Compid=' + CompanyId,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (response) {
                    if (response.isSuccess && response.data && response.data.length > 0) {
                        displayBirthdayData(response.data);
                    } else {
                        $('#todayBirthdays').html('<div style="color: #999; font-style: italic; font-size: 11px;">No birthdays today</div>');
                        $('#upcomingBirthdays').html('<div style="color: #999; font-style: italic; font-size: 11px;">No upcoming birthdays</div>');
                    }
                    loadAnniversaryData();
                },
                error: function (xhr, status, error) {
                    console.error("Error loading birthday data:", error);
                    $('#todayBirthdays').html('<div style="color: #999; font-style: italic; font-size: 11px;">No birthdays today</div>');
                    $('#upcomingBirthdays').html('<div style="color: #999; font-style: italic; font-size: 11px;">No upcoming birthdays</div>');
                    loadAnniversaryData();
                }
            });
        }

        function loadAnniversaryData() {
            // Load anniversary data using the provided API
            $.ajax({
                url: '@baseDomainUrl/api/EmployeeDashBoardAPI/GetTodayWorkAnniversary?Compid=' + CompanyId,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (response) {
                    $('#birthday-loader').hide();
                    $('#birthday-content').show();

                    if (response.isSuccess && response.data && response.data.length > 0) {
                        displayAnniversaryData(response.data);
                    } else {
                        $('#todayAnniversaries').html('<div style="color: #999; font-style: italic; font-size: 11px;">No anniversaries today</div>');
                        $('#upcomingAnniversaries').html('<div style="color: #999; font-style: italic; font-size: 11px;">No upcoming anniversaries</div>');
                    }
                },
                error: function (xhr, status, error) {
                    $('#birthday-loader').hide();
                    $('#birthday-content').show();
                    console.error("Error loading anniversary data:", error);
                    $('#todayAnniversaries').html('<div style="color: #999; font-style: italic; font-size: 11px;">No anniversaries today</div>');
                    $('#upcomingAnniversaries').html('<div style="color: #999; font-style: italic; font-size: 11px;">No upcoming anniversaries</div>');
                }
            });
        }

      function displayBirthdayData(data) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const todayBirthdays = [];
        const upcomingBirthdays = [];

        data.forEach(person => {
            const birthDate = new Date(person.date);
            const birthMonth = birthDate.getMonth();
            const birthDay = birthDate.getDate();
            const todayMonth = today.getMonth();
            const todayDay = today.getDate();

            if (birthMonth === todayMonth && birthDay === todayDay) {
                todayBirthdays.push(person);
            } else {
                // Calculate next birthday
                const thisYear = today.getFullYear();
                const nextBirthday = new Date(thisYear, birthMonth, birthDay);

                if (nextBirthday < today) {
                    nextBirthday.setFullYear(thisYear + 1);
                }

                const daysDiff = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));

                // Only show upcoming birthdays within next 30 days
                if (daysDiff > 0 && daysDiff <= 30) {
                    person.daysDiff = daysDiff;
                    person.nextBirthdayDate = nextBirthday;
                    upcomingBirthdays.push(person);
                }
            }
        });

        // Display today's birthdays
        displayTodaysBirthdays(todayBirthdays);

        // Sort upcoming birthdays by date
        upcomingBirthdays.sort((a, b) => a.nextBirthdayDate - b.nextBirthdayDate);

        // Display upcoming birthdays grouped by date
        displayUpcomingBirthdays(upcomingBirthdays);
    }
        function displayAnniversaryData(data) {
            const today = new Date();
            const todayAnniversaries = [];
            const upcomingAnniversaries = [];

            data.forEach(person => {
                const anniversaryDate = new Date(person.date);
                const anniversaryMonth = anniversaryDate.getMonth();
                const anniversaryDay = anniversaryDate.getDate();
                const todayMonth = today.getMonth();
                const todayDay = today.getDate();

                if (anniversaryMonth === todayMonth && anniversaryDay === todayDay) {
                    todayAnniversaries.push(person);
                } else {
                    // Only show upcoming anniversaries within next 30 days
                    const thisYear = today.getFullYear();
                    const nextAnniversary = new Date(thisYear, anniversaryMonth, anniversaryDay);
                    if (nextAnniversary < today) {
                        nextAnniversary.setFullYear(thisYear + 1);
                    }
                    const daysDiff = Math.ceil((nextAnniversary - today) / (1000 * 60 * 60 * 24));
                    if (daysDiff <= 30) {
                        person.daysDiff = daysDiff;
                        person.nextAnniversaryDate = nextAnniversary;
                        upcomingAnniversaries.push(person);
                    }
                }
            });

            // Display today's anniversaries
            displayTodaysAnniversaries(todayAnniversaries);

            // Display upcoming anniversaries grouped by date
            displayUpcomingAnniversaries(upcomingAnniversaries);
        }

        function displayTodaysBirthdays(todayBirthdays) {
            if (todayBirthdays.length > 0) {
                let todayHtml = '';
                todayBirthdays.forEach(person => {
                    todayHtml += createPersonCard(person, 'birthday', false);
                });
                $('#todayBirthdays').html(todayHtml);
            } else {
                $('#todayBirthdays').html('<div style="color: #999; font-style: italic; font-size: 11px;">No birthdays today</div>');
            }
        }

        function displayUpcomingBirthdays(upcomingBirthdays) {
            if (upcomingBirthdays.length > 0) {
                // Sort by date
                upcomingBirthdays.sort((a, b) => new Date(a.nextBirthdayDate) - new Date(b.nextBirthdayDate));

                // Group by date
                const groupedByDate = {};
                upcomingBirthdays.forEach(person => {
                    const dateKey = person.nextBirthdayDate.toDateString();
                    if (!groupedByDate[dateKey]) {
                        groupedByDate[dateKey] = [];
                    }
                    groupedByDate[dateKey].push(person);
                });

                let upcomingHtml = '';
                Object.keys(groupedByDate).forEach(dateKey => {
                    const persons = groupedByDate[dateKey];
                    const date = persons[0].nextBirthdayDate;
                    const dateStr = `Date : ${date.getDate()}-${getMonthName(date.getMonth()).toUpperCase()}`;

                    upcomingHtml += `<div style="font-weight: bold; margin: 12px 0 5px 0; font-size: 11px; color: #333;">${dateStr}</div>`;


                    persons.forEach(person => {
                     upcomingHtml += createPersonCard(person, 'birthday', false, person.employeeProfileUrl);
                    });
                });
                $('#upcomingBirthdays').html(upcomingHtml);
            } else {
                $('#upcomingBirthdays').html('<div style="color: #999; font-style: italic; font-size: 11px;">No upcoming birthdays</div>');
            }
        }

    async function showAttendancePopup(BranchId, BranchName) {
        const shiftsResponse = await fetchShiftData();
        const response = await fetchTodaysAttendance(BranchId, 0, CompanyId);
        if (response.isSuccess && response.data) {
            let currentData = response.data;
            const popup = $("#attendancePopup").dxPopup({
                title: "Today's Attendance Summary",
                width: 900,
                height: 720,
                maxWidth: "95vw",
                maxHeight: "90vh",
                showTitle: true,
                resizeEnabled: true,
                contentTemplate: function(container) {
                    // Create main container with better spacing
                    const mainContainer = $("<div>").css({
                        "padding": "10px",
                        "height": "calc(100% - 20px)",
                        "background": "#fafafa",
                        "font-family": "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                    });

                    // Compact filter section
                    const filterContainer = $("<div>").css({
                        "padding": "8px 12px",
                        "margin-bottom": "10px",
                        "display": "flex",
                        "align-items": "center",
                        "justify-content": "flex-start",
                        "gap": "8px",
                        "background": "white",
                        "border-radius": "6px",
                        "box-shadow": "0 1px 3px rgba(0,0,0,0.1)"
                    });

                    $("<label>").text("Shift:").css({
                        "font-weight": "600",
                        "font-size": "13px",
                        "color": "#555",
                        "min-width": "40px"
                    }).appendTo(filterContainer);

                    const shiftDropdown = $("<div>").attr("id", "shiftFilterDropdown").appendTo(filterContainer);
                    const goButton = $("<div>").attr("id", "filterGoButton").appendTo(filterContainer);
                    filterContainer.appendTo(mainContainer);

                    // Summary cards section - more compact
                    const summaryContainer = $("<div>")
                        .attr("id", "attendanceSummary")
                        .css({
                            "display": "grid",
                            "grid-template-columns": "repeat(auto-fit, minmax(80px, 1fr))",
                            "gap": "8px",
                            "margin-bottom": "12px",
                            "font-size": "12px"
                        })
                        .appendTo(mainContainer);

                    // Compact grid container
                    const gridContainer = $("<div>")
                        .attr("id", "attendanceDataGrid")
                        .css({
                            "margin-bottom": "12px",
                            "height": "250px",
                            "background": "white",
                            "border-radius": "6px",
                            "box-shadow": "0 1px 3px rgba(0,0,0,0.1)"
                        })
                        .appendTo(mainContainer);

                    // Chart section - side by side layout
                    const chartSection = $("<div>").css({
                        "display": "grid",
                        "grid-template-columns": "280px 1fr",
                        "gap": "12px",
                        "height": "220px",
                        "margin-top": "10px",
                        "margin-bottom": "10px"
                    });

                    // Legend container (left side)
                    const legendContainer = $("<div>").css({
                        "background": "white",
                        "border-radius": "6px",
                        "padding": "10px",
                        "box-shadow": "0 1px 3px rgba(0,0,0,0.1)",
                        "overflow": "hidden"
                    }).appendTo(chartSection);

                    const legendTitle = $("<h5>").text("Status Legend").css({
                        "margin": "0 0 8px 0",
                        "font-size": "14px",
                        "font-weight": "600",
                        "color": "#333"
                    }).appendTo(legendContainer);

                    const legendItems = $("<div>").attr("id", "legendItems").css({
                        "display": "grid",
                        "grid-template-columns": "1fr 1fr",
                        "gap": "8px",
                        "font-size": "12px"
                    }).appendTo(legendContainer);

                    // Chart container (right side)
                    const chartContainer = $("<div>").css({
                        "background": "white",
                        "border-radius": "6px",
                        "padding": "8px",
                        "display": "flex",
                        "flex-direction": "column",
                        "align-items": "center",
                        "justify-content": "center",
                        "box-shadow": "0 1px 3px rgba(0,0,0,0.1)",
                        "height": "100%"
                    }).appendTo(chartSection);

                    const chartTitle = $("<h5>").text("Distribution").css({
                        "margin": "0 0 8px 0",
                        "font-size": "14px",
                        "font-weight": "600",
                        "color": "#333"
                    }).appendTo(chartContainer);

                    const chartDiv = $("<div>")
                        .attr("id", "attendanceChart")
                        .css({
                            "height": "170px",
                            "width": "170px",
                            "margin": "0 auto",
                            "flex-shrink": "0"
                        })
                        .appendTo(chartContainer);

                    chartSection.appendTo(mainContainer);

                    // Initialize compact dropdown
                    let shiftOptions = [{ shiftID: 0, shiftName: "--All Shifts--" }];
                    if (shiftsResponse.isSuccess && shiftsResponse.data) {
                        shiftOptions = shiftOptions.concat(shiftsResponse.data.map(shift => ({
                            shiftID: shift.shiftID,
                            shiftName: shift.shiftName
                        })));
                    }

                    shiftDropdown.dxSelectBox({
                        dataSource: shiftOptions,
                        displayExpr: "shiftName",
                        valueExpr: "shiftID",
                        value: 0,
                        width: 160,
                        height: 32
                    });

                    goButton.dxButton({
                        text: "Apply",
                        type: "default",
                        width: 80,
                        height: 34,
                        onClick: async function() {
                            const selectedShiftId = shiftDropdown.dxSelectBox("option", "value");
                            const newResponse = await fetchTodaysAttendance(BranchId, selectedShiftId, CompanyId);

                            if (newResponse.isSuccess && newResponse.data) {
                                currentData = newResponse.data;
                                updateGridAndChart(currentData);
                            } else {
                                DevExpress.ui.notify("No data found for selected shift.", "warning", 2000);
                            }
                        }
                    });

                    // Grid and chart update function
                    function updateGridAndChart(data) {
                        // Update compact grid
                        gridContainer.dxDataGrid({
                            dataSource: data,
                            columns: [
                                {
                                    dataField: "employeeCode",
                                    caption: "Code",
                                    width: 100,
                                    alignment: "center"
                                },
                                {
                                    dataField: "fullName",
                                    caption: "Employee Name",
                                    minWidth: 200,
                                    alignment: "left"
                                },
                                {
                                    dataField: "employeeTypeName",
                                    caption: "Type",
                                    width: 100,
                                    alignment: "center"
                                },
                                {
                                    dataField: "attendanceStatus",
                                    caption: "Status",
                                    width: 100,
                                    alignment: "center",
                                    cellTemplate: function(container, options) {
                                        const status = options.value;
                                        let color, text, bgColor;
                                        switch(status) {
                                            case "P": color = "white"; bgColor = "#1f77b4"; text = "P"; break;
                                            case "A": color = "white"; bgColor = "#d62728"; text = "A"; break;
                                            case "L": color = "white"; bgColor = "#ff7f0e"; text = "L"; break;
                                            case "HF": color = "white"; bgColor = "#2ca02c"; text = "HF"; break;
                                            case "H": color = "white"; bgColor = "#17a2b8"; text = "H"; break;
                                            case "W": color = "white"; bgColor = "#9467bd"; text = "W"; break;
                                            case "LWP": color = "white"; bgColor = "#ff6b35"; text = "LWP"; break;
                                            default: color = "white"; bgColor = "#6c757d"; text = status; break;
                                        }
                                        $("<div>")
                                            .text(text)
                                            .css({
                                                "color": color,
                                                "background": bgColor,
                                                "padding": "4px 8px",
                                                "border-radius": "18px",
                                                "font-weight": "600",
                                                "font-size": "11px",
                                                "display": "inline-block",
                                                "min-width": "24px",
                                                "text-align": "center",
                                                "width": "28px",
                                                "height": "28px",
                                                "line-height": "20px"
                                            })
                                            .appendTo(container);
                                    }
                                }
                            ],
                            showBorders: true,
                            columnAutoWidth: true,
                            paging: {
                                enabled: false
                            },
                            scrolling: {
                                mode: "standard",
                                useNative: true,
                                showScrollbar: "always"
                            },
                            height: 250,
                            headerFilter: { visible: false },
                            export: {
                                enabled: false  // Disable built-in export to avoid duplicate icons
                            },
                            onToolbarPreparing: function(e) {
                                // Add title to toolbar
                                e.toolbarOptions.items.unshift({
                                    location: "before",
                                    template: function() {
                                        return $("<div>").css({
                                            "font-weight": "600",
                                            "color": "#333",
                                            "font-size": "14px"
                                        }).text(`${BranchName} - Employee List`);
                                    }
                                });

                                e.toolbarOptions.items.push({
                                    location: "after",
                                    widget: "dxButton",
                                    options: {
                                        icon: "exportxlsx",
                                        text: "Export Excel",
                                        type: "normal",
                                        elementAttr: {
                                            class: "green-export-btn"
                                        },
                                        onClick: function() {
                                            exportToExcel(data, BranchName);
                                        }
                                    }
                                });
                            }
                        });

                        // Calculate summary data
                        const summary = calculateSummary(data);

                        // Update compact summary cards
                        summaryContainer.empty();
                        const summaryItems = [
                            { label: "Present", value: summary.present, color: "#1f77b4" },
                            { label: "Absent", value: summary.absent, color: "#d62728" },
                            { label: "Leave", value: summary.leave, color: "#ff7f0e" },
                            { label: "Half Day", value: summary.halfDay, color: "#2ca02c" },
                            { label: "Week Off", value: summary.weekOff, color: "#9467bd" },
                            { label: "Total", value: data.length, color: "#333" }
                        ];

                        summaryItems.forEach(item => {
                            const card = $("<div>").css({
                                "background": "white",
                                "border-radius": "6px",
                                "padding": "8px",
                                "text-align": "center",
                                "box-shadow": "0 1px 3px rgba(0,0,0,0.1)",
                                "border-left": `3px solid ${item.color}`
                            });

                            $("<div>").text(item.value).css({
                                "font-size": "16px",
                                "font-weight": "700",
                                "color": item.color,
                                "margin-bottom": "2px"
                            }).appendTo(card);

                            $("<div>").text(item.label).css({
                                "font-size": "11px",
                                "color": "#666",
                                "font-weight": "500"
                            }).appendTo(card);

                            card.appendTo(summaryContainer);
                        });

                        // Update compact legend
                        legendItems.empty();
                        const legendData = [
                            { text: "PRESENT", color: "#1f77b4", short: "P" },
                            { text: "ABSENT", color: "#d62728", short: "A" },
                            { text: "LEAVE", color: "#ff7f0e", short: "L" },
                            { text: "Half Day", color: "#2ca02c", short: "HF" },
                            { text: "WEEK OFF", color: "#9467bd", short: "W" },
                            { text: "HOLIDAY", color: "#17a2b8", short: "H" }
                        ];

                        legendData.forEach(item => {
                            const legendItem = $("<div>").css({
                                "display": "flex",
                                "align-items": "center",
                                "gap": "6px"
                            });

                            $("<div>").css({
                                "width": "12px",
                                "height": "12px",
                                "background-color": item.color,
                                "border-radius": "2px",
                                "flex-shrink": "0"
                            }).appendTo(legendItem);

                            $("<span>").text(item.text).css({
                                "font-size": "11px",
                                "font-weight": "500",
                                "color": "#555"
                            }).appendTo(legendItem);

                            legendItem.appendTo(legendItems);
                        });

                        // Update compact doughnut chart
                        const chartData = getChartDataForDoughnut(data);
                        chartDiv.dxPieChart({
                            dataSource: chartData,
                            series: [{
                                argumentField: "status",
                                valueField: "count",
                                colorField: "color"
                            }],
                            innerRadius: 0.65,
                            legend: { visible: false },
                            tooltip: {
                                enabled: true,
                                customizeTooltip: function(arg) {
                                    return {
                                        text: `${arg.argumentText}: ${arg.valueText} (${Math.round(arg.percent)}%)`
                                    };
                                }
                            },
                            size: {
                                height: 170,
                                width: 170
                            }
                        });
                    }

                    // Calculate summary function
                    function calculateSummary(data) {
                        const summary = {
                            present: 0,
                            absent: 0,
                            leave: 0,
                            halfDay: 0,
                            weekOff: 0,
                            holiday: 0,
                            lwp: 0
                        };

                        data.forEach(item => {
                            switch(item.attendanceStatus) {
                                case "P": summary.present++; break;
                                case "A": summary.absent++; break;
                                case "L": summary.leave++; break;
                                case "HF": summary.halfDay++; break;
                                case "W": summary.weekOff++; break;
                                case "H": summary.holiday++; break;
                                case "LWP": summary.lwp++; break;
                            }
                        });

                        return summary;
                    }

                    // Chart data for doughnut
                    function getChartDataForDoughnut(data) {
                        const summary = calculateSummary(data);
                        const chartData = [];

                        if (summary.present > 0) {
                            chartData.push({ status: "Present", count: summary.present, color: "#1f77b4" });
                        }
                        if (summary.absent > 0) {
                            chartData.push({ status: "Absent", count: summary.absent, color: "#d62728" });
                        }
                        if (summary.leave > 0) {
                            chartData.push({ status: "Leave", count: summary.leave, color: "#ff7f0e" });
                        }
                        if (summary.halfDay > 0) {
                            chartData.push({ status: "Half Day", count: summary.halfDay, color: "#2ca02c" });
                        }
                        if (summary.weekOff > 0) {
                            chartData.push({ status: "Week Off", count: summary.weekOff, color: "#9467bd" });
                        }
                        if (summary.holiday > 0) {
                            chartData.push({ status: "Holiday", count: summary.holiday, color: "#17a2b8" });
                        }

                        return chartData;
                    }

                    updateGridAndChart(currentData);
                    return mainContainer;
                }

            }).dxPopup("instance");

            popup.show();
        } else {
            DevExpress.ui.notify("No attendance data found for this branch.", "error", 3000);
        }
    }

    // Enhanced manual export function with better status text conversion
    function exportToExcel(data, branchName) {
        try {
            // Check if XLSX library is available
            if (typeof XLSX === 'undefined') {
                // Fallback: Use DevExpress built-in export
                const gridInstance = $("#attendanceDataGrid").dxDataGrid("instance");
                if (gridInstance) {
                    gridInstance.exportToExcel();
                } else {
                    DevExpress.ui.notify("Export functionality not available. Please try again.", "error", 3000);
                }
                return;
            }

            // Create workbook and worksheet
            const workbook = XLSX.utils.book_new();

            // Add summary data
            const currentDate = new Date().toLocaleDateString();
            const summary = calculateSummaryForExport(data);

            // Prepare header data
            const headerData = [
                [`${branchName} - Today's Attendance Report`],
                [`Date: ${currentDate}`],
                [`Total Employees: ${data.length}`],
                [''],
                ['Summary:'],
                [`Present: ${summary.present}`, `Absent: ${summary.absent}`, `Leave: ${summary.leave}`, `Half Day: ${summary.halfDay}`, `Week Off: ${summary.weekOff}`, `Holiday: ${summary.holiday}`],
                [''],
                ['Employee Details:']
            ];

            // Prepare employee data for Excel
            const excelData = data.map(item => ({
                'Employee Code': item.employeeCode || '',
                'Employee Name': item.fullName || '',
                'Employee Type': item.employeeTypeName || '',
                'Attendance Status': getStatusText(item.attendanceStatus),
                'Department': item.departmentName || '',
                'Designation': item.designationName || '',
                'Shift': item.shiftName || ''
            }));

            // Create worksheet with headers
            const worksheet = XLSX.utils.aoa_to_sheet(headerData);

            // Add employee data starting from row 9
            XLSX.utils.sheet_add_json(worksheet, excelData, {
                origin: 'A9',
                skipHeader: false
            });

            // Set column widths
            const columnWidths = [
                { wch: 15 }, // Employee Code
                { wch: 30 }, // Employee Name
                { wch: 15 }, // Employee Type
                { wch: 18 }, // Attendance Status
                { wch: 20 }, // Department
                { wch: 20 }, // Designation
                { wch: 15 }  // Shift
            ];
            worksheet['!cols'] = columnWidths;

            // Style the header cells (if styling is supported)
            const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
            for (let row = 0; row < 8; row++) {
                for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    if (worksheet[cellAddress]) {
                        worksheet[cellAddress].s = {
                            font: { bold: true, sz: 12 },
                            fill: { fgColor: { rgb: "E6E6E6" } }
                        };
                    }
                }
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Attendance Report');

            // Generate filename with current date and time
            const currentDateTime = new Date();
            const dateStr = currentDateTime.toISOString().split('T')[0];
            const timeStr = currentDateTime.toTimeString().split(' ')[0].replace(/:/g, '-');
            const filename = `Attendance_${branchName.replace(/[^a-zA-Z0-9]/g, '_')}_${dateStr}_${timeStr}.xlsx`;

            // Save file
            XLSX.writeFile(workbook, filename);

            // Show success message
            DevExpress.ui.notify("Excel file downloaded successfully!", "success", 3000);

        } catch (error) {
            console.error("Error exporting to Excel:", error);
            DevExpress.ui.notify("Error exporting to Excel. Please try again.", "error", 3000);

            // Fallback to DevExpress export if available
            try {
                const gridInstance = $("#attendanceDataGrid").dxDataGrid("instance");
                if (gridInstance) {
                    gridInstance.exportToExcel();
                }
            } catch (fallbackError) {
                console.error("Fallback export also failed:", fallbackError);
            }
        }
    }

    // Helper function to get readable status text
    function getStatusText(status) {
        const statusMap = {
            'P': 'Present',
            'A': 'Absent',
            'L': 'Leave',
            'HF': 'Half Day',
            'H': 'Holiday',
            'W': 'Week Off',
            'LWP': 'Leave Without Pay'
        };
        return statusMap[status] || status;
    }

    // Helper function to calculate summary for export
    function calculateSummaryForExport(data) {
        const summary = {
            present: 0,
            absent: 0,
            leave: 0,
            halfDay: 0,
            weekOff: 0,
            holiday: 0,
            lwp: 0
        };

        data.forEach(item => {
            switch(item.attendanceStatus) {
                case "P": summary.present++; break;
                case "A": summary.absent++; break;
                case "L": summary.leave++; break;
                case "HF": summary.halfDay++; break;
                case "W": summary.weekOff++; break;
                case "H": summary.holiday++; break;
                case "LWP": summary.lwp++; break;
            }
        });

        return summary;
    }


        function displayTodaysAnniversaries(todayAnniversaries) {
            if (todayAnniversaries.length > 0) {
                let todayHtml = '';
                todayAnniversaries.forEach(person => {
                    todayHtml += createPersonCard(person, 'anniversary', false);
                });
                $('#todayAnniversaries').html(todayHtml);
            } else {
                $('#todayAnniversaries').html('<div style="color: #999; font-style: italic; font-size: 11px;">No anniversaries today</div>');
            }
        }

        function displayUpcomingAnniversaries(upcomingAnniversaries) {
            if (upcomingAnniversaries.length > 0) {
                // Sort by date
                upcomingAnniversaries.sort((a, b) => new Date(a.nextAnniversaryDate) - new Date(b.nextAnniversaryDate));

                // Group by date
                const groupedByDate = {};
                upcomingAnniversaries.forEach(person => {
                    const dateKey = person.nextAnniversaryDate.toDateString();
                    if (!groupedByDate[dateKey]) {
                        groupedByDate[dateKey] = [];
                    }
                    groupedByDate[dateKey].push(person);
                });

                let upcomingHtml = '';
                Object.keys(groupedByDate).forEach(dateKey => {
                    const persons = groupedByDate[dateKey];
                    const date = persons[0].nextAnniversaryDate;
                    const dateStr = `Date : ${date.getDate()}-${getMonthName(date.getMonth()).toUpperCase()}`;

                    upcomingHtml += `<div style="font-weight: bold; margin: 12px 0 5px 0; font-size: 11px; color: #333;">${dateStr}</div>`;

                    persons.forEach(person => {
                         upcomingHtml += createPersonCard(person, 'birthday', false, person.employeeProfileUrl);
                    });
                });
                $('#upcomingAnniversaries').html(upcomingHtml);
            } else {
                $('#upcomingAnniversaries').html('<div style="color: #999; font-style: italic; font-size: 11px;">No upcoming anniversaries</div>');
            }
        }

         function createPersonCard(person, type, showAge) {
            const age = type === 'birthday' ? (person.ageInYears || calculateAge(person.date)) : calculateWorkYears(person.date);

            return `
                <div class="person-card"
                     style="display: flex; justify-content: space-between; align-items: center; margin: 6px 0; padding: 6px 8px; background: #f8f9fa; border-radius: 4px; position: relative; font-size: 11px;"
                     onmouseenter="showProfilePopup(event, '${person.id}', '${person.fullName}', '${person.designationName || ''}', '${person.departmentName || ''}', '${person.employeeProfileUrl || ''}')"
                     onmouseleave="hideProfilePopup()">
                    <div style="flex: 1;">
                        <div style="color: #333; font-weight: 500; font-size: 11px;">${person.fullName}</div>
                        <div style="color: #666; font-size: 10px;">${person.branchName}</div>
                    </div>
                </div>
            `;
        }



        function calculateWorkYears(joiningDate) {
            const joining = new Date(joiningDate);
            const today = new Date();
            let years = today.getFullYear() - joining.getFullYear();
            const monthDiff = today.getMonth() - joining.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < joining.getDate())) {
                years--;
            }

            return years;
        }

        function getCurrentDate() {
            const today = new Date();
            const day = today.getDate();
            const month = getMonthName(today.getMonth()).toUpperCase();
            return `${day}-${month}`;
        }

        function calculateAge(dateOfBirth) {
            const birth = new Date(dateOfBirth);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }

            return age;
        }

        function getMonthName(monthIndex) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return months[monthIndex];
        }

        // Profile popup functions remain the same
        let profilePopupTimeout;

        function showProfilePopup(event, employeeId, fullName, designation, department, profileImageUrl) {
            clearTimeout(profilePopupTimeout);
            let popup = document.getElementById('profilePopup');

            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'profilePopup';
                popup.style.cssText = `
                    position: fixed;
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    padding: 10px;
                    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
                    z-index: 1000;
                    display: none;
                    min-width: 180px;
                    font-size: 11px;
                    pointer-events: none;
                `;
                document.body.appendChild(popup);
            }

            // Use the profile image if available, otherwise use a default
            let imageSrc = profileImageUrl || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNjY2MiIHN0cm9rZS13aWR0aD0iMSI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiByeD0iMCIgZmlsbD0iI2QyZDFkMSIvPjxwYXRoIGQ9Ik0xMiAxMkw4IDZMMTIgMTBMMCAxMEwxMiAxMHpNMTIgMTZMOCAxMkwxMiAxNkwwIDE2TDEyIDE2eiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==';

            popup.innerHTML = `
                <div style="text-align: center;">
                    <img src="${imageSrc}"
                         style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 8px; object-fit: cover;"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNjY2MiIHN0cm9rZS13aWR0aD0iMSI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiByeD0iMCIgZmlsbD0iI2QyZDFkMSIvPjxwYXRoIGQ9Ik0xMiAxMkw4IDZMMTIgMTBMMCAxMEwxMiAxMHpNMTIgMTZMOCAxMkwxMiAxNkwwIDE2TDEyIDE2eiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg=='"
                         alt="Profile">
                    <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${fullName}</div>
                    <div style="color: #666; font-size: 10px; margin-bottom: 2px;"><strong>Designation:</strong> ${designation}</div>
                    <div style="color: #666; font-size: 10px;"><strong>Department:</strong> ${department}</div>
                    <div style="color: #666; font-size: 10px; margin-top: 4px;"><strong>ID:</strong> ${employeeId}</div>
                </div>
            `;

            // Position the popup near the cursor
            popup.style.left = `${event.clientX + 10}px`;
            popup.style.top = `${event.clientY + 10}px`;
            popup.style.display = 'block';
        }



        function hideProfilePopup() {
            profilePopupTimeout = setTimeout(() => {
                const popup = document.getElementById('profilePopup');
                if (popup) {
                    popup.style.display = 'none';
                }
            }, 200);
        }

        function createProfilePopup() {
            const popup = document.createElement('div');
            popup.id = 'profilePopup';
            popup.style.cssText = `
                position: absolute;
                background: white;
                border: 1px solid #ddd;
                border-radius: 6px;
                padding: 10px;
                box-shadow: 0 3px 8px rgba(0,0,0,0.15);
                z-index: 1000;
                display: none;
                min-width: 180px;
                max-width: 220px;
                font-size: 11px;
            `;
            document.body.appendChild(popup);
            return popup;
        }

        function loadNewJoiningData() {
            $('#newJoiningContent').html(`
                <div id="newJoining-loader" class="text-center" style="display: block;">
                    <img src="@baseDomainUrl/loders/loder.png" style="width: 20px; height: 20px; animation: spin 1s linear infinite;" />
                    <div>Loading...</div>
                </div>
                <div id="newJoining-content" style="display: none;">
                    <div id="newJoiningGrid" class="mt-2"></div>
                </div>
            `);

            // Load new joining data
            $.ajax({
                url: '@baseDomainUrl/api/EmployeeDashBoardAPI/GetRecentJoinedEmployeesForAdmin',
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (response) {
                    $('#newJoining-loader').hide();
                    $('#newJoining-content').show();

                    if (response.isSuccess && response.data && response.data.length > 0) {
                        displayNewJoiningData(response.data);
                    } else {
                        $('#newJoiningGrid').html('<div style="color: #999; font-style: italic; font-size: 11px; text-align: center; padding: 20px;">No recent joinings found</div>');
                    }
                },
                error: function (xhr, status, error) {
                    $('#newJoining-loader').hide();
                    $('#newJoining-content').show();
                    console.error("Error loading new joining data:", error);
                    $('#newJoiningGrid').html('<div style="color: #999; font-style: italic; font-size: 11px; text-align: center; padding: 20px;">Error loading new joining data</div>');
                }
            });
        }



    function displayNewJoiningData(data) {
        // Group employees by company
        const groupedByCompany = {};
        data.forEach(emp => {
            if (!groupedByCompany[emp.companyName]) {
                groupedByCompany[emp.companyName] = [];
            }
            groupedByCompany[emp.companyName].push(emp);
        });

        let gridHtml = '';
        Object.keys(groupedByCompany).forEach(companyName => {
            const employees = groupedByCompany[companyName];

            // Company header
            gridHtml += `<div style="font-weight: bold; margin: 15px 0 8px 0; font-size: 12px; color: #333; background: #E0E5E5; padding: 6px 8px; border-radius: 4px;">${companyName}</div>`;

            // Employee list for this company
            employees.forEach(emp => {
                const joiningDate = new Date(emp.dateOfJoining);
                const formattedDate = `${joiningDate.getDate().toString().padStart(2, '0')}-${(joiningDate.getMonth() + 1).toString().padStart(2, '0')}-${joiningDate.getFullYear()}`;

                gridHtml += `
                    <div class="new-joining-card"
                         style="display: flex; justify-content: space-between; align-items: center; margin: 4px 0; padding: 6px 8px; background: white; border: 1px solid #e9ecef; border-radius: 4px; font-size: 11px;"
                         onmouseenter="showNewJoiningProfilePopup(event, '${emp.employeeCode}', '${emp.fullName}', '${emp.designationName || ''}', '${formattedDate}', '${emp.employeeProfileUrl || ''}')"
                         onmouseleave="hideProfilePopup()">
                        <div style="flex: 1;">
                            <div style="color: #333; font-weight: 500; font-size: 11px;">${emp.fullName}</div>
                            <div style="color: #666; font-size: 10px;">${emp.designationName || 'N/A'}</div>
                        </div>
                        <div style="color: #666; font-size: 10px; text-align: right;">
                            <div>Joined: ${formattedDate}</div>
                        </div>
                    </div>
                `;
            });
        });

        // Apply scrollbar styles to the container
        $('#newJoiningGrid').html(gridHtml).css({
            'max-height': '400px',        // Set maximum height
            'overflow-y': 'auto',         // Enable vertical scrollbar
            'overflow-x': 'hidden',       // Hide horizontal scrollbar
            'padding': '0 6px 0 10px',      // Add padding to prevent content cutoff
            'border': '1px solid #ddd',   // Optional: add border
            'border-radius': '4px',       // Optional: rounded corners
            'background': '#f8f9fa'       // Optional: background color
        });
    }
        // Profile popup function for new joining employees
        function showNewJoiningProfilePopup(event, employeeCode, fullName, designation, joiningDate, profileImageUrl) {
            clearTimeout(profilePopupTimeout);
            let popup = document.getElementById('profilePopup');

            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'profilePopup';
                popup.style.cssText = `
                    position: fixed;
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    padding: 10px;
                    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
                    z-index: 1000;
                    display: none;
                    min-width: 180px;
                    font-size: 11px;
                    pointer-events: none;
                `;
                document.body.appendChild(popup);
            }

            // Use the profile image if available, otherwise use a default
            let imageSrc = profileImageUrl || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNjY2MiIHN0cm9rZS13aWR0aD0iMSI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiByeD0iMCIgZmlsbD0iI2QyZDFkMSIvPjxwYXRoIGQ9Ik0xMiAxMkw4IDZMMTIgMTBMMCAxMEwxMiAxMHpNMTIgMTZMOCAxMkwxMiAxNkwwIDE2TDEyIDE2eiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==';

            popup.innerHTML = `
                <div style="text-align: center;">
                    <img src="${imageSrc}"
                         style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 8px; object-fit: cover;"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNjY2MiIHN0cm9rZS13aWR0aD0iMSI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiByeD0iMCIgZmlsbD0iI2QyZDFkMSIvPjxwYXRoIGQ9Ik0xMiAxMkw4IDZMMTIgMTBMMCAxMEwxMiAxMHpNMTIgMTZMOCAxMkwxMiAxNkwwIDE2TDEyIDE2eiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg=='"
                         alt="Profile">
                    <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${fullName}</div>
                    <div style="color: #666; font-size: 10px; margin-bottom: 2px;"><strong>Designation:</strong> ${designation}</div>
                    <div style="color: #666; font-size: 10px; margin-bottom: 2px;"><strong>Emp Code:</strong> ${employeeCode}</div>
                    <div style="color: #666; font-size: 10px; margin-top: 4px;"><strong>Joining Date:</strong> ${joiningDate}</div>
                </div>
            `;

            // Position the popup near the cursor
            popup.style.left = `${event.clientX + 10}px`;
            popup.style.top = `${event.clientY + 10}px`;
            popup.style.display = 'block';
        }


           function BranchData() {
        $('#grid-loader').addClass('d-flex').show();
        $.ajax({
            type: "GET",
            url: '@baseDomainUrl/api/BranchAPI/GetBranchWiseEmpCount/' + CompanyId,
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (data) {
                if (data.isSuccess && data.data.length > 0) {
                    $("#employeeGrid").dxDataGrid({
                        dataSource: data.data,
                        columns: [
                            {
                                dataField: 'branchName',
                                caption: 'Branch',
                                alignment: 'center',
                                cellTemplate: function(container, options) {
                                    $('<a>')
                                        .text(options.value)
                                        .css({
                                            'color': '#0066cc',
                                            'cursor': 'pointer',
                                            'text-decoration': 'underline'
                                        })
                                        .on('click', function() {
                                            showEmployeeDetailsPopup(options.data.branchId);
                                        })
                                        .appendTo(container);
                                }
                            },
                            { dataField: 'branchName', caption: 'Branch', alignment: 'center' },
                            { dataField: 'totalUsers', caption: 'Total', alignment: 'center' },
                            { dataField: 'joinLastMonth', caption: 'Join (Last Month)', alignment: 'center' },
                            { dataField: 'leftLastMonth', caption: 'Left (Last Month)', alignment: 'center' }
                        ],
                        height: 250,
                        showBorders: true,
                        columnAutoWidth: true,
                        paging: {
                            enabled: false
                        },
                        scrolling: {
                            mode: "standard",
                            useNative: true,
                            showScrollbar: "always"
                        },
                        filterRow: { visible: false, applyFilter: "auto" },
                        headerFilter: { visible: false },
                        groupPanel: { visible: false },
                        summary: {
                            totalItems: [
                                { column: "branchName", summaryType: "count", displayFormat: "Total" },
                                { column: "totalUsers", summaryType: "sum" },
                                { column: "joinLastMonth", summaryType: "sum" },
                                { column: "leftLastMonth", summaryType: "sum" }
                            ]
                        },
                        onContentReady(e) {
                            $('#grid-loader').removeClass('d-flex').hide()
                            const totalRecords = e.component.option("dataSource").length;
                        }
                        // onRowClick: function(e) {

                        //     var branchId = e.data.branchId; // Make sure your data includes branchId
                        //     console.log('branchId', branchId);
                        //     showEmployeeDetailsPopup(branchId);
                        // }
                    });
                } else {
                    // round_error_noti("No record found!");
                    $('#grid-loader').removeClass('d-flex').hide()
                }
            },
            error: function (xhr, status, error) {
                $('#grid-loader').removeClass('d-flex').hide()
                console.error("AJAX Error: ", error);
            }
        });
    }

     // Global variables
    let employeeGridInstance = null;
    let popupInstance = null;

     function showEmployeeDetailsPopup(branchId) {
        $('#grid-loader').addClass('d-flex').show();

        $.ajax({
            type: "GET",
            url: '@baseDomainUrl/api/EmployeeDashBoardAPI/GetBranchNewJoinerDetails/' + CompanyId + '/' + branchId,
            headers: { 'Authorization': 'Bearer ' + Token },
            success: function(data) {
                $('#grid-loader').removeClass('d-flex').hide();

                if (data.isSuccess && data.data && data.data.length > 0) {
                    const branchName = data.data[0].branchName;
                    const popupTitle = `Branch Employee List - ${branchName} (${data.data.length})`;
                    // Pass the title to popup
                    showPopupWithData(data.data, popupTitle);
                } else {
                    // round_error_noti(data.responseMessage || "No employees found for this branch");
                }
            },
            error: function(xhr, status, error) {
                $('#grid-loader').removeClass('d-flex').hide();
                // round_error_noti("Failed to load employee data. Please try again.");
                console.error("AJAX Error:", error, xhr.responseText);
            }
        });
    }

    function showPopupWithData(employeeData, title = "Employee Details") {
        if (!popupInstance) {
            if (!$("#employeeDetailsPopup").length) {
                $("body").append(`
                    <div id="employeeDetailsPopup">
                        <div id="employeeDetailsGrid"></div>
                    </div>
                `);
            }

            // Initialize popup with dynamic title
            popupInstance = $("#employeeDetailsPopup").dxPopup({
                width: 800,
                height: 550,
                title: title,  // Dynamic title set here
                showTitle: true,
                visible: false,
                dragEnabled: true,
                closeOnOutsideClick: true,
                shading: true,
                position: {
                    of: "body",
                    at: "center",
                    my: "center"
                },
                onShown: function() {
                    if (!employeeGridInstance) {
                        initializeGrid(employeeData);
                    }
                }
            }).dxPopup("instance");
        } else {
            // Update title if popup already exists
            popupInstance.option("title", title);
        }

        // Update grid data
        if (employeeGridInstance) {
            employeeGridInstance.option("dataSource", employeeData);
            employeeGridInstance.refresh();
        }

        popupInstance.show();
    }


    function initializeGrid(employeeData) {
        $("#employeeDetailsGrid").dxDataGrid({
            dataSource: employeeData,
            columns: [
                {
                    dataField: 'employeeCode',
                    caption: 'Employee Code',
                    alignment: 'center',
                    width: 130
                },
                {
                    dataField: 'fullName',
                    caption: 'Employee Name',
                    alignment: 'left',
                    width: 210
                },
                {
                    dataField: 'designationName',
                    caption: 'Designation',
                    alignment: 'left',
                    width: 140
                },
                {
                    dataField: 'departmentName',
                    caption: 'Department',
                    alignment: 'left',
                    width: 120
                },
                {
                    dataField: 'joiningDate',
                    caption: 'Joining Date',
                    alignment: 'center',
                    dataType: 'date',
                    format: 'dd-MM-yyyy',
                    width: 120
                }
            ],
            height: 450,
            //showBorders: true,
            //columnAutoWidth: false,
            // paging: {
            //     enabled: true,
            //     pageSize: 10
            // },
            // pager: {
            //     showPageSizeSelector: true,
            //     allowedPageSizes: [10, 20, 50],
            //     showInfo: true
            // },
            // scrolling: {
            //     mode: "standard"
            // },
            showBorders: true,
            columnAutoWidth: true,
            paging: {
                enabled: false
            },
            scrolling: {
                mode: "standard",
                useNative: true,
                showScrollbar: "always"
            },
            noDataText: "No employee details found for this branch"
        });

        employeeGridInstance = $("#employeeDetailsGrid").dxDataGrid("instance");
    }

</script>

<script>

    let currentDate = new Date();
    let currentMonth = currentDate.getMonth(); // Dynamic current month
    let currentYear = currentDate.getFullYear(); // Dynamic current year
    let events = {}; // Store events by date key
    let showingEvents = false;


       $(document).ready(function () {

           initializeEventsGrid();
            $("#postedEventsGridContainer").hide(); // Pehle hide karo
             $("#deleteButtonContainer").hide();
       });

    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];

    const dayHeaders = ['Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'];


    function getCurrentDate() {
        const now = new Date();
        return {
            year: now.getFullYear(),
            month: now.getMonth(),
            date: now.getDate(),
            day: now.getDay()
        };
    }


    function getTodayKey() {
        const today = getCurrentDate();
        return `${today.year}-${(today.month + 1).toString().padStart(2, '0')}-${today.date.toString().padStart(2, '0')}`;
    }

    function formatDateForDisplay(year, month, day) {
        return `${day.toString().padStart(2, '0')}/${(month + 1).toString().padStart(2, '0')}/${year}`;
    }


    function formatDateForStorage(day, month, year) {
        return `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
    }


    function isToday(year, month, day) {
        const today = getCurrentDate();
        return year === today.year && month === today.month && day === today.date;
    }

    // Function to get future date
    function getFutureDate(daysFromToday) {
        const today = new Date();
        const futureDate = new Date(today);
        futureDate.setDate(today.getDate() + daysFromToday);

        return {
            year: futureDate.getFullYear(),
            month: futureDate.getMonth(),
            date: futureDate.getDate(),
            key: `${futureDate.getFullYear()}-${(futureDate.getMonth() + 1).toString().padStart(2, '0')}-${futureDate.getDate().toString().padStart(2, '0')}`
        };
    }

    function initializeCalendar() {
        const current = getCurrentDate();
        currentMonth = current.month;
        currentYear = current.year;

        generateCalendar();

        const eventsList = document.getElementById('eventsList');
        if (eventsList) {
            updateEventsDisplay();
        }
    }

    function generateCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthYear = document.getElementById('monthYear');

        if (!grid || !monthYear) {
            console.error('Calendar elements not found');
            return;
        }

        monthYear.textContent = `${months[currentMonth]} ${currentYear}`;

        // Clear existing content
        grid.innerHTML = '';

        dayHeaders.forEach(day => {
            const header = document.createElement('div');
            header.className = 'day-header';
            header.textContent = day;
            grid.appendChild(header);
        });


        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const daysInMonth = lastDay.getDate();

        let firstDayOfWeek = firstDay.getDay();
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        for (let i = 0; i < firstDayOfWeek; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'day-cell';
            grid.appendChild(emptyCell);
        }

        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'day-cell';
            dayCell.textContent = day;

            // Check if this is today using dynamic function
            if (isToday(currentYear, currentMonth, day)) {
                dayCell.classList.add('today');
            }

            // Check if this date has events
            const dateKey = formatDateForStorage(day, currentMonth, currentYear);
            if (events[dateKey] && events[dateKey].length > 0) {
                dayCell.classList.add('has-event');
            }

            dayCell.onclick = () => openEventModal(day);
            grid.appendChild(dayCell);
        }
    }

    function previousMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        generateCalendar();

        // Check if element exists before updating
        const eventsList = document.getElementById('eventsList');
        if (eventsList) {
            updateEventsDisplay();
        }
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        generateCalendar();

        // Check if element exists before updating
        const eventsList = document.getElementById('eventsList');
        if (eventsList) {
            updateEventsDisplay();
        }
    }

    function getSelectedDateFromModal() {
        const eventDate = document.getElementById('eventDate');
        if (eventDate && eventDate.value) {
            // Convert DD/MM/YYYY to YYYY-MM-DD format for API
            const dateParts = eventDate.value.split('/');
            return `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
        }
        return null;
    }

    function openEventModal(day) {
       
        const dateInput = document.getElementById('eventDate');

        if ( !dateInput) {
            console.error( 'date input element not found');
            return;
        }

        // Use dynamic date formatting function
        const formattedDate = formatDateForDisplay(currentYear, currentMonth, day);
        dateInput.value = formattedDate;

       $('#eventModal').modal('show');

        // Only call updatePostedEvents if element exists
        const postedEventsElement = document.getElementById('postedEvents');
        if (postedEventsElement) {
            updatePostedEvents();
        } else {
            console.warn('postedEvents element not found - skipping updatePostedEvents()');
        }

        // Load events for the selected date
        const selectedDateForAPI = formatDateForStorage(day, currentMonth, currentYear);
        loadEventsForDate(selectedDateForAPI);
    }

    function closeModal() {
       $('#eventModal').modal('show');
            clearForm();
        
    }

    function clearForm() {
        const eventName = document.getElementById('eventName');
        const eventType = document.getElementById('eventType');
        const eventRepeat = document.getElementById('eventRepeat');
        const myEvent = document.getElementById('myEvent');

        if (eventName) eventName.value = '';
        if (eventType) eventType.value = '';
        if (eventRepeat) eventRepeat.value = 'no-repeat';
        if (myEvent) myEvent.checked = true;
    }

    function saveEvent() {
        const eventName = document.getElementById('eventName');
        const eventType = document.getElementById('eventType');
        const eventRepeat = document.getElementById('eventRepeat');
        const eventDate = document.getElementById('eventDate');

        if (!eventName || !eventType || !eventDate) {
            console.error('Required form elements not found');
            return;
        }

        if (!eventName.value.trim() || !eventType.value) {
            Swal.fire({
                icon: 'warning',
                title: 'Missing Fields',
                text: 'Please fill in all required fields',
                confirmButtonText: 'OK',
                width: '350px',
                customClass: {
                    popup: 'small-swal'
                }
            });
            return;
        }

        const dateParts = eventDate.value.split('/');
        const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

        const eventData = {
            EventName: eventName.value.trim(),
            Date: formattedDate,
            EventType: eventType.value,
            Repeat: eventRepeat.value,
            IsMyevent: true,
            IsShowall: false,
            CreatedBy: userId
        };

        // Show loading alert
        Swal.fire({
            title: 'Saving...',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            width: '300px',
            customClass: {
                popup: 'small-swal'
            },
            didOpen: () => {
                Swal.showLoading();
            }
        });

        $.ajax({
            url: '@baseDomainUrl/api/AddEventAPI/CreateEvent',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(eventData),
            success: function(result) {
                Swal.close(); // Close loading alert
                if (result.isSuccess) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Event saved successfully!',
                        confirmButtonText: 'OK',
                        width: '350px',
                        customClass: {
                            popup: 'small-swal'
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            closeModal();
                            clearForm();
                            generateCalendar();

                            // Check if elements exist before updating
                            const eventsList = document.getElementById('eventsList');
                            if (eventsList) {
                                updateEventsDisplay();
                            }

                            const postedEvents = document.getElementById('postedEvents');
                            if (postedEvents) {
                                updatePostedEvents();
                            }

                            // Reload events for current selected date
                            const selectedDate = getSelectedDateFromModal();
                            if (selectedDate) {
                                loadEventsForDate(selectedDate);
                            }
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: result.responseMessage || 'Failed to save event',
                        confirmButtonText: 'OK',
                        width: '350px',
                        customClass: {
                            popup: 'small-swal'
                        }
                    });
                }
            },
            error: function(xhr, status, error) {
                Swal.close(); // Close loading alert

                Swal.fire({
                    icon: 'error',
                    title: 'Network Error!',
                    text: 'Please try again.',
                    confirmButtonText: 'OK',
                    width: '350px',
                    customClass: {
                        popup: 'small-swal'
                    }
                });
            }
        });
    }

    function updateEventsDisplay() {
        const eventsList = document.getElementById('eventsList');

        if (!eventsList) {
            console.warn('eventsList element not found in DOM');
            return;
        }

        const todayKey = getTodayKey(); // Use dynamic function

        let hasEvents = false;
        let eventsHtml = '';

        // Show today's events
        if (events[todayKey] && events[todayKey].length > 0) {
            hasEvents = true;
            events[todayKey].forEach(event => {
                eventsHtml += `
    <div class="event-item">
        <div class="event-date">${event.date}</div>
        <div class="event-name">${event.name}</div>
        <div class="event-type">${event.type}</div>
    </div>
                `;
            });
        }

        for (let i = 1; i <= 7; i++) {
            const futureDate = getFutureDate(i);

            if (events[futureDate.key] && events[futureDate.key].length > 0) {
                hasEvents = true;
                events[futureDate.key].forEach(event => {
                    eventsHtml += `
    <div class="event-item">
        <div class="event-date">${event.date}</div>
        <div class="event-name">${event.name}</div>
        <div class="event-type">${event.type}</div>
    </div>
                    `;
                });
            }
        }

        if (hasEvents) {
            eventsList.innerHTML = eventsHtml;
        } else {
            eventsList.innerHTML = `
    <div class="no-events">No Event Today</div>
    <div class="no-events">No Upcoming Event</div>
            `;
        }
    }

    function updatePostedEvents() {
        const postedEventsDiv = document.getElementById('postedEvents');

        // Strong null check with early return
        if (!postedEventsDiv) {
            console.warn('postedEvents element not found in DOM - function terminated');
            return false;
        }

        let allEvents = [];

        // Collect all events
        Object.keys(events).forEach(dateKey => {
            if (events[dateKey] && Array.isArray(events[dateKey])) {
                events[dateKey].forEach(event => {
                    allEvents.push(event);
                });
            }
        });

        try {
            if (allEvents.length === 0) {
                postedEventsDiv.innerHTML = 'No Record Found';
                postedEventsDiv.className = 'no-record';
            } else {
                let eventsHtml = '';
                allEvents.forEach(event => {
                    eventsHtml += `
    <div class="event-item">
        <div class="event-date">${event.date || 'N/A'}</div>
        <div class="event-name">${event.name || 'N/A'}</div>
        <div class="event-type">${event.type || 'N/A'}</div>
    </div>
                    `;
                });
                postedEventsDiv.innerHTML = eventsHtml;
                postedEventsDiv.className = '';
            }
            return true;
        } catch (error) {
            console.error('Error updating posted events:', error);
            return false;
        }
    }

    // Function to initialize the Events DataGrid
    function initializeEventsGrid() {
        $("#postedEventsGrid").dxDataGrid({
            dataSource: [],
            keyExpr: "eventId",
            columnAutoWidth: true,
            showBorders: true,
            paging: {
                pageSize: 10
            },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [5, 10, 20],
                showInfo: true
            },
            // Multi-selection settings
            selection: {
                mode: "multiple", // Enable multiple row selection
                allowSelectAll: true, // Show "Select All" checkbox in header
                showCheckBoxesMode: "always" // Always show checkboxes
            },
            columns: [
                {
                    dataField: "eventName",
                    caption: "Event Name",
                    width: 80
                },
                {
                    dataField: "date",
                    caption: "Date",
                    dataType: "date",
                    format: "dd/MM/yyyy",
                    width: 90
                },
                {
                    dataField: "eventType",
                    caption: "Type",
                    width: 70
                }
            ],
            onInitialized: function(e) {
                loadEventsData();
            }
        });
    }


      function loadEventsForDate(dateString) {
        $.ajax({
            url: `@baseDomainUrl/api/AddEventAPI/GetAllEvent/${dateString}`,
            type: 'GET',
            contentType: 'application/json',
            success: function(response) {
                const gridInstance = $("#postedEventsGrid").dxDataGrid("instance");
                if (response.isSuccess && response.data && response.data.length > 0) {
                    // Data mila → Grid aur button dikhao
                    $("#postedEventsGridContainer").show();
                    $("#deleteButtonContainer").show();
                    gridInstance.option("dataSource", response.data.map(event => ({
                        ...event,
                        date: event.date ? new Date(event.date) : null
                    }))); // <-- Yahan missing parenthesis tha (ab add kar diya)
                } else {
                    // Data nahi → Sab hide karo
                    $("#postedEventsGridContainer").hide();
                    $("#deleteButtonContainer").hide();
                    gridInstance.option("dataSource", []);
                }
            },
            error: function(xhr, status, error) {
                // Error → Sab hide karo
                $("#postedEventsGridContainer").hide();
                 $("#deleteButtonContainer").hide();
                const gridInstance = $("#postedEventsGrid").dxDataGrid("instance"); // <-- Yahan bhi gridInstance re-declare karna padega
                gridInstance.option("dataSource", []);
                DevExpress.ui.notify(
                    { message: "Failed to load events. Please try again.", width: 300 },
                    "error",
                    3000
                );
                console.error("Error loading events:", error);
            }
        });
    }

    function onDateChange() {
        const selectedDate = getSelectedDateFromModal();
        if (selectedDate) {
            loadEventsForDate(selectedDate);
        }
    }

    function toggleEventsView() {
        showingEvents = !showingEvents;
        if (showingEvents) {
            const eventsList = document.getElementById('eventsList');
            if (eventsList) {
                updateEventsDisplay();
            }
        }
    }

    function goToToday() {
        const current = getCurrentDate();
        currentMonth = current.month;
        currentYear = current.year;
        generateCalendar();

        const eventsList = document.getElementById('eventsList');
        if (eventsList) {
            updateEventsDisplay();
        }
    }


        function deleteSelectedEvents() {
        const gridInstance = $("#postedEventsGrid").dxDataGrid("instance");
        const selectedRowKeys = gridInstance.getSelectedRowKeys();

        // Check if any rows are selected
        if (selectedRowKeys.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'No Selection',
                text: 'Please select at least one event to delete',
                confirmButtonText: 'OK',
                width: '350px',
                customClass: {
                    popup: 'small-swal'
                }
            });
            return;
        }

        // Directly perform delete without confirmation
        performDelete(selectedRowKeys);
    }
    function performDelete(selectedEventIds) {

        const deleteData = {
            Id: selectedEventIds,
            DeletedBy: userId
        };


        $.ajax({
            url: '@baseDomainUrl/api/AddEventAPI/Delete',
            type: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify(deleteData),
            success: function(response) {
                if (response.isSuccess) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: response.responseMessage || 'Events deleted successfully!',
                        confirmButtonText: 'OK',
                        width: '350px',
                        customClass: {
                            popup: 'small-swal'
                        }
                    }).then(() => {
                       const selectedDate = getSelectedDateFromModal();  // Get the date from the modal
                        if (selectedDate) {
                            loadEventsForDate(selectedDate);
                        }
                        generateCalendar();
                        const eventsList = document.getElementById('eventsList');
                        if (eventsList) { updateEventsDisplay(); }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: response.responseMessage || 'Failed to delete events',
                        confirmButtonText: 'OK',
                        width: '350px',
                        customClass: {
                            popup: 'small-swal'
                        }
                    });
                }
            },
            error: function(xhr, status, error) {

                let errorMessage = 'Failed to delete events. Please try again.';

                // Try to parse error response
                if (xhr.responseJSON && xhr.responseJSON.responseMessage) {
                    errorMessage = xhr.responseJSON.responseMessage;
                }

                Swal.fire({
                    icon: 'error',
                    title: 'Network Error!',
                    text: errorMessage,
                    confirmButtonText: 'OK',
                    width: '350px',
                    customClass: {
                        popup: 'small-swal'
                    }
                });

                console.error('Delete error:', error);
            }
        });
    }
     function loadUserEvents() {
        $.ajax({
            url: '@baseDomainUrl/api/AddEventAPI/GetUserEvents/' + userId,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function(response) {
                if (response.isSuccess && response.data && response.data.length > 0) {
                    displayEventsByCategory(response.data);
                } else {
                    $('#eventsList').html(`
                        <div class="no-events">No Event Today</div>
                        <div class="no-events">No Upcoming Event</div>
                    `);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error loading events:", error);
                $('#eventsList').html(`
                    <div class="no-events">Failed to load events</div>
                `);
            }
        });
    }


    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('eventDate');
        if (dateInput) {
            dateInput.addEventListener('change', onDateChange);
        }

        // Initialize calendar when DOM is ready
        initializeCalendar();
    });

    window.onclick = function(event) {
        $('#eventModal').modal('hide');
       
    }

    window.onload = function() {
        // Backup initialization if DOMContentLoaded doesn't fire
        if (document.getElementById('calendarGrid')) {
            initializeCalendar();
        }
    }


    function displayEventsByCategory(events) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Separate events into Today's and Upcoming
        const todaysEvents = [];
        const upcomingEvents = [];

        events.forEach(event => {
            const eventDate = new Date(event.date);
            eventDate.setHours(0, 0, 0, 0);

            if (eventDate.getTime() === today.getTime()) {
                todaysEvents.push(event);
            } else if (eventDate > today) {
                upcomingEvents.push(event);
            }
        });

        // SORT UPCOMING EVENTS BY DATE (ASCENDING)
        upcomingEvents.sort((a, b) => {
            const dateA = new Date(a.date);
            const dateB = new Date(b.date);
            return dateA - dateB;
        });

        let eventsHtml = '';

        // Display Today's Events
        if (todaysEvents.length > 0) {
            eventsHtml += '<div style="background: #5a6b7d; color: white; padding: 8px 12px; font-weight: bold; font-size: 13px; margin-bottom: 8px;">Today\'s Event</div>';
            eventsHtml += groupEventsByDateAndType(todaysEvents);
        } else {
            eventsHtml += '<div class="no-events">No Event Today</div>';
        }

        // Display Upcoming Events (DATE-WISE)
        if (upcomingEvents.length > 0) {
            eventsHtml += '<div style="background: #5a6b7d; color: white; padding: 8px 12px; font-weight: bold; font-size: 13px; margin: 12px 0 8px 0;">Upcoming Event</div>';
            eventsHtml += groupEventsByDateAndType(upcomingEvents);
        } else {
            eventsHtml += '<div class="no-events" style="margin-top: 12px;">No Upcoming Event</div>';
        }

        $('#eventsList').html(eventsHtml);
    }

     // Group events by DATE first, then by TYPE
    function groupEventsByDateAndType(events) {
        // Group by date first
        const groupedByDate = {};

        events.forEach(event => {
            const eventDate = new Date(event.date);
            const dateKey = `${eventDate.getDate().toString().padStart(2, '0')}-${(eventDate.getMonth() + 1).toString().padStart(2, '0')}-${eventDate.getFullYear()}`;

            if (!groupedByDate[dateKey]) {
                groupedByDate[dateKey] = {
                    date: eventDate,
                    events: []
                };
            }
            groupedByDate[dateKey].events.push(event);
        });

        let html = '';

        // Sort dates
        const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
            return groupedByDate[a].date - groupedByDate[b].date;
        });

        // Display events date-wise
        sortedDates.forEach(dateKey => {
            const dateGroup = groupedByDate[dateKey];
            const eventDate = dateGroup.date;
            const day = eventDate.getDate().toString().padStart(2, '0');
            const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const month = monthNames[eventDate.getMonth()];

            // Date Header
            html += `<div style="background: #E0E5E5; color: #333; padding: 6px 10px; font-weight: 600; font-size: 12px; margin: 8px 0 4px 0;">Date: ${day}-${month}</div>`;

            // Group events by type within this date
            const groupedByType = {};
            dateGroup.events.forEach(event => {
                if (!groupedByType[event.eventType]) {
                    groupedByType[event.eventType] = [];
                }
                groupedByType[event.eventType].push(event);
            });

            // Display events by type
            Object.keys(groupedByType).forEach(eventType => {
                html += `<div style="background: #f8f9fa; padding: 4px 10px; font-weight: 500; font-size: 11px; margin: 4px 0; text-transform: capitalize;">${eventType}</div>`;

                groupedByType[eventType].forEach(event => {
                    const fullDate = `${day}/${(eventDate.getMonth() + 1).toString().padStart(2, '0')}/${eventDate.getFullYear()}`;

                    html += `
                        <div class="event-item" style="background: white; margin: 4px 0; padding: 8px 10px; border-radius: 4px; border-left: 4px solid #ff9933; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-weight: 500; color: #333; font-size: 12px; margin-bottom: 3px;">${event.eventName}</div>
                            <div style="color: #666; font-size: 11px;">${fullDate}</div>
                        </div>
                    `;
                });
            });
        });

        return html;
    }

    // Holiday Modal Variables
    let currentHolidayYear = new Date().getFullYear();
    let holidayGridInstance = null;

    // Initialize Holiday Grid
    function initializeHolidayGrid() {
        $("#holidayGrid").dxDataGrid({
            dataSource: [],
            columns: [
                {
                    dataField: "holidayName",
                    caption: "Holiday Name",
                    alignment: "left",
                    width: 200
                },
                {
                    dataField: "fromDate",
                    caption: "From Date",
                    dataType: "date",
                    format: "dd MMM yyyy",
                    alignment: "center",
                    width: 150
                },
                {
                    dataField: "toDate",
                    caption: "To Date",
                    dataType: "date",
                    format: "dd MMM yyyy",
                    alignment: "center",
                    width: 150
                },
                {
                    dataField: "branchName",
                    caption: "Branch",
                    alignment: "left",
                    width: 200
                },
                {
                    dataField: "annualyRepeat",
                    caption: "Annually Repeat",
                    alignment: "center",
                    width: 130,
                    cellTemplate: function(container, options) {
                        const value = options.value === 'Y' || options.value === true ? 'Yes' : 'No';
                        $("<div>").text(value).appendTo(container);
                    }
                }
            ],
            showBorders: true,
            columnAutoWidth: true,
            height: '100%',
            paging: {
                enabled: false
            },
            scrolling: {
                mode: "standard",
                useNative: true,
                showScrollbar: "always"
            },
             searchPanel: {
            visible: true,
            width: 250,
            placeholder: "Search holidays...",
            highlightCaseSensitive: false // Optional: case-insensitive search
        },
            export: {
                enabled: false
          
            }
       
        });

        holidayGridInstance = $("#holidayGrid").dxDataGrid("instance");
    }

    // Load Holidays for Selected Year
    function loadHolidaysForYear(year) {
        if (holidayGridInstance) {
            holidayGridInstance.beginCustomLoading("Loading holidays...");
        }

        $.ajax({
            url: '@baseDomainUrl/api/ReportAPI/GetHolidaysForYear?Year=' + year,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function(response) {
                if (holidayGridInstance) {
                    holidayGridInstance.endCustomLoading();
                }

                if (response.isSuccess && response.data && response.data.length > 0) {
                    holidayGridInstance.option("dataSource", response.data);

                    const recordCount = response.data.length;
                    holidayGridInstance.option("onToolbarPreparing", function(e) {
                        e.toolbarOptions.items.unshift({
                            location: "before",
                            template: function() {
                                return $("<div>").css({
                                    "font-weight": "600",
                                    "color": "#333",
                                    "font-size": "14px"
                                }).text(`Holiday List - ${year} (${recordCount} holidays)`);
                            }
                        });
                    });

                    holidayGridInstance.refresh();
                } else {
                    holidayGridInstance.option("dataSource", []);
                    DevExpress.ui.notify(
                        `No holidays found for year ${year}`,
                        "warning",
                        2000
                    );
                }
            },
            error: function(xhr, status, error) {
                if (holidayGridInstance) {
                    holidayGridInstance.endCustomLoading();
                }
                holidayGridInstance.option("dataSource", []);
                DevExpress.ui.notify(
                    "Failed to load holidays. Please try again.",
                    "error",
                    3000
                );
                console.error("Error loading holidays:", error);
            }
        });
    }

    // Open Holiday Modal
    function openHolidayModal() {
        const modal = document.getElementById('holidayModal');
        if (modal) {
            modal.style.display = 'block';
            currentHolidayYear = new Date().getFullYear();
            document.getElementById('selectedYear').textContent = currentHolidayYear;

            if (!holidayGridInstance) {
                initializeHolidayGrid();
            }

            loadHolidaysForYear(currentHolidayYear);
        }
    }

    // Close Holiday Modal
    function closeHolidayModal() {
        const modal = document.getElementById('holidayModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Yearly Salary Modal Variables
    let currentSalaryYear = new Date().getFullYear();
    let currentYearType = 'financial';
    let salaryChartInstance = null;

    // Define colors for different months
    const monthColors = [
        '#1f77b4', // Blue
        '#ff7f0e', // Orange
        '#2ca02c', // Green
        '#d62728', // Red
        '#9467bd', // Purple
        '#8c564b', // Brown
        '#e377c2', // Pink
        '#7f7f7f', // Gray
        '#bcbd22', // Yellow-Green
        '#17becf', // Cyan
        '#aec7e8', // Light Blue
        '#ffbb78'  // Light Orange
    ];

    // Initialize Year Dropdown
    function initializeSalaryYearDropdown() {
        const dropdown = document.getElementById('salaryYearDropdown');
        const currentYear = new Date().getFullYear();

        dropdown.innerHTML = '';

        for (let i = currentYear - 5; i <= currentYear + 2; i++) {
            const option = document.createElement('option');
            if (currentYearType === 'financial') {
                option.value = `${i}-${i + 1}`;
                option.textContent = `${i}-${i + 1}`;
                if (i === currentYear) {
                    option.selected = true;
                }
            } else {
                option.value = i;
                option.textContent = i;
                if (i === currentYear) {
                    option.selected = true;
                }
            }
            dropdown.appendChild(option);
        }
    }

    // Handle Year Type Change
    function onYearTypeChange() {
        const selectedType = document.querySelector('input[name="yearType"]:checked').value;
        currentYearType = selectedType;
        initializeSalaryYearDropdown();
    }

    // Open Yearly Salary Modal
    function openYearlySalaryModal() {
        const modal = document.getElementById('yearlySalaryModal');
        if (modal) {
            modal.style.display = 'block';
            currentYearType = 'financial';
            document.querySelector('input[name="yearType"][value="financial"]').checked = true;
            initializeSalaryYearDropdown();
            loadSalaryData();
        }
    }

    // Close Yearly Salary Modal
    function closeYearlySalaryModal() {
        const modal = document.getElementById('yearlySalaryModal');
        if (modal) {
            modal.style.display = 'none';
            if (salaryChartInstance) {
                salaryChartInstance.dispose();
                salaryChartInstance = null;
            }
        }
    }

    // Load Salary Data
    function loadSalaryData() {
        const selectedYear = document.getElementById('salaryYearDropdown').value;
        let startYear, endYear;

        if (currentYearType === 'financial') {
            const years = selectedYear.split('-');
            startYear = parseInt(years[0]);
            endYear = parseInt(years[1]);
        } else {
            startYear = parseInt(selectedYear);
            endYear = parseInt(selectedYear);
        }

        $('#salaryChart').html('<div style="display: flex; justify-content: center; align-items: center; height: 100%;"><img src="@baseDomainUrl/loders/loder.png" style="width: 30px; height: 30px; animation: spin 1s linear infinite;" /></div>');
        $('#salaryTable').html('<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #666;">Loading...</div>');

        $.ajax({
            url: `@baseDomainUrl/api/ReportAPI/GetYearlySalaryReportForAdmin?StartYear=${startYear}&EnadYear=${endYear}`,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function(response) {
                if (response.isSuccess && response.data && response.data.length > 0) {
                    displaySalaryChart(response.data);
                    displaySalaryTable(response.data);
                } else {
                    $('#salaryChart').html('<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #999; font-style: italic;">No salary data found</div>');
                    $('#salaryTable').html('<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #999; font-style: italic;">No data available</div>');
                    DevExpress.ui.notify("No salary data found for selected period", "warning", 2000);
                }
            },
            error: function(xhr, status, error) {
                $('#salaryChart').html('<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #d62728;">Error loading data</div>');
                $('#salaryTable').html('<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #d62728;">Error loading data</div>');
                DevExpress.ui.notify("Failed to load salary data. Please try again.", "error", 3000);
                console.error("Error loading salary data:", error);
            }
        });
    }

    // Display Salary Chart with different colors for each bar
    function displaySalaryChart(data) {
        const chartData = data.map((item, index) => ({
            month: item.monthYear || item.monthName,
            netAmount: parseFloat(item.totalNetSalary || 0),
            color: monthColors[index % monthColors.length]
        }));

        if (salaryChartInstance) {
            salaryChartInstance.dispose();
        }

        salaryChartInstance = $("#salaryChart").dxChart({
            dataSource: chartData,
            series: [{
                argumentField: "month",
                valueField: "netAmount",
                name: "Yearly Salary Details",
                type: "bar",
                colorField: "color"
            }],
            argumentAxis: {
                label: {
                    rotationAngle: -45,
                    overlappingBehavior: "rotate",
                    font: {
                        size: 11
                    }
                }
            },
            valueAxis: {
                label: {
                    format: {
                        type: "fixedPoint",
                        precision: 0
                    },
                    font: {
                        size: 11
                    }
                }
            },
            legend: {
                visible: true,
                position: "outside",
                horizontalAlignment: "center",
                verticalAlignment: "bottom",
                font: {
                    size: 12
                }
            },
            tooltip: {
                enabled: true,
                customizeTooltip: function(arg) {
                    return {
                        text: `${arg.argumentText}<br/>Net Amount: ₹${arg.value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                    };
                }
            },
            size: {
                height: '100%'
            }
        }).dxChart("instance");
    }

     // Display Salary Table - Left aligned header with proper spacing
    function displaySalaryTable(data) {
        let tableHtml = `
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead style="position: sticky; top: 0; background: #5a6b7d; color: white; z-index: 1;">
                    <tr>
                        <th style="padding: 8px 10px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600;">Month</th>
                        <th style="padding: 8px 10px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600;">NetAmount</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach((item, index) => {
            const bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
            const netAmount = parseFloat(item.totalNetSalary || 0);

            tableHtml += `
                <tr style="background: ${bgColor};">
                    <td style="padding: 6px 10px; border-bottom: 1px solid #e9ecef; white-space: nowrap;">${item.monthYear || item.monthName}</td>
                    <td style="padding: 6px 10px; text-align: left; border-bottom: 1px solid #e9ecef; font-weight: 500;">${netAmount.toFixed(2)}</td>
                </tr>
            `;
        });

        tableHtml += `
                </tbody>
            </table>
        `;

        $('#salaryTable').html(tableHtml);
    }

    // Close modal on outside click
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('yearlySalaryModal');
        if (event.target === modal) {
            closeYearlySalaryModal();
        }
    });


        // Leave Report Modal Variables
    let leaveChartInstance = null;

    // Define colors for different leave types
    const leaveColors = {
        'Comp-Off Leave': '#1f77b4',      // Blue
        'Half Day': '#ff7f0e',            // Orange
        'LWP': '#d62728',                 // Red
        'Privilege Leave': '#9467bd',     // Purple
        'Casual Leave': '#2ca02c',        // Green
        'Sick Leave': '#8c564b',          // Brown
        'Maternity Leave': '#e377c2',     // Pink
        'Paternity Leave': '#7f7f7f'      // Gray
    };

    // Open Leave Report Modal
    function openLeaveReportModal() {
        const modal = document.getElementById('leaveReportModal');
        if (modal) {
            modal.style.display = 'block';
            loadLeaveReportData();
        }
    }

    // Close Leave Report Modal
    function closeLeaveReportModal() {
        const modal = document.getElementById('leaveReportModal');
        if (modal) {
            modal.style.display = 'none';
            if (leaveChartInstance) {
                leaveChartInstance.dispose();
                leaveChartInstance = null;
            }
        }
    }

    // Load Leave Report Data
    function loadLeaveReportData() {
        $('#leaveChart').html('<div style="display: flex; justify-content: center; align-items: center; height: 100%;"><img src="@baseDomainUrl/loders/loder.png" style="width: 30px; height: 30px; animation: spin 1s linear infinite;" /></div>');
        $('#leaveTable').html('<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #666;">Loading...</div>');

        $.ajax({
            url: '@baseDomainUrl/api/ReportAPI/GetUsedLeavesSummary',
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function(response) {
                if (response.isSuccess && response.data && response.data.length > 0) {
                    displayLeaveChart(response.data);
                    displayLeaveTable(response.data);
                } else {
                    $('#leaveChart').html('<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #999; font-style: italic;">No leave data found</div>');
                    $('#leaveTable').html('<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #999; font-style: italic;">No data available</div>');
                    DevExpress.ui.notify("No leave data found", "warning", 2000);
                }
            },
            error: function(xhr, status, error) {
                $('#leaveChart').html('<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #d62728;">Error loading data</div>');
                $('#leaveTable').html('<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #d62728;">Error loading data</div>');
                DevExpress.ui.notify("Failed to load leave data. Please try again.", "error", 3000);
                console.error("Error loading leave data:", error);
            }
        });
    }
    // Display Leave Chart with different colors for each leave type
    function displayLeaveChart(data) {
        // Define vibrant colors for each bar
        const colors = [
            '#1f77b4',  // Blue
            '#ff7f0e',  // Orange
            '#d62728',  // Red
            '#9467bd',  // Purple
            '#2ca02c',  // Green
            '#8c564b',  // Brown
            '#e377c2',  // Pink
            '#7f7f7f',  // Gray
            '#bcbd22',  // Yellow-Green
            '#17becf'   // Cyan
        ];

        const chartData = data.map((item, index) => ({
            leaveName: item.leaveName,
            totalUsedDays: parseFloat(item.totalUsedDays || 0),
            color: colors[index % colors.length] // Each bar gets different color
        }));

        if (leaveChartInstance) {
            leaveChartInstance.dispose();
        }

        leaveChartInstance = $("#leaveChart").dxChart({
            dataSource: chartData,
            series: [{
                argumentField: "leaveName",
                valueField: "totalUsedDays",
                name: "Leave Used",
                type: "bar",
                label: {
                    visible: true,
                    format: {
                        type: "fixedPoint",
                        precision: 2
                    },
                    font: {
                        size: 12,
                        weight: 500
                    },
                    backgroundColor: 'transparent'
                }
            }],
            customizePoint: function() {
                // Get the index from the data
                const index = this.index;
                return {
                    color: colors[index % colors.length] // Apply different color to each bar
                };
            },
            argumentAxis: {
                label: {
                    rotationAngle: -45,
                    overlappingBehavior: "rotate",
                    font: {
                        size: 11
                    }
                }
            },
            valueAxis: {
                label: {
                    format: {
                        type: "fixedPoint",
                        precision: 0
                    },
                    font: {
                        size: 11
                    }
                },
                title: {
                    text: "Days Used",
                    font: {
                        size: 13,
                        weight: 500
                    }
                }
            },
            legend: {
                visible: false
            },
            title: {
                text: "Leave Summary",
                font: {
                    size: 16,
                    weight: 600
                }
            },
            tooltip: {
                enabled: true,
                customizeTooltip: function(arg) {
                    return {
                        text: `${arg.argumentText}<br/>Used: ${arg.value.toFixed(2)} days`
                    };
                }
            },
            size: {
                height: '100%'
            }
        }).dxChart("instance");
    }
    // Display Leave Table - Left aligned with no total row
    function displayLeaveTable(data) {
        let tableHtml = `
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead style="position: sticky; top: 0; background: #5a6b7d; color: white; z-index: 1;">
                    <tr>
                        <th style="padding: 8px 10px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600;">Leave Name</th>
                        <th style="padding: 8px 10px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600;">Used (Days)</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach((item, index) => {
            const bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
            const used = parseFloat(item.totalUsedDays || 0);

            tableHtml += `
                <tr style="background: ${bgColor};">
                    <td style="padding: 6px 10px; border-bottom: 1px solid #e9ecef; white-space: nowrap;">${item.leaveName}</td>
                    <td style="padding: 6px 10px; text-align: left; border-bottom: 1px solid #e9ecef; font-weight: 500;">${used.toFixed(2)}</td>
                </tr>
            `;
        });

        tableHtml += `
                </tbody>
            </table>
        `;

        $('#leaveTable').html(tableHtml);
    }

    // Close modal on outside click
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('leaveReportModal');
        if (event.target === modal) {
            closeLeaveReportModal();
        }
    });


    let compoffLapseGridInstance = null;

    // Function to open Compoff Lapse Modal
    function openCompoffLapseModal() {
        const modal = document.getElementById('compoffLapseModal');
        if (modal) {
            modal.style.display = 'block';

            // Set current date in the date input
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
            document.getElementById('compoffLapseDate').value = formattedDate;

            // Initialize grid if not already initialized
            if (!compoffLapseGridInstance) {
                initializeCompoffLapseGrid();
            }

            // Load data automatically on modal open
            loadCompoffLapseData();
        }
    }

    // Function to close Compoff Lapse Modal
    function closeCompoffLapseModal() {
        const modal = document.getElementById('compoffLapseModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Function to initialize the grid
    function initializeCompoffLapseGrid() {
        $("#compoffLapseGrid").dxDataGrid({
            dataSource: [],
            columns: [
                {
                    dataField: "employeeCode",
                    caption: "Employee Code",
                    alignment: "center",
                    width: 140
                },
                {
                    dataField: "fullName",
                    caption: "Employee Name",
                    alignment: "left",
                    width: 200
                },
                {
                    dataField: "designationName",
                    caption: "Designation",
                    alignment: "left",
                    width: 150
                },
                {
                    dataField: "forDate",
                    caption: "For Date",
                    dataType: "date",
                    format: "dd/MM/yyyy",
                    alignment: "center",
                    width: 120
                },
                {
                    dataField: "balance",
                    caption: "Balance",
                    alignment: "center",
                    width: 100,
                    dataType: "number",
                    format: {
                        type: "fixedPoint",
                        precision: 2
                    }
                },
                {
                    dataField: "dueDate",
                    caption: "Due Date",
                    dataType: "date",
                    format: "dd/MM/yyyy",
                    alignment: "center",
                    width: 120
                }
            ],
            showBorders: true,
            columnAutoWidth: true,
            height: '100%',
            paging: {
                enabled: false
            },
            scrolling: {
                mode: "standard",
                useNative: true,
                showScrollbar: "always"
            },
     
            export: {
                enabled: false
              
            },
            onToolbarPreparing: function(e) {
                e.toolbarOptions.items.unshift({
                    location: "before",
                    template: function() {
                        return $("<div>").attr("id", "compoffLapseRecordCount").css({
                            "font-weight": "600",
                            "color": "#333",
                            "font-size": "14px"
                        }).text("0 Records Found");
                    }
                });
            }
        });

        compoffLapseGridInstance = $("#compoffLapseGrid").dxDataGrid("instance");
    }

    // Function to load Compoff Lapse data
    function loadCompoffLapseData() {
        const selectedDate = document.getElementById('compoffLapseDate').value;
        const lapseDays = document.getElementById('compoffLapseDays').value;

        // Validate inputs
        if (!selectedDate) {
            DevExpress.ui.notify("Please select a date", "warning", 2000);
            return;
        }

        if (!lapseDays || lapseDays < 1) {
            DevExpress.ui.notify("Please enter valid lapse days", "warning", 2000);
            return;
        }

        // Show loading
        if (compoffLapseGridInstance) {
            compoffLapseGridInstance.beginCustomLoading("Loading...");
        }

        // Make API call
        $.ajax({
            url: `@baseDomainUrl/api/ReportAPI/GetCompoffLapseReminder?SelectedDate=${selectedDate}&LapseDays=${lapseDays}`,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function(response) {
                if (compoffLapseGridInstance) {
                    compoffLapseGridInstance.endCustomLoading();
                }

                if (response.isSuccess && response.data && response.data.length > 0) {
                    // Update grid with data
                    compoffLapseGridInstance.option("dataSource", response.data);

                    // Update record count
                    const recordCount = response.data.length;
                    $("#compoffLapseRecordCount").text(`${recordCount} Record${recordCount > 1 ? 's' : ''} Found`);

                    // DevExpress.ui.notify(`${recordCount} record(s) loaded successfully`, "success", 2000);
                } else {
                    // No data found
                    compoffLapseGridInstance.option("dataSource", []);
                    $("#compoffLapseRecordCount").text("0 Records Found");
                    DevExpress.ui.notify("No records found for selected criteria", "warning", 2000);
                }
            },
            error: function(xhr, status, error) {
                if (compoffLapseGridInstance) {
                    compoffLapseGridInstance.endCustomLoading();
                }

                compoffLapseGridInstance.option("dataSource", []);
                $("#compoffLapseRecordCount").text("0 Records Found");

                DevExpress.ui.notify("Failed to load data. Please try again.", "error", 3000);
                console.error("Error loading compoff lapse data:", error);
            }
        });
    }

    // Close modal on outside click
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('compoffLapseModal');
        if (event.target === modal) {
            closeCompoffLapseModal();
        }
    });  


     let continuousAbsentGridInstance = null;
    let branchDataSource = [];
    let employeeDataSource = [];

    // Function to open Continuous Absent Modal
    function openContinuousAbsentModal() {
        const modal = document.getElementById('continuousAbsentModal');
        if (modal) {
            modal.style.display = 'block';

            // Initialize filters if not already initialized
            if (!continuousAbsentGridInstance) {
                initializeContinuousAbsentFilters();
                initializeContinuousAbsentGrid();
            }

            // Load initial data
            loadBranchesForFilter();
        }
    }

    // Function to close Continuous Absent Modal
    function closeContinuousAbsentModal() {
        const modal = document.getElementById('continuousAbsentModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Function to initialize filters
    function initializeContinuousAbsentFilters() {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth() + 1;
        const currentYear = currentDate.getFullYear();

        // Month Dropdown
        $("#continuousAbsentMonth").dxSelectBox({
            dataSource: [
                { id: 1, name: 'January' },
                { id: 2, name: 'February' },
                { id: 3, name: 'March' },
                { id: 4, name: 'April' },
                { id: 5, name: 'May' },
                { id: 6, name: 'June' },
                { id: 7, name: 'July' },
                { id: 8, name: 'August' },
                { id: 9, name: 'September' },
                { id: 10, name: 'October' },
                { id: 11, name: 'November' },
                { id: 12, name: 'December' }
            ],
            displayExpr: "name",
            valueExpr: "id",
            value: currentMonth,
            searchEnabled: true,
            width: "100%",
            height: 36
        });

        // Year Dropdown
        const years = [];
        for (let i = currentYear - 5; i <= currentYear + 2; i++) {
            years.push({ id: i, name: i.toString() });
        }

        $("#continuousAbsentYear").dxSelectBox({
            dataSource: years,
            displayExpr: "name",
            valueExpr: "id",
            value: currentYear,
            searchEnabled: true,
            width: "100%",
            height: 36
        });

        // Branch TagBox (Multi-select with search)
        $("#continuousAbsentBranch").dxTagBox({
            dataSource: [],
            displayExpr: "branchName",
            valueExpr: "branchId",
            searchEnabled: true,
            placeholder: "Select Branch(es)",
            showSelectionControls: true,
            applyValueMode: "useButtons",
            width: "100%",
            height: 36,
            onValueChanged: function(e) {
                // When branch changes, reload employees
                loadEmployeesForFilter(e.value);
            }
        });

        // Employee TagBox (Multi-select with search)
        $("#continuousAbsentEmployee").dxTagBox({
            dataSource: [],
            displayExpr: "fullName",
            valueExpr: "employeeCode",
            searchEnabled: true,
            placeholder: "Select Employee(s)",
            showSelectionControls: true,
            applyValueMode: "useButtons",
            width: "100%",
            height: 36
        });
    }

    // Function to load branches for filter
    function loadBranchesForFilter() {
        $.ajax({
            type: "GET",
            url: '@baseDomainUrl/api/BranchAPI/GetAllBranchesListByCompanyId/' + CompanyId,
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function(data) {
                if (data.isSuccess && data.data && data.data.length > 0) {
                    branchDataSource = data.data;
                    const branchTagBox = $("#continuousAbsentBranch").dxTagBox("instance");
                    if (branchTagBox) {
                        branchTagBox.option("dataSource", branchDataSource);
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error("Error loading branches:", error);
                DevExpress.ui.notify("Failed to load branches", "error", 2000);
            }
        });
    }

    // Function to load employees based on selected branches
    function loadEmployeesForFilter(selectedBranchIds) {
        if (!selectedBranchIds || selectedBranchIds.length === 0) {
            // If no branch selected, clear employees
            const employeeTagBox = $("#continuousAbsentEmployee").dxTagBox("instance");
            if (employeeTagBox) {
                employeeTagBox.option("dataSource", []);
                employeeTagBox.option("value", []);
            }
            return;
        }

        // Create branch IDs string
        const branchIdsString = selectedBranchIds.join(',');

        $.ajax({
            type: "GET",
            url: '@baseDomainUrl/api/EmployeeAPI/GetEmployeesByBranches',
            data: {
                branchIds: branchIdsString,
                companyId: CompanyId
            },
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function(data) {
                if (data.isSuccess && data.data && data.data.length > 0) {
                    employeeDataSource = data.data;
                    const employeeTagBox = $("#continuousAbsentEmployee").dxTagBox("instance");
                    if (employeeTagBox) {
                        employeeTagBox.option("dataSource", employeeDataSource);
                    }
                } else {
                    const employeeTagBox = $("#continuousAbsentEmployee").dxTagBox("instance");
                    if (employeeTagBox) {
                        employeeTagBox.option("dataSource", []);
                        employeeTagBox.option("value", []);
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error("Error loading employees:", error);
                DevExpress.ui.notify("Failed to load employees", "error", 2000);
            }
        });
    }

    // Function to initialize the grid
    function initializeContinuousAbsentGrid() {
        $("#continuousAbsentGrid").dxDataGrid({
            dataSource: [],
            columns: [
                {
                    dataField: "employeeCode",
                    caption: "Employee Code",
                    alignment: "center",
                    width: 130
                },
                {
                    dataField: "fullName",
                    caption: "Employee Name",
                    alignment: "left",
                    width: 200
                },
                {
                    dataField: "designationName",
                    caption: "Designation",
                    alignment: "left",
                    width: 150
                },
                {
                    dataField: "departmentName",
                    caption: "Department",
                    alignment: "left",
                    width: 150
                },
                {
                    dataField: "branchName",
                    caption: "Branch",
                    alignment: "left",
                    width: 150
                },
                {
                    dataField: "absentDays",
                    caption: "Absent Days",
                    alignment: "center",
                    width: 120,
                    dataType: "number"
                },
                {
                    dataField: "fromDate",
                    caption: "From Date",
                    dataType: "date",
                    format: "dd/MM/yyyy",
                    alignment: "center",
                    width: 120
                },
                {
                    dataField: "toDate",
                    caption: "To Date",
                    dataType: "date",
                    format: "dd/MM/yyyy",
                    alignment: "center",
                    width: 120
                }
            ],
            showBorders: true,
            columnAutoWidth: true,
            height: '100%',
            paging: {
                enabled: false
            },
            scrolling: {
                mode: "standard",
                useNative: true,
                showScrollbar: "always"
            },
            searchPanel: {
                visible: true,
                width: 250,
                placeholder: "Search...",
                highlightCaseSensitive: false
            },
            export: {
                enabled: true,
                allowExportSelectedData: false
            },
            onToolbarPreparing: function(e) {
                e.toolbarOptions.items.unshift({
                    location: "before",
                    template: function() {
                        return $("<div>").attr("id", "continuousAbsentRecordCount").css({
                            "font-weight": "600",
                            "color": "#333",
                            "font-size": "14px"
                        }).text("0 Records Found");
                    }
                });
            }
        });

        continuousAbsentGridInstance = $("#continuousAbsentGrid").dxDataGrid("instance");
    }

    // Function to load Continuous Absent data
    function loadContinuousAbsentData() {
        const monthInstance = $("#continuousAbsentMonth").dxSelectBox("instance");
        const yearInstance = $("#continuousAbsentYear").dxSelectBox("instance");
        const branchInstance = $("#continuousAbsentBranch").dxTagBox("instance");
        const employeeInstance = $("#continuousAbsentEmployee").dxTagBox("instance");

        const selectedMonth = monthInstance.option("value");
        const selectedYear = yearInstance.option("value");
        const selectedBranches = branchInstance.option("value") || [];
        const selectedEmployees = employeeInstance.option("value") || [];

        // Validate inputs
        if (!selectedMonth) {
            DevExpress.ui.notify("Please select a month", "warning", 2000);
            return;
        }

        if (!selectedYear) {
            DevExpress.ui.notify("Please select a year", "warning", 2000);
            return;
        }

        // Show loading
        if (continuousAbsentGridInstance) {
            continuousAbsentGridInstance.beginCustomLoading("Loading...");
        }

        // Prepare API parameters
        const branchIds = selectedBranches.length > 0 ? selectedBranches.join(',') : '0';
        const employeeCodes = selectedEmployees.length > 0 ? selectedEmployees.join(',') : '';

        // Make API call
        $.ajax({
            url: `@baseDomainUrl/api/ReportAPI/GetContinuousAbsentReport`,
            type: 'GET',
            data: {
                Month: selectedMonth,
                Year: selectedYear,
                BranchId: branchIds,
                EmployeeCode: employeeCodes
            },
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function(response) {
                if (continuousAbsentGridInstance) {
                    continuousAbsentGridInstance.endCustomLoading();
                }

                if (response.isSuccess && response.data && response.data.length > 0) {
                    // Update grid with data
                    continuousAbsentGridInstance.option("dataSource", response.data);

                    // Update record count
                    const recordCount = response.data.length;
                    $("#continuousAbsentRecordCount").text(`${recordCount} Record${recordCount > 1 ? 's' : ''} Found`);
                } else {
                    // No data found
                    continuousAbsentGridInstance.option("dataSource", []);
                    $("#continuousAbsentRecordCount").text("0 Records Found");
                    DevExpress.ui.notify("No records found for selected criteria", "warning", 2000);
                }
            },
            error: function(xhr, status, error) {
                if (continuousAbsentGridInstance) {
                    continuousAbsentGridInstance.endCustomLoading();
                }

                continuousAbsentGridInstance.option("dataSource", []);
                $("#continuousAbsentRecordCount").text("0 Records Found");

                DevExpress.ui.notify("Failed to load data. Please try again.", "error", 3000);
                console.error("Error loading continuous absent data:", error);
            }
        });
    }

    // Close modal on outside click
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('continuousAbsentModal');
        if (event.target === modal) {
            closeContinuousAbsentModal();
        }
    });
</script>

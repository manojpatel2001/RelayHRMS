@inject IConfiguration Configuration
@{
	ViewData["Title"] = "Ticket Status";
	Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
	string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
	string UIBaseUrlLayout = Configuration["UIBaseUrlSettings:baseUrl"];
	var uriAPI = new Uri(baseUrl);
	string baseAPIDomainUrl = $"{uriAPI.Scheme}://{uriAPI.Host}:{uriAPI.Port}";
}

<div class="card ">
	<div class="card-header bg-transparent ml-0 py-0">
		<div class="row">
			<div class="col-6">
				<h6 class="pt-2 mb-0">
					Employee Bulk Increment
				</h6>
			</div>

			<div class="col-6 d-flex justify-content-end align-items-center">
				<div class="font-22 pl-2" style="color:#32393f; cursor:pointer;">


					<div>
                        <a href="/AdminPanel/Increment/EmployeeIncrement" type="button"
						   class="btn mr-1 rounded-1"
						   style="background-color:#000; color:white;">Back</a>
					</div>

				</div>
			</div>
		</div>
	</div>


	<div class="card-body">
		<div class="row">
			<div class="col-md-12">

				<div class="grid-wrapper " style="position: relative; " id="gridTag">
					<div id="grid-loader" class="grid-loader justify-content-center align-items-center flex-column "
						 style="display: none;  inset: 0; background: rgba(255,255,255,0.6); z-index: 10; ">
						<img src="@baseAPIDomainUrl/loders/loder.png" class="grid-logo-spinner" style="width: 30px; height: 30px; animation: spin 1s linear infinite;" />
						<div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>

					</div>
					<div class="rowCount" id="rowCount2"></div>
					<div id="GridContainer"></div>
				</div>

			</div>
		</div>
	</div>
</div>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
			const UserId = localStorage.getItem("EmployeeId");
			  var Token=localStorage.getItem("authToken");
		var companyDetails = JSON.parse(localStorage.getItem('selectedCompany'));
		const CompanyId=companyDetails.CompanyId;

		let reasonList=[];

     $(() => {
        BindReasonAndLoadGrid();
    });


      function BindReasonAndLoadGrid() {
        $.ajax({
            url: '@baseUrl/EmployeeIncrementAPI/GetAllIncrementReason',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (response) {

                if (response.isSuccess) {
                    reasonList = response.data || [];
                }

                loadIncrementDataTable();
            }
        });
    }


            let gridInstance = null;

    function loadIncrementDataTable() {

        try {

            // 1️⃣ INITIALIZE GRID FIRST (EMPTY)
            if (!gridInstance) {
                gridInstance = $("#GridContainer").dxDataGrid({
                    dataSource: [],
                    keyExpr: "EmployeeId",
                    showBorders: true,
                    width: "100%",
                    height: 300,

                    loadPanel: {
                        enabled: true,
                        text: "Loading data...",
                        showIndicator: true,
                        showPane: true
                    },

                    paging: { enabled: false },

                    scrolling: {
                        mode: "standard",
                        useNative: false,
                        showScrollbar: "always"
                    },

                    selection: {
                        mode: "multiple",
                        showCheckBoxesMode: "always"
                    },

                    editing: {
                        mode: "cell",
                        allowUpdating: true,
                        selectTextOnEditStart: true
                    },

                    searchPanel: {
                        visible: true,
                        width: 250,
                        placeholder: "Search..."
                    },

                    // 🔥 TOOLBAR WITH SAVE BUTTON (ALL VERSIONS)
                       onToolbarPreparing: function (e) {
                        e.toolbarOptions.items.unshift(
                            {
                                name: "searchPanel",
                                location: "before"
                            },
                            {
                                location: "after",
                                widget: "dxButton",
                                options: {
                                    icon: "refresh",
                                    text: "Refresh",
                                    type: "normal",
                                    onClick: function () {
                                        handleRefreshGrid();
                                    }
                                }
                            },
                            {
                                location: "after",
                                widget: "dxButton",
                                options: {
                                    text: "Save",
                                    icon: "save",
                                    type: "success",
                                    onClick: function (btn) {
                                        handleSaveClick(btn.component);
                                    }
                                }
                            }
                        );
                    },

                        onRowPrepared: function (e) {
                        if (e.rowType === "data" && e.data.__isInvalid) {
                            e.rowElement.css({
                                "background-color": "#fff3f3",
                                "border-left": "4px solid #dc3545"
                            });
                        }
                    },

                    // 🔥 REVALIDATE DEPENDENT FIELDS
                    onCellValueChanged: function (e) {
                        if (
                            e.column.dataField === "NewBasicSalary" ||
                            e.column.dataField === "NewGrossSalary"
                        ) {
                            e.component.validate();
                        }
                    },

                    columns: [
                        { dataField: "EmployeeCode", caption: "Code", width: 80,allowEditing: false },
                        { dataField: "EmployeeName", caption: "Employee Name", width: 220,allowEditing: false },

                        {
                            dataField: "BasicSalary",
                            caption: "Old Basic Salary",
                            format: { type: "fixedPoint", precision: 2 },
                            allowEditing: false
                        },
                        {
                            dataField: "GrossSalary",
                            caption: "Old Gross Salary",
                            format: { type: "fixedPoint", precision: 2 },
                            allowEditing: false
                        },

                        {
                            dataField: "NewBasicSalary",
                            caption: "New Basic Salary",
                            dataType: "number",
                            editorOptions: { min: 0 },
                            validationRules: [
                                { type: "required", message: "New Basic Salary required" },
                                {
                                    type: "custom",
                                    message: "New Basic ≥ Old Basic",
                                    validationCallback: e => e.value == null || e.value >= e.data.BasicSalary
                                }
                            ]
                        },

                        {
                            dataField: "NewGrossSalary",
                            caption: "New Gross Salary",
                            dataType: "number",
                            editorOptions: { min: 0 },
                            validationRules: [
                                { type: "required", message: "New Gross Salary required" },
                                {
                                    type: "custom",
                                    message: "New Gross ≥ Old Gross",
                                    validationCallback: e => e.value == null || e.value >= e.data.GrossSalary
                                },
                                {
                                    type: "custom",
                                    message: "New Gross ≥ New Basic",
                                    validationCallback: e =>
                                        e.value == null || e.data.NewBasicSalary == null ||
                                        e.value >= e.data.NewBasicSalary
                                }
                            ]
                        },

                           {
                                dataField: "EffectiveDate",
                                caption: "Effective Date",
                                dataType: "date",
                                width: 140,
                                format: "dd/MM/yyyy",

                                setCellValue: (row, value) => {
                                    row.EffectiveDate = value ? new Date(value) : null;
                                },

                                editorOptions: {
                                    displayFormat: "dd/MM/yyyy",
                                    disabledDates: e => e.date.getDate() !== 1
                                }
                            },

                          {
                            dataField: "reasonId",
                            caption: "Reason",
                            width: 180,
                            lookup: {
                                dataSource: reasonList,
                                valueExpr: "reasonId",
                                displayExpr: "reasonName"
                            },
                            setCellValue: function (rowData, value) {
                                rowData.reasonId = value; // ✔ keep
                            },
                            validationRules: [
                                { type: "required", message: "Reason is required" }
                            ]
                        }

                    ]
                }).dxDataGrid("instance");
            }

            // 2️⃣ SHOW DEFAULT GRID LOADER
            gridInstance.beginCustomLoading("Loading data...");

            // 3️⃣ AJAX CALL
            $.ajax({
                type: "GET",
                url: '@baseUrl/EmployeeIncrementAPI/GetEmployeeSalaryInfoByCompnayId/' + CompanyId,
                headers: { 'Authorization': 'Bearer ' + Token },

                success: function (response) {

                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

                    if (response.isSuccess && response.data) {
                        response.data.forEach(r => {
                            r.EffectiveDate = r.EffectiveDate
                                ? new Date(r.EffectiveDate)
                                : new Date(firstDay);
                        });
                    }

                    // 4️⃣ SET DATA + HIDE LOADER
                    gridInstance.option("dataSource", response.data || []);
                    gridInstance.endCustomLoading();
                },

                error: function () {
                    gridInstance.endCustomLoading();
                }
            });

        } catch (e) {
            console.error(e);
            if (gridInstance) gridInstance.endCustomLoading();
        }
    }



        
    async function handleSaveClick(saveButton) {
                saveButton.option({ disabled: true, text: "Saving..." });

        const grid = $("#GridContainer").dxDataGrid("instance");

        await grid.saveEditData();
       // grid.refresh();


        const selectedRows = grid.getSelectedRowsData();

        if (!selectedRows || selectedRows.length === 0) {
            DevExpress.ui.notify(
                "Please select at least one employee",
                "warning",
                2000
            );
            resetSaveButton(saveButton);
            return;
        }

        let firstInvalidRowKey = null;

        selectedRows.forEach(r => {
            r.__isInvalid = false;

            if (
                r.NewBasicSalary == null ||
                r.NewGrossSalary == null ||
                r.NewBasicSalary < r.BasicSalary ||
                r.NewGrossSalary < r.GrossSalary ||
                r.NewGrossSalary < r.NewBasicSalary ||
                r.reasonId == null ||
                r.EffectiveDate == null
            ) {
                r.__isInvalid = true;

                if (!firstInvalidRowKey) {
                    firstInvalidRowKey = r.EmployeeId;
                }
            }
        });

        if (firstInvalidRowKey) {
            grid.navigateToRow(firstInvalidRowKey);
            grid.selectRows([firstInvalidRowKey], false);

            DevExpress.ui.notify(
                "Please fill required fields for highlighted rows",
                "error",
                3000
            );

            resetSaveButton(saveButton);
            return;
        }

        const payload = selectedRows.map(r => ({
            employeeId: r.EmployeeId,
            oldBasicSalary: r.BasicSalary,
            oldGrossSalary: r.GrossSalary,
            newBasicSalary: r.NewBasicSalary,
            newGrossSalary: r.NewGrossSalary,
            EffectiveFromDate: r.EffectiveDate
            ? `${r.EffectiveDate.getFullYear()}-${
                String(r.EffectiveDate.getMonth() + 1).padStart(2, '0')
              }-${
                String(r.EffectiveDate.getDate()).padStart(2, '0')
              }`
            : null,

            reasonId: r.reasonId,
            createdBy: UserId
        }));


        try {
            const response = await fetch('@baseUrl/EmployeeIncrementAPI/InsertBulkEmployeeSalaryHistory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const responseData = await response.json();
            if (responseData.isSuccess) {
                round_success_noti(responseData.responseMessage);
                handleRefreshGrid();
            } else {
                round_error_noti(responseData.responseMessage);
            }

        } catch (error) {
            console.error(error);
        }

        resetSaveButton(saveButton);
    }


    function resetSaveButton(saveButton) {
        saveButton.option({
            disabled: false,
            text: "Save"
        });
    }


    function handleRefreshGrid() 
    {

            const grid = $("#GridContainer").dxDataGrid("instance");

                // 1️⃣ Cancel active editors
                grid.cancelEditData();

                // 2️⃣ Clear selection
                grid.clearSelection();

                // 3️⃣ Remove invalid flags
                const items = grid.getDataSource().items();
                items.forEach(r => delete r.__isInvalid);
                //grid.refresh();
      
    }


</script>
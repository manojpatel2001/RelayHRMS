@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Employee Increment";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    string UIBaseUrlLayout = Configuration["UIBaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}


<title>Employee Salary Increment/Decrement</title>
<style>


    .form-container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin: 2px;
    }

    .form-tag {
        background-color: white;
        border-radius: 8px;
        border: 1px solid grey;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
    }

    .form-header {
        background-color: #2c3e50;
        color: white;
        padding: 5px 20px;
        border-radius: 5px 5px 0 0;
        margin: -20px -20px 20px -20px;
    }

    .form-row {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 15px;
        align-items: center;
    }

    .form-group {
        flex: 1;
        min-width: 200px;
        margin-right: 15px;
        margin-bottom: 10px;
    }

    label {
        display: block;
        margin-bottom: 3px;
        font-weight: bold;
    }

    input, select {
        width: 100%;
        padding: 4px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }

    .radio-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-right: 15px;
    }

    .salary-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

        .salary-table th, .salary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .salary-table th {
            background-color: #f2f2f2;
        }

        .salary-table input {
            width: 100%;
        }

    @@media (max-width: 768px) {
        .form-group {
            flex: 100%;
            margin-right: 0;
        }

        .radio-group {
            flex: 100%;
            margin-right: 0;
            margin-bottom: 10px;
        }
    }
</style>


<style>




    .header {
        text-align: center;
        margin-bottom: 30px;
    }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
            margin: 0;
        }

    .table-container {
        margin-bottom: 30px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .section-header {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        font-weight: 600;
        font-size: 1.1em;
        text-align: center;
        padding: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .earnings-header {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
    }

    .deductions-header {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .ctc-header {
        background: linear-gradient(135deg, #8e44ad, #9b59b6);
    }

    th {
        background: linear-gradient(135deg, #34495e, #2c3e50);
        color: white;
        padding: 12px;
        font-weight: 600;
        text-align: left;
        border-bottom: 2px solid #ecf0f1;
    }

    td {
        padding: 12px;
        border-bottom: 1px solid #ecf0f1;
        transition: background-color 0.3s ease;
    }

    /*   tr:hover td {
                            background-color: #f8f9fa;
                        } */

    .component-name {
        color: #2c3e50;
    }



    .fixed {
        color: #27ae60;
        font-weight: 600;
    }

    .variable {
        color: #e67e22;
    }

    .amount {
        font-weight: 600;
        color: #2c3e50;
    }

    .total-row {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
    }

        .total-row td {
            border-bottom: none;
        }

    .net-salary-row {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
    }

    .ctc-row {
        background: linear-gradient(135deg, #8e44ad, #9b59b6);
        color: white;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }

    .summary-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

        .summary-card h4 {
            margin: 0 0 10px 0;
            opacity: 0.9;
        }

        .summary-card .amount {
            font-size: 1.8em;
            font-weight: 700;
            color: white;
        }


    .SalaryContainer {
        margin: 10px;
    }

    table {
        font-size: 0.9em;
    }

    .header h1 {
        font-size: 2em;
    }

    .summary-cards {
        grid-template-columns: 1fr;
    }

</style>




<div class="form-container">
    <div class="form-header">
        <div class="row">
            <div class="col-6">
                <h6 class="pt-2">
                    Add Employee Increment/Decrement
                </h6>
            </div>

            <div class="col-6 d-flex justify-content-end align-items-center">

                <button onclick="window.location.href='/AdminPanel/Increment/EmployeeIncrement';" class="btn  btn-white px-2">
                    Back
                </button>

            </div>
        </div>
    </div>
    <form class="form-tag">
        <div class="form-row ">
            
            <div class="form-group">
                <label for="effectDate">
                    Effect Date <span class="text-danger">*</span>
                </label>

                <input type="date" id="effectDate">

                <div id="spneffectDate" class="text-danger" style="display:none;">
                    
                </div>

            </div>

          
            <div class="form-group">
                <label class="form-label">Employee Name<span class="text-danger">*</span> :</label>
                <div class="form-group-row">
                    <div class="form-floating-custom flex-grow-1">
                        <div class="searchable-select-wrapper" id="ResponsibleWrapper">
                            <input type="text" class="searchable-select-input" id="ddlEmployee" placeholder="Employee Name" readonly>
                            <span class="searchable-select-arrow">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                    <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                </svg>
                            </span>
                            <div class="searchable-select-dropdown">
                                <div class="searchable-select-search">
                                    <input type="text" placeholder="Search employee..." class="search-input">
                                </div>
                                <div class="multi-select-actions">
                                    <button type="button" class="multi-select-btn select-all-btn">Select All</button>
                                    <button type="button" class="multi-select-btn clear-all-btn">Clear All</button>
                                </div>
                                <div class="searchable-select-options"></div>
                            </div>
                        </div>
                        <div class="text-danger " id="spnddlEmployee" style="display:none;">Please select employee</div>
                    </div>
                </div>
            </div>
          

        </div>

        <div class="form-row mt-0">
          
            <div class="form-group">
                <label class="form-label">Reason<span class="text-danger">*</span> :</label>
                <div class="form-group-row">
                    <div class="form-floating-custom flex-grow-1">
                        <div class="searchable-select-wrapper" id="ResponsibleWrapper">
                            <input type="text" class="searchable-select-input" id="ddlReason" placeholder="Reason" readonly>
                            <span class="searchable-select-arrow">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                    <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                </svg>
                            </span>
                            <div class="searchable-select-dropdown">
                                <div class="searchable-select-search">
                                    <input type="text" placeholder="Search reason..." class="search-input">
                                </div>
                                <div class="multi-select-actions">
                                    <button type="button" class="multi-select-btn select-all-btn">Select All</button>
                                    <button type="button" class="multi-select-btn clear-all-btn">Clear All</button>
                                </div>
                                <div class="searchable-select-options"></div>
                            </div>
                        </div>
                        <div class="text-danger " id="spnddlReason" style="display:none;">Please select reason</div>
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-top: 20px; display:none;" id="salaryChange">
            <h6><b>Salary Structure</b></h6>
         
            <table class="salary-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Current</th>
                        <th>New Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Basic Salary</td>
                        <td>
                            <input type="text" id="basicSalary" readonly>
                        </td>
                        <td>
                            <input type="text" id="newBasicSalary" data-decimal>
                            <span class="text-danger" id="errNewBasic"></span>
                        </td>
                    </tr>

                    <tr>
                        <td>Gross Salary</td>
                        <td>
                            <input type="text" id="grossSalary" readonly>
                        </td>
                        <td>
                            <input type="text" id="newGrossSalary" data-decimal>
                            <span class="text-danger" id="errNewGross"></span>
                        </td>
                    </tr>

                    
                </tbody>
            </table>
        </div>

        <div class="text-center mt-3 btnTag" style="display:none;">
            <button type="button" class="btn btn-primary" id="btnIncrementSave" style="background-color:#2395c6; color:white;">Save</button>
            <button type="button" class="btn btn-primary" id="btnIncrementSaving" style="background-color:#2395c6; color:white;display:none" disabled><span class="spinner-border spinner-border-sm me-2" role="status"></span> Saving...</button>

            <button type="button" onclick="resetForm()" class="btn btn-sm btn-secondary px-2">Clear</button>
        </div>
    </form>
</div>





<script src="~/assets/js/jquery.min.js"></script>
<script>
      let UserId=localStorage.getItem('EmployeeId');
          const savedCompany = localStorage.getItem('selectedCompany');
          var companyDetails = JSON.parse(savedCompany);
          const CompanyId=companyDetails.CompanyId;
          const Token=localStorage.getItem("authToken");

       $(document).ready( async function() {

             effectDate();
             bindEmployee();
               BindReason();

               const allowedDay = 1; 

                const input = document.getElementById("effectDate");

                input.addEventListener("change", function () {
                    if (!this.value) return;

                    const selectedDay = new Date(this.value).getDate();

                    if (selectedDay !== allowedDay) {
                        this.value = "";   
                      $( "#spneffectDate").show();
                        $("#spneffectDate").text("Only 1st day of every month is allowed");
                        
                    } else {
                         $( "#spneffectDate").hide();
                    }
                });


                $("#newBasicSalary, #newGrossSalary").on("input", function () {

                    $("#errNewBasic, #errNewGross").text("");

                    var newBasic = parseFloat($("#newBasicSalary").val()) || 0;
                    var newGross = parseFloat($("#newGrossSalary").val()) || 0;

                    if (newGross && newBasic && newGross < newBasic) {
                        $("#errNewGross").text("Gross salary must be ≥ Basic salary");
                    }
                });
      });

      function btnShow(){
          $("#btnIncrementSaving").show();
          $("#btnIncrementSave").hide();
      }
      function btnHide(){
          $("#btnIncrementSaving").hide();
          $("#btnIncrementSave").show();
      }

              function effectDate() {
                    const today = new Date();

                    // First day of current month (LOCAL time)
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

                    // Manual formatting (SAFE)
                    const yyyy = firstDay.getFullYear();
                    const mm = String(firstDay.getMonth() + 1).padStart(2, '0');
                    const dd = String(firstDay.getDate()).padStart(2, '0');

                    document.getElementById('effectDate').value = `${yyyy}-${mm}-${dd}`;
                }


           function handleSingleInput(currentInput, currentId) {
              // Set the value for the current input
              $('#' + currentId).val($(currentInput).val());

              const isPercentageMode = $('input[name="incrementMode"]:checked').val() === 'percentage';
              if (isPercentageMode) {
                  // Ensure currentInput is a jQuery object
                  const $input = $(currentInput);
                  if (parseFloat($input.val()) > 100) {
                      $input.val('100');
                  }
              }
              // Recalculate salary
              calculateNewSalary();
          }


         function toggleInputMode() {

            // Reset values to 0
            $('#basic').val("0");
            $('#gross').val("0");
            $('#ctc').val("0");
                $('#newBasicSalary').val("");
                $('#newGrossSalary').val("");
                $('#newctcSalary').val("");

        }


    

       async function bindEmployee() {


        return new Promise((resolve, reject) => {
            $.ajax({
                url: '@baseUrl/EmployeeMasterAPI/GetAllEmployeeList/'+CompanyId,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (response) {
                    if (response.isSuccess) {

                           $('#ddlEmployee').searchableSelect({
                            data: response.data||[],
                            valueKey: 'EmployeeId',
                            textKey: 'EmployeeName',
                            placeholder:'Employee',
                            searchPlaceholder: 'Search employee...',
                            onChange: function(item) {
                                loadSalary();
                            }
                        });
                        resolve(response.data);
                    } else {
                        reject('Failed to fetch employees');
                    }
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }

         function BindReason() {
            $.ajax({
                    url: '@baseUrl/EmployeeIncrementAPI/GetAllIncrementReason',
                    method: 'GET',
                      headers: {
                              'Authorization': 'Bearer ' + Token
                          },
                    success: function (response) {
                       
                           $('#ddlReason').searchableSelect({
                            data: response.data||[],
                            valueKey: 'reasonId',
                            textKey: 'reasonName',
                            placeholder:'Reason',
                            searchPlaceholder: 'Search reason...',
                            onChange: function(item) {
                            }
                        });
                    }
            });
        }

        function resetForm()
        {
            clearErrors();
              effectDate();
                 const dropdownddlEmployee = $('#ddlEmployee').data('searchableSelect');
                if(dropdownddlEmployee){
                    dropdownddlEmployee.clear()
                }    
                const dropdownddlreason = $('#ddlReason').data('searchableSelect');
                if(dropdownddlreason){
                    dropdownddlreason.clear()
                }               
                   $('#ddlBranch').prop('disabled',false);
                     $("#salaryChange").hide();
                        $(".btnTag").hide();
             $('#spneffectDate').hide();
            $('#spnddlEmployee').hide();
            $('#spnddlReason').hide();
        }

       

      async function loadSalary() {
           const empId = $('#ddlEmployee').data('searchableSelect').getValue();
            if(!empId){
                return;
            }
          
          try {
              const response = await fetch('@baseUrl/EmployeeIncrementAPI/GetEmployeeSalaryInfo/'+empId, {
                  method: 'GET',
                  headers: {
                      'Authorization': 'Bearer ' + localStorage.getItem("authToken"),
                      'Content-Type': 'application/json'
                  }
              });
              const data = await response.json();
              if (data.isSuccess) {

                 $('#basicSalary').val(data.data.basicSalary);
                  $('#grossSalary').val(data.data.grossSalary);
                   $("#salaryChange").show();
                      $(".btnTag").show();
              }
              else{
                  round_error_noti(data.responseMessage);
                    $("#salaryChange").hide();
                      $(".btnTag").hide();
              }

          } catch (error) {
              console.error('Fetch error:', error);
          }
      }


      function clearErrors() {
           $('#spneffectDate').hide();
          $('#spnddlEmployee').hide();
          $('#spnddlReason').hide();
        $("#errNewBasic, #errNewGross").text("");
    }
    

      $("#btnIncrementSave").click(async function() {
          btnShow();
          clearErrors();
          var reasonId = $('#ddlReason').data('searchableSelect').getValue();
          var effectedDated = $('#effectDate').val();
          var empId = $('#ddlEmployee').data('searchableSelect').getValue();
          var isValid = true;

           var basicSalary = parseFloat($("#basicSalary").val()) || 0;
            var newBasicSalary = parseFloat($("#newBasicSalary").val()) || 0;

            var grossSalary = parseFloat($("#grossSalary").val()) || 0;
            var newGrossSalary = parseFloat($("#newGrossSalary").val()) || 0;

          // Validation
          if (!effectedDated) {
               $('#spneffectDate').show();
              $('#spneffectDate').text("Please select effected date");
              isValid = false;
          }
          if (!empId) {
              $('#spnddlEmployee').show();
              isValid = false;
          }
          if (!reasonId) {
              $('#spnddlReason').show();
              isValid = false;
          }
          if (!newBasicSalary)
           {
                $("#errNewBasic").text("Please enter New Basic Salary");
                isValid = false;
            }
           if (!newGrossSalary) {
                $("#errNewBasic").text("Please enter New Gross Salary");
                isValid = false;
            }
           
           if (newBasicSalary < basicSalary) {
            $("#errNewBasic").text("New Basic Salary must be greater than or equal to Current Basic Salary");
            isValid = false;
            }

            if (newGrossSalary < grossSalary) {
                $("#errNewGross").text("New Gross Salary must be greater than or equal to Current Gross Salary");
                isValid = false;
            }

            if (newGrossSalary < newBasicSalary) {
                $("#errNewGross").text("New Gross Salary cannot be less than New Basic Salary");
                isValid = false;
            }

            if (!isValid) 
            {
                btnHide();
                return;
            }

          // Default values
          if (basicSalary == null || basicSalary === '') 
          {
              basicSalary = 0;
          }
          if (!grossSalary) {
              round_error_noti("Please enter gross salary!");
              return;
          }

          // Prepare payload
          var payload = {  // Renamed from 'data' to avoid conflict
              OldGrossSalary: grossSalary,
              OldBasicSalary: basicSalary,
              NewGrossSalary: newGrossSalary,
              NewBasicSalary: newBasicSalary,
              EffectiveFromDate: effectedDated,
              ReasonId: reasonId,
              EmployeeId: empId,
              CreatedBy:UserId
          };
          try {
              const response = await fetch('@baseUrl/EmployeeIncrementAPI/InsertEmployeeSalaryHistory', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(payload)  // Use 'payload' instead of 'data'
              });

              const responseData = await response.json();  // Renamed to avoid conflict

              if (responseData.isSuccess) {
                  round_success_noti(responseData.responseMessage);
                    resetForm();
              } else {
                  round_error_noti(responseData.responseMessage);
              }
              btnHide();
          } catch (error) {
              console.error('Fetch error:', error);
              round_error_noti("An error occurred. Please try again.");
          }
      });
</script>
@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Attendance Register";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attendance Register</title>

    <!-- DevExtreme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/devextreme@23.2.3/dist/css/dx.light.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/devextreme@23.2.3/dist/js/dx.all.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
        }

        .header {
            background-color: #3f4d6b;
            color: white;
            font-size: 18px;
            font-weight: bold;
            padding: 12px 20px;
        }

        .main {
            display: flex;
            height: calc(100vh - 50px);
        }

        .left-section, .right-section {
            width: 50%;
            padding: 30px;
            background-color: #fff;
            box-sizing: border-box;
        }

        .separator {
            width: 1px;
            background-color: #ccc;
        }

        .date-row {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .form-group {
            flex: 1;
        }

        label {
            font-weight: 600;
            display: block;
            margin-bottom: 6px;
            color: #333;
        }

        input[type="date"] {
            width: 100%;
            padding: 8px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .btn-group {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            background-color: #3f4d6b;
            color: white;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
        }

        #recordCount {
            color: red;
            font-weight: 600;
            margin-bottom: 15px;
        }

        #employeeGrid {
            height: calc(100vh - 180px);
        }
    </style>
</head>
<body>

    <div class="header">ATTENDANCE REGISTER</div>

    <div class="main">
        <!-- Left Section -->
        <div class="left-section">
            <div class="date-row">
                <div class="form-group">
                    <label for="fromDate">From Date:</label>
                    <input type="date" id="fromDate" value="2025-07-01">
                </div>
                <div class="form-group">
                    <label for="toDate">To Date:</label>
                    <input type="date" id="toDate" value="2025-07-31">
                </div>
            </div>
            <div class="btn-group">
                <button onclick="onFind()" id="btnfind">Find</button>
                <button onclick="onClear()">Clear</button>
            </div>
        </div>

        <!-- Vertical Separator -->
        <div class="separator"></div>

        <!-- Right Section -->
        <div class="right-section">
            <div class="d-flex justify-content-between align-items-center">
                <div id="recordCount">0 Records found.</div>
                <button id="btnView">View</button>
            </div>
            <div id="employeeGrid"></div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="attendanceModal" tabindex="-1" aria-labelledby="attendanceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="attendanceModalLabel">Attendance Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="attendanceModalBody"></div>
            </div>
        </div>
    </div>

    <script>
        function onFind() { arguments
            debugger;
            const fromDate = $('#fromDate').val();
            const toDate = $('#toDate').val();

            if (!fromDate || !toDate) {
                Swal.fire('Validation', 'Select both dates.', 'warning');
                return;
            }

            $.ajax({
                url: '@(baseDomainUrl + "/api/EmployeeAPI/GetAllEmployee")',
                type: "GET",
                dataType: "json",
                success: function (response) {
                    const employeeData = response.data || response;

                    const grid = $("#employeeGrid").dxDataGrid({
                        dataSource: employeeData,
                        keyExpr: "EmployeeCode",
                        selection: {
                            mode: "multiple",
                            showCheckBoxesMode: "always"
                        },
                        showBorders: true,
                        columnAutoWidth: true,
                        export: {
                            enabled: true,
                            fileName: "Employee_Records"
                        },
                        columns: [
                            { dataField: "EmployeeCode", caption: "Employee Code", width: 150 },
                            { dataField: "EmployeeName", caption: "Employee Name" }
                        ]
                    }).dxDataGrid("instance");

                    $('#recordCount').text(`${employeeData.length} Records found.`);
                },
                error: function () {
                    Swal.fire('Error', 'Failed to load employees.', 'error');
                }
            });
        }

        function onClear() {
            $('#fromDate, #toDate').val('');
            $('#employeeGrid').dxDataGrid("instance").option("dataSource", []);
            $('#recordCount').text('0 Records found.');
        }

        $('#btnView').click(function () {
            const grid = $('#employeeGrid').dxDataGrid("instance");
            const selected = grid.getSelectedRowsData();

            if (!selected.length) {
                Swal.fire('Warning', 'Select at least one employee.', 'warning');
                return;
            }

            const empCodes = selected.map(emp => emp.EmployeeCode);
            const request = {
                EmployeeCodes: empCodes,
                StartDate: $('#fromDate').val(),
                EndDate: $('#toDate').val()
            };

            $.ajax({
                url: '@(baseDomainUrl + "/api/AttendanceAPI/GetAttendanceData")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(request),
                success: function (res) {
                    if (!res || !res.data || res.data.length === 0) {
                        $('#attendanceModalBody').html('<p class="text-danger">No attendance records found.</p>');
                        const modal = new bootstrap.Modal(document.getElementById('attendanceModal'));
                        modal.show();
                        return;
                    }

                    renderAttendanceTable(res.data, request.StartDate, request.EndDate);
                },
                error: function () {
                    Swal.fire('Error', 'Failed to fetch attendance.', 'error');
                }
            });
        });
    </script>
</body>
</html>

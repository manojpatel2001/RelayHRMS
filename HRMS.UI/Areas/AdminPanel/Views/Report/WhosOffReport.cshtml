@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Attendance Report";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];
}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    .salary-box {
        background-color: white !important;
        border: 1px solid #ccc;
        padding: 12px;
        border-radius: 5px;
    }

    .salary-header {
        background-color: #3e4b6d;
        color: white;
        font-weight: bold;
        padding: 8px 15px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
    }

    .form-group-row {
        margin-bottom: 20px;
        gap: 15px;
    }

    .form-label {
        min-width: 100px;
        font-weight: 500;
        color: #495057;
        font-size: 14px;
        margin-bottom: 0;
    }

    .btn-go {
        padding: 5px 30px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        margin: 0 5px;
    }

    #btnFetchAttendance, #btnFetchingAttendance {
        background-color: #2395c6;
        color: #fff;
    }

        #btnFetchAttendance:hover, #btnFetchingAttendance:hover {
            background-color: #1d7ba3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(35, 149, 198, 0.3);
        }

    #btnClear {
        background-color: #dc3545;
        color: #fff;
    }

        #btnClear:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

    .btn-go:last-child {
        background-color: #6c757d;
        color: #fff;
    }

        .btn-go:last-child:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

    .btn-go:last-child {
        background-color: #6c757d;
        color: #fff;
    }

        .btn-go:last-child:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

    .text-danger {
        color: #dc3545;
    }

    .error-message {
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    #attendanceGridContainer {
        margin-bottom: 20px !important;
        max-height: 500px !important;
        overflow: auto !important;
    }

    #grid-loader {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(3px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .grid-logo-spinner {
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .form-floating-custom {
        position: relative;
    }

    /* Searchable Multi-Select Dropdown Styles */
    .searchable-select-wrapper {
        position: relative;
        width: 100%;
    }

        .searchable-select-wrapper label {
            display: none;
        }

    .searchable-select-input {
        min-height: 38px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 4px 35px 4px 8px;
        cursor: pointer;
        background-color: white;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 4px;
    }

        .searchable-select-input:hover {
            border-color: #86b7fe;
        }

    .selected-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        width: 100%;
    }

    .selected-tags-placeholder {
        color: #6c757d;
        font-size: 14px;
    }

    .selected-tag {
        background-color: #e7f3ff;
        border: 1px solid #2395c6;
        border-radius: 3px;
        padding: 2px 8px;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

        .selected-tag .remove-tag {
            cursor: pointer;
            font-weight: bold;
            color: #2395c6;
        }

            .selected-tag .remove-tag:hover {
                color: #1d7ba3;
            }

    .searchable-select-arrow {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 12px;
        height: 12px;
        pointer-events: none;
        transition: transform 0.3s;
    }

    .searchable-select-wrapper.active .searchable-select-arrow {
        transform: translateY(-50%) rotate(180deg);
    }

    .searchable-select-arrow svg {
        width: 100%;
        height: 100%;
        fill: #495057;
    }

    .searchable-select-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 4px;
        margin-top: 2px;
        max-height: 300px;
        overflow: hidden;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .searchable-select-wrapper.active .searchable-select-dropdown {
        display: flex;
        flex-direction: column;
    }

    .searchable-select-search {
        padding: 8px;
        border-bottom: 1px solid #e9ecef;
        background: white;
        flex-shrink: 0;
    }

        .searchable-select-search input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

            .searchable-select-search input:focus {
                outline: none;
                border-color: #86b7fe;
            }

    .multi-select-actions {
        padding: 8px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        gap: 8px;
        background: white;
        flex-shrink: 0;
    }

    .multi-select-btn {
        flex: 1;
        padding: 5px 10px;
        font-size: 12px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }

        .multi-select-btn:hover {
            background-color: #f8f9fa;
            border-color: #2395c6;
        }

    .searchable-select-options {
        overflow-y: auto;
        flex: 1;
    }

    .searchable-select-option {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

        .searchable-select-option:hover {
            background-color: #f8f9fa;
        }

        .searchable-select-option.selected {
            background-color: #e7f3ff;
        }

        .searchable-select-option input[type="checkbox"] {
            cursor: pointer;
        }

    .no-results {
        padding: 12px;
        text-align: center;
        color: #6c757d;
        font-size: 14px;
    }
</style>

<div class="salary-box">
    <div class="salary-header">Attendance Report</div>
    <div class="row justify-content-center mt-3">
        <div class="col-lg-8">
            <!-- First Row: Month and Year -->
            <div class="row justify-content-center mb-3">
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Month<span class="text-danger">*</span>:</label>
                        <div class="form-floating-custom flex-grow-1">
                            <select class="form-select" id="monthDropdown">
                                <option value="">Select Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <span class="text-danger error-message" id="errorMonth">Please select month</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Year<span class="text-danger">*</span>:</label>
                        <div class="form-floating-custom flex-grow-1">
                            <select class="form-select" id="yearDropdown">
                                <option value="">Select Year</option>
                            </select>
                            <span class="text-danger error-message" id="errorYear">Please select year</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Row: Branch and Employee with Searchable Multi-Select -->
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Branch<span class="text-danger">*</span>:</label>
                        <div class="form-floating-custom flex-grow-1">
                            <div class="searchable-select-wrapper multi-select" id="branchWrapper">
                                <div class="searchable-select-input" id="branchDropdown">
                                    <div class="selected-tags">
                                        <span class="selected-tags-placeholder">Select Branch</span>
                                    </div>
                                </div>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search branch..." class="search-input">
                                    </div>
                                    <div class="multi-select-actions">
                                        <button type="button" class="multi-select-btn select-all-btn">Select All</button>
                                        <button type="button" class="multi-select-btn clear-all-btn">Clear All</button>
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                            <span class="text-danger error-message" id="errorBranch">Please select branch</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Employee<span class="text-danger">*</span>:</label>
                        <div class="form-floating-custom flex-grow-1">
                            <div class="searchable-select-wrapper multi-select" id="employeeWrapper">
                                <div class="searchable-select-input" id="employeeDropdown">
                                    <div class="selected-tags">
                                        <span class="selected-tags-placeholder">Select Employee</span>
                                    </div>
                                </div>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search employee..." class="search-input">
                                    </div>
                                    <div class="multi-select-actions">
                                        <button type="button" class="multi-select-btn select-all-btn">Select All</button>
                                        <button type="button" class="multi-select-btn clear-all-btn">Clear All</button>
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                            <span class="text-danger error-message" id="errorEmployee">Please select employee</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buttons -->

    <div class="col-md-12 text-center mt-4">
        <button class="btn-go" id="btnFetchAttendance">Go</button>
        <button class="btn-go" id="btnFetchingAttendance" disabled style="display: none;">
            <span class="spinner-border spinner-border-sm me-2" role="status"></span> Go
        </button>
        <button class="btn-go" id="btnClear">Clear</button>
        <button class="btn-go" onclick="goBack()">Back</button>
    </div>
</div>

<!-- Loader -->
<div id="grid-loader">
    <img src="@baseDomainUrl/loders/loder.png" class="grid-logo-spinner" />
    <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>
</div>

<!-- Attendance Grid -->
<div id="attendanceGridContainer" style="display: none; margin-top: 20px;"></div>

<script>
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany);
    const CompanyId = companyDetails.CompanyId;
    const Token = localStorage.getItem("authToken");

    // Searchable Multi-Select Component
    class SearchableMultiSelect {
        constructor(wrapperId, options = {}) {
            this.wrapper = document.getElementById(wrapperId);
            this.input = this.wrapper.querySelector('.searchable-select-input');
            this.dropdown = this.wrapper.querySelector('.searchable-select-dropdown');
            this.searchInput = this.wrapper.querySelector('.search-input');
            this.optionsContainer = this.wrapper.querySelector('.searchable-select-options');
            this.selectedTags = this.wrapper.querySelector('.selected-tags');
            this.placeholder = this.wrapper.querySelector('.selected-tags-placeholder');
            this.selectAllBtn = this.wrapper.querySelector('.select-all-btn');
            this.clearAllBtn = this.wrapper.querySelector('.clear-all-btn');

            this.options = [];
            this.selectedValues = [];
            this.onChangeCallback = options.onChange || null;

            this.init();
        }

        init() {
            this.input.addEventListener('click', (e) => {
                e.stopPropagation();
                this.toggleDropdown();
            });

            this.searchInput.addEventListener('input', (e) => {
                this.filterOptions(e.target.value);
            });

            this.selectAllBtn.addEventListener('click', () => {
                this.selectAll();
            });

            this.clearAllBtn.addEventListener('click', () => {
                this.clearAll();
            });

            document.addEventListener('click', (e) => {
                if (!this.wrapper.contains(e.target)) {
                    this.closeDropdown();
                }
            });
        }

        toggleDropdown() {
            this.wrapper.classList.toggle('active');
            if (this.wrapper.classList.contains('active')) {
                this.searchInput.focus();
            }
        }

        closeDropdown() {
            this.wrapper.classList.remove('active');
            this.searchInput.value = '';
            this.filterOptions('');
        }

        setOptions(options) {
            this.options = options;
            this.renderOptions();
        }

        renderOptions() {
            this.optionsContainer.innerHTML = '';

            if (this.options.length === 0) {
                this.optionsContainer.innerHTML = '<div class="no-results">No options available</div>';
                return;
            }

            this.options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'searchable-select-option';
                if (this.selectedValues.includes(option.value)) {
                    optionDiv.classList.add('selected');
                }

                optionDiv.innerHTML = `
                    <input type="checkbox" ${this.selectedValues.includes(option.value) ? 'checked' : ''}>
                    <span>${option.text}</span>
                `;

                optionDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleOption(option.value);
                });

                this.optionsContainer.appendChild(optionDiv);
            });
        }

        filterOptions(searchTerm) {
            const options = this.optionsContainer.querySelectorAll('.searchable-select-option');
            let visibleCount = 0;

            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchTerm.toLowerCase())) {
                    option.style.display = 'flex';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            });

            if (visibleCount === 0 && searchTerm) {
                if (!this.optionsContainer.querySelector('.no-results')) {
                    this.optionsContainer.innerHTML = '<div class="no-results">No results found</div>';
                }
            }
        }

        toggleOption(value) {
            const index = this.selectedValues.indexOf(value);
            if (index > -1) {
                this.selectedValues.splice(index, 1);
            } else {
                this.selectedValues.push(value);
            }
            this.updateSelectedTags();
            this.renderOptions();
            if (this.onChangeCallback) {
                this.onChangeCallback(this.selectedValues);
            }
        }

        selectAll() {
            this.selectedValues = this.options.map(opt => opt.value);
            this.updateSelectedTags();
            this.renderOptions();
            if (this.onChangeCallback) {
                this.onChangeCallback(this.selectedValues);
            }
        }

        clearAll() {
            this.selectedValues = [];
            this.updateSelectedTags();
            this.renderOptions();
            if (this.onChangeCallback) {
                this.onChangeCallback(this.selectedValues);
            }
        }

        updateSelectedTags() {
            this.selectedTags.innerHTML = '';

            if (this.selectedValues.length === 0) {
                const placeholder = document.createElement('span');
                placeholder.className = 'selected-tags-placeholder';
                placeholder.textContent = this.wrapper.id === 'branchWrapper' ? 'Select Branch' : 'Select Employee';
                this.selectedTags.appendChild(placeholder);
                return;
            }

            this.selectedValues.forEach(value => {
                const option = this.options.find(opt => opt.value === value);
                if (option) {
                    const tag = document.createElement('span');
                    tag.className = 'selected-tag';
                    tag.innerHTML = `
                        ${option.text}
                        <span class="remove-tag" data-value="${value}">×</span>
                    `;

                    tag.querySelector('.remove-tag').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleOption(value);
                    });

                    this.selectedTags.appendChild(tag);
                }
            });
        }

        getSelectedValues() {
            return this.selectedValues;
        }

        reset() {
            this.selectedValues = [];
            this.updateSelectedTags();
            this.renderOptions();
        }
    }

    // Initialize multi-select dropdowns
    let branchMultiSelect, employeeMultiSelect;

    $(document).ready(function() {
        // Initialize Branch Multi-Select
        branchMultiSelect = new SearchableMultiSelect('branchWrapper', {
            onChange: (selectedValues) => {
                loadEmployeesForBranches(selectedValues);
            }
        });

        // Initialize Employee Multi-Select
        employeeMultiSelect = new SearchableMultiSelect('employeeWrapper');

             const startYear = 2025;
            const currentYear = new Date().getFullYear();

            for (let year = currentYear; year >= startYear; year--) {
                $('#yearDropdown').append(`<option value="${year}">${year}</option>`);
            }

        // Load Branches
        $.ajax({
            url: '@baseUrl/BranchAPI/GetAllBranchesListByCompanyId/' + CompanyId,
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + Token },
            success: function(response) {
                if (response?.data?.length > 0) {
                    const branchOptions = response.data.map(branch => ({
                        value: branch.branchId,
                        text: branch.branchName
                    }));
                    branchMultiSelect.setOptions(branchOptions);
                }
            }
        });
    });

    function loadEmployeesForBranches(branchIds) {
        // Reset employee dropdown
        employeeMultiSelect.setOptions([]);
        employeeMultiSelect.reset();

        if (!branchIds || branchIds.length === 0) {
            return;
        }

        // Create comma-separated string of branch IDs
        const branchIdsParam = branchIds.join(',');

        // Call the specified API
        $.ajax({
            url: `@baseDomainUrl/api/EmployeeMasterAPI/GetAllEmployeeByBranch/${CompanyId}?BranchId=${branchIdsParam}`,
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + Token },
            success: function(response) {
                console.log('response' ,response);
                if (response?.data?.length > 0) {
                    const employeeOptions = response.data.map(emp => ({
                        value: emp.id,
                        text: `${emp.fullName} (${emp.employeeCode})`
                    }));
                    employeeMultiSelect.setOptions(employeeOptions);
                } else {
                    employeeMultiSelect.setOptions([]);
                }
            },
            error: function(error) {
                console.error('Error loading employees:', error);
                employeeMultiSelect.setOptions([]);
            }
        });
    }

    function goBack() {
        window.location.href = '@Url.Action("Index", "Home", new { area = "AdminPanel" })';
    }

    function clearPage() {
        // Reset Month dropdown
        $('#monthDropdown').val('');

        // Reset Year dropdown
        $('#yearDropdown').val('');

        // Reset Branch multi-select
        branchMultiSelect.clearAll();

        // Reset Employee multi-select
        employeeMultiSelect.clearAll();

        // Hide all error messages
        $('.error-message').hide();

        // Hide attendance grid
        $('#attendanceGridContainer').hide().empty();
    }

    // Clear button click event
    $('#btnClear').click(function() {
        clearPage();
    });
    function showLoader() {
        $('#grid-loader').css('display', 'flex');
    }

    function hideLoader() {
        $('#grid-loader').hide();
    }

    function showBtnLoader() {
        $('#btnFetchingAttendance').show();
        $('#btnFetchAttendance').hide();
    }

    function hideBtnLoader() {
        $('#btnFetchingAttendance').hide();
        $('#btnFetchAttendance').show();
    }

    $('#btnFetchAttendance').click(function() {
        debugger;
        showBtnLoader();
        const month = $('#monthDropdown').val();
        const year = $('#yearDropdown').val();
        const branchIds = branchMultiSelect.getSelectedValues();
        const employeeIds = employeeMultiSelect.getSelectedValues();

        let isValid = true;
        if (!month) { $('#errorMonth').show(); isValid = false; } else { $('#errorMonth').hide(); }
        if (!year) { $('#errorYear').show(); isValid = false; } else { $('#errorYear').hide(); }
        if (branchIds.length === 0) { $('#errorBranch').show(); isValid = false; } else { $('#errorBranch').hide(); }
        if (employeeIds.length === 0) { $('#errorEmployee').show(); isValid = false; } else { $('#errorEmployee').hide(); }

        if (!isValid) {
            hideBtnLoader();
            return;
        }

        showLoader();
        const startDate = `${year}-${month.padStart(2, '0')}-01`;
        const lastDay = new Date(year, month, 0).getDate();
        const endDate = `${year}-${month.padStart(2, '0')}-${lastDay}`;

        $.ajax({
            url: '@(baseDomainUrl + "/api/EmployeeReportAPI/Attendencereport")',
            method: 'POST',
            contentType: 'application/json',
            headers: { 'Authorization': 'Bearer ' + Token },
            data: JSON.stringify({
                StartDate: startDate,
                EndDate: endDate,
                EmployeeIds: employeeIds,
                BranchIds: branchIds
            }),
            success: function(response) {
                hideLoader();
                hideBtnLoader();
                if (response?.data?.length > 0) {
                    renderAttendanceGrid(response.data);
                } else {
                    Swal.fire('Info', 'No attendance records found.', 'info');
                }
            },
            error: function(xhr, status, error) {
                hideLoader();
                hideBtnLoader();
                console.error('Error fetching attendance:', error);
                Swal.fire('Error', 'Failed to fetch attendance data.', 'error');
            }
        });
    });

    function renderAttendanceGrid(data) {
        const days = Object.keys(data[0].days).sort((a, b) => parseInt(a) - parseInt(b));
        const columns = [
            { dataField: "branchName", caption: "Branch", width: 120 },
            { dataField: "employeeCode", caption: "Employee Code", width: 120 },
            { dataField: "fullName", caption: "Employee Name", width: 200 }
        ];

        // Add day columns
        days.forEach(day => {
            columns.push({
                dataField: `days.${day}`,
                caption: day,
                width: 40,
                cellTemplate: function(container, options) {
                    const value = options.value;
                    container.text(value);
                    if (value === 'P') container.css('color', 'green');
                    else if (value === 'A') container.css('color', 'red');
                    else if (value === 'W') container.css('color', 'blue');
                }
            });
        });

        // Add total columns
        columns.push(
            { dataField: "p", caption: "P", width: 50 },
            { dataField: "a", caption: "A", width: 50 },
            { dataField: "w", caption: "W", width: 50 },
            { dataField: "l", caption: "L", width: 50 },
            { dataField: "h", caption: "H", width: 50 },
            { dataField: "hf", caption: "HF", width: 50 }
        );

        $("#attendanceGridContainer").dxDataGrid({
            dataSource: data,
            keyExpr: "employeeCode",
            showBorders: true,
            columnAutoWidth: true,
            rowHeight: 50,
            columns: columns,
            export: { enabled: true },
            searchPanel: { visible: true },
            paging: { enabled: false },
            scrolling: { mode: "standard" }
        }).show();
    }
</script>
@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Employee Leave/OD Status";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn3.devexpress.com/jslib/23.1.3/css/dx.light.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body {
        background-color: white !important;
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
    }

    .leave-box {
        background-color: white !important;
        border: 1px solid #ccc;
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .leave-header {
        background-color: #5a6c8f;
        color: white;
        font-weight: bold;
        padding: 8px 15px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
    }

    .section-header {
        background-color: #5a6c8f;
        color: white;
        font-weight: bold;
        padding: 8px 15px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        margin-top: 20px;
    }

    .form-label {
        margin-bottom: 5px;
        font-weight: 500;
        display: block;
    }

    .form-group-row {
        margin-bottom: 12px;
    }

    .btn-go {
        background-color: #5a6c8f;
        color: white;
        border: none;
        padding: 6px 20px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 4px;
        transition: none;
        box-shadow: none;
        margin: 0 5px;
        cursor: pointer;
    }

        .btn-go:hover,
        .btn-go:focus,
        .btn-go:active {
            background-color: #4a5c7f;
            color: white;
            outline: none;
            box-shadow: none;
        }

    /* Custom Searchable Multi-Select Styles */
    .searchable-select-wrapper {
        position: relative;
        width: 100%;
    }

    .searchable-select-input {
        width: 100%;
        padding: 8px 35px 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer !important;
        background-color: white;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        user-select: none;
    }

        .searchable-select-input:focus {
            outline: none;
            border-color: #5a6c8f;
        }

    .searchable-select-wrapper {
        position: relative;
        width: 100%;
        cursor: pointer;
    }

    .searchable-select-arrow {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        width: 16px;
        height: 16px;
    }

        .searchable-select-arrow svg {
            width: 100%;
            height: 100%;
            fill: #666;
        }

    .searchable-select-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: none !important;
        max-height: 300px;
        overflow: hidden;
    }

        .searchable-select-dropdown.active {
            display: block !important;
        }

    .searchable-select-search {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }

        .searchable-select-search .search-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 13px;
        }

    .multi-select-actions {
        padding: 8px;
        border-bottom: 1px solid #eee;
        display: flex;
        gap: 8px;
    }

    .multi-select-btn {
        flex: 1;
        padding: 5px 10px;
        border: 1px solid #5a6c8f;
        background: white;
        color: #5a6c8f;
        border-radius: 3px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

        .multi-select-btn:hover {
            background: #5a6c8f;
            color: white;
        }

    .searchable-select-options {
        max-height: 200px;
        overflow-y: auto;
    }

    .searchable-select-option {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

        .searchable-select-option:hover {
            background-color: #f5f5f5;
        }

        .searchable-select-option input[type="checkbox"] {
            cursor: pointer;
        }

        .searchable-select-option.selected {
            background-color: #e8f0fe;
        }

    select.form-select-sm {
        width: 150px;
        height: 32px;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 8px;
        margin-right: 10px;
    }

    #grid-loader {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(3px);
        z-index: 9999;
    }

    .grid-logo-spinner {
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0%

    {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }

    }

    .grid-loading-text {
        font-size: 16px;
        color: #333;
    }

    /* DevExtreme Grid Header Styling */
    .dx-datagrid-headers .dx-header-row > td,
    .dx-datagrid-headers .dx-header-row > th {
        background-color: #5a6c8f !important;
        color: white !important;
        font-weight: bold !important;
        border-color: #495a75 !important;
    }

    .dx-datagrid .dx-datagrid-headers {
        background-color: #5a6c8f !important;
    }

    #monthlyLeaveGrid,
    #yearlyLeaveGrid {
        margin-top: 15px;
        display: none;
    }

    .total-column {
        background-color: #f0f0f0 !important;
        font-weight: bold;
    }

    .inline-filter-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 15px;
        margin-bottom: 15px;
    }

    .filter-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .field-error {
        font-size: 12px;
        margin-top: 4px;
    }
</style>

<!-- Top Filter Section -->
<div class="leave-box">
    <div class="leave-header">Employee Leave/OD Status</div>

    <div class="row justify-content-center mt-3">
        <div class="col-lg-10">
            <div class="row">
                <!-- Branch Dropdown -->
                <div class="col-md-6">
                    <label class="form-label">Branch<span class="text-danger">*</span> :</label>
                    <div class="form-group-row">
                        <div class="form-floating-custom flex-grow-1">
                            <div class="searchable-select-wrapper">
                                <input type="text" class="searchable-select-input" id="branchDropdown" placeholder="Select Branch" readonly>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search branch..." class="search-input">
                                    </div>
                                    <div class="multi-select-actions">
                                        <button type="button" class="multi-select-btn select-all-btn">Select All</button>
                                        <button type="button" class="multi-select-btn clear-all-btn">Clear All</button>
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                            <div class="text-danger field-error" id="branchError"></div>
                        </div>
                    </div>
                </div>

                <!-- Employee Dropdown -->
                <div class="col-md-6">
                    <label class="form-label">Employee<span class="text-danger">*</span> :</label>
                    <div class="form-group-row">
                        <div class="form-floating-custom flex-grow-1">
                            <div class="searchable-select-wrapper">
                                <input type="text" class="searchable-select-input" id="employeeDropdown" placeholder="Select Branch First" readonly>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search employee..." class="search-input">
                                    </div>
                                    <div class="multi-select-actions">
                                        <button type="button" class="multi-select-btn select-all-btn">Select All</button>
                                        <button type="button" class="multi-select-btn clear-all-btn">Clear All</button>
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                            <div class="text-danger field-error" id="employeeError"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buttons -->
    <div class="col-md-12 text-center mt-3">
        <button class="btn-go" id="btnGo">Go</button>
        <button class="btn-go" id="btnClear">Clear</button>
        <button onclick="goBack()" class="btn-go">Back</button>
    </div>
</div>

<!-- Loader -->
<div id="grid-loader" class="justify-content-center align-items-center flex-column">
    <img src="@baseDomainUrl/loders/loder.png" class="grid-logo-spinner" />
    <div class="grid-loading-text text-dark">Loading...</div>
</div>

<!-- Monthly Leave Status Section -->
<div class="leave-box" id="monthlySection" style="display:none;">
    <div class="section-header">Employee Leave Application Status</div>

    <div class="inline-filter-row justify-content-center">
        <div class="filter-item">
            <label class="form-label">Month :</label>
            <select class="form-select-sm" id="monthDropdown">
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
        </div>

        <div class="filter-item">
            <label class="form-label">Year :</label>
            <select class="form-select-sm" id="yearDropdownMonthly"></select>
        </div>

        <button class="btn-go" id="btnFetchMonthly">Go</button>
    </div>

    <div id="monthlyLeaveApplicationGrid" style="display:none; margin-top: 15px;"></div>

    <div id="monthlyLeaveGrid"></div>
</div>

<!-- Yearly Leave Status Section -->
<div class="leave-box" id="yearlySection" style="display:none;">
    <div class="section-header">Employee Yearly Leave Status</div>

    <div class="inline-filter-row justify-content-center">
        <div class="filter-item">
            <label class="form-label">Year :</label>
            <select class="form-select-sm" id="yearDropdownYearly"></select>
        </div>

        <button class="btn-go" id="btnFetchYearly">Go</button>
    </div>

    <div id="yearlyLeaveGrid"></div>
</div>

<script>
    const savedCompany = localStorage.getItem('selectedCompany');
    var companyDetails = JSON.parse(savedCompany);
    const CompanyId = companyDetails.CompanyId;
    const EmployeeId = localStorage.getItem('EmployeeId');
    const Token = localStorage.getItem("authToken");

    // Custom Searchable Multi-Select Plugin
    (function($) {
        $.fn.searchableSelect = function(options) {
            const settings = $.extend({
                data: [],
                valueKey: 'value',
                textKey: 'text',
                placeholder: 'Select',
                searchPlaceholder: 'Search...',
                onChange: null
            }, options);

            return this.each(function() {
                const $input = $(this);
                const $wrapper = $input.closest('.searchable-select-wrapper');
                const $dropdown = $wrapper.find('.searchable-select-dropdown');
                const $searchInput = $dropdown.find('.search-input');
                const $optionsContainer = $dropdown.find('.searchable-select-options');
                const $selectAllBtn = $dropdown.find('.select-all-btn');
                const $clearAllBtn = $dropdown.find('.clear-all-btn');

                let selectedValues = [];
                let allData = settings.data;

                // Store instance data
                $input.data('searchableSelect', {
                    setData: function(newData) {
                        allData = newData;
                        selectedValues = [];
                        renderOptions();
                        updateInputDisplay();
                    },
                    getValue: function() {
                        return selectedValues;
                    },
                    setValue: function(values) {
                        selectedValues = values || [];
                        renderOptions();
                        updateInputDisplay();
                    },
                    clear: function() {
                        selectedValues = [];
                        renderOptions();
                        updateInputDisplay();
                    }
                });

                // Toggle dropdown - Fixed to work properly
                $input.on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Input clicked!'); // Debug log
                    $('.searchable-select-dropdown').not($dropdown).removeClass('active');
                    $dropdown.toggleClass('active');
                    if ($dropdown.hasClass('active')) {
                        $searchInput.focus();
                    }
                });

                // Prevent dropdown from closing when clicking inside
                $dropdown.on('click', function(e) {
                    e.stopPropagation();
                });

                // Search functionality
                $searchInput.on('input', function() {
                    const searchTerm = $(this).val().toLowerCase();
                    renderOptions(searchTerm);
                });

                // Select All
                $selectAllBtn.on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectedValues = allData.map(item => item[settings.valueKey]);
                    renderOptions($searchInput.val());
                    updateInputDisplay();
                    if (settings.onChange) settings.onChange(selectedValues);
                });

                // Clear All
                $clearAllBtn.on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectedValues = [];
                    renderOptions($searchInput.val());
                    updateInputDisplay();
                    if (settings.onChange) settings.onChange(selectedValues);
                });

                // Render options
                function renderOptions(searchTerm = '') {
                    $optionsContainer.empty();

                    const filteredData = allData.filter(item => {
                        const text = item[settings.textKey].toLowerCase();
                        return text.includes(searchTerm.toLowerCase());
                    });

                    if (filteredData.length === 0) {
                        $optionsContainer.html('<div style="padding: 12px; text-align: center; color: #999;">No results found</div>');
                        return;
                    }

                    filteredData.forEach(item => {
                        const value = item[settings.valueKey];
                        const text = item[settings.textKey];
                        const isSelected = selectedValues.includes(value);

                        const $option = $(`
                            <div class="searchable-select-option ${isSelected ? 'selected' : ''}" data-value="${value}">
                                <input type="checkbox" ${isSelected ? 'checked' : ''}>
                                <span>${text}</span>
                            </div>
                        `);

                        $option.on('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const checkbox = $(this).find('input[type="checkbox"]');
                            checkbox.prop('checked', !checkbox.prop('checked'));

                            if (checkbox.prop('checked')) {
                                if (!selectedValues.includes(value)) {
                                    selectedValues.push(value);
                                }
                            } else {
                                selectedValues = selectedValues.filter(v => v !== value);
                            }

                            $(this).toggleClass('selected', checkbox.prop('checked'));
                            updateInputDisplay();
                            if (settings.onChange) settings.onChange(selectedValues);
                        });

                        $optionsContainer.append($option);
                    });
                }

                // Update input display
                function updateInputDisplay() {
                    if (selectedValues.length === 0) {
                        $input.val('').attr('placeholder', settings.placeholder);
                    } else {
                        const selectedTexts = selectedValues.map(val => {
                            const item = allData.find(d => d[settings.valueKey] === val);
                            return item ? item[settings.textKey] : '';
                        }).filter(t => t);

                        $input.val(selectedTexts.join(', '));
                    }
                }

                // Initial render
                renderOptions();
            });
        };
    })(jQuery);

    $(document).ready(function() {
        console.log('Document ready!'); // Debug

        // Close dropdowns when clicking outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.searchable-select-wrapper').length) {
                $('.searchable-select-dropdown').removeClass('active');
            }
        });

        // Initialize dropdowns
        $('#branchDropdown').searchableSelect({
            data: [],
            valueKey: 'branchId',
            textKey: 'branchName',
            placeholder: 'Select Branch',
            searchPlaceholder: 'Search branch...',
            onChange: function(selectedValues) {
                BindEmployeeDropdownByBranch(selectedValues);
            }
        });

        $('#employeeDropdown').searchableSelect({
            data: [],
            valueKey: 'employeeCode',
            textKey: 'displayName',
            placeholder: 'Select Branch First',
            searchPlaceholder: 'Search employee...'
        });

        // Manual click handler as backup
        $('.searchable-select-input').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Manual click handler triggered!');
            const $dropdown = $(this).siblings('.searchable-select-dropdown');
            $('.searchable-select-dropdown').not($dropdown).removeClass('active');
            $dropdown.toggleClass('active');
            console.log('Dropdown has active class:', $dropdown.hasClass('active'));
        });

        BindBranchDropdown();
        PopulateYearDropdowns();
        SetCurrentMonthYear();
    });

    function goBack() {
        window.history.back();
    }

    function PopulateYearDropdowns() {
        const currentYear = new Date().getFullYear();
        const years = [];
        for (let i = currentYear - 5; i <= currentYear + 5; i++) {
            years.push(i);
        }

        years.forEach(year => {
            $('#yearDropdownMonthly').append(`<option value="${year}">${year}</option>`);
            $('#yearDropdownYearly').append(`<option value="${year}">${year}</option>`);
        });

        $('#yearDropdownMonthly').val(currentYear);
        $('#yearDropdownYearly').val(currentYear);
    }

    function SetCurrentMonthYear() {
        const currentMonth = new Date().getMonth() + 1;
        $('#monthDropdown').val(currentMonth);
    }

    async function showLoder() {
        $('#grid-loader').addClass('d-flex').show();
    }

    async function hideLoder() {
        $('#grid-loader').removeClass('d-flex').hide();
    }

    function BindBranchDropdown() {
        $.ajax({
            url: '@baseUrl/BranchAPI/GetAllBranchesListByCompanyId/' + CompanyId,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function(response) {
                if (response?.data?.length > 0) {
                    const branchDropdown = $('#branchDropdown').data('searchableSelect');
                    if (branchDropdown) {
                        branchDropdown.setData(response.data);
                    }
                }
            }
        });
    }

    function BindEmployeeDropdownByBranch(selectedBranchIds) {
        const employeeDropdown = $('#employeeDropdown').data('searchableSelect');

        if (!Array.isArray(selectedBranchIds)) {
            selectedBranchIds = selectedBranchIds ? [selectedBranchIds] : [];
        }

        if (!selectedBranchIds || selectedBranchIds.length === 0) {
            employeeDropdown.setData([]);
            $('#employeeDropdown').attr('placeholder', 'Select Branch First');
            return;
        }

        // Extract branchId from objects if needed
        const branchParam = selectedBranchIds.map(branch => branch.branchId).join(',');
        console.log('branchParam:', branchParam); // Debugging

        $.ajax({
            type: "GET",
            url: '@(baseDomainUrl + "/api/EmployeeMasterAPI/GetAllEmployeeByBranchId")?BranchIds=' + branchParam + '&CompanyId=' + CompanyId,
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function(response) {
                console.log('response', response);
                if (response?.data?.length > 0) {
                    const employeeData = response.data.map(emp => ({
                        employeeCode: emp.employeeCode,
                        displayName: `${emp.fullName} - ${emp.employeeCode}`
                    }));
                    employeeDropdown.setData(employeeData);
                    $('#employeeDropdown').attr('placeholder', 'Select Employee');
                } else {
                    employeeDropdown.setData([]);
                    $('#employeeDropdown').attr('placeholder', 'No Employees Found');
                }
            }
        });
    }

    // Main Go Button - Fetch data and show sections
    $('#btnGo').on('click', function() {
        const branchDropdown = $('#branchDropdown').data('searchableSelect');
        const branchIds = branchDropdown.getValue();

        if (!branchIds || branchIds.length === 0) {
            Swal.fire("Please select Branch");
            return;
        }

        const employeeDropdown = $('#employeeDropdown').data('searchableSelect');
        const employeeCodes = employeeDropdown.getValue();

        if (!employeeCodes || employeeCodes.length === 0) {
            Swal.fire("Please select an Employee");
            return;
        }

        // Show both sections
        $('#monthlySection').show();
        $('#yearlySection').show();

        // Auto-fetch monthly data with current month/year
        FetchMonthlyLeaveStatus();

        // Auto-fetch yearly data with current year
        FetchYearlyLeaveStatus();
    });

    // Fetch Monthly Leave Status
    $('#btnFetchMonthly').on('click', function() {
        FetchMonthlyLeaveStatus();
    });

    function FetchMonthlyLeaveStatus() {
        const employeeDropdown = $('#employeeDropdown').data('searchableSelect');
        const employeeCodes = employeeDropdown.getValue();

        if (!employeeCodes || employeeCodes.length === 0) {
            Swal.fire("Please select an Employee first");
            return;
        }

        const selectedMonth = $('#monthDropdown').val();
        const selectedYear = $('#yearDropdownMonthly').val();

        showLoder();

        const empIdParam = employeeCodes;

        $.ajax({
            url: '@baseDomainUrl/api/ReportAPI/GetEmployeeMonthlyLeaveStatus',
            type: 'GET',
            data: {
                EmpId: empIdParam,
                SelectedMonth: selectedMonth,
                SelectedYear: selectedYear,
                CompId: CompanyId
            },
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function(response) {
                hideLoder();
                if (response.isSuccess) {
                    console.log('Monthly Response:', response);

                    if (response.data.leaveApplications && response.data.leaveApplications.length > 0) {
                        RenderMonthlyLeaveApplicationGrid(response.data.leaveApplications);
                        $('#monthlyLeaveApplicationGrid').show();
                    } else {
                        $('#monthlyLeaveApplicationGrid').hide();
                    }

                    if (response.data.leaveStatuses && response.data.leaveStatuses.length > 0) {
                        RenderMonthlyLeaveStatusGrid(response.data.leaveStatuses);
                        $('#monthlyLeaveGrid').show();
                    } else {
                        $('#monthlyLeaveGrid').hide();
                    }

                    if ((!response.data.leaveApplications || response.data.leaveApplications.length === 0) &&
                        (!response.data.leaveStatuses || response.data.leaveStatuses.length === 0)) {
                        Swal.fire({
                            icon: 'info',
                            title: 'No Data Found',
                            text: 'No records found for the selected criteria.'
                        });
                    }
                } else {
                    Swal.fire(response.responseMessage || "Error fetching data");
                }
            },
            error: function(xhr, status, error) {
                hideLoder();
                Swal.fire("Error occurred while fetching data");
                console.error(error);
            }
        });
    }

    function RenderMonthlyLeaveApplicationGrid(data) {
        if ($("#monthlyLeaveApplicationGrid").data('dxDataGrid')) {
            $("#monthlyLeaveApplicationGrid").dxDataGrid('dispose');
        }

        $("#monthlyLeaveApplicationGrid").dxDataGrid({
            dataSource: data,
            showBorders: true,
            columnAutoWidth: true,
            height: 'auto',
            paging: { enabled: true, pageSize: 10 },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [10, 20, 50],
                showInfo: true
            },
            searchPanel: { visible: true },
            export: {
                enabled: true,
                allowExportSelectedData: false
            },
            columns: [
                { dataField: "leaveName", caption: "Leave Name", alignment: "left" },
                { dataField: "leavePeriod", caption: "Leave Period", alignment: "center", format: "#0.00" },
                { dataField: "fromDate", caption: "From Date", alignment: "center", dataType: "date", format: "dd/MM/yyyy" },
                { dataField: "toDate", caption: "To Date", alignment: "center", dataType: "date", format: "dd/MM/yyyy" },
                { dataField: "leaveStatus", caption: "Leave Status", alignment: "center" }
            ]
        });
    }

    // Fetch Yearly Leave Status
    $('#btnFetchYearly').on('click', function() {
        FetchYearlyLeaveStatus();
    });

    function FetchYearlyLeaveStatus() {
        const employeeDropdown = $('#employeeDropdown').data('searchableSelect');
        const employeeCodes = employeeDropdown.getValue();

        if (!employeeCodes || employeeCodes.length === 0) {
            Swal.fire("Please select an Employee first");
            return;
        }

        const selectedYear = $('#yearDropdownYearly').val();

        showLoder();

        const empIdParam = employeeCodes;

        $.ajax({
            url: '@baseDomainUrl/api/ReportAPI/GetEmployeeYearlyLeaveStatus',
            type: 'GET',
            data: {
                EmpId: empIdParam,
                CompId: CompanyId,
                Year: selectedYear
            },
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function(response) {
                hideLoder();
                if (response.isSuccess) {
                    if (response.data && response.data.length > 0) {
                        console.log('response', response);
                        RenderYearlyLeaveGrid(response.data);
                    } else {
                        Swal.fire({
                            icon: 'info',
                            title: 'No Data Found',
                            text: 'No records found for the selected criteria.'
                        });
                        $('#yearlyLeaveGrid').hide();
                    }
                } else {
                    Swal.fire(response.responseMessage || "Error fetching data");
                }
            },
            error: function(xhr, status, error) {
                hideLoder();
                Swal.fire("Error occurred while fetching data");
                console.error(error);
            }
        });
    }

    function RenderMonthlyLeaveStatusGrid(data) {
        if ($("#monthlyLeaveGrid").data('dxDataGrid')) {
            $("#monthlyLeaveGrid").dxDataGrid('dispose');
        }

        $("#monthlyLeaveGrid").dxDataGrid({
            dataSource: data,
            showBorders: true,
            columnAutoWidth: true,
            height: 'auto',
            paging: { enabled: true, pageSize: 10 },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [10, 20, 50],
                showInfo: true
            },
            searchPanel: { visible: true },
            export: {
                enabled: true,
                allowExportSelectedData: false
            },
            columns: [
                { dataField: "leaveType", caption: "Leave Type", alignment: "left" },
                { dataField: "openingBalance", caption: "Opening", alignment: "center", format: "#0.00" },
                { dataField: "credit", caption: "Credit", alignment: "center", format: "#0.00" },
                { dataField: "used", caption: "Used", alignment: "center", format: "#0.00" },
                { dataField: "closingBalance", caption: "Balance", alignment: "center", format: "#0.00" }
            ]
        });

        $("#monthlyLeaveGrid").show();
    }

    function RenderYearlyLeaveGrid(data) {
        console.log('YearData', data);
        if ($("#yearlyLeaveGrid").data('dxDataGrid')) {
            $("#yearlyLeaveGrid").dxDataGrid('dispose');
        }

        $("#yearlyLeaveGrid").dxDataGrid({
            dataSource: data,
            showBorders: true,
            columnAutoWidth: true,
            height: 'auto',
            paging: { enabled: true, pageSize: 10 },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [10, 20, 50],
                showInfo: true
            },
            searchPanel: { visible: true },
            export: {
                enabled: true,
                allowExportSelectedData: false
            },
            columns: [
                {
                    dataField: "leaveName",
                    caption: "Leave Name",
                    width: 150,
                    fixed: true,
                    fixedPosition: "left",
                    alignment: "left"
                },
                { dataField: "jan", caption: "Jan", width: 70, alignment: "center", format: "#0.00" },
                { dataField: "feb", caption: "Feb", width: 70, alignment: "center", format: "#0.00" },
                { dataField: "mar", caption: "Mar", width: 70, alignment: "center", format: "#0.00" },
                { dataField: "apr", caption: "Apr", width: 70, alignment: "center", format: "#0.00" },
                { dataField: "may", caption: "May", width: 70, alignment: "center", format: "#0.00" },
                { dataField: "jun", caption: "Jun", width: 70, alignment: "center", format: "#0.00" },
                { dataField: "jul", caption: "Jul", width: 70, alignment: "center", format: "#0.00" },
                { dataField: "aug", caption: "Aug", width: 70, alignment: "center", format: "#0.00" },
                { dataField: "sep", caption: "Sep", width: 70, alignment: "center", format: "#0.00" },
                { dataField: "oct", caption: "Oct", width: 70, alignment: "center", format: "#0.00" },
                { dataField: "nov", caption: "Nov", width: 70, alignment: "center", format: "#0.00" },
                { dataField: "dec", caption: "Dec", width: 70, alignment: "center", format: "#0.00" },
                {
                    dataField: "total",
                    caption: "Total",
                    width: 90,
                    alignment: "center",
                    format: "#0.00",
                    cssClass: "total-column"
                }
            ],
            scrolling: {
                mode: "standard"
            }
        });

        $("#yearlyLeaveGrid").show();
    }

    function clearAllData() {
        const branchDropdown = $('#branchDropdown').data('searchableSelect');
        if (branchDropdown) {
            branchDropdown.clear();
        }

        const employeeDropdown = $('#employeeDropdown').data('searchableSelect');
        if (employeeDropdown) {
            employeeDropdown.clear();
            $('#employeeDropdown').attr('placeholder', 'Select Branch First');
        }

        SetCurrentMonthYear();
        PopulateYearDropdowns();

        $('#monthlySection').hide();
        $('#yearlySection').hide();
        $('#monthlyLeaveGrid').hide();
        $('#yearlyLeaveGrid').hide();
        $('#monthlyLeaveApplicationGrid').hide();
    }

    $('#btnClear').on('click', function() {
        clearAllData();
    });
</script>
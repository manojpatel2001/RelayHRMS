@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Employee Leave/OD Status";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn3.devexpress.com/jslib/23.1.3/css/dx.light.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body {
        background-color: white !important;
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
    }

    .leave-box {
        background-color: white !important;
        border: 1px solid #ccc;
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .leave-header {
        background-color: #5a6c8f;
        color: white;
        font-weight: bold;
        padding: 8px 15px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
    }

    .section-header {
        background-color: #5a6c8f;
        color: white;
        font-weight: bold;
        padding: 8px 15px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        margin-top: 20px;
    }

    .form-label {
        width: 130px;
        margin-bottom: 0;
        font-weight: 500;
    }

    .form-group-row {
        margin-bottom: 12px;
    }

    .btn-go {
        background-color: #5a6c8f;
        color: white;
        border: none;
        padding: 6px 20px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 4px;
        transition: none;
        box-shadow: none;
        margin: 0 5px;
    }

        .btn-go:hover,
        .btn-go:focus,
        .btn-go:active {
            background-color: #5a6c8f;
            color: white;
            outline: none;
            box-shadow: none;
        }

    .dx-tagbox,
    .dx-tagbox .dx-texteditor {
        width: 100% !important;
        max-width: 100% !important;
    }

    .small-dropdown {
        width: 250px !important;
    }

    .dx-placeholder {
        font-size: 14px !important;
        color: #999 !important;
        white-space: nowrap;
    }

    select.form-select-sm {
        width: 180px;
        height: 32px;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 8px;
    }

    #grid-loader {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(3px);
        z-index: 9999;
    }

    .grid-logo-spinner {
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .grid-loading-text {
        font-size: 16px;
        color: #333;
    }

    /* DevExtreme Grid Header Styling */
    .dx-datagrid-headers .dx-header-row > td,
    .dx-datagrid-headers .dx-header-row > th {
        background-color: #5a6c8f !important;
        color: white !important;
        font-weight: bold !important;
        border-color: #495a75 !important;
    }

    .dx-datagrid .dx-datagrid-headers {
        background-color: #5a6c8f !important;
    }

    #monthlyLeaveGrid,
    #yearlyLeaveGrid {
        margin-top: 10px;
        display: none;
    }

    .dx-dropdowneditor-button {
        background-color: transparent !important;
    }
</style>

<!-- Top Filter Section -->
<div class="leave-box">
    <div class="leave-header">Employee Leave/OD Status</div>

    <div class="row justify-content-center mt-3">
        <div class="col-lg-10">
            <div class="row">
                <!-- Branch Dropdown -->
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Branch<span class="text-danger">*</span> :</label>
                        <div id="branchDropdown" class="small-dropdown"></div>
                    </div>
                </div>

                <!-- Employee Dropdown -->
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Employee<span class="text-danger">*</span> :</label>
                        <div id="employeeDropdown" class="small-dropdown"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buttons -->
    <div class="col-md-12 text-center mt-3">
        <button class="btn-go" id="btnGo">Go</button>
        <button class="btn-go" id="btnClear">Clear</button>
        <button onclick="goBack()" class="btn-go">Back</button>
    </div>
</div>

<!-- Loader -->
<div id="grid-loader" class="justify-content-center align-items-center flex-column">
    <img src="@baseDomainUrl/loders/loder.png" class="grid-logo-spinner" />
    <div class="grid-loading-text text-dark">Loading...</div>
</div>

<!-- Monthly Leave Status Section -->
<div class="leave-box" id="monthlySection" style="display:none;">
    <div class="section-header">Employee Leave Application Status</div>

    <div class="row justify-content-center mt-3">
        <div class="col-lg-10">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Month :</label>
                        <select class="form-select-sm" id="monthDropdown">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Year :</label>
                        <select class="form-select-sm" id="yearDropdownMonthly"></select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-12 text-center mt-3">
        <button class="btn-go" id="btnFetchMonthly">Go</button>
    </div>

    <div id="monthlyLeaveGrid"></div>
</div>

<!-- Yearly Leave Status Section -->
<div class="leave-box" id="yearlySection" style="display:none;">
    <div class="section-header">Employee Yearly Leave Status</div>

    <div class="row justify-content-center mt-3">
        <div class="col-lg-10">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Year :</label>
                        <select class="form-select-sm" id="yearDropdownYearly"></select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-12 text-center mt-3">
        <button class="btn-go" id="btnFetchYearly">Go</button>
    </div>

    <div id="yearlyLeaveGrid"></div>
</div>

<script>
    const savedCompany = localStorage.getItem('selectedCompany');
    var companyDetails = JSON.parse(savedCompany);
    const CompanyId = companyDetails.CompanyId;
    const EmployeeId = localStorage.getItem('EmployeeId');
    const Token = localStorage.getItem("authToken");

    $(document).ready(function () {
        InitializeEmployeeDropdown();
        BindBranchDropdown();
        PopulateYearDropdowns();
        SetCurrentMonthYear();
    });

    function InitializeEmployeeDropdown() {
        $("#employeeDropdown").dxSelectBox({
            items: [],
            displayExpr: "displayName",
            valueExpr: "employeeCode",
            placeholder: "--Select Branch First--",
            searchEnabled: true,
            showClearButton: true,
            width: "100%"
        });
    }

    function goBack() {
        window.history.back();
    }

    function PopulateYearDropdowns() {
        const currentYear = new Date().getFullYear();
        const years = [];
        for (let i = currentYear - 5; i <= currentYear + 5; i++) {
            years.push(i);
        }

        years.forEach(year => {
            $('#yearDropdownMonthly').append(`<option value="${year}">${year}</option>`);
            $('#yearDropdownYearly').append(`<option value="${year}">${year}</option>`);
        });

        $('#yearDropdownMonthly').val(currentYear);
        $('#yearDropdownYearly').val(currentYear);
    }

    function SetCurrentMonthYear() {
        const currentMonth = new Date().getMonth() + 1;
        $('#monthDropdown').val(currentMonth);
    }

    async function showLoder() {
        $('#grid-loader').addClass('d-flex').show();
    }

    async function hideLoder() {
        $('#grid-loader').removeClass('d-flex').hide();
    }

    function BindBranchDropdown() {
        $.ajax({
            url: '@baseUrl/BranchAPI/GetAllBranchesListByCompanyId/' + CompanyId,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (response) {
                if (response?.data?.length > 0) {
                    $("#branchDropdown").dxSelectBox({
                        items: response.data,
                        displayExpr: "branchName",
                        valueExpr: "branchId",
                        placeholder: "--Select Branch--",
                        searchEnabled: true,
                        showClearButton: true,
                        width: "100%",
                        onValueChanged: function (e) {
                            let selectedBranchId = e.value ? e.value : 0;
                            BindEmployeeDropdownByBranch(selectedBranchId);
                        }
                    });
                }
            }
        });
    }

    function BindEmployeeDropdownByBranch(selectedBranchId) {
        const branchParam = selectedBranchId ? selectedBranchId : "0";

        $.ajax({
            type: "GET",
            url: '@(baseDomainUrl + "/api/EmployeeMasterAPI/GetAllEmployeeByBranchId")?BranchIds=' + branchParam + '&CompanyId=' + CompanyId,
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (response) {
                const employeeDropdown = $("#employeeDropdown").dxSelectBox("instance");
                console.log('response' ,response);
                if (response?.data?.length > 0) {
                    const employeeData = response.data.map(emp => ({                
                        employeeCode: emp.employeeCode,
                        displayName: `${emp.fullName} - ${emp.employeeCode}`
                    }));

                    employeeDropdown.option("items", employeeData);
                    employeeDropdown.option("placeholder", "--Select Employee--");
                    employeeDropdown.option("value", null);
                } else {
                    employeeDropdown.option("items", []);
                    employeeDropdown.option("placeholder", "No Employees Found");
                    employeeDropdown.option("value", null);
                }
            }
        });
    }

    // Main Go Button - Fetch data and show sections
    $('#btnGo').on('click', function () {
        const branchDropdown = $("#branchDropdown").dxSelectBox("instance");
        const branchId = branchDropdown.option("value");

        if (!branchId) {
            Swal.fire("Please select Branch");
            return;
        }

        const employeeDropdown = $("#employeeDropdown").dxSelectBox("instance");
        const employeeCode = employeeDropdown.option("value");

        console.log('Branch ID:', branchId);
        console.log('Employee ID type:', typeof employeeCode);

        if (!employeeCode) {
            Swal.fire("Please select an Employee");
            return;
        }

        // Show both sections
        $('#monthlySection').show();
        $('#yearlySection').show();

        // Auto-fetch monthly data with current month/year
        FetchMonthlyLeaveStatus();

        // Auto-fetch yearly data with current year
        FetchYearlyLeaveStatus();
    });

    // Fetch Monthly Leave Status
    $('#btnFetchMonthly').on('click', function () {
        FetchMonthlyLeaveStatus();
    });

    function FetchMonthlyLeaveStatus() {
      const employeeDropdown = $("#employeeDropdown").dxSelectBox("instance");
      const employeeCode = employeeDropdown.option("value");

      if (!employeeCode) {
          Swal.fire("Please select an Employee first");
          return;
      }

      const selectedMonth = $('#monthDropdown').val();
      const selectedYear = $('#yearDropdownMonthly').val();

        showLoder();

        $.ajax({
            url: '@baseDomainUrl/api/ReportAPI/GetEmployeeMonthlyLeaveStatus',
            type: 'GET',
            data: {
                EmpId: employeeCode,
                SelectedMonth: selectedMonth,
                SelectedYear: selectedYear
            },
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (response) {
                hideLoder();
                if (response.isSuccess) {
                    if (response.data && response.data.length > 0) {
                        RenderMonthlyLeaveGrid(response.data);
                    } else {
                        Swal.fire({
                            icon: 'info',
                            title: 'No Data Found',
                            text: 'No records found for the selected criteria.'
                        });
                        $('#monthlyLeaveGrid').hide();
                    }
                } else {
                    Swal.fire(response.responseMessage || "Error fetching data");
                }
            },
            error: function (xhr, status, error) {
                hideLoder();
                Swal.fire("Error occurred while fetching data");
                console.error(error);
            }
        });
    }

    // Fetch Yearly Leave Status
    $('#btnFetchYearly').on('click', function () {
        FetchYearlyLeaveStatus();
    });

    function FetchYearlyLeaveStatus() {
      const employeeDropdown = $("#employeeDropdown").dxSelectBox("instance");
      const employeeCode = employeeDropdown.option("value");

      if (!employeeCode) {
          Swal.fire("Please select an Employee first");
          return;
      }

      const selectedYear = $('#yearDropdownYearly').val();

        showLoder();

        $.ajax({
            url: '@baseDomainUrl/api/ReportAPI/GetEmployeeYearlyLeaveStatus',
            type: 'GET',
            data: {
                EmpId: employeeCode,
                CompId: CompanyId,
                Year: selectedYear
            },
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (response) {
                hideLoder();
                if (response.isSuccess) {
                    if (response.data && response.data.length > 0) {
                        RenderYearlyLeaveGrid(response.data);
                    } else {
                        Swal.fire({
                            icon: 'info',
                            title: 'No Data Found',
                            text: 'No records found for the selected criteria.'
                        });
                        $('#yearlyLeaveGrid').hide();
                    }
                } else {
                    Swal.fire(response.responseMessage || "Error fetching data");
                }
            },
            error: function (xhr, status, error) {
                hideLoder();
                Swal.fire("Error occurred while fetching data");
                console.error(error);
            }
        });
    }

    function RenderMonthlyLeaveGrid(data) {
        if ($("#monthlyLeaveGrid").data('dxDataGrid')) {
            $("#monthlyLeaveGrid").dxDataGrid('dispose');
        }

        $("#monthlyLeaveGrid").dxDataGrid({
            dataSource: data,
            showBorders: true,
            columnAutoWidth: true,
            height: 400,
            paging: { enabled: true, pageSize: 10 },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [10, 20, 50],
                showInfo: true
            },
            searchPanel: { visible: true },
            export: {
                enabled: true,
                allowExportSelectedData: false
            },
            columns: [
                { dataField: "employeeCode", caption: "Code", width: 100 },
                { dataField: "fullName", caption: "Name", width: 150 },
                { dataField: "leaveType", caption: "Leave Type", width: 120 },
                { dataField: "fromDate", caption: "From Date", dataType: "date", format: "dd/MM/yyyy" },
                { dataField: "toDate", caption: "To Date", dataType: "date", format: "dd/MM/yyyy" },
                { dataField: "totalDays", caption: "Days", width: 80, alignment: "center" },
                { dataField: "status", caption: "Status", width: 100 }
            ]
        });

        $("#monthlyLeaveGrid").show();
    }

    function RenderYearlyLeaveGrid(data) {
        if ($("#yearlyLeaveGrid").data('dxDataGrid')) {
            $("#yearlyLeaveGrid").dxDataGrid('dispose');
        }

        $("#yearlyLeaveGrid").dxDataGrid({
            dataSource: data,
            showBorders: true,
            columnAutoWidth: true,
            height: 400,
            paging: { enabled: true, pageSize: 10 },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [10, 20, 50],
                showInfo: true
            },
            searchPanel: { visible: true },
            export: {
                enabled: true,
                allowExportSelectedData: false
            },
            columns: [
                { dataField: "month", caption: "Month", width: 100 },
                { dataField: "casualLeave", caption: "Casual Leave", width: 100, alignment: "center" },
                { dataField: "sickLeave", caption: "Sick Leave", width: 100, alignment: "center" },
                { dataField: "earnedLeave", caption: "Earned Leave", width: 100, alignment: "center" },
                { dataField: "totalLeaves", caption: "Total", width: 80, alignment: "center" }
            ]
        });

        $("#yearlyLeaveGrid").show();
    }

    function clearAllData() {
        const branchDropdown = $("#branchDropdown").dxSelectBox("instance");
        if (branchDropdown) {
            branchDropdown.option("value", null);
        }

        const employeeDropdown = $("#employeeDropdown").dxSelectBox("instance");
        if (employeeDropdown) {
            employeeDropdown.option("value", null);
            employeeDropdown.option("items", []);
            employeeDropdown.option("placeholder", "--Select Branch First--");
        }

        SetCurrentMonthYear();
        PopulateYearDropdowns();

        $('#monthlySection').hide();
        $('#yearlySection').hide();
        $('#monthlyLeaveGrid').hide();
        $('#yearlyLeaveGrid').hide();
    }

    $('#btnClear').on('click', function () {
        clearAllData();
    });
</script>
@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Yearly Leave Balance";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}

<meta charset="UTF-8">
<title>Yearly Leave Balance</title>

<!-- DevExtreme -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/devextreme@23.2.3/dist/css/dx.light.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/devextreme@23.2.3/dist/js/dx.all.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
        padding: 0;
    }

    .header {
        background-color: #3f4d6b;
        color: white;
        font-size: 18px;
        font-weight: bold;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .back-btn:hover {
        background-color: #dfe6f1;
    }

    .main {
        display: flex;
        height: calc(100vh - 50px);
    }

    .left-section, .right-section {
        width: 50%;
        padding: 30px;
        background-color: #fff;
        box-sizing: border-box;
    }

    .separator {
        width: 1px;
        background-color: #ccc;
    }

    .date-row {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }

    .form-group {
        flex: 1;
    }

    label {
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
        font-size: 13px;
        color: #333;
    }

    select,
    input[type="date"] {
        padding: 4px 6px;
        font-size: 13px;
        height: 32px;
        border-radius: 4px;
        border: 1px solid #ccc;
        width: 130px;
        box-sizing: border-box;
    }

    #branchDropdown {
        width: 180px;
    }

    .btn-group {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }

        .btn-group button,
        .header + .main button {
            padding: 6px 14px;
            font-size: 13px;
            min-width: 70px;
        }

    button {
        border: none;
        background-color: #3f4d6b;
        color: white;
        font-weight: bold;
        border-radius: 4px;
        cursor: pointer;
    }

    #recordCount {
        color: red;
        font-weight: 600;
        margin-bottom: 15px;
        display: none;
    }

    #employeeGrid {
        height: calc(100vh - 180px);
    }

    #yearSelect {
        padding: 4px 6px;
        font-size: 13px;
        height: 30px;
        width: 110px;
        border-radius: 4px;
        border: 1px solid #ccc;
        box-sizing: border-box;
    }

    .back-btn {
        float: right;
        margin-top: 20px;
        margin-right: 40px;
    }

    .branch-row {
        margin-bottom: 15px;
    }

    .filter-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
    }

    .search-view-container {
        display: none;
        margin-bottom: 15px;
        align-items: center;
        gap: 15px;
    }

        .search-view-container.show {
            display: flex;
        }

        .search-view-container input {
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 240px;
        }

        .search-view-container button {
            padding: 6px 14px;
            font-size: 13px;
            min-width: 70px;
        }

    .no-data-message {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-style: italic;
        font-size: 14px;
    }

    #recordCount.show {
        display: block;
    }

    .btn-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.8;
    }

        .btn-loading::before {
            content: "";
            display: inline-block;
            width: 14px;
            height: 14px;
            margin-right: 8px;
            vertical-align: middle;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }

    @@keyframes spin {
        to

    {
        transform: rotate(360deg);
    }

    }
</style>

<div class="header">
    YEARLY LEAVE BALANCE
</div>

<div class="main">
    <!-- Left Section -->
    <div class="left-section">
        <div class="filter-section">
            <div class="date-row">
                <div class="form-group" style="width: 200px; display: inline-block; margin-right: 20px;">
                    <label for="branchDropdown">Branch:</label>
                    <div id="branchDropdown"></div>
                </div>
                <div class="form-group" style="width: 180px; display: inline-block; margin-right: 20px;">
                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate" class="form-control">
                </div>
                <div class="form-group" style="width: 180px; display: inline-block;">
                    <label for="endDate">End Date:</label>
                    <input type="date" id="endDate" class="form-control">
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button onclick="onFind()" id="btnfind">Find</button>
            <button onclick="onClear()">Clear</button>
            <button onclick="goBack()">Back</button>
        </div>
    </div>

    <!-- Vertical Separator -->
    <div class="separator"></div>

    <!-- Right Section -->
    <div class="right-section">
        <div id="recordCount">0 Records found.</div>

        <div class="search-view-container" id="searchViewContainer">
            <input type="text" id="employeeSearch" placeholder="Search employees..." />
            <button id="btnView">View & Export</button>
        </div>

        <div class="grid-wrapper" style="position: relative;" id="gridTag">
            <div id="grid-loader" class="grid-loader justify-content-center align-items-center flex-column"
                 style="display: none; inset: 0; background: rgba(255,255,255,0.6); z-index: 10;">
                <img src="@baseDomainUrl/loders/loder.png" class="grid-logo-spinner" style="width: 30px; height: 30px; animation: spin 1s linear infinite;" />
                <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>
            </div>

            <div class="no-data-message" id="noDataMessage">
                No data to display. Please select a branch and date range, then click Find to load employee data.
            </div>

            <div id="employeeGrid"></div>
        </div>
    </div>
</div>

<script>
    const Empid = parseInt(localStorage.getItem("EmployeeId"));
    const Role = localStorage.getItem("RoleSlug");
    const Token = localStorage.getItem("authToken");
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany || '{}');
    const Compname = companyDetails.CompanyName;
    const CompanyId = companyDetails.CompanyId;

    let originalEmployeeData = [];

    $(document).ready(function () {
        setDefaultDates();
        BindBranchDropdown();
        hideDataElements();
    });

    function setDefaultDates() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), 0, 1); // Jan 1
        const lastDay = new Date(today.getFullYear(), 11, 31); // Dec 31

        $('#startDate').val(formatDateForInput(firstDay));
        $('#endDate').val(formatDateForInput(lastDay));
    }

    function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function hideDataElements() {
        $('#recordCount').removeClass('show').hide();
        $('#searchViewContainer').removeClass('show').hide();
        $('#noDataMessage').show();
        $('#employeeGrid').hide();
    }

    function showDataElements() {
        $('#recordCount').addClass('show').show();
        $('#searchViewContainer').addClass('show').show();
        $('#noDataMessage').hide();
        $('#employeeGrid').show();
    }

    function goBack() {
        window.history.back();
    }

    function BindBranchDropdown() {
        $.ajax({
            url: '@baseDomainUrl/api/BranchAPI/GetAllBranchesListByCompanyId/' + CompanyId,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (response) {
                if (response?.data?.length > 0) {
                    $("#branchDropdown").dxTagBox({
                        items: response.data,
                        displayExpr: "branchName",
                        valueExpr: "branchId",
                        placeholder: "--Select Branch--",
                        showSelectionControls: true,
                        searchEnabled: true,
                        showClearButton: true,
                        maxDisplayedTags: 3,
                        applyValueMode: "instantly",
                        multiline: false,
                        minSearchLength: 0,
                        width: "100%",
                        onOpened: function () {
                            $(".dx-overlay-content").css("max-width", "150px");
                        }
                    });
                }
            },
            error: function () {
                console.error('Failed to load branches');
                Swal.fire('Error', 'Failed to load branches.', 'error');
            }
        });
    }

    function updateRecordCount() {
        const grid = $("#employeeGrid").dxDataGrid("instance");
        if (grid) {
            const visibleRows = grid.getVisibleRows();
            const filteredCount = visibleRows.length;
            $('#recordCount').text(`${filteredCount} Records found.`);

            if (filteredCount > 0) {
                $('#recordCount').css('color', '#28a745');
            } else {
                $('#recordCount').css('color', '#dc3545');
            }
        }
    }

    function onFind() {
        const branchTagBox = $("#branchDropdown").dxTagBox("instance");
        const selectedBranchIds = branchTagBox ? branchTagBox.option("value") : [];

        if (!selectedBranchIds || selectedBranchIds.length === 0) {
            Swal.fire('Warning', 'Please select at least one branch.', 'warning');
            return;
        }

        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();

        if (!startDate || !endDate) {
            Swal.fire('Warning', 'Please select both start and end dates.', 'warning');
            return;
        }

        // Extract month and year from start date
        const startDateObj = new Date(startDate);
        const selectedMonth = startDateObj.getMonth() + 1; // getMonth() returns 0-11, so add 1
        const selectedYear = startDateObj.getFullYear();

        $('#grid-loader').addClass('d-flex').show();
        hideDataElements();

        const branchIdsParam = selectedBranchIds.join(',');

        $.ajax({
            url: `@baseDomainUrl/api/EmployeeMasterAPI/GetAllEmployee_DropDown/${CompanyId}?BranchId=${branchIdsParam}&Month=${selectedMonth}&Year=${selectedYear}`,
            type: "GET",
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            dataType: "json",
            success: function (response) {
                const employeeData = response.data || response;
                originalEmployeeData = employeeData;

                if (employeeData && employeeData.length > 0) {
                    showDataElements();

                    const grid = $("#employeeGrid").dxDataGrid({
                        dataSource: employeeData,
                        keyExpr: "id",
                        selection: {
                            mode: "multiple",
                            showCheckBoxesMode: "always"
                        },
                        showBorders: true,
                        columnAutoWidth: true,
                        paging: {
                            enabled: false
                        },
                        scrolling: {
                            mode: "standard",
                            useNative: true,
                            showScrollbar: "always"
                        },
                        searchPanel: {
                            visible: false
                        },
                        height: 500,
                        columns: [
                            { dataField: "employeeCode", caption: "Employee Code", width: 150 },
                            { dataField: "id", caption: "EmployeeId", visible: false },
                            { dataField: "fullName", caption: "Employee Name" },
                            { dataField: "branchName", caption: "Branch", width: 150 }
                        ],
                        onContentReady: function() {
                            updateRecordCount();
                        }
                    }).dxDataGrid("instance");

                    $('#employeeSearch').off('input').on('input', function() {
                        const searchValue = $(this).val();
                        if (searchValue) {
                            grid.filter([
                                ['fullName', 'contains', searchValue],
                                'or',
                                ['employeeCode', 'contains', searchValue],
                                'or',
                                ['branchName', 'contains', searchValue]
                            ]);
                        } else {
                            grid.clearFilter();
                        }
                        setTimeout(updateRecordCount, 100);
                    });

                    const recordCount = employeeData.length;
                    $('#recordCount').text(`${recordCount} Records found.`);
                    $('#recordCount').css('color', '#28a745');
                } else {
                    hideDataElements();
                    $('#noDataMessage').text('No employees found for the selected branch(es).').show();
                }

                $('#grid-loader').removeClass('d-flex').hide();
            },
            error: function () {
                $('#grid-loader').removeClass('d-flex').hide();
                hideDataElements();
                $('#noDataMessage').text('Failed to load employees. Please try again.').show();
                Swal.fire('Error', 'Failed to load employees.', 'error');
            }
        });
    }

    function onClear() {
        const branchTagBox = $("#branchDropdown").dxTagBox("instance");
        if (branchTagBox) {
            branchTagBox.option("value", []);
        }
        setDefaultDates();

        const grid = $("#employeeGrid").dxDataGrid("instance");
        if (grid) {
            grid.option("dataSource", []);
            grid.clearSelection();
        }

        hideDataElements();
        $('#noDataMessage').text('No data to display. Please select a branch and date range, then click Find to load employee data.');
        $('#employeeSearch').val('');
        originalEmployeeData = [];
    }

    $('#btnView').on('click', function () {
        const branchTagBox = $("#branchDropdown").dxTagBox("instance");
        const selectedBranchIds = branchTagBox ? branchTagBox.option("value") : [];

        if (!selectedBranchIds || selectedBranchIds.length === 0) {
            Swal.fire('Warning', 'Please select at least one branch.', 'warning');
            return;
        }

        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();

        if (!startDate || !endDate) {
            Swal.fire('Warning', 'Please select both start and end dates.', 'warning');
            return;
        }

        const grid = $('#employeeGrid').dxDataGrid("instance");
        const selected = grid.getSelectedRowsData();

        if (!selected.length) {
            Swal.fire('Warning', 'Select at least one employee.', 'warning');
            return;
        }

        const empCodes = selected.map(emp => emp.employeeCode).join(',');

        const $btnView = $(this);
        $btnView.prop('disabled', true).addClass('btn-loading');

        // Build URL - EmpCode needs quotes, dates don't
        const empCodesParam = `${empCodes}`;
        const fullUrl = `@baseDomainUrl/api/ReportAPI/GetLeaveYearlySummary?EmpCode=${encodeURIComponent(empCodesParam)}&StratDate=${startDate}&EndDate=${endDate}`;

        console.log('API URL:', fullUrl);

        $.ajax({
            url: fullUrl,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (res) {
                console.log('API Response:', res);
                if (!res || !res.data || res.data.length === 0) {
                    Swal.fire('Info', 'No leave balance records found.', 'info');
                    return;
                }
                exportToExcel(res.data, startDate, endDate);
            },
            error: function (xhr, status, error) {
                console.error('API Error Details:');
                console.error('Status:', xhr.status);
                console.error('Status Text:', xhr.statusText);
                console.error('Response Text:', xhr.responseText);
                console.error('Error:', error);

                let errorMsg = 'Failed to fetch data.';
                if (xhr.responseText) {
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        errorMsg = errorResponse.message || errorResponse.title || errorMsg;
                    } catch (e) {
                        errorMsg = xhr.responseText;
                    }
                }

                Swal.fire('Error', errorMsg, 'error');
            },
            complete: function () {
                $btnView.prop('disabled', false).removeClass('btn-loading');
            }
        });
    });

function exportToExcel(data, startDate, endDate) {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet("Leave Balance");

    // Format date as DD-MM-YYYY
    const formatDate = (dateStr) => {
        const [yyyy, mm, dd] = dateStr.split("-");
        return `${dd}-${mm}-${yyyy}`;
    };

    // Get current date with day name
    const today = new Date();
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const formattedDate = `${days[today.getDay()]},${String(today.getDate()).padStart(2, '0')} ${months[today.getMonth()]},${today.getFullYear()}`;

    // Row 1: Company Name
    worksheet.mergeCells('A1:AA1');
    worksheet.getCell('A1').value = `Company Name : ${Compname}`;
    worksheet.getCell('A1').font = { bold: true, size: 12 };
    worksheet.getCell('A1').alignment = { horizontal: 'left', vertical: 'middle' };

    // Row 2: Current Date
    worksheet.mergeCells('A2:AA2');
    worksheet.getCell('A2').value = formattedDate;
    worksheet.getCell('A2').font = { bold: true };
    worksheet.getCell('A2').alignment = { horizontal: 'left', vertical: 'middle' };

    // Row 3: Date Range
    worksheet.mergeCells('A3:AA3');
    worksheet.getCell('A3').value = `Leave Transaction From := ${formatDate(startDate)} To ${formatDate(endDate)}`;
    worksheet.getCell('A3').font = { bold: true };
    worksheet.getCell('A3').alignment = { horizontal: 'left', vertical: 'middle' };

    // Row 4: Empty
    worksheet.addRow([]);

    // Row 5: Main Headers
    const row5 = worksheet.getRow(5);
    row5.values = [
        'Employee Code',
        'Employee Name',    
        'Opening Balance', '', '', '', '',  // H to L (5 columns)
        'Nov--2025', '', '', '', '',         // M to Q (5 columns)
        'Dec--2025', '', '', '', '',         // R to V (5 columns)
        'Jan--2026', '', '', '', ''          // W to AA (5 columns)
    ];

    // Row 6: Sub Headers - Leave Types
    const row6 = worksheet.getRow(6);
    row6.values = [
        '', '', '', '', '', '', '',  // Empty for employee details columns (A to G)
        'HD', 'ML', 'PL', 'SH/COMP', '',  // Opening Balance (H to L)
        'HD', 'ML', 'PL', 'SH/COMP', '',  // Nov-2025 (M to Q)
        'HD', 'ML', 'PL', 'SH/COMP', '',  // Dec-2025 (R to V)
        'HD', 'ML', 'PL', 'SH/COMP', ''   // Jan-2026 (W to AA)
    ];

    // Style headers
    [row5, row6].forEach(row => {
        row.eachCell((cell) => {
            cell.font = { bold: true, size: 10 };
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFD3D3D3' }
            };
            cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });
    });

    // Merge cells for employee details (vertical merge A5:A6, B5:B6, etc.)
    worksheet.mergeCells('A5:A6'); // Employee Code
    worksheet.mergeCells('B5:B6'); // Employee Name
    worksheet.mergeCells('C5:C6'); // Date of Join
    worksheet.mergeCells('D5:D6'); // Department
    worksheet.mergeCells('E5:E6'); // Vertical
    worksheet.mergeCells('F5:F6'); // Designation Name
    worksheet.mergeCells('G5:G6'); // Business

    // Merge cells for leave sections (horizontal merge)
    worksheet.mergeCells('H5:L5'); // Opening Balance
    worksheet.mergeCells('M5:Q5'); // Nov--2025
    worksheet.mergeCells('R5:V5'); // Dec--2025
    worksheet.mergeCells('W5:AA5'); // Jan--2026

    // Group data by employee
    const employeeMap = {};
    
    data.forEach(row => {
        const empCode = row.employeeCode;
        
        if (!employeeMap[empCode]) {
            employeeMap[empCode] = {
                empCode: empCode,
                fullName: row.fullName,
                leaves: {
                    HD: {},
                    ML: {},
                    PL: {},
                    'SH/COMP': {},
                    SHL: {},
                    COMP: {}
                }
            };
        }
        
        // Store leave data by type
        const leaveType = row.leaveType;
        if (leaveType) {
            // Map SHL or COMP to SH/COMP
            if (leaveType === 'SHL' || leaveType === 'COMP') {
                if (!employeeMap[empCode].leaves['SH/COMP'].opening) {
                    employeeMap[empCode].leaves['SH/COMP'] = row;
                } else {
                    // Combine values if both exist
                    const existing = employeeMap[empCode].leaves['SH/COMP'];
                    existing.opening = (existing.opening || 0) + (row.opening || 0);
                    existing.used_Nov = (existing.used_Nov || 0) + (row.used_Nov || 0);
                    existing.used_Dec = (existing.used_Dec || 0) + (row.used_Dec || 0);
                    existing.used_Jan = (existing.used_Jan || 0) + (row.used_Jan || 0);
                }
            } else if (employeeMap[empCode].leaves[leaveType] !== undefined) {
                employeeMap[empCode].leaves[leaveType] = row;
            }
        }
    });

    // Add data rows - ONE ROW PER EMPLOYEE
    Object.values(employeeMap).forEach(emp => {
        const leaves = emp.leaves;
        
        // Get data for each leave type
        const hdData = leaves.HD || {};
        const mlData = leaves.ML || {};
        const plData = leaves.PL || {};
        const shCompData = leaves['SH/COMP'] || {};

        // Format date of join
        let doj = '';
        if (emp.dateOfJoin) {
            const dojDate = new Date(emp.dateOfJoin);
            if (!isNaN(dojDate.getTime())) {
                doj = `${String(dojDate.getDate()).padStart(2, '0')}-${String(dojDate.getMonth() + 1).padStart(2, '0')}-${dojDate.getFullYear()}`;
            }
        }

        // Create single row with all data - MATCHING CLIENT FORMAT EXACTLY
        const rowData = [
            emp.empCode,                    // A - Employee Code
            emp.fullName,                   // B - Employee Name
            hdData.opening || 0,           // H - HD
            mlData.opening || 0,           // I - ML
            plData.opening || 0,           // J - PL
            shCompData.opening || 0,       // K - SH/COMP
            '',                            // L - Empty column
            // Nov-2025 (M to Q)
            hdData.used_Nov || 0,          // M - HD
            mlData.used_Nov || 0,          // N - ML
            plData.used_Nov || 0,          // O - PL
            shCompData.used_Nov || 0,      // P - SH/COMP
            '',                            // Q - Empty column
            // Dec-2025 (R to V)
            hdData.used_Dec || 0,          // R - HD
            mlData.used_Dec || 0,          // S - ML
            plData.used_Dec || 0,          // T - PL
            shCompData.used_Dec || 0,      // U - SH/COMP
            '',                            // V - Empty column
            // Jan-2026 (W to AA)
            hdData.used_Jan || 0,          // W - HD
            mlData.used_Jan || 0,          // X - ML
            plData.used_Jan || 0,          // Y - PL
            shCompData.used_Jan || 0,      // Z - SH/COMP
            ''                             // AA - Empty column
        ];

        const excelRow = worksheet.addRow(rowData);
        
        // Apply styling to data row
        excelRow.eachCell((cell, colNumber) => {
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
            
            // Columns H onwards (leave data) - center align
            if (colNumber >= 8) {
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
            } else {
                cell.alignment = { horizontal: 'left', vertical: 'middle' };
            }
        });
    });

    // Set column widths - MATCHING CLIENT FORMAT
    worksheet.getColumn(1).width = 12;  // Employee Code
    worksheet.getColumn(2).width = 28;  // Employee Name
    worksheet.getColumn(3).width = 13;  // Date of Join
    worksheet.getColumn(4).width = 15;  // Department
    worksheet.getColumn(5).width = 10;  // Vertical
    worksheet.getColumn(6).width = 20;  // Designation Name
    worksheet.getColumn(7).width = 15;  // Business
    
    // Leave columns - uniform width
    for (let i = 8; i <= 27; i++) {
        worksheet.getColumn(i).width = 8;
    }

    // Set row heights
    worksheet.getRow(5).height = 30;
    worksheet.getRow(6).height = 20;

    // Save file
    workbook.xlsx.writeBuffer().then(buffer => {
        const fileName = `Leave_Balance_${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}.xlsx`;
        const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        saveAs(blob, fileName);

        Swal.fire('Success', 'Excel file exported successfully!', 'success');
    }).catch(error => {
        console.error('Export error:', error);
        Swal.fire('Error', 'Failed to export Excel file.', 'error');
    });
}
</script>
@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Employee Transfer";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseAPIDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}


<div class="card">
    <div class="card-header bg-transparent ml-0 py-0">
        <div class="row">
            <div class="col-6">
                <h6 class="pt-2 mb-0">
                    Manage Employee Transfer
                </h6>
            </div>

            <div class="col-6 d-flex justify-content-end align-items-center">
                <button id="addTransfer"
                        type="button"
                        class="btn mr-1 rounded-1"
                        style="background-color:#2395c6; color:white;">
                    Add
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">

        <div class="card-body">

            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">

                        <div class="grid-wrapper " style="position: relative; ">
                            <div id="grid-loader" class="grid-loader justify-content-center align-items-center flex-column "
                                 style="display: none;  inset: 0; background: rgba(255,255,255,0.6); z-index: 10; ">
                                <img src="@baseAPIDomainUrl/loders/loder.png" class="grid-logo-spinner" style="width: 30px; height: 30px; animation: spin 1s linear infinite;" />
                                <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>
                            </div>
                            <div id="gridTag">
                                <div class="rowCount" id="rowCount1"></div>
                                <div id="gridContainer"></div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<div class="modal fade" id="addTransferModal" tabindex="-1" aria-labelledby="addTransferLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title btn-heading-title" id="modalTitle">Add Employee Transfer</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body-font" style="font-size:12px;">
                <form id="transferForm">
                    <input type="hidden" id="transferId" value="0">

                    <div class="row">
                        <!-- Application Date -->
                        <div class="col-md-6">
                            <div class="form-group mt-3 position-relative">
                                <input type="date" class="form-control floating-input" id="applicationDate" placeholder="Application Date">
                                <label class="floating-label" for="applicationDate">Application Date <span class="text-danger">*</span></label>
                            </div>
                            <span id="spnapplicationDate" style="color:red; display:none; font-size: 0.85em;">Please Select Application Date</span>
                        </div>

                        <!-- Current Branch -->
                        <div class="col-md-6">
                            <div class="mt-3 form-floating-custom">
                                <div class="searchable-select-wrapper" id="currentBranchWrapper">
                                    <label for="currentBranch">Current Branch <span class="text-danger">*</span></label>
                                    <input type="text" class="searchable-select-input" id="currentBranch" readonly>
                                    <span class="searchable-select-arrow">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                            <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                        </svg>
                                    </span>
                                    <div class="searchable-select-dropdown">
                                        <div class="searchable-select-search">
                                            <input type="text" placeholder="Search branch..." class="search-input">
                                        </div>
                                        <div class="searchable-select-options"></div>
                                    </div>
                                </div>
                                <span id="spncurrentBranch" style="color:red; display:none; font-size: 0.85em;">Please Select Current Branch</span>
                            </div>
                        </div>

                        <!-- Employee -->
                        <div class="col-md-6">
                            <div class="mt-3 form-floating-custom">
                                <div class="searchable-select-wrapper" id="employeeTransferWrapper">
                                    <label for="employeeTransfer">Employee <span class="text-danger">*</span></label>
                                    <input type="text" class="searchable-select-input" id="employeeTransfer" readonly>
                                    <span class="searchable-select-arrow">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                            <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                        </svg>
                                    </span>
                                    <div class="searchable-select-dropdown">
                                        <div class="searchable-select-search">
                                            <input type="text" placeholder="Search employee..." class="search-input">
                                        </div>
                                        <div class="searchable-select-options"></div>
                                    </div>
                                </div>
                                <span id="spnemployeeTransfer" style="color:red; display:none; font-size: 0.85em;">Please Select Employee</span>
                            </div>
                        </div>

                        <!-- Transfer Branch -->
                        <div class="col-md-6">
                            <div class="mt-3 form-floating-custom">
                                <div class="searchable-select-wrapper" id="transferBranchWrapper">
                                    <label for="transferBranch">Transfer Branch <span class="text-danger">*</span></label>
                                    <input type="text" class="searchable-select-input" id="transferBranch" readonly>
                                    <span class="searchable-select-arrow">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                            <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                        </svg>
                                    </span>
                                    <div class="searchable-select-dropdown">
                                        <div class="searchable-select-search">
                                            <input type="text" placeholder="Search branch..." class="search-input">
                                        </div>
                                        <div class="searchable-select-options"></div>
                                    </div>
                                </div>
                                <span id="spntransferBranch" style="color:red; display:none; font-size: 0.85em;">Please Select Transfer Branch</span>
                            </div>
                        </div>

                        <!-- Effective Date -->
                        <div class="col-md-6">
                            <div class="form-group mt-3 position-relative">
                                <input type="date" class="form-control floating-input" id="effectiveDate" placeholder="Effective Date">
                                <label class="floating-label" for="effectiveDate">Effective Date <span class="text-danger">*</span></label>
                            </div>
                            <span id="spneffectiveDate" style="color:red; display:none; font-size: 0.85em;">Please Select Effective Date</span>
                        </div>

                        <!-- Reason -->
                        <div class="col-md-6">
                            <div class="form-group mt-3 position-relative">
                                <input type="text" class="form-control floating-input" id="reason" placeholder="Reason">
                                <label class="floating-label" for="reason">Reason <span class="text-danger">*</span></label>
                            </div>
                            <span id="spnreason" style="color:red; display:none; font-size: 0.85em;">Please Enter Reason</span>
                        </div>

                    </div>
                </form>
            </div>
            <div class="modal-footer btn-heading-title">
                <button type="button" class="btn btn-primary" id="btnSaveTransfer" style="background-color:#2395c6; color:white;">Save</button>
                <button type="button" class="btn btn-primary" id="btnSavingTransfer" style="background-color:#2395c6; color:white;display:none;" disabled><span class="spinner-border spinner-border-sm me-2" role="status"></span> Saving..</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewTransferModal" tabindex="-1" aria-labelledby="previewTransferLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Transfer Letter Preview</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Preview content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script src="~/assets/js/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    var companyDetails = JSON.parse(localStorage.getItem('selectedCompany'));
    const CompanyId = companyDetails?.CompanyId;
    const EmployeeId = localStorage.getItem('EmployeeId');
    const Token = localStorage.getItem("authToken");

    $(document).ready(function(){
        // Set current date by default
        var today = new Date().toISOString().split('T')[0];
        $('#applicationDate').val(today);

        loadEmployeeTransfers(CompanyId);

        $('#employeeTransfer').searchableSelect({
            data: [],
            valueKey: 'employeeId',
            textKey: 'employeeName',
            placeholder:'Employee',
            searchPlaceholder: 'Search employee...'
        });

        BindBranchDropdownForTransfer();
    })

    $("#addTransfer").click(() => {
        resetTransferForm();
        $('#modalTitle').text('Add Employee Transfer');
        $("#addTransferModal").modal('show');
    });

    function showbtnLoder(isUpdate){
        $('#btnSaveTransfer').hide();
        if(isUpdate) {
            $('#btnSavingTransfer').html('<span class="spinner-border spinner-border-sm me-2" role="status"></span> Updating..');
        } else {
            $('#btnSavingTransfer').html('<span class="spinner-border spinner-border-sm me-2" role="status"></span> Saving..');
        }
        $('#btnSavingTransfer').show();
    }

    function hidebtnLoder(){
        $('#btnSaveTransfer').show();
        $('#btnSavingTransfer').hide();
    }

    async function BindBranchDropdownForTransfer() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '@baseUrl/BranchAPI/GetAllBranchesListByCompanyId/' + CompanyId,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (data) {
                    if (data.isSuccess) {
                        // Initialize Current Branch dropdown
                        $('#currentBranch').searchableSelect({
                            data: data.data || [],
                            valueKey: 'branchId',
                            textKey: 'branchName',
                            placeholder: 'Current Branch',
                            searchPlaceholder: 'Search branch...',
                            onChange: function(item) {
                                BindEmployeeByBranchIdForTransfer(item.branchId);
                            }
                        });

                        // Initialize Transfer Branch dropdown
                        $('#transferBranch').searchableSelect({
                            data: data.data || [],
                            valueKey: 'branchId',
                            textKey: 'branchName',
                            placeholder: 'Transfer Branch',
                            searchPlaceholder: 'Search branch...'
                        });

                        resolve(data.data);
                    } else {
                        reject('Failed to fetch branches');
                    }
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }

    async function BindEmployeeByBranchIdForTransfer() {
        var branchId = $('#currentBranch').data('searchableSelect').getValue();
        if (!branchId) {
            return Promise.resolve();
        }
        var payLoad = {
            BranchId: branchId,
            CompanyId: CompanyId
        }
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '@baseUrl/EmployeeMasterAPI/GetEmployeeListByBranchId',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                data: JSON.stringify(payLoad),
                success: function (data) {
                    if (data.isSuccess) {
                        const dropdownEmployee = $('#employeeTransfer').data('searchableSelect');
                        if (dropdownEmployee) {
                            dropdownEmployee.setData(data.data);
                        }
                        resolve(data.data);
                    } else {
                        reject('Failed to fetch employees');
                    }
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }

    async function loadEmployeeTransfers(CompanyId) {
        $('#grid-loader').addClass('d-flex').show();
        return new Promise((resolve, reject) => {
            $.ajax({
                url: `@baseUrl/EmployeeTransferAPI/GetEmployeeTransfer/${CompanyId}`,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (response) {
                    if (!response.isSuccess) {
                        $('#grid-loader').removeClass('d-flex').hide();
                        toastr.error(response.responseMessage || 'Failed to load data');
                        reject(response.responseMessage);
                        return;
                    }

                    if (response.data && response.data.length > 0) {
                        console.log('Sample data structure:', response.data[0]);
                    }

                    var gridInstance = $("#gridContainer").dxDataGrid({
                        dataSource: response.data || [],
                        columns: [
                            {
                                dataField: 'effectiveDate',
                                caption: 'Effective Date',
                                dataType: 'date',
                                format: 'dd-MM-yyyy'
                            },
                            { dataField: 'currentBranchName', caption: 'Current Branch' },
                            { dataField: 'fullName', caption: 'Employee Name' },
                            { dataField: 'transferBranchName', caption: 'Transfer Branch' },
                            { dataField: 'reason', caption: 'Reason' },
                            { dataField: 'transferId', caption: 'TransferId', visible: false },
                      
                            {
                                caption: 'Edit',
                                dataType: 'string',
                                width: '70px',
                                alignment: 'center',
                                cellTemplate: function (container, options) {
                                    var buttonElement = $('<a href="javascript:;" class="edit-action" title="Edit Transfer">' +
                                        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">' +
                                        '<path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>' +
                                        '<path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>' +
                                        '</svg>' +
                                        '</a>');

                                    buttonElement.on('click', function () {
                                        UpdateTransferData(options.data);
                                    });

                                    buttonElement.appendTo(container);
                                }
                            },
                            {
                                caption: 'Delete',
                                dataType: 'string',
                                width: '80px',
                                alignment: 'center',
                                cellTemplate: function (container, options) {
                                    var buttonElement = $('<a href="javascript:;" class="delete-action" title="Delete Transfer">' +
                                        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">' +
                                        '<path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>' +
                                        '<path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>' +
                                        '</svg>' +
                                        '</a>');

                                    buttonElement.on('click', function () {
                                        DeleteTransfer(options.data);
                                    });

                                    buttonElement.appendTo(container);
                                }
                            },      {
                                caption: 'Preview',
                                dataType: 'string',
                                width: '80px',
                                alignment: 'center',
                                cellTemplate: function (container, options) {
                                    var buttonElement = $('<a href="javascript:;" class="preview-action" title="Preview Transfer Letter">' +
                                        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">' +
                                        '<path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/>' +
                                        '<path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/>' +
                                        '</svg>' +
                                        '</a>');

                                    buttonElement.on('click', function () {
                                        PreviewTransferLetter(options.data);
                                    });

                                    buttonElement.appendTo(container);
                                }
                            },
                            {
                                caption: 'Export',
                                dataType: 'string',
                                width: '80px',
                                alignment: 'center',
                                cellTemplate: function (container, options) {
                                    var buttonElement = $('<a href="javascript:;" class="export-action" title="Export to PDF">' +
                                        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">' +
                                        '<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>' +
                                        '<path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/>' +
                                        '</svg>' +
                                        '</a>');

                                    buttonElement.on('click', function () {
                                        ExportTransferLetterToPDF(options.data);
                                    });

                                    buttonElement.appendTo(container);
                                }
                            }
                        ],
                        columnAutoWidth: true,
                        allowColumnResizing: true,
                        columnResizingMode: "widget",
                        wordWrapEnabled: false,
                        showBorders: true,
                        scrolling: {
                            mode: "standard",
                            useNative: true,
                            scrollByContent: true,
                            scrollByThumb: true,
                            showScrollbar: "always"
                        },
                        rowAlternationEnabled: false,
                        grouping: { autoExpandAll: false },
                        paging: { pageSize: 10 },
                        pager: {
                            showPageSizeSelector: true,
                            allowedPageSizes: [10, 25, 50, 100]
                        },
                        headerFilter: { visible: false },
                        filterRow: { visible: false, applyFilter: "auto" },
                        groupPanel: { visible: false },
                        searchPanel: { visible: true, width: 240, placeholder: "Search..." },
                        allowColumnReordering: false,
                        onContentReady(e) {
                            $('.rowCount').html('Total Records: ' + e.component.totalCount());
                            e.component.updateDimensions();
                            $('#grid-loader').removeClass('d-flex').hide();
                        }
                    }).dxDataGrid('instance');

                    $('#grid-loader').removeClass('d-flex').hide();
                    toastr.success(response.responseMessage || 'Data loaded successfully');
                    resolve(response.data);
                },
                error: function (xhr, status, error) {
                    $('#grid-loader').removeClass('d-flex').hide();
                    console.error('Error loading employee transfers:', error);

                    let errorMessage = 'Failed to load employee transfers';
                    if (xhr.responseJSON && xhr.responseJSON.responseMessage) {
                        errorMessage = xhr.responseJSON.responseMessage;
                    }

                    toastr.error(errorMessage);
                    reject(error);
                }
            });
        });
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
    }

    function PreviewTransferLetter(data) {
        const effectiveDate = formatDate(data.effectiveDate || data.EffectiveDate);
        const currentDate = formatDate(new Date());

        const letterHTML = `
            <div style="padding: 20px; font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
                <div style="text-align: center; border: 2px solid #000; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="width: 100px; height: 80px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center;">
                            <img src="@baseAPIDomainUrl/CompanyLogo/${companyDetails?.CompanyLogo || 'default-logo.png'}" alt="Company Logo" style="max-width: 90px; max-height: 70px;">
                        </div>
                        <h2 style="margin: 0; flex: 1; text-align: center;">TRANSFER LETTER</h2>
                        <div style="text-align: right; width: 150px;">
                            <strong>Date : </strong>${currentDate}
                        </div>
                    </div>
                    <h3 style="margin: 10px 0;">${companyDetails?.CompanyName || 'COMPANY NAME'}</h3>
                </div>

                <div style="margin-bottom: 20px; line-height: 1.8;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 5px;"><strong>Name</strong></td>
                            <td style="padding: 5px;">: ${data.fullName || data.FullName || ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;"><strong>Employee Code</strong></td>
                            <td style="padding: 5px;">: ${data.employeeCode || data.EmployeeCode || ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;"><strong>Designation</strong></td>
                            <td style="padding: 5px;">: ${data.designationName || data.DesignationName || ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;"><strong>Department</strong></td>
                            <td style="padding: 5px;">: ${data.departmentName || data.DepartmentName || ''}</td>
                        </tr>
                    </table>
                </div>

                <div style="margin-bottom: 20px;">
                    <p><strong>Dear ${data.fullName || data.FullName || ''}</strong></p>
                </div>

                <div style="margin-bottom: 20px; line-height: 1.8; text-align: justify;">
                    <p>We are pleased to inform you that you are hereby transferred from <strong>${data.currentBranchName || data.CurrentBranchName || ''}</strong> to <strong>${data.transferBranchName || data.TransferBranchName || ''}</strong>, with effect from <strong>${effectiveDate}</strong>.</p>

                    <p>As such, you will be reporting for duty & further assignment of work, accordingly, to <strong>${data.reportingManagerName || data.ReportingManagerName || ''}</strong>. All the rules & regulations and terms & conditions as applicable to your category / post at the place you are transferred shall be applicable to you, accordingly.</p>

                    <p>However, we accept your sincere efforts and also wish you all the best to fulfill your future assignment.</p>
                </div>

                <div style="margin-top: 40px;">
                    <p style="margin: 5px 0;"><strong>For ${companyDetails?.CompanyName || 'COMPANY NAME'}</strong></p>
                    <div style="margin-top: 40px; margin-bottom: 10px;">
                        <p style="margin: 0;"><strong>(Authorized Signatory)</strong></p>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <p style="margin: 5px 0;"><strong>Encl. :</strong></p>
                    <p style="margin: 5px 0;"><strong>CC :</strong></p>
                </div>
            </div>
        `;

        $('#previewContent').html(letterHTML);
        $('#previewTransferModal').modal('show');
    }

    function ExportTransferLetterToPDF(data) {
        const effectiveDate = formatDate(data.effectiveDate || data.EffectiveDate);
        const currentDate = formatDate(new Date());

        const letterHTML = `
            <div style="padding: 20px; font-family: Arial, sans-serif;">
                <div style="text-align: center; border: 2px solid #000; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="width: 100px; height: 80px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center;">
                            <img src="@baseAPIDomainUrl/CompanyLogo/${companyDetails?.CompanyLogo || 'default-logo.png'}" alt="Company Logo" style="max-width: 90px; max-height: 70px;">
                        </div>
                        <h2 style="margin: 0; flex: 1; text-align: center;">TRANSFER LETTER</h2>
                        <div style="text-align: right; width: 150px;">
                            <strong>Date : </strong>${currentDate}
                        </div>
                    </div>
                    <h3 style="margin: 10px 0;">${companyDetails?.CompanyName || 'COMPANY NAME'}</h3>
                </div>

                <div style="margin-bottom: 20px; line-height: 1.8;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 5px; width: 150px;"><strong>Name</strong></td>
                            <td style="padding: 5px;">: ${data.fullName || data.FullName || ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;"><strong>Employee Code</strong></td>
                            <td style="padding: 5px;">: ${data.employeeCode || data.EmployeeCode || ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;"><strong>Designation</strong></td>
                            <td style="padding: 5px;">: ${data.designationName || data.DesignationName || ''}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;"><strong>Department</strong></td>
                            <td style="padding: 5px;">: ${data.departmentName || data.DepartmentName || ''}</td>
                        </tr>
                    </table>
                </div>

                <div style="margin-bottom: 20px;">
                    <p><strong>Dear ${data.fullName || data.FullName || ''}</strong></p>
                </div>

                <div style="margin-bottom: 20px; line-height: 1.8; text-align: justify;">
                    <p>We are pleased to inform you that you are hereby transferred from <strong>${data.currentBranchName || data.CurrentBranchName || ''}</strong> to <strong>${data.transferBranchName || data.TransferBranchName || ''}</strong>, with effect from <strong>${effectiveDate}</strong>.</p>

                    <p>As such, you will be reporting for duty & further assignment of work, accordingly, to <strong>${data.reportingManagerName || data.ReportingManagerName || ''}</strong>. All the rules & regulations and terms & conditions as applicable to your category / post at the place you are transferred shall be applicable to you, accordingly.</p>

                    <p>However, we accept your sincere efforts and also wish you all the best to fulfill your future assignment.</p>
                </div>

                <div style="margin-top: 40px;">
                    <p style="margin: 5px 0;"><strong>For ${companyDetails?.CompanyName || 'COMPANY NAME'}</strong></p>
                    <div style="margin-top: 40px; margin-bottom: 10px;">
                        <p style="margin: 0;"><strong>(Authorized Signatory)</strong></p>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <p style="margin: 5px 0;"><strong>Encl. :</strong></p>
                    <p style="margin: 5px 0;"><strong>CC :</strong></p>
                </div>
            </div>
        `;

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = letterHTML;
        document.body.appendChild(tempDiv);

        const opt = {
            margin: 10,
            filename: `Transfer_Letter_${data.fullName || data.FullName || 'Employee'}_${new Date().getTime()}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(tempDiv).save().then(() => {
            document.body.removeChild(tempDiv);
            toastr.success('Transfer letter exported successfully!');
        });
    }

    $('#btnSaveTransfer').click(function () {
        var transferId = $('#transferId').val();
        var isUpdate = transferId > 0;
        showbtnLoder(isUpdate);

        var currentBranch = $('#currentBranch').data('searchableSelect').getValue();
        var employee = $('#employeeTransfer').data('searchableSelect').getValue();
        var transferBranch = $('#transferBranch').data('searchableSelect').getValue();
        var effectiveDate = $('#effectiveDate').val();
        var reason = $('#reason').val();
        var isValid = true;

        // Validation
        if (!currentBranch) {
            $('#spncurrentBranch').show();
            isValid = false;
        } else {
            $('#spncurrentBranch').hide();
        }

        if (!employee) {
            $('#spnemployeeTransfer').show();
            isValid = false;
        } else {
            $('#spnemployeeTransfer').hide();
        }

        if (!transferBranch) {
            $('#spntransferBranch').show();
            isValid = false;
        } else {
            $('#spntransferBranch').hide();
        }

        if (!effectiveDate) {
            $('#spneffectiveDate').show();
            isValid = false;
        } else {
            $('#spneffectiveDate').hide();
        }

        if (!reason || reason.trim() === '') {
            $('#spnreason').show();
            isValid = false;
        } else {
            $('#spnreason').hide();
        }

        if (!isValid) {
            hidebtnLoder();
            return;
        }

        // Match API Model exactly
        var transferData = {
            TransferId: parseInt(transferId),
            EmployeeId: parseInt(employee),
            CurrentBranchId: parseInt(currentBranch),
            TransferBranchId: parseInt(transferBranch),
            EffectiveDate: effectiveDate,
            Reason: reason.trim(),
            IsEnabled: true,
            IsDeleted: false,
            CreatedBy: parseInt(EmployeeId),
            UpdatedBy: parseInt(EmployeeId)
        };

        var apiUrl = isUpdate
            ? "@baseUrl/EmployeeTransferAPI/UpdateEmployeeTransfer"
            : "@baseUrl/EmployeeTransferAPI/CreateEmployeeTransfer";

        var httpMethod = isUpdate ? "PUT" : "POST";

        $.ajax({
            url: apiUrl,
            type: httpMethod,
            contentType: 'application/json',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            data: JSON.stringify(transferData),
            success: function (response) {
                if (response.isSuccess) {
                    round_success_noti(response.responseMessage);
                    $("#addTransferModal").modal('hide');
                    loadEmployeeTransfers(CompanyId);
                } else {
                    round_error_noti(response.responseMessage);
                }
                hidebtnLoder();
            },
            error: function (xhr) {
                hidebtnLoder();
                console.error('Error:', xhr);
                var errorMsg = 'Unable to save employee transfer';
                if (xhr.responseJSON && xhr.responseJSON.responseMessage) {
                    errorMsg = xhr.responseJSON.responseMessage;
                }
                round_error_noti(errorMsg);
            }
        });
    });

    async function resetTransferForm() {
        $('#transferId').val('0');

        // Set current date by default for effective date
        var today = new Date().toISOString().split('T')[0];
        $('#applicationDate').val(today);
        $('#effectiveDate').val('');

        $('#currentBranch').data('searchableSelect').clear();
        $('#employeeTransfer').data('searchableSelect').clear();
        $('#transferBranch').data('searchableSelect').clear();
        $('#reason').val('');
        hidebtnLoder();

        $('#btnSaveTransfer').text('Save');
        $('#spnapplicationDate, #spncurrentBranch, #spnemployeeTransfer, #spntransferBranch, #spneffectiveDate, #spnreason').hide();
    }

    async function UpdateTransferData(data) {
        console.log('data',data);
        await resetTransferForm();
        $('#modalTitle').text('Update Employee Transfer');
        $('#btnSaveTransfer').text('Update');

        // Use correct property name: TransferId (not EmployeeTransferId)
        $('#transferId').val(data.transferId || data.TransferId || 0);

        // Set current branch and load employees
        const currentBranchId = data.currentBranchId || data.CurrentBranchId;
        $('#currentBranch').data('searchableSelect').setValue(currentBranchId);
        await BindEmployeeByBranchIdForTransfer();

        // Set employee
        const employeeId = data.employeeId || data.EmployeeId;
        $('#employeeTransfer').data('searchableSelect').setValue(employeeId);

        // Set transfer branch
        const transferBranchId = data.transferBranchId || data.TransferBranchId;
        $('#transferBranch').data('searchableSelect').setValue(transferBranchId);

        // Set effective date
        var effDateStr = data.effectiveDate || data.EffectiveDate;
        if (effDateStr) {
            if (effDateStr.includes('T')) {
                effDateStr = effDateStr.split('T')[0];
            } else if (effDateStr.includes(' ')) {
                effDateStr = effDateStr.split(' ')[0];
            }
            $('#effectiveDate').val(effDateStr);
        }

        // Set reason
        $('#reason').val(data.reason || data.Reason || '');

        $("#addTransferModal").modal('show');
    }

    function DeleteTransfer(data) {
        debugger;
           // Use correct property name: TransferId
           const transferId = data.transferId || data.TransferId;
           console.log('data',data);
           if (confirm('Are you sure you want to delete this transfer?')) {
               var deletePayload = {
                   Id: parseInt(transferId),
                   DeletedBy: (EmployeeId).toString()
               };

               $.ajax({
                   url: `@baseUrl/EmployeeTransferAPI/Delete`,
                   type: "DELETE",
                   contentType: 'application/json',
                   headers: {
                       'Authorization': 'Bearer ' + Token
                   },
                   data: JSON.stringify(deletePayload),
                   success: function (response) {
                       if (response.isSuccess) {
                           round_success_noti(response.responseMessage);
                           loadEmployeeTransfers(CompanyId);
                       } else {
                           round_error_noti(response.responseMessage);
                       }
                   },
                   error: function (xhr) {
                       console.error('Error:', xhr);
                       var errorMsg = 'Unable to delete transfer';
                       if (xhr.responseJSON && xhr.responseJSON.responseMessage) {
                           errorMsg = xhr.responseJSON.responseMessage;
                       }
                       round_error_noti(errorMsg);
                   }
               });
           }
       }
</script>
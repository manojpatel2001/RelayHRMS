@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Scheme Master";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}

<title>Scheme Master</title>
<link href="~/commoncss.css" rel="stylesheet" />

<!-- jQuery + Bootstrap + SweetAlert + DevExtreme -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.all.min.js"></script>


<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
    }

    .form-section {
        padding: 15px;
        border: 1px solid #ccc;
        max-width: 100%;
        background-color: white;
    }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        font-weight: 600;
        padding: 6px 14px;
        border: none;
        border-radius: 4px;
        margin-right: 8px;
        cursor: pointer;
        font-size: 13px;
    }

        .btn-custom:hover {
            background-color: #2c3a57;
        }

    .search-panel-container {
        background-color: #3e4b6d;
        padding: 6px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }



    .form-label {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .form-control-sm, .form-select-sm {
        height: calc(1.5em + .5rem + 2px);
        font-size: 0.875rem;
        padding: .25rem .5rem;
    }

    .text-center-cell {
        text-align: center !important;
    }

        .text-center-cell > div {
            text-align: center !important;
        }

    .container-fluid {
        max-width: 100% !important;
        padding-left: 15px;
        padding-right: 15px;
    }

    .grid-container {
        width: 100%;
        overflow-x: auto;
    }

    .action-buttons-right {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        justify-content: flex-end;
        align-items: center;
        padding: 8px 0;
    }

    .search-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: center;
    }

    .btn-search {
        background-color: #3e4b6d;
        color: white;
        font-weight: 600;
        padding: 6px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

        .btn-search:hover {
            background-color: #2c3a57;
        }

    .btn-clear {
        background-color: #6c757d;
        color: white;
        font-weight: 600;
        padding: 6px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

        .btn-clear:hover {
            background-color: #5a6268;
        }

    .btn-back {
        background-color: #6c757d;
        color: white;
        font-weight: 600;
        padding: 6px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

        .btn-back:hover {
            background-color: #5a6268;
        }

    #recordSummary {
        font-size: 13px;
        color: #6c757d;
        padding: 8px 0;
    }

    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
    }

    .modal-container {
        width: 100%;
        max-width: 800px;
        margin: 150px auto 50px auto;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        background-color: #3e4b6d;
        color: white;
        padding: 15px 25px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 4px 4px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }

        .modal-close:hover {
            opacity: 0.8;
        }

    .modal-body {
        padding: 40px 60px;
        background-color: white;
    }

    .form-container {
        width: 100%;
    }

    .form-group {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }

        .form-group label {
            font-size: 14px;
            font-weight: 400;
            margin-right: 15px;
            white-space: nowrap;
            min-width: 140px;
            text-align: right;
        }

            .form-group label.required::after {
                content: "*";
                color: red;
                margin-left: 3px;
            }

        .form-group input[type="text"],
        .form-group select {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
            max-width: 500px;
        }

        .form-group input[type="checkbox"] {
            margin-left: 0;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

    .modal-footer {
        padding: 20px;
        background-color: white;
        display: flex;
        justify-content: center;
        gap: 15px;
        border-radius: 0 0 4px 4px;
    }

    .btn-save {
        background-color: #3e4b6d;
        color: white;
        padding: 8px 30px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
    }

        .btn-save:hover {
            background-color: #3e4b6d;
        }

    .btn-modal-clear {
        background-color: #6c7a8d;
        color: white;
        padding: 8px 30px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
    }

        .btn-modal-clear:hover {
            background-color: #3e4b6d;
        }

    /* View Modal Styles */
    .view-modal-container {
        width: 100%;
        max-width: 700px;
        margin: 150px auto 50px auto;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .view-modal-body {
        padding: 30px 50px;
        background-color: white;
    }

    .view-detail-row {
        display: flex;
        margin-bottom: 18px;
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
    }

        .view-detail-row:last-child {
            border-bottom: none;
        }

    .view-label {
        font-size: 14px;
        font-weight: 600;
        color: #3e4b6d;
        min-width: 180px;
        text-align: right;
        padding-right: 20px;
    }

    .view-value {
        font-size: 14px;
        color: #212529;
        flex: 1;
    }

    .badge {
        padding: 5px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-success {
        background-color: #28a745;
        color: white;
    }

    .badge-secondary {
        background-color: #6c757d;
        color: white;
    }

    @@media (max-width: 768px) {
        .action-buttons-right

    {
        flex-direction: row;
        justify-content: flex-end;
        gap: 6px;
    }

    .btn-custom, .btn-add {
        padding: 5px 10px;
        font-size: 12px;
    }

    .modal-container, .view-modal-container {
        margin: 20px;
        max-width: calc(100% - 40px);
    }

    .modal-body, .view-modal-body {
        padding: 20px 30px;
    }

    .form-group {
        flex-direction: column;
        align-items: flex-start;
    }

        .form-group label {
            width: 100%;
            margin-bottom: 8px;
            min-width: auto;
            text-align: left;
        }

        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            max-width: 100%;
        }

    .modal-footer {
        flex-direction: row;
        gap: 10px;
    }

    .view-detail-row {
        flex-direction: column;
    }

    .view-label {
        text-align: left;
        padding-right: 0;
        margin-bottom: 5px;
        min-width: auto;
    }

    }

    .dx-datagrid {
        font-size: 13px;
    }

    .btn-add {
        background-color: #87CEEB;
        color: white;
        font-weight: 600;
        padding: 4px 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

        .btn-add:hover {
            background-color: #5dade2;
        }


    .form-group .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 4px;
        display: none; 
    }

        .form-group .error-message.show {
            display: block; 
        }
</style>

<div class="container-fluid">
    <!-- Search Panel Header -->
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Search Panel</div>
            <button type="button" class="btn-add" id="btnAdd">
                <i class="fas fa-plus"></i> Add
            </button>
        </div>
    </div>

    <!-- Search Form Section -->
    <div class="form-section">
        <div class="row justify-content-center mb-3">
            <div class="col-md-3 d-flex align-items-center">
                <label for="Schemeforid" class="form-label me-2" style="white-space: nowrap;">Search For:</label>
                <select class="form-control form-control-sm" id="Schemeforid">
                    <option value="0">-- Select --</option>
                    <option value="1">Scheme Name</option>
                    <option value="2">Scheme Type</option>
                </select>
            </div>

            <div class="col-md-3 d-flex align-items-center">
                <label for="input1" class="form-label me-2" style="white-space: nowrap;">Search by:</label>
                <input type="text" class="form-control form-control-sm" id="input1" disabled />
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="search-buttons">
                    <button type="button" class="btn-search" id="goButtonId">GO</button>
                    <button type="button" class="btn-search" id="clearButtonId">Clear</button>
                    <button type="button" class="btn-search" id="btnBackTop" onclick="window.history.back();">Back</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scheme Records Header -->
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Scheme Record(s)</div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons-right" id="actionButtons" style="display: none;">
        <button id="btnDelete" class="btn-custom">
            <i class="fas fa-trash"></i> Delete
        </button>
    </div>

    <!-- Data Grid -->
    <div class="grid-container">
        <div id="attendanceGrid">Loading...</div>
    </div>

    <!-- Record Summary -->
    <div id="recordSummary" class="text-center mt-2"></div>
</div>

<!-- Add/Edit Scheme Modal -->
<div class="modal-overlay" id="addSchemeModal">
    <div class="modal-container">
        <div class="modal-header">
            <span>Add Scheme</span>
            <button type="button" class="modal-close" id="btnModalClose">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-container">
                <form id="schemeForm">
                    <div class="form-group">
                        <label class="required">Name :</label>
                        <div class="input-wrapper">
                            <input type="text" id="schemeName" name="schemeName" required />
                            <span class="error-message" id="schemeNameError">Please enter scheme name</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="required">Type :</label>
                        <div class="input-wrapper">
                            <select id="schemeType" name="schemeType" required>
                                <option value="">-- Select --</option>
                            </select>
                            <span class="error-message" id="schemeTypeError">Please select scheme type</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Default Scheme :</label>
                        <input type="checkbox" id="isDefaultScheme" name="isDefaultScheme" />
                    </div>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-save" id="btnSave">Save</button>
            <button type="button" class="btn-modal-clear" id="btnModalClear">Clear</button>
        </div>
    </div>
</div>

<script>
    let allData = [];
    let selectedKeys = [];
    const baseDomainUrl = '@baseDomainUrl';
    const Empid = parseInt(localStorage.getItem("EmployeeId") || "0");
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany || '{}');
    const Compid = parseInt(companyDetails.CompanyId || "0");
    const Token = localStorage.getItem("authToken");

    $(document).ready(function () {
        loadSchemeData();
         loadSchemeTypes();

        // GO Button Click
        $('#goButtonId').click(function () {
            loadSchemeData();
        });

        // Clear Button Click
        $('#clearButtonId').click(function () {
            $('#Schemeforid').val('0');
            $('#input1').val('').prop('disabled', true);
            selectedKeys = [];
            loadSchemeData();
        });

        // Search For Dropdown Change
        $('#Schemeforid').change(function () {
            $('#input1').prop('disabled', $(this).val() === '0');
            if ($(this).val() === '0') {
                $('#input1').val('');
            }
        });

        // Add Button Click
        $('#btnAdd').click(function () {
            $('#schemeForm')[0].reset();
            $('#addSchemeModal .modal-header span').text('Add Scheme');
            $('#btnSave').off('click').on('click', saveScheme);
            $('#addSchemeModal').fadeIn(200);
        });

    
        $('#btnModalClear').click(function () {
            $('#schemeForm')[0].reset();
        });

     
        $('#btnModalClose').click(function () {
            closeModal();
        });

  
        $('#btnSave').click(function () {
            debugger;
            saveScheme();
        });

        $('#btnDelete').click(function () {
            if (selectedKeys.length === 0) {
                Swal.fire({
                    title: 'No Selection',
                    text: 'Please select at least one record to delete',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
                return;
            }

            Swal.fire({
                title: 'Are you sure?',
                text: `You are about to delete ${selectedKeys.length} record(s)`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteSchemes();
                }
            });
        });

        // View Modal Close Buttons
        $('#btnViewModalClose, #btnViewClose').click(function () {
            closeViewModal();
        });


            function loadSchemeTypes() {
        $.ajax({
            url: `${baseDomainUrl}/api/SchemeTypeAPI/GetAllSchemeType`,
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${Token}`
            },
            success: function (response) {
                if (response.isSuccess && response.data) {
                    const schemeTypeDropdown = $('#schemeType');
                    schemeTypeDropdown.empty();
                    schemeTypeDropdown.append('<option value="">-- Select --</option>');

                    response.data.forEach(function(item) {
                        schemeTypeDropdown.append(
                            `<option value="${item.schemeTypeId}">${item.schemeType}</option>`
                        );
                    });
                } else {
                    console.warn('No scheme types found');
                    Swal.fire({
                        title: 'Warning!',
                        text: 'No scheme types available',
                        icon: 'warning',
                        confirmButtonText: 'OK'
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error('Error loading scheme types:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to load scheme types',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    }


        // Press Escape to close modals
        $(document).keydown(function(e) {
            if (e.key === "Escape") {
                if ($('#addSchemeModal').is(':visible')) {
                    closeModal();
                }
                if ($('#viewSchemeModal').is(':visible')) {
                    closeViewModal();
                }
            }
        });

        // Click outside modal to close
        $('#addSchemeModal').click(function(e) {
            if ($(e.target).is('#addSchemeModal')) {
                closeModal();
            }
        });

        $('#viewSchemeModal').click(function(e) {
            if ($(e.target).is('#viewSchemeModal')) {
                closeViewModal();
            }
        });
    });

    function closeModal() {
        $('#addSchemeModal').fadeOut(200);
        $('#addSchemeModal .modal-header span').text('Add Scheme');
        $('#schemeForm')[0].reset();

        // Validation errors clear करें
        $('#schemeName').removeClass('error');
        $('#schemeType').removeClass('error');
        $('#schemeNameError').removeClass('show');
        $('#schemeTypeError').removeClass('show');

        $('#btnSave').off('click').on('click', saveScheme);
    }

    function closeViewModal() {
        $('#viewSchemeModal').fadeOut(200);
    }

    function loadSchemeData() {
        $('#attendanceGrid').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');

        $.ajax({
            url: `${baseDomainUrl}/api/SchemeMasterAPI/GetAllSchemeMaster`,
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${Token}`
            },
            success: function (response) {
                if (response.isSuccess && response.data) {
                    allData = response.data;

                    // Filter data based on search criteria
                    let filteredData = [...allData];
                    const searchFor = $('#Schemeforid').val();
                    const searchBy = $('#input1').val().trim();

                    if (searchFor !== '0' && searchBy !== '') {
                        if (searchFor === '1') { // Scheme Name
                            filteredData = filteredData.filter(item =>
                                item.schemeName && item.schemeName.toLowerCase().includes(searchBy.toLowerCase())
                            );
                        } else if (searchFor === '2') { // Scheme Type
                            filteredData = filteredData.filter(item =>
                                item.type && item.type.toLowerCase().includes(searchBy.toLowerCase())
                            );
                        }
                    }

                    renderTable(filteredData);
                    updateRecordSummary(filteredData.length);
                } else {
                    $('#attendanceGrid').html('<div class="text-center p-4 text-muted">No records found</div>');
                    $('#recordSummary').text('');
                }
            },
            error: function (xhr, status, error) {
                console.error('Error loading data:', error);
                $('#attendanceGrid').html('<div class="text-center p-4 text-danger">Error loading data. Please try again.</div>');
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to load scheme data',
                    icon: 'error'
                });
            }
        });
    }

    function renderTable(data) {
        $("#attendanceGrid").dxDataGrid({
            dataSource: data,
            keyExpr: "schemeID",
            showBorders: true,
            columnAutoWidth: true,
            width: '100%',
            rowAlternationEnabled: false,
            hoverStateEnabled: true,
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "always"
            },
            paging: {
                pageSize: 10
            },
            pager: {
                visible: true,
                showPageSizeSelector: true,
                allowedPageSizes: [5, 10, 20, 50],
                showInfo: true
            },
            onSelectionChanged: function (e) {
                selectedKeys = e.selectedRowKeys;
                if (selectedKeys.length > 0) {
                    $('#actionButtons').show();
                } else {
                    $('#actionButtons').hide();
                }
            },
            columns: [
                {
                    dataField: "schemeID",
                    caption: "Scheme ID",
                    width: 100,
                    alignment: "center"
                },
                {
                    dataField: "schemeName",
                    caption: "Scheme Name",
                    width: 200
                },
                {
                    dataField: "type",
                    caption: "Type",
                    width: 150,
                    alignment: "center"
                },
                {
                    dataField: "isDefaultScheme",
                    caption: "Default Scheme",
                    width: 130,
                    alignment: "center",
                    cellTemplate: function (container, options) {
                        const badge = options.value
                            ? '<span class="badge badge-success">Yes</span>'
                            : '<span class="badge badge-secondary">No</span>';
                        container.append(badge);
                    }
                },
                {
                    dataField: "isEnabled",
                    caption: "Status",
                    width: 100,
                    alignment: "center",
                    cellTemplate: function (container, options) {
                        const badge = options.value
                            ? '<span class="badge badge-success">Active</span>'
                            : '<span class="badge badge-secondary">Inactive</span>';
                        container.append(badge);
                    }
                },
                {
                    caption: "Actions",
                    width: 120,
                    alignment: "center",
                    cellTemplate: function (container, options) {
                        $('<button>')
                            .addClass('btn btn-sm btn-info me-1')
                            .html('<i class="fas fa-eye"></i>')
                            .attr('title', 'View')
                            .css({ 'font-size': '11px', 'padding': '3px 8px' })
                            .on('click', function () {
                                viewScheme(options.data.schemeID);
                            })
                            .appendTo(container);

                        $('<button>')
                            .addClass('btn btn-sm btn-primary me-1')
                            .html('<i class="fas fa-edit"></i>')
                            .attr('title', 'Edit')
                            .css({ 'font-size': '11px', 'padding': '3px 8px' })
                            .on('click', function () {
                                editScheme(options.data.schemeID);
                            })
                            .appendTo(container);
                    }
                }
            ]
        });
    }

    function updateRecordSummary(count) {
        if (count === 0) {
            $('#recordSummary').html('No records found');
        } else {
            $('#recordSummary').html(`Total Records: <strong>${count}</strong>`);
        }
    }

    function saveScheme() {
        debugger;
        $('#schemeName').removeClass('error');
        $('#schemeType').removeClass('error');
        $('#schemeNameError').removeClass('show');
        $('#schemeTypeError').removeClass('show');

        const schemeName = $('#schemeName').val().trim();
        const schemeType = $('#schemeType').val();
        const isDefaultScheme = $('#isDefaultScheme').is(':checked');

        let isValid = true;

        if (!schemeName) {
            $('#schemeName').addClass('error');
            $('#schemeNameError').addClass('show');
            isValid = false;
        }

        if (!schemeType) {
            $('#schemeType').addClass('error');
            $('#schemeTypeError').addClass('show');
            isValid = false;
        }

 
        if (!isValid) {
            return;
        }

   
        const schemeData = {
            SchemeName: schemeName,
            Type: parseInt(schemeType),
            IsDefaultScheme: isDefaultScheme,
            IsDeleted: false,
            IsEnabled: true,
            CreatedBy: Empid
        };

          console.log('schemeData' ,schemeData);
        $.ajax({
            url: '@baseDomainUrl/api/SchemeMasterAPI/AddScheme',
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${Token}`,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(schemeData),
            success: function (response) {
                if (response.isSuccess) {
                    Swal.fire({
                        title: 'Success!',
                        text: response.responseMessage || 'Scheme added successfully',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        closeModal();
                        loadSchemeData();
                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: response.responseMessage || 'Failed to add scheme',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error('Error saving scheme:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to add scheme. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    }

    function deleteSchemes() {
        const deletePromises = selectedKeys.map(id => {
            return $.ajax({
                url: `${baseDomainUrl}/api/SchemeMasterAPI/Delete`,
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${Token}`,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    Id: id,
                    DeletedBy: Empid
                })
            });
        });

        Promise.all(deletePromises)
            .then(responses => {
                const allSuccess = responses.every(r => r.isSuccess);
                if (allSuccess) {
                    Swal.fire({
                        title: 'Deleted!',
                        text: `${selectedKeys.length} scheme(s) deleted successfully`,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        selectedKeys = [];
                        $('#actionButtons').hide();
                        loadSchemeData();
                    });
                } else {
                    Swal.fire({
                        title: 'Partial Success',
                        text: 'Some schemes could not be deleted',
                        icon: 'warning',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        selectedKeys = [];
                        $('#actionButtons').hide();
                        loadSchemeData();
                    });
                }
            })
            .catch(error => {
                console.error('Error deleting schemes:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to delete schemes',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            });
    }

    function viewScheme(schemeId) {
        $.ajax({
            url: `${baseDomainUrl}/api/SchemeMasterAPI/GetBySchemeId/${schemeId}`,
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${Token}`
            },
            success: function (response) {
                if (response.isSuccess && response.data) {
                    const data = response.data;

                    // Populate view modal
                    $('#viewSchemeID').text(data.schemeID || '-');
                    $('#viewSchemeName').text(data.schemeName || '-');
                    $('#viewSchemeType').text(data.type || '-');

                    const defaultBadge = data.isDefaultScheme
                        ? '<span class="badge badge-success">Yes</span>'
                        : '<span class="badge badge-secondary">No</span>';
                    $('#viewDefaultScheme').html(defaultBadge);

                    const statusBadge = data.isEnabled
                        ? '<span class="badge badge-success">Active</span>'
                        : '<span class="badge badge-secondary">Inactive</span>';
                    $('#viewStatus').html(statusBadge);

                    $('#viewCreatedDate').text(data.createdDate ? formatDate(data.createdDate) : '-');
                    $('#viewModifiedDate').text(data.modifiedDate ? formatDate(data.modifiedDate) : '-');

                    $('#viewSchemeModal').fadeIn(200);
                }
            },
            error: function () {
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to load scheme details',
                    icon: 'error'
                });
            }
        });
    }

    function editScheme(schemeId) {
        $.ajax({
            url: `${baseDomainUrl}/api/SchemeMasterAPI/GetBySchemeId/${schemeId}`,
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${Token}`
            },
            success: function (response) {
                if (response.isSuccess && response.data) {
                    $('#schemeName').val(response.data.schemeName);
                    $('#schemeType').val(response.data.type);
                    $('#isDefaultScheme').prop('checked', response.data.isDefaultScheme);
                    $('#addSchemeModal .modal-header span').text('Edit Scheme');
                    $('#addSchemeModal').fadeIn(200);

                    $('#btnSave').off('click').on('click', function() {
                        updateScheme(schemeId);
                    });
                }
            },
            error: function () {
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to load scheme details',
                    icon: 'error'
                });
            }
        });
    }

    function updateScheme(schemeId) {
        const schemeName = $('#schemeName').val().trim();
        const schemeType = $('#schemeType').val();
        const isDefaultScheme = $('#isDefaultScheme').is(':checked');

        if (!schemeName || !schemeType) {
            Swal.fire({
                title: 'Validation Error',
                text: 'Please fill all required fields',
                icon: 'warning'
            });
            return;
        }

        const schemeData = {
            SchemeID: schemeId,
            SchemeName: schemeName,
            Type: schemeType,
            IsDefaultScheme: isDefaultScheme,
            IsDeleted: false,
            IsEnabled: true,
            CreatedBy: Empid
        };

        $.ajax({
            url: `${baseDomainUrl}/api/SchemeMasterAPI/UpdateScheme`,
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${Token}`,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(schemeData),
            success: function (response) {
                if (response.isSuccess) {
                    Swal.fire({
                        title: 'Success!',
                        text: response.responseMessage || 'Scheme updated successfully',
                        icon: 'success'
                    }).then(() => {
                        closeModal();
                        loadSchemeData();
                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: response.responseMessage || 'Failed to update scheme',
                        icon: 'error'
                    });
                }
            },
            error: function () {
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to update scheme',
                    icon: 'error'
                });
            }
        });
    }

    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}/${month}/${year} ${hours}:${minutes}`;
    }
</script>
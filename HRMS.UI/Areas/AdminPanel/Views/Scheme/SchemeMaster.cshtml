@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Scheme Master";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}

<title>Scheme Master</title>
<link href="~/commoncss.css" rel="stylesheet" />

<!-- jQuery + Bootstrap + SweetAlert + DevExtreme -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.all.min.js"></script>


<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
    }

    .form-section {
        padding: 15px;
        border: 1px solid #ccc;
        max-width: 100%;
        background-color: white;
    }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        font-weight: 600;
        padding: 6px 14px;
        border: none;
        border-radius: 4px;
        margin-right: 8px;
        cursor: pointer;
        font-size: 13px;
    }

        .btn-custom:hover {
            background-color: #2c3a57;
        }

    .search-panel-container {
        background-color: #3e4b6d;
        padding: 6px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }



    .form-label {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .form-control-sm, .form-select-sm {
        height: calc(1.5em + .5rem + 2px);
        font-size: 0.875rem;
        padding: .25rem .5rem;
    }

    .text-center-cell {
        text-align: center !important;
    }

        .text-center-cell > div {
            text-align: center !important;
        }

    .container-fluid {
        max-width: 100% !important;
        padding-left: 15px;
        padding-right: 15px;
    }

    .grid-container {
        width: 100%;
        overflow-x: auto;
    }

    .action-buttons-right {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        justify-content: flex-end;
        align-items: center;
        padding: 8px 0;
    }

    .search-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: center;
    }

    .btn-search {
        background-color: #3e4b6d;
        color: white;
        font-weight: 600;
        padding: 6px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

        .btn-search:hover {
            background-color: #2c3a57;
        }

    .btn-clear {
        background-color: #6c757d;
        color: white;
        font-weight: 600;
        padding: 6px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

        .btn-clear:hover {
            background-color: #5a6268;
        }

    .btn-back {
        background-color: #6c757d;
        color: white;
        font-weight: 600;
        padding: 6px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

        .btn-back:hover {
            background-color: #5a6268;
        }

    #recordSummary {
        font-size: 13px;
        color: #6c757d;
        padding: 8px 0;
    }

    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
    }

    .modal-container {
        width: 100%;
        max-width: 800px;
        margin: 150px auto 50px auto;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        background-color: #3e4b6d;
        color: white;
        padding: 15px 25px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 4px 4px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }

        .modal-close:hover {
            opacity: 0.8;
        }

    .modal-body {
        padding: 40px 60px;
        background-color: white;
    }

    .form-container {
        width: 100%;
    }

    .form-group {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }

        .form-group label {
            font-size: 14px;
            font-weight: 400;
            margin-right: 15px;
            white-space: nowrap;
            min-width: 140px;
            text-align: right;
        }

            .form-group label.required::after {
                content: "*";
                color: red;
                margin-left: 3px;
            }

        .form-group input[type="text"],
        .form-group select {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
            max-width: 500px;
        }

        .form-group input[type="checkbox"] {
            margin-left: 0;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

    .modal-footer {
        padding: 20px;
        background-color: white;
        display: flex;
        justify-content: center;
        gap: 15px;
        border-radius: 0 0 4px 4px;
    }

    .btn-save {
        background-color: #3e4b6d;
        color: white;
        padding: 8px 30px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
    }

        .btn-save:hover {
            background-color: #3e4b6d;
        }

    .btn-modal-clear {
        background-color: #6c7a8d;
        color: white;
        padding: 8px 30px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
    }

        .btn-modal-clear:hover {
            background-color: #3e4b6d;
        }

    /* View Modal Styles */
    .view-modal-container {
        width: 100%;
        max-width: 700px;
        margin: 150px auto 50px auto;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .view-modal-body {
        padding: 30px 50px;
        background-color: white;
    }

    .view-detail-row {
        display: flex;
        margin-bottom: 18px;
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
    }

        .view-detail-row:last-child {
            border-bottom: none;
        }

    .view-label {
        font-size: 14px;
        font-weight: 600;
        color: #3e4b6d;
        min-width: 180px;
        text-align: right;
        padding-right: 20px;
    }

    .view-value {
        font-size: 14px;
        color: #212529;
        flex: 1;
    }

    .badge {
        padding: 5px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-success {
        background-color: #28a745;
        color: white;
    }

    .badge-secondary {
        background-color: #6c757d;
        color: white;
    }

    @@media (max-width: 768px) {
        .action-buttons-right

    {
        flex-direction: row;
        justify-content: flex-end;
        gap: 6px;
    }

    .btn-custom, .btn-add {
        padding: 5px 10px;
        font-size: 12px;
    }

    .modal-container, .view-modal-container {
        margin: 20px;
        max-width: calc(100% - 40px);
    }

    .modal-body, .view-modal-body {
        padding: 20px 30px;
    }

    .form-group {
        flex-direction: column;
        align-items: flex-start;
    }

        .form-group label {
            width: 100%;
            margin-bottom: 8px;
            min-width: auto;
            text-align: left;
        }

        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            max-width: 100%;
        }

    .modal-footer {
        flex-direction: row;
        gap: 10px;
    }

    .view-detail-row {
        flex-direction: column;
    }

    .view-label {
        text-align: left;
        padding-right: 0;
        margin-bottom: 5px;
        min-width: auto;
    }

    }

    .dx-datagrid {
        font-size: 13px;
    }

    .btn-add {
        background-color: #5dade2;
        color: white;
        font-weight: 600;
        padding: 4px 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

        .btn-add:hover {
            background-color: #5dade2;
        }


    .form-group .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 4px;
        display: none; 
    }

        .form-group .error-message.show {
            display: block; 
        }
</style>

<div class="container-fluid">
    <!-- Search Panel Header -->
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Search Panel</div>
            <button type="button" class="btn-add" id="btnAdd">
                <i class="fas fa-plus"></i> Add
            </button>
        </div>
    </div>

    <!-- Search Form Section -->
    <div class="form-section">
        <div class="row justify-content-center mb-3">
            <div class="col-md-3 d-flex align-items-center">
                <label for="Schemeforid" class="form-label me-2" style="white-space: nowrap;">Search For:</label>
                <select class="form-control form-control-sm" id="Schemeforid">
                    <option value="0">-- Select --</option>
                    <option value="Scheme Name">Scheme Name</option>
                    <option value="Scheme Type">Scheme Type</option>
                </select>
            </div>

            <div class="col-md-3 d-flex align-items-center">
                <label for="input1" class="form-label me-2" style="white-space: nowrap;">Search by:</label>
                <input type="text" class="form-control form-control-sm" id="input1" disabled />
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="search-buttons">
                    <button type="button" class="btn-search" id="goButtonId">GO</button>
                    <button type="button" class="btn-search" id="clearButtonId">Clear</button>
                    <button type="button" class="btn-search" id="btnBackTop" onclick="window.history.back();">Back</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scheme Records Header -->
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Scheme Record(s)</div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons-right" id="actionButtons" style="display: none;">
        <button id="btnDelete" class="btn-custom">
            <i class="fas fa-trash"></i> Delete
        </button>
    </div>

    <!-- Data Grid -->

    <div id="grid-loader"
         class="grid-loader justify-content-center align-items-center flex-column"
         style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(3px); z-index: 9999;">
        <img src="@baseDomainUrl/loders/loder.png"
             class="grid-logo-spinner"
             style="width: 40px; height: 40px; animation: spin 1s linear infinite;" />
        <div class="grid-loading-text text-dark " style="font-size: 16px;">Loading...</div>
    </div>

    <div class="grid-container">
        <div id="attendanceGrid">Loading...</div>
    </div>

    <!-- Record Summary -->
    <div id="recordSummary" class="text-center mt-2"></div>
</div>

<!-- Add/Edit Scheme Modal -->
<div class="modal-overlay" id="addSchemeModal">
    <div class="modal-container">
        <div class="modal-header">
            <span>Add Scheme</span>
            <button type="button" class="modal-close" id="btnModalClose">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-container">
                <form id="schemeForm">
                    <input type="hidden" id="schemeID" name="schemeID" value="0" />

                    <div class="form-group">
                        <label class="required">Name :</label>
                        <div class="input-wrapper">
                            <input type="text" id="schemeName" name="schemeName" required />
                            <span class="error-message" id="schemeNameError">Please enter scheme name</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="required">Type :</label>
                        <div class="input-wrapper">
                            <select id="schemeType" name="schemeType" required>
                                <option value="">-- Select --</option>
                            </select>
                            <span class="error-message" id="schemeTypeError">Please select scheme type</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Default Scheme :</label>
                        <input type="checkbox" id="isDefaultScheme" name="isDefaultScheme" />
                    </div>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-save" id="btnSave">Save</button>
            <button type="button" class="btn-modal-clear" id="btnModalClear">Clear</button>
        </div>
    </div>
</div>

<script>
    let allData = [];
    let selectedKeys = [];
    const baseDomainUrl = '@baseDomainUrl';
    const Empid = parseInt(localStorage.getItem("EmployeeId") || "0");
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany || '{}');
    const Compid = parseInt(companyDetails.CompanyId || "0");
    const Token = localStorage.getItem("authToken");

    $(document).ready(function () {
        loadSchemeData();
         loadSchemeTypes();
    });
        // GO Button Click
        $('#goButtonId').click(function () {
            loadSchemeData();
        });

               async function showLoder() {
              $('#grid-loader').addClass('d-flex').show();
          }

          async function hideLoder() {
              $('#grid-loader').removeClass('d-flex').hide();
          }

        // Clear Button Click
        $('#clearButtonId').click(function () {
            $('#Schemeforid').val('0');
            $('#input1').val('').prop('disabled', true);
            selectedKeys = [];
            loadSchemeData();
        });



                 $('#btnAdd').click(function () {
                        $('#schemeForm')[0].reset();
                        $('#schemeID').val('0'); // Reset to 0 for new entry
                        $('#addSchemeModal .modal-header span').text('Add Scheme');
                        $('#btnSave').text('Save'); // Make sure it says Save
                        $('#btnSave').off('click').on('click', saveScheme);
                        $('#addSchemeModal').fadeIn(200);
                    });

        $('#btnModalClear').click(function () {
            $('#schemeForm')[0].reset();
        });

     
        $('#btnModalClose').click(function () {
            closeModal();
        });

  
        $('#btnSave').click(function () {
            saveScheme();
        });

        $('#btnViewModalClose, #btnViewClose').click(function () {
            closeViewModal();
        });


            function loadSchemeTypes() {
        $.ajax({
            url: `${baseDomainUrl}/api/SchemeTypeAPI/GetAllSchemeType`,
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${Token}`
            },
            success: function (response) {
                if (response.isSuccess && response.data) {
                    const schemeTypeDropdown = $('#schemeType');
                    schemeTypeDropdown.empty();
                    schemeTypeDropdown.append('<option value="">-- Select --</option>');

                    response.data.forEach(function(item) {
                        schemeTypeDropdown.append(
                            `<option value="${item.schemeTypeId}">${item.schemeType}</option>`
                        );
                    });
                } else {
                    console.warn('No scheme types found');
                    Swal.fire({
                        title: 'Warning!',
                        text: 'No scheme types available',
                        icon: 'warning',
                        confirmButtonText: 'OK'
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error('Error loading scheme types:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to load scheme types',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    }


        // Press Escape to close modals
        $(document).keydown(function(e) {
            if (e.key === "Escape") {
                if ($('#addSchemeModal').is(':visible')) {
                    closeModal();
                }
                if ($('#viewSchemeModal').is(':visible')) {
                    closeViewModal();
                }
            }
        });

        // Click outside modal to close
        $('#addSchemeModal').click(function(e) {
            if ($(e.target).is('#addSchemeModal')) {
                closeModal();
            }
        });

        $('#viewSchemeModal').click(function(e) {
            if ($(e.target).is('#viewSchemeModal')) {
                closeViewModal();
            }
        });


    function closeModal() {
        $('#addSchemeModal').fadeOut(200);
        $('#addSchemeModal .modal-header span').text('Add Scheme');
        $('#btnSave').text('Save'); // Reset button text
        $('#schemeForm')[0].reset();
        $('#schemeID').val('0'); // Reset hidden field

        // Clear validation errors
        $('#schemeName').removeClass('error');
        $('#schemeType').removeClass('error');
        $('#schemeNameError').removeClass('show');
        $('#schemeTypeError').removeClass('show');

        // Rebind Save button to saveScheme function
        $('#btnSave').off('click').on('click', saveScheme);
    }


    function closeViewModal() {
        $('#viewSchemeModal').fadeOut(200);
    }



    function loadSchemeData() { 
 
        $('#attendanceGrid').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i></div>');
    const searchFor = $('#Schemeforid').val(); // "Scheme Name" or "Scheme Type"
    const searchBy = $('#input1').val().trim(); // The actual search term

    const requestData = {
        SearchFor: searchFor === '0' ? 'Scheme Name' : searchFor,
        SearchBy: searchBy
    };
    showLoder();

        $.ajax({
            url: `@baseDomainUrl/api/SchemeMasterAPI/GetAllSchemeMaster`,
            method: 'POST',  // Changed to POST since we're sending a body
            headers: {
                'Authorization': `Bearer ${Token}`,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(requestData),  // Send search criteria to the server
            success: function (response) {
             hideLoder();
                if (response.isSuccess && response.data) {
                    allData = response.data;
                    renderTable(allData);  // No need for client-side filtering now
                    updateRecordSummary(allData.length);
                } else {
                    $('#attendanceGrid').html('<div class="text-center p-4 text-muted">No records found</div>');
                    $('#recordSummary').text('');
                }
            },
            error: function (xhr, status, error) {
           hideLoder();
                console.error('Error loading data:', error);
                $('#attendanceGrid').html('<div class="text-center p-4 text-danger">Error loading data. Please try again.</div>');
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to load scheme data',
                    icon: 'error'
                });
            }
        });
    }

    function renderTable(data) {
        // Check if grid instance exists before trying to dispose
        try {
            const gridInstance = $("#attendanceGrid").dxDataGrid("instance");
            if (gridInstance) {
                gridInstance.dispose();
            }
        } catch (e) {
            // Grid not initialized yet, just clear the container
            $("#attendanceGrid").empty();
        }

        // Calculate equal width for non-button columns (3 columns: schemeName, schemeType, isDefaultScheme)
        const nonButtonColumns = 3;
        const equalWidth = `${100 / nonButtonColumns}%`;

        // Initialize new grid with equal-width columns
        $("#attendanceGrid").dxDataGrid({
            dataSource: data,
            keyExpr: "schemeID",
            showBorders: true,
            columnAutoWidth: false, // Disable auto-width since we're manually setting widths
            width: '100%',
            rowAlternationEnabled: false,
            hoverStateEnabled: true,
            paging: {
                pageSize: 10
            },
            pager: {
                visible: true,
                showPageSizeSelector: true,
                allowedPageSizes: [5, 10, 20, 50],
                showInfo: true
            },
            columns: [
                {
                    dataField: "schemeID",
                    caption: "Scheme ID",
                    alignment: "center",
                    visible: false // Hidden column
                },
                {
                    dataField: "schemeName",
                    caption: "Scheme Name",
                    alignment: "center",
                    width: equalWidth // Equal width (33.33%)
                },
                {
                    dataField: "schemeType",
                    caption: "Type",
                    alignment: "center",
                    width: equalWidth // Equal width (33.33%)
                },
                {
                    dataField: "isDefaultScheme",
                    caption: "Default",
                    width: equalWidth, // Equal width (33.33%)
                    alignment: "center",
                    cellTemplate: function (container, options) {
                        const text = options.value ? "Yes" : "No";
                        const color = options.value ? "#212529" : "#6c757d";
                        container.append(`<span style="color: ${color}; font-weight: 500;">${text}</span>`);
                    }
                },
                {
                    dataField: '',
                    caption: 'Edit',
                    dataType: 'string',
                    width: 70, // Fixed small width for action buttons
                    cellTemplate: function (container, options) {
                        $('<div class="d-flex order-actions">')
                            .append('<a href="javascript:;" class="edit-action" title="Update Scheme">'+
                                '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">'+
                                '<path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 1.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.354-.854z"/></svg>'+
                                '</a>')
                            .on('click', function() {
                                openEditModal(options.data.schemeID);
                            })
                            .appendTo(container);
                    }
                },
                {
                    dataField: '',
                    caption: 'Delete',
                    dataType: 'string',
                    width: 70, // Fixed small width for action buttons
                    cellTemplate: function (container, options) {
                        $('<div class="d-flex order-actions">')
                            .append('<a href="javascript:;" class="delete-action" title="Delete Scheme">'+
                                '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">'+
                                '<path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/></path>'+
                                '</svg>'+
                                '</a>')
                            .on('click', function() {
                                deleteScheme(options.data.schemeID);
                            })
                            .appendTo(container);
                    }
                }
            ]
        });
    }

    function updateRecordSummary(count) {
        if (count === 0) {
            $('#recordSummary').html('No records found');
        } else {
            $('#recordSummary').html(`Total Records: <strong>${count}</strong>`);
        }
    }

    function saveScheme() {

        $('#schemeName').removeClass('error');
        $('#schemeType').removeClass('error');
        $('#schemeNameError').removeClass('show');
        $('#schemeTypeError').removeClass('show');

        const schemeName = $('#schemeName').val().trim();
        const schemeType = $('#schemeType').val();
        const isDefaultScheme = $('#isDefaultScheme').is(':checked');

        let isValid = true;

        if (!schemeName) {
            $('#schemeName').addClass('error');
            $('#schemeNameError').addClass('show');
            isValid = false;
        }

        if (!schemeType) {
            $('#schemeType').addClass('error');
            $('#schemeTypeError').addClass('show');
            isValid = false;
        }

 
        if (!isValid) {
            return;
        }

   
        const schemeData = {
            SchemeName: schemeName,
            Type: parseInt(schemeType),
            IsDefaultScheme: isDefaultScheme,
            IsDeleted: false,
            IsEnabled: true,
            CreatedBy: Empid
        };
     showLoder();
        $.ajax({
            url: '@baseDomainUrl/api/SchemeMasterAPI/AddScheme',
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${Token}`,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(schemeData),
            success: function (response) {
             hideLoder();
                if (response.isSuccess) {
                    Swal.fire({
                        title: 'Success!',
                        text: response.responseMessage || 'Scheme added successfully',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        closeModal();
                        loadSchemeData();
                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: response.responseMessage || 'Failed to add scheme',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            },
            error: function (xhr, status, error) {
            hideLoder();
                console.error('Error saving scheme:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to add scheme. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    }

    function deleteScheme(schemeID) {
        if (!schemeID || isNaN(schemeID)) {
            Swal.fire('Error!', 'Invalid scheme ID', 'error');
            return;
        }

        if (!Empid) {
            Swal.fire('Error!', 'Employee ID missing', 'error');
            return;
        }
       showLoder();

        $.ajax({
            url: '@baseDomainUrl/api/SchemeMasterAPI/Delete',
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${Token}`,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                Id: parseInt(schemeID),   
                DeletedBy: Empid.toString()
            }),
            success: function(response) {
                 hideLoder();
                Swal.fire({
                    title: 'Success!',
                    text: response.responseMessage || 'Scheme deleted successfully',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    loadSchemeData(); // Refresh the data
                });
            },
            error: function(xhr) {
               hideLoder();
                let errorMsg = 'Failed to delete scheme';

                if (xhr.responseText) {
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        errorMsg = errorResponse.responseMessage ||
                                  errorResponse.message ||
                                  errorResponse.data ||
                                  'An error occurred while deleting the scheme';
                    } catch (e) {
                        errorMsg = 'Unable to process the delete request';
                    }
                }

                Swal.fire({
                    title: 'Error!',
                    text: errorMsg,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    }

    function openEditModal(schemeId) {
        // Clear previous errors
        $('#schemeName').removeClass('error');
        $('#schemeType').removeClass('error');
        $('#schemeNameError').removeClass('show');
        $('#schemeTypeError').removeClass('show');

        // Fetch scheme data by ID
        $.ajax({
            url: `${baseDomainUrl}/api/SchemeMasterAPI/GetBySchemeId/${schemeId}`,
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${Token}`,
                'Content-Type': 'application/json'
            },
            success: function(response) {
                if (response.isSuccess && response.data) {
                    const schemeData = response.data;
                    console.log('schemeData' ,schemeData);
                    // Populate form fields
                    $('#schemeID').val(schemeData.schemeID);
                    $('#schemeName').val(schemeData.schemeName);
                    $('#schemeType').val(schemeData.type || schemeData.schemeTypeId);
                    $('#isDefaultScheme').prop('checked', schemeData.isDefaultScheme);

                    // Change modal title to Edit
                    $('#addSchemeModal .modal-header span').text('Edit Scheme');

                    // Change Save button text to Update
                    $('#btnSave').text('Update');

                    // Bind update function to Save button
                    $('#btnSave').off('click').on('click', function() {
                        updateSchemeData();
                    });

                    // Show modal
                    $('#addSchemeModal').fadeIn(200);
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: 'Failed to load scheme data',
                        icon: 'error'
                    });
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading scheme:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to load scheme data',
                    icon: 'error'
                });
            }
        });
    }

    // New function for updating scheme
    function updateSchemeData() {
        // Clear previous errors
        $('#schemeName').removeClass('error');
        $('#schemeType').removeClass('error');
        $('#schemeNameError').removeClass('show');
        $('#schemeTypeError').removeClass('show');

        const schemeID = $('#schemeID').val();
        const schemeName = $('#schemeName').val().trim();
        const schemeType = $('#schemeType').val();
        const isDefaultScheme = $('#isDefaultScheme').is(':checked');

        let isValid = true;

        if (!schemeName) {
            $('#schemeName').addClass('error');
            $('#schemeNameError').addClass('show');
            isValid = false;
        }

        if (!schemeType) {
            $('#schemeType').addClass('error');
            $('#schemeTypeError').addClass('show');
            isValid = false;
        }

        if (!isValid) {
            return;
        }

        const schemeData = {
            SchemeID: parseInt(schemeID),
            SchemeName: schemeName,
            Type: parseInt(schemeType),
            IsDefaultScheme: isDefaultScheme,
            IsDeleted: false,
            IsEnabled: true,
            ModifiedBy: Empid
        };

          showLoder();
        $.ajax({
            url: `${baseDomainUrl}/api/SchemeMasterAPI/UpdateScheme`,
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${Token}`,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(schemeData),
            success: function(response) {  
                     hideLoder();
                if (response.isSuccess) {
                    Swal.fire({
                        title: 'Success!',
                        text: response.responseMessage || 'Scheme updated successfully',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        closeModal();
                         loadSchemeData();
                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: response.responseMessage || 'Failed to update scheme',
                        icon: 'error'
                    });
                }
            },
            error: function(xhr) {
                     hideLoder();
                let errorMsg = 'Failed to update scheme';
                if (xhr.responseText) {
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        errorMsg = errorResponse.responseMessage ||
                                  errorResponse.message ||
                                  errorResponse.data ||
                                  errorMsg;
                    } catch (e) {
                        errorMsg = xhr.responseText || errorMsg;
                    }
                }
                Swal.fire({
                    title: 'Error!',
                    text: errorMsg,
                    icon: 'error'
                });
            }
        });
    }


</script>
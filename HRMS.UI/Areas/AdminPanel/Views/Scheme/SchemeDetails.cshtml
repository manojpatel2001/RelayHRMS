@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Scheme Details";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseAPIDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}
<style>
    .approval-level-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: #f8f9fa;
    }

    .approval-level-header {
        background: #2395c6;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .radio-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .radio-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
    }

    .dept-approval-badge {
        display: inline-block;
        background: #e3f2fd;
        padding: 5px 10px;
        border-radius: 4px;
        margin: 3px;
        font-size: 12px;
    }

    .selected-approvals-container {
        border: 1px dashed #ccc;
        padding: 10px;
        min-height: 50px;
        border-radius: 5px;
        background: #fff;
    }

    .approval-chip {
        display: inline-flex;
        align-items: center;
        background: #4caf50;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        margin: 3px;
        font-size: 13px;
    }

        .approval-chip .remove-chip {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }

    .modal-backdrop.show {
        opacity: 0.7;
    }

    .escalation-days-input {
        width: 100px;
    }

    .level-remove-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        font-size: 14px;
        cursor: pointer;
        height: 36px;
    }

        .level-remove-btn:hover {
            background-color: #c82333;
        }

    @@media (max-width: 768px) {
        .radio-group {
            flex-direction: column;
        }

        .col-md-4, .col-md-6 {
            margin-bottom: 15px;
        }
    }
</style>
<div class="card">
    <div class="card-header bg-transparent ml-0 py-0">
        <div class="row">
            <div class="col-6">
                <h6 class="pt-2 mb-0">Scheme Details</h6>
            </div>
            <div class="col-6 d-flex justify-content-end align-items-center">
                <button id="addSchemeDetails" type="button" class="btn mr-1 rounded-1" style="background-color:#2395c6; color:white;">
                    Add Scheme Details
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <div class="grid-wrapper" style="position: relative;" id="gridTag">
                    <div id="grid-loader" class="grid-loader justify-content-center align-items-center flex-column"
                         style="display: none; inset: 0; background: rgba(255,255,255,0.6); z-index: 10;">
                        <img src="@baseAPIDomainUrl/loders/loder.png" class="grid-logo-spinner"
                             style="width: 30px; height: 30px; animation: spin 1s linear infinite;" />
                        <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>
                    </div>
                    <div class="rowCount" id="rowCount2"></div>
                    <div id="GridContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Main Modal -->
<div class="modal fade" id="modalSchemeDetails" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title btn-heading-title">
                    <span class="formType">Add</span> Scheme Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body modal-body-font">
                <!-- Scheme Type & Scheme Selection -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group position-relative">
                            <div class="searchable-select-wrapper" id="schemeTypeWrapper">
                                <input type="text" class="searchable-select-input" id="drpSchemeType" readonly placeholder="Select">
                                <label class="floating-label" for="drpSchemeType">
                                    Scheme Type<span class="text-danger">*</span>
                                </label>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search scheme type..." class="search-input">
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                            <span id="spnSchemeType" style="color:red; display:none;">Please Select Scheme Type</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group position-relative">
                            <div class="searchable-select-wrapper" id="schemeWrapper">
                                <input type="text" class="searchable-select-input" id="drpScheme" readonly placeholder="Select">
                                <label class="floating-label" for="drpScheme">
                                    Scheme<span class="text-danger">*</span>
                                </label>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search scheme..." class="search-input">
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                            <span id="spnScheme" style="color:red; display:none;">Please Select Scheme</span>
                        </div>
                    </div>
                </div>
                <!-- Level 1 - Reporting Manager (Always Required) -->
                <div class="approval-level-card" id="level1Card">
                    <div class="approval-level-header">
                        <span>Level 1 </span>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group position-relative">
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" class="form-check-input level-radio" name="level1Approval" id="radioReportingPerson1" data-level="1" data-type="reportingManager" checked>
                                        <label class="form-check-label" for="radioReportingPerson1">Reporting Manger</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label>Escalation Days:</label>
                            <input type="number" class="form-control escalation-days-input" id="escalationDays1" min="0" value="0">
                        </div>
                        <div class="col-md-6">
                            <label>Skip Days:</label>
                            <input type="number" class="form-control escalation-days-input" id="skipDays1" min="0" value="0">
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-12">
                            <div class="checkbox-item">
                                <input type="checkbox" class="form-check-input" id="checkIsNotMandatory1" data-level="1">
                                <label class="form-check-label" for="checkIsNotMandatory1">Is Not Mandatory</label>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Dynamic Levels Container -->
                <div id="dynamicLevelsContainer"></div>
                <!-- Add Level Button -->
                <div class="text-center mt-3 mb-3">
                    <button type="button" class="btn btn-outline-primary" id="btnAddLevel">
                        <i class="bx bx-plus"></i> Level
                    </button>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnSave" style="background-color:#2395c6; color:white;">
                    Save All Levels
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Approver Selection Modal -->
<div class="modal fade" id="modalApproverSelection" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Approver - <span id="approverModalTitle"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group position-relative">
                            <div class="searchable-select-wrapper">
                                <input type="text" class="searchable-select-input" id="drpApproverCompany" readonly placeholder="Select">
                                <label class="floating-label">Company<span class="text-danger">*</span></label>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search company..." class="search-input">
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group position-relative">
                            <div class="searchable-select-wrapper">
                                <input type="text" class="searchable-select-input" id="drpApproverEmployee" readonly placeholder="Select">
                                <label class="floating-label">Approver<span class="text-danger">*</span></label>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search employee..." class="search-input">
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row ">
                    <div class="col-md-12">
                        <label>Select Designation Name:</label>
                        <select class="form-select" id="drpDesignationName" disabled>
                            <option value="">Select Designation</option>
                            <option value="National Manager">National Manager</option>
                            <option value="HR">HR</option>
                            <option value="HOD">HOD</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnConfirmApprover">Confirm Selection</button>
            </div>
        </div>
    </div>
</div>
<!-- Department Wise Approver Modal -->
<div class="modal fade" id="modalDepartmentApprover" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Department-wise Approvers - Level <span id="deptModalLevelNo"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Instructions:</strong> Select department and assign approver for each department. You can add multiple departments.
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 mt-3">
                        <div class="form-group position-relative">
                            <div class="searchable-select-wrapper">
                                <input type="text" class="searchable-select-input" id="drpDepartment" readonly placeholder="Select">
                                <label class="floating-label">Department<span class="text-danger">*</span></label>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search department..." class="search-input">
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mt-3">
                        <div class="form-group position-relative">
                            <div class="searchable-select-wrapper">
                                <input type="text" class="searchable-select-input" id="drpDeptApprover" readonly placeholder="Select">
                                <label class="floating-label">Approver<span class="text-danger">*</span></label>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search approver..." class="search-input">
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label>Select Designation Name:</label>
                        <select class="form-select" id="drpDeptDesignation" disabled>
                            <option value="">Select Designation</option>
                            <option value="National Manager">National Manager</option>
                            <option value="HR">HR</option>
                            <option value="HOD">HOD</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-12 text-end">
                        <button type="button" class="btn btn-success btn-sm" id="btnAddDeptApprover">
                            <i class="bx bx-plus"></i> Add Department Approver
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Department</th>
                                <th>Approver</th>
                                <th>Designation</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="deptApproverTableBody">
                            <!-- Dynamic rows will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnConfirmDeptApprovers">Confirm All</button>
            </div>
        </div>
    </div>
</div>
<script src="~/assets/js/jquery.min.js"></script>
<script>
    // Global Variables
    const companyDetails = JSON.parse(localStorage.getItem('selectedCompany'));
    const CompanyId = companyDetails.CompanyId;
    const EmployeeId = localStorage.getItem('EmployeeId');
    const Token = localStorage.getItem("authToken");
    let Id = 0;
    let currentLevel = 2; // Start from level 2 since level 1 is fixed
    let maxLevels = 5;
    let approvalLevelsData = {};
    let departmentApprovalsData = {};
    let currentModalContext = {};
    // Radio type mapping
    const radioTypes = {
        nationalManager: 'National Manager',
        hr: 'HR',
        hod: 'HOD',
        reportingManager: 'Reporting Manager'
    };
    // Initialize on document ready
    $(document).ready(function() {
        initializeDropdowns();
        loadSchemeDropdowns();
        setupEventHandlers();
        // Initialize Level 1 data
        approvalLevelsData[1] = {
            levelNo: 1,
            approvals: [],
            isDepartmentBased: false,
            departmentApprovals: [],
            escalationDays: 0,
            skipDays: 0,
            selectedRadioType: 'reportingManager',
            isNotMandatory: false,
            isFilled: true
        };
    });
    // Initialize all dropdowns
    function initializeDropdowns() {
        // Scheme dropdowns
        $('#drpSchemeType').searchableSelect({
            data: [],
            valueKey: 'schemeTypeId',
            textKey: 'schemeType',
            placeholder: 'Scheme Type',
            searchPlaceholder: 'Search scheme type...',
            onChange: function(item) {
                loadScheme();
            }
        });
        $('#drpScheme').searchableSelect({
            data: [],
            valueKey: 'schemeId',
            textKey: 'schemeName',
            placeholder: 'Scheme Name',
            searchPlaceholder: 'Search scheme...'
        });
        // Approver modal dropdowns
        $('#drpApproverCompany').searchableSelect({
            data: [],
            valueKey: 'companyId',
            textKey: 'companyName',
            placeholder: 'Company',
            onChange: function(item) {
                loadApproverEmployees();
            }
        });
        $('#drpApproverEmployee').searchableSelect({
            data: [],
            valueKey: 'employeeId',
            textKey: 'employeeName',
            placeholder: 'Approver'
        });
        // Department modal dropdowns
        $('#drpDepartment').searchableSelect({
            data: [],
            valueKey: 'departmentId',
            textKey: 'departmentName',
            placeholder: 'Department',
            onChange: function(item) {
                loadApproverEmployees();
            }
        });
        $('#drpDeptApprover').searchableSelect({
            data: [],
            valueKey: 'employeeId',
            textKey: 'employeeName',
            placeholder: 'Approver'
        });
    }
    // Load initial dropdown data
    async function loadSchemeDropdowns() {
        try {
            const response = await $.ajax({
                url: '@baseUrl/SchemeReportingManagerAPI/GetSchemeDropdownDetails',
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                }
            });
            if (response.isSuccess) {
                // Bind scheme types
                $('#drpSchemeType').data('searchableSelect').setData(response.data.schemeTypes || []);
                // Bind companies to all dropdowns
                const companies = response.data.companies || [];
                $('#drpApproverCompany').data('searchableSelect').setData(companies);
                // Bind departments
                if (response.data.departments) {
                    $('#drpDepartment').data('searchableSelect').setData(response.data.departments);
                }
            }
        } catch (error) {
            console.error('Error loading dropdown data:', error);
            showNotification('Error loading data', 'error');
        }
    }
    // Load schemes based on scheme type
    async function loadScheme() {
        const schemeTypeId = $('#drpSchemeType').data('searchableSelect').getValue();
        if (!schemeTypeId) return;
        try {
            const response = await $.ajax({
                url: `@baseUrl/SchemeReportingManagerAPI/GetDrpSchemeDetailsBySchemeType/${schemeTypeId}`,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                }
            });
            if (response.isSuccess) {
                $('#drpScheme').data('searchableSelect').setData(response.data || []);
            }
        } catch (error) {
            console.error('Error loading schemes:', error);
        }
    }
    // Load approver employees
    async function loadApproverEmployees() {
        const companyId = $('#drpApproverCompany').data('searchableSelect').getValue();
        const departmentId = $('#drpDepartment').data('searchableSelect').getValue();
        let urlPost = "";
        if (departmentId) {
            urlPost = `@baseUrl/SchemeReportingManagerAPI/GetAllEmployByDepartmentId?departmentId=${departmentId}`;
        } else {
            urlPost = `@baseUrl/SchemeReportingManagerAPI/GetAllEmployByDepartmentId?companyId=${companyId}`;
        }
        try {
            const response = await $.ajax({
                url: urlPost,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                }
            });
            if (response.isSuccess) {
                $('#drpApproverEmployee').data('searchableSelect').setData(response.data || []);
                $('#drpDeptApprover').data('searchableSelect').setData(response.data || []);
            }
        } catch (error) {
            console.error('Error loading employees:', error);
        }
    }
    // Setup event handlers
    function setupEventHandlers() {
        // Add scheme details button
        $('#addSchemeDetails').click(function() {
            resetForm();
            $('#modalSchemeDetails').modal('show');
        });
        // Add level button
        $('#btnAddLevel').click(function() {
            if (currentLevel <= maxLevels) {
                addApprovalLevel(currentLevel);
                currentLevel++;
            } else {
                showNotification('Maximum 5 levels allowed', 'warning');
            }
        });
        // Save button
        $('#btnSave').click(function() {
            saveAllLevels();
        });
        // Confirm approver selection
        $('#btnConfirmApprover').click(function() {
            confirmApproverSelection();
        });
        // Add department approver
        $('#btnAddDeptApprover').click(function() {
            addDepartmentApprover();
        });
        // Confirm all department approvers
        $('#btnConfirmDeptApprovers').click(function() {
            confirmDepartmentApprovers();
        });
        // Is Not Mandatory checkbox for Level 1
        $('#checkIsNotMandatory1').change(function() {
            const isChecked = $(this).is(':checked');
            approvalLevelsData[1].isNotMandatory = isChecked;
        });
    }
    // Check if current level is filled
    function isCurrentLevelFilled(levelNo) {
        const levelData = approvalLevelsData[levelNo];
        if (!levelData) return false;
        return levelData.isDepartmentBased ? levelData.departmentApprovals.length > 0 : levelData.approvals.length > 0;
    }
    // Add a new approval level
    function addApprovalLevel(levelNo) {
        const levelHtml = `
            <div class="approval-level-card" id="level${levelNo}Card" data-level="${levelNo}">
                <div class="approval-level-header">
                    <span>Level ${levelNo}</span>
                    <button type="button" class="btn level-remove-btn" onclick="removeLevel(${levelNo})">
                           <i class="bx bx-minus"></i>
                    </button>
                </div>
                <!-- Radio Options -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" class="form-check-input level-radio" name="level${levelNo}Approval" id="radioNationalManager${levelNo}" data-level="${levelNo}" data-type="nationalManager">
                                <label class="form-check-label" for="radioNationalManager${levelNo}">National Manager</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" class="form-check-input level-radio" name="level${levelNo}Approval" id="radioHr${levelNo}" data-level="${levelNo}" data-type="hr">
                                <label class="form-check-label" for="radioHr${levelNo}">HR</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" class="form-check-input level-radio" name="level${levelNo}Approval" id="radioHod${levelNo}" data-level="${levelNo}" data-type="hod">
                                <label class="form-check-label" for="radioHod${levelNo}">HOD</label>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Department Based Approval Checkbox -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="checkbox-item">
                            <input type="checkbox" class="form-check-input" id="checkDepartmentBased${levelNo}" data-level="${levelNo}">
                            <label class="form-check-label" for="checkDepartmentBased${levelNo}">
                                <strong>Department Based Approval</strong>
                            </label>
                        </div>
                    </div>
                </div>
                <!-- Selected Approvals Display -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label><strong>Selected Approvers:</strong></label>
                        <div class="selected-approvals-container" id="selectedApprovals${levelNo}">
                            <span class="text-muted">No approvers selected</span>
                        </div>
                    </div>
                </div>
                <!-- Escalation and Skip Days -->
                <div class="row">
                    <div class="col-md-6">
                        <label>Escalation Days:</label>
                        <input type="number" class="form-control escalation-days-input" id="escalationDays${levelNo}" min="0" value="0">
                    </div>
                    <div class="col-md-6">
                        <label>Skip Days:</label>
                        <input type="number" class="form-control escalation-days-input" id="skipDays${levelNo}" min="0" value="0">
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <div class="checkbox-item">
                            <input type="checkbox" class="form-check-input" id="checkIsNotMandatory${levelNo}" data-level="${levelNo}">
                            <label class="form-check-label" for="checkIsNotMandatory${levelNo}">Is Not Mandatory</label>
                        </div>
                    </div>
                </div>
            </div>
        `;
        $('#dynamicLevelsContainer').append(levelHtml);
        // Initialize approval data structure for this level
        approvalLevelsData[levelNo] = {
            levelNo: levelNo,
            approvals: [],
            isDepartmentBased: false,
            departmentApprovals: [],
            escalationDays: 0,
            skipDays: 0,
            selectedRadioType: null,
            isNotMandatory: false,
            isFilled: false
        };
        // Attach event handlers for radio buttons and checkbox
        attachLevelRadioHandlers(levelNo);
    }
    // Attach radio button and checkbox event handlers
    function attachLevelRadioHandlers(levelNo) {
        // Handle radio button selection
        $(`.level-radio[name="level${levelNo}Approval"]`).change(function() {
            const radioType = $(this).data('type');
            handleRadioSelection(levelNo, radioType);
            openApproverSelectionModal(levelNo, radioType);
        });
        // Handle department-based checkbox
        $(`#checkDepartmentBased${levelNo}`).change(function() {
            const isChecked = $(this).is(':checked');
            if (isChecked) {
                // Uncheck and disable radio buttons
                $(`.level-radio[name="level${levelNo}Approval"]`).prop('checked', false).prop('disabled', true);
                approvalLevelsData[levelNo].isDepartmentBased = true;
                openDepartmentApproverModal(levelNo);
            } else {
                $(`.level-radio[name="level${levelNo}Approval"]`).prop('disabled', false);
                approvalLevelsData[levelNo].isDepartmentBased = false;
                approvalLevelsData[levelNo].departmentApprovals = [];
                updateSelectedApprovalsDisplay(levelNo);
            }
        });
        // Handle Is Not Mandatory checkbox
        $(`#checkIsNotMandatory${levelNo}`).change(function() {
            const isChecked = $(this).is(':checked');
            if (approvalLevelsData[levelNo]) {
                approvalLevelsData[levelNo].isNotMandatory = isChecked;
            }
        });
    }
    // Handle radio button selection logic
    function handleRadioSelection(levelNo, radioType) {
        // Ensure approvalLevelsData[levelNo] exists
        if (!approvalLevelsData[levelNo]) {
            approvalLevelsData[levelNo] = {
                levelNo: levelNo,
                approvals: [],
                isDepartmentBased: false,
                departmentApprovals: [],
                escalationDays: 0,
                skipDays: 0,
                selectedRadioType: null,
                isNotMandatory: false,
                isFilled: false
            };
        }
        // If a radio button is selected in a lower level, uncheck the above level's radio button of the same type
        for (let i = 1; i < levelNo; i++) {
            if (approvalLevelsData[i] && approvalLevelsData[i].selectedRadioType === radioType) {
                $(`#radio${radioType.charAt(0).toUpperCase() + radioType.slice(1)}${i}`).prop('checked', false);
                approvalLevelsData[i].selectedRadioType = null;
            }
        }
        // If a radio button is selected in a lower level, check the same radio in the upper level
        for (let i = levelNo - 1; i >= 1; i--) {
            if (approvalLevelsData[i]) {
                $(`#radio${radioType.charAt(0).toUpperCase() + radioType.slice(1)}${i}`).prop('checked', true);
                approvalLevelsData[i].selectedRadioType = radioType;
                break;
            }
        }
        approvalLevelsData[levelNo].selectedRadioType = radioType;
    }
    // Open approver selection modal
    function openApproverSelectionModal(levelNo, radioType) {
        currentModalContext = {
            levelNo: levelNo,
            radioType: radioType
        };
        $('#approverModalTitle').text(`${radioTypes[radioType]} - Level ${levelNo}`);
        // Auto-select the designation based on the radio button selection
        $('#drpDesignationName').val(radioTypes[radioType]).prop('disabled', true);
        // Reset other fields
        $('#drpApproverCompany').data('searchableSelect').setValue(null);
        $('#drpApproverEmployee').data('searchableSelect').setValue(null);
        $('#modalApproverSelection').modal('show');
    }
    // Confirm approver selection
    function confirmApproverSelection() {
        const employeeId = $('#drpApproverEmployee').data('searchableSelect').getValue();
        const employeeName = $('#drpApproverEmployee').data('searchableSelect').getText();
        const designationName = $('#drpDesignationName').val();
        if (!employeeId && !designationName) {
            showNotification('Please select an approver or enter designation name', 'warning');
            return;
        }
        const approval = {
            radioType: currentModalContext.radioType,
            employeeId: employeeId || null,
            employeeName: employeeName || null,
            designationName: designationName || null,
            displayName: employeeName || designationName
        };
        // Add to level data
        if (approvalLevelsData[currentModalContext.levelNo]) {
            approvalLevelsData[currentModalContext.levelNo].approvals = [approval];
            approvalLevelsData[currentModalContext.levelNo].isFilled = true;
            // Update display
            updateSelectedApprovalsDisplay(currentModalContext.levelNo);
        }
        $('#modalApproverSelection').modal('hide');
    }
    // Update selected approvals display
    function updateSelectedApprovalsDisplay(levelNo) {
        const container = $(`#selectedApprovals${levelNo}`);
        const levelData = approvalLevelsData[levelNo];
        if (!levelData) return;
        container.empty();
        if (levelData.isDepartmentBased && levelData.departmentApprovals.length > 0) {
            // Display department-based approvals
            levelData.departmentApprovals.forEach(dept => {
                const chip = `
                    <div class="approval-chip">
                        <strong>${dept.departmentName}:</strong> ${dept.displayName}
                        <span class="remove-chip" onclick="removeDeptApproval(${levelNo}, ${dept.departmentId})">×</span>
                    </div>
                `;
                container.append(chip);
            });
        } else if (levelData.approvals.length > 0) {
            // Display regular approvals
            levelData.approvals.forEach(approval => {
                const chip = `
                    <div class="approval-chip">
                        <strong>${radioTypes[approval.radioType]}:</strong> ${approval.displayName}
                        <span class="remove-chip" onclick="removeApprovalChip(${levelNo}, '${approval.radioType}')">×</span>
                    </div>
                `;
                container.append(chip);
            });
        } else {
            container.html('<span class="text-muted">No approvers selected</span>');
        }
    }
    // Open department approver modal
    function openDepartmentApproverModal(levelNo) {
        currentModalContext = { levelNo: levelNo };
        $('#deptModalLevelNo').text(levelNo);
        $('#deptApproverTableBody').empty();
        // Reset fields
        $('#drpDepartment').data('searchableSelect').setValue(null);
        $('#drpDeptApprover').data('searchableSelect').setValue(null);
        // Enable the designation dropdown without auto-selecting
        $('#drpDeptDesignation').prop('disabled', false).val('');
        // Load existing department approvals
        const levelData = approvalLevelsData[levelNo];
        if (levelData && levelData.departmentApprovals.length > 0) {
            levelData.departmentApprovals.forEach(dept => {
                addDepartmentRow(dept);
            });
        }
        $('#modalDepartmentApprover').modal('show');
    }
    // Add department approver to table
    function addDepartmentApprover() {
        const deptId = $('#drpDepartment').data('searchableSelect').getValue();
        const deptName = $('#drpDepartment').data('searchableSelect').getText();
        const approverId = $('#drpDeptApprover').data('searchableSelect').getValue();
        const approverName = $('#drpDeptApprover').data('searchableSelect').getText();
        const designationName = $('#drpDeptDesignation').val();
        if (!deptId) {
            showNotification('Please select a department', 'warning');
            return;
        }
        if (!approverId && !designationName) {
            showNotification('Please select an approver or enter designation', 'warning');
            return;
        }
        const deptApproval = {
            departmentId: deptId,
            departmentName: deptName,
            employeeId: approverId || null,
            employeeName: approverName || null,
            designationName: designationName || null,
            displayName: approverName || designationName
        };
        addDepartmentRow(deptApproval);
        // Reset fields
        $('#drpDepartment').data('searchableSelect').setValue(null);
        $('#drpDeptApprover').data('searchableSelect').setValue(null);
    }
    // Add department row to table
    function addDepartmentRow(deptApproval) {
        const row = `
            <tr data-dept-id="${deptApproval.departmentId}">
                <td>${deptApproval.departmentName}</td>
                <td>${deptApproval.employeeName || '-'}</td>
                <td>${deptApproval.designationName || '-'}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeDeptRow(${deptApproval.departmentId})">
                       <i class="bx bx-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        $('#deptApproverTableBody').append(row);
    }
    // Remove department row
    window.removeDeptRow = function(deptId) {
        $(`tr[data-dept-id="${deptId}"]`).remove();
    };
    // Confirm department approvers
    function confirmDepartmentApprovers() {
        const levelNo = currentModalContext.levelNo;
        const departmentApprovals = [];
        $('#deptApproverTableBody tr').each(function() {
            const deptId = $(this).data('dept-id');
            const deptName = $(this).find('td:eq(0)').text();
            const approverName = $(this).find('td:eq(1)').text();
            const designationName = $(this).find('td:eq(2)').text();
            departmentApprovals.push({
                departmentId: deptId,
                departmentName: deptName,
                employeeId: approverName !== '-' ? $(this).data('employee-id') : null,
                employeeName: approverName !== '-' ? approverName : null,
                designationName: designationName !== '-' ? designationName : null,
                displayName: approverName !== '-' ? approverName : designationName
            });
        });
        if (departmentApprovals.length === 0) {
            showNotification('Please add at least one department approver', 'warning');
            return;
        }
        if (approvalLevelsData[levelNo]) {
            approvalLevelsData[levelNo].departmentApprovals = departmentApprovals;
            approvalLevelsData[levelNo].isFilled = true;
            updateSelectedApprovalsDisplay(levelNo);
        }
        $('#modalDepartmentApprover').modal('hide');
    }
    // Remove department approval chip
    window.removeDeptApproval = function(levelNo, deptId) {
        const levelData = approvalLevelsData[levelNo];
        if (levelData) {
            levelData.departmentApprovals = levelData.departmentApprovals.filter(d => d.departmentId !== deptId);
            levelData.isFilled = levelData.departmentApprovals.length > 0 || levelData.approvals.length > 0;
            updateSelectedApprovalsDisplay(levelNo);
        }
    };
    // Remove approval chip
    window.removeApprovalChip = function(levelNo, radioType) {
        $(`#radio${radioType.charAt(0).toUpperCase() + radioType.slice(1)}${levelNo}`).prop('checked', false);
        const levelData = approvalLevelsData[levelNo];
        if (levelData) {
            levelData.approvals = [];
            levelData.isFilled = levelData.departmentApprovals.length > 0 || levelData.approvals.length > 0;
            updateSelectedApprovalsDisplay(levelNo);
        }
    };
    // Remove level
    window.removeLevel = function(levelNo) {
        if (confirm(`Are you sure you want to remove Level ${levelNo}?`)) {
            $(`#level${levelNo}Card`).remove();
            delete approvalLevelsData[levelNo];
            // Adjust currentLevel if needed
            if (levelNo === currentLevel - 1) {
                currentLevel--;
            }
        }
    };
    // Validate form
    function validateForm() {
        let isValid = true;
        // Validate scheme type and scheme
        if (!$('#drpSchemeType').data('searchableSelect').getValue()) {
            $('#spnSchemeType').show();
            isValid = false;
        } else {
            $('#spnSchemeType').hide();
        }
        if (!$('#drpScheme').data('searchableSelect').getValue()) {
            $('#spnScheme').show();
            isValid = false;
        } else {
            $('#spnScheme').hide();
        }
        return isValid;
    }
    // Save all levels
    async function saveAllLevels() {
        $('#btnSave').prop('disabled', true).text('Saving...');
        try {
            const schemeId = $('#drpScheme').data('searchableSelect').getValue();
            const approvalScheme = [];
            // Add Level 1 (Reporting Manager)
            const level1Data = {
                Action: 'Insert',
                ApprovalSchemeLevelId: 0,
                SchemeId: parseInt(schemeId),
                SequenceNo: 1,
                ApproverEmployeeId: EmployeeId,
                ApproverDesignationName: 'Reporting Manager',
                IsDepartmentBased: false,
                IsNotMandatory: approvalLevelsData[1].isNotMandatory,
                EscalationDays: parseInt($('#escalationDays1').val()) || 0,
                SkipDays: parseInt($('#skipDays1').val()) || 0,
                IsActive: true,
                CreatedBy: EmployeeId,
                UpdatedBy: EmployeeId,
                approvalSchemeLevelDepartmentVMs: []
            };
            approvalScheme.push(level1Data);
            // Add dynamic levels
            Object.keys(approvalLevelsData).sort().forEach(levelNo => {
                if (levelNo == 1) return; // Skip Level 1
                const levelData = approvalLevelsData[levelNo];
                if (!levelData) return; // Skip if levelData is undefined
                if (levelData.isDepartmentBased) {
                    // Department-based approval
                    const deptLevelData = {
                        Action: 'Insert',
                        ApprovalSchemeLevelId: 0,
                        SchemeId: parseInt(schemeId),
                        SequenceNo: parseInt(levelNo),
                        ApproverEmployeeId: null,
                        ApproverDesignationName: null,
                        IsDepartmentBased: true,
                        IsNotMandatory: levelData.isNotMandatory,
                        EscalationDays: parseInt($(`#escalationDays${levelNo}`).val()) || 0,
                        SkipDays: parseInt($(`#skipDays${levelNo}`).val()) || 0,
                        IsActive: true,
                        CreatedBy: EmployeeId,
                        UpdatedBy: EmployeeId,
                        approvalSchemeLevelDepartmentVMs: levelData.departmentApprovals.map(dept => ({
                            ApprovalSchemeLevelId: 0,
                            DepartmentId: dept.departmentId,
                            DeptApproverEmployeeId: dept.employeeId,
                            DeptApproverDesignationName: dept.designationName,
                            IsActive: true
                        }))
                    };
                    approvalScheme.push(deptLevelData);
                } else if (levelData.approvals.length > 0) {
                    // Regular approvals
                    const approval = levelData.approvals[0];
                    const approvalData = {
                        Action: 'Insert',
                        ApprovalSchemeLevelId: 0,
                        SchemeId: parseInt(schemeId),
                        SequenceNo: parseInt(levelNo),
                        ApproverEmployeeId: approval.employeeId,
                        ApproverDesignationName: approval.designationName,
                        IsDepartmentBased: false,
                        IsNotMandatory: levelData.isNotMandatory,
                        EscalationDays: parseInt($(`#escalationDays${levelNo}`).val()) || 0,
                        SkipDays: parseInt($(`#skipDays${levelNo}`).val()) || 0,
                        IsActive: true,
                        CreatedBy: EmployeeId,
                        UpdatedBy: EmployeeId,
                        approvalSchemeLevelDepartmentVMs: []
                    };
                    approvalScheme.push(approvalData);
                }
            });
            console.log('Saving approval scheme:', approvalScheme);
            // Updated AJAX call with .done() and .fail()
            await $.ajax({
                url: '@baseUrl/ApprovalManagementAPI/ManageApprovalSchemeLevel',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                data: JSON.stringify(approvalScheme)
            })
            .done(function(response) {
                if (response.isSuccess) {
                    showNotification('Approval scheme saved successfully!', 'success');
                    $('#modalSchemeDetails').modal('hide');
                    resetForm();
                } else {
                    showNotification(response.message || 'Error saving approval scheme', 'error');
                }
            })
            .fail(function(xhr, status, error) {
                console.error('AJAX Error:', error);
                let errorMessage = 'An error occurred while saving';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                showNotification(errorMessage, 'error');
            });
        } catch (error) {
            console.error('Unexpected error:', error);
            showNotification('An unexpected error occurred', 'error');
        } finally {
            $('#btnSave').prop('disabled', false).text('Save All Levels');
        }
    }
    // Reset form
    function resetForm() {
        // Reset dropdowns
        $('#drpSchemeType').data('searchableSelect').setValue(null);
        $('#drpScheme').data('searchableSelect').setValue(null);
        // Reset escalation days
        $('#escalationDays1').val(0);
        $('#skipDays1').val(0);
        // Clear dynamic levels
        $('#dynamicLevelsContainer').empty();
        // Reset data
        approvalLevelsData = {
            1: {
                levelNo: 1,
                approvals: [],
                isDepartmentBased: false,
                departmentApprovals: [],
                escalationDays: 0,
                skipDays: 0,
                selectedRadioType: 'reportingPerson',
                isNotMandatory: false,
                isFilled: true
            }
        };
        currentLevel = 2;
        // Hide error messages
        $('[id^="spn"]').hide();
    }
    // Show notification
    function showNotification(message, type) {
        if (type === 'success') {
            alert('✓ ' + message);
        } else if (type === 'error') {
            alert('✗ ' + message);
        } else {
            alert(message);
        }
    }
</script>

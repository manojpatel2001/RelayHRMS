@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Employee Panel";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];
}

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Search Panel</title>
<link href="~/commoncss.css" rel="stylesheet" />

<!-- jQuery + Bootstrap + SweetAlert -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.all.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
    }

    .form-section {
        padding: 15px;
        border: 1px solid #ccc;
        max-width: 100%;
    }

    .btn-custom {
        background-color: #3e4b6d;
        color: white;
        font-weight: 600;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        margin-right: 10px;
        cursor: pointer;
    }

        .btn-custom:hover {
            background-color: #2c3a57;
        }

    .btn-approve {
        background-color: #28a745;
        color: white;
        font-weight: 600;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        margin-right: 10px;
        cursor: pointer;
    }

        .btn-approve:hover {
            background-color: #218838;
        }

    .search-panel-container {
        background-color: #3e4b6d;
        padding: 6px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .search-panel-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-heading {
        font-size: 15px;
        color: white;
        margin: 0;
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
        white-space: nowrap;
        display: block;
        text-align: left;
    }

    .form-control-sm, .form-select-sm {
        height: calc(1.5em + .5rem + 2px);
        font-size: 0.875rem;
        padding: .25rem .5rem;
        width: 180px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .form-control-md {
        width: 180px;
    }

    .text-center-cell {
        text-align: center !important;
    }

        .text-center-cell > div {
            text-align: center !important;
        }

    .container {
        max-width: 100% !important;
        padding-left: 15px;
        padding-right: 15px;
    }

    .grid-container {
        width: 100%;
        overflow-x: auto;
    }

    .action-buttons-right {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        justify-content: flex-end;
        align-items: center;
        padding: 10px 0;
    }

    /* Fixed form layout - horizontal alignment */
    .form-row {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 30px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        min-width: 200px;
        align-items: flex-start;
    }

    /* Status and control row - horizontal alignment */
    .status-control-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 30px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .status-group {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .status-label {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 10px;
        text-align: center;
    }

    .radio-group {
        display: flex;
        justify-content: center;
        gap: 20px;
        align-items: center;
    }

    .radio-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

        .radio-item input[type="radio"] {
            margin: 0;
        }

        .radio-item label {
            margin: 0;
            font-size: 13px;
            cursor: pointer;
        }

    /* Control buttons styling */
    .control-buttons {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .control-btn {
        background-color: #3e4b6d;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        font-size: 13px;
        cursor: pointer;
        font-weight: 500;
        min-width: 60px;
    }

        .control-btn:hover {
            background-color: #2c3a57;
        }

    @@media (max-width: 768px) {
        .form-row

    {
        flex-direction: column;
        gap: 15px;
        align-items: center;
    }

    .form-group {
        min-width: 180px;
        width: 100%;
        max-width: 300px;
    }

    .status-control-row {
        flex-direction: column;
        gap: 20px;
    }

    .radio-group {
        flex-wrap: wrap;
        gap: 15px;
    }

    .control-buttons {
        gap: 10px;
    }

    .control-btn {
        padding: 6px 15px;
        font-size: 12px;
    }

    }
</style>

<div class="search-panel-wrapper">
    <div class="search-panel-container">
        <div class="search-panel-row">
            <div class="search-heading">Search Panel</div>
        </div>
    </div>
</div>

<div class="form-section">
    <!-- First Row: Search By, Search For, By Branch -->
    <div class="form-row">
        <div class="form-group">
            <label for="searchtypeid" class="form-label">Search By:</label>
            <select class="form-control form-control-sm" id="searchtypeid">
                <option value="">-- Select --</option>
                <option value="Employee Code">Employee Code</option>
                <option value="Employee Name">Employee Name</option>
            </select>
        </div>
        <div class="form-group">
            <label for="searchforid" class="form-label">Search For:</label>
            <input type="text" class="form-control form-control-sm" id="searchforid" disabled />
        </div>
        <div class="form-group">
            <label for="branchid" class="form-label">By Branch:</label>
            <select class="form-control form-control-sm" id="branchid">
                <option value="">-- Select --</option>
            </select>
        </div>
    </div>

    <!-- Second Row: Status Radio buttons with GO and Clear buttons -->
    <div class="status-control-row">
        <div class="status-group">
            <div class="radio-group">
                <div class="radio-item">
                    <input type="radio" id="statusPending" name="statusFilter" value="Pending" checked>
                    <label for="statusPending">Pending</label>
                </div>
                <div class="radio-item">
                    <input type="radio" id="statusApproved" name="statusFilter" value="Approved">
                    <label for="statusApproved">Approved</label>
                </div>
                <div class="radio-item">
                    <input type="radio" id="statusRejected" name="statusFilter" value="Rejected">
                    <label for="statusRejected">Rejected</label>
                </div>
            </div>
        </div>

        <div class="control-buttons">
            <button type="button" class="control-btn" id="goButtonId">GO</button>
            <button type="button" class="control-btn" id="clearButtonId">Clear</button>
        </div>
    </div>

    <div class="search-panel-wrapper">
        <div class="search-panel-container">
            <div class="search-panel-row">
                <div class="search-heading">Comp Off Application</div>
            </div>
        </div>
    </div>

    <!-- Full width container -->
    <div class="container-fluid mt-3">
        <!-- Action buttons on the RIGHT side -->
        <div class="action-buttons-right" id="actionButtons" style="display: none;">
            <button id="btnApprove" class="btn-custom" value="Approved">
                <i class="fas fa-check"></i> Approve
            </button>
            <button id="btnReject" class="btn-custom" value="Rejected">
                <i class="fas fa-times"></i> Reject
            </button>
        </div>

        <!-- Full width grid container -->
        <div class="grid-container">
            <div id="attendanceGrid">Loading...</div>
        </div>

        <div id="recordSummary" class="text-center mt-2 text-muted"></div>
    </div>
</div>

<script>
    const Empid = parseInt(localStorage.getItem("EmployeeId"));
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany || '{}');
    const Compid = parseInt(companyDetails.CompanyId);
    const Token = localStorage.getItem("authToken");
    let selectedKeys = [];

    $(document).ready(function () {
        GetBranch();
        // Load pending applications by default
        loadAllApplications();

        // Enable/disable search input based on search type selection
        $('#searchtypeid').on('change', function () {
            const selectedValue = $(this).val();
            if (selectedValue) {
                $('#searchforid').prop('disabled', false);
            } else {
                $('#searchforid').prop('disabled', true).val('');
            }
        });

        // Handle status change - hide buttons when status changes
        $('input[name="statusFilter"]').on('change', function () {
            // Hide action buttons when status filter changes
            $('#actionButtons').hide();
            selectedKeys = [];
            loadAllApplications();
        });

        // GO button click
        $('#goButtonId').on('click', function () {
            // Hide action buttons when GO is clicked
            $('#actionButtons').hide();
            selectedKeys = [];
            loadAllApplications();
        });

        // Clear button click
        $('#clearButtonId').on('click', function () {
            $('#searchtypeid').val('');
            $('#searchforid').val('').prop('disabled', true);
            $('#branchid').val('');
            $('input[name="statusFilter"][value="Pending"]').prop('checked', true);
            loadAllApplications();
            $('#actionButtons').hide();
            selectedKeys = [];
        });

        // Approve button click
        $('#btnApprove').on('click', function () {
            handleApprovalOrRejection("Approved");
        });

        // Reject button click
        $('#btnReject').on('click', function () {
            handleApprovalOrRejection("Rejected");
        });
    });

    function GetBranch() {
        debugger;
        $.ajax({
            url: '@(baseDomainUrl)/api/BranchAPI/GetAllBranchesListByCompanyId/' + Compid,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + Token,
            },
            contentType: 'application/json',
            success: function (data) {
                if (data.isSuccess && data.data && data.data.length > 0) {
                    const branches = data.data;
                    const $branchDropdown = $('#branchid');
                    $branchDropdown.empty().append('<option value="">-- Select --</option>');
                    branches.forEach(branch => {
                        $branchDropdown.append(`<option value="${branch.branchId}">${branch.branchName}</option>`);
                    });
                }
            },
            error: function () {
                console.error("Error loading branch data.");
            }
        });
    }

    function loadAllApplications() {
        debugger;
        const searchType = $('#searchtypeid').val();
        const searchFor = $('#searchforid').val();
        const branchId = $('#branchid').val();
        const applicationStatus = $('input[name="statusFilter"]:checked').val();

        const payload = {
            SearchType: searchType || null,
            SearchFor: searchFor || null,
            CompId: Compid,
            BranchId: branchId ? parseInt(branchId) : null,
            ApplicationStatus: applicationStatus || null
        };

        $.ajax({
            url: '@(baseDomainUrl)/api/CompOffAPI/GetCompOffDetailsReportForAdmin',
            method: 'POST',
            contentType: 'application/json',
            headers: {
                'Authorization': 'Bearer ' + Token,
            },
            data: JSON.stringify(payload),
            success: function (data) {
                if (data.isSuccess && data.data && data.data.length > 0) {
                    renderTable(data.data);
                    $('#recordSummary').text(`${data.data.length} records found.`);
                } else {
                    $('#attendanceGrid').html('<div class="text-center text-muted">No records found.</div>');
                    $('#recordSummary').text('');
                    $('#actionButtons').show();
                }
            },
            error: function (xhr) {
                console.error("Error loading data:", xhr);
                $('#attendanceGrid').html('<div class="text-center text-danger">Error loading data.</div>');
                $('#recordSummary').text('');
                $('#actionButtons').hide();
                Swal.fire("❌ Server error", xhr.responseText || "Unable to load data", "error");
            }
        });
    }

    function renderTable(data) {
        $("#attendanceGrid").dxDataGrid({
            dataSource: data,
            keyExpr: "comp_Off_Detailsid",
            showBorders: true,
            columnAutoWidth: true,
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "always"
            },
            onSelectionChanged: function (e) {
                selectedKeys = e.selectedRowKeys;
                const currentStatus = $('input[name="statusFilter"]:checked').val();
   
                if (currentStatus === "Pending" && selectedKeys.length > 0) {
                    $("#actionButtons").show();
                } else {
                    $("#actionButtons").hide();
                }
            },
            columns: [
                { dataField: "comp_Off_Detailsid", caption: "Application ID", width: 120, cssClass: "text-center-cell" },
                { dataField: "employeeCode", caption: "Employee Code", cssClass: "text-center-cell" },
                { dataField: "fullName", caption: "Employee Name", cssClass: "text-center-cell" },
                { dataField: "branchName", caption: "Branch Name", cssClass: "text-center-cell" },
                { dataField: "designationName", caption: "Designation", cssClass: "text-center-cell" },
                { dataField: "extraWorkDay", caption: "Extra Work Day", dataType: "date", format: "dd/MM/yyyy", cssClass: "text-center-cell" },
                { dataField: "extraWorkHours", caption: "Extra Hours", dataType: "number", format: { type: "fixedPoint", precision: 2 }, cssClass: "text-center-cell" },
                { dataField: "comoffReason", caption: "Reason", cssClass: "text-center-cell" },
                { dataField: "applicationStatus", caption: "Application Status", cssClass: "text-center-cell" }
            ]
        });
    }

    function handleApprovalOrRejection(status) {
        debugger;
        if (!selectedKeys || selectedKeys.length === 0) {
            Swal.fire('Warning', 'Please select at least one application.', 'warning');
            return;
        }

        // Show loading state
        if (status == "Approved") {
            $('#btnApprove').hide();
            $('#btnApprove').after('<button id="btnAproving" class="btn-custom" disabled>Approving...</button>');
        } else {
            $('#btnReject').hide();
            $('#btnReject').after('<button id="btnRejecting" class="btn-custom" disabled>Rejecting...</button>');
        }

        const payload = {
            CompoffIds: selectedKeys,
            status: status,
            EmployeeId: Empid
        };

        $.ajax({
            url: '@(baseDomainUrl)/api/CompOffAPI/CompOffDetailsApproveorReject',
            method: 'POST',
            contentType: 'application/json',
            headers: {
                'Authorization': 'Bearer ' + Token,
            },
            data: JSON.stringify(payload),
            success: function (res) {
                if (res.isSuccess) {
                    Swal.fire("✅ Success", res.responseMessage, "success");
                    // Reload data
                    loadAllApplications();
                    selectedKeys = [];
                    $('#actionButtons').hide();
                } else {
                    Swal.fire("❌ Failed", res.responseMessage, "error");
                }
            },
            error: function (xhr) {
                console.error("Error in approval/rejection:", xhr);
                Swal.fire("❌ Server error", xhr.responseText || "Unable to process request", "error");
            },
            complete: function () {
                // Reset buttons
                if (status == "Approved") {
                    $('#btnAproving').remove();
                    $('#btnApprove').show();
                } else {
                    $('#btnRejecting').remove();
                    $('#btnReject').show();
                }
            }
        });
    }
</script>
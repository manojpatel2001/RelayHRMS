@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Monthly Salary";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];

}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body {
            background-color: white !important;
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .inout-box {
            background-color: white !important;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 5px;
        }

        .inout-header {
            background-color: #3e4b6d;
            color: white;
            font-weight: bold;
            padding: 8px 15px;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }

        .form-label {
            width: 130px;
            margin-bottom: 0;
            font-weight: 500;
        }

        .form-group-row {
            margin-bottom: 12px;
        }

        .form-select-sm,
        .form-control-sm {
            width: 180px;
        }

        .btn-go {
            background-color: #3e4b6d;
            color: white;
            border: none;
            padding: 4px 12px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 4px;
            transition: none;
            box-shadow: none;
        }

            .btn-go:hover,
            .btn-go:focus,
            .btn-go:active {
                background-color: #3e4b6d;
                color: white;
                outline: none;
                box-shadow: none;
            }

        .dx-tagbox,
        .dx-tagbox .dx-texteditor {
            width: 100% !important;
            max-width: 100% !important;
        }

        #branchDropdown,
        #employeeDropdown {
            width: 100%;
        }

        .dx-placeholder {
            font-size: 14px !important;
            color: #999 !important;
            white-space: nowrap;
        }

        .dx-texteditor-input {
            width: 100% !important;
        }

        .small-dropdown {
            width: 180px !important;
        }

        .dx-list-select-all {
            background-color: transparent !important;
            color: #333 !important;
            font-weight: normal;
            padding: 8px 12px;
        }

            .dx-list-select-all.dx-state-hover {
                background-color: #f8f8f8 !important;
            }

        .dx-placeholder {
            color: #999 !important;
            font-weight: normal;
        }

        #inoutActions {
            margin-top: 20px !important;
            margin-bottom: 20px !important;
            clear: both;
            padding: 10px 0;
        }

            #inoutActions button {
                background-color: #3e4b6d;
                color: white;
                border: none;
                padding: 4px 12px;
                font-size: 13px;
                font-weight: 600;
                border-radius: 4px;
                transition: none;
                box-shadow: none;
                margin: 0 5px;
            }

                #inoutActions button:hover,
                #inoutActions button:focus,
                #inoutActions button:active {
                    background-color: #3e4b6d;
                    color: white;
                    outline: none;
                    box-shadow: none;
                }

        .dx-button .fa-file-excel {
            color: #217346;
        }

        /* DevExtreme Grid Header Fixes */
        .dx-datagrid-headers .dx-header-row > td,
        .dx-datagrid-headers .dx-header-row > th,
        .dx-datagrid .dx-datagrid-headers .dx-datagrid-content-fixed .dx-header-row > td,
        .dx-datagrid .dx-datagrid-headers .dx-datagrid-content-fixed .dx-header-row > th {
            background-color: #3e4b6d !important;
            color: white !important;
            font-weight: bold !important;
            border-color: #2a3447 !important;
        }

        .dx-datagrid .dx-header-row .dx-datagrid-action,
        .dx-datagrid-headers .dx-datagrid-action {
            background-color: #3e4b6d !important;
        }

        .dx-datagrid .dx-datagrid-headers {
            background-color: #3e4b6d !important;
        }

            .dx-datagrid .dx-datagrid-headers .dx-datagrid-table .dx-row > td {
                background-color: #3e4b6d !important;
                color: white !important;
                border-color: #2a3447 !important;
            }

        .dx-datagrid-header-panel .dx-toolbar .dx-toolbar-items-container {
            background-color: transparent;
        }

        .dx-datagrid-wrapper {
            margin-bottom: 20px !important;
        }

        .small-swal {
            width: 150px !important;
        }

            .small-swal .swal2-title {
                font-size: 10px !important;
            }

            .small-swal .swal2-content {
                font-size: 10px !important;
            }

            .small-swal .swal2-icon {
                width: 1em !important;
                height: 1em !important;
            }

            .small-swal .swal2-styled {
                font-size: 10px !important;
                padding: 5px 15px !important;
            }

        @@media (max-width: 768px) {
            #inoutGridContainer

        {
            height: 250px;
        }

        }

        #inoutGridContainer {
            margin-bottom: 20px !important;
            height: 350px !important;
            overflow: auto !important;
        }

        .grid-container {
            height: 350px;
            overflow: auto;
        }

        #grid-loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(3px);
            z-index: 9999;
        }

        .grid-logo-spinner {
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @@keyframes spin {
            0%

        {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }

        }

        .grid-loading-text {
            font-size: 16px;
            color: #333;
        }
    </style>

    <div class="inout-box">
        <div class="inout-header">Employee In/Out</div>

        <div class="row justify-content-center mt-3">
            <div class="col-lg-10">
                <div class="row">
                    <!-- Left Column -->
                    <div class="col-md-6">
                        <div class="form-group-row d-flex align-items-center">
                            <label class="form-label">Start Date<span class="text-danger">*</span> :</label>
                            <input type="date" class="form-control form-control-sm" id="startDate">
                        </div>

                        <div class="form-group-row d-flex align-items-center">
                            <label class="form-label">Branch<span class="text-danger">*</span> :</label>
                            <div id="branchDropdown" class="small-dropdown"></div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="col-md-6">
                        <div class="form-group-row d-flex align-items-center">
                            <label class="form-label">End Date<span class="text-danger">*</span> :</label>
                            <input type="date" class="form-control form-control-sm" id="endDate">
                        </div>

                        <div class="form-group-row d-flex align-items-center">
                            <label class="form-label">Employee<span class="text-danger">*</span> :</label>
                            <div id="employeeDropdown" class="small-dropdown"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Buttons -->
        <div class="col-md-12 text-center mt-3">
            <button class="btn-go" id="btnFetchInOut">Go</button>
        <button class="btn-go" id="btnClearInOut">Clear</button>
            <button onclick="goBack()" class="btn-go">Back</button>
        </div>
    </div>

    <!-- Loader -->
@*     <div id="grid-loader" class="d-flex justify-content-center align-items-center flex-column">
        <div class="spinner-border text-primary grid-logo-spinner" role="status"></div>
        <div class="grid-loading-text">Loading...</div>
    </div> *@

    <!-- Grid Container -->
    <div id="inoutGridContainer" style="display:none" class="mt-4"></div>


    <script>

            const savedCompany = localStorage.getItem('selectedCompany');
           var companyDetails = JSON.parse(savedCompany);
           const CompanyId=companyDetails.CompanyId;
           const EmployeeId=localStorage.getItem('EmployeeId');
           const Token=localStorage.getItem("authToken");



        $(document).ready(function () {
            let selectedBranchIds = [0];
            BindBranchDropdown();
            setDefaultDates();
            BindEmployeeDropdownByBranch(selectedBranchIds);
        });

        function goBack() {
            window.history.back();
        }

        function setDefaultDates() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            $('#startDate').val(todayStr);
            $('#endDate').val(todayStr);
        }

    function BindBranchDropdown() {
        $.ajax({
                    url: '@baseUrl/BranchAPI/GetAllBranchesListByCompanyId/'+CompanyId,
                method: 'GET',
                    headers: {
                            'Authorization': 'Bearer ' + Token
                        },
            success: function (response) {
                if (response?.data?.length > 0) {
                    $("#branchDropdown").dxTagBox({
                        items: response.data,
                        displayExpr: "branchName",
                        valueExpr: "branchId",
                        placeholder: "--Select Branch--",
                        showSelectionControls: true,
                        searchEnabled: true,
                        showClearButton: true,
                        maxDisplayedTags: 3,
                        applyValueMode: "instantly",
                        multiline: false,
                        minSearchLength: 0,
                        width: "100%",
                        onOpened: function () {
                            $(".dx-overlay-content").css("max-width", "150px");
                        },
                        onValueChanged: function (e) {
                                 let selectedBranchIds = e.value.length > 0 ? e.value : [0];
                            BindEmployeeDropdownByBranch(selectedBranchIds);
                        }
                    });
                }
            }
        });
    }

           async function showLoder() {
              $('#grid-loader').addClass('d-flex').show();
          }

          async function hideLoder() {
              $('#grid-loader').removeClass('d-flex').hide();
          }



    function BindEmployeeDropdownByBranch(selectedBranchIds) {
        const branchParam = (selectedBranchIds?.length > 0) ? selectedBranchIds.join(",") : "0";

        $.ajax({
            type: "GET",
                url: '@(baseDomainUrl + "/api/EmployeeMasterAPI/GetAllEmployeeByBranchId")?BranchIds=' + branchParam+'&CompanyId='+CompanyId,
            success: function (response) {
                const $empDropdown = $("#employeeDropdown");

                if (response?.data?.length > 0) {
                    const employeeData = response.data.map(emp => ({
                        employeeCode: emp.employeeCode,
                        displayName: `${emp.fullName} - ${emp.employeeCode}`
                    }));

                    $empDropdown.dxTagBox({
                        items: employeeData,
                        displayExpr: "displayName",
                        valueExpr: "employeeCode",
                        placeholder: "--Select Employee--",
                        showSelectionControls: true,
                        searchEnabled: true,
                        showClearButton: true,
                        maxDisplayedTags: 3,
                        applyValueMode: "instantly",
                        multiline: false,
                        minSearchLength: 0,
                        width: "300%",
                        onOpened: function () {
                            $(".dx-overlay-content").css("max-width", "300px");
                        }
                    });

                } else {
                    $empDropdown.dxTagBox({
                        items: [],
                        placeholder: "No Employees Found",
                        searchEnabled: false,
                        showClearButton: true,
                        width: "100%"
                    });
                }
            }
        });
    }



    $('#btnFetchInOut').on('click', function () {
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();

        if (!startDate) {
            Swal.fire("Please select Start Date");
            return;
        }
        if (!endDate) {
            Swal.fire("Please select End Date");
            return;
        }

        const branchIds = $("#branchDropdown").dxTagBox("instance").option("value");
        const employeeIds = $("#employeeDropdown").dxTagBox("instance").option("value");

        if (branchIds.length <= 0) {
            Swal.fire("Please select Branch");
            return;
        }
        if (!employeeIds || employeeIds.length <= 0) {
            Swal.fire("Please select at least one Employee");
            return;
        }

        const empCodes = employeeIds.join(",");

        console.log(`Start Date: ${startDate}, End Date: ${endDate}`);
        console.log(`Branch IDs: ${branchIds.join(",")}`);
        console.log(`Employee Codes: ${empCodes}`);

        showLoder();

        const requestData = {
            StartDate: startDate,
            EndDate: endDate,
            BranchId: branchIds.join(","),
            EmployeeCodes: empCodes,
            CompanyId:CompanyId
        };

        console.log('requestData' ,requestData);

        $.ajax({
            url: '@baseDomainUrl/api/EmployeeInOut/GetEmpInOutReportForAdmin',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                console.log('response', response);
                hideLoder();
                if (response.isSuccess) {
                    RenderInOutGrid(response.data);
                    $('#startDate').prop('disabled', true);
                    $('#endDate').prop('disabled', true);
                    $("#branchDropdown").dxTagBox("instance").option("disabled", true);
                    $("#employeeDropdown").dxTagBox("instance").option("disabled", true);
                } else {
                    Swal.fire(response.ResponseMessage || "Error fetching data");
                }
            },
            error: function(xhr, status, error) {
                hideLoder();
                Swal.fire("Error occurred while fetching data");
                console.error(error);
            }
        });
    });


      function RenderInOutGrid(data) {
        console.log('Grid data:', data); // Add this to debug

        $("#inoutGridContainer").dxDataGrid({
            dataSource: data,
            keyExpr: "employeeId",
            showBorders: true,
            columnAutoWidth: true,
            height: 350,
            paging: {
                enabled: false
            },
            scrolling: {
                mode: "standard"
            },
            searchPanel: { visible: false },
            columns: [
                {
                    dataField: "employeeCode",
                    caption: "Code",
                    width: 100
                },
                {
                    dataField: "fullName",
                    caption: "Name",
                    width: 200
                },
                {
                    dataField: "shiftDate",
                    caption: "Date",
                    width: 120,
                    dataType: "date",
                    format: "dd/MM/yyyy"
                },
                {
                    dataField: "inTime",
                    caption: "In Time",
                    width: 100
                },
                {
                    dataField: "outTime",
                    caption: "Out Time",
                    width: 100
                },
                {
                    dataField: "workingHours",
                    caption: "Total Hours",
                    width: 120
                },
                {
                    dataField: "attendanceStatus",
                    caption: "Status",
                    width: 100,
                    cellTemplate: function(container, options) {
                        // Clean up the status text (remove extra spaces)
                        const status = options.value ? options.value.trim() : '';
                        container.text(status);
                    }
                },
                {
                    dataField: "designationName",
                    caption: "Designation",
                    width: 150
                },
                {
                    dataField: "branchName",
                    caption: "Branch",
                    width: 120
                }
            ]
        });

        $("#inoutGridContainer").show();
    }


       function clearAllData() {
        // Enable all disabled fields
        $('#startDate').prop('disabled', false);
        $('#endDate').prop('disabled', false);

        // Reset dates to today
        setDefaultDates();

        // Clear and enable branch dropdown
        try {
            const branchDropdown = $("#branchDropdown").dxTagBox("instance");
            if (branchDropdown) {
                branchDropdown.option("value", []);
                branchDropdown.option("disabled", false);
            }
        } catch (error) {
            console.error("Branch dropdown clear error:", error);
        }

        // Clear and enable employee dropdown
        try {
            const employeeDropdown = $("#employeeDropdown").dxTagBox("instance");
            if (employeeDropdown) {
                employeeDropdown.option("value", []);
                employeeDropdown.option("disabled", false);
            }
        } catch (error) {
            console.error("Employee dropdown clear error:", error);
        }

        // Hide and clear grid
        $("#inoutGridContainer").hide();
        try {
            const grid = $("#inoutGridContainer").dxDataGrid("instance");
            if (grid) {
                grid.clearSelection();
                grid.option("dataSource", []);
            }
        } catch (error) {
            console.error("Grid clear error:", error);
        }

        // Reset employee dropdown to show all employees for branch 0
        let selectedBranchIds = [0];
        BindEmployeeDropdownByBranch(selectedBranchIds);

    }
    $('#btnClearInOut').on('click', function () {
        clearAllData();
    });
    </script>

@inject IConfiguration Configuration
@{
	ViewData["Title"] = "Ticket Status";
	Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
	string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
	string UIBaseUrlLayout = Configuration["UIBaseUrlSettings:baseUrl"];
	var uriAPI = new Uri(baseUrl);
	string baseAPIDomainUrl = $"{uriAPI.Scheme}://{uriAPI.Host}:{uriAPI.Port}";
}
<style>
  .error-message {
        font-size: 0.875em;
        display: block;
        margin-top: 0.25rem;
    }
    .is-invalid {
        border-color: #dc3545 !important;
    }
   

    .dx-selectbox-arrow {
        display: block !important;
        opacity: 1 !important;
    }

      
</style>

<div class="card ">
	<div class="card-header bg-transparent ml-0 py-0">
		<div class="row">
			<div class="col-6">
				<h6 class="pt-2 mb-0">
					Manpower Details
				</h6>
			</div>

			<div class="col-6 d-flex justify-content-end align-items-center">
				<div class="font-22 pl-2" style="color:#32393f; cursor:pointer;">

					<button id="addManpower"
							type="button"
							class="btn mr-1 rounded-1"
							style="background-color:#2395c6; color:white;">
						Add Manpower
					</button>

				</div>
			</div>
		</div>
	</div>


	<div class="card-body">
		<div class="row">
			<div class="col-md-12">

				<div class="grid-wrapper " style="position: relative; " id="gridTag">
					<div id="grid-loader" class="grid-loader justify-content-center align-items-center flex-column "
						 style="display: none;  inset: 0; background: rgba(255,255,255,0.6); z-index: 10; ">
						<img src="@baseAPIDomainUrl/loders/loder.png" class="grid-logo-spinner" style="width: 30px; height: 30px; animation: spin 1s linear infinite;" />
						<div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>

					</div>
					<div class="rowCount" id="rowCount2"></div>
					<div id="GridContainer"></div>
				</div>
				<div id="divNoRecord" class="text-center text-muted" style="display:none;">No Record Found!</div>

			</div>
		</div>
	</div>
</div>


<div class="modal fade" id="addManpowerModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title btn-heading-title" id="exampleModalLabel"><span class="formType">Add</span> Manpower Requisition</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body-font">
                <!-- First Row -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <select class="form-select floating-input" id="ddlDepartment">
                                <option value="">Select</option>
                            </select>
                            <label class="floating-label">Department<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorDepartment"></span>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <select class="form-select floating-input" id="ddlRequirementType">
                                <option selected disabled value="">Select</option>
                                <option value="1">New Position</option>
                                <option value="2">Replacement</option>
                            </select>
                            <label class="floating-label">Requirement Type<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorRequirementType"></span>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <input type="text" class="form-control floating-input" data-trim-input id="txtEmployeeName" placeholder="Name of Employee" />
                            <label class="floating-label">Name of Employee<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorEmployeeName"></span>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <input type="email" class="form-control floating-input" data-trim-input placeholder="Personal Email Id" id="txtPersonalEmail" />
                            <label class="floating-label">Personal Email Id<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorPersonalEmail"></span>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <input type="text" class="form-control floating-input" data-integer-only placeholder="Personal Contact Number" id="txtContactNumber" />
                            <label class="floating-label">Personal Contact Number<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorContactNumber"></span>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <input type="text" class="form-control floating-input" data-trim-input placeholder="Closure by Branch/HR/Reference/Recommendation" id="txtClosureBy" />
                            <label class="floating-label">Closure by Branch/HR/Reference/Recommendation<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorClosureBy"></span>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <select class="form-select floating-input" id="ddlDesignation">
                                <option value="">Select</option>
                            </select>
                            <label class="floating-label">Designation<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorDesignation"></span>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <input type="text" class="form-control floating-input" data-trim-input id="txtExperienceRange" placeholder="Experience Range" />
                            <label class="floating-label">Experience Range<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorExperienceRange"></span>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <select class="form-select floating-input" id="ddlEducationalQualification">
                                <option selected disabled value="">Select</option>
                                <option value="1">Post Graduate</option>
                                <option value="2">Graduate</option>
                                <option value="3">10th Passed</option>
                                <option value="4">12th Passed</option>
                                <option value="5">Below 10th</option>
                                <option value="6">Diploma</option>
                            </select>
                            <label class="floating-label">Educational Qualification<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorEducationalQualification"></span>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <input type="text" class="form-control floating-input" data-trim-input id="txtComputerSkills" placeholder="Specific Computer Skills/Technology" />
                            <label class="floating-label">Specific Computer Skills/Technology<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorComputerSkills"></span>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <textarea class="form-control floating-input" id="txtJobResponsibility" placeholder="Job Responsibility (in Brief)"></textarea>
                            <label class="floating-label">Job Responsibility (in Brief)<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorJobResponsibility"></span>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <input type="text" class="form-control floating-input" id="txtAge" placeholder="Age" />
                            <label class="floating-label">Age<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorAge"></span>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group mt-3">
                            <label><b>Gender<span class="text-danger">*</span>:&nbsp;&nbsp;</b></label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="gender" id="maleGender" value="Male">
                                <label class="form-check-label" for="maleGender">Male</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="gender" id="femaleGender" value="Female">
                                <label class="form-check-label" for="femaleGender">Female</label>
                            </div>
                        </div>
                        <span class="text-danger error-message" id="errorGender"></span>

                    </div>
                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <div id="otherBenefitsSelectBox"></div>
                        </div>
                        <span class="text-danger error-message" id="errorOtherBenfit"></span>
                    </div>

                    <div class="col-md-3">
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="chkSystemRequire">
                            <label class="form-check-label">System Require</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="chkEmailIdRequire">
                            <label class="form-check-label">Email Id Require</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="chkSIMRequire">
                            <label class="form-check-label">SIM Require</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="chkMobileHandsetRequire" placeholder="Mobile Handset Require">
                            <label class="form-check-label">Mobile Handset Require</label>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <select class="form-select floating-input" id="ddlReportingTo">
                                <option selected value="">Select</option>
                            </select>
                            <label class="floating-label">Reporting To<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorReportingTo"></span>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <input type="date" class="form-control floating-input" id="txtDateOfJoining" />
                            <label class="floating-label">Date of Joining<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorDateOfJoining"></span>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <select class="form-select floating-input" id="ddlCategoryOfEmployment">
                                <option value="">Select</option>
                                <option >On Roll</option>
                                <option >Off Roll</option>
                            </select>
                            <label class="floating-label">Category of Employment<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorCategoryOfEmployment"></span>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mt-3 position-relative">
                            <input type="text" class="form-control floating-input" data-decimal id="txtTakeHomeSalary" placeholder="Take Home Salary" />
                            <label class="floating-label">Take Home Salary<span class="text-danger">*</span></label>
                        </div>
                        <span class="text-danger error-message" id="errorTakeHomeSalary"></span>

                    </div>
                </div>
            </div>
            <div class="modal-footer btn-heading-title">
                <button type="button" class="btn btn-primary" id="btnSubmitManpower" style="background-color:#2395c6; color:white;">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script src="~/assets/js/jquery.min.js"></script>
<script>
			const EmployeeId = localStorage.getItem("EmployeeId");
			  var Token=localStorage.getItem("authToken");
                var companyDetails = JSON.parse(localStorage.getItem('selectedCompany'));
            const CompanyId=companyDetails.CompanyId;
            let manpowerRequisitionId=0;
		$("#addManpower").click( () => 
        {
              resetFormAndValidation();
		  $("#addManpowerModal").modal('show');

		})


		function showStatusNoRecord()
		{
		   $("#divNoRecord").show();
			$("#gridTag").hide();
		}

		function hideStatusNoRecord()
		{
		   $("#divNoRecord").hide();
			$("#gridTag").show();
		}



        $(document).ready(function(){
                manpowerDataTable();
                loadDropDownForManpower();

        });

	function manpowerDataTable() {
		 try {
			$('#grid-loader').addClass('d-flex').show();
			 $.ajax({
				type: "GET",
                 url: '@baseUrl/ManpowerRequisitionAPI/GetAllManpowerRequisitions/' + CompanyId,
				headers: {
						'Authorization': 'Bearer ' + Token
					},
				 success: function (data) {
					

                     console.log(data);
						$("#GridContainer").dxDataGrid({
							dataSource: data.data||[],  

							columns: [
                                    // {
                                    //   dataField: 'serialNo',
                                    //   caption: 'Serial No',
                                    //   width: 150,
                                    //   cellTemplate: function (container, options) {
                                    //     const link = $('<a>')
                                    //       .attr('href', '#')
                                    //       .text(options.value)
                                    //       .on('click', function (e) {
                                    //         e.preventDefault();
                                    //         openPrintWindow(options.data); 
                                    //       });
                                    //     container.append(link);
                                    //   }
                                    // },

                                {
                                    dataField: 'departmentName',
                                    caption: 'Department',
                                    width: 150
                                },
                                {
                                    dataField: 'designationName',
                                    caption: 'Designation',
                                    width: 150
                                },
                                {
                                    dataField: 'requirementType',
                                    caption: 'Requirement Type',
                                    width: 130
                                },
                                {
                                    dataField: 'employeeName',
                                    caption: 'Employee Name',
                                    width: 150
                                },
                                {
                                    dataField: 'personalEmail',
                                    caption: 'Personal Email',
                                    width: 180
                                },
                                {
                                    dataField: 'contactNumber',
                                    caption: 'Contact Number',
                                    width: 120
                                },
                                {
                                    dataField: 'closureBy',
                                    caption: 'Closure By',
                                    width: 100
                                },
                                {
                                    dataField: 'experienceRange',
                                    caption: 'Experience (Years)',
                                    width: 120
                                },
                                {
                                    dataField: 'educationalQualification',
                                    caption: 'Education',
                                    width: 150
                                },
                                {
                                    dataField: 'computerSkills',
                                    caption: 'Computer Skills',
                                    width: 150
                                },
                                {
                                    dataField: 'jobResponsibility',
                                    caption: 'Job Responsibility',
                                    width: 200
                                },
                                {
                                    dataField: 'age',
                                    caption: 'Age',
                                    width: 60,
                                    alignment: 'center'
                                },
                                {
                                    dataField: 'gender',
                                    caption: 'Gender',
                                    width: 80
                                },
                                {
                                    dataField: 'otherBenefits',
                                    caption: 'Other Benefits',
                                    width: 180
                                },
                                {
                                    dataField: 'systemRequire',
                                    caption: 'System Required',
                                    width: 120
                                },
                                {
                                    dataField: 'emailIdRequire',
                                    caption: 'Email ID Required',
                                    width: 130
                                },
                                {
                                    dataField: 'simRequire',
                                    caption: 'SIM Required',
                                    width: 110
                                },
                                {
                                    dataField: 'mobileHandsetRequire',
                                    caption: 'Mobile Handset Required',
                                    width: 150
                                },
                                {
                                    dataField: 'reportingName',
                                    caption: 'Reporting To',
                                    width: 200
                                },
                                {
                                    dataField: 'reportingCode',
                                    caption: 'Reporting Code',
                                    width: 100
                                },
                                {
                                    dataField: 'dateOfJoining',
                                    caption: 'Date of Joining',
                                    width: 120,
                                    dataType: 'date',
                                    format: 'dd-MM-yyyy'
                                },
                                {
                                    dataField: 'categoryOfEmployment',
                                    caption: 'Employment Category',
                                    width: 150
                                },
                                {
                                    dataField: 'ctC_Monthly',
                                    caption: 'CTC (Monthly)',
                                    width: 120,
                                    dataType: 'number',
                                    format: {
                                        type: 'fixedPoint',
                                        precision: 2
                                    }
                                },
                                {
                                    dataField: 'grossSalary',
                                    caption: 'Gross Salary',
                                    width: 120,
                                    dataType: 'number',
                                    format: {
                                        type: 'fixedPoint',
                                        precision: 2
                                    }
                                },
                                {
                                    dataField: 'takeHomeSalary',
                                    caption: 'Take Home Salary',
                                    width: 130,
                                    dataType: 'number',
                                    format: {
                                        type: 'fixedPoint',
                                        precision: 2
                                    }
                                },
                                {
                                    dataField: 'createdDate',
                                    caption: 'Created Date',
                                    width: 120,
                                    dataType: 'datetime',
                                    format: 'dd-MM-yyyy'
                                },
                                {
                                    dataField: 'requestedBy',
                                    caption: 'Requested By',
                                    width: 150
                                },
                                {
                                   dataField: 'hR_Approved',
                                    caption: 'HR Approved',
                                    width: 150
                                },
                                 
                                {
                                        dataField: 'nM_Approved',
                                    caption: 'NM Approved',
                                    width: 150
                                },
                                {
                                        dataField: 'rM_Approved',
                                    caption: 'RM Approved',
                                    width: 150
                                },
                                {
                                    dataField: '',
                                    caption: 'Edit',
                                    alignment: 'center',
                                    dataType: 'string',
                                    type: 'buttons',
                                    width: 60,
                                    cellTemplate: function(container, options) {
                                        $('<div class="d-flex order-actions">')
                                            .append('<a href="javascript:;" class="edit-action" title="Update">'+
                                                '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">'+
                                                '<path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456l-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>'+
                                                '<path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11zm1.5-1a.5.5 0 0 0 .5.5v2a.5.5 0 0 0 .5.5h2a.5.5 0 0 0 .5-.5v-2l6.97-6.97a.5.5 0 0 0-.316-.316l-6.97 6.97H1.5z"/>'+
                                                '</svg>'+
                                                '</a>')
                                            .on('dxclick', function() {
                                                    updateManpower(options.data);
                                            })
                                            .appendTo(container);
                                    }
                                },
                                {
                                    dataField: '',
                                    caption: 'Delete',
                                    alignment: 'center',
                                    dataType: 'string',
                                    type: 'buttons',
                                    width: 60,
                                    cellTemplate: function(container, options) {
                                        $('<div class="d-flex order-actions">')
                                            .append('<a href="javascript:;" class="delete-action" title="Delete">'+
                                                '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">'+
                                                '<path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/>'+
                                                '</svg>'+
                                                '</a>')
                                            .on('dxclick', function() {
                                                    deleteManpower(options.data);
                                            })
                                            .appendTo(container);
                                    }
                                }
                            ],

							columnsAutoWidth: true,
							wordWrapEnabled: false,
							rowAlternationEnabled: false,
							showBorders: true,
							grouping: { autoExpandAll: true },
							paging: { pageSize: 10 },
							pager: { showPageSizeSelector: true, allowedPageSizes: [10, 25, 50, 100] },
							headerFilter: { visible: false },
							filterRow: { visible: true, applyFilter: "auto" },
							allowColumnResizing: true,
							groupPanel: { visible: true },
							searchPanel: { visible: true, width: 240, placeholder: "Search..." },
							allowColumnReordering: true,
							columnFixing: { enabled: false },
                                 scrolling: {
                                mode: "standard",
                                useNative: true,
                                showScrollbar: "always"
                            },
							onContentReady(e) {
								   $('#rowCount1').html('Total Records: ' + $("#GridContainer").dxDataGrid('instance').totalCount());
							}
						}).dxDataGrid('instance');
					
						  $('#grid-loader').removeClass('d-flex').hide();

				},
				error: function (xhr, status, error) {
					  $('#grid-loader').removeClass('d-flex').hide();

					// Handle any errors that occurred during the AJAX request
					console.error("AJAX Error: " + status + " - " + error);

				}
			});

		  } catch (e)
		  {
			   console.error("Error in TicketPriorityDataTable:", e);
			   $('#grid-loader').removeClass('d-flex').hide();
		  }
	}

        var otherBenefit = [
        "Not Applicable",
        "Convenience",
        "Petrol Allowance"
    ];

     $(function() {
        $("#otherBenefitsSelectBox").dxTagBox({ 
            placeholder: "None selected",
            dataSource: otherBenefit || [],
            showClearButton: true,
             placeholder:"Other Benefits",
            searchEnabled: true,
            showSelectionControls: true, 
            maxDisplayedTags: 3, 
            value: [],
            onValueChanged: function(e) {
                console.log("Selected values:", e.value);
            }
        });
    });
   
         async function loadDropDownForManpower(){
           $.ajax({
                    url: '@baseUrl/ManpowerRequisitionAPI/GetDropDownForManpower/'+CompanyId,
                    method: 'GET',
                    success: function(response) {
                        debugger;
                            if (response.isSuccess)
                            {
                              
                                bindDesignation(response.data.designations);
                                bindReporting(response.data.reportingEmployees);
                                bindDepartment(response.data.departments);
                                
                            }
                            else{
                                round_error_noti(data.responseMessage);
                              
                            }
                                   
                    },
                    error: function(error) {
                        console.error('Error fetching  data:', error);
                    }
                });

        }

    async  function bindDepartment(data)
    {
            var dropdown = $('#ddlDepartment');
        dropdown.empty();
        dropdown.append('<option disabled selected value="">Select </option>');
        $.each(data, function(index, company) {
                dropdown.append($('<option>', {
                                value: company.departmentId,
                                text: company.departmentName
                }));
        });
    }

     function bindDesignation(data)
     {
        var dropdown = $('#ddlDesignation');
        dropdown.empty();
        dropdown.append('<option disabled selected value="">Select Designation</option>');
        $.each(data, function(index, company) {
            dropdown.append($('<option>', {
                value: company.designationId,
                text: company.designationName
            }));
        });
     }


    async function bindReporting(data)
    {
            var dropdown = $('#ddlReportingTo');
            dropdown.empty();
            dropdown.append('<option disabled selected value="">Select</option>');
            $.each(data, function(index, company) {
                dropdown.append($('<option>', {
                    value: company.employeeId,
                    text: company.fullName+" - "+company.employeeCode
                }));
            });
    }

$('#btnSubmitManpower').click( async function() {
    //$('#btnSubmitManpower').prop('disabled', true)
        debugger;
           var validate= await  validateForm();
            if (!validate)
            {
                
                return;
            }
        const formData = await  collectFormData();

		console.log(formData);
		debugger;
    $.ajax({
         url: manpowerRequisitionId==0?'@baseUrl/ManpowerRequisitionAPI/CreateManpowerRequisition':'@baseUrl/ManpowerRequisitionAPI/UpdateManpowerRequisition',
        type: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem("authToken")
        },
        success: function(response) {
            if(response.isSuccess)
            {
                round_success_noti(response.responseMessage);
                    manpowerDataTable();
            }
            else
            {
                round_error_noti(response.responseMessage);
            }
        },
        error: function(xhr, status, error) {
                round_error_noti("Some thing went wrong!");
        }
    });
});


function getValueOrNull(value) {
        return value === "" || value === undefined || value === null ? null : value;
    }

    // Validation function
    async function validateForm() 
    {
        let isValid = true;

        // Reset all error messages and invalid states
        $('.error-message').text('');
        $('.form-control, .form-select').removeClass('is-invalid');

        // Department validation
        if (!$('#ddlDepartment').val()) {
            $('#errorDepartment').text('Department is required');
            $('#ddlDepartment').addClass('is-invalid');
            isValid = false;
        }

        // Requirement Type validation
        if (!$('#ddlRequirementType').val()) {
            $('#errorRequirementType').text('Requirement Type is required');
            $('#ddlRequirementType').addClass('is-invalid');
            isValid = false;
        }

        // Employee Name validation
        if (!$('#txtEmployeeName').val()) {
            $('#errorEmployeeName').text('Employee Name is required');
            $('#txtEmployeeName').addClass('is-invalid');
            isValid = false;
        }

        // Personal Email validation
        const email = $('#txtPersonalEmail').val();
        if (!email) {
            $('#errorPersonalEmail').text('Personal Email is required');
            $('#txtPersonalEmail').addClass('is-invalid');
            isValid = false;
        } 
        // Contact Number validation
        if (!$('#txtContactNumber').val()) {
            $('#errorContactNumber').text('Contact Number is required');
            $('#txtContactNumber').addClass('is-invalid');
            isValid = false;
        }

        // Closure By validation
        if (!$('#txtClosureBy').val()) {
            $('#errorClosureBy').text('Closure By is required');
            $('#txtClosureBy').addClass('is-invalid');
            isValid = false;
        }

        // Designation validation
        if (!$('#ddlDesignation').val()) {
            $('#errorDesignation').text('Designation is required');
            $('#ddlDesignation').addClass('is-invalid');
            isValid = false;
        }

        // Experience Range validation
        if (!$('#txtExperienceRange').val()) {
            $('#errorExperienceRange').text('Experience Range is required');
            $('#txtExperienceRange').addClass('is-invalid');
            isValid = false;
        }

        // Educational Qualification validation
        if (!$('#ddlEducationalQualification').val()) {
            $('#errorEducationalQualification').text('Educational Qualification is required');
            $('#ddlEducationalQualification').addClass('is-invalid');
            isValid = false;
        }

        // Computer Skills validation
        if (!$('#txtComputerSkills').val()) {
            $('#errorComputerSkills').text('Computer Skills are required');
            $('#txtComputerSkills').addClass('is-invalid');
            isValid = false;
        }

        // Job Responsibility validation
        if (!$('#txtJobResponsibility').val()) {
            $('#errorJobResponsibility').text('Job Responsibility is required');
            $('#txtJobResponsibility').addClass('is-invalid');
            isValid = false;
        }

        // Age validation
        const age = $('#txtAge').val();
        if (!age) {
            $('#errorAge').text('Age is required');
            $('#txtAge').addClass('is-invalid');
            isValid = false;
        } else if (age && (isNaN(age) || parseInt(age) < 18 || parseInt(age) > 100)) {
            $('#errorAge').text('Please enter a valid age (18-100)');
            $('#txtAge').addClass('is-invalid');
            isValid = false;
        }

        // Gender validation
        if (!$('input[name="gender"]:checked').length) {
            $('#errorGender').text('Gender is required');
            isValid = false;
        }

              var selectedValues = $("#otherBenefitsSelectBox").dxTagBox("option", "value");
            var selectedValuesString = selectedValues && selectedValues.length > 0 ? selectedValues.join(", ") : null;

        // Reporting To validation
          if (!selectedValuesString) {
                $('#errorOtherBenfit').text('Other benfit  is required');
                $('#otherBenefitsSelectBox').addClass('is-invalid');
            isValid = false;
        }
        // Reporting To validation
        if (!$('#ddlReportingTo').val()) {
            $('#errorReportingTo').text('Reporting To is required');
            $('#ddlReportingTo').addClass('is-invalid');
            isValid = false;
        }

        // Date of Joining validation
        if (!$('#txtDateOfJoining').val()) {
            $('#errorDateOfJoining').text('Date of Joining is required');
            $('#txtDateOfJoining').addClass('is-invalid');
            isValid = false;
        }

        // Category of Employment validation
        if (!$('#ddlCategoryOfEmployment').val()) {
            $('#errorCategoryOfEmployment').text('Category of Employment is required');
            $('#ddlCategoryOfEmployment').addClass('is-invalid');
            isValid = false;
        }

        // Take Home Salary validation
        if (!$('#txtTakeHomeSalary').val()) {
            $('#errorTakeHomeSalary').text('Take Home Salary is required');
            $('#txtTakeHomeSalary').addClass('is-invalid');
            isValid = false;
        }

        return isValid;
    }

    // Collect form data function
      async function collectFormData(manpowerRequisitionId) {
        var selectedValues = $("#otherBenefitsSelectBox").dxTagBox("option", "value");
        var selectedValuesString = selectedValues && selectedValues.length > 0 ? selectedValues.join(", ") : "";

        return {
            ManpowerRequisitionId: manpowerRequisitionId,
            DepartmentId: getValueOrNull($('#ddlDepartment').val()),
            RequirementType: getValueOrNull($('#ddlRequirementType').val()),
            EmployeeName: getValueOrNull($('#txtEmployeeName').val()),
            PersonalEmail: getValueOrNull($('#txtPersonalEmail').val()),
            ContactNumber: getValueOrNull($('#txtContactNumber').val()),
            ClosureBy: getValueOrNull($('#txtClosureBy').val()),
            DesignationId: getValueOrNull($('#ddlDesignation').val()),
            ExperienceRange: getValueOrNull($('#txtExperienceRange').val()),
            EducationalQualification: getValueOrNull($('#ddlEducationalQualification').val()),
            ComputerSkills: getValueOrNull($('#txtComputerSkills').val()),
            JobResponsibility: getValueOrNull($('#txtJobResponsibility').val()),
            Age: $('#txtAge').val() ? parseInt($('#txtAge').val()) : null, // Ensure it's an integer
            Gender: getValueOrNull($('input[name="gender"]:checked').val()),
            OtherBenefits: selectedValuesString,
            SystemRequire: $('#chkSystemRequire').is(':checked') ? "Yes" : "No",
            EmailIdRequire: $('#chkEmailIdRequire').is(':checked') ? "Yes" : "No",
            SIMRequire: $('#chkSIMRequire').is(':checked') ? "Yes" : "No",
            MobileHandsetRequire: $('#chkMobileHandsetRequire').is(':checked') ? "Yes" : "No",
            ReportingToId: getValueOrNull($('#ddlReportingTo').val()),
            DateOfJoining: $('#txtDateOfJoining').val() ? new Date($('#txtDateOfJoining').val()).toISOString() : null, // ISO format
            CategoryOfEmployment: getValueOrNull($('#ddlCategoryOfEmployment').val()),
            CTC_Monthly: $('#txtCTC_Monthly').val() ? parseFloat($('#txtCTC_Monthly').val()) : null, // Convert to decimal
            GrossSalary: $('#txtGrossSalary').val() ? parseFloat($('#txtGrossSalary').val()) : null, // Convert to decimal
            TakeHomeSalary: $('#txtTakeHomeSalary').val() ? parseFloat($('#txtTakeHomeSalary').val()) : null, // Convert to decimal
          
            CreatedBy: EmployeeId,
            UpdatedBy: EmployeeId,
            CompanyId: CompanyId // Ensure this is an integer (not DateTime)
        };
    }

    // Clear validation errors when user interacts with fields
    $('.form-control, .form-select').on('input change', function() {
        $(this).removeClass('is-invalid');
        const errorId = 'error' + this.id.charAt(0).toUpperCase() + this.id.slice(1);
        $('#' + errorId).text('');
    });

    // Special handling for radio buttons
    $('input[name="gender"]').change(function() {
        $('#errorGender').text('');
    });

    // Special handling for checkboxes
    $('input[type="checkbox"]').change(function() {
        // Checkboxes don't have error messages in this form
    });

     async function updateManpower(data) {
            await  resetFormAndValidation();
        // Set dropdown values
        $('#ddlDepartment').val(data.departmentId);
        $('#ddlRequirementType').val(data.requirementType);
        $('#ddlDesignation').val(data.designationId);
        $('#ddlEducationalQualification').val(data.educationalQualification);
        $('#ddlCategoryOfEmployment').val(data.categoryOfEmployment);
        $('#ddlReportingTo').val(data.reportingToId);

        // Set text inputs
        $('#txtEmployeeName').val(data.employeeName);
        $('#txtPersonalEmail').val(data.personalEmail);
        $('#txtContactNumber').val(data.contactNumber);
        $('#txtClosureBy').val(data.closureBy);
        $('#txtExperienceRange').val(data.experienceRange);
        $('#txtComputerSkills').val(data.computerSkills);
        $('#txtJobResponsibility').val(data.jobResponsibility);
        $('#txtAge').val(data.age);
        $('#txtTakeHomeSalary').val(data.takeHomeSalary);

        // Set gender radio button
        if (data.gender) {
            $(`input[name="gender"][value="${data.gender}"]`).prop('checked', true);
        }

        // Set date fields
        if (data.dateOfJoining) {
               $('#txtDateOfJoining').val(data.dateOfJoining.split('T')[0]||"");
        }

        // Set checkboxes based on string values
         $('#chkSystemRequire').prop('checked', data.systemRequire === "Yes");
        $('#chkEmailIdRequire').prop('checked', data.emailIdRequire === "Yes");
        $('#chkSIMRequire').prop('checked', data.simRequire === "Yes");
        $('#chkMobileHandsetRequire').prop('checked', data.mobileHandsetRequire === "Yes");

        // Set OtherBenefits (assuming it's a dxTagBox or similar)
        if (data.otherBenefits) {
            const benefitsArray = data.otherBenefits.split(',').map(item => item.trim());
            $('#otherBenefitsSelectBox').dxTagBox('instance').option('value', benefitsArray);
        }
            manpowerRequisitionId=data.manpowerRequisitionId;
           $("#btnSubmitManpower").text("Update");
               $("#formType").text("Update");
               $("#addManpowerModal").modal('show');
    }

     function resetFormAndValidation() {
             manpowerRequisitionId=0;
        // Clear all error messages
        $('.error-message').text('');
        $('input[name="gender"]').closest('.form-check').removeClass('is-invalid');

        // Remove invalid classes from all form controls
        $('.form-control, .form-select, .dx-texteditor, .dx-selectbox, .dx-datebox').removeClass('is-invalid');

        // Reset dropdowns
        $('#ddlDepartment').val(null).trigger('change');
        $('#ddlRequirementType').val(null).trigger('change');
        $('#ddlDesignation').val(null).trigger('change');
        $('#ddlEducationalQualification').val(null).trigger('change');
        $('#ddlReportingTo').val(null).trigger('change');
        $('#ddlCategoryOfEmployment').val(null).trigger('change');

        // Reset text inputs
        $('#txtEmployeeName').val('');
        $('#txtPersonalEmail').val('');
        $('#txtContactNumber').val('');
        $('#txtClosureBy').val('');
        $('#txtExperienceRange').val('');
        $('#txtComputerSkills').val('');
        $('#txtJobResponsibility').val('');
        $('#txtAge').val('');
        $('#txtTakeHomeSalary').val('');
        $('#txtCTC_Monthly').val('');
        $('#txtGrossSalary').val('');

        // Reset radio buttons
        $('input[name="gender"]').prop('checked', false);

        // Reset checkboxes
        $('#chkSystemRequire').prop('checked', false);
        $('#chkEmailIdRequire').prop('checked', false);
        $('#chkSIMRequire').prop('checked', false);
        $('#chkMobileHandsetRequire').prop('checked', false);

        // Reset DevExtreme components
        if ($('#otherBenefitsSelectBox').data('dxTagBox')) {
            $('#otherBenefitsSelectBox').dxTagBox('instance').reset();
        }

        if ($('#txtDateOfJoining').data('dxDateBox')) {
            $('#txtDateOfJoining').dxDateBox('instance').reset();
        }

        // Reset read-only display fields
        $('#lblSerialNo').text('');
        $('#lblDesignationName').text('');
        $('#lblDepartmentName').text('');
        $('#lblReportingName').text('');
        $('#lblReportingCode').text('');
        $('#lblCreatedDate').text('');

        // Reset hidden fields
        $('#hdnManpowerRequisitionId').val('');

        // Clear specific error messages
        $('#errorDepartment').text('');
        $('#errorRequirementType').text('');
        $('#errorEmployeeName').text('');
        $('#errorPersonalEmail').text('');
        $('#errorContactNumber').text('');
        $('#errorClosureBy').text('');
        $('#errorDesignation').text('');
        $('#errorExperienceRange').text('');
        $('#errorEducationalQualification').text('');
        $('#errorComputerSkills').text('');
        $('#errorJobResponsibility').text('');
        $('#errorAge').text('');
        $('#errorGender').text('');
        $('#errorReportingTo').text('');
        $('#errorDateOfJoining').text('');
        $('#errorCategoryOfEmployment').text('');
        $('#errorTakeHomeSalary').text('');
        $('#errorOtherBenefits').text('');
        $("#btnSubmitManpower").text("Save");
            $("#formType").text("Add");
    }

    function deleteManpower(data)
    {
        if (!confirm("Are you sure you want to delete this?"))
        {
            return; // Cancel the delete operation
        }

        var deleteObj = {
            id: data.manpowerRequisitionId,
            deletedBy: EmployeeId 
        };

        $.ajax({
            url: '@baseUrl/ManpowerRequisitionAPI/DeleteManpowerRequisition',
            type: 'DELETE',
            contentType: 'application/json',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            data: JSON.stringify(deleteObj),
            success: function (response) {
                if(response.isSuccess)
                {
                    round_success_noti(response.responseMessage);
                        manpowerDataTable();
                }
                else
                {
                    round_error_noti(response.responseMessage)
                }
                        
            },
            error: function (error) {
                    console.log(error);
            }
        });
    }



    //print

// Replace the openPrintWindow function with this updated version

// function openPrintWindow(data) {
//   const htmlContent = `
//     <!DOCTYPE html>
//     <html>
//     <head>
//       <title>Print Manpower Requisition Form</title>
//       <style>
//         body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
//         .container { max-width: 800px; margin: 0 auto; border: 1px solid #ccc; padding: 20px; }
//         .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
//         .logo { height: 80px; }
//         .title { text-align: center; font-weight: bold; font-size: 18px; }
//         table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
//         table, th, td { border: 1px solid #000; }
//         th, td { padding: 8px; text-align: left; }
//         th { background-color: #f2f2f2; }
//         .print-button { 
//           margin: 20px 0; 
//           padding: 10px 20px; 
//           background-color: #2395c6; 
//           color: white; 
//           border: none; 
//           cursor: pointer; 
//           font-size: 16px;
//           border-radius: 4px;
//         }
//         .print-button:hover { background-color: #1a7aa3; }
//         @@media print {
//           .print-button { display: none; }
//         }
//       </style>
//     </head>
//     <body>
//       <div class="container">
//         <button class="print-button" onclick="window.print()">Print</button>
        
//         <div class="header">
//           <img src="https://via.placeholder.com/200x80?text=RELAY+EXPRESS" alt="Relay Express Logo" class="logo">
//           <div>
//             <div class="title">Manpower Requisition Form</div>
//             <div>Sr. No.: <span id="serialNo"></span></div>
//             <div>Date: <span id="currentDate"></span></div>
//           </div>
//         </div>

//         <table>
//           <tr><th>Location</th><td id="location"></td><th>Department</th><td id="departmentName"></td></tr>
//           <tr><th>Requirement</th><td id="requirementType"></td><th>Name of Employee</th><td id="employeeName"></td></tr>
//           <tr><th>Personal Email</th><td id="personalEmail"></td><th>Contact No.</th><td id="contactNumber"></td></tr>
//           <tr><th>Closure By</th><td id="closureBy"></td><th>Designation</th><td id="designationName"></td></tr>
//           <tr><th>Experience Range</th><td id="experienceRange"></td><th>Minimum Qualification</th><td id="educationalQualification"></td></tr>
//           <tr><th>Computer Skills</th><td id="computerSkills"></td><th>Job Responsibility</th><td id="jobResponsibility"></td></tr>
//           <tr><th>Age</th><td id="age"></td><th>Gender</th><td id="gender"></td></tr>
//           <tr><th>Reporting To</th><td id="reportingName"></td><th>Date of Joining</th><td id="dateOfJoining"></td></tr>
//           <tr><th>Category of Employment</th><td id="categoryOfEmployment"></td><th>Take Home Salary</th><td id="takeHomeSalary"></td></tr>
//           <tr><th>Other Benefits</th><td id="otherBenefits"></td><th>System Require</th><td id="systemRequire"></td></tr>
//           <tr><th>Email ID Require</th><td id="emailIdRequire"></td><th>SIM Require</th><td id="simRequire"></td></tr>
//           <tr><th>Mobile Handset Require</th><td id="mobileHandsetRequire"></td></tr>
//         </table>
//       </div>

//       <script>
//         const data = ${JSON.stringify(data)};
        
//         // Helper function to format date
//         function formatDate(dateString) {
//           if (!dateString) return 'N/A';
//           const date = new Date(dateString);
//           return date.toLocaleDateString('en-GB'); // DD/MM/YYYY format
//         }

//         // Helper function to get educational qualification text
//         function getEducationalQualification(value) {
//           const qualifications = {
//             "1": "Post Graduate",
//             "2": "Graduate",
//             "3": "10th Passed",
//             "4": "12th Passed",
//             "5": "Below 10th",
//             "6": "Diploma"
//           };
//           return qualifications[value] || value;
//         }

//         // Populate the form
//         document.getElementById("currentDate").textContent = formatDate(new Date());
//         document.getElementById("serialNo").textContent = data.serialNo || 'N/A';
//         document.getElementById("location").textContent = data.location || 'N/A';
//         document.getElementById("departmentName").textContent = data.departmentName || 'N/A';
//         document.getElementById("requirementType").textContent = data.requirementType === "1" ? "New Position" : data.requirementType === "2" ? "Replacement" : data.requirementType || 'N/A';
//         document.getElementById("employeeName").textContent = data.employeeName || 'N/A';
//         document.getElementById("personalEmail").textContent = data.personalEmail || 'N/A';
//         document.getElementById("contactNumber").textContent = data.contactNumber || 'N/A';
//         document.getElementById("closureBy").textContent = data.closureBy || 'N/A';
//         document.getElementById("designationName").textContent = data.designationName || 'N/A';
//         document.getElementById("experienceRange").textContent = data.experienceRange || 'N/A';
//         document.getElementById("educationalQualification").textContent = getEducationalQualification(data.educationalQualification);
//         document.getElementById("computerSkills").textContent = data.computerSkills || 'N/A';
//         document.getElementById("jobResponsibility").textContent = data.jobResponsibility || 'N/A';
//         document.getElementById("age").textContent = data.age || 'N/A';
//         document.getElementById("gender").textContent = data.gender || 'N/A';
//         document.getElementById("reportingName").textContent = data.reportingName || 'N/A';
//         document.getElementById("dateOfJoining").textContent = formatDate(data.dateOfJoining);
//         document.getElementById("categoryOfEmployment").textContent = data.categoryOfEmployment || 'N/A';
//         document.getElementById("takeHomeSalary").textContent = data.takeHomeSalary ? '₹ ' + parseFloat(data.takeHomeSalary).toFixed(2) : 'N/A';
//         document.getElementById("otherBenefits").textContent = data.otherBenefits || 'N/A';
//         document.getElementById("systemRequire").textContent = (data.systemRequire === "Yes" || data.systemRequire === true) ? "Yes" : "No";
//         document.getElementById("emailIdRequire").textContent = (data.emailIdRequire === "Yes" || data.emailIdRequire === true) ? "Yes" : "No";
//         document.getElementById("simRequire").textContent = (data.simRequire === "Yes" || data.simRequire === true) ? "Yes" : "No";
//         document.getElementById("mobileHandsetRequire").textContent = (data.mobileHandsetRequire === "Yes" || data.mobileHandsetRequire === true) ? "Yes" : "No";
//       <\/script>
//     </body>
//     </html>
//   `;

//   // Open in new tab instead of new window
//   const printWindow = window.open('', '_blank');
//   if (printWindow) {
//     printWindow.document.write(htmlContent);
//     printWindow.document.close();
//     printWindow.focus();
//   } else {
//     alert('Please allow pop-ups for this site to view the print preview.');
//   }
// }

</script>
@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Attendance Lock";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];
}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .salary-box {
        background-color: white !important;
        border: 1px solid #ccc;
        padding: 12px;
        border-radius: 5px;
    }

    .salary-header {
        background-color: #3e4b6d;
        color: white;
        font-weight: bold;
        padding: 8px 15px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
    }

    .form-group-row {
        margin-bottom: 20px;
        gap: 15px;
    }

    .form-label {
        min-width: 100px;
        font-weight: 500;
        color: #495057;
        font-size: 14px;
        margin-bottom: 0;
    }

    .btn-go {
        padding: 5px 30px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        margin: 0 5px;
    }

    #btnFetchLockData, #btnFetchingLockData {
        background-color: #2395c6;
        color: #fff;
    }

        #btnFetchLockData:hover, #btnFetchingLockData:hover {
            background-color: #1d7ba3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(35, 149, 198, 0.3);
        }

    #btnClear {
        background-color: #dc3545;
        color: #fff;
    }

        #btnClear:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

    .btn-go:last-child {
        background-color: #6c757d;
        color: #fff;
    }

        .btn-go:last-child:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

    .text-danger {
        color: #dc3545;
    }

    .error-message {
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    #lockGridContainer {
        margin-bottom: 20px !important;
        max-height: 500px !important;
        overflow: auto !important;
    }

    #grid-loader {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(3px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .grid-logo-spinner {
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0%

    {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }

    }

    /* Radio Button Styles */
    .radio-group {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #2395c6;
        }

        .radio-option label {
            cursor: pointer;
            margin-bottom: 0;
            font-size: 14px;
            color: #495057;
        }

    /* Searchable Multi-Select Dropdown Styles */
    .searchable-select-wrapper {
        position: relative;
        width: 100%;
    }

    .searchable-select-input {
        min-height: 38px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 4px 35px 4px 8px;
        cursor: pointer;
        background-color: white;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 4px;
    }

        .searchable-select-input:hover {
            border-color: #86b7fe;
        }

    .selected-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        width: 100%;
    }

    .selected-tags-placeholder {
        color: #6c757d;
        font-size: 14px;
    }

    .selected-tag {
        background-color: #3e4b6d;
        border: 1px solid #3e4b6d;
        border-radius: 3px;
        padding: 2px 8px;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        color: white;
    }

        .selected-tag .remove-tag {
            cursor: pointer;
            font-weight: bold;
            color: white;
        }

            .selected-tag .remove-tag:hover {
                color: #f0f0f0;
            }

    .searchable-select-arrow {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 12px;
        height: 12px;
        pointer-events: none;
        transition: transform 0.3s;
    }

    .searchable-select-wrapper.active .searchable-select-arrow {
        transform: translateY(-50%) rotate(180deg);
    }

    .searchable-select-arrow svg {
        width: 100%;
        height: 100%;
        fill: #495057;
    }

    .searchable-select-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 4px;
        margin-top: 2px;
        max-height: 300px;
        overflow: hidden;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .searchable-select-wrapper.active .searchable-select-dropdown {
        display: flex;
        flex-direction: column;
    }

    .searchable-select-search {
        padding: 8px;
        border-bottom: 1px solid #e9ecef;
        background: white;
        flex-shrink: 0;
    }

        .searchable-select-search input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

            .searchable-select-search input:focus {
                outline: none;
                border-color: #86b7fe;
            }

    .multi-select-actions {
        padding: 8px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        gap: 8px;
        background: white;
        flex-shrink: 0;
    }

    .multi-select-btn {
        flex: 1;
        padding: 5px 10px;
        font-size: 12px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }

        .multi-select-btn:hover {
            background-color: #f8f9fa;
            border-color: #2395c6;
        }

    .searchable-select-options {
        overflow-y: auto;
        flex: 1;
    }

    .searchable-select-option {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

        .searchable-select-option:hover {
            background-color: #f8f9fa;
        }

        .searchable-select-option.selected {
            background-color: #e7f3ff;
        }

        .searchable-select-option input[type="checkbox"] {
            cursor: pointer;
        }

    .no-results {
        padding: 12px;
        text-align: center;
        color: #6c757d;
        font-size: 14px;
    }

    /* Status Badge Styles */
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        display: inline-block;
    }

    .status-locked {
        background-color: #dc3545;
        color: white;
    }

    .status-unlocked {
        background-color: #28a745;
        color: white;
    }

    /* Lock/Unlock Action Buttons */
    .grid-action-buttons {
        display: none;
        justify-content: center;
        gap: 15px;
        margin-top: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }

    .btn-lock-action {
        padding: 8px 35px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-lock {
        background-color: #dc3545;
        color: white;
    }

        .btn-lock:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        .btn-lock:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

    .btn-unlock {
        background-color: #28a745;
        color: white;
    }

        .btn-unlock:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .btn-unlock:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
</style>

<div class="salary-box">
    <div class="salary-header">Attendance Lock</div>
    <div class="row justify-content-center mt-3">
        <div class="col-lg-10">
            <!-- First Row: Month and Year -->
            <div class="row justify-content-center mb-3">
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Month<span class="text-danger">*</span>:</label>
                        <div class="flex-grow-1">
                            <select class="form-select" id="monthDropdown">
                                <option value="">Select Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <span class="text-danger error-message" id="errorMonth">Please select month</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Year<span class="text-danger">*</span>:</label>
                        <div class="flex-grow-1">
                            <select class="form-select" id="yearDropdown">
                                <option value="">Select Year</option>
                            </select>
                            <span class="text-danger error-message" id="errorYear">Please select year</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Row: Branch and Employee -->
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Branch<span class="text-danger">*</span>:</label>
                        <div class="flex-grow-1">
                            <div class="searchable-select-wrapper multi-select" id="branchWrapper">
                                <div class="searchable-select-input" id="branchDropdown">
                                    <div class="selected-tags">
                                        <span class="selected-tags-placeholder">Select Branch</span>
                                    </div>
                                </div>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search branch..." class="search-input">
                                    </div>
                                    <div class="multi-select-actions">
                                        <button type="button" class="multi-select-btn select-all-btn">Select All</button>
                                        <button type="button" class="multi-select-btn clear-all-btn">Clear All</button>
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                            <span class="text-danger error-message" id="errorBranch">Please select branch</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Employee<span class="text-danger">*</span>:</label>
                        <div class="flex-grow-1">
                            <div class="searchable-select-wrapper multi-select" id="employeeWrapper">
                                <div class="searchable-select-input" id="employeeDropdown">
                                    <div class="selected-tags">
                                        <span class="selected-tags-placeholder">Select Employee</span>
                                    </div>
                                </div>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search employee..." class="search-input">
                                    </div>
                                    <div class="multi-select-actions">
                                        <button type="button" class="multi-select-btn select-all-btn">Select All</button>
                                        <button type="button" class="multi-select-btn clear-all-btn">Clear All</button>
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                            <span class="text-danger error-message" id="errorEmployee">Please select employee</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Radio Button and Buttons Row -->
    <div class="row justify-content-center mt-3">
        <div class="col-lg-10">
            <div class="d-flex align-items-center justify-content-center gap-3">
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="radioLocked" name="lockStatus" value="Locked">
                        <label for="radioLocked">Locked</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="radioUnlocked" name="lockStatus" value="Unlocked">
                        <label for="radioUnlocked">Unlocked</label>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn-go" id="btnFetchLockData">Go</button>
                    <button class="btn-go" id="btnFetchingLockData" disabled style="display: none;">
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span> Go
                    </button>
                    <button class="btn-go" id="btnClear">Clear</button>
                    <button class="btn-go" onclick="goBack()">Back</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loader -->
<div id="grid-loader">
    <img src="@baseDomainUrl/loders/loder.png" class="grid-logo-spinner" />
    <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>
</div>

<!-- Lock Status Grid -->
<div id="lockGridContainer" style="display: none; margin-top: 20px;"></div>

<!-- Lock/Unlock Action Buttons -->
<div id="gridActionButtons" class="grid-action-buttons">
    <button class="btn-lock-action btn-lock" id="btnLockAttendance">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
        </svg>
        Lock Attendance
    </button>
    <button class="btn-lock-action btn-lock" id="btnLockingAttendance" disabled style="display: none;">
        <span class="spinner-border spinner-border-sm" role="status"></span>
        Locking...
    </button>

    <button class="btn-lock-action btn-unlock" id="btnUnlockAttendance">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2z" />
        </svg>
        Unlock Attendance
    </button>
    <button class="btn-lock-action btn-unlock" id="btnUnlockingAttendance" disabled style="display: none;">
        <span class="spinner-border spinner-border-sm" role="status"></span>
        Unlocking...
    </button>
</div>

<script> 
       const Empid = parseInt(localStorage.getItem("EmployeeId"));
    const savedCompany = localStorage.getItem('selectedCompany');
    const companyDetails = JSON.parse(savedCompany);
    const CompanyId = companyDetails.CompanyId;
    const Token = localStorage.getItem("authToken");

    // Store current grid data and filters
    let currentGridData = [];
    let currentFilters = {
        month: null,
        year: null
    };

    // Searchable Multi-Select Component
    class SearchableMultiSelect {
        constructor(wrapperId, options = {}) {
            this.wrapper = document.getElementById(wrapperId);
            this.input = this.wrapper.querySelector('.searchable-select-input');
            this.dropdown = this.wrapper.querySelector('.searchable-select-dropdown');
            this.searchInput = this.wrapper.querySelector('.search-input');
            this.optionsContainer = this.wrapper.querySelector('.searchable-select-options');
            this.selectedTags = this.wrapper.querySelector('.selected-tags');
            this.selectAllBtn = this.wrapper.querySelector('.select-all-btn');
            this.clearAllBtn = this.wrapper.querySelector('.clear-all-btn');

            this.options = [];
            this.selectedValues = [];
            this.onChangeCallback = options.onChange || null;

            this.init();
        }

        init() {
            this.input.addEventListener('click', (e) => {
                e.stopPropagation();
                this.toggleDropdown();
            });

            this.searchInput.addEventListener('input', (e) => {
                this.filterOptions(e.target.value);
            });

            this.selectAllBtn.addEventListener('click', () => this.selectAll());
            this.clearAllBtn.addEventListener('click', () => this.clearAll());

            document.addEventListener('click', (e) => {
                if (!this.wrapper.contains(e.target)) {
                    this.closeDropdown();
                }
            });
        }

        toggleDropdown() {
            this.wrapper.classList.toggle('active');
            if (this.wrapper.classList.contains('active')) {
                this.searchInput.focus();
            }
        }

        closeDropdown() {
            this.wrapper.classList.remove('active');
            this.searchInput.value = '';
            this.filterOptions('');
        }

        setOptions(options) {
            this.options = options;
            this.renderOptions();
        }

        renderOptions() {
            this.optionsContainer.innerHTML = '';

            if (this.options.length === 0) {
                this.optionsContainer.innerHTML = '<div class="no-results">No options available</div>';
                return;
            }

            this.options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'searchable-select-option';
                if (this.selectedValues.includes(option.value)) {
                    optionDiv.classList.add('selected');
                }

                optionDiv.innerHTML = `
                    <input type="checkbox" ${this.selectedValues.includes(option.value) ? 'checked' : ''}>
                    <span>${option.text}</span>
                `;

                optionDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleOption(option.value);
                });

                this.optionsContainer.appendChild(optionDiv);
            });
        }

        filterOptions(searchTerm) {
            const options = this.optionsContainer.querySelectorAll('.searchable-select-option');
            let visibleCount = 0;

            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchTerm.toLowerCase())) {
                    option.style.display = 'flex';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            });

            if (visibleCount === 0 && searchTerm) {
                if (!this.optionsContainer.querySelector('.no-results')) {
                    this.optionsContainer.innerHTML = '<div class="no-results">No results found</div>';
                }
            }
        }

        toggleOption(value) {
            const index = this.selectedValues.indexOf(value);
            if (index > -1) {
                this.selectedValues.splice(index, 1);
            } else {
                this.selectedValues.push(value);
            }
            this.updateSelectedTags();
            this.renderOptions();
            if (this.onChangeCallback) {
                this.onChangeCallback(this.selectedValues);
            }
        }

        selectAll() {
            this.selectedValues = this.options.map(opt => opt.value);
            this.updateSelectedTags();
            this.renderOptions();
            if (this.onChangeCallback) {
                this.onChangeCallback(this.selectedValues);
            }
        }

        clearAll() {
            this.selectedValues = [];
            this.updateSelectedTags();
            this.renderOptions();
            if (this.onChangeCallback) {
                this.onChangeCallback(this.selectedValues);
            }
        }

        updateSelectedTags() {
            this.selectedTags.innerHTML = '';

            if (this.selectedValues.length === 0) {
                const placeholder = document.createElement('span');
                placeholder.className = 'selected-tags-placeholder';
                placeholder.textContent = this.wrapper.id === 'branchWrapper' ? 'Select Branch' : 'Select Employee';
                this.selectedTags.appendChild(placeholder);
                return;
            }

            this.selectedValues.forEach(value => {
                const option = this.options.find(opt => opt.value === value);
                if (option) {
                    const tag = document.createElement('span');
                    tag.className = 'selected-tag';
                    tag.innerHTML = `
                        ${option.text}
                        <span class="remove-tag" data-value="${value}">×</span>
                    `;

                    tag.querySelector('.remove-tag').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleOption(value);
                    });

                    this.selectedTags.appendChild(tag);
                }
            });
        }

        getSelectedValues() {
            return this.selectedValues;
        }

        reset() {
            this.selectedValues = [];
            this.updateSelectedTags();
            this.renderOptions();
        }
    }

    // Initialize multi-select dropdowns
    let branchMultiSelect, employeeMultiSelect;

    $(document).ready(function() {
        // Initialize Branch Multi-Select
        branchMultiSelect = new SearchableMultiSelect('branchWrapper', {
            onChange: (selectedValues) => {
                loadEmployeesForBranches(selectedValues);
            }
        });

        // Initialize Employee Multi-Select
        employeeMultiSelect = new SearchableMultiSelect('employeeWrapper');

        // Load Years (current year only)
        const currentYear = new Date().getFullYear();
        $('#yearDropdown').append(`<option value="${currentYear}">${currentYear}</option>`);

        // Load Branches
        $.ajax({
            url: '@baseUrl/BranchAPI/GetAllBranchesListByCompanyId/' + CompanyId,
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + Token },
            success: function(response) {
                if (response?.data?.length > 0) {
                    const branchOptions = response.data.map(branch => ({
                        value: branch.branchId,
                        text: branch.branchName
                    }));
                    branchMultiSelect.setOptions(branchOptions);
                }
            }
        });
    });

    function loadEmployeesForBranches(branchIds) {
        employeeMultiSelect.setOptions([]);
        employeeMultiSelect.reset();

        if (!branchIds || branchIds.length === 0) {
            return;
        }

        const branchIdsParam = branchIds.join(',');

        $.ajax({
            url: `@baseDomainUrl/api/EmployeeMasterAPI/GetAllEmployeeByBranch/${CompanyId}?BranchId=${branchIdsParam}`,
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + Token },
            success: function(response) {
                if (response?.data?.length > 0) {
                    const employeeOptions = response.data.map(emp => ({
                        value: emp.id,
                        text: `${emp.fullName} (${emp.employeeCode})`
                    }));
                    employeeMultiSelect.setOptions(employeeOptions);
                } else {
                    console.warn('No employees found for selected branches');
                    employeeMultiSelect.setOptions([]);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading employees:', error);
                console.error('XHR Response:', xhr.responseText);
                employeeMultiSelect.setOptions([]);
                Swal.fire('Error', 'Failed to load employees for selected branches.', 'error');
            }
        });
    }

    function goBack() {
        window.location.href = '@Url.Action("Index", "Home", new { area = "AdminPanel" })';
    }

    function clearPage() {
        $('#monthDropdown').val('');
        $('#yearDropdown').val('');
        $('input[name="lockStatus"]').prop('checked', false);
        branchMultiSelect.clearAll();
        employeeMultiSelect.clearAll();
        $('.error-message').hide();
        $('#lockGridContainer').hide().empty();
        $('#gridActionButtons').hide();
        currentGridData = [];
        currentFilters = { month: null, year: null };
    }

    $('#btnClear').click(function() {
        clearPage();
    });

    function showLoader() {
        $('#grid-loader').css('display', 'flex');
    }

    function hideLoader() {
        $('#grid-loader').hide();
    }

    function showBtnLoader() {
        $('#btnFetchingLockData').show();
        $('#btnFetchLockData').hide();
    }

    function hideBtnLoader() {
        $('#btnFetchingLockData').hide();
        $('#btnFetchLockData').show();
    }

    $('#btnFetchLockData').click(function() {
        showBtnLoader();

        const month = $('#monthDropdown').val();
        const year = $('#yearDropdown').val();
        const status = $('input[name="lockStatus"]:checked').val() || null;
        const employeeIds = employeeMultiSelect.getSelectedValues();

        let isValid = true;
        if (!month) { $('#errorMonth').show(); isValid = false; } else { $('#errorMonth').hide(); }
        if (!year) { $('#errorYear').show(); isValid = false; } else { $('#errorYear').hide(); }
        if (employeeIds.length === 0) { $('#errorEmployee').show(); isValid = false; } else { $('#errorEmployee').hide(); }

        if (!isValid) {
            hideBtnLoader();
            return;
        }

        // Store current filters
        currentFilters = {
            month: parseInt(month),
            year: parseInt(year)
        };

        showLoader();

        // Create request payload
        const requestData = {
            Month: parseInt(month),
            Year: parseInt(year),
            EmployeeId: employeeIds.join(','),
            Status: status
        };

        $.ajax({
            url: '@(baseDomainUrl + "/api/AttendanceLockAPI/GetAttendanceLockDetails")',
            method: 'POST',
            contentType: 'application/json',
            headers: { 'Authorization': 'Bearer ' + Token },
            data: JSON.stringify(requestData),
            success: function(response) {
                hideLoader();
                hideBtnLoader();

                if (response?.isSuccess && response?.data?.length > 0) {
                    currentGridData = response.data;
                    renderLockGrid(response.data);
                    $('#gridActionButtons').css('display', 'flex');
                } else {
                    $('#gridActionButtons').hide();
                    Swal.fire('Info', response?.responseMessage || 'No lock records found.', 'info');
                }
            },
            error: function(xhr, status, error) {
                hideLoader();
                hideBtnLoader();
                $('#gridActionButtons').hide();
                console.error('Error fetching lock data:', error);
                Swal.fire('Error', 'Failed to fetch attendance lock data.', 'error');
            }
        });
    });

    function renderLockGrid(data) {
        const columns = [
            { dataField: "employeeCode", caption: "Employee Code", width: 150 },
            { dataField: "employeeId", caption: "EmployeeId", visible: false },
            { dataField: "fullName", caption: "Employee Name", width: 200 },
            { dataField: "designationName", caption: "Designation Name", width: 150 },
            { dataField: "month", caption: "Month", width: 100 },
            { dataField: "year", caption: "Year", width: 100 },
            {
                dataField: "status",
                caption: "Status",
                width: 120,
                cellTemplate: function(container, options) {
                    const status = options.value;
                    const badgeClass = status === 'Locked' ? 'status-locked' : 'status-unlocked';
                    container.html(`<span class="status-badge ${badgeClass}">${status}</span>`);
                }
            }
        ];

        $("#lockGridContainer").dxDataGrid({
            dataSource: data,
            keyExpr: "employeeId",
            showBorders: true,
            columnAutoWidth: true,
            rowAlternationEnabled: true,
            export: {
                enabled: false
            },
            searchPanel: {
                visible: true,
                width: 240,
                placeholder: "Search..."
            },
            paging: {
                enabled: true,
                pageSize: 20
            },
            pager: {
                visible: true,
                showPageSizeSelector: true,
                allowedPageSizes: [20, 50, 100],
                showInfo: true
            },
            scrolling: {
                mode: "standard"
            },
            loadPanel: {
                enabled: true
            },
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "always"
            },
            columns: columns,
            onContentReady: function(e) {
                // Set the width of the selection column
                var $checkBoxes = $(".dx-selection-checkbox");
                $checkBoxes.closest("th").css("width", "30px");
                $checkBoxes.closest("td").css("width", "30px");
            }
        }).show();
    }

    // Lock Attendance Button Click
    $('#btnLockAttendance').click(function() {
        const gridInstance = $("#lockGridContainer").dxDataGrid("instance");
        const selectedRows = gridInstance.getSelectedRowsData();

        if (selectedRows.length === 0) {
            Swal.fire('Warning', 'Please select at least one employee to lock attendance.', 'warning');
            return;
        }

        // Confirm before locking
        Swal.fire({
            title: 'Confirm Lock',
            text: `Are you sure you want to lock attendance for ${selectedRows.length} employee(s)?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, Lock It!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                lockAttendance(selectedRows);
            }
        });
    });

    // Unlock Attendance Button Click
    $('#btnUnlockAttendance').click(function() {
        const gridInstance = $("#lockGridContainer").dxDataGrid("instance");
        const selectedRows = gridInstance.getSelectedRowsData();

        if (selectedRows.length === 0) {
            Swal.fire('Warning', 'Please select at least one employee to unlock attendance.', 'warning');
            return;
        }

        // Confirm before unlocking
        Swal.fire({
            title: 'Confirm Unlock',
            text: `Are you sure you want to unlock attendance for ${selectedRows.length} employee(s)?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, Unlock It!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                unlockAttendance(selectedRows);
            }
        });
    });

    // Lock Attendance Function (Insert)
    function lockAttendance(selectedRows) {
        $('#btnLockingAttendance').show();
        $('#btnLockAttendance').hide();
        showLoader();
        debugger;
        // Prepare data for insert
        const lockRecords = selectedRows.map(row => ({
            EmpId: row.employeeId,
            Month: currentFilters.month,
            Year: currentFilters.year,
            IsLocked: true,
            IsEnabled: true,
            IsDeleted: false,
            CreatedBy: Empid 
        }));
        console.log('lockRecords' ,lockRecords);
        // DEMO API - Replace with actual endpoint
        const demoApiUrl = '@(baseDomainUrl + "/api/AttendanceLockAPI/CreateAttendanceLockEmp")';

        $.ajax({
            url: demoApiUrl,
            method: 'POST',
            contentType: 'application/json',
            headers: { 'Authorization': 'Bearer ' + Token },
            data: JSON.stringify(lockRecords),
            success: function(response) {
                hideLoader();
                $('#btnLockingAttendance').hide();
                $('#btnLockAttendance').show();

                if (response?.isSuccess) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: `Attendance locked successfully for ${selectedRows.length} employee(s).`,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        // Refresh grid data
                        $('#btnFetchLockData').click();
                    });
                } else {
                    Swal.fire('Error', response?.responseMessage || 'Failed to lock attendance.', 'error');
                }
            },
            error: function(xhr, status, error) {
                hideLoader();
                $('#btnLockingAttendance').hide();
                $('#btnLockAttendance').show();
                console.error('Error locking attendance:', error);
                Swal.fire('Error', 'Failed to lock attendance. Please try again.', 'error');
            }
        });
    }

    // Unlock Attendance Function (Update)
    function unlockAttendance(selectedRows) {
        $('#btnUnlockingAttendance').show();
        $('#btnUnlockAttendance').hide();
        showLoader();

        // Prepare data for update
        const unlockRecords = selectedRows.map(row => ({
            EmpId: row.employeeId,
            Month: currentFilters.month,
            Year: currentFilters.year,
            IsLocked: false,
            IsEnabled: true,
            IsDeleted: false,
            UpdatedBy: Empid // Replace with actual user ID if available
        }));

        // DEMO API - Replace with actual endpoint
        const demoApiUrl = '@(baseDomainUrl + "/api/AttendanceLockAPI/UpdateAttendanceLock")';

        $.ajax({
            url: demoApiUrl,
            method: 'PUT',
            contentType: 'application/json',
            headers: { 'Authorization': 'Bearer ' + Token },
            data: JSON.stringify(unlockRecords),
            success: function(response) {
                hideLoader();
                $('#btnUnlockingAttendance').hide();
                $('#btnUnlockAttendance').show();

                if (response?.isSuccess) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: `Attendance unlocked successfully for ${selectedRows.length} employee(s).`,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        // Refresh grid data
                        $('#btnFetchLockData').click();
                    });
                } else {
                    Swal.fire('Error', response?.responseMessage || 'Failed to unlock attendance.', 'error');
                }
            },
            error: function(xhr, status, error) {
                hideLoader();
                $('#btnUnlockingAttendance').hide();
                $('#btnUnlockAttendance').show();
                console.error('Error unlocking attendance:', error);
                Swal.fire('Error', 'Failed to unlock attendance. Please try again.', 'error');
            }
        });
    }
</script>
@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Employee Holiday Marking";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseAPIDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}


<div class="card">
    <div class="card-header bg-transparent ml-0 py-0">
        <div class="row">
            <div class="col-6">
                <h6 class="pt-2 mb-0">
                    Manage Employee Holiday Marking
                </h6>
            </div>

            <div class="col-6 d-flex justify-content-end align-items-center">
                <button id="addHolidayMarking"
                        type="button"
                        class="btn mr-1 rounded-1"
                        style="background-color:#2395c6; color:white;">
                    Add
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">

        <div class="card-body">

            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">

                        <div class="grid-wrapper " style="position: relative; ">
                            <div id="grid-loader" class="grid-loader justify-content-center align-items-center flex-column "
                                 style="display: none;  inset: 0; background: rgba(255,255,255,0.6); z-index: 10; ">
                                <img src="@baseAPIDomainUrl/loders/loder.png" class="grid-logo-spinner" style="width: 30px; height: 30px; animation: spin 1s linear infinite;" />
                                <div class="grid-loading-text text-dark" style="font-size: 16px;">Loading...</div>
                            </div>
                            <div id="gridTag">
                                <div class="rowCount" id="rowCount1"></div>
                                <div id="gridContainer"></div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<div class="modal fade" id="addHolidayMarkingModal" tabindex="-1" aria-labelledby="addHolidayMarkingLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title btn-heading-title" id="modalTitle">Add Holiday Marking</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body-font" style="font-size:12px;">
                <form id="holidayMarkingForm">
                    <input type="hidden" id="holidayMarkingId" value="0">

                    <div class="row">
                        <!-- Branch -->
                        <div class="col-md-6">
                            <div class="mt-3 form-floating-custom">
                                <div class="searchable-select-wrapper" id="branchHolidayWrapper">
                                    <label for="branchHoliday">Branch <span class="text-danger">*</span></label>
                                    <input type="text" class="searchable-select-input" id="branchHoliday" readonly>
                                    <span class="searchable-select-arrow">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                            <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                        </svg>
                                    </span>
                                    <div class="searchable-select-dropdown">
                                        <div class="searchable-select-search">
                                            <input type="text" placeholder="Search branch..." class="search-input">
                                        </div>
                                        <div class="searchable-select-options"></div>
                                    </div>
                                </div>
                                <span id="spnbranchHoliday" style="color:red; display:none; font-size: 0.85em;">Please Select Branch</span>
                            </div>
                        </div>

                        <!-- Employee -->
                        <div class="col-md-6">
                            <div class="mt-3 form-floating-custom">
                                <div class="searchable-select-wrapper" id="employeeHolidayWrapper">
                                    <label for="employeeHoliday">Employee <span class="text-danger">*</span></label>
                                    <input type="text" class="searchable-select-input" id="employeeHoliday" readonly>
                                    <span class="searchable-select-arrow">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                            <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                        </svg>
                                    </span>
                                    <div class="searchable-select-dropdown">
                                        <div class="searchable-select-search">
                                            <input type="text" placeholder="Search employee..." class="search-input">
                                        </div>
                                        <div class="searchable-select-options"></div>
                                    </div>
                                </div>
                                <span id="spnemployeeHoliday" style="color:red; display:none; font-size: 0.85em;">Please Select Employee</span>
                            </div>
                        </div>

                        <!-- Holiday Date -->
                        <div class="col-md-6">
                            <div class="form-group mt-3 position-relative">
                                <input type="date" class="form-control floating-input" id="holidayDate" placeholder="Holiday Date">
                                <label class="floating-label" for="holidayDate">Holiday Date <span class="text-danger">*</span></label>
                            </div>
                            <span id="spnholidayDate" style="color:red; display:none; font-size: 0.85em;">Please Select Holiday Date</span>
                        </div>

                        <!-- Holiday Name -->
                        <div class="col-md-6">
                            <div class="form-group mt-3 position-relative">
                                <input type="text" class="form-control floating-input" id="holidayName" placeholder="Holiday Name">
                                <label class="floating-label" for="holidayName">Holiday Name <span class="text-danger">*</span></label>
                            </div>
                            <span id="spnholidayName" style="color:red; display:none; font-size: 0.85em;">Please Enter Holiday Name</span>
                        </div>

                    </div>
                </form>
            </div>
            <div class="modal-footer btn-heading-title">
                <button type="button" class="btn btn-primary" id="btnSaveHolidayMarking" style="background-color:#2395c6; color:white;">Save</button>
                <button type="button" class="btn btn-primary" id="btnSavingHolidayMarking" style="background-color:#2395c6; color:white;display:none;" disabled><span class="spinner-border spinner-border-sm me-2" role="status"></span> Saving..</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script src="~/assets/js/jquery.min.js"></script>


<script>
     var companyDetails = JSON.parse(localStorage.getItem('selectedCompany'));
     const CompanyId = companyDetails?.CompanyId;
     const EmployeeId = localStorage.getItem('EmployeeId');
     const Token = localStorage.getItem("authToken");

     $(document).ready(function(){
         loadEmployeeHolidayMarkings();

         $('#employeeHoliday').searchableSelect({
             data: [],
             valueKey: 'employeeId',
             textKey: 'employeeName',
             placeholder:'Employee',
             searchPlaceholder: 'Search employee...'
         });

         BindBranchDropdownForHoliday();
     })

     $("#addHolidayMarking").click(() => {
          resetHolidayMarkingForm();
          $('#modalTitle').text('Add Holiday Marking');
          $("#addHolidayMarkingModal").modal('show');
     });

      function showbtnLoder(isUpdate){
        $('#btnSaveHolidayMarking').hide();
        if(isUpdate) {
            $('#btnSavingHolidayMarking').html('<span class="spinner-border spinner-border-sm me-2" role="status"></span> Updating..');
        } else {
            $('#btnSavingHolidayMarking').html('<span class="spinner-border spinner-border-sm me-2" role="status"></span> Saving..');
        }
        $('#btnSavingHolidayMarking').show();
    }

    function hidebtnLoder(){
        $('#btnSaveHolidayMarking').show();
        $('#btnSavingHolidayMarking').hide();
    }

    async function BindBranchDropdownForHoliday() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '@baseUrl/BranchAPI/GetAllBranchesListByCompanyId/' + CompanyId,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (data) {
                    if (data.isSuccess) {
                        $('#branchHoliday').searchableSelect({
                            data: data.data || [],
                            valueKey: 'branchId',
                            textKey: 'branchName',
                            placeholder: 'Branch',
                            searchPlaceholder: 'Search branch...',
                            onChange: function(item) {
                                BindEmployeeByBranchIdForHoliday(item.branchId);
                            }
                        });
                        resolve(data.data);
                    } else {
                        reject('Failed to fetch branches');
                    }
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }

    async function BindEmployeeByBranchIdForHoliday() {
        var branchId = $('#branchHoliday').data('searchableSelect').getValue();
        if (!branchId) {
            return Promise.resolve();
        }
        var payLoad = {
            BranchId: branchId,
            CompanyId: CompanyId
        }
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '@baseUrl/EmployeeMasterAPI/GetEmployeeListByBranchId',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                data: JSON.stringify(payLoad),
                success: function (data) {
                    if (data.isSuccess) {
                        const dropdownEmployee = $('#employeeHoliday').data('searchableSelect');
                        if (dropdownEmployee) {
                            dropdownEmployee.setData(data.data);
                        }
                        resolve(data.data);
                    } else {
                        reject('Failed to fetch employees');
                    }
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }

    async function loadEmployeeHolidayMarkings() {
        $('#grid-loader').addClass('d-flex').show();
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '@baseUrl/EmployeeHolidayMarkingAPI/GetAllEmployeeHoliday/',
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (response) {

                        if (response.data && response.data.length > 0) {
                              console.log('Sample data structure:', response.data[0]);
                           }

                          var gridInstance = $("#gridContainer").dxDataGrid({
                        dataSource: response.data || [],
                        columns: [
                            { dataField: 'branchName', caption: 'Branch Name' },
                            { dataField: 'employeeCode', caption: 'Employee Code' },
                            { dataField: 'fullName', caption: 'Employee Name' },
                            { dataField: 'employeeId', caption: 'EmployeeId' ,visible: false },
                            {
                                dataField: 'holidayDate',
                                caption: 'Holiday Date',
                                dataType: 'date',
                                format: 'dd-MM-yyyy'
                            },
                            { dataField: 'holidayName', caption: 'Holiday Name' },
                            { dataField: 'marked', caption: 'Status' }, 
                            { dataField: 'branchId', caption: 'BranchId' ,visible: false },
                            {
                                dataField: '',
                                caption: 'Actions',
                                dataType: 'string',
                                width: '100px',
                                cellTemplate: function (container, options) {
                                    var buttonElement = $('<div class="d-flex order-actions">' +
                                        '<a href="javascript:;" class="edit-action me-2" title="Edit Holiday Marking">' +
                                        '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">' +
                                        '<path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>' +
                                        '<path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>' +
                                        '</svg>' +
                                        '</a>' +
                                        '<a href="javascript:;" class="delete-action" title="Delete Holiday Marking">' +
                                        '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">' +
                                        '<path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>' +
                                        '<path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>' +
                                        '</svg>' +
                                        '</a>' +
                                        '</div>');

                                    buttonElement.find('.edit-action').on('click', function () {
                                        UpdateHolidayMarkingData(options.data);
                                    });

                                    buttonElement.find('.delete-action').on('click', function () {
                                        DeleteHolidayMarking(options.data);
                                    });

                                    buttonElement.appendTo(container);
                                }
                            }
                        ],

                        columnAutoWidth: true,
                        allowColumnResizing: true,
                        columnResizingMode: "widget",
                        wordWrapEnabled: false,
                        showBorders: true,
                        scrolling: {
                            mode: "standard",
                            useNative: true,
                            scrollByContent: true,
                            scrollByThumb: true,
                            showScrollbar: "always"
                        },

                        rowAlternationEnabled: false,
                        grouping: { autoExpandAll: false },
                        paging: { pageSize: 10 },
                        pager: {
                            showPageSizeSelector: true,
                            allowedPageSizes: [10, 25, 50, 100]
                        },
                        headerFilter: { visible: false },
                        filterRow: { visible: false, applyFilter: "auto" },
                        groupPanel: { visible: false },
                        searchPanel: { visible: true, width: 240, placeholder: "Search..." },
                        allowColumnReordering: false,

                        onContentReady(e) {
                            $('.rowCount').html('Total Records: ' + e.component.totalCount());
                            e.component.updateDimensions();
                            $('#grid-loader').removeClass('d-flex').hide();
                        }
                    }).dxDataGrid('instance');

                    $('#grid-loader').removeClass('d-flex').hide();
                    resolve(response.data);
                },
                error: function (error) {
                    $('#grid-loader').removeClass('d-flex').hide();
                    reject(error);
                }
            });
        });
    }
    $('#btnSaveHolidayMarking').click(function () {
        showbtnLoder(isUpdate);
        var holidayMarkingId = $('#holidayMarkingId').val();
        var branch = $('#branchHoliday').data('searchableSelect').getValue();
        var employee = $('#employeeHoliday').data('searchableSelect').getValue();
        var holidayDate = $('#holidayDate').val();
        var holidayName = $('#holidayName').val();
        var isValid = true;

        if (!branch) {
            $('#spnbranchHoliday').show();
            isValid = false;
        } else {
            $('#spnbranchHoliday').hide();
        }

        if (!employee) {
            $('#spnemployeeHoliday').show();
            isValid = false;
        } else {
            $('#spnemployeeHoliday').hide();
        }

        if (!holidayDate) {
            $('#spnholidayDate').show();
            isValid = false;
        } else {
            $('#spnholidayDate').hide();
        }

        if (!holidayName || holidayName.trim() === '') {
            $('#spnholidayName').show();
            isValid = false;
        } else {
            $('#spnholidayName').hide();
        }

        if (!isValid) {
           hidebtnLoder();
            return;
        }

        var holidayMarkingData = {
            EmployeeHolidayId: parseInt(holidayMarkingId),
            EmployeeId: parseInt(employee),
            HolidayDate: holidayDate,
            Marked: 'H',
            HolidayName: holidayName.trim(),
            CreatedBy: parseInt(EmployeeId),
            UpdatedBy: parseInt(EmployeeId)
        };

        var isUpdate = holidayMarkingId > 0;
        var apiUrl = isUpdate
            ? "@baseUrl/EmployeeHolidayMarkingAPI/UpdateEmployeeHoliday"
            : "@baseUrl/EmployeeHolidayMarkingAPI/CreateEmployeeHoliday";

        var httpMethod = isUpdate ? "PUT" : "POST";

        $.ajax({
            url: apiUrl,
            type: httpMethod,
            contentType: 'application/json',
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            data: JSON.stringify(holidayMarkingData),
            success: function (response) {
                if (response.isSuccess) {
                    round_success_noti(response.responseMessage);
                    $("#addHolidayMarkingModal").modal('hide');
                    loadEmployeeHolidayMarkings();
                } else {
                    round_error_noti(response.responseMessage);
                }
                hidebtnLoder();
            },
            error: function (xhr) {
                hidebtnLoder();
                console.error('Error:', xhr);
                round_error_noti('Unable to save holiday marking');
            }
        });
    });
    async function resetHolidayMarkingForm() {
        $('#holidayMarkingId').val('0');
        $('#branchHoliday').data('searchableSelect').clear();
        $('#employeeHoliday').data('searchableSelect').clear();
        $('#holidayDate').val('');
        $('#holidayName').val('');
        hidebtnLoder();

        // Reset button text to "Save"
        $('#btnSaveHolidayMarking').text('Save');

        $('#spnbranchHoliday, #spnemployeeHoliday, #spnholidayDate, #spnholidayName').hide();
    }

    async function UpdateHolidayMarkingData(data) { 
     
        await resetHolidayMarkingForm();
        $('#modalTitle').text('Update Holiday Marking');
        $('#btnSaveHolidayMarking').text('Update');
        $('#holidayMarkingId').val(data.employeeHolidayId || data.EmployeeHolidayId || 0);

    
        const branchId = data.branchId || data.BranchId;
        $('#branchHoliday').data('searchableSelect').setValue(branchId);
        await BindEmployeeByBranchIdForHoliday();
        const employeeId = data.employeeId || data.EmployeeId;
        $('#employeeHoliday').data('searchableSelect').setValue(employeeId);

        // Set the date and holiday name
        var dateStr = data.holidayDate || data.HolidayDate;
        if (dateStr.includes('T')) {
            dateStr = dateStr.split('T')[0];
        } else if (dateStr.includes(' ')) {
            dateStr = dateStr.split(' ')[0];
        }
        $('#holidayDate').val(dateStr);
        $('#holidayName').val(data.holidayName || data.HolidayName);

        // Show the modal
        $("#addHolidayMarkingModal").modal('show');
    }


    function DeleteHolidayMarking(data) {
        const holidayId = data.employeeHolidayId || data.EmployeeHolidayId;
        if (confirm('Are you sure you want to delete this holiday marking?')) {
            $.ajax({
                url: `@baseUrl/EmployeeHolidayMarkingAPI/Delete?Id=${holidayId}&DeletedBy=${EmployeeId}`,
                type: "DELETE",
                headers: {
                    'Authorization': 'Bearer ' + Token
                },
                success: function (response) {
                    if (response.isSuccess) {
                        round_success_noti(response.responseMessage);
                        loadEmployeeHolidayMarkings();
                    } else {
                        round_error_noti(response.responseMessage);
                    }
                },
                error: function (xhr) {
                    console.error('Error:', xhr);
                    round_error_noti('Unable to delete holiday marking');
                }
            });
        }
    }

</script>
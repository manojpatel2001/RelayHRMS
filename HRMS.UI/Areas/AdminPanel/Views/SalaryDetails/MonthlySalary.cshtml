@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Monthly Salary";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}"; 
    string UIBaseUrl = Configuration["UIBaseUrlSettings:baseUrl"];

}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
   

    .salary-box {
        background-color: white !important;
        border: 1px solid #ccc;
        padding: 12px;
        border-radius: 5px;
    }

    .salary-header {
        background-color: #3e4b6d;
        color: white;
        font-weight: bold;
        padding: 8px 15px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
    } 




    .form-group-row {
        margin-bottom: 20px;
        gap: 15px;
    }

    .form-label {
        min-width: 100px;
        font-weight: 500;
        color: #495057;
        font-size: 14px;
        margin-bottom: 0;
    }

    

    .btn-go {
        padding: 5px 30px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        margin: 0 5px;
    }

    #btnFetchSalary, #btnFetchingSalary {
        background-color: #2395c6;
        color: #fff;
    }

    #btnFetchSalary, #btnFetchingSalary:hover {
            background-color: #1d7ba3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(35, 149, 198, 0.3);
        }

    .btn-go:last-child {
        background-color: #6c757d;
        color: #fff;
    }

        .btn-go:last-child:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

    .text-danger {
        color: #dc3545;
    }

    .error-message {
        font-size: 12px;
        margin-top: 5px;
        display:none;
    }






    .dx-tagbox,
    .dx-tagbox .dx-texteditor {
        width: 100% !important;
        max-width: 100% !important;
    }

  
    .dx-placeholder {
        font-size: 14px !important;
        color: #999 !important;
        white-space: nowrap;
    }

    .dx-texteditor-input {
        width: 100% !important;
    }

    .small-dropdown {
        width: 180px !important;
    }

    .dx-list-select-all {
        background-color: transparent !important;
        color: #333 !important;
        font-weight: normal;
        padding: 8px 12px;
    }

        .dx-list-select-all.dx-state-hover {
            background-color: #f8f8f8 !important;
        }

    .dx-placeholder {
        color: #999 !important;
        font-weight: normal;
    }


    #salaryActions {
        margin-top: 20px !important;
        margin-bottom: 20px !important;
        clear: both;
        padding: 10px 0;
    }

        #salaryActions button {
            background-color: #3e4b6d;
            color: white;
            border: none;
            padding: 4px 12px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 4px;
            transition: none;
            box-shadow: none;
            margin: 0 5px;
        }

            #salaryActions button:hover,
            #salaryActions button:focus,
            #salaryActions button:active {
                background-color: #3e4b6d;
                color: white;
                outline: none;
                box-shadow: none;
            }

    .dx-button .fa-file-excel {
        color: #217346;
    }

    /* DevExtreme Grid Header Fixes */
    .dx-datagrid-headers .dx-header-row > td,
    .dx-datagrid-headers .dx-header-row > th,
    .dx-datagrid .dx-datagrid-headers .dx-datagrid-content-fixed .dx-header-row > td,
    .dx-datagrid .dx-datagrid-headers .dx-datagrid-content-fixed .dx-header-row > th {
        background-color: #3e4b6d !important;
        color: white !important;
        font-weight: bold !important;
        border-color: #2a3447 !important;
    }

    .dx-datagrid .dx-header-row .dx-datagrid-action,
    .dx-datagrid-headers .dx-datagrid-action {
        background-color: #3e4b6d !important;
    }

    .dx-datagrid .dx-datagrid-headers {
        background-color: #3e4b6d !important;
    }

        .dx-datagrid .dx-datagrid-headers .dx-datagrid-table .dx-row > td {
            background-color: #3e4b6d !important;
            color: white !important;
            border-color: #2a3447 !important;
        }

    .dx-datagrid-header-panel .dx-toolbar .dx-toolbar-items-container {
        background-color: transparent;
    }

    .dx-datagrid-wrapper {
        margin-bottom: 20px !important;
    }


    .small-swal {
        width: 150px !important; /* Adjust width as needed */
    }

        .small-swal .swal2-title {
            font-size: 10px !important; /* Adjust title font size */
        }

        .small-swal .swal2-content {
            font-size: 10px!important; /* Adjust text font size */
        }

        .small-swal .swal2-icon {
            width: 1em !important; /* Adjust icon size */
            height: 1em !important;
        }

        .small-swal .swal2-styled {
            font-size: 10px !important; /* Adjust button font size */
            padding: 5px 15px !important; /* Adjust button padding */
        }

   /*   @@media (max-width: 768px) {
        #salaryGridContainer

    {
        height: 250px; 
    }

    }


   
 */
    #salaryGridContainer {
        margin-bottom: 20px !important;
        max-height: 200px !important;
        overflow: auto !important;
    }
</style>



<div class="salary-box">
    <div class="salary-header">Add Monthly Salary</div>

    <div class="row justify-content-center mt-3">
        <div class="col-lg-10">
            <div class="row">
                <!-- Left Column -->
                <div class="col-md-6">
                    <!-- Month Dropdown (Single Select) -->
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Month<span class="text-danger">*</span> :</label>
                        <div class="form-floating-custom flex-grow-1">
                            <div class="searchable-select-wrapper" id="monthWrapper">
                                <label for="monthDropdown">Select Month <span class="text-danger">*</span></label>
                                <input type="text" class="searchable-select-input" id="monthDropdown" readonly>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search month..." class="search-input">
                                    </div>
                                    <div class="multi-select-actions">
                                        <button type="button" class="multi-select-btn select-all-btn">Select All</button>
                                        <button type="button" class="multi-select-btn clear-all-btn">Clear All</button>
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                            <span class="text-danger error-message" id="errorMonth">Please select month</span>
                        </div>
                    </div>

                    <!-- Branch Dropdown (Multi Select) -->
                   @*  <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Branch<span class="text-danger">*</span> :</label>
                        <div class="form-floating-custom flex-grow-1">
                            <div class="searchable-select-wrapper multi-select" id="branchWrapper">
                                <label for="branchDropdown">Select Branch <span class="text-danger">*</span></label>
                                <div class="searchable-select-input" id="branchDropdown">
                                    <div class="selected-tags">
                                        <span class="selected-tags-placeholder"></span>
                                    </div>
                                </div>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search branch..." class="search-input">
                                    </div>
                                    <div class="multi-select-actions">
                                        <button type="button" class="multi-select-btn select-all-btn">Select All</button>
                                        <button type="button" class="multi-select-btn clear-all-btn">Clear All</button>
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                            <span class="text-danger error-message" id="errorBranch">Please select branch</span>
                        </div>
                    </div> *@

                </div>

                <!-- Right Column -->
                <div class="col-md-6">
                    <!-- Year Dropdown (Single Select) -->
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Year<span class="text-danger">*</span> :</label>
                        <div class="form-floating-custom flex-grow-1">
                            <div class="searchable-select-wrapper" id="yearWrapper">
                                <label for="yearDropdown">Select Year <span class="text-danger">*</span></label>
                                <input type="text" class="searchable-select-input" id="yearDropdown" readonly>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search year..." class="search-input">
                                    </div>
                                    <div class="multi-select-actions">
                                        <button type="button" class="multi-select-btn select-all-btn">Select All</button>
                                        <button type="button" class="multi-select-btn clear-all-btn">Clear All</button>
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                            <span class="text-danger error-message" id="errorYear">Please select year</span>
                        </div>
                    </div>

                   
                </div>

                <div class="col-md-6">

                    <!-- Employee Dropdown (Multi Select) -->
                    <div class="form-group-row d-flex align-items-center">
                        <label class="form-label">Employee<span class="text-danger">*</span> :</label>
                        <div class="form-floating-custom flex-grow-1">
                            <div class="searchable-select-wrapper multi-select" id="employeeWrapper">
                                <label for="employeeDropdown">Select Employee <span class="text-danger">*</span></label>
                                <div class="searchable-select-input" id="employeeDropdown">
                                    <div class="selected-tags">
                                        <span class="selected-tags-placeholder"></span>
                                    </div>
                                </div>
                                <span class="searchable-select-arrow">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                    </svg>
                                </span>
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Search employee..." class="search-input">
                                    </div>
                                    <div class="multi-select-actions">
                                        <button type="button" class="multi-select-btn select-all-btn">Select All</button>
                                        <button type="button" class="multi-select-btn clear-all-btn">Clear All</button>
                                    </div>
                                    <div class="searchable-select-options"></div>
                                </div>
                            </div>
                            <span class="text-danger error-message" id="errorEmployee">Please select employee</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Buttons -->
    <div class="col-md-12 text-center mt-4">
        <button class="btn-go" id="btnFetchSalary">Go</button>
        <button class="btn-go" id="btnFetchingSalary" disabled style="display:none;"><span class="spinner-border spinner-border-sm me-2" role="status"></span> Go</button>

        <button class="btn-go" onclick="goBack()">Back</button>
    </div>
</div>



<div id="grid-loader"
     class="grid-loader justify-content-center align-items-center flex-column"
     style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(3px); z-index: 9999;">
    <img src="@baseDomainUrl/loders/loder.png"
         class="grid-logo-spinner"
         style="width: 40px; height: 40px; animation: spin 1s linear infinite;" />
    <div class="grid-loading-text text-dark " style="font-size: 16px;">Loading...</div>
</div>



<div id="salaryGridContainer" style="display:none" class="mt-4"></div>   

<div class="col-md-12 text-center my-2" id="salaryActions" style="display:none">
    <button id="btnProcessSalary" class="salary-header mx-1">Process</button>
    <button id="btnProcessingSalary" class="salary-header mx-1" disabled style="display:none;"><span class="spinner-border spinner-border-sm me-2" role="status"></span> Processing..</button>
    <button id="btnClearSalary" class="salary-header mx-1">Clear</button>
</div>

<script>

                   const savedCompany = localStorage.getItem('selectedCompany');
           var companyDetails = JSON.parse(savedCompany);
           const CompanyId=companyDetails.CompanyId;
           const EmployeeId=localStorage.getItem('EmployeeId');
           const Token=localStorage.getItem("authToken");
    $(document).ready(function () {
        const months = [
            { monthNumber: 1, monthName: 'January' },
            { monthNumber: 2, monthName: 'February' },
            { monthNumber: 3, monthName: 'March' },
            { monthNumber: 4, monthName: 'April' },
            { monthNumber: 5, monthName: 'May' },
            { monthNumber: 6, monthName: 'June' },
            { monthNumber: 7, monthName: 'July' },
            { monthNumber: 8, monthName: 'August' },
            { monthNumber: 9, monthName: 'September' },
            { monthNumber: 10, monthName: 'October' },
            { monthNumber: 11, monthName: 'November' },
            { monthNumber: 12, monthName: 'December' }
        ];

        const currentMonth = new Date().getMonth() + 1;
        const currentYear = new Date().getFullYear();

        const years = [];
      for (let i = currentYear; i <= currentYear + 1; i++) {
        years.push({ yearName: i.toString() });
    }

        // Month Dropdown
        $('#monthDropdown').searchableSelect({
            data: months,
            valueKey: 'monthNumber',
            textKey: 'monthName',
            searchPlaceholder: 'Search month...',
            defaultValue: currentMonth,
            onChange: function(item) {
                loadEmployeeDropdown();
            }
        });

        // Year Dropdown
        $('#yearDropdown').searchableSelect({
            data: years,
            valueKey: 'yearName',
            textKey: 'yearName',
            searchPlaceholder: 'Search year...',
            defaultValue: currentYear.toString(),
            onChange: function(item) {
                loadEmployeeDropdown();
            }
        });

        // **FIX: Force update the visible input text**
        setTimeout(function() {
            // Month ko display update karo
            const selectedMonthName = months.find(m => m.monthNumber === currentMonth)?.monthName;
            if (selectedMonthName) {
                $('#monthDropdown').val(selectedMonthName).trigger('change');
            }

            // Year ko display update karo
            $('#yearDropdown').val(currentYear.toString()).trigger('change');

            // Employee dropdown bhi load karo with current values
            loadEmployeeDropdown();
        }, 150);
    });
    function goBack() {
        window.history.back();
    }
    function loadEmployeeDropdown() {
        // Get selected month and year from dropdowns
        const monthNumber = $('#monthDropdown').data('searchableSelect')?.getValue() || new Date().getMonth() + 1;
        const year = $('#yearDropdown').data('searchableSelect')?.getValue() || new Date().getFullYear();

        // Validate month and year before API call
        if (!monthNumber || !year) {
            console.error('Month or Year not selected');
            return;
        }

        $.ajax({
            url: '@baseUrl/EmployeeMasterAPI/GetEmployeesListForSalary',
            method: 'GET',
            data: {
                month: monthNumber,
                year: year
            },
            success: function (res) {
                // Clear existing employee dropdown data
                const employeeDropdown = $('#employeeDropdown').data('searchableSelect');

                if (employeeDropdown) {
                    // If dropdown already exists, update its data
                    employeeDropdown.setData(res.data || []);
                    employeeDropdown.clear(); // Clear any previous selections
                } else {
                    // Initialize dropdown for the first time
                    $('#employeeDropdown').searchableSelect({
                        data: res.data || [],
                        valueKey: 'employeeCode',
                        textKey: 'employeeName',
                        searchPlaceholder: 'Search ...',
                        placeholder: 'Employee ...',
                        multiple: true,
                        onChange: function(items) {
                            // Handle employee selection change if needed
                        }
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error('Error loading employee dropdown:', error);
                round_error_noti('Failed to load employees for selected month and year');
            }
        });
    }
    function showbtnLoader(){
        $("#btnFetchingSalary").show();
        $("#btnFetchSalary").hide();
    }
    function hidebtnLoader(){
        $("#btnFetchingSalary").hide();
        $("#btnFetchSalary").show();
    }
     function showbtnProcessingLoader(){
        $("#btnProcessingSalary").show();
        $("#btnProcessSalary").hide();
    }
    function hidebtnProcessingLoader(){
        $("#btnProcessingSalary").hide();
        $("#btnProcessSalary").show();
    }

    // function BindBranchDropdown() {
    //     $.ajax({
    //                 url: '@baseUrl/BranchAPI/GetAllBranchesListByCompanyId/'+CompanyId,
    //             method: 'GET',
    //                 headers: {
    //                         'Authorization': 'Bearer ' + Token
    //                     },
    //         success: function (response) { 
    //             if (response?.data?.length > 0) {
                  

    //                 $('#branchDropdown').searchableSelect({
    //                     data: response.data||[],
    //                     valueKey: 'branchId',
    //                     textKey: 'branchName',
    //                     searchPlaceholder: 'Search ...',
    //                     placeholder: 'Branch ...',
    //                     multiple: true,
    //                     onChange: function(items) {
    //                         const branchIds = items.map(i => i.branchId).join(',');
    //                         BindEmployeeDropdownByBranch();
    //                     }
    //                 });
    //             }
    //         }
    //     });
    // }
     

           async function showLoder() {
              $('#grid-loader').addClass('d-flex').show();
          }

          async function hideLoder() {
              $('#grid-loader').removeClass('d-flex').hide();
          }



    // function BindEmployeeDropdownByBranch() {
    //     var selectedBranchIds=$('#branchDropdown').data('searchableSelect').getValue().join(",");
    //     if(!selectedBranchIds){
    //         selectedBranchIds="0";
    //     }

    //     // Get selected month (1-12)
    //     const monthNumber = $('#monthDropdown').data('searchableSelect').getValue();
    //     $('#errorMonth').hide();
    //     if(!monthNumber){
    //         $('#errorMonth').show();
    //         $('#branchDropdown').data('searchableSelect').clear();
    //         return ;
    //     }

    //     $.ajax({
    //         type: "GET",
    //         url: '@(baseDomainUrl + "/api/MonthlySalaryDetailsAPI/GetEmployeesForSalary")?BranchIds=' + selectedBranchIds + '&CompanyId=' + CompanyId + '&Month=' + monthNumber,
    //         success: function (response) {
    //             const $empDropdown = $("#employeeDropdown");

    //             if (response?.data?.length > 0) {
    //                 const employeeData = response.data.map(emp => ({
    //                     employeeCode: emp.employeeCode,
    //                     displayName: `${emp.fullName} - ${emp.employeeCode}`
    //                 }));


    //                       const dropdownddlEmployee = $('#employeeDropdown').data('searchableSelect');
    //                             if(dropdownddlEmployee){
    //                                     dropdownddlEmployee.setData(employeeData);
    //                             }
    //             } 
    //         },
    //         error: function(xhr, status, error) {
    //             console.error("Error fetching employees:", error);
                
    //         }
    //     });
    // }


    $('#btnFetchSalary').on('click', function () {
         showbtnLoader();
        const monthNumber = $('#monthDropdown').data('searchableSelect').getValue();
        const year = $('#yearDropdown').data('searchableSelect').getValue();
        //const branchIds = $('#branchDropdown').data('searchableSelect').getValue();
        const employeeIds = $('#employeeDropdown').data('searchableSelect').getValue();
  
            let isValid = true;
            if (!monthNumber) {
                $('#errorMonth').show();
                isValid = false;
            } else {
                $('#errorMonth').hide();
            }

            if (!year) {
                $('#errorYear').show();
                isValid = false;
            } else {
                $('#errorYear').hide();
            }
            // if (!branchIds) {
            //     $('#errorBranch').show();
            //     isValid = false;
            // } else {
            //     $('#errorBranch').hide();
            // }

            if (!employeeIds||employeeIds.length==0) {
                $('#errorEmployee').show();
                isValid = false;
            } else {
                $('#errorEmployee').hide();
            }


            if (!isValid) {
                  hidebtnLoader();
                return;
            }



        // Create start date (first day of month)
        const startDate = `${year}-${monthNumber.toString().padStart(2, '0')}-01`;

        // Get the actual last day of the month
        const lastDayOfMonth = new Date(year, monthNumber, 0).getDate();

        // Create end date (last day of month)
        const endDate = `${year}-${monthNumber.toString().padStart(2, '0')}-${lastDayOfMonth.toString().padStart(2, '0')}`;


        const empCodes = employeeIds.join(",");

        // Modified to send multiple branch IDs
        const requestData = {
            StartDate: startDate,
            EndDate: endDate,
            EmployeeCodes: empCodes,
            CompanyId: CompanyId,
            Action: "GetData",
            CreatedBy: EmployeeId
        };

       // showLoder();
        $.ajax({
            type: "POST",
            url: '@(baseDomainUrl + "/api/MonthlySalaryDetailsAPI/GetMonthlySalary")',
            data: JSON.stringify(requestData),
            contentType: "application/json",
            success: function (response) {
                if (response && response.data && response.data.length > 0) {
                    RenderSalaryGrid(response.data);
                    $('#yearDropdown').prop('disabled', true);
                    $('#monthDropdown').prop('disabled', true);           
                    $('#branchDropdown').css('pointer-events', 'none');
                    $('#employeeDropdown').css('pointer-events', 'none');
                } else {
                    round_error_noti("No data found for the selected criteria");
                }
                hidebtnLoader();
            },
            error: function (xhr) {
                hidebtnLoader()
                round_error_noti("Failed to fetch salary data");
                console.log(xhr);
            }
        });
    });

     function RenderSalaryGrid(data) {
        $("#salaryGridContainer").show();
        let isExportingSelected = false;

        $("#salaryGridContainer").dxDataGrid({
            dataSource: data,
            keyExpr: "employeeId",
            showBorders: true,
            columnAutoWidth: true,
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "always"
            },
            columnFixing: {
                enabled: true
            },
            paging: {
                enabled: false
            },
            scrolling: {
                mode: "standard",
                useNative: false,
                scrollByContent: true,
                scrollByThumb: true,
                showScrollbar: "always"
            },
            export: {
                enabled: true,
                allowExportSelectedData: true
            },

            onExporting: function(e) {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('MonthlySalary');

                // Get visible columns with dataField only
                const visibleColumns = e.component.getVisibleColumns()
                    .filter(column => column.visible !== false && column.dataField);

                // Add header row
                const headerRow = worksheet.addRow(
                    visibleColumns.map(column => column.caption)
                );

                // Style header row
                headerRow.eachCell((cell) => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF3E4B6D' }
                    };
                    cell.font = {
                        color: { argb: 'FFFFFFFF' },
                        bold: true
                    };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                });

                // CRITICAL: Check if selectedRowsOnly is true in the export options
                let dataToExport;
                const selectedRowsData = e.component.getSelectedRowsData();

                // Check the format parameter to determine export type
                if (e.format === 'xlsx' && selectedRowsData.length > 0) {
                    // This will be true when "Export selected rows" is clicked
                    dataToExport = selectedRowsData;
                } else {
                    // Export all data
                    dataToExport = e.component.getDataSource().items();
                }

                // Add data rows
                dataToExport.forEach((row) => {
                    const dataRow = visibleColumns.map(column => {
                        const value = row[column.dataField];
                        return value !== undefined && value !== null ? value : '';
                    });
                    worksheet.addRow(dataRow);
                });

                // Auto-fit columns
                worksheet.columns.forEach((column) => {
                    let maxLength = 0;
                    column.eachCell({ includeEmpty: true }, cell => {
                        const columnLength = cell.value ? cell.value.toString().length : 0;
                        if (columnLength > maxLength) {
                            maxLength = columnLength;
                        }
                    });
                    column.width = maxLength < 10 ? 10 : maxLength + 2;
                });

                // Generate and download file
                const fileName = dataToExport === selectedRowsData && selectedRowsData.length > 0
                    ? 'MonthlySalary_Selected_' + new Date().toISOString().slice(0, 10) + '.xlsx'
                    : 'MonthlySalary_All_' + new Date().toISOString().slice(0, 10) + '.xlsx';

                workbook.xlsx.writeBuffer().then((buffer) => {
                    saveAs(
                        new Blob([buffer], { type: 'application/octet-stream' }),
                        fileName
                    );
                });

                e.cancel = true;
            },
            onSelectionChanged: function(e) {
                // No need to manage custom button anymore
            },
            toolbar: {
                items: [
                    "exportButton",
                    "searchPanel",
                    {
                        location: "after",
                        widget: "dxButton",
                        options: {
                            icon: "clear",
                            hint: "Clear Selection",
                            onClick: function () {
                                const grid = $("#salaryGridContainer").dxDataGrid("instance");
                                grid.clearSelection();
                                grid.refresh();
                            }
                        }
                    }
                ]
            },
            searchPanel: {
                visible: true,
                width: 240,
                placeholder: "Search..."
            },
            columns: [
                { dataField: "employeeId", caption: "Employee ID", visible: false },
                {
                    dataField: "employeeCode",
                    caption: "Code",
                    
                    width: 100
                },
                {
                    dataField: "employeeName",
                    caption: "Name",
                   
                    width: 200
                },
                { dataField: "grossSalary", caption: "Gross Salary", width: 120 },
                { dataField: "payableDays", caption: "Payable Days", width: 100 },
                { dataField: "absentDays", caption: "Absent Days", width: 100 },
                { dataField: "presentDays", caption: "Present Days", width: 100 },
                { dataField: "weekOff", caption: "Week Off", width: 100 },
                { dataField: "leave", caption: "Leave", width: 80 },
                { dataField: "salaryDays", caption: "Salary Days", width: 100 },
                { dataField: "basicSalary", caption: "Basic Salary", dataType: "number", format: "#,##0", width: 120 },
                { dataField: "hra", caption: "HRA", dataType: "number", format: "#,##0", width: 100 },
                { dataField: "conveyanceAllowance", caption: "Conveyance", dataType: "number", format: "#,##0", width: 120 },
                { dataField: "childEducationAllowance", caption: "Child Edu. Allowance", dataType: "number", format: "#,##0", width: 150 },
                { dataField: "medicalAllowance", caption: "Medical Allowance", dataType: "number", format: "#,##0", width: 130 },
                { dataField: "deputationAllowance", caption: "Deputation Allowance", dataType: "number", format: "#,##0", width: 150 },
                { dataField: "totalGrossSalary", caption: "Total Gross Salary", dataType: "number", format: "#,##0", width: 140 },
                { dataField: "pf", caption: "PF", dataType: "number", format: "#,##0", width: 100 },
                { dataField: "esic", caption: "ESIC", dataType: "number", format: "#,##0", width: 100 },
                { dataField: "professionalTax", caption: "Professional Tax", dataType: "number", format: "#,##0", width: 130 },
                { dataField: "lwf", caption: "LWF", dataType: "number", format: "#,##0", width: 80 },
                { dataField: "tds", caption: "TDS", dataType: "number", format: "#,##0", width: 100 },
                { dataField: "loan", caption: "Loan", dataType: "number", format: "#,##0", width: 100 },
                { dataField: "arrears", caption: "Arrears", dataType: "number", format: "#,##0", width: 100 },
                { dataField: "otherDeduction", caption: "Other Deduction", dataType: "number", format: "#,##0", width: 130 },
                { dataField: "totalDeductions", caption: "Total Deductions", dataType: "number", format: "#,##0", width: 140 },
                { dataField: "netSalary", caption: "Net Salary", dataType: "number", format: "#,##0", width: 120 }
            ],
            onContentReady: function (e) {
                // Optional: any logic after grid is fully rendered
            }
        });

        $("#salaryActions").show();
    }

    $('#btnProcessSalary').on('click', function () {
        showbtnProcessingLoader();
        const monthNumber = $('#monthDropdown').data('searchableSelect').getValue();
        const selectedYear = $('#yearDropdown').data('searchableSelect').getValue();

        // const branchIds = $('#branchDropdown').data('searchableSelect').getValue();
        const selectedGridRows = $("#salaryGridContainer").dxDataGrid("instance").getSelectedRowsData();
        const empCodes = selectedGridRows.map(emp => emp.employeeCode).join(",");

        
      let isValid = true;

            if (!monthNumber) {
                $('#errorMonth').show();
                isValid = false;
            } else {
                $('#errorMonth').hide();
            }

            if (!selectedYear) {
                $('#errorYear').show();
                isValid = false;
            } else {
                $('#errorYear').hide();
            }
           
         if (!empCodes) {
           round_error_noti("Please select at least one employee from the grid");
             isValid = false;
        }

            if (!isValid) {
                   hidebtnProcessingLoader();
                return;
            }

        

      
        // Create start date (first day of month)
        const startDate = `${selectedYear}-${monthNumber.toString().padStart(2, '0')}-01`;

        // Get the actual last day of the month
        const lastDayOfMonth = new Date(selectedYear, monthNumber, 0).getDate();

        // Create end date (last day of month)
        const endDate = `${selectedYear}-${monthNumber.toString().padStart(2, '0')}-${lastDayOfMonth.toString().padStart(2, '0')}`;


       const requestData = {
        StartDate: startDate,
        EndDate: endDate,
        EmployeeCodes: empCodes,
        CompanyId: CompanyId,
        Action: "Insert" ,
        CreatedBy: EmployeeId
    };
        processSalaryInsert(requestData);
    });

    function processSalaryInsert(payload) {
        $.ajax({
            type: "POST",
            url: '@(baseDomainUrl + "/api/MonthlySalaryDetailsAPI/CreateMonthlySalary")',
            data: JSON.stringify(payload),
            contentType: "application/json",
            headers: {
                'Authorization': 'Bearer ' + Token
            },
            success: function (response) {
                if (response.isSuccess) {
                    round_success_noti(response.responseMessage);
                } else {
                    round_error_noti(response.responseMessage);
                }
                hidebtnProcessingLoader();
            },
            error: function () {
                 hidebtnProcessingLoader();
              round_error_noti("Something went wrong!")
            }
        });
    }

     function clearAllData() {
       
        //  $('#yearDropdown').prop('disabled', false);
        // $('#monthDropdown').prop('disabled', false);
        // $('#branchDropdown').css('pointer-events', 'auto');
        // $('#employeeDropdown').css('pointer-events', 'auto');
        // $("#salaryGridContainer").hide();
    
        try {
            const grid = $("#salaryGridContainer").dxDataGrid("instance");
            if (grid) {
                grid.clearSelection(); // Selection clear kar do
                grid.option("dataSource", []); // Data clear kar do
            }
        } catch (error) {
            console.error("Grid clear error:", error);
        }


    }

    $("#btnClearSalary").on("click", function () {
             const grid = $("#salaryGridContainer").dxDataGrid("instance");

        // Clear selection
        grid.clearSelection();
        grid.refresh();
            $('#yearDropdown').prop('disabled', false);
    $('#monthDropdown').prop('disabled', false);
    $('#employeeDropdown').css('pointer-events', 'auto');
    });

     

</script>


@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Import Data";
    Layout = "~/Areas/AdminPanel/Views/Shared/_AdminLayout.cshtml";
    string baseUrl = Configuration["BaseUrlSettings:baseUrl"];
    var uri = new Uri(baseUrl);
    string baseDomainUrl = $"{uri.Scheme}://{uri.Host}:{uri.Port}";
}


<!-- jQuery and SweetAlert -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow-y: auto;
    }

    .content-wrapper {
        overflow-y: visible !important;
        height: auto !important;
    }

    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        overflow-y: auto !important;
    }

    .header {
        background-color: #3d4e6b;
        color: white;
        padding: 10px 15px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .tabs-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px 0 15px;
    }

    .tabs {
        display: flex;
        border-bottom: 2px solid #ccc;
    }

    .tab-button {
        padding: 8px 15px;
        background-color: #3d4e6b;
        color: white;
        border: none;
        cursor: pointer;
        border-right: 1px solid white;
    }

        .tab-button.active {
            background-color: orange;
        }

    .form-section {
        padding: 20px;
        border: 1px solid #999;
        margin: 10px 10px;
    }

    .form-group {
        margin-bottom: 10px;
    }

    .footer-buttons {
        padding: 10px 15px;
        text-align: right;
    }

        .footer-buttons button {
            margin-left: 5px;
            padding: 6px 16px;
            color: white;
            background-color: #3d4e6b;
            border: none;
        }

    .tab-content {
        display: none;
    }

        .tab-content.active {
            display: block;
        }

    .radio-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }

        .radio-group label {
            width: 30%;
            white-space: nowrap;
        }

    .dx-tabpanel,
    .dx-tabpanel .dx-multiview-wrapper,
    .dx-datagrid {
        height: auto !important;
        overflow: visible !important;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
        animation: fadeIn 0.3s;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .modal-content {
        background-color: #fefefe;
        margin: 2% auto;
        padding: 0;
        border: 1px solid #888;
        width: 95%;
        max-width: 1200px;
        height: auto;
        max-height: 70vh;
        min-height: 400px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        animation: slideIn 0.3s;
    }

    .modal-body {
        padding: 20px;
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    @@keyframes slideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        background-color: #3d4e6b;
        color: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

    .modal-body {
        padding: 20px;
        flex: 1;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #ddd;
        text-align: right;
        border-radius: 0 0 8px 8px;
        background-color: #f8f9fa;
    }

    .close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s;
    }

        .close-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
        transition: background-color 0.3s;
    }

    .btn-primary {
        background-color: #3d4e6b;
        color: white;
    }

        .btn-primary:hover {
            background-color: #2c3e54;
        }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

    .error-stats {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid #dc3545;
    }

    .stats-item {
        display: inline-block;
        margin-right: 30px;
        font-weight: bold;
    }

    .stats-value {
        color: #dc3545;
        font-size: 18px;
    }

    #errorGrid {
        height: 350px !important;
        min-height: 350px;
        max-height: 350px;
        flex: 1;
    }

    .dx-datagrid {
        height: 100% !important;
        overflow: hidden !important;
    }

        .dx-datagrid .dx-scrollview-content {
            overflow: visible !important;
        }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<div class="header">IMPORT FILES FOR MASTERS</div>

<div class="tabs-container">
    <div class="tabs">
        <button class="tab-button active" data-tab="master">Master</button>
        <button class="tab-button" data-tab="employee">Employee</button>
        <button class="tab-button" data-tab="leave">Leave</button>
        <button class="tab-button" data-tab="salary">Salary</button>
    </div>
    <div>
        <button style="background:#3d4e6b; color:white; border:none; padding: 6px 10px;" id="btnBack">Back</button>
    </div>
</div>

<!-- Tab Contents Start -->
<div class="tab-content active" id="master">
    <div class="form-section">
        <b>Import in Master</b>
        <div class="radio-group" id="masterRadioGroup">
            <label><input type="radio" name="master" value="Branch"> Branch</label>
            <label><input type="radio" name="master" value="Department"> Department</label>
            <label><input type="radio" name="master" value="Designation"> Designation</label>
            <label><input type="radio" name="master" value="Bank"> Bank</label>
            <label><input type="radio" name="master" value="City"> City Master</label>
            <label><input type="radio" name="master" value="Holiday"> Holiday Master</label>
        </div>
    </div>

    <div class="form-section">
        <div class="form-group">Import File* : <input type="file" id="masterFileInput" /></div>
        <div class="form-group">Sheet Name* : <input type="text" id="masterSheetName" /></div>
        <div class="form-group">
            Row No From* : <input type="text" id="masterRowFrom" style="width:60px;" />
            To <input type="text" id="masterRowTo" style="width:60px;" />
        </div>
        <div class="form-group">
            Download Samples: <a href="javascript:void(0);" onclick="downloadSample()" id="masterSampleLink">Click Here</a>
        </div>
    </div>
</div>

<div class="tab-content" id="employee">
    <div class="form-section">
        <b>Import in Employee</b><br />
        <input type="radio" name="employee" value="Employee"> <label for="empEmployee">Employee</label><br />
        <input type="radio" name="employee" value="EmployeeUpdate"> <label for="empUpdate">Employee Update</label><br />
        <input type="radio" name="employee" value="EarnDed"> <label for="empEarnDed">Earn/Ded Data</label>
    </div>

    <div class="form-section">
        <div class="form-group">
            Import File*: <input type="file" id="employeeFileInput" />
        </div>

        <div class="form-group">
            Sheet Name*: <input type="text" id="employeeSheetName" />
        </div>

        <div class="form-group">
            Row No From*: <input type="text" id="employeeRowFrom" style="width:60px;" />
            To <input type="text" id="employeeRowTo" style="width:60px;" />
        </div>

        <div class="form-group">
            Download Samples: <a href="javascript:void(0);" onclick="downloadSample('employee')" id="employeeSampleLink">Click Here</a>
        </div>
    </div>
</div>

<div class="tab-content" id="leave">
    <div class="form-section">
        <b>Import in Leave</b><br />
        <input type="radio" name="leave" value="LeaveOpening" id="leaveOpening">
        <label for="leaveOpening">Leave Opening</label>
    </div>

    <div class="form-section">
        <div class="form-group">
            Import File*: <input type="file" id="leaveFileInput" />
        </div>

        <div class="form-group">
            Sheet Name*: <input type="text" id="leaveSheetName" />
        </div>

        <div class="form-group">
            Row No From*: <input type="text" id="leaveRowFrom" style="width:60px;" />
            To <input type="text" id="leaveRowTo" style="width:60px;" />
        </div>

        <div class="form-group">
            Download Samples: <a href="javascript:void(0);" onclick="downloadSample('leave')" id="leaveSampleLink">Click Here</a>
        </div>
    </div>
</div>

<div class="tab-content" id="salary">
    <div class="form-section">
        <b>Import in Salary</b><br />
        <input type="radio" name="salary" value="Attendance" id="Attendance">
        <label for="salaryAttendance">Attendance Import</label><br />
        <input type="radio" name="salary" value="MonthlyEar" id="MonthlyEar">
        <label for="salaryMonthlyEarning">Monthly Earning</label> <br />
        <input type="radio" name="salary" value="MonthlyDed" id="MonthlyDed">
        <label for="salaryMonthlyDeduction">Monthly Deduction</label>
    </div>

    <div class="form-section">
        <div class="form-group">
            Import File*: <input type="file" id="salaryFileInput" />
        </div>

        <div class="form-group">
            Sheet Name*: <input type="text" id="salarySheetName" />
        </div>

        <div class="form-group">
            Row No From*: <input type="text" id="salaryRowFrom" style="width:60px;" />
            To <input type="text" id="salaryRowTo" style="width:60px;" />
        </div>

        <div class="form-group">
            Download Samples: <a href="javascript:void(0);" onclick="downloadSample('salary')" id="salarySampleLink">Click Here</a>
        </div>
    </div>
</div>

<!-- Footer Buttons -->
<div class="footer-buttons">
    <button id="btnImport">Import</button>
    <button id="btnClear">Clear</button>
</div>

<!-- Loading Spinner -->
<div id="grid-loader"
     class="grid-loader justify-content-center align-items-center flex-column"
     style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(3px); z-index: 9999;">

    <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3d4e6b; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <div class="grid-loading-text text-dark" style="font-size: 16px; margin-top: 15px;">Loading...</div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Import Error Records</h3>
            <button type="button" class="close-btn" onclick="closeErrorModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="errorStats" class="error-stats" style="display: none;">
                <div class="stats-item">
                    Total Errors: <span class="stats-value" id="totalErrors">0</span>
                </div>
                <div class="stats-item">
                    Import Type: <span class="stats-value" id="importType">-</span>
                </div>
                <div class="stats-item">
                    Import Date: <span class="stats-value" id="importDate">-</span>
                </div>
            </div>
            <div id="errorGrid" style="height: 500px;"></div>
        </div>
        <div class="modal-footer">
            @*       <button type="button" class="btn btn-primary" onclick="exportErrorData()">Export Errors</button> *@
            <button type="button" class="btn btn-secondary" onclick="closeErrorModal()">Close</button>
        </div>
    </div>
</div>

<script>
    var errorDataGrid;

    $(document).ready(function () {

        $('.tab-button').click(function () {
            var tab = $(this).data('tab');
            $('.tab-button').removeClass('active');
            $(this).addClass('active');
            $('.tab-content').removeClass('active');
            $('#' + tab).addClass('active');
            if (errorDataGrid) {
                errorDataGrid.option("dataSource", []);
                closeErrorModal();
            }
        });

        // Clear button
        $('#btnClear').click(function () {
            clearForm();
        });

        function clearForm() {
            $('input[type="radio"]').prop('checked', false);
            $('input[type="file"]').val('');
            $('input[type="text"]').val('');

            if (errorDataGrid) {
                errorDataGrid.option("dataSource", []);
                closeErrorModal();
            }
        }

        async function showLoder(){
            $('#grid-loader').addClass('d-flex').show();
        }
        async function hideLoder(){
            $('#grid-loader').removeClass('d-flex').hide();
        }

        $('#btnImport').click(function () {
            var activeTab = $('.tab-content.active').attr('id');
            var selectedType = $('input[name="' + activeTab + '"]:checked').val();
            var file = $('#' + activeTab + 'FileInput')[0]?.files[0];
            var sheetName = $('#' + activeTab + 'SheetName').val();
            var rowFrom = $('#' + activeTab + 'RowFrom').val();
            var rowTo = $('#' + activeTab + 'RowTo').val();
            var createdBy = localStorage.getItem("EmployeeId");

            // Validation
            if (!selectedType) return Swal.fire("Warning", "Please select a type", "warning");
            if (!file) return Swal.fire("Warning", "Please upload a file", "warning");
            if (!sheetName) return Swal.fire("Warning", "Please enter sheet name", "warning");
            if (!rowFrom) return Swal.fire("Warning", "Please enter 'Row From'", "warning");
            if (!rowTo) return Swal.fire("Warning", "Please enter 'Row To'", "warning");
            if (!createdBy) return Swal.fire("Warning", "User not authenticated", "warning");

            // Show loader
            showLoder();

            var formData = new FormData();
            formData.append("File", file);
            formData.append("Type", selectedType);
            formData.append("SheetName", sheetName);
            formData.append("RowFrom", rowFrom);
            formData.append("RowTo", rowTo);
            formData.append("CreatedBy", createdBy);
          
            $.ajax({
                url: '@baseDomainUrl/api/ImportData/Upload',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (res) {
                    hideLoder();
                    if (res.isSuccess) {
                        if (res.data?.length) {
                            // Show SweetAlert with custom button to view errors
                            Swal.fire({
                                title: "Partial Success",
                                text: res.responseMessage,
                                icon: "warning",
                                showCancelButton: true,
                                confirmButtonText: "View Errors",
                                cancelButtonText: "OK",
                                confirmButtonColor: "#3d4e6b",
                                cancelButtonColor: "#6c757d"
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    showErrorGrid(res.data);
                                } else if (result.dismiss === Swal.DismissReason.cancel) {
                                    clearForm();
                                }
                            });
                        } else {
                            Swal.fire("Success", res.responseMessage, "success").then(() => {
                                clearForm();
                            });
                        }
                    } else {
                        if (res.data?.length) {
                            // Show SweetAlert with custom button to view errors
                            Swal.fire({
                                title: "Import Failed",
                                text: res.responseMessage,
                                icon: "error",
                                showCancelButton: true,
                                confirmButtonText: "View Errors",
                                cancelButtonText: "OK",
                                confirmButtonColor: "#3d4e6b",
                                cancelButtonColor: "#6c757d"
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    showErrorGrid(res.data);
                                } else if (result.dismiss === Swal.DismissReason.cancel) {
                                    clearForm();
                                }
                            });
                        } else {
                            Swal.fire("Failed", res.responseMessage, "error").then(() => {
                                clearForm();
                            });
                        }
                    }
                },
                error: function () {
                    hideLoder();
                    Swal.fire("Error", "Something went wrong while importing!", "error");
                },
                complete: function () {
                    hideLoder();
                }
            });
        });

        $('#btnBack').click(function () {
            history.back();
        });

        $('input[type="radio"]').change(function() {
            if (errorDataGrid) {
                errorDataGrid.option("dataSource", []);
                closeErrorModal();
            }
        });

        function showErrorGrid(data) {
            if (!errorDataGrid) {
                errorDataGrid = $("#errorGrid").dxDataGrid({
                    dataSource: data,
                    height: 350,
                    showBorders: true,
                    paging: { pageSize: 10 },
                    pager: {
                        showPageSizeSelector: true,
                        allowedPageSizes: [10, 25, 50, 100],
                        showInfo: true
                    },
                    columns: [
                        { dataField: "rowNumber", caption: "Row Number", width: 70 },
                        { dataField: "importDate", caption: "Date Of Import", width: 150 },
                        { dataField: "errorDescription", caption: "Suggestion" },
                        { dataField: "actualValue", caption: "Actual Value", width: 90 },
                        { dataField: "suggestion", caption: "Error Description", width: 200 },
                        { dataField: "importType", caption: "Import Type", width: 120 }
                    ],
                    headerFilter: { visible: true },
                    filterRow: { visible: true, applyFilter: "auto" },
                    allowColumnResizing: true,
                    allowColumnReordering: true,
                    columnsAutoWidth: true,
                    grouping: { contextMenuEnabled: true },
                    searchPanel: { visible: true, width: 240, placeholder: "Search..." }
                }).dxDataGrid("instance");
            } else {
                errorDataGrid.option("dataSource", data);
            }

            $("#errorModal").fadeIn(300);
        }

        // Make clearForm globally accessible
        window.clearForm = clearForm;
    });

    function closeErrorModal() {
            $('#errorModal').hide();
            if (errorDataGrid) {
                errorDataGrid.option("dataSource", []);
            }
        }

    // Close modal when clicking outside
    $(window).click(function(event) {
        if (event.target.id === 'errorModal') {
            closeErrorModal();
        }
    });

    // Close modal on escape key
    $(document).keydown(function(event) {
        if (event.key === "Escape") {
            closeErrorModal();
        }
    });

    function downloadSample() {
        let selectedMaster = document.querySelector('input[type="radio"]:checked')?.value;

        const samplePaths = {
            "Branch": "/SampleTemplates/Branch_Master_Version1.2.xls",
            "Department": "/SampleTemplates/Department_Master_Version1.2.xls",
            "Designation": "/SampleTemplates/Designation_Master_Version1.2.xls",
            "Bank": "/SampleTemplates/Bank_Master_Version1.2.xls",
            "City": "/SampleTemplates/City_Master_Version1.2.xls",
            "Holiday": "/SampleTemplates/Holiday_Master_Import1.2.xls",
            "Employee": "/SampleTemplates/Employee_Update.xls",
            "EmployeeUpdate": "/SampleTemplates/EmployeeMasterUpdate.xlsx",
            "EarnDed": "/SampleTemplates/EarnDed.xls",
            "LeaveOpening": "/SampleTemplates/Leave.xls",
            "Attendance": "/SampleTemplates/Attendance_Import_version1.2.xls",
            "MonthlyEar": "/SampleTemplates/MonthlyEarSample.xlsx",
            "MonthlyDed": "/SampleTemplates/MonthlyDeductionTemplate1.xlsx"
        };

        const downloadUrl = samplePaths[selectedMaster];

        if (downloadUrl) {
            const a = document.createElement("a");
            a.href = downloadUrl;
            a.download = downloadUrl.split('/').pop();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } else {
            Swal.fire("Warning", "Please select a master type", "warning");
        }
    }
</script>